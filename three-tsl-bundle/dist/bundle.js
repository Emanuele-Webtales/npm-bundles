const t=300,e=301,s=302,i=1e3,r=1001,n=1002,a=1003,o=1006,h=1008,l=1014,u=1015,c=1016,d=1023,p=1026,m=1027,g=2300,y=2301,f=2302,x="srgb",b="srgb-linear",v="linear",w="srgb",N=7680,T=35044,M=35048,_=2e3,S=2001;class A{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const s=this._listeners;void 0===s[t]&&(s[t]=[]),-1===s[t].indexOf(e)&&s[t].push(e)}hasEventListener(t,e){const s=this._listeners;return void 0!==s&&(void 0!==s[t]&&-1!==s[t].indexOf(e))}removeEventListener(t,e){const s=this._listeners;if(void 0===s)return;const i=s[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}dispatchEvent(t){const e=this._listeners;if(void 0===e)return;const s=e[t.type];if(void 0!==s){t.target=this;const e=s.slice(0);for(let s=0,i=e.length;s<i;s++)e[s].call(this,t);t.target=null}}}const z=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let V=1234567;const C=Math.PI/180,I=180/Math.PI;function R(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,s=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(z[255&t]+z[t>>8&255]+z[t>>16&255]+z[t>>24&255]+"-"+z[255&e]+z[e>>8&255]+"-"+z[e>>16&15|64]+z[e>>24&255]+"-"+z[63&s|128]+z[s>>8&255]+"-"+z[s>>16&255]+z[s>>24&255]+z[255&i]+z[i>>8&255]+z[i>>16&255]+z[i>>24&255]).toLowerCase()}function E(t,e,s){return Math.max(e,Math.min(s,t))}function O(t,e){return(t%e+e)%e}function F(t,e,s){return(1-s)*t+s*e}function B(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return t/4294967295;case Uint16Array:return t/65535;case Uint8Array:return t/255;case Int32Array:return Math.max(t/2147483647,-1);case Int16Array:return Math.max(t/32767,-1);case Int8Array:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}function L(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return Math.round(4294967295*t);case Uint16Array:return Math.round(65535*t);case Uint8Array:return Math.round(255*t);case Int32Array:return Math.round(2147483647*t);case Int16Array:return Math.round(32767*t);case Int8Array:return Math.round(127*t);default:throw new Error("Invalid component type.")}}const P={DEG2RAD:C,RAD2DEG:I,generateUUID:R,clamp:E,euclideanModulo:O,mapLinear:function(t,e,s,i,r){return i+(t-e)*(r-i)/(s-e)},inverseLerp:function(t,e,s){return t!==e?(s-t)/(e-t):0},lerp:F,damp:function(t,e,s,i){return F(t,e,1-Math.exp(-s*i))},pingpong:function(t,e=1){return e-Math.abs(O(t,2*e)-e)},smoothstep:function(t,e,s){return t<=e?0:t>=s?1:(t=(t-e)/(s-e))*t*(3-2*t)},smootherstep:function(t,e,s){return t<=e?0:t>=s?1:(t=(t-e)/(s-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},seededRandom:function(t){void 0!==t&&(V=t);let e=V+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296},degToRad:function(t){return t*C},radToDeg:function(t){return t*I},isPowerOfTwo:function(t){return!(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},setQuaternionFromProperEuler:function(t,e,s,i,r){const n=Math.cos,a=Math.sin,o=n(s/2),h=a(s/2),l=n((e+i)/2),u=a((e+i)/2),c=n((e-i)/2),d=a((e-i)/2),p=n((i-e)/2),m=a((i-e)/2);switch(r){case"XYX":t.set(o*u,h*c,h*d,o*l);break;case"YZY":t.set(h*d,o*u,h*c,o*l);break;case"ZXZ":t.set(h*c,h*d,o*u,o*l);break;case"XZX":t.set(o*u,h*m,h*p,o*l);break;case"YXY":t.set(h*p,o*u,h*m,o*l);break;case"ZYZ":t.set(h*m,h*p,o*u,o*l)}},normalize:L,denormalize:B};class D{constructor(t=0,e=0){D.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,s=this.y,i=t.elements;return this.x=i[0]*e+i[3]*s+i[6],this.y=i[1]*e+i[4]*s+i[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=E(this.x,t.x,e.x),this.y=E(this.y,t.y,e.y),this}clampScalar(t,e){return this.x=E(this.x,t,e),this.y=E(this.y,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(E(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(E(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y;return e*e+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const s=Math.cos(e),i=Math.sin(e),r=this.x-t.x,n=this.y-t.y;return this.x=r*s-n*i+t.x,this.y=r*i+n*s+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class k{constructor(t,e,s,i,r,n,a,o,h){k.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,e,s,i,r,n,a,o,h)}set(t,e,s,i,r,n,a,o,h){const l=this.elements;return l[0]=t,l[1]=i,l[2]=a,l[3]=e,l[4]=r,l[5]=o,l[6]=s,l[7]=n,l[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this}extractBasis(t,e,s){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),s.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,n=s[0],a=s[3],o=s[6],h=s[1],l=s[4],u=s[7],c=s[2],d=s[5],p=s[8],m=i[0],g=i[3],y=i[6],f=i[1],x=i[4],b=i[7],v=i[2],w=i[5],N=i[8];return r[0]=n*m+a*f+o*v,r[3]=n*g+a*x+o*w,r[6]=n*y+a*b+o*N,r[1]=h*m+l*f+u*v,r[4]=h*g+l*x+u*w,r[7]=h*y+l*b+u*N,r[2]=c*m+d*f+p*v,r[5]=c*g+d*x+p*w,r[8]=c*y+d*b+p*N,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8];return e*n*l-e*a*h-s*r*l+s*a*o+i*r*h-i*n*o}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],u=l*n-a*h,c=a*o-l*r,d=h*r-n*o,p=e*u+s*c+i*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const m=1/p;return t[0]=u*m,t[1]=(i*h-l*s)*m,t[2]=(a*s-i*n)*m,t[3]=c*m,t[4]=(l*e-i*o)*m,t[5]=(i*r-a*e)*m,t[6]=d*m,t[7]=(s*o-h*e)*m,t[8]=(n*e-s*r)*m,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,s,i,r,n,a){const o=Math.cos(r),h=Math.sin(r);return this.set(s*o,s*h,-s*(o*n+h*a)+n+t,-i*h,i*o,-i*(-h*n+o*a)+a+e,0,0,1),this}scale(t,e){return this.premultiply(U.makeScale(t,e)),this}rotate(t){return this.premultiply(U.makeRotation(-t)),this}translate(t,e){return this.premultiply(U.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,s,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<9;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e=0){for(let s=0;s<9;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}const U=new k;Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array;function W(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)}const j=(new k).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),q=(new k).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function H(){const t={enabled:!0,workingColorSpace:b,spaces:{},convert:function(t,e,s){return!1!==this.enabled&&e!==s&&e&&s?(this.spaces[e].transfer===w&&(t.r=X(t.r),t.g=X(t.g),t.b=X(t.b)),this.spaces[e].primaries!==this.spaces[s].primaries&&(t.applyMatrix3(this.spaces[e].toXYZ),t.applyMatrix3(this.spaces[s].fromXYZ)),this.spaces[s].transfer===w&&(t.r=Y(t.r),t.g=Y(t.g),t.b=Y(t.b)),t):t},fromWorkingColorSpace:function(t,e){return this.convert(t,this.workingColorSpace,e)},toWorkingColorSpace:function(t,e){return this.convert(t,e,this.workingColorSpace)},getPrimaries:function(t){return this.spaces[t].primaries},getTransfer:function(t){return""===t?v:this.spaces[t].transfer},getLuminanceCoefficients:function(t,e=this.workingColorSpace){return t.fromArray(this.spaces[e].luminanceCoefficients)},define:function(t){Object.assign(this.spaces,t)},_getMatrix:function(t,e,s){return t.copy(this.spaces[e].toXYZ).multiply(this.spaces[s].fromXYZ)},_getDrawingBufferColorSpace:function(t){return this.spaces[t].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(t=this.workingColorSpace){return this.spaces[t].workingColorSpaceConfig.unpackColorSpace}},e=[.64,.33,.3,.6,.15,.06],s=[.2126,.7152,.0722],i=[.3127,.329];return t.define({[b]:{primaries:e,whitePoint:i,transfer:v,toXYZ:j,fromXYZ:q,luminanceCoefficients:s,workingColorSpaceConfig:{unpackColorSpace:x},outputColorSpaceConfig:{drawingBufferColorSpace:x}},[x]:{primaries:e,whitePoint:i,transfer:w,toXYZ:j,fromXYZ:q,luminanceCoefficients:s,outputColorSpaceConfig:{drawingBufferColorSpace:x}}}),t}const G=H();function X(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function Y(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}let $;class Z{static getDataURL(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===$&&($=W("canvas")),$.width=t.width,$.height=t.height;const s=$.getContext("2d");t instanceof ImageData?s.putImageData(t,0,0):s.drawImage(t,0,0,t.width,t.height),e=$}return e.toDataURL("image/png")}static sRGBToLinear(t){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const e=W("canvas");e.width=t.width,e.height=t.height;const s=e.getContext("2d");s.drawImage(t,0,0,t.width,t.height);const i=s.getImageData(0,0,t.width,t.height),r=i.data;for(let t=0;t<r.length;t++)r[t]=255*X(r[t]/255);return s.putImageData(i,0,0),e}if(t.data){const e=t.data.slice(0);for(let t=0;t<e.length;t++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[t]=Math.floor(255*X(e[t]/255)):e[t]=X(e[t]);return{data:e,width:t.width,height:t.height}}return t}}let J=0;class K{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:J++}),this.uuid=R(),this.data=t,this.dataReady=!0,this.version=0}set needsUpdate(t){!0===t&&this.version++}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.images[this.uuid])return t.images[this.uuid];const s={uuid:this.uuid,url:""},i=this.data;if(null!==i){let t;if(Array.isArray(i)){t=[];for(let e=0,s=i.length;e<s;e++)i[e].isDataTexture?t.push(Q(i[e].image)):t.push(Q(i[e]))}else t=Q(i);s.url=t}return e||(t.images[this.uuid]=s),s}}function Q(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?Z.getDataURL(t):t.data?{data:Array.from(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:{}}let tt=0;class et extends A{constructor(t=et.DEFAULT_IMAGE,e=et.DEFAULT_MAPPING,s=1001,i=1001,r=1006,n=1008,a=1023,o=1009,h=et.DEFAULT_ANISOTROPY,l=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:tt++}),this.uuid=R(),this.name="",this.source=new K(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=s,this.wrapT=i,this.magFilter=r,this.minFilter=n,this.anisotropy=h,this.format=a,this.internalFormat=null,this.type=o,this.offset=new D(0,0),this.repeat=new D(1,1),this.center=new D(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new k,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=l,this.userData={},this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.renderTarget=t.renderTarget,this.isRenderTargetTexture=t.isRenderTargetTexture,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const s={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(s.userData=this.userData),e||(t.textures[this.uuid]=s),s}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==t)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case i:e.x=e.x-Math.floor(e.x);break;case r:e.x=e.x<0?0:1;break;case n:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case i:e.y=e.y-Math.floor(e.y);break;case r:e.y=e.y<0?0:1;break;case n:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(t){!0===t&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){!0===t&&this.pmremVersion++}}et.DEFAULT_IMAGE=null,et.DEFAULT_MAPPING=t,et.DEFAULT_ANISOTROPY=1;class st{constructor(t=0,e=0,s=0,i=1){st.prototype.isVector4=!0,this.x=t,this.y=e,this.z=s,this.w=i}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,s=this.y,i=this.z,r=this.w,n=t.elements;return this.x=n[0]*e+n[4]*s+n[8]*i+n[12]*r,this.y=n[1]*e+n[5]*s+n[9]*i+n[13]*r,this.z=n[2]*e+n[6]*s+n[10]*i+n[14]*r,this.w=n[3]*e+n[7]*s+n[11]*i+n[15]*r,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,s,i,r;const n=.01,a=.1,o=t.elements,h=o[0],l=o[4],u=o[8],c=o[1],d=o[5],p=o[9],m=o[2],g=o[6],y=o[10];if(Math.abs(l-c)<n&&Math.abs(u-m)<n&&Math.abs(p-g)<n){if(Math.abs(l+c)<a&&Math.abs(u+m)<a&&Math.abs(p+g)<a&&Math.abs(h+d+y-3)<a)return this.set(1,0,0,0),this;e=Math.PI;const t=(h+1)/2,o=(d+1)/2,f=(y+1)/2,x=(l+c)/4,b=(u+m)/4,v=(p+g)/4;return t>o&&t>f?t<n?(s=0,i=.707106781,r=.707106781):(s=Math.sqrt(t),i=x/s,r=b/s):o>f?o<n?(s=.707106781,i=0,r=.707106781):(i=Math.sqrt(o),s=x/i,r=v/i):f<n?(s=.707106781,i=.707106781,r=0):(r=Math.sqrt(f),s=b/r,i=v/r),this.set(s,i,r,e),this}let f=Math.sqrt((g-p)*(g-p)+(u-m)*(u-m)+(c-l)*(c-l));return Math.abs(f)<.001&&(f=1),this.x=(g-p)/f,this.y=(u-m)/f,this.z=(c-l)/f,this.w=Math.acos((h+d+y-1)/2),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this.w=e[15],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=E(this.x,t.x,e.x),this.y=E(this.y,t.y,e.y),this.z=E(this.z,t.z,e.z),this.w=E(this.w,t.w,e.w),this}clampScalar(t,e){return this.x=E(this.x,t,e),this.y=E(this.y,t,e),this.z=E(this.z,t,e),this.w=E(this.w,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(E(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this.w=t.w+(e.w-t.w)*s,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class it extends A{constructor(t=1,e=1,s={}){super(),this.isRenderTarget=!0,this.width=t,this.height=e,this.depth=1,this.scissor=new st(0,0,t,e),this.scissorTest=!1,this.viewport=new st(0,0,t,e);const i={width:t,height:e,depth:1};s=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:o,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1},s);const r=new et(i,s.mapping,s.wrapS,s.wrapT,s.magFilter,s.minFilter,s.format,s.type,s.anisotropy,s.colorSpace);r.flipY=!1,r.generateMipmaps=s.generateMipmaps,r.internalFormat=s.internalFormat,this.textures=[];const n=s.count;for(let t=0;t<n;t++)this.textures[t]=r.clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;this.depthBuffer=s.depthBuffer,this.stencilBuffer=s.stencilBuffer,this.resolveDepthBuffer=s.resolveDepthBuffer,this.resolveStencilBuffer=s.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=s.depthTexture,this.samples=s.samples}get texture(){return this.textures[0]}set texture(t){this.textures[0]=t}set depthTexture(t){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==t&&(t.renderTarget=this),this._depthTexture=t}get depthTexture(){return this._depthTexture}setSize(t,e,s=1){if(this.width!==t||this.height!==e||this.depth!==s){this.width=t,this.height=e,this.depth=s;for(let i=0,r=this.textures.length;i<r;i++)this.textures[i].image.width=t,this.textures[i].image.height=e,this.textures[i].image.depth=s;this.dispose()}this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)}clone(){return(new this.constructor).copy(this)}copy(t){this.width=t.width,this.height=t.height,this.depth=t.depth,this.scissor.copy(t.scissor),this.scissorTest=t.scissorTest,this.viewport.copy(t.viewport),this.textures.length=0;for(let e=0,s=t.textures.length;e<s;e++){this.textures[e]=t.textures[e].clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;const s=Object.assign({},t.textures[e].image);this.textures[e].source=new K(s)}return this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.resolveDepthBuffer=t.resolveDepthBuffer,this.resolveStencilBuffer=t.resolveStencilBuffer,null!==t.depthTexture&&(this.depthTexture=t.depthTexture.clone()),this.samples=t.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class rt extends et{constructor(t=null,e=1,s=1,i=1){super(null),this.isDataArrayTexture=!0,this.image={data:t,width:e,height:s,depth:i},this.magFilter=a,this.minFilter=a,this.wrapR=r,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(t){this.layerUpdates.add(t)}clearLayerUpdates(){this.layerUpdates.clear()}}class nt{constructor(t=0,e=0,s=0,i=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=s,this._w=i}static slerpFlat(t,e,s,i,r,n,a){let o=s[i+0],h=s[i+1],l=s[i+2],u=s[i+3];const c=r[n+0],d=r[n+1],p=r[n+2],m=r[n+3];if(0===a)return t[e+0]=o,t[e+1]=h,t[e+2]=l,void(t[e+3]=u);if(1===a)return t[e+0]=c,t[e+1]=d,t[e+2]=p,void(t[e+3]=m);if(u!==m||o!==c||h!==d||l!==p){let t=1-a;const e=o*c+h*d+l*p+u*m,s=e>=0?1:-1,i=1-e*e;if(i>Number.EPSILON){const r=Math.sqrt(i),n=Math.atan2(r,e*s);t=Math.sin(t*n)/r,a=Math.sin(a*n)/r}const r=a*s;if(o=o*t+c*r,h=h*t+d*r,l=l*t+p*r,u=u*t+m*r,t===1-a){const t=1/Math.sqrt(o*o+h*h+l*l+u*u);o*=t,h*=t,l*=t,u*=t}}t[e]=o,t[e+1]=h,t[e+2]=l,t[e+3]=u}static multiplyQuaternionsFlat(t,e,s,i,r,n){const a=s[i],o=s[i+1],h=s[i+2],l=s[i+3],u=r[n],c=r[n+1],d=r[n+2],p=r[n+3];return t[e]=a*p+l*u+o*d-h*c,t[e+1]=o*p+l*c+h*u-a*d,t[e+2]=h*p+l*d+a*c-o*u,t[e+3]=l*p-a*u-o*c-h*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,s,i){return this._x=t,this._y=e,this._z=s,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const s=t._x,i=t._y,r=t._z,n=t._order,a=Math.cos,o=Math.sin,h=a(s/2),l=a(i/2),u=a(r/2),c=o(s/2),d=o(i/2),p=o(r/2);switch(n){case"XYZ":this._x=c*l*u+h*d*p,this._y=h*d*u-c*l*p,this._z=h*l*p+c*d*u,this._w=h*l*u-c*d*p;break;case"YXZ":this._x=c*l*u+h*d*p,this._y=h*d*u-c*l*p,this._z=h*l*p-c*d*u,this._w=h*l*u+c*d*p;break;case"ZXY":this._x=c*l*u-h*d*p,this._y=h*d*u+c*l*p,this._z=h*l*p+c*d*u,this._w=h*l*u-c*d*p;break;case"ZYX":this._x=c*l*u-h*d*p,this._y=h*d*u+c*l*p,this._z=h*l*p-c*d*u,this._w=h*l*u+c*d*p;break;case"YZX":this._x=c*l*u+h*d*p,this._y=h*d*u+c*l*p,this._z=h*l*p-c*d*u,this._w=h*l*u-c*d*p;break;case"XZY":this._x=c*l*u-h*d*p,this._y=h*d*u-c*l*p,this._z=h*l*p+c*d*u,this._w=h*l*u+c*d*p}return!0===e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const s=e/2,i=Math.sin(s);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(s),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,s=e[0],i=e[4],r=e[8],n=e[1],a=e[5],o=e[9],h=e[2],l=e[6],u=e[10],c=s+a+u;if(c>0){const t=.5/Math.sqrt(c+1);this._w=.25/t,this._x=(l-o)*t,this._y=(r-h)*t,this._z=(n-i)*t}else if(s>a&&s>u){const t=2*Math.sqrt(1+s-a-u);this._w=(l-o)/t,this._x=.25*t,this._y=(i+n)/t,this._z=(r+h)/t}else if(a>u){const t=2*Math.sqrt(1+a-s-u);this._w=(r-h)/t,this._x=(i+n)/t,this._y=.25*t,this._z=(o+l)/t}else{const t=2*Math.sqrt(1+u-s-a);this._w=(n-i)/t,this._x=(r+h)/t,this._y=(o+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let s=t.dot(e)+1;return s<Number.EPSILON?(s=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=s):(this._x=0,this._y=-t.z,this._z=t.y,this._w=s)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=s),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(E(this.dot(t),-1,1)))}rotateTowards(t,e){const s=this.angleTo(t);if(0===s)return this;const i=Math.min(1,e/s);return this.slerp(t,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const s=t._x,i=t._y,r=t._z,n=t._w,a=e._x,o=e._y,h=e._z,l=e._w;return this._x=s*l+n*a+i*h-r*o,this._y=i*l+n*o+r*a-s*h,this._z=r*l+n*h+s*o-i*a,this._w=n*l-s*a-i*o-r*h,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const s=this._x,i=this._y,r=this._z,n=this._w;let a=n*t._w+s*t._x+i*t._y+r*t._z;if(a<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),a>=1)return this._w=n,this._x=s,this._y=i,this._z=r,this;const o=1-a*a;if(o<=Number.EPSILON){const t=1-e;return this._w=t*n+e*this._w,this._x=t*s+e*this._x,this._y=t*i+e*this._y,this._z=t*r+e*this._z,this.normalize(),this}const h=Math.sqrt(o),l=Math.atan2(h,a),u=Math.sin((1-e)*l)/h,c=Math.sin(e*l)/h;return this._w=n*u+this._w*c,this._x=s*u+this._x*c,this._y=i*u+this._y*c,this._z=r*u+this._z*c,this._onChangeCallback(),this}slerpQuaternions(t,e,s){return this.copy(t).slerp(e,s)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),s=Math.random(),i=Math.sqrt(1-s),r=Math.sqrt(s);return this.set(i*Math.sin(t),i*Math.cos(t),r*Math.sin(e),r*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class at{constructor(t=0,e=0,s=0){at.prototype.isVector3=!0,this.x=t,this.y=e,this.z=s}set(t,e,s){return void 0===s&&(s=this.z),this.x=t,this.y=e,this.z=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(ht.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(ht.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*s+r[6]*i,this.y=r[1]*e+r[4]*s+r[7]*i,this.z=r[2]*e+r[5]*s+r[8]*i,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,s=this.y,i=this.z,r=t.elements,n=1/(r[3]*e+r[7]*s+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*s+r[8]*i+r[12])*n,this.y=(r[1]*e+r[5]*s+r[9]*i+r[13])*n,this.z=(r[2]*e+r[6]*s+r[10]*i+r[14])*n,this}applyQuaternion(t){const e=this.x,s=this.y,i=this.z,r=t.x,n=t.y,a=t.z,o=t.w,h=2*(n*i-a*s),l=2*(a*e-r*i),u=2*(r*s-n*e);return this.x=e+o*h+n*u-a*l,this.y=s+o*l+a*h-r*u,this.z=i+o*u+r*l-n*h,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,s=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*s+r[8]*i,this.y=r[1]*e+r[5]*s+r[9]*i,this.z=r[2]*e+r[6]*s+r[10]*i,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=E(this.x,t.x,e.x),this.y=E(this.y,t.y,e.y),this.z=E(this.z,t.z,e.z),this}clampScalar(t,e){return this.x=E(this.x,t,e),this.y=E(this.y,t,e),this.z=E(this.z,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(E(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const s=t.x,i=t.y,r=t.z,n=e.x,a=e.y,o=e.z;return this.x=i*o-r*a,this.y=r*n-s*o,this.z=s*a-i*n,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const s=t.dot(this)/e;return this.copy(t).multiplyScalar(s)}projectOnPlane(t){return ot.copy(this).projectOnVector(t),this.sub(ot)}reflect(t){return this.sub(ot.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(E(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return e*e+s*s+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,s){const i=Math.sin(e)*t;return this.x=i*Math.sin(s),this.y=Math.cos(e)*t,this.z=i*Math.cos(s),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,s){return this.x=t*Math.sin(e),this.y=s,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),s=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=s,this.z=i,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=2*Math.random()-1,s=Math.sqrt(1-e*e);return this.x=s*Math.cos(t),this.y=e,this.z=s*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const ot=new at,ht=new nt;class lt{constructor(t=new at(1/0,1/0,1/0),e=new at(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e+=3)this.expandByPoint(ct.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,s=t.count;e<s;e++)this.expandByPoint(ct.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const s=ct.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(s),this.max.copy(t).add(s),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const s=t.geometry;if(void 0!==s){const i=s.getAttribute("position");if(!0===e&&void 0!==i&&!0!==t.isInstancedMesh)for(let e=0,s=i.count;e<s;e++)!0===t.isMesh?t.getVertexPosition(e,ct):ct.fromBufferAttribute(i,e),ct.applyMatrix4(t.matrixWorld),this.expandByPoint(ct);else void 0!==t.boundingBox?(null===t.boundingBox&&t.computeBoundingBox(),dt.copy(t.boundingBox)):(null===s.boundingBox&&s.computeBoundingBox(),dt.copy(s.boundingBox)),dt.applyMatrix4(t.matrixWorld),this.union(dt)}const i=t.children;for(let t=0,s=i.length;t<s;t++)this.expandByObject(i[t],e);return this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y&&t.max.z>=this.min.z&&t.min.z<=this.max.z}intersectsSphere(t){return this.clampPoint(t.center,ct),ct.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,s;return t.normal.x>0?(e=t.normal.x*this.min.x,s=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,s=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,s+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,s+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,s+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,s+=t.normal.z*this.min.z),e<=-t.constant&&s>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(bt),vt.subVectors(this.max,bt),pt.subVectors(t.a,bt),mt.subVectors(t.b,bt),gt.subVectors(t.c,bt),yt.subVectors(mt,pt),ft.subVectors(gt,mt),xt.subVectors(pt,gt);let e=[0,-yt.z,yt.y,0,-ft.z,ft.y,0,-xt.z,xt.y,yt.z,0,-yt.x,ft.z,0,-ft.x,xt.z,0,-xt.x,-yt.y,yt.x,0,-ft.y,ft.x,0,-xt.y,xt.x,0];return!!Tt(e,pt,mt,gt,vt)&&(e=[1,0,0,0,1,0,0,0,1],!!Tt(e,pt,mt,gt,vt)&&(wt.crossVectors(yt,ft),e=[wt.x,wt.y,wt.z],Tt(e,pt,mt,gt,vt)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,ct).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=.5*this.getSize(ct).length()),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(ut[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),ut[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),ut[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),ut[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),ut[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),ut[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),ut[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),ut[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(ut)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const ut=[new at,new at,new at,new at,new at,new at,new at,new at],ct=new at,dt=new lt,pt=new at,mt=new at,gt=new at,yt=new at,ft=new at,xt=new at,bt=new at,vt=new at,wt=new at,Nt=new at;function Tt(t,e,s,i,r){for(let n=0,a=t.length-3;n<=a;n+=3){Nt.fromArray(t,n);const a=r.x*Math.abs(Nt.x)+r.y*Math.abs(Nt.y)+r.z*Math.abs(Nt.z),o=e.dot(Nt),h=s.dot(Nt),l=i.dot(Nt);if(Math.max(-Math.max(o,h,l),Math.min(o,h,l))>a)return!1}return!0}const Mt=new lt,_t=new at,St=new at;class At{constructor(t=new at,e=-1){this.isSphere=!0,this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const s=this.center;void 0!==e?s.copy(e):Mt.setFromPoints(t).getCenter(s);let i=0;for(let e=0,r=t.length;e<r;e++)i=Math.max(i,s.distanceToSquared(t[e]));return this.radius=Math.sqrt(i),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const s=this.center.distanceToSquared(t);return e.copy(t),s>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;_t.subVectors(t,this.center);const e=_t.lengthSq();if(e>this.radius*this.radius){const t=Math.sqrt(e),s=.5*(t-this.radius);this.center.addScaledVector(_t,s/t),this.radius+=s}return this}union(t){return t.isEmpty()?this:this.isEmpty()?(this.copy(t),this):(!0===this.center.equals(t.center)?this.radius=Math.max(this.radius,t.radius):(St.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(_t.copy(t.center).add(St)),this.expandByPoint(_t.copy(t.center).sub(St))),this)}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const zt=new at,Vt=new at,Ct=new at,It=new at,Rt=new at,Et=new at,Ot=new at;class Ft{constructor(t=new at,e=new at(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return e.copy(this.origin).addScaledVector(this.direction,t)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,zt)),this}closestPointToPoint(t,e){e.subVectors(t,this.origin);const s=e.dot(this.direction);return s<0?e.copy(this.origin):e.copy(this.origin).addScaledVector(this.direction,s)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=zt.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(zt.copy(this.origin).addScaledVector(this.direction,e),zt.distanceToSquared(t))}distanceSqToSegment(t,e,s,i){Vt.copy(t).add(e).multiplyScalar(.5),Ct.copy(e).sub(t).normalize(),It.copy(this.origin).sub(Vt);const r=.5*t.distanceTo(e),n=-this.direction.dot(Ct),a=It.dot(this.direction),o=-It.dot(Ct),h=It.lengthSq(),l=Math.abs(1-n*n);let u,c,d,p;if(l>0)if(u=n*o-a,c=n*a-o,p=r*l,u>=0)if(c>=-p)if(c<=p){const t=1/l;u*=t,c*=t,d=u*(u+n*c+2*a)+c*(n*u+c+2*o)+h}else c=r,u=Math.max(0,-(n*c+a)),d=-u*u+c*(c+2*o)+h;else c=-r,u=Math.max(0,-(n*c+a)),d=-u*u+c*(c+2*o)+h;else c<=-p?(u=Math.max(0,-(-n*r+a)),c=u>0?-r:Math.min(Math.max(-r,-o),r),d=-u*u+c*(c+2*o)+h):c<=p?(u=0,c=Math.min(Math.max(-r,-o),r),d=c*(c+2*o)+h):(u=Math.max(0,-(n*r+a)),c=u>0?r:Math.min(Math.max(-r,-o),r),d=-u*u+c*(c+2*o)+h);else c=n>0?-r:r,u=Math.max(0,-(n*c+a)),d=-u*u+c*(c+2*o)+h;return s&&s.copy(this.origin).addScaledVector(this.direction,u),i&&i.copy(Vt).addScaledVector(Ct,c),d}intersectSphere(t,e){zt.subVectors(t.center,this.origin);const s=zt.dot(this.direction),i=zt.dot(zt)-s*s,r=t.radius*t.radius;if(i>r)return null;const n=Math.sqrt(r-i),a=s-n,o=s+n;return o<0?null:a<0?this.at(o,e):this.at(a,e)}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;const s=-(this.origin.dot(t.normal)+t.constant)/e;return s>=0?s:null}intersectPlane(t,e){const s=this.distanceToPlane(t);return null===s?null:this.at(s,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);if(0===e)return!0;return t.normal.dot(this.direction)*e<0}intersectBox(t,e){let s,i,r,n,a,o;const h=1/this.direction.x,l=1/this.direction.y,u=1/this.direction.z,c=this.origin;return h>=0?(s=(t.min.x-c.x)*h,i=(t.max.x-c.x)*h):(s=(t.max.x-c.x)*h,i=(t.min.x-c.x)*h),l>=0?(r=(t.min.y-c.y)*l,n=(t.max.y-c.y)*l):(r=(t.max.y-c.y)*l,n=(t.min.y-c.y)*l),s>n||r>i?null:((r>s||isNaN(s))&&(s=r),(n<i||isNaN(i))&&(i=n),u>=0?(a=(t.min.z-c.z)*u,o=(t.max.z-c.z)*u):(a=(t.max.z-c.z)*u,o=(t.min.z-c.z)*u),s>o||a>i?null:((a>s||s!=s)&&(s=a),(o<i||i!=i)&&(i=o),i<0?null:this.at(s>=0?s:i,e)))}intersectsBox(t){return null!==this.intersectBox(t,zt)}intersectTriangle(t,e,s,i,r){Rt.subVectors(e,t),Et.subVectors(s,t),Ot.crossVectors(Rt,Et);let n,a=this.direction.dot(Ot);if(a>0){if(i)return null;n=1}else{if(!(a<0))return null;n=-1,a=-a}It.subVectors(this.origin,t);const o=n*this.direction.dot(Et.crossVectors(It,Et));if(o<0)return null;const h=n*this.direction.dot(Rt.cross(It));if(h<0)return null;if(o+h>a)return null;const l=-n*It.dot(Ot);return l<0?null:this.at(l/a,r)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class Bt{constructor(t,e,s,i,r,n,a,o,h,l,u,c,d,p,m,g){Bt.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,s,i,r,n,a,o,h,l,u,c,d,p,m,g)}set(t,e,s,i,r,n,a,o,h,l,u,c,d,p,m,g){const y=this.elements;return y[0]=t,y[4]=e,y[8]=s,y[12]=i,y[1]=r,y[5]=n,y[9]=a,y[13]=o,y[2]=h,y[6]=l,y[10]=u,y[14]=c,y[3]=d,y[7]=p,y[11]=m,y[15]=g,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Bt).fromArray(this.elements)}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],this}copyPosition(t){const e=this.elements,s=t.elements;return e[12]=s[12],e[13]=s[13],e[14]=s[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,s){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),s.setFromMatrixColumn(this,2),this}makeBasis(t,e,s){return this.set(t.x,e.x,s.x,0,t.y,e.y,s.y,0,t.z,e.z,s.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,s=t.elements,i=1/Lt.setFromMatrixColumn(t,0).length(),r=1/Lt.setFromMatrixColumn(t,1).length(),n=1/Lt.setFromMatrixColumn(t,2).length();return e[0]=s[0]*i,e[1]=s[1]*i,e[2]=s[2]*i,e[3]=0,e[4]=s[4]*r,e[5]=s[5]*r,e[6]=s[6]*r,e[7]=0,e[8]=s[8]*n,e[9]=s[9]*n,e[10]=s[10]*n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,s=t.x,i=t.y,r=t.z,n=Math.cos(s),a=Math.sin(s),o=Math.cos(i),h=Math.sin(i),l=Math.cos(r),u=Math.sin(r);if("XYZ"===t.order){const t=n*l,s=n*u,i=a*l,r=a*u;e[0]=o*l,e[4]=-o*u,e[8]=h,e[1]=s+i*h,e[5]=t-r*h,e[9]=-a*o,e[2]=r-t*h,e[6]=i+s*h,e[10]=n*o}else if("YXZ"===t.order){const t=o*l,s=o*u,i=h*l,r=h*u;e[0]=t+r*a,e[4]=i*a-s,e[8]=n*h,e[1]=n*u,e[5]=n*l,e[9]=-a,e[2]=s*a-i,e[6]=r+t*a,e[10]=n*o}else if("ZXY"===t.order){const t=o*l,s=o*u,i=h*l,r=h*u;e[0]=t-r*a,e[4]=-n*u,e[8]=i+s*a,e[1]=s+i*a,e[5]=n*l,e[9]=r-t*a,e[2]=-n*h,e[6]=a,e[10]=n*o}else if("ZYX"===t.order){const t=n*l,s=n*u,i=a*l,r=a*u;e[0]=o*l,e[4]=i*h-s,e[8]=t*h+r,e[1]=o*u,e[5]=r*h+t,e[9]=s*h-i,e[2]=-h,e[6]=a*o,e[10]=n*o}else if("YZX"===t.order){const t=n*o,s=n*h,i=a*o,r=a*h;e[0]=o*l,e[4]=r-t*u,e[8]=i*u+s,e[1]=u,e[5]=n*l,e[9]=-a*l,e[2]=-h*l,e[6]=s*u+i,e[10]=t-r*u}else if("XZY"===t.order){const t=n*o,s=n*h,i=a*o,r=a*h;e[0]=o*l,e[4]=-u,e[8]=h*l,e[1]=t*u+r,e[5]=n*l,e[9]=s*u-i,e[2]=i*u-s,e[6]=a*l,e[10]=r*u+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(Dt,t,kt)}lookAt(t,e,s){const i=this.elements;return jt.subVectors(t,e),0===jt.lengthSq()&&(jt.z=1),jt.normalize(),Ut.crossVectors(s,jt),0===Ut.lengthSq()&&(1===Math.abs(s.z)?jt.x+=1e-4:jt.z+=1e-4,jt.normalize(),Ut.crossVectors(s,jt)),Ut.normalize(),Wt.crossVectors(jt,Ut),i[0]=Ut.x,i[4]=Wt.x,i[8]=jt.x,i[1]=Ut.y,i[5]=Wt.y,i[9]=jt.y,i[2]=Ut.z,i[6]=Wt.z,i[10]=jt.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,r=this.elements,n=s[0],a=s[4],o=s[8],h=s[12],l=s[1],u=s[5],c=s[9],d=s[13],p=s[2],m=s[6],g=s[10],y=s[14],f=s[3],x=s[7],b=s[11],v=s[15],w=i[0],N=i[4],T=i[8],M=i[12],_=i[1],S=i[5],A=i[9],z=i[13],V=i[2],C=i[6],I=i[10],R=i[14],E=i[3],O=i[7],F=i[11],B=i[15];return r[0]=n*w+a*_+o*V+h*E,r[4]=n*N+a*S+o*C+h*O,r[8]=n*T+a*A+o*I+h*F,r[12]=n*M+a*z+o*R+h*B,r[1]=l*w+u*_+c*V+d*E,r[5]=l*N+u*S+c*C+d*O,r[9]=l*T+u*A+c*I+d*F,r[13]=l*M+u*z+c*R+d*B,r[2]=p*w+m*_+g*V+y*E,r[6]=p*N+m*S+g*C+y*O,r[10]=p*T+m*A+g*I+y*F,r[14]=p*M+m*z+g*R+y*B,r[3]=f*w+x*_+b*V+v*E,r[7]=f*N+x*S+b*C+v*O,r[11]=f*T+x*A+b*I+v*F,r[15]=f*M+x*z+b*R+v*B,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[4],i=t[8],r=t[12],n=t[1],a=t[5],o=t[9],h=t[13],l=t[2],u=t[6],c=t[10],d=t[14];return t[3]*(+r*o*u-i*h*u-r*a*c+s*h*c+i*a*d-s*o*d)+t[7]*(+e*o*d-e*h*c+r*n*c-i*n*d+i*h*l-r*o*l)+t[11]*(+e*h*u-e*a*d-r*n*u+s*n*d+r*a*l-s*h*l)+t[15]*(-i*a*l-e*o*u+e*a*c+i*n*u-s*n*c+s*o*l)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,s){const i=this.elements;return t.isVector3?(i[12]=t.x,i[13]=t.y,i[14]=t.z):(i[12]=t,i[13]=e,i[14]=s),this}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],r=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],u=t[9],c=t[10],d=t[11],p=t[12],m=t[13],g=t[14],y=t[15],f=u*g*h-m*c*h+m*o*d-a*g*d-u*o*y+a*c*y,x=p*c*h-l*g*h-p*o*d+n*g*d+l*o*y-n*c*y,b=l*m*h-p*u*h+p*a*d-n*m*d-l*a*y+n*u*y,v=p*u*o-l*m*o-p*a*c+n*m*c+l*a*g-n*u*g,w=e*f+s*x+i*b+r*v;if(0===w)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const N=1/w;return t[0]=f*N,t[1]=(m*c*r-u*g*r-m*i*d+s*g*d+u*i*y-s*c*y)*N,t[2]=(a*g*r-m*o*r+m*i*h-s*g*h-a*i*y+s*o*y)*N,t[3]=(u*o*r-a*c*r-u*i*h+s*c*h+a*i*d-s*o*d)*N,t[4]=x*N,t[5]=(l*g*r-p*c*r+p*i*d-e*g*d-l*i*y+e*c*y)*N,t[6]=(p*o*r-n*g*r-p*i*h+e*g*h+n*i*y-e*o*y)*N,t[7]=(n*c*r-l*o*r+l*i*h-e*c*h-n*i*d+e*o*d)*N,t[8]=b*N,t[9]=(p*u*r-l*m*r-p*s*d+e*m*d+l*s*y-e*u*y)*N,t[10]=(n*m*r-p*a*r+p*s*h-e*m*h-n*s*y+e*a*y)*N,t[11]=(l*a*r-n*u*r-l*s*h+e*u*h+n*s*d-e*a*d)*N,t[12]=v*N,t[13]=(l*m*i-p*u*i+p*s*c-e*m*c-l*s*g+e*u*g)*N,t[14]=(p*a*i-n*m*i-p*s*o+e*m*o+n*s*g-e*a*g)*N,t[15]=(n*u*i-l*a*i+l*s*o-e*u*o-n*s*c+e*a*c)*N,this}scale(t){const e=this.elements,s=t.x,i=t.y,r=t.z;return e[0]*=s,e[4]*=i,e[8]*=r,e[1]*=s,e[5]*=i,e[9]*=r,e[2]*=s,e[6]*=i,e[10]*=r,e[3]*=s,e[7]*=i,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,s,i))}makeTranslation(t,e,s){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,s,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),s=Math.sin(t);return this.set(1,0,0,0,0,e,-s,0,0,s,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,0,s,0,0,1,0,0,-s,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,0,s,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const s=Math.cos(e),i=Math.sin(e),r=1-s,n=t.x,a=t.y,o=t.z,h=r*n,l=r*a;return this.set(h*n+s,h*a-i*o,h*o+i*a,0,h*a+i*o,l*a+s,l*o-i*n,0,h*o-i*a,l*o+i*n,r*o*o+s,0,0,0,0,1),this}makeScale(t,e,s){return this.set(t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1),this}makeShear(t,e,s,i,r,n){return this.set(1,s,r,0,t,1,n,0,e,i,1,0,0,0,0,1),this}compose(t,e,s){const i=this.elements,r=e._x,n=e._y,a=e._z,o=e._w,h=r+r,l=n+n,u=a+a,c=r*h,d=r*l,p=r*u,m=n*l,g=n*u,y=a*u,f=o*h,x=o*l,b=o*u,v=s.x,w=s.y,N=s.z;return i[0]=(1-(m+y))*v,i[1]=(d+b)*v,i[2]=(p-x)*v,i[3]=0,i[4]=(d-b)*w,i[5]=(1-(c+y))*w,i[6]=(g+f)*w,i[7]=0,i[8]=(p+x)*N,i[9]=(g-f)*N,i[10]=(1-(c+m))*N,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}decompose(t,e,s){const i=this.elements;let r=Lt.set(i[0],i[1],i[2]).length();const n=Lt.set(i[4],i[5],i[6]).length(),a=Lt.set(i[8],i[9],i[10]).length();this.determinant()<0&&(r=-r),t.x=i[12],t.y=i[13],t.z=i[14],Pt.copy(this);const o=1/r,h=1/n,l=1/a;return Pt.elements[0]*=o,Pt.elements[1]*=o,Pt.elements[2]*=o,Pt.elements[4]*=h,Pt.elements[5]*=h,Pt.elements[6]*=h,Pt.elements[8]*=l,Pt.elements[9]*=l,Pt.elements[10]*=l,e.setFromRotationMatrix(Pt),s.x=r,s.y=n,s.z=a,this}makePerspective(t,e,s,i,r,n,a=2e3){const o=this.elements,h=2*r/(e-t),l=2*r/(s-i),u=(e+t)/(e-t),c=(s+i)/(s-i);let d,p;if(a===_)d=-(n+r)/(n-r),p=-2*n*r/(n-r);else{if(a!==S)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);d=-n/(n-r),p=-n*r/(n-r)}return o[0]=h,o[4]=0,o[8]=u,o[12]=0,o[1]=0,o[5]=l,o[9]=c,o[13]=0,o[2]=0,o[6]=0,o[10]=d,o[14]=p,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(t,e,s,i,r,n,a=2e3){const o=this.elements,h=1/(e-t),l=1/(s-i),u=1/(n-r),c=(e+t)*h,d=(s+i)*l;let p,m;if(a===_)p=(n+r)*u,m=-2*u;else{if(a!==S)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);p=r*u,m=-1*u}return o[0]=2*h,o[4]=0,o[8]=0,o[12]=-c,o[1]=0,o[5]=2*l,o[9]=0,o[13]=-d,o[2]=0,o[6]=0,o[10]=m,o[14]=-p,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<16;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e=0){for(let s=0;s<16;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t[e+9]=s[9],t[e+10]=s[10],t[e+11]=s[11],t[e+12]=s[12],t[e+13]=s[13],t[e+14]=s[14],t[e+15]=s[15],t}}const Lt=new at,Pt=new Bt,Dt=new at(0,0,0),kt=new at(1,1,1),Ut=new at,Wt=new at,jt=new at,qt=new Bt,Ht=new nt;class Gt{constructor(t=0,e=0,s=0,i=Gt.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=s,this._order=i}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,s,i=this._order){return this._x=t,this._y=e,this._z=s,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,s=!0){const i=t.elements,r=i[0],n=i[4],a=i[8],o=i[1],h=i[5],l=i[9],u=i[2],c=i[6],d=i[10];switch(e){case"XYZ":this._y=Math.asin(E(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-l,d),this._z=Math.atan2(-n,r)):(this._x=Math.atan2(c,h),this._z=0);break;case"YXZ":this._x=Math.asin(-E(l,-1,1)),Math.abs(l)<.9999999?(this._y=Math.atan2(a,d),this._z=Math.atan2(o,h)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(E(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(-u,d),this._z=Math.atan2(-n,h)):(this._y=0,this._z=Math.atan2(o,r));break;case"ZYX":this._y=Math.asin(-E(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(c,d),this._z=Math.atan2(o,r)):(this._x=0,this._z=Math.atan2(-n,h));break;case"YZX":this._z=Math.asin(E(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-l,h),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(a,d));break;case"XZY":this._z=Math.asin(-E(n,-1,1)),Math.abs(n)<.9999999?(this._x=Math.atan2(c,h),this._y=Math.atan2(a,r)):(this._x=Math.atan2(-l,d),this._y=0)}return this._order=e,!0===s&&this._onChangeCallback(),this}setFromQuaternion(t,e,s){return qt.makeRotationFromQuaternion(t),this.setFromRotationMatrix(qt,e,s)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return Ht.setFromEuler(this),this.setFromQuaternion(Ht,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Gt.DEFAULT_ORDER="XYZ";class Xt{constructor(){this.mask=1}set(t){this.mask=1<<t>>>0}enable(t){this.mask|=1<<t}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t}disable(t){this.mask&=~(1<<t)}disableAll(){this.mask=0}test(t){return 0!==(this.mask&t.mask)}isEnabled(t){return!!(this.mask&1<<t)}}let Yt=0;const $t=new at,Zt=new nt,Jt=new Bt,Kt=new at,Qt=new at,te=new at,ee=new nt,se=new at(1,0,0),ie=new at(0,1,0),re=new at(0,0,1),ne={type:"added"},ae={type:"removed"},oe={type:"childadded",child:null},he={type:"childremoved",child:null};class le extends A{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Yt++}),this.uuid=R(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=le.DEFAULT_UP.clone();const t=new at,e=new Gt,s=new nt,i=new at(1,1,1);e._onChange(function(){s.setFromEuler(e,!1)}),s._onChange(function(){e.setFromQuaternion(s,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:s},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new Bt},normalMatrix:{value:new k}}),this.matrix=new Bt,this.matrixWorld=new Bt,this.matrixAutoUpdate=le.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=le.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Xt,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return Zt.setFromAxisAngle(t,e),this.quaternion.multiply(Zt),this}rotateOnWorldAxis(t,e){return Zt.setFromAxisAngle(t,e),this.quaternion.premultiply(Zt),this}rotateX(t){return this.rotateOnAxis(se,t)}rotateY(t){return this.rotateOnAxis(ie,t)}rotateZ(t){return this.rotateOnAxis(re,t)}translateOnAxis(t,e){return $t.copy(t).applyQuaternion(this.quaternion),this.position.add($t.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(se,t)}translateY(t){return this.translateOnAxis(ie,t)}translateZ(t){return this.translateOnAxis(re,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(Jt.copy(this.matrixWorld).invert())}lookAt(t,e,s){t.isVector3?Kt.copy(t):Kt.set(t,e,s);const i=this.parent;this.updateWorldMatrix(!0,!1),Qt.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Jt.lookAt(Qt,Kt,this.up):Jt.lookAt(Kt,Qt,this.up),this.quaternion.setFromRotationMatrix(Jt),i&&(Jt.extractRotation(i.matrixWorld),Zt.setFromRotationMatrix(Jt),this.quaternion.premultiply(Zt.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this||t&&t.isObject3D&&(t.removeFromParent(),t.parent=this,this.children.push(t),t.dispatchEvent(ne),oe.child=t,this.dispatchEvent(oe),oe.child=null),this}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(ae),he.child=t,this.dispatchEvent(he),he.child=null),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),Jt.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),Jt.multiply(t.parent.matrixWorld)),t.applyMatrix4(Jt),t.removeFromParent(),t.parent=this,this.children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(ne),oe.child=t,this.dispatchEvent(oe),oe.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let s=0,i=this.children.length;s<i;s++){const i=this.children[s].getObjectByProperty(t,e);if(void 0!==i)return i}}getObjectsByProperty(t,e,s=[]){this[t]===e&&s.push(this);const i=this.children;for(let r=0,n=i.length;r<n;r++)i[r].getObjectsByProperty(t,e,s);return s}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Qt,t,te),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Qt,ee,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let s=0,i=e.length;s<i;s++)e[s].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let s=0,i=e.length;s<i;s++){e[s].updateMatrixWorld(t)}}updateWorldMatrix(t,e){const s=this.parent;if(!0===t&&null!==s&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===e){const t=this.children;for(let e=0,s=t.length;e<s;e++){t[e].updateWorldMatrix(!1,!0)}}}toJSON(t){const e=void 0===t||"string"==typeof t,s={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},s.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const i={};function r(e,s){return void 0===e[s.uuid]&&(e[s.uuid]=s.toJSON(t)),s.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.visibility=this._visibility,i.active=this._active,i.bounds=this._bounds.map(t=>({boxInitialized:t.boxInitialized,boxMin:t.box.min.toArray(),boxMax:t.box.max.toArray(),sphereInitialized:t.sphereInitialized,sphereRadius:t.sphere.radius,sphereCenter:t.sphere.center.toArray()})),i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.geometryCount=this._geometryCount,i.matricesTexture=this._matricesTexture.toJSON(t),null!==this._colorsTexture&&(i.colorsTexture=this._colorsTexture.toJSON(t)),null!==this.boundingSphere&&(i.boundingSphere={center:i.boundingSphere.center.toArray(),radius:i.boundingSphere.radius}),null!==this.boundingBox&&(i.boundingBox={min:i.boundingBox.min.toArray(),max:i.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(i.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=r(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const s=e.shapes;if(Array.isArray(s))for(let e=0,i=s.length;e<i;e++){const i=s[e];r(t.shapes,i)}else r(t.shapes,s)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(t.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let s=0,i=this.material.length;s<i;s++)e.push(r(t.materials,this.material[s]));i.material=e}else i.material=r(t.materials,this.material);if(this.children.length>0){i.children=[];for(let e=0;e<this.children.length;e++)i.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){i.animations=[];for(let e=0;e<this.animations.length;e++){const s=this.animations[e];i.animations.push(r(t.animations,s))}}if(e){const e=n(t.geometries),i=n(t.materials),r=n(t.textures),a=n(t.images),o=n(t.shapes),h=n(t.skeletons),l=n(t.animations),u=n(t.nodes);e.length>0&&(s.geometries=e),i.length>0&&(s.materials=i),r.length>0&&(s.textures=r),a.length>0&&(s.images=a),o.length>0&&(s.shapes=o),h.length>0&&(s.skeletons=h),l.length>0&&(s.animations=l),u.length>0&&(s.nodes=u)}return s.object=i,s;function n(t){const e=[];for(const s in t){const i=t[s];delete i.metadata,e.push(i)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const s=t.children[e];this.add(s.clone())}return this}}le.DEFAULT_UP=new at(0,1,0),le.DEFAULT_MATRIX_AUTO_UPDATE=!0,le.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const ue=new at,ce=new at,de=new at,pe=new at,me=new at,ge=new at,ye=new at,fe=new at,xe=new at,be=new at,ve=new st,we=new st,Ne=new st;class Te{constructor(t=new at,e=new at,s=new at){this.a=t,this.b=e,this.c=s}static getNormal(t,e,s,i){i.subVectors(s,e),ue.subVectors(t,e),i.cross(ue);const r=i.lengthSq();return r>0?i.multiplyScalar(1/Math.sqrt(r)):i.set(0,0,0)}static getBarycoord(t,e,s,i,r){ue.subVectors(i,e),ce.subVectors(s,e),de.subVectors(t,e);const n=ue.dot(ue),a=ue.dot(ce),o=ue.dot(de),h=ce.dot(ce),l=ce.dot(de),u=n*h-a*a;if(0===u)return r.set(0,0,0),null;const c=1/u,d=(h*o-a*l)*c,p=(n*l-a*o)*c;return r.set(1-d-p,p,d)}static containsPoint(t,e,s,i){return null!==this.getBarycoord(t,e,s,i,pe)&&(pe.x>=0&&pe.y>=0&&pe.x+pe.y<=1)}static getInterpolation(t,e,s,i,r,n,a,o){return null===this.getBarycoord(t,e,s,i,pe)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(r,pe.x),o.addScaledVector(n,pe.y),o.addScaledVector(a,pe.z),o)}static getInterpolatedAttribute(t,e,s,i,r,n){return ve.setScalar(0),we.setScalar(0),Ne.setScalar(0),ve.fromBufferAttribute(t,e),we.fromBufferAttribute(t,s),Ne.fromBufferAttribute(t,i),n.setScalar(0),n.addScaledVector(ve,r.x),n.addScaledVector(we,r.y),n.addScaledVector(Ne,r.z),n}static isFrontFacing(t,e,s,i){return ue.subVectors(s,e),ce.subVectors(t,e),ue.cross(ce).dot(i)<0}set(t,e,s){return this.a.copy(t),this.b.copy(e),this.c.copy(s),this}setFromPointsAndIndices(t,e,s,i){return this.a.copy(t[e]),this.b.copy(t[s]),this.c.copy(t[i]),this}setFromAttributeAndIndices(t,e,s,i){return this.a.fromBufferAttribute(t,e),this.b.fromBufferAttribute(t,s),this.c.fromBufferAttribute(t,i),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return ue.subVectors(this.c,this.b),ce.subVectors(this.a,this.b),.5*ue.cross(ce).length()}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return Te.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return Te.getBarycoord(t,this.a,this.b,this.c,e)}getInterpolation(t,e,s,i,r){return Te.getInterpolation(t,this.a,this.b,this.c,e,s,i,r)}containsPoint(t){return Te.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return Te.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){const s=this.a,i=this.b,r=this.c;let n,a;me.subVectors(i,s),ge.subVectors(r,s),fe.subVectors(t,s);const o=me.dot(fe),h=ge.dot(fe);if(o<=0&&h<=0)return e.copy(s);xe.subVectors(t,i);const l=me.dot(xe),u=ge.dot(xe);if(l>=0&&u<=l)return e.copy(i);const c=o*u-l*h;if(c<=0&&o>=0&&l<=0)return n=o/(o-l),e.copy(s).addScaledVector(me,n);be.subVectors(t,r);const d=me.dot(be),p=ge.dot(be);if(p>=0&&d<=p)return e.copy(r);const m=d*h-o*p;if(m<=0&&h>=0&&p<=0)return a=h/(h-p),e.copy(s).addScaledVector(ge,a);const g=l*p-d*u;if(g<=0&&u-l>=0&&d-p>=0)return ye.subVectors(r,i),a=(u-l)/(u-l+(d-p)),e.copy(i).addScaledVector(ye,a);const y=1/(g+m+c);return n=m*y,a=c*y,e.copy(s).addScaledVector(me,n).addScaledVector(ge,a)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}const Me={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},_e={h:0,s:0,l:0},Se={h:0,s:0,l:0};function Ae(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+6*(e-t)*(2/3-s):t}class ze{constructor(t,e,s){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(t,e,s)}set(t,e,s){if(void 0===e&&void 0===s){const e=t;e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e)}else this.setRGB(t,e,s);return this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=x){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,G.toWorkingColorSpace(this,e),this}setRGB(t,e,s,i=G.workingColorSpace){return this.r=t,this.g=e,this.b=s,G.toWorkingColorSpace(this,i),this}setHSL(t,e,s,i=G.workingColorSpace){if(t=O(t,1),e=E(e,0,1),s=E(s,0,1),0===e)this.r=this.g=this.b=s;else{const i=s<=.5?s*(1+e):s+e-s*e,r=2*s-i;this.r=Ae(r,i,t+1/3),this.g=Ae(r,i,t),this.b=Ae(r,i,t-1/3)}return G.toWorkingColorSpace(this,i),this}setStyle(t,e=x){function s(t){void 0!==t&&parseFloat(t)}let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(t)){let t;const r=i[1],n=i[2];switch(r){case"rgb":case"rgba":if(t=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return s(t[4]),this.setRGB(Math.min(255,parseInt(t[1],10))/255,Math.min(255,parseInt(t[2],10))/255,Math.min(255,parseInt(t[3],10))/255,e);if(t=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return s(t[4]),this.setRGB(Math.min(100,parseInt(t[1],10))/100,Math.min(100,parseInt(t[2],10))/100,Math.min(100,parseInt(t[3],10))/100,e);break;case"hsl":case"hsla":if(t=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return s(t[4]),this.setHSL(parseFloat(t[1])/360,parseFloat(t[2])/100,parseFloat(t[3])/100,e)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=i[1],s=t.length;if(3===s)return this.setRGB(parseInt(t.charAt(0),16)/15,parseInt(t.charAt(1),16)/15,parseInt(t.charAt(2),16)/15,e);if(6===s)return this.setHex(parseInt(t,16),e)}else if(t&&t.length>0)return this.setColorName(t,e);return this}setColorName(t,e=x){const s=Me[t.toLowerCase()];return void 0!==s&&this.setHex(s,e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=X(t.r),this.g=X(t.g),this.b=X(t.b),this}copyLinearToSRGB(t){return this.r=Y(t.r),this.g=Y(t.g),this.b=Y(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=x){return G.fromWorkingColorSpace(Ve.copy(this),t),65536*Math.round(E(255*Ve.r,0,255))+256*Math.round(E(255*Ve.g,0,255))+Math.round(E(255*Ve.b,0,255))}getHexString(t=x){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=G.workingColorSpace){G.fromWorkingColorSpace(Ve.copy(this),e);const s=Ve.r,i=Ve.g,r=Ve.b,n=Math.max(s,i,r),a=Math.min(s,i,r);let o,h;const l=(a+n)/2;if(a===n)o=0,h=0;else{const t=n-a;switch(h=l<=.5?t/(n+a):t/(2-n-a),n){case s:o=(i-r)/t+(i<r?6:0);break;case i:o=(r-s)/t+2;break;case r:o=(s-i)/t+4}o/=6}return t.h=o,t.s=h,t.l=l,t}getRGB(t,e=G.workingColorSpace){return G.fromWorkingColorSpace(Ve.copy(this),e),t.r=Ve.r,t.g=Ve.g,t.b=Ve.b,t}getStyle(t=x){G.fromWorkingColorSpace(Ve.copy(this),t);const e=Ve.r,s=Ve.g,i=Ve.b;return t!==x?`color(${t} ${e.toFixed(3)} ${s.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(255*e)},${Math.round(255*s)},${Math.round(255*i)})`}offsetHSL(t,e,s){return this.getHSL(_e),this.setHSL(_e.h+t,_e.s+e,_e.l+s)}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,s){return this.r=t.r+(e.r-t.r)*s,this.g=t.g+(e.g-t.g)*s,this.b=t.b+(e.b-t.b)*s,this}lerpHSL(t,e){this.getHSL(_e),t.getHSL(Se);const s=F(_e.h,Se.h,e),i=F(_e.s,Se.s,e),r=F(_e.l,Se.l,e);return this.setHSL(s,i,r),this}setFromVector3(t){return this.r=t.x,this.g=t.y,this.b=t.z,this}applyMatrix3(t){const e=this.r,s=this.g,i=this.b,r=t.elements;return this.r=r[0]*e+r[3]*s+r[6]*i,this.g=r[1]*e+r[4]*s+r[7]*i,this.b=r[2]*e+r[5]*s+r[8]*i,this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const Ve=new ze;ze.NAMES=Me;let Ce=0;class Ie extends A{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Ce++}),this.uuid=R(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=100,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new ze(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=N,this.stencilZFail=N,this.stencilZPass=N,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(t){this._alphaTest>0!=t>0&&this.version++,this._alphaTest=t}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(t){if(void 0!==t)for(const e in t){const s=t[e];if(void 0===s)continue;const i=this[e];void 0!==i&&(i&&i.isColor?i.set(s):i&&i.isVector3&&s&&s.isVector3?i.copy(s):this[e]=s)}}toJSON(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{}});const s={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function i(t){const e=[];for(const s in t){const i=t[s];delete i.metadata,e.push(i)}return e}if(s.uuid=this.uuid,s.type=this.type,""!==this.name&&(s.name=this.name),this.color&&this.color.isColor&&(s.color=this.color.getHex()),void 0!==this.roughness&&(s.roughness=this.roughness),void 0!==this.metalness&&(s.metalness=this.metalness),void 0!==this.sheen&&(s.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(s.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(s.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(s.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(s.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(s.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(s.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(s.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(s.shininess=this.shininess),void 0!==this.clearcoat&&(s.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(s.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(s.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(s.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(s.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,s.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(s.dispersion=this.dispersion),void 0!==this.iridescence&&(s.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(s.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(s.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(s.iridescenceMap=this.iridescenceMap.toJSON(t).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(s.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(t).uuid),void 0!==this.anisotropy&&(s.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(s.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(s.anisotropyMap=this.anisotropyMap.toJSON(t).uuid),this.map&&this.map.isTexture&&(s.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(s.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(s.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(s.lightMap=this.lightMap.toJSON(t).uuid,s.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(s.aoMap=this.aoMap.toJSON(t).uuid,s.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(s.bumpMap=this.bumpMap.toJSON(t).uuid,s.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(s.normalMap=this.normalMap.toJSON(t).uuid,s.normalMapType=this.normalMapType,s.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(s.displacementMap=this.displacementMap.toJSON(t).uuid,s.displacementScale=this.displacementScale,s.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(s.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(s.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(s.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(s.specularMap=this.specularMap.toJSON(t).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(s.specularIntensityMap=this.specularIntensityMap.toJSON(t).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(s.specularColorMap=this.specularColorMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(s.envMap=this.envMap.toJSON(t).uuid,void 0!==this.combine&&(s.combine=this.combine)),void 0!==this.envMapRotation&&(s.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(s.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(s.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(s.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(s.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.transmission&&(s.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(s.transmissionMap=this.transmissionMap.toJSON(t).uuid),void 0!==this.thickness&&(s.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(s.thicknessMap=this.thicknessMap.toJSON(t).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(s.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(s.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(s.size=this.size),null!==this.shadowSide&&(s.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(s.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(s.blending=this.blending),0!==this.side&&(s.side=this.side),!0===this.vertexColors&&(s.vertexColors=!0),this.opacity<1&&(s.opacity=this.opacity),!0===this.transparent&&(s.transparent=!0),204!==this.blendSrc&&(s.blendSrc=this.blendSrc),205!==this.blendDst&&(s.blendDst=this.blendDst),100!==this.blendEquation&&(s.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(s.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(s.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(s.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(s.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(s.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(s.depthFunc=this.depthFunc),!1===this.depthTest&&(s.depthTest=this.depthTest),!1===this.depthWrite&&(s.depthWrite=this.depthWrite),!1===this.colorWrite&&(s.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(s.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(s.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(s.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(s.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==N&&(s.stencilFail=this.stencilFail),this.stencilZFail!==N&&(s.stencilZFail=this.stencilZFail),this.stencilZPass!==N&&(s.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(s.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(s.rotation=this.rotation),!0===this.polygonOffset&&(s.polygonOffset=!0),0!==this.polygonOffsetFactor&&(s.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(s.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(s.linewidth=this.linewidth),void 0!==this.dashSize&&(s.dashSize=this.dashSize),void 0!==this.gapSize&&(s.gapSize=this.gapSize),void 0!==this.scale&&(s.scale=this.scale),!0===this.dithering&&(s.dithering=!0),this.alphaTest>0&&(s.alphaTest=this.alphaTest),!0===this.alphaHash&&(s.alphaHash=!0),!0===this.alphaToCoverage&&(s.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(s.premultipliedAlpha=!0),!0===this.forceSinglePass&&(s.forceSinglePass=!0),!0===this.wireframe&&(s.wireframe=!0),this.wireframeLinewidth>1&&(s.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(s.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(s.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(s.flatShading=!0),!1===this.visible&&(s.visible=!1),!1===this.toneMapped&&(s.toneMapped=!1),!1===this.fog&&(s.fog=!1),Object.keys(this.userData).length>0&&(s.userData=this.userData),e){const e=i(t.textures),r=i(t.images);e.length>0&&(s.textures=e),r.length>0&&(s.images=r)}return s}clone(){return(new this.constructor).copy(this)}copy(t){this.name=t.name,this.blending=t.blending,this.side=t.side,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.blendColor.copy(t.blendColor),this.blendAlpha=t.blendAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let s=null;if(null!==e){const t=e.length;s=new Array(t);for(let i=0;i!==t;++i)s[i]=e[i].clone()}return this.clippingPlanes=s,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.alphaHash=t.alphaHash,this.alphaToCoverage=t.alphaToCoverage,this.premultipliedAlpha=t.premultipliedAlpha,this.forceSinglePass=t.forceSinglePass,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(t){!0===t&&this.version++}onBuild(){}}class Re extends Ie{constructor(t){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new ze(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Gt,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}const Ee=Oe();function Oe(){const t=new ArrayBuffer(4),e=new Float32Array(t),s=new Uint32Array(t),i=new Uint32Array(512),r=new Uint32Array(512);for(let t=0;t<256;++t){const e=t-127;e<-27?(i[t]=0,i[256|t]=32768,r[t]=24,r[256|t]=24):e<-14?(i[t]=1024>>-e-14,i[256|t]=1024>>-e-14|32768,r[t]=-e-1,r[256|t]=-e-1):e<=15?(i[t]=e+15<<10,i[256|t]=e+15<<10|32768,r[t]=13,r[256|t]=13):e<128?(i[t]=31744,i[256|t]=64512,r[t]=24,r[256|t]=24):(i[t]=31744,i[256|t]=64512,r[t]=13,r[256|t]=13)}const n=new Uint32Array(2048),a=new Uint32Array(64),o=new Uint32Array(64);for(let t=1;t<1024;++t){let e=t<<13,s=0;for(;!(8388608&e);)e<<=1,s-=8388608;e&=-8388609,s+=947912704,n[t]=e|s}for(let t=1024;t<2048;++t)n[t]=939524096+(t-1024<<13);for(let t=1;t<31;++t)a[t]=t<<23;a[31]=1199570944,a[32]=2147483648;for(let t=33;t<63;++t)a[t]=2147483648+(t-32<<23);a[63]=3347054592;for(let t=1;t<64;++t)32!==t&&(o[t]=1024);return{floatView:e,uint32View:s,baseTable:i,shiftTable:r,mantissaTable:n,exponentTable:a,offsetTable:o}}function Fe(t){Math.abs(t),t=E(t,-65504,65504),Ee.floatView[0]=t;const e=Ee.uint32View[0],s=e>>23&511;return Ee.baseTable[s]+((8388607&e)>>Ee.shiftTable[s])}function Be(t){const e=t>>10;return Ee.uint32View[0]=Ee.mantissaTable[Ee.offsetTable[e]+(1023&t)]+Ee.exponentTable[e],Ee.floatView[0]}const Le=new at,Pe=new D;let De=0;class ke{constructor(t,e,s=!1){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:De++}),this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=s,this.usage=T,this.updateRanges=[],this.gpuType=u,this.version=0}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this.gpuType=t.gpuType,this}copyAt(t,e,s){t*=this.itemSize,s*=e.itemSize;for(let i=0,r=this.itemSize;i<r;i++)this.array[t+i]=e.array[s+i];return this}copyArray(t){return this.array.set(t),this}applyMatrix3(t){if(2===this.itemSize)for(let e=0,s=this.count;e<s;e++)Pe.fromBufferAttribute(this,e),Pe.applyMatrix3(t),this.setXY(e,Pe.x,Pe.y);else if(3===this.itemSize)for(let e=0,s=this.count;e<s;e++)Le.fromBufferAttribute(this,e),Le.applyMatrix3(t),this.setXYZ(e,Le.x,Le.y,Le.z);return this}applyMatrix4(t){for(let e=0,s=this.count;e<s;e++)Le.fromBufferAttribute(this,e),Le.applyMatrix4(t),this.setXYZ(e,Le.x,Le.y,Le.z);return this}applyNormalMatrix(t){for(let e=0,s=this.count;e<s;e++)Le.fromBufferAttribute(this,e),Le.applyNormalMatrix(t),this.setXYZ(e,Le.x,Le.y,Le.z);return this}transformDirection(t){for(let e=0,s=this.count;e<s;e++)Le.fromBufferAttribute(this,e),Le.transformDirection(t),this.setXYZ(e,Le.x,Le.y,Le.z);return this}set(t,e=0){return this.array.set(t,e),this}getComponent(t,e){let s=this.array[t*this.itemSize+e];return this.normalized&&(s=B(s,this.array)),s}setComponent(t,e,s){return this.normalized&&(s=L(s,this.array)),this.array[t*this.itemSize+e]=s,this}getX(t){let e=this.array[t*this.itemSize];return this.normalized&&(e=B(e,this.array)),e}setX(t,e){return this.normalized&&(e=L(e,this.array)),this.array[t*this.itemSize]=e,this}getY(t){let e=this.array[t*this.itemSize+1];return this.normalized&&(e=B(e,this.array)),e}setY(t,e){return this.normalized&&(e=L(e,this.array)),this.array[t*this.itemSize+1]=e,this}getZ(t){let e=this.array[t*this.itemSize+2];return this.normalized&&(e=B(e,this.array)),e}setZ(t,e){return this.normalized&&(e=L(e,this.array)),this.array[t*this.itemSize+2]=e,this}getW(t){let e=this.array[t*this.itemSize+3];return this.normalized&&(e=B(e,this.array)),e}setW(t,e){return this.normalized&&(e=L(e,this.array)),this.array[t*this.itemSize+3]=e,this}setXY(t,e,s){return t*=this.itemSize,this.normalized&&(e=L(e,this.array),s=L(s,this.array)),this.array[t+0]=e,this.array[t+1]=s,this}setXYZ(t,e,s,i){return t*=this.itemSize,this.normalized&&(e=L(e,this.array),s=L(s,this.array),i=L(i,this.array)),this.array[t+0]=e,this.array[t+1]=s,this.array[t+2]=i,this}setXYZW(t,e,s,i,r){return t*=this.itemSize,this.normalized&&(e=L(e,this.array),s=L(s,this.array),i=L(i,this.array),r=L(r,this.array)),this.array[t+0]=e,this.array[t+1]=s,this.array[t+2]=i,this.array[t+3]=r,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(t.name=this.name),this.usage!==T&&(t.usage=this.usage),t}}class Ue extends ke{constructor(t,e,s){super(new Uint16Array(t),e,s)}}class We extends ke{constructor(t,e,s){super(new Uint32Array(t),e,s)}}class je extends ke{constructor(t,e,s){super(new Float32Array(t),e,s)}}let qe=0;const He=new Bt,Ge=new le,Xe=new at,Ye=new lt,$e=new lt,Ze=new at;class Je extends A{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:qe++}),this.uuid=R(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return Array.isArray(t)?this.index=new(function(t){for(let e=t.length-1;e>=0;--e)if(t[e]>=65535)return!0;return!1}(t)?We:Ue)(t,1):this.index=t,this}setIndirect(t){return this.indirect=t,this}getIndirect(){return this.indirect}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return void 0!==this.attributes[t]}addGroup(t,e,s=0){this.groups.push({start:t,count:e,materialIndex:s})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const s=this.attributes.normal;if(void 0!==s){const e=(new k).getNormalMatrix(t);s.applyNormalMatrix(e),s.needsUpdate=!0}const i=this.attributes.tangent;return void 0!==i&&(i.transformDirection(t),i.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(t){return He.makeRotationFromQuaternion(t),this.applyMatrix4(He),this}rotateX(t){return He.makeRotationX(t),this.applyMatrix4(He),this}rotateY(t){return He.makeRotationY(t),this.applyMatrix4(He),this}rotateZ(t){return He.makeRotationZ(t),this.applyMatrix4(He),this}translate(t,e,s){return He.makeTranslation(t,e,s),this.applyMatrix4(He),this}scale(t,e,s){return He.makeScale(t,e,s),this.applyMatrix4(He),this}lookAt(t){return Ge.lookAt(t),Ge.updateMatrix(),this.applyMatrix4(Ge.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Xe).negate(),this.translate(Xe.x,Xe.y,Xe.z),this}setFromPoints(t){const e=this.getAttribute("position");if(void 0===e){const e=[];for(let s=0,i=t.length;s<i;s++){const i=t[s];e.push(i.x,i.y,i.z||0)}this.setAttribute("position",new je(e,3))}else{const s=Math.min(t.length,e.count);for(let i=0;i<s;i++){const s=t[i];e.setXYZ(i,s.x,s.y,s.z||0)}t.length,e.count,e.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new lt);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)this.boundingBox.set(new at(-1/0,-1/0,-1/0),new at(1/0,1/0,1/0));else{if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,s=e.length;t<s;t++){const s=e[t];Ye.setFromBufferAttribute(s),this.morphTargetsRelative?(Ze.addVectors(this.boundingBox.min,Ye.min),this.boundingBox.expandByPoint(Ze),Ze.addVectors(this.boundingBox.max,Ye.max),this.boundingBox.expandByPoint(Ze)):(this.boundingBox.expandByPoint(Ye.min),this.boundingBox.expandByPoint(Ye.max))}}else this.boundingBox.makeEmpty();isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new At);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)this.boundingSphere.set(new at,1/0);else if(t){const s=this.boundingSphere.center;if(Ye.setFromBufferAttribute(t),e)for(let t=0,s=e.length;t<s;t++){const s=e[t];$e.setFromBufferAttribute(s),this.morphTargetsRelative?(Ze.addVectors(Ye.min,$e.min),Ye.expandByPoint(Ze),Ze.addVectors(Ye.max,$e.max),Ye.expandByPoint(Ze)):(Ye.expandByPoint($e.min),Ye.expandByPoint($e.max))}Ye.getCenter(s);let i=0;for(let e=0,r=t.count;e<r;e++)Ze.fromBufferAttribute(t,e),i=Math.max(i,s.distanceToSquared(Ze));if(e)for(let r=0,n=e.length;r<n;r++){const n=e[r],a=this.morphTargetsRelative;for(let e=0,r=n.count;e<r;e++)Ze.fromBufferAttribute(n,e),a&&(Xe.fromBufferAttribute(t,e),Ze.add(Xe)),i=Math.max(i,s.distanceToSquared(Ze))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)}}computeTangents(){const t=this.index,e=this.attributes;if(null===t||void 0===e.position||void 0===e.normal||void 0===e.uv)return;const s=e.position,i=e.normal,r=e.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new ke(new Float32Array(4*s.count),4));const n=this.getAttribute("tangent"),a=[],o=[];for(let t=0;t<s.count;t++)a[t]=new at,o[t]=new at;const h=new at,l=new at,u=new at,c=new D,d=new D,p=new D,m=new at,g=new at;function y(t,e,i){h.fromBufferAttribute(s,t),l.fromBufferAttribute(s,e),u.fromBufferAttribute(s,i),c.fromBufferAttribute(r,t),d.fromBufferAttribute(r,e),p.fromBufferAttribute(r,i),l.sub(h),u.sub(h),d.sub(c),p.sub(c);const n=1/(d.x*p.y-p.x*d.y);isFinite(n)&&(m.copy(l).multiplyScalar(p.y).addScaledVector(u,-d.y).multiplyScalar(n),g.copy(u).multiplyScalar(d.x).addScaledVector(l,-p.x).multiplyScalar(n),a[t].add(m),a[e].add(m),a[i].add(m),o[t].add(g),o[e].add(g),o[i].add(g))}let f=this.groups;0===f.length&&(f=[{start:0,count:t.count}]);for(let e=0,s=f.length;e<s;++e){const s=f[e],i=s.start;for(let e=i,r=i+s.count;e<r;e+=3)y(t.getX(e+0),t.getX(e+1),t.getX(e+2))}const x=new at,b=new at,v=new at,w=new at;function N(t){v.fromBufferAttribute(i,t),w.copy(v);const e=a[t];x.copy(e),x.sub(v.multiplyScalar(v.dot(e))).normalize(),b.crossVectors(w,e);const s=b.dot(o[t])<0?-1:1;n.setXYZW(t,x.x,x.y,x.z,s)}for(let e=0,s=f.length;e<s;++e){const s=f[e],i=s.start;for(let e=i,r=i+s.count;e<r;e+=3)N(t.getX(e+0)),N(t.getX(e+1)),N(t.getX(e+2))}}computeVertexNormals(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let s=this.getAttribute("normal");if(void 0===s)s=new ke(new Float32Array(3*e.count),3),this.setAttribute("normal",s);else for(let t=0,e=s.count;t<e;t++)s.setXYZ(t,0,0,0);const i=new at,r=new at,n=new at,a=new at,o=new at,h=new at,l=new at,u=new at;if(t)for(let c=0,d=t.count;c<d;c+=3){const d=t.getX(c+0),p=t.getX(c+1),m=t.getX(c+2);i.fromBufferAttribute(e,d),r.fromBufferAttribute(e,p),n.fromBufferAttribute(e,m),l.subVectors(n,r),u.subVectors(i,r),l.cross(u),a.fromBufferAttribute(s,d),o.fromBufferAttribute(s,p),h.fromBufferAttribute(s,m),a.add(l),o.add(l),h.add(l),s.setXYZ(d,a.x,a.y,a.z),s.setXYZ(p,o.x,o.y,o.z),s.setXYZ(m,h.x,h.y,h.z)}else for(let t=0,a=e.count;t<a;t+=3)i.fromBufferAttribute(e,t+0),r.fromBufferAttribute(e,t+1),n.fromBufferAttribute(e,t+2),l.subVectors(n,r),u.subVectors(i,r),l.cross(u),s.setXYZ(t+0,l.x,l.y,l.z),s.setXYZ(t+1,l.x,l.y,l.z),s.setXYZ(t+2,l.x,l.y,l.z);this.normalizeNormals(),s.needsUpdate=!0}}normalizeNormals(){const t=this.attributes.normal;for(let e=0,s=t.count;e<s;e++)Ze.fromBufferAttribute(t,e),Ze.normalize(),t.setXYZ(e,Ze.x,Ze.y,Ze.z)}toNonIndexed(){function t(t,e){const s=t.array,i=t.itemSize,r=t.normalized,n=new s.constructor(e.length*i);let a=0,o=0;for(let r=0,h=e.length;r<h;r++){a=t.isInterleavedBufferAttribute?e[r]*t.data.stride+t.offset:e[r]*i;for(let t=0;t<i;t++)n[o++]=s[a++]}return new ke(n,i,r)}if(null===this.index)return this;const e=new Je,s=this.index.array,i=this.attributes;for(const r in i){const n=t(i[r],s);e.setAttribute(r,n)}const r=this.morphAttributes;for(const i in r){const n=[],a=r[i];for(let e=0,i=a.length;e<i;e++){const i=t(a[e],s);n.push(i)}e.morphAttributes[i]=n}e.morphTargetsRelative=this.morphTargetsRelative;const n=this.groups;for(let t=0,s=n.length;t<s;t++){const s=n[t];e.addGroup(s.start,s.count,s.materialIndex)}return e}toJSON(){const t={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const s in e)void 0!==e[s]&&(t[s]=e[s]);return t}t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const s=this.attributes;for(const e in s){const i=s[e];t.data.attributes[e]=i.toJSON(t.data)}const i={};let r=!1;for(const e in this.morphAttributes){const s=this.morphAttributes[e],n=[];for(let e=0,i=s.length;e<i;e++){const i=s[e];n.push(i.toJSON(t.data))}n.length>0&&(i[e]=n,r=!0)}r&&(t.data.morphAttributes=i,t.data.morphTargetsRelative=this.morphTargetsRelative);const n=this.groups;n.length>0&&(t.data.groups=JSON.parse(JSON.stringify(n)));const a=this.boundingSphere;return null!==a&&(t.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),t}clone(){return(new this.constructor).copy(this)}copy(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const s=t.index;null!==s&&this.setIndex(s.clone(e));const i=t.attributes;for(const t in i){const s=i[t];this.setAttribute(t,s.clone(e))}const r=t.morphAttributes;for(const t in r){const s=[],i=r[t];for(let t=0,r=i.length;t<r;t++)s.push(i[t].clone(e));this.morphAttributes[t]=s}this.morphTargetsRelative=t.morphTargetsRelative;const n=t.groups;for(let t=0,e=n.length;t<e;t++){const e=n[t];this.addGroup(e.start,e.count,e.materialIndex)}const a=t.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=t.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const Ke=new Bt,Qe=new Ft,ts=new At,es=new at,ss=new at,is=new at,rs=new at,ns=new at,as=new at,os=new at,hs=new at;class ls extends le{constructor(t=new Je,e=new Re){super(),this.isMesh=!0,this.type="Mesh",this.geometry=t,this.material=e,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const s=t[e[0]];if(void 0!==s){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=s.length;t<e;t++){const e=s[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}getVertexPosition(t,e){const s=this.geometry,i=s.attributes.position,r=s.morphAttributes.position,n=s.morphTargetsRelative;e.fromBufferAttribute(i,t);const a=this.morphTargetInfluences;if(r&&a){as.set(0,0,0);for(let s=0,i=r.length;s<i;s++){const i=a[s],o=r[s];0!==i&&(ns.fromBufferAttribute(o,t),n?as.addScaledVector(ns,i):as.addScaledVector(ns.sub(e),i))}e.add(as)}return e}raycast(t,e){const s=this.geometry,i=this.material,r=this.matrixWorld;if(void 0!==i){if(null===s.boundingSphere&&s.computeBoundingSphere(),ts.copy(s.boundingSphere),ts.applyMatrix4(r),Qe.copy(t.ray).recast(t.near),!1===ts.containsPoint(Qe.origin)){if(null===Qe.intersectSphere(ts,es))return;if(Qe.origin.distanceToSquared(es)>(t.far-t.near)**2)return}Ke.copy(r).invert(),Qe.copy(t.ray).applyMatrix4(Ke),null!==s.boundingBox&&!1===Qe.intersectsBox(s.boundingBox)||this._computeIntersections(t,e,Qe)}}_computeIntersections(t,e,s){let i;const r=this.geometry,n=this.material,a=r.index,o=r.attributes.position,h=r.attributes.uv,l=r.attributes.uv1,u=r.attributes.normal,c=r.groups,d=r.drawRange;if(null!==a)if(Array.isArray(n))for(let r=0,o=c.length;r<o;r++){const o=c[r],p=n[o.materialIndex];for(let r=Math.max(o.start,d.start),n=Math.min(a.count,Math.min(o.start+o.count,d.start+d.count));r<n;r+=3){i=us(this,p,t,s,h,l,u,a.getX(r),a.getX(r+1),a.getX(r+2)),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=o.materialIndex,e.push(i))}}else{for(let r=Math.max(0,d.start),o=Math.min(a.count,d.start+d.count);r<o;r+=3){i=us(this,n,t,s,h,l,u,a.getX(r),a.getX(r+1),a.getX(r+2)),i&&(i.faceIndex=Math.floor(r/3),e.push(i))}}else if(void 0!==o)if(Array.isArray(n))for(let r=0,a=c.length;r<a;r++){const a=c[r],p=n[a.materialIndex];for(let r=Math.max(a.start,d.start),n=Math.min(o.count,Math.min(a.start+a.count,d.start+d.count));r<n;r+=3){i=us(this,p,t,s,h,l,u,r,r+1,r+2),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=a.materialIndex,e.push(i))}}else{for(let r=Math.max(0,d.start),a=Math.min(o.count,d.start+d.count);r<a;r+=3){i=us(this,n,t,s,h,l,u,r,r+1,r+2),i&&(i.faceIndex=Math.floor(r/3),e.push(i))}}}}function us(t,e,s,i,r,n,a,o,h,l){t.getVertexPosition(o,ss),t.getVertexPosition(h,is),t.getVertexPosition(l,rs);const u=function(t,e,s,i,r,n,a,o){let h;if(h=1===e.side?i.intersectTriangle(a,n,r,!0,o):i.intersectTriangle(r,n,a,0===e.side,o),null===h)return null;hs.copy(o),hs.applyMatrix4(t.matrixWorld);const l=s.ray.origin.distanceTo(hs);return l<s.near||l>s.far?null:{distance:l,point:hs.clone(),object:t}}(t,e,s,i,ss,is,rs,os);if(u){const t=new at;Te.getBarycoord(os,ss,is,rs,t),r&&(u.uv=Te.getInterpolatedAttribute(r,o,h,l,t,new D)),n&&(u.uv1=Te.getInterpolatedAttribute(n,o,h,l,t,new D)),a&&(u.normal=Te.getInterpolatedAttribute(a,o,h,l,t,new at),u.normal.dot(i.direction)>0&&u.normal.multiplyScalar(-1));const e={a:o,b:h,c:l,normal:new at,materialIndex:0};Te.getNormal(ss,is,rs,e.normal),u.face=e,u.barycoord=t}return u}class cs extends Je{constructor(t=1,e=1,s=1,i=1,r=1,n=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:s,widthSegments:i,heightSegments:r,depthSegments:n};const a=this;i=Math.floor(i),r=Math.floor(r),n=Math.floor(n);const o=[],h=[],l=[],u=[];let c=0,d=0;function p(t,e,s,i,r,n,p,m,g,y,f){const x=n/g,b=p/y,v=n/2,w=p/2,N=m/2,T=g+1,M=y+1;let _=0,S=0;const A=new at;for(let n=0;n<M;n++){const a=n*b-w;for(let o=0;o<T;o++){const c=o*x-v;A[t]=c*i,A[e]=a*r,A[s]=N,h.push(A.x,A.y,A.z),A[t]=0,A[e]=0,A[s]=m>0?1:-1,l.push(A.x,A.y,A.z),u.push(o/g),u.push(1-n/y),_+=1}}for(let t=0;t<y;t++)for(let e=0;e<g;e++){const s=c+e+T*t,i=c+e+T*(t+1),r=c+(e+1)+T*(t+1),n=c+(e+1)+T*t;o.push(s,i,n),o.push(i,r,n),S+=6}a.addGroup(d,S,f),d+=S,c+=_}p("z","y","x",-1,-1,s,e,t,n,r,0),p("z","y","x",1,-1,s,e,-t,n,r,1),p("x","z","y",1,1,t,s,e,i,n,2),p("x","z","y",1,-1,t,s,-e,i,n,3),p("x","y","z",1,-1,t,e,s,i,r,4),p("x","y","z",-1,-1,t,e,-s,i,r,5),this.setIndex(o),this.setAttribute("position",new je(h,3)),this.setAttribute("normal",new je(l,3)),this.setAttribute("uv",new je(u,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new cs(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}}class ds extends le{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Bt,this.projectionMatrix=new Bt,this.projectionMatrixInverse=new Bt,this.coordinateSystem=_}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this.coordinateSystem=t.coordinateSystem,this}getWorldDirection(t){return super.getWorldDirection(t).negate()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const ps=new at,ms=new D,gs=new D;class ys extends ds{constructor(t=50,e=1,s=.1,i=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=s,this.far=i,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}setFocalLength(t){const e=.5*this.getFilmHeight()/t;this.fov=2*I*Math.atan(e),this.updateProjectionMatrix()}getFocalLength(){const t=Math.tan(.5*C*this.fov);return.5*this.getFilmHeight()/t}getEffectiveFOV(){return 2*I*Math.atan(Math.tan(.5*C*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(t,e,s){ps.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),e.set(ps.x,ps.y).multiplyScalar(-t/ps.z),ps.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),s.set(ps.x,ps.y).multiplyScalar(-t/ps.z)}getViewSize(t,e){return this.getViewBounds(t,ms,gs),e.subVectors(gs,ms)}setViewOffset(t,e,s,i,r,n){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=s,this.view.offsetY=i,this.view.width=r,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=this.near;let e=t*Math.tan(.5*C*this.fov)/this.zoom,s=2*e,i=this.aspect*s,r=-.5*i;const n=this.view;if(null!==this.view&&this.view.enabled){const t=n.fullWidth,a=n.fullHeight;r+=n.offsetX*i/t,e-=n.offsetY*s/a,i*=n.width/t,s*=n.height/a}const a=this.filmOffset;0!==a&&(r+=t*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+i,e,e-s,t,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}class fs{constructor(t,e){this.isInterleavedBuffer=!0,this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.usage=T,this.updateRanges=[],this.version=0,this.uuid=R()}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.usage=t.usage,this}copyAt(t,e,s){t*=this.stride,s*=e.stride;for(let i=0,r=this.stride;i<r;i++)this.array[t+i]=e.array[s+i];return this}set(t,e=0){return this.array.set(t,e),this}clone(t){void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=R()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const e=new this.array.constructor(t.arrayBuffers[this.array.buffer._uuid]),s=new this.constructor(e,this.stride);return s.setUsage(this.usage),s}onUpload(t){return this.onUploadCallback=t,this}toJSON(t){return void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=R()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const xs=new at;class bs{constructor(t,e,s,i=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=t,this.itemSize=e,this.offset=s,this.normalized=i}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(t){this.data.needsUpdate=t}applyMatrix4(t){for(let e=0,s=this.data.count;e<s;e++)xs.fromBufferAttribute(this,e),xs.applyMatrix4(t),this.setXYZ(e,xs.x,xs.y,xs.z);return this}applyNormalMatrix(t){for(let e=0,s=this.count;e<s;e++)xs.fromBufferAttribute(this,e),xs.applyNormalMatrix(t),this.setXYZ(e,xs.x,xs.y,xs.z);return this}transformDirection(t){for(let e=0,s=this.count;e<s;e++)xs.fromBufferAttribute(this,e),xs.transformDirection(t),this.setXYZ(e,xs.x,xs.y,xs.z);return this}getComponent(t,e){let s=this.array[t*this.data.stride+this.offset+e];return this.normalized&&(s=B(s,this.array)),s}setComponent(t,e,s){return this.normalized&&(s=L(s,this.array)),this.data.array[t*this.data.stride+this.offset+e]=s,this}setX(t,e){return this.normalized&&(e=L(e,this.array)),this.data.array[t*this.data.stride+this.offset]=e,this}setY(t,e){return this.normalized&&(e=L(e,this.array)),this.data.array[t*this.data.stride+this.offset+1]=e,this}setZ(t,e){return this.normalized&&(e=L(e,this.array)),this.data.array[t*this.data.stride+this.offset+2]=e,this}setW(t,e){return this.normalized&&(e=L(e,this.array)),this.data.array[t*this.data.stride+this.offset+3]=e,this}getX(t){let e=this.data.array[t*this.data.stride+this.offset];return this.normalized&&(e=B(e,this.array)),e}getY(t){let e=this.data.array[t*this.data.stride+this.offset+1];return this.normalized&&(e=B(e,this.array)),e}getZ(t){let e=this.data.array[t*this.data.stride+this.offset+2];return this.normalized&&(e=B(e,this.array)),e}getW(t){let e=this.data.array[t*this.data.stride+this.offset+3];return this.normalized&&(e=B(e,this.array)),e}setXY(t,e,s){return t=t*this.data.stride+this.offset,this.normalized&&(e=L(e,this.array),s=L(s,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=s,this}setXYZ(t,e,s,i){return t=t*this.data.stride+this.offset,this.normalized&&(e=L(e,this.array),s=L(s,this.array),i=L(i,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=s,this.data.array[t+2]=i,this}setXYZW(t,e,s,i,r){return t=t*this.data.stride+this.offset,this.normalized&&(e=L(e,this.array),s=L(s,this.array),i=L(i,this.array),r=L(r,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=s,this.data.array[t+2]=i,this.data.array[t+3]=r,this}clone(t){if(void 0===t){const t=[];for(let e=0;e<this.count;e++){const s=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[s+e])}return new ke(new this.array.constructor(t),this.itemSize,this.normalized)}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new bs(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(t){if(void 0===t){const t=[];for(let e=0;e<this.count;e++){const s=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[s+e])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.toJSON(t)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class vs extends ke{constructor(t,e,s,i=1){super(t,e,s),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=i}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}toJSON(){const t=super.toJSON();return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}const ws=new at,Ns=new at,Ts=new k;class Ms{constructor(t=new at(1,0,0),e=0){this.isPlane=!0,this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,s,i){return this.normal.set(t,e,s),this.constant=i,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,s){const i=ws.subVectors(s,e).cross(Ns.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(i,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(t).addScaledVector(this.normal,-this.distanceToPoint(t))}intersectLine(t,e){const s=t.delta(ws),i=this.normal.dot(s);if(0===i)return 0===this.distanceToPoint(t.start)?e.copy(t.start):null;const r=-(t.start.dot(this.normal)+this.constant)/i;return r<0||r>1?null:e.copy(t.start).addScaledVector(s,r)}intersectsLine(t){const e=this.distanceToPoint(t.start),s=this.distanceToPoint(t.end);return e<0&&s>0||s<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const s=e||Ts.getNormalMatrix(t),i=this.coplanarPoint(ws).applyMatrix4(t),r=this.normal.applyMatrix3(s).normalize();return this.constant=-i.dot(r),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return(new this.constructor).copy(this)}}class _s extends et{constructor(t,e){super({width:t,height:e}),this.isFramebufferTexture=!0,this.magFilter=a,this.minFilter=a,this.generateMipmaps=!1,this.needsUpdate=!0}}class Ss extends et{constructor(t,e,s,i,r,n,o,h,u,c=1026){if(c!==p&&c!==m)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===s&&c===p&&(s=l),void 0===s&&c===m&&(s=1020),super(null,i,r,n,o,h,c,s,u),this.isDepthTexture=!0,this.image={width:t,height:e},this.magFilter=void 0!==o?o:a,this.minFilter=void 0!==h?h:a,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(t){return super.copy(t),this.source=new K(Object.assign({},t.image)),this.compareFunction=t.compareFunction,this}toJSON(t){const e=super.toJSON(t);return null!==this.compareFunction&&(e.compareFunction=this.compareFunction),e}}function As(t,e,s){return!t||!s&&t.constructor===e?t:"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t)}class zs{constructor(t,e,s,i){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==i?i:new e.constructor(s),this.sampleValues=e,this.valueSize=s,this.settings=null,this.DefaultSettings_={}}evaluate(t){const e=this.parameterPositions;let s=this._cachedIndex,i=e[s],r=e[s-1];t:{e:{let n;s:{i:if(!(t<i)){for(let n=s+2;;){if(void 0===i){if(t<r)break i;return s=e.length,this._cachedIndex=s,this.copySampleValue_(s-1)}if(s===n)break;if(r=i,i=e[++s],t<i)break e}n=e.length;break s}if(!(t>=r)){const a=e[1];t<a&&(s=2,r=a);for(let n=s-2;;){if(void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(s===n)break;if(i=r,r=e[--s-1],t>=r)break e}n=s,s=0;break s}break t}for(;s<n;){const i=s+n>>>1;t<e[i]?n=i:s=i+1}if(i=e[s],r=e[s-1],void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===i)return s=e.length,this._cachedIndex=s,this.copySampleValue_(s-1)}this._cachedIndex=s,this.intervalChanged_(s,r,i)}return this.interpolate_(s,r,t,i)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(t){const e=this.resultBuffer,s=this.sampleValues,i=this.valueSize,r=t*i;for(let t=0;t!==i;++t)e[t]=s[r+t];return e}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class Vs extends zs{constructor(t,e,s,i){super(t,e,s,i),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(t,e,s){const i=this.parameterPositions;let r=t-2,n=t+1,a=i[r],o=i[n];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:r=t,a=2*e-s;break;case 2402:r=i.length-2,a=e+i[r]-i[r+1];break;default:r=t,a=s}if(void 0===o)switch(this.getSettings_().endingEnd){case 2401:n=t,o=2*s-e;break;case 2402:n=1,o=s+i[1]-i[0];break;default:n=t-1,o=e}const h=.5*(s-e),l=this.valueSize;this._weightPrev=h/(e-a),this._weightNext=h/(o-s),this._offsetPrev=r*l,this._offsetNext=n*l}interpolate_(t,e,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=t*a,h=o-a,l=this._offsetPrev,u=this._offsetNext,c=this._weightPrev,d=this._weightNext,p=(s-e)/(i-e),m=p*p,g=m*p,y=-c*g+2*c*m-c*p,f=(1+c)*g+(-1.5-2*c)*m+(-.5+c)*p+1,x=(-1-d)*g+(1.5+d)*m+.5*p,b=d*g-d*m;for(let t=0;t!==a;++t)r[t]=y*n[l+t]+f*n[h+t]+x*n[o+t]+b*n[u+t];return r}}class Cs extends zs{constructor(t,e,s,i){super(t,e,s,i)}interpolate_(t,e,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=t*a,h=o-a,l=(s-e)/(i-e),u=1-l;for(let t=0;t!==a;++t)r[t]=n[h+t]*u+n[o+t]*l;return r}}class Is extends zs{constructor(t,e,s,i){super(t,e,s,i)}interpolate_(t){return this.copySampleValue_(t-1)}}class Rs{constructor(t,e,s,i){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=As(e,this.TimeBufferType),this.values=As(s,this.ValueBufferType),this.setInterpolation(i||this.DefaultInterpolation)}static toJSON(t){const e=t.constructor;let s;if(e.toJSON!==this.toJSON)s=e.toJSON(t);else{s={name:t.name,times:As(t.times,Array),values:As(t.values,Array)};const e=t.getInterpolation();e!==t.DefaultInterpolation&&(s.interpolation=e)}return s.type=t.ValueTypeName,s}InterpolantFactoryMethodDiscrete(t){return new Is(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodLinear(t){return new Cs(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodSmooth(t){return new Vs(this.times,this.values,this.getValueSize(),t)}setInterpolation(t){let e;switch(t){case g:e=this.InterpolantFactoryMethodDiscrete;break;case y:e=this.InterpolantFactoryMethodLinear;break;case f:e=this.InterpolantFactoryMethodSmooth}if(void 0===e){const e="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error(e);this.setInterpolation(this.DefaultInterpolation)}return this}return this.createInterpolant=e,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return g;case this.InterpolantFactoryMethodLinear:return y;case this.InterpolantFactoryMethodSmooth:return f}}getValueSize(){return this.values.length/this.times.length}shift(t){if(0!==t){const e=this.times;for(let s=0,i=e.length;s!==i;++s)e[s]+=t}return this}scale(t){if(1!==t){const e=this.times;for(let s=0,i=e.length;s!==i;++s)e[s]*=t}return this}trim(t,e){const s=this.times,i=s.length;let r=0,n=i-1;for(;r!==i&&s[r]<t;)++r;for(;-1!==n&&s[n]>e;)--n;if(++n,0!==r||n!==i){r>=n&&(n=Math.max(n,1),r=n-1);const t=this.getValueSize();this.times=s.slice(r,n),this.values=this.values.slice(r*t,n*t)}return this}validate(){let t=!0;const e=this.getValueSize();e-Math.floor(e)!==0&&(t=!1);const s=this.times,i=this.values,r=s.length;0===r&&(t=!1);let n=null;for(let e=0;e!==r;e++){const i=s[e];if("number"==typeof i&&isNaN(i)){t=!1;break}if(null!==n&&n>i){t=!1;break}n=i}if(void 0!==i&&(a=i,ArrayBuffer.isView(a)&&!(a instanceof DataView)))for(let e=0,s=i.length;e!==s;++e){const s=i[e];if(isNaN(s)){t=!1;break}}var a;return t}optimize(){const t=this.times.slice(),e=this.values.slice(),s=this.getValueSize(),i=this.getInterpolation()===f,r=t.length-1;let n=1;for(let a=1;a<r;++a){let r=!1;const o=t[a];if(o!==t[a+1]&&(1!==a||o!==t[0]))if(i)r=!0;else{const t=a*s,i=t-s,n=t+s;for(let a=0;a!==s;++a){const s=e[t+a];if(s!==e[i+a]||s!==e[n+a]){r=!0;break}}}if(r){if(a!==n){t[n]=t[a];const i=a*s,r=n*s;for(let t=0;t!==s;++t)e[r+t]=e[i+t]}++n}}if(r>0){t[n]=t[r];for(let t=r*s,i=n*s,a=0;a!==s;++a)e[i+a]=e[t+a];++n}return n!==t.length?(this.times=t.slice(0,n),this.values=e.slice(0,n*s)):(this.times=t,this.values=e),this}clone(){const t=this.times.slice(),e=this.values.slice(),s=new(0,this.constructor)(this.name,t,e);return s.createInterpolant=this.createInterpolant,s}}Rs.prototype.TimeBufferType=Float32Array,Rs.prototype.ValueBufferType=Float32Array,Rs.prototype.DefaultInterpolation=y;class Es extends Rs{constructor(t,e,s){super(t,e,s)}}Es.prototype.ValueTypeName="bool",Es.prototype.ValueBufferType=Array,Es.prototype.DefaultInterpolation=g,Es.prototype.InterpolantFactoryMethodLinear=void 0,Es.prototype.InterpolantFactoryMethodSmooth=void 0;class Os extends Rs{}Os.prototype.ValueTypeName="color";class Fs extends Rs{}Fs.prototype.ValueTypeName="number";class Bs extends zs{constructor(t,e,s,i){super(t,e,s,i)}interpolate_(t,e,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=(s-e)/(i-e);let h=t*a;for(let t=h+a;h!==t;h+=4)nt.slerpFlat(r,0,n,h-a,n,h,o);return r}}class Ls extends Rs{InterpolantFactoryMethodLinear(t){return new Bs(this.times,this.values,this.getValueSize(),t)}}Ls.prototype.ValueTypeName="quaternion",Ls.prototype.InterpolantFactoryMethodSmooth=void 0;class Ps extends Rs{constructor(t,e,s){super(t,e,s)}}Ps.prototype.ValueTypeName="string",Ps.prototype.ValueBufferType=Array,Ps.prototype.DefaultInterpolation=g,Ps.prototype.InterpolantFactoryMethodLinear=void 0,Ps.prototype.InterpolantFactoryMethodSmooth=void 0;class Ds extends Rs{}Ds.prototype.ValueTypeName="vector";class ks{constructor(t,e,s){const i=this;let r,n=!1,a=0,o=0;const h=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=s,this.itemStart=function(t){o++,!1===n&&void 0!==i.onStart&&i.onStart(t,a,o),n=!0},this.itemEnd=function(t){a++,void 0!==i.onProgress&&i.onProgress(t,a,o),a===o&&(n=!1,void 0!==i.onLoad&&i.onLoad())},this.itemError=function(t){void 0!==i.onError&&i.onError(t)},this.resolveURL=function(t){return r?r(t):t},this.setURLModifier=function(t){return r=t,this},this.addHandler=function(t,e){return h.push(t,e),this},this.removeHandler=function(t){const e=h.indexOf(t);return-1!==e&&h.splice(e,2),this},this.getHandler=function(t){for(let e=0,s=h.length;e<s;e+=2){const s=h[e],i=h[e+1];if(s.global&&(s.lastIndex=0),s.test(t))return i}return null}}}const Us=new ks;class Ws{constructor(t){this.manager=void 0!==t?t:Us,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(t,e){const s=this;return new Promise(function(i,r){s.load(t,i,e,r)})}parse(){}setCrossOrigin(t){return this.crossOrigin=t,this}setWithCredentials(t){return this.withCredentials=t,this}setPath(t){return this.path=t,this}setResourcePath(t){return this.resourcePath=t,this}setRequestHeader(t){return this.requestHeader=t,this}}Ws.DEFAULT_MATERIAL_NAME="__DEFAULT";Error;class js extends ds{constructor(t=-1,e=1,s=1,i=-1,r=.1,n=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=s,this.bottom=i,this.near=r,this.far=n,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this}setViewOffset(t,e,s,i,r,n){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=s,this.view.offsetY=i,this.view.width=r,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),s=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let r=s-t,n=s+t,a=i+e,o=i-e;if(null!==this.view&&this.view.enabled){const t=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=t*this.view.offsetX,n=r+t*this.view.width,a-=e*this.view.offsetY,o=a-e*this.view.height}this.projectionMatrix.makeOrthographic(r,n,a,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}class qs extends fs{constructor(t,e,s=1){super(t,e),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=s}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}clone(t){const e=super.clone(t);return e.meshPerAttribute=this.meshPerAttribute,e}toJSON(t){const e=super.toJSON(t);return e.isInstancedInterleavedBuffer=!0,e.meshPerAttribute=this.meshPerAttribute,e}}class Hs{constructor(t,e,s,i){Hs.prototype.isMatrix2=!0,this.elements=[1,0,0,1],void 0!==t&&this.set(t,e,s,i)}identity(){return this.set(1,0,0,1),this}fromArray(t,e=0){for(let s=0;s<4;s++)this.elements[s]=t[s+e];return this}set(t,e,s,i){const r=this.elements;return r[0]=t,r[2]=e,r[1]=s,r[3]=i,this}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:"174"}})),"undefined"!=typeof window&&(window.__THREE__||(window.__THREE__="174"));const Gs=["alphaMap","alphaTest","anisotropy","anisotropyMap","anisotropyRotation","aoMap","attenuationColor","attenuationDistance","bumpMap","clearcoat","clearcoatMap","clearcoatNormalMap","clearcoatNormalScale","clearcoatRoughness","color","dispersion","displacementMap","emissive","emissiveMap","envMap","gradientMap","ior","iridescence","iridescenceIOR","iridescenceMap","iridescenceThicknessMap","lightMap","map","matcap","metalness","metalnessMap","normalMap","normalScale","opacity","roughness","roughnessMap","sheen","sheenColor","sheenColorMap","sheenRoughnessMap","shininess","specular","specularColor","specularColorMap","specularIntensity","specularIntensityMap","specularMap","thickness","transmission","transmissionMap"];class Xs{constructor(t){this.renderObjects=new WeakMap,this.hasNode=this.containsNode(t),this.hasAnimation=!0===t.object.isSkinnedMesh,this.refreshUniforms=Gs,this.renderId=0}firstInitialization(t){return!1===this.renderObjects.has(t)&&(this.getRenderObjectData(t),!0)}getRenderObjectData(t){let e=this.renderObjects.get(t);if(void 0===e){const{geometry:s,material:i,object:r}=t;if(e={material:this.getMaterialData(i),geometry:{id:s.id,attributes:this.getAttributesData(s.attributes),indexVersion:s.index?s.index.version:null,drawRange:{start:s.drawRange.start,count:s.drawRange.count}},worldMatrix:r.matrixWorld.clone()},r.center&&(e.center=r.center.clone()),r.morphTargetInfluences&&(e.morphTargetInfluences=r.morphTargetInfluences.slice()),null!==t.bundle&&(e.version=t.bundle.version),e.material.transmission>0){const{width:s,height:i}=t.context;e.bufferWidth=s,e.bufferHeight=i}this.renderObjects.set(t,e)}return e}getAttributesData(t){const e={};for(const s in t){const i=t[s];e[s]={version:i.version}}return e}containsNode(t){const e=t.material;for(const t in e)if(e[t]&&e[t].isNode)return!0;return null!==t.renderer.nodes.modelViewMatrix||null!==t.renderer.nodes.modelNormalViewMatrix}getMaterialData(t){const e={};for(const s of this.refreshUniforms){const i=t[s];null!=i&&("object"==typeof i&&void 0!==i.clone?!0===i.isTexture?e[s]={id:i.id,version:i.version}:e[s]=i.clone():e[s]=i)}return e}equals(t){const{object:e,material:s,geometry:i}=t,r=this.getRenderObjectData(t);if(!0!==r.worldMatrix.equals(e.matrixWorld))return r.worldMatrix.copy(e.matrixWorld),!1;const n=r.material;for(const t in n){const e=n[t],i=s[t];if(void 0!==e.equals){if(!1===e.equals(i))return e.copy(i),!1}else if(!0===i.isTexture){if(e.id!==i.id||e.version!==i.version)return e.id=i.id,e.version=i.version,!1}else if(e!==i)return n[t]=i,!1}if(n.transmission>0){const{width:e,height:s}=t.context;if(r.bufferWidth!==e||r.bufferHeight!==s)return r.bufferWidth=e,r.bufferHeight=s,!1}const a=r.geometry,o=i.attributes,h=a.attributes,l=Object.keys(h),u=Object.keys(o);if(a.id!==i.id)return a.id=i.id,!1;if(l.length!==u.length)return r.geometry.attributes=this.getAttributesData(o),!1;for(const t of l){const e=h[t],s=o[t];if(void 0===s)return delete h[t],!1;if(e.version!==s.version)return e.version=s.version,!1}const c=i.index,d=a.indexVersion,p=c?c.version:null;if(d!==p)return a.indexVersion=p,!1;if(a.drawRange.start!==i.drawRange.start||a.drawRange.count!==i.drawRange.count)return a.drawRange.start=i.drawRange.start,a.drawRange.count=i.drawRange.count,!1;if(r.morphTargetInfluences){let t=!1;for(let s=0;s<r.morphTargetInfluences.length;s++)r.morphTargetInfluences[s]!==e.morphTargetInfluences[s]&&(t=!0);if(t)return!0}return r.center&&!1===r.center.equals(e.center)?(r.center.copy(e.center),!0):(null!==t.bundle&&(r.version=t.bundle.version),!0)}needsRefresh(t,e){if(this.hasNode||this.hasAnimation||this.firstInitialization(t))return!0;const{renderId:s}=e;if(this.renderId!==s)return this.renderId=s,!0;const i=!0===t.object.static,r=null!==t.bundle&&!0===t.bundle.static&&this.getRenderObjectData(t).version===t.bundle.version;if(i||r)return!1;return!0!==this.equals(t)}}function Ys(t,e=0){let s=3735928559^e,i=1103547991^e;if(t instanceof Array)for(let e,r=0;r<t.length;r++)e=t[r],s=Math.imul(s^e,2654435761),i=Math.imul(i^e,1597334677);else for(let e,r=0;r<t.length;r++)e=t.charCodeAt(r),s=Math.imul(s^e,2654435761),i=Math.imul(i^e,1597334677);return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&i)+(s>>>0)}const $s=t=>Ys(t),Zs=(...t)=>Ys(t);function Js(t,e=!1){const s=[];!0===t.isNode&&(s.push(t.id),t=t.getSelf());for(const{property:i,childNode:r}of Ks(t))s.push(Ys(i.slice(0,-4)),r.getCacheKey(e));return Ys(s)}function*Ks(t,e=!1){for(const s in t){if(!0===s.startsWith("_"))continue;const i=t[s];if(!0===Array.isArray(i))for(let t=0;t<i.length;t++){const r=i[t];r&&(!0===r.isNode||e&&"function"==typeof r.toJSON)&&(yield{property:s,index:t,childNode:r})}else if(i&&!0===i.isNode)yield{property:s,childNode:i};else if("object"==typeof i)for(const t in i){const r=i[t];r&&(!0===r.isNode||e&&"function"==typeof r.toJSON)&&(yield{property:s,index:t,childNode:r})}}}const Qs=new Map([[1,"float"],[2,"vec2"],[3,"vec3"],[4,"vec4"],[9,"mat3"],[16,"mat4"]]),ti=new WeakMap;function ei(t){if(/[iu]?vec\d/.test(t))return t.startsWith("ivec")?Int32Array:t.startsWith("uvec")?Uint32Array:Float32Array;if(/mat\d/.test(t))return Float32Array;if(/float/.test(t))return Float32Array;if(/uint/.test(t))return Uint32Array;if(/int/.test(t))return Int32Array;throw new Error(`THREE.NodeUtils: Unsupported type: ${t}`)}function si(t){return/float|int|uint/.test(t)?1:/vec2/.test(t)?2:/vec3/.test(t)?3:/vec4/.test(t)||/mat2/.test(t)?4:/mat3/.test(t)?9:/mat4/.test(t)?16:void 0}function ii(t){if(null==t)return null;const e=typeof t;return!0===t.isNode?"node":"number"===e?"float":"boolean"===e?"bool":"string"===e?"string":"function"===e?"shader":!0===t.isVector2?"vec2":!0===t.isVector3?"vec3":!0===t.isVector4?"vec4":!0===t.isMatrix2?"mat2":!0===t.isMatrix3?"mat3":!0===t.isMatrix4?"mat4":!0===t.isColor?"color":t instanceof ArrayBuffer?"ArrayBuffer":null}function ri(t,...e){const s=t?t.slice(-4):void 0;return 1===e.length&&("vec2"===s?e=[e[0],e[0]]:"vec3"===s?e=[e[0],e[0],e[0]]:"vec4"===s&&(e=[e[0],e[0],e[0],e[0]])),"color"===t?new ze(...e):"vec2"===s?new D(...e):"vec3"===s?new at(...e):"vec4"===s?new st(...e):"mat2"===s?new Hs(...e):"mat3"===s?new k(...e):"mat4"===s?new Bt(...e):"bool"===t?e[0]||!1:"float"===t||"int"===t||"uint"===t?e[0]||0:"string"===t?e[0]||"":"ArrayBuffer"===t?oi(e[0]):null}function ni(t){let e=ti.get(t);return void 0===e&&(e={},ti.set(t,e)),e}function ai(t){let e="";const s=new Uint8Array(t);for(let t=0;t<s.length;t++)e+=String.fromCharCode(s[t]);return btoa(e)}function oi(t){return Uint8Array.from(atob(t),t=>t.charCodeAt(0)).buffer}const hi={VERTEX:"vertex",FRAGMENT:"fragment"},li={NONE:"none",FRAME:"frame",RENDER:"render",OBJECT:"object"},ui={READ_ONLY:"readOnly",WRITE_ONLY:"writeOnly",READ_WRITE:"readWrite"},ci=["fragment","vertex"],di=[...ci,"compute"],pi=["x","y","z","w"];let mi=0;class gi extends A{static get type(){return"Node"}constructor(t=null){super(),this.nodeType=t,this.updateType=li.NONE,this.updateBeforeType=li.NONE,this.updateAfterType=li.NONE,this.uuid=P.generateUUID(),this.version=0,this.global=!1,this.isNode=!0,this._cacheKey=null,this._cacheKeyVersion=0,Object.defineProperty(this,"id",{value:mi++})}set needsUpdate(t){!0===t&&this.version++}get type(){return this.constructor.type}onUpdate(t,e){return this.updateType=e,this.update=t.bind(this.getSelf()),this}onFrameUpdate(t){return this.onUpdate(t,li.FRAME)}onRenderUpdate(t){return this.onUpdate(t,li.RENDER)}onObjectUpdate(t){return this.onUpdate(t,li.OBJECT)}onReference(t){return this.updateReference=t.bind(this.getSelf()),this}getSelf(){return this.self||this}updateReference(){return this}isGlobal(){return this.global}*getChildren(){for(const{childNode:t}of Ks(this))yield t}dispose(){this.dispatchEvent({type:"dispose"})}traverse(t){t(this);for(const e of this.getChildren())e.traverse(t)}getCacheKey(t=!1){return!0!==(t=t||this.version!==this._cacheKeyVersion)&&null!==this._cacheKey||(this._cacheKey=Zs(Js(this,t),this.customCacheKey()),this._cacheKeyVersion=this.version),this._cacheKey}customCacheKey(){return 0}getScope(){return this}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getUpdateAfterType(){return this.updateAfterType}getElementType(t){const e=this.getNodeType(t);return t.getElementType(e)}getMemberType(){return"void"}getNodeType(t){const e=t.getNodeProperties(this);return e.outputNode?e.outputNode.getNodeType(t):this.nodeType}getShared(t){const e=this.getHash(t);return t.getNodeFromHash(e)||this}setup(t){const e=t.getNodeProperties(this);let s=0;for(const t of this.getChildren())e["node"+s++]=t;return e.outputNode||null}analyze(t){if(1===t.increaseUsage(this)){const e=t.getNodeProperties(this);for(const s of Object.values(e))s&&!0===s.isNode&&s.build(t)}}generate(t,e){const{outputNode:s}=t.getNodeProperties(this);if(s&&!0===s.isNode)return s.build(t,e)}updateBefore(){}updateAfter(){}update(){}build(t,e=null){const s=this.getShared(t);if(this!==s)return s.build(t,e);t.addNode(this),t.addChain(this);let i=null;const r=t.getBuildStage();if("setup"===r){this.updateReference(t);const e=t.getNodeProperties(this);if(!0!==e.initialized){e.initialized=!0;const s=this.setup(t),i=s&&!0===s.isNode;for(const s of Object.values(e))s&&!0===s.isNode&&s.build(t);i&&s.build(t),e.outputNode=s}}else if("analyze"===r)this.analyze(t);else if("generate"===r){if(1===this.generate.length){const s=this.getNodeType(t),r=t.getDataFromNode(this);i=r.snippet,void 0===i?(i=this.generate(t)||"",r.snippet=i):void 0!==r.flowCodes&&void 0!==t.context.nodeBlock&&t.addFlowCodeHierarchy(this,t.context.nodeBlock),i=t.format(i,s,e)}else i=this.generate(t,e)||""}return t.removeChain(this),t.addSequentialNode(this),i}getSerializeChildren(){return Ks(this)}serialize(t){const e=this.getSerializeChildren(),s={};for(const{property:i,index:r,childNode:n}of e)void 0!==r?(void 0===s[i]&&(s[i]=Number.isInteger(r)?[]:{}),s[i][r]=n.toJSON(t.meta).uuid):s[i]=n.toJSON(t.meta).uuid;Object.keys(s).length>0&&(t.inputNodes=s)}deserialize(t){if(void 0!==t.inputNodes){const e=t.meta.nodes;for(const s in t.inputNodes)if(Array.isArray(t.inputNodes[s])){const i=[];for(const r of t.inputNodes[s])i.push(e[r]);this[s]=i}else if("object"==typeof t.inputNodes[s]){const i={};for(const r in t.inputNodes[s]){const n=t.inputNodes[s][r];i[r]=e[n]}this[s]=i}else{const i=t.inputNodes[s];this[s]=e[i]}}}toJSON(t){const{uuid:e,type:s}=this,i=void 0===t||"string"==typeof t;i&&(t={textures:{},images:{},nodes:{}});let r=t.nodes[e];function n(t){const e=[];for(const s in t){const i=t[s];delete i.metadata,e.push(i)}return e}if(void 0===r&&(r={uuid:e,type:s,meta:t,metadata:{version:4.6,type:"Node",generator:"Node.toJSON"}},!0!==i&&(t.nodes[r.uuid]=r),this.serialize(r),delete r.meta),i){const e=n(t.textures),s=n(t.images),i=n(t.nodes);e.length>0&&(r.textures=e),s.length>0&&(r.images=s),i.length>0&&(r.nodes=i)}return r}}class yi extends gi{static get type(){return"ArrayElementNode"}constructor(t,e){super(),this.node=t,this.indexNode=e,this.isArrayElementNode=!0}getNodeType(t){return this.node.getElementType(t)}generate(t){return`${this.node.build(t)}[ ${this.indexNode.build(t,"uint")} ]`}}class fi extends gi{static get type(){return"ConvertNode"}constructor(t,e){super(),this.node=t,this.convertTo=e}getNodeType(t){const e=this.node.getNodeType(t);let s=null;for(const i of this.convertTo.split("|"))null!==s&&t.getTypeLength(e)!==t.getTypeLength(i)||(s=i);return s}serialize(t){super.serialize(t),t.convertTo=this.convertTo}deserialize(t){super.deserialize(t),this.convertTo=t.convertTo}generate(t,e){const s=this.node,i=this.getNodeType(t),r=s.build(t,i);return t.format(r,i,e)}}class xi extends gi{static get type(){return"TempNode"}constructor(t=null){super(t),this.isTempNode=!0}hasDependencies(t){return t.getDataFromNode(this).usageCount>1}build(t,e){if("generate"===t.getBuildStage()){const s=t.getVectorType(this.getNodeType(t,e)),i=t.getDataFromNode(this);if(void 0!==i.propertyName)return t.format(i.propertyName,s,e);if("void"!==s&&"void"!==e&&this.hasDependencies(t)){const r=super.build(t,s),n=t.getVarFromNode(this,null,s),a=t.getPropertyName(n);return t.addLineFlowCode(`${a} = ${r}`,this),i.snippet=r,i.propertyName=a,t.format(i.propertyName,s,e)}}return super.build(t,e)}}class bi extends xi{static get type(){return"JoinNode"}constructor(t=[],e=null){super(e),this.nodes=t}getNodeType(t){return null!==this.nodeType?t.getVectorType(this.nodeType):t.getTypeFromLength(this.nodes.reduce((e,s)=>e+t.getTypeLength(s.getNodeType(t)),0))}generate(t,e){const s=this.getNodeType(t),i=this.nodes,r=t.getComponentType(s),n=[];for(const e of i){let s=e.build(t);const i=t.getComponentType(e.getNodeType(t));i!==r&&(s=t.format(s,i,r)),n.push(s)}const a=`${t.getType(s)}( ${n.join(", ")} )`;return t.format(a,s,e)}}const vi=pi.join("");class wi extends gi{static get type(){return"SplitNode"}constructor(t,e="x"){super(),this.node=t,this.components=e,this.isSplitNode=!0}getVectorLength(){let t=this.components.length;for(const e of this.components)t=Math.max(pi.indexOf(e)+1,t);return t}getComponentType(t){return t.getComponentType(this.node.getNodeType(t))}getNodeType(t){return t.getTypeFromLength(this.components.length,this.getComponentType(t))}generate(t,e){const s=this.node,i=t.getTypeLength(s.getNodeType(t));let r=null;if(i>1){let n=null;this.getVectorLength()>=i&&(n=t.getTypeFromLength(this.getVectorLength(),this.getComponentType(t)));const a=s.build(t,n);r=this.components.length===i&&this.components===vi.slice(0,this.components.length)?t.format(a,n,e):t.format(`${a}.${this.components}`,this.getNodeType(t),e)}else r=s.build(t,e);return r}serialize(t){super.serialize(t),t.components=this.components}deserialize(t){super.deserialize(t),this.components=t.components}}class Ni extends xi{static get type(){return"SetNode"}constructor(t,e,s){super(),this.sourceNode=t,this.components=e,this.targetNode=s}getNodeType(t){return this.sourceNode.getNodeType(t)}generate(t){const{sourceNode:e,components:s,targetNode:i}=this,r=this.getNodeType(t),n=t.getComponentType(i.getNodeType(t)),a=t.getTypeFromLength(s.length,n),o=i.build(t,a),h=e.build(t,r),l=t.getTypeLength(r),u=[];for(let t=0;t<l;t++){const e=pi[t];e===s[0]?(u.push(o),t+=s.length-1):u.push(h+"."+e)}return`${t.getType(r)}( ${u.join(", ")} )`}}class Ti extends xi{static get type(){return"FlipNode"}constructor(t,e){super(),this.sourceNode=t,this.components=e}getNodeType(t){return this.sourceNode.getNodeType(t)}generate(t){const{components:e,sourceNode:s}=this,i=this.getNodeType(t),r=s.build(t),n=t.getVarFromNode(this),a=t.getPropertyName(n);t.addLineFlowCode(a+" = "+r,this);const o=t.getTypeLength(i),h=[];let l=0;for(let t=0;t<o;t++){const s=pi[t];s===e[l]?(h.push("1.0 - "+a+"."+s),l++):h.push(a+"."+s)}return`${t.getType(i)}( ${h.join(", ")} )`}}class Mi extends gi{static get type(){return"InputNode"}constructor(t,e=null){super(e),this.isInputNode=!0,this.value=t,this.precision=null}getNodeType(){return null===this.nodeType?ii(this.value):this.nodeType}getInputType(t){return this.getNodeType(t)}setPrecision(t){return this.precision=t,this}serialize(t){super.serialize(t),t.value=this.value,this.value&&this.value.toArray&&(t.value=this.value.toArray()),t.valueType=ii(this.value),t.nodeType=this.nodeType,"ArrayBuffer"===t.valueType&&(t.value=ai(t.value)),t.precision=this.precision}deserialize(t){super.deserialize(t),this.nodeType=t.nodeType,this.value=Array.isArray(t.value)?ri(t.valueType,...t.value):t.value,this.precision=t.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(t.value))}generate(){}}const _i=/float|u?int/;class Si extends Mi{static get type(){return"ConstNode"}constructor(t,e=null){super(t,e),this.isConstNode=!0}generateConst(t){return t.generateConst(this.getNodeType(t),this.value)}generate(t,e){const s=this.getNodeType(t);return _i.test(s)&&_i.test(e)?t.generateConst(e,this.value):t.format(this.generateConst(t),s,e)}}class Ai extends gi{static get type(){return"MemberNode"}constructor(t,e){super(),this.node=t,this.property=e,this.isMemberNode=!0}getNodeType(t){return this.node.getMemberType(t,this.property)}generate(t){return this.node.build(t)+"."+this.property}}let zi=null;const Vi=new Map;function Ci(t,e){if(!Vi.has(t)){if("function"!=typeof e)throw new Error(`Node element ${t} is not a function`);Vi.set(t,e)}}const Ii=t=>t.replace(/r|s/g,"x").replace(/g|t/g,"y").replace(/b|p/g,"z").replace(/a|q/g,"w"),Ri=t=>Ii(t).split("").sort().join(""),Ei={setup(t,e){const s=e.shift();return t(rr(s),...e)},get(t,e,s){if("string"==typeof e&&void 0===t[e]){if(!0!==t.isStackNode&&"assign"===e)return(...t)=>(zi.assign(s,...t),s);if(Vi.has(e)){const i=Vi.get(e);return t.isStackNode?(...t)=>s.add(i(...t)):(...t)=>i(s,...t)}if("self"===e)return t;if(e.endsWith("Assign")&&Vi.has(e.slice(0,e.length-6))){const i=Vi.get(e.slice(0,e.length-6));return t.isStackNode?(...t)=>s.assign(t[0],i(...t)):(...t)=>s.assign(i(s,...t))}if(!0===/^[xyzwrgbastpq]{1,4}$/.test(e))return e=Ii(e),ir(new wi(s,e));if(!0===/^set[XYZWRGBASTPQ]{1,4}$/.test(e))return e=Ri(e.slice(3).toLowerCase()),s=>ir(new Ni(t,e,s));if(!0===/^flip[XYZWRGBASTPQ]{1,4}$/.test(e))return e=Ri(e.slice(4).toLowerCase()),()=>ir(new Ti(ir(t),e));if("width"===e||"height"===e||"depth"===e)return"width"===e?e="x":"height"===e?e="y":"depth"===e&&(e="z"),ir(new wi(t,e));if(!0===/^\d+$/.test(e))return ir(new yi(s,new Si(Number(e),"uint")));if(!0===/^get$/.test(e))return t=>ir(new Ai(s,t))}return Reflect.get(t,e,s)},set:(t,e,s,i)=>"string"!=typeof e||void 0!==t[e]||!0!==/^[xyzwrgbastpq]{1,4}$/.test(e)&&"width"!==e&&"height"!==e&&"depth"!==e&&!0!==/^\d+$/.test(e)?Reflect.set(t,e,s,i):(i[e].assign(s),!0)},Oi=new WeakMap,Fi=new WeakMap,Bi=function(t,e=null){for(const s in t)t[s]=ir(t[s],e);return t},Li=function(t,e=null){const s=t.length;for(let i=0;i<s;i++)t[i]=ir(t[i],e);return t},Pi=function(t,e=null,s=null,i=null){const r=t=>ir(null!==i?Object.assign(t,i):t);return null===e?(...e)=>r(new t(...nr(e))):null!==s?(s=ir(s),(...i)=>r(new t(e,...nr(i),s))):(...s)=>r(new t(e,...nr(s)))},Di=function(t,...e){return ir(new t(...nr(e)))};class ki extends gi{constructor(t,e){super(),this.shaderNode=t,this.inputNodes=e}getNodeType(t){return this.shaderNode.nodeType||this.getOutputNode(t).getNodeType(t)}getMemberType(t,e){return this.getOutputNode(t).getMemberType(t,e)}call(t){const{shaderNode:e,inputNodes:s}=this,i=t.getNodeProperties(e);if(i.onceOutput)return i.onceOutput;let r=null;if(e.layout){let i=Fi.get(t.constructor);void 0===i&&(i=new WeakMap,Fi.set(t.constructor,i));let n=i.get(e);void 0===n&&(n=ir(t.buildFunctionNode(e)),i.set(e,n)),t.addInclude(n),r=ir(n.call(s))}else{const i=e.jsFunc,n=null!==s||i.length>1?i(s||[],t):i(t);r=ir(n)}return e.once&&(i.onceOutput=r),r}getOutputNode(t){const e=t.getNodeProperties(this);return null===e.outputNode&&(e.outputNode=this.setupOutput(t)),e.outputNode}setup(t){return this.getOutputNode(t)}setupOutput(t){return t.addStack(),t.stack.outputNode=this.call(t),t.removeStack()}generate(t,e){return this.getOutputNode(t).build(t,e)}}class Ui extends gi{constructor(t,e){super(e),this.jsFunc=t,this.layout=null,this.global=!0,this.once=!1}setLayout(t){return this.layout=t,this}call(t=null){return rr(t),ir(new ki(this,t))}setup(){return this.call()}}const Wi=[!1,!0],ji=[0,1,2,3],qi=[-1,-2],Hi=[.5,1.5,1/3,1e-6,1e6,Math.PI,2*Math.PI,1/Math.PI,2/Math.PI,1/(2*Math.PI),Math.PI/2],Gi=new Map;for(const t of Wi)Gi.set(t,new Si(t));const Xi=new Map;for(const t of ji)Xi.set(t,new Si(t,"uint"));const Yi=new Map([...Xi].map(t=>new Si(t.value,"int")));for(const t of qi)Yi.set(t,new Si(t,"int"));const $i=new Map([...Yi].map(t=>new Si(t.value)));for(const t of Hi)$i.set(t,new Si(t));for(const t of Hi)$i.set(-t,new Si(-t));const Zi={bool:Gi,uint:Xi,ints:Yi,float:$i},Ji=new Map([...Gi,...$i]),Ki=(t,e)=>Ji.has(t)?Ji.get(t):!0===t.isNode?t:new Si(t,e),Qi=function(t,e=null){return(...s)=>{if((0===s.length||!["bool","float","int","uint"].includes(t)&&s.every(t=>"object"!=typeof t))&&(s=[ri(t,...s)]),1===s.length&&null!==e&&e.has(s[0]))return ir(e.get(s[0]));if(1===s.length){const e=Ki(s[0],t);return(t=>{try{return t.getNodeType()}catch(t){return}})(e)===t?ir(e):ir(new fi(e,t))}const i=s.map(t=>Ki(t));return ir(new bi(i,t))}},tr=t=>"object"==typeof t&&null!==t?t.value:t,er=t=>null!=t?t.nodeType||t.convertTo||("string"==typeof t?t:null):null;function sr(t,e){return new Proxy(new Ui(t,e),Ei)}const ir=(t,e=null)=>function(t,e=null){const s=ii(t);if("node"===s){let e=Oi.get(t);return void 0===e&&(e=new Proxy(t,Ei),Oi.set(t,e),Oi.set(e,e)),e}return null===e&&("float"===s||"boolean"===s)||s&&"shader"!==s&&"string"!==s?ir(Ki(t,e)):"shader"===s?hr(t):t}(t,e),rr=(t,e=null)=>new Bi(t,e),nr=(t,e=null)=>new Li(t,e),ar=(...t)=>new Pi(...t),or=(...t)=>new Di(...t),hr=(t,e)=>{const s=new sr(t,e),i=(...t)=>{let e;return rr(t),e=t[0]&&t[0].isNode?[...t]:t[0],s.call(e)};return i.shaderNode=s,i.setLayout=t=>(s.setLayout(t),i),i.once=()=>(s.once=!0,i),i};Ci("toGlobal",t=>(t.global=!0,t));const lr=t=>{zi=t},ur=()=>zi,cr=(...t)=>zi.If(...t);function dr(t){return zi&&zi.add(t),t}Ci("append",dr);const pr=new Qi("color"),mr=new Qi("float",Zi.float),gr=new Qi("int",Zi.ints),yr=new Qi("uint",Zi.uint),fr=new Qi("bool",Zi.bool),xr=new Qi("vec2"),br=new Qi("ivec2"),vr=new Qi("uvec2"),wr=new Qi("bvec2"),Nr=new Qi("vec3"),Tr=new Qi("ivec3"),Mr=new Qi("uvec3"),_r=new Qi("bvec3"),Sr=new Qi("vec4"),Ar=new Qi("ivec4"),zr=new Qi("uvec4"),Vr=new Qi("bvec4"),Cr=new Qi("mat2"),Ir=new Qi("mat3"),Rr=new Qi("mat4");Ci("toColor",pr),Ci("toFloat",mr),Ci("toInt",gr),Ci("toUint",yr),Ci("toBool",fr),Ci("toVec2",xr),Ci("toIVec2",br),Ci("toUVec2",vr),Ci("toBVec2",wr),Ci("toVec3",Nr),Ci("toIVec3",Tr),Ci("toUVec3",Mr),Ci("toBVec3",_r),Ci("toVec4",Sr),Ci("toIVec4",Ar),Ci("toUVec4",zr),Ci("toBVec4",Vr),Ci("toMat2",Cr),Ci("toMat3",Ir),Ci("toMat4",Rr);const Er=ar(yi),Or=(t,e)=>ir(new fi(ir(t),e));Ci("element",Er),Ci("convert",Or);class Fr extends xi{static get type(){return"ArrayNode"}constructor(t,e,s=null){super(t),this.count=e,this.values=s,this.isArrayNode=!0}getNodeType(t){return null===this.nodeType&&(this.nodeType=this.values[0].getNodeType(t)),this.nodeType}getElementType(t){return this.getNodeType(t)}generate(t){const e=this.getNodeType(t);return t.generateArray(e,this.count,this.values)}}const Br=(...t)=>{let e;if(1===t.length){const s=t[0];e=new Fr(null,s.length,s)}else{const s=t[0],i=t[1];e=new Fr(s,i)}return ir(e)};Ci("toArray",(t,e)=>Br(Array(e).fill(t)));class Lr extends gi{static get type(){return"UniformGroupNode"}constructor(t,e=!1,s=1){super("string"),this.name=t,this.shared=e,this.order=s,this.isUniformGroup=!0}serialize(t){super.serialize(t),t.name=this.name,t.version=this.version,t.shared=this.shared}deserialize(t){super.deserialize(t),this.name=t.name,this.version=t.version,this.shared=t.shared}}const Pr=t=>new Lr(t),Dr=(t,e=0)=>new Lr(t,!0,e),kr=Dr("frame"),Ur=Dr("render"),Wr=Pr("object");class jr extends Mi{static get type(){return"UniformNode"}constructor(t,e=null){super(t,e),this.isUniformNode=!0,this.name="",this.groupNode=Wr}label(t){return this.name=t,this}setGroup(t){return this.groupNode=t,this}getGroup(){return this.groupNode}getUniformHash(t){return this.getHash(t)}onUpdate(t,e){const s=this.getSelf();return t=t.bind(s),super.onUpdate(e=>{const i=t(e,s);void 0!==i&&(this.value=i)},e)}generate(t,e){const s=this.getNodeType(t),i=this.getUniformHash(t);let r=t.getNodeFromHash(i);void 0===r&&(t.setHashNode(this,i),r=this);const n=r.getInputType(t),a=t.getUniformFromNode(r,n,t.shaderStage,this.name||t.context.label),o=t.getPropertyName(a);return void 0!==t.context.label&&delete t.context.label,t.format(o,s,e)}}const qr=(t,e)=>{const s=er(e||t),i=t&&!0===t.isNode?t.node&&t.node.value||t.value:t;return ir(new jr(i,s))};class Hr extends gi{static get type(){return"PropertyNode"}constructor(t,e=null,s=!1){super(t),this.name=e,this.varying=s,this.isPropertyNode=!0}getHash(t){return this.name||super.getHash(t)}isGlobal(){return!0}generate(t){let e;return!0===this.varying?(e=t.getVaryingFromNode(this,this.name),e.needsInterpolation=!0):e=t.getVarFromNode(this,this.name),t.getPropertyName(e)}}const Gr=(t,e)=>ir(new Hr(t,e)),Xr=(t,e)=>ir(new Hr(t,e,!0)),Yr=or(Hr,"vec4","DiffuseColor"),$r=or(Hr,"vec3","EmissiveColor"),Zr=or(Hr,"float","Roughness"),Jr=or(Hr,"float","Metalness"),Kr=or(Hr,"float","Clearcoat"),Qr=or(Hr,"float","ClearcoatRoughness"),tn=or(Hr,"vec3","Sheen"),en=or(Hr,"float","SheenRoughness"),sn=or(Hr,"float","Iridescence"),rn=or(Hr,"float","IridescenceIOR"),nn=or(Hr,"float","IridescenceThickness"),an=or(Hr,"float","AlphaT"),on=or(Hr,"float","Anisotropy"),hn=or(Hr,"vec3","AnisotropyT"),ln=or(Hr,"vec3","AnisotropyB"),un=or(Hr,"color","SpecularColor"),cn=or(Hr,"float","SpecularF90"),dn=or(Hr,"float","Shininess"),pn=or(Hr,"vec4","Output"),mn=or(Hr,"float","dashSize"),gn=or(Hr,"float","gapSize"),yn=or(Hr,"float","pointWidth"),fn=or(Hr,"float","IOR"),xn=or(Hr,"float","Transmission"),bn=or(Hr,"float","Thickness"),vn=or(Hr,"float","AttenuationDistance"),wn=or(Hr,"color","AttenuationColor"),Nn=or(Hr,"float","Dispersion");class Tn extends xi{static get type(){return"AssignNode"}constructor(t,e){super(),this.targetNode=t,this.sourceNode=e}hasDependencies(){return!1}getNodeType(t,e){return"void"!==e?this.targetNode.getNodeType(t):"void"}needsSplitAssign(t){const{targetNode:e}=this;if(!1===t.isAvailable("swizzleAssign")&&e.isSplitNode&&e.components.length>1){const s=t.getTypeLength(e.node.getNodeType(t));return pi.join("").slice(0,s)!==e.components}return!1}generate(t,e){const{targetNode:s,sourceNode:i}=this,r=this.needsSplitAssign(t),n=s.getNodeType(t),a=s.context({assign:!0}).build(t),o=i.build(t,n),h=i.getNodeType(t),l=t.getDataFromNode(this);let u;if(!0===l.initialized)"void"!==e&&(u=a);else if(r){const i=t.getVarFromNode(this,null,n),r=t.getPropertyName(i);t.addLineFlowCode(`${r} = ${o}`,this);const h=s.node.context({assign:!0}).build(t);for(let e=0;e<s.components.length;e++){const i=s.components[e];t.addLineFlowCode(`${h}.${i} = ${r}[ ${e} ]`,this)}"void"!==e&&(u=a)}else u=`${a} = ${o}`,"void"!==e&&"void"!==h||(t.addLineFlowCode(u,this),"void"!==e&&(u=a));return l.initialized=!0,t.format(u,n,e)}}const Mn=ar(Tn);Ci("assign",Mn);class _n extends xi{static get type(){return"FunctionCallNode"}constructor(t=null,e={}){super(),this.functionNode=t,this.parameters=e}setParameters(t){return this.parameters=t,this}getParameters(){return this.parameters}getNodeType(t){return this.functionNode.getNodeType(t)}generate(t){const e=[],s=this.functionNode,i=s.getInputs(t),r=this.parameters,n=(e,s)=>{const i=s.type;let r;return r="pointer"===i?"&"+e.build(t):e.build(t,i),r};if(Array.isArray(r))for(let t=0;t<r.length;t++)e.push(n(r[t],i[t]));else for(const t of i){const s=r[t.name];if(void 0===s)throw new Error(`FunctionCallNode: Input '${t.name}' not found in FunctionNode.`);e.push(n(s,t))}return`${s.build(t,"property")}( ${e.join(", ")} )`}}const Sn=(t,...e)=>(e=e.length>1||e[0]&&!0===e[0].isNode?nr(e):rr(e[0]),ir(new _n(ir(t),e)));Ci("call",Sn);class An extends xi{static get type(){return"OperatorNode"}constructor(t,e,s,...i){if(super(),i.length>0){let r=new An(t,e,s);for(let e=0;e<i.length-1;e++)r=new An(t,r,i[e]);e=r,s=i[i.length-1]}this.op=t,this.aNode=e,this.bNode=s,this.isOperatorNode=!0}getNodeType(t,e){const s=this.op,i=this.aNode,r=this.bNode,n=i.getNodeType(t),a=void 0!==r?r.getNodeType(t):null;if("void"===n||"void"===a)return"void";if("%"===s)return n;if("~"===s||"&"===s||"|"===s||"^"===s||">>"===s||"<<"===s)return t.getIntegerType(n);if("!"===s||"=="===s||"&&"===s||"||"===s||"^^"===s)return"bool";if("<"===s||">"===s||"<="===s||">="===s){const s=e?t.getTypeLength(e):Math.max(t.getTypeLength(n),t.getTypeLength(a));return s>1?`bvec${s}`:"bool"}if(t.isMatrix(n)){if("float"===a)return n;if(t.isVector(a))return t.getVectorFromMatrix(n);if(t.isMatrix(a))return n}else if(t.isMatrix(a)){if("float"===n)return a;if(t.isVector(n))return t.getVectorFromMatrix(a)}return t.getTypeLength(a)>t.getTypeLength(n)?a:n}generate(t,e){const s=this.op,i=this.aNode,r=this.bNode,n=this.getNodeType(t,e);let a=null,o=null;"void"!==n?(a=i.getNodeType(t),o=void 0!==r?r.getNodeType(t):null,"<"===s||">"===s||"<="===s||">="===s||"=="===s?t.isVector(a)?o=a:a!==o&&(a=o="float"):">>"===s||"<<"===s?(a=n,o=t.changeComponentType(o,"uint")):t.isMatrix(a)?"float"===o?o="float":t.isVector(o)?o=t.getVectorFromMatrix(a):t.isMatrix(o)||(a=o=n):a=t.isMatrix(o)?"float"===a?"float":t.isVector(a)?t.getVectorFromMatrix(o):o=n:o=n):a=o=n;const h=i.build(t,a),l=void 0!==r?r.build(t,o):null,u=t.getTypeLength(e),c=t.getFunctionOperator(s);return"void"!==e?"<"===s&&u>1?t.useComparisonMethod?t.format(`${t.getMethod("lessThan",e)}( ${h}, ${l} )`,n,e):t.format(`( ${h} < ${l} )`,n,e):"<="===s&&u>1?t.useComparisonMethod?t.format(`${t.getMethod("lessThanEqual",e)}( ${h}, ${l} )`,n,e):t.format(`( ${h} <= ${l} )`,n,e):">"===s&&u>1?t.useComparisonMethod?t.format(`${t.getMethod("greaterThan",e)}( ${h}, ${l} )`,n,e):t.format(`( ${h} > ${l} )`,n,e):">="===s&&u>1?t.useComparisonMethod?t.format(`${t.getMethod("greaterThanEqual",e)}( ${h}, ${l} )`,n,e):t.format(`( ${h} >= ${l} )`,n,e):"!"===s||"~"===s?t.format(`(${s}${h})`,a,e):c?t.format(`${c}( ${h}, ${l} )`,n,e):t.isMatrix(a)&&"float"===o?t.format(`( ${l} ${s} ${h} )`,n,e):"float"===a&&t.isMatrix(o)?t.format(`${h} ${s} ${l}`,n,e):t.format(`( ${h} ${s} ${l} )`,n,e):"void"!==a?c?t.format(`${c}( ${h}, ${l} )`,n,e):t.isMatrix(a)&&"float"===o?t.format(`${l} ${s} ${h}`,n,e):t.format(`${h} ${s} ${l}`,n,e):void 0}serialize(t){super.serialize(t),t.op=this.op}deserialize(t){super.deserialize(t),this.op=t.op}}const zn=ar(An,"+"),Vn=ar(An,"-"),Cn=ar(An,"*"),In=ar(An,"/"),Rn=ar(An,"%"),En=ar(An,"=="),On=ar(An,"!="),Fn=ar(An,"<"),Bn=ar(An,">"),Ln=ar(An,"<="),Pn=ar(An,">="),Dn=ar(An,"&&"),kn=ar(An,"||"),Un=ar(An,"!"),Wn=ar(An,"^^"),jn=ar(An,"&"),qn=ar(An,"~"),Hn=ar(An,"|"),Gn=ar(An,"^"),Xn=ar(An,"<<"),Yn=ar(An,">>");Ci("add",zn),Ci("sub",Vn),Ci("mul",Cn),Ci("div",In),Ci("modInt",Rn),Ci("equal",En),Ci("notEqual",On),Ci("lessThan",Fn),Ci("greaterThan",Bn),Ci("lessThanEqual",Ln),Ci("greaterThanEqual",Pn),Ci("and",Dn),Ci("or",kn),Ci("not",Un),Ci("xor",Wn),Ci("bitAnd",jn),Ci("bitNot",qn),Ci("bitOr",Hn),Ci("bitXor",Gn),Ci("shiftLeft",Xn),Ci("shiftRight",Yn);const $n=(...t)=>Rn(...t);Ci("remainder",$n);class Zn extends xi{static get type(){return"MathNode"}constructor(t,e,s=null,i=null){super(),this.method=t,this.aNode=e,this.bNode=s,this.cNode=i,this.isMathNode=!0}getInputType(t){const e=this.aNode.getNodeType(t),s=this.bNode?this.bNode.getNodeType(t):null,i=this.cNode?this.cNode.getNodeType(t):null,r=t.isMatrix(e)?0:t.getTypeLength(e),n=t.isMatrix(s)?0:t.getTypeLength(s),a=t.isMatrix(i)?0:t.getTypeLength(i);return r>n&&r>a?e:n>a?s:a>r?i:e}getNodeType(t){const e=this.method;return e===Zn.LENGTH||e===Zn.DISTANCE||e===Zn.DOT?"float":e===Zn.CROSS?"vec3":e===Zn.ALL?"bool":e===Zn.EQUALS?t.changeComponentType(this.aNode.getNodeType(t),"bool"):e===Zn.MOD?this.aNode.getNodeType(t):this.getInputType(t)}generate(t,e){let s=this.method;const i=this.getNodeType(t),r=this.getInputType(t),n=this.aNode,a=this.bNode,o=this.cNode,h=t.renderer.coordinateSystem;if(s===Zn.TRANSFORM_DIRECTION){let s=n,i=a;t.isMatrix(s.getNodeType(t))?i=Sr(Nr(i),0):s=Sr(Nr(s),0);const r=Cn(s,i).xyz;return pa(r).build(t,e)}if(s===Zn.NEGATE)return t.format("( - "+n.build(t,r)+" )",i,e);if(s===Zn.ONE_MINUS)return Vn(1,n).build(t,e);if(s===Zn.RECIPROCAL)return In(1,n).build(t,e);if(s===Zn.DIFFERENCE)return wa(Vn(n,a)).build(t,e);{const l=[];return s===Zn.CROSS||s===Zn.MOD?l.push(n.build(t,i),a.build(t,i)):h===_&&s===Zn.STEP?l.push(n.build(t,1===t.getTypeLength(n.getNodeType(t))?"float":r),a.build(t,r)):h===_&&(s===Zn.MIN||s===Zn.MAX)||s===Zn.MOD?l.push(n.build(t,r),a.build(t,1===t.getTypeLength(a.getNodeType(t))?"float":r)):s===Zn.REFRACT?l.push(n.build(t,r),a.build(t,r),o.build(t,"float")):s===Zn.MIX?l.push(n.build(t,r),a.build(t,r),o.build(t,1===t.getTypeLength(o.getNodeType(t))?"float":r)):(h===S&&s===Zn.ATAN&&null!==a&&(s="atan2"),l.push(n.build(t,r)),null!==a&&l.push(a.build(t,r)),null!==o&&l.push(o.build(t,r))),t.format(`${t.getMethod(s,i)}( ${l.join(", ")} )`,i,e)}}serialize(t){super.serialize(t),t.method=this.method}deserialize(t){super.deserialize(t),this.method=t.method}}Zn.ALL="all",Zn.ANY="any",Zn.RADIANS="radians",Zn.DEGREES="degrees",Zn.EXP="exp",Zn.EXP2="exp2",Zn.LOG="log",Zn.LOG2="log2",Zn.SQRT="sqrt",Zn.INVERSE_SQRT="inversesqrt",Zn.FLOOR="floor",Zn.CEIL="ceil",Zn.NORMALIZE="normalize",Zn.FRACT="fract",Zn.SIN="sin",Zn.COS="cos",Zn.TAN="tan",Zn.ASIN="asin",Zn.ACOS="acos",Zn.ATAN="atan",Zn.ABS="abs",Zn.SIGN="sign",Zn.LENGTH="length",Zn.NEGATE="negate",Zn.ONE_MINUS="oneMinus",Zn.DFDX="dFdx",Zn.DFDY="dFdy",Zn.ROUND="round",Zn.RECIPROCAL="reciprocal",Zn.TRUNC="trunc",Zn.FWIDTH="fwidth",Zn.TRANSPOSE="transpose",Zn.BITCAST="bitcast",Zn.EQUALS="equals",Zn.MIN="min",Zn.MAX="max",Zn.MOD="mod",Zn.STEP="step",Zn.REFLECT="reflect",Zn.DISTANCE="distance",Zn.DIFFERENCE="difference",Zn.DOT="dot",Zn.CROSS="cross",Zn.POW="pow",Zn.TRANSFORM_DIRECTION="transformDirection",Zn.MIX="mix",Zn.CLAMP="clamp",Zn.REFRACT="refract",Zn.SMOOTHSTEP="smoothstep",Zn.FACEFORWARD="faceforward";const Jn=mr(1e-6),Kn=mr(1e6),Qn=mr(Math.PI),ta=mr(2*Math.PI),ea=ar(Zn,Zn.ALL),sa=ar(Zn,Zn.ANY),ia=ar(Zn,Zn.RADIANS),ra=ar(Zn,Zn.DEGREES),na=ar(Zn,Zn.EXP),aa=ar(Zn,Zn.EXP2),oa=ar(Zn,Zn.LOG),ha=ar(Zn,Zn.LOG2),la=ar(Zn,Zn.SQRT),ua=ar(Zn,Zn.INVERSE_SQRT),ca=ar(Zn,Zn.FLOOR),da=ar(Zn,Zn.CEIL),pa=ar(Zn,Zn.NORMALIZE),ma=ar(Zn,Zn.FRACT),ga=ar(Zn,Zn.SIN),ya=ar(Zn,Zn.COS),fa=ar(Zn,Zn.TAN),xa=ar(Zn,Zn.ASIN),ba=ar(Zn,Zn.ACOS),va=ar(Zn,Zn.ATAN),wa=ar(Zn,Zn.ABS),Na=ar(Zn,Zn.SIGN),Ta=ar(Zn,Zn.LENGTH),Ma=ar(Zn,Zn.NEGATE),_a=ar(Zn,Zn.ONE_MINUS),Sa=ar(Zn,Zn.DFDX),Aa=ar(Zn,Zn.DFDY),za=ar(Zn,Zn.ROUND),Va=ar(Zn,Zn.RECIPROCAL),Ca=ar(Zn,Zn.TRUNC),Ia=ar(Zn,Zn.FWIDTH),Ra=ar(Zn,Zn.TRANSPOSE),Ea=ar(Zn,Zn.BITCAST),Oa=ar(Zn,Zn.EQUALS),Fa=ar(Zn,Zn.MIN),Ba=ar(Zn,Zn.MAX),La=ar(Zn,Zn.MOD),Pa=ar(Zn,Zn.STEP),Da=ar(Zn,Zn.REFLECT),ka=ar(Zn,Zn.DISTANCE),Ua=ar(Zn,Zn.DIFFERENCE),Wa=ar(Zn,Zn.DOT),ja=ar(Zn,Zn.CROSS),qa=ar(Zn,Zn.POW),Ha=ar(Zn,Zn.POW,2),Ga=ar(Zn,Zn.POW,3),Xa=ar(Zn,Zn.POW,4),Ya=ar(Zn,Zn.TRANSFORM_DIRECTION),$a=t=>Cn(Na(t),qa(wa(t),1/3)),Za=t=>Wa(t,t),Ja=ar(Zn,Zn.MIX),Ka=(t,e=0,s=1)=>ir(new Zn(Zn.CLAMP,ir(t),ir(e),ir(s))),Qa=t=>Ka(t),to=ar(Zn,Zn.REFRACT),eo=ar(Zn,Zn.SMOOTHSTEP),so=ar(Zn,Zn.FACEFORWARD),io=hr(([t])=>{const e=Wa(t.xy,xr(12.9898,78.233)),s=La(e,Qn);return ma(ga(s).mul(43758.5453))}),ro=(t,e,s)=>Ja(e,s,t),no=(t,e,s)=>eo(e,s,t),ao=(t,e)=>va(t,e),oo=so,ho=ua;Ci("all",ea),Ci("any",sa),Ci("equals",Oa),Ci("radians",ia),Ci("degrees",ra),Ci("exp",na),Ci("exp2",aa),Ci("log",oa),Ci("log2",ha),Ci("sqrt",la),Ci("inverseSqrt",ua),Ci("floor",ca),Ci("ceil",da),Ci("normalize",pa),Ci("fract",ma),Ci("sin",ga),Ci("cos",ya),Ci("tan",fa),Ci("asin",xa),Ci("acos",ba),Ci("atan",va),Ci("abs",wa),Ci("sign",Na),Ci("length",Ta),Ci("lengthSq",Za),Ci("negate",Ma),Ci("oneMinus",_a),Ci("dFdx",Sa),Ci("dFdy",Aa),Ci("round",za),Ci("reciprocal",Va),Ci("trunc",Ca),Ci("fwidth",Ia),Ci("atan2",ao),Ci("min",Fa),Ci("max",Ba),Ci("mod",La),Ci("step",Pa),Ci("reflect",Da),Ci("distance",ka),Ci("dot",Wa),Ci("cross",ja),Ci("pow",qa),Ci("pow2",Ha),Ci("pow3",Ga),Ci("pow4",Xa),Ci("transformDirection",Ya),Ci("mix",ro),Ci("clamp",Ka),Ci("refract",to),Ci("smoothstep",no),Ci("faceForward",so),Ci("difference",Ua),Ci("saturate",Qa),Ci("cbrt",$a),Ci("transpose",Ra),Ci("rand",io);class lo extends gi{static get type(){return"ConditionalNode"}constructor(t,e,s=null){super(),this.condNode=t,this.ifNode=e,this.elseNode=s}getNodeType(t){const{ifNode:e,elseNode:s}=t.getNodeProperties(this);if(void 0===e)return this.setup(t),this.getNodeType(t);const i=e.getNodeType(t);if(null!==s){const e=s.getNodeType(t);if(t.getTypeLength(e)>t.getTypeLength(i))return e}return i}setup(t){const e=this.condNode.cache(),s=this.ifNode.cache(),i=this.elseNode?this.elseNode.cache():null,r=t.context.nodeBlock;t.getDataFromNode(s).parentNodeBlock=r,null!==i&&(t.getDataFromNode(i).parentNodeBlock=r);const n=t.getNodeProperties(this);n.condNode=e,n.ifNode=s.context({nodeBlock:s}),n.elseNode=i?i.context({nodeBlock:i}):null}generate(t,e){const s=this.getNodeType(t),i=t.getDataFromNode(this);if(void 0!==i.nodeProperty)return i.nodeProperty;const{condNode:r,ifNode:n,elseNode:a}=t.getNodeProperties(this),o="void"!==e,h=o?Gr(s).build(t):"";i.nodeProperty=h;const l=r.build(t,"bool");t.addFlowCode(`\n${t.tab}if ( ${l} ) {\n\n`).addFlowTab();let u=n.build(t,s);if(u&&(u=o?h+" = "+u+";":"return "+u+";"),t.removeFlowTab().addFlowCode(t.tab+"\t"+u+"\n\n"+t.tab+"}"),null!==a){t.addFlowCode(" else {\n\n").addFlowTab();let e=a.build(t,s);e&&(e=o?h+" = "+e+";":"return "+e+";"),t.removeFlowTab().addFlowCode(t.tab+"\t"+e+"\n\n"+t.tab+"}\n\n")}else t.addFlowCode("\n\n");return t.format(h,s,e)}}const uo=ar(lo);Ci("select",uo);const co=(...t)=>uo(...t);Ci("cond",co);class po extends gi{static get type(){return"ContextNode"}constructor(t,e={}){super(),this.isContextNode=!0,this.node=t,this.value=e}getScope(){return this.node.getScope()}getNodeType(t){return this.node.getNodeType(t)}analyze(t){this.node.build(t)}setup(t){const e=t.getContext();t.setContext({...t.context,...this.value});const s=this.node.build(t);return t.setContext(e),s}generate(t,e){const s=t.getContext();t.setContext({...t.context,...this.value});const i=this.node.build(t,e);return t.setContext(s),i}}const mo=ar(po),go=(t,e)=>mo(t,{label:e});Ci("context",mo),Ci("label",go);class yo extends gi{static get type(){return"VarNode"}constructor(t,e=null,s=!1){super(),this.node=t,this.name=e,this.global=!0,this.isVarNode=!0,this.readOnly=s}getHash(t){return this.name||super.getHash(t)}getMemberType(t,e){return this.node.getMemberType(t,e)}getElementType(t){return this.node.getElementType(t)}getNodeType(t){return this.node.getNodeType(t)}generate(t){const{node:e,name:s,readOnly:i}=this,{renderer:r}=t,n=!0===r.backend.isWebGPUBackend;let a=!1,o=!1;i&&(a=t.isDeterministic(e),o=n?i:a);const h=t.getVectorType(this.getNodeType(t)),l=e.build(t,h),u=t.getVarFromNode(this,s,h,void 0,o),c=t.getPropertyName(u);let d=c;if(o)if(n)d=a?`const ${c}`:`let ${c}`;else{const s=t.getArrayCount(e);d=`const ${t.getVar(u.type,c,s)}`}return t.addLineFlowCode(`${d} = ${l}`,this),c}}const fo=ar(yo),xo=(t,e=null)=>fo(t,e).append(),bo=(t,e=null)=>fo(t,e,!0).append();Ci("toVar",xo),Ci("toConst",bo);const vo=t=>fo(t);Ci("temp",vo);class wo extends gi{static get type(){return"VaryingNode"}constructor(t,e=null){super(),this.node=t,this.name=e,this.isVaryingNode=!0}isGlobal(){return!0}getHash(t){return this.name||super.getHash(t)}getNodeType(t){return this.node.getNodeType(t)}setupVarying(t){const e=t.getNodeProperties(this);let s=e.varying;if(void 0===s){const i=this.name,r=this.getNodeType(t);e.varying=s=t.getVaryingFromNode(this,i,r),e.node=this.node}return s.needsInterpolation||(s.needsInterpolation="fragment"===t.shaderStage),s}setup(t){this.setupVarying(t)}analyze(t){return this.setupVarying(t),this.node.analyze(t)}generate(t){const e=t.getNodeProperties(this),s=this.setupVarying(t),i="fragment"===t.shaderStage&&!0===e.reassignPosition&&t.context.needsPositionReassign;if(void 0===e.propertyName||i){const r=this.getNodeType(t),n=t.getPropertyName(s,hi.VERTEX);t.flowNodeFromShaderStage(hi.VERTEX,this.node,r,n),e.propertyName=n,i?e.reassignPosition=!1:void 0===e.reassignPosition&&t.context.isPositionNodeInput&&(e.reassignPosition=!0)}return t.getPropertyName(s)}}const No=ar(wo),To=t=>No(t);Ci("toVarying",No),Ci("toVertexStage",To),Ci("varying",(...t)=>No(...t)),Ci("vertexStage",(...t)=>No(...t));const Mo=hr(([t])=>{const e=t.mul(.9478672986).add(.0521327014).pow(2.4),s=t.mul(.0773993808),i=t.lessThanEqual(.04045);return Ja(e,s,i)}).setLayout({name:"sRGBTransferEOTF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),_o=hr(([t])=>{const e=t.pow(.41666).mul(1.055).sub(.055),s=t.mul(12.92),i=t.lessThanEqual(.0031308);return Ja(e,s,i)}).setLayout({name:"sRGBTransferOETF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),So="WorkingColorSpace",Ao="OutputColorSpace";class zo extends xi{static get type(){return"ColorSpaceNode"}constructor(t,e,s){super("vec4"),this.colorNode=t,this.source=e,this.target=s}resolveColorSpace(t,e){return e===So?G.workingColorSpace:e===Ao?t.context.outputColorSpace||t.renderer.outputColorSpace:e}setup(t){const{colorNode:e}=this,s=this.resolveColorSpace(t,this.source),i=this.resolveColorSpace(t,this.target);let r=e;return!1!==G.enabled&&s!==i&&s&&i?(G.getTransfer(s)===w&&(r=Sr(Mo(r.rgb),r.a)),G.getPrimaries(s)!==G.getPrimaries(i)&&(r=Sr(Ir(G._getMatrix(new k,s,i)).mul(r.rgb),r.a)),G.getTransfer(i)===w&&(r=Sr(_o(r.rgb),r.a)),r):r}}const Vo=t=>ir(new zo(ir(t),So,Ao)),Co=t=>ir(new zo(ir(t),Ao,So)),Io=(t,e)=>ir(new zo(ir(t),So,e)),Ro=(t,e)=>ir(new zo(ir(t),e,So));Ci("toOutputColorSpace",Vo),Ci("toWorkingColorSpace",Co),Ci("workingToColorSpace",Io),Ci("colorSpaceToWorking",Ro);let Eo=class extends yi{static get type(){return"ReferenceElementNode"}constructor(t,e){super(t,e),this.referenceNode=t,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(t){const e=super.generate(t),s=this.referenceNode.getNodeType(),i=this.getNodeType();return t.format(e,s,i)}};class Oo extends gi{static get type(){return"ReferenceBaseNode"}constructor(t,e,s=null,i=null){super(),this.property=t,this.uniformType=e,this.object=s,this.count=i,this.properties=t.split("."),this.reference=s,this.node=null,this.group=null,this.updateType=li.OBJECT}setGroup(t){return this.group=t,this}element(t){return ir(new Eo(this,ir(t)))}setNodeType(t){const e=qr(null,t).getSelf();null!==this.group&&e.setGroup(this.group),this.node=e}getNodeType(t){return null===this.node&&(this.updateReference(t),this.updateValue()),this.node.getNodeType(t)}getValueFromReference(t=this.reference){const{properties:e}=this;let s=t[e[0]];for(let t=1;t<e.length;t++)s=s[e[t]];return s}updateReference(t){return this.reference=null!==this.object?this.object:t.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const t=this.getValueFromReference();Array.isArray(t)?this.node.array=t:this.node.value=t}}class Fo extends Oo{static get type(){return"RendererReferenceNode"}constructor(t,e,s=null){super(t,e,s),this.renderer=s,this.setGroup(Ur)}updateReference(t){return this.reference=null!==this.renderer?this.renderer:t.renderer,this.reference}}const Bo=(t,e,s=null)=>ir(new Fo(t,e,s));class Lo extends xi{static get type(){return"ToneMappingNode"}constructor(t,e=Do,s=null){super("vec3"),this.toneMapping=t,this.exposureNode=e,this.colorNode=s}customCacheKey(){return Zs(this.toneMapping)}setup(t){const e=this.colorNode||t.context.color,s=this.toneMapping;if(0===s)return e;let i=null;const r=t.renderer.library.getToneMappingFunction(s);return i=null!==r?Sr(r(e.rgb,this.exposureNode),e.a):e,i}}const Po=(t,e,s)=>ir(new Lo(t,ir(e),ir(s))),Do=Bo("toneMappingExposure","float");Ci("toneMapping",(t,e,s)=>Po(e,s,t));class ko extends Mi{static get type(){return"BufferAttributeNode"}constructor(t,e=null,s=0,i=0){super(t,e),this.isBufferNode=!0,this.bufferType=e,this.bufferStride=s,this.bufferOffset=i,this.usage=T,this.instanced=!1,this.attribute=null,this.global=!0,t&&!0===t.isBufferAttribute&&(this.attribute=t,this.usage=t.usage,this.instanced=t.isInstancedBufferAttribute)}getHash(t){if(0===this.bufferStride&&0===this.bufferOffset){let e=t.globalCache.getData(this.value);return void 0===e&&(e={node:this},t.globalCache.setData(this.value,e)),e.node.uuid}return this.uuid}getNodeType(t){return null===this.bufferType&&(this.bufferType=t.getTypeFromAttribute(this.attribute)),this.bufferType}setup(t){if(null!==this.attribute)return;const e=this.getNodeType(t),s=this.value,i=t.getTypeLength(e),r=this.bufferStride||i,n=this.bufferOffset,a=!0===s.isInterleavedBuffer?s:new fs(s,r),o=new bs(a,i,n);a.setUsage(this.usage),this.attribute=o,this.attribute.isInstancedBufferAttribute=this.instanced}generate(t){const e=this.getNodeType(t),s=t.getBufferAttributeFromNode(this,e),i=t.getPropertyName(s);let r=null;if("vertex"===t.shaderStage||"compute"===t.shaderStage)this.name=i,r=i;else{r=No(this).build(t,e)}return r}getInputType(){return"bufferAttribute"}setUsage(t){return this.usage=t,this.attribute&&!0===this.attribute.isBufferAttribute&&(this.attribute.usage=t),this}setInstanced(t){return this.instanced=t,this}}const Uo=(t,e=null,s=0,i=0)=>ir(new ko(t,e,s,i)),Wo=(t,e=null,s=0,i=0)=>Uo(t,e,s,i).setUsage(M),jo=(t,e=null,s=0,i=0)=>Uo(t,e,s,i).setInstanced(!0),qo=(t,e=null,s=0,i=0)=>Wo(t,e,s,i).setInstanced(!0);Ci("toAttribute",t=>Uo(t.value));class Ho extends gi{static get type(){return"ComputeNode"}constructor(t,e,s=[64]){super("void"),this.isComputeNode=!0,this.computeNode=t,this.count=e,this.workgroupSize=s,this.dispatchCount=0,this.version=1,this.name="",this.updateBeforeType=li.OBJECT,this.onInitFunction=null,this.updateDispatchCount()}dispose(){this.dispatchEvent({type:"dispose"})}label(t){return this.name=t,this}updateDispatchCount(){const{count:t,workgroupSize:e}=this;let s=e[0];for(let t=1;t<e.length;t++)s*=e[t];this.dispatchCount=Math.ceil(t/s)}onInit(t){return this.onInitFunction=t,this}updateBefore({renderer:t}){t.compute(this)}generate(t){const{shaderStage:e}=t;if("compute"===e){const e=this.computeNode.build(t,"void");""!==e&&t.addLineFlowCode(e,this)}}}const Go=(t,e,s)=>ir(new Ho(ir(t),e,s));Ci("compute",Go);class Xo extends gi{static get type(){return"CacheNode"}constructor(t,e=!0){super(),this.node=t,this.parent=e,this.isCacheNode=!0}getNodeType(t){const e=t.getCache(),s=t.getCacheFromNode(this,this.parent);t.setCache(s);const i=this.node.getNodeType(t);return t.setCache(e),i}build(t,...e){const s=t.getCache(),i=t.getCacheFromNode(this,this.parent);t.setCache(i);const r=this.node.build(t,...e);return t.setCache(s),r}}const Yo=(t,e)=>ir(new Xo(ir(t),e));Ci("cache",Yo);class $o extends gi{static get type(){return"BypassNode"}constructor(t,e){super(),this.isBypassNode=!0,this.outputNode=t,this.callNode=e}getNodeType(t){return this.outputNode.getNodeType(t)}generate(t){const e=this.callNode.build(t,"void");return""!==e&&t.addLineFlowCode(e,this),this.outputNode.build(t)}}const Zo=ar($o);Ci("bypass",Zo);class Jo extends gi{static get type(){return"RemapNode"}constructor(t,e,s,i=mr(0),r=mr(1)){super(),this.node=t,this.inLowNode=e,this.inHighNode=s,this.outLowNode=i,this.outHighNode=r,this.doClamp=!0}setup(){const{node:t,inLowNode:e,inHighNode:s,outLowNode:i,outHighNode:r,doClamp:n}=this;let a=t.sub(e).div(s.sub(e));return!0===n&&(a=a.clamp()),a.mul(r.sub(i)).add(i)}}const Ko=ar(Jo,null,null,{doClamp:!1}),Qo=ar(Jo);Ci("remap",Ko),Ci("remapClamp",Qo);class th extends gi{static get type(){return"ExpressionNode"}constructor(t="",e="void"){super(e),this.snippet=t}generate(t,e){const s=this.getNodeType(t),i=this.snippet;if("void"!==s)return t.format(`( ${i} )`,s,e);t.addLineFlowCode(i,this)}}const eh=ar(th),sh=t=>(t?uo(t,eh("discard")):eh("discard")).append();Ci("discard",sh);class ih extends xi{static get type(){return"RenderOutputNode"}constructor(t,e,s){super("vec4"),this.colorNode=t,this.toneMapping=e,this.outputColorSpace=s,this.isRenderOutputNode=!0}setup({context:t}){let e=this.colorNode||t.color;const s=(null!==this.toneMapping?this.toneMapping:t.toneMapping)||0,i=(null!==this.outputColorSpace?this.outputColorSpace:t.outputColorSpace)||"";return 0!==s&&(e=e.toneMapping(s)),""!==i&&i!==G.workingColorSpace&&(e=e.workingToColorSpace(i)),e}}const rh=(t,e=null,s=null)=>ir(new ih(ir(t),e,s));Ci("renderOutput",rh);class nh extends gi{static get type(){return"AttributeNode"}constructor(t,e=null){super(e),this.global=!0,this._attributeName=t}getHash(t){return this.getAttributeName(t)}getNodeType(t){let e=this.nodeType;if(null===e){const s=this.getAttributeName(t);if(t.hasGeometryAttribute(s)){const i=t.geometry.getAttribute(s);e=t.getTypeFromAttribute(i)}else e="float"}return e}setAttributeName(t){return this._attributeName=t,this}getAttributeName(){return this._attributeName}generate(t){const e=this.getAttributeName(t),s=this.getNodeType(t);if(!0===t.hasGeometryAttribute(e)){const i=t.geometry.getAttribute(e),r=t.getTypeFromAttribute(i),n=t.getAttribute(e,r);if("vertex"===t.shaderStage)return t.format(n.name,r,s);return No(this).build(t,s)}return t.generateConst(s)}serialize(t){super.serialize(t),t.global=this.global,t._attributeName=this._attributeName}deserialize(t){super.deserialize(t),this.global=t.global,this._attributeName=t._attributeName}}const ah=(t,e)=>ir(new nh(t,e)),oh=(t=0)=>ah("uv"+(t>0?t:""),"vec2");class hh extends gi{static get type(){return"TextureSizeNode"}constructor(t,e=null){super("uvec2"),this.isTextureSizeNode=!0,this.textureNode=t,this.levelNode=e}generate(t,e){const s=this.textureNode.build(t,"property"),i=null===this.levelNode?"0":this.levelNode.build(t,"int");return t.format(`${t.getMethod("textureDimensions")}( ${s}, ${i} )`,this.getNodeType(t),e)}}const lh=ar(hh);class uh extends jr{static get type(){return"MaxMipLevelNode"}constructor(t){super(0),this._textureNode=t,this.updateType=li.FRAME}get textureNode(){return this._textureNode}get texture(){return this._textureNode.value}update(){const t=this.texture,e=t.images,s=e&&e.length>0?e[0]&&e[0].image||e[0]:t.image;if(s&&void 0!==s.width){const{width:t,height:e}=s;this.value=Math.log2(Math.max(t,e))}}}const ch=ar(uh);class dh extends jr{static get type(){return"TextureNode"}constructor(t,e=null,s=null,i=null){super(t),this.isTextureNode=!0,this.uvNode=e,this.levelNode=s,this.biasNode=i,this.compareNode=null,this.depthNode=null,this.gradNode=null,this.sampler=!0,this.updateMatrix=!1,this.updateType=li.NONE,this.referenceNode=null,this._value=t,this._matrixUniform=null,this.setUpdateMatrix(null===e)}set value(t){this.referenceNode?this.referenceNode.value=t:this._value=t}get value(){return this.referenceNode?this.referenceNode.value:this._value}getUniformHash(){return this.value.uuid}getNodeType(){return!0===this.value.isDepthTexture?"float":this.value.type===l?"uvec4":1013===this.value.type?"ivec4":"vec4"}getInputType(){return"texture"}getDefaultUV(){return oh(this.value.channel)}updateReference(){return this.value}getTransformedUV(t){return null===this._matrixUniform&&(this._matrixUniform=qr(this.value.matrix)),this._matrixUniform.mul(Nr(t,1)).xy}setUpdateMatrix(t){return this.updateMatrix=t,this.updateType=t?li.RENDER:li.NONE,this}setupUV(t,e){const s=this.value;return t.isFlipY()&&(s.image instanceof ImageBitmap&&!0===s.flipY||!0===s.isRenderTargetTexture||!0===s.isFramebufferTexture||!0===s.isDepthTexture)&&(e=this.sampler?e.flipY():e.setY(gr(lh(this,this.levelNode).y).sub(e.y).sub(1))),e}setup(t){const e=t.getNodeProperties(this);e.referenceNode=this.referenceNode;const s=this.value;if(!s||!0!==s.isTexture)throw new Error("THREE.TSL: `texture( value )` function expects a valid instance of THREE.Texture().");let i=this.uvNode;null!==i&&!0!==t.context.forceUVContext||!t.context.getUV||(i=t.context.getUV(this)),i||(i=this.getDefaultUV()),!0===this.updateMatrix&&(i=this.getTransformedUV(i)),i=this.setupUV(t,i);let r=this.levelNode;null===r&&t.context.getTextureLevel&&(r=t.context.getTextureLevel(this)),e.uvNode=i,e.levelNode=r,e.biasNode=this.biasNode,e.compareNode=this.compareNode,e.gradNode=this.gradNode,e.depthNode=this.depthNode}generateUV(t,e){return e.build(t,!0===this.sampler?"vec2":"ivec2")}generateSnippet(t,e,s,i,r,n,a,o){const h=this.value;let l;return l=i?t.generateTextureLevel(h,e,s,i,n):r?t.generateTextureBias(h,e,s,r,n):o?t.generateTextureGrad(h,e,s,o,n):a?t.generateTextureCompare(h,e,s,a,n):!1===this.sampler?t.generateTextureLoad(h,e,s,n):t.generateTexture(h,e,s,n),l}generate(t,e){const s=this.value,i=t.getNodeProperties(this),r=super.generate(t,"property");if("sampler"===e)return r+"_sampler";if(t.isReference(e))return r;{const n=t.getDataFromNode(this);let a=n.propertyName;if(void 0===a){const{uvNode:e,levelNode:s,biasNode:o,compareNode:h,depthNode:l,gradNode:u}=i,c=this.generateUV(t,e),d=s?s.build(t,"float"):null,p=o?o.build(t,"float"):null,m=l?l.build(t,"int"):null,g=h?h.build(t,"float"):null,y=u?[u[0].build(t,"vec2"),u[1].build(t,"vec2")]:null,f=t.getVarFromNode(this);a=t.getPropertyName(f);const x=this.generateSnippet(t,r,c,d,p,m,g,y);t.addLineFlowCode(`${a} = ${x}`,this),n.snippet=x,n.propertyName=a}let o=a;const h=this.getNodeType(t);return t.needsToWorkingColorSpace(s)&&(o=Ro(eh(o,h),s.colorSpace).setup(t).build(t,h)),t.format(o,h,e)}}setSampler(t){return this.sampler=t,this}getSampler(){return this.sampler}uv(t){return this.sample(t)}sample(t){const e=this.clone();return e.uvNode=ir(t),e.referenceNode=this.getSelf(),ir(e)}blur(t){const e=this.clone();return e.biasNode=ir(t).mul(ch(e)),e.referenceNode=this.getSelf(),ir(e)}level(t){const e=this.clone();return e.levelNode=ir(t),e.referenceNode=this.getSelf(),ir(e)}size(t){return lh(this,t)}bias(t){const e=this.clone();return e.biasNode=ir(t),e.referenceNode=this.getSelf(),ir(e)}compare(t){const e=this.clone();return e.compareNode=ir(t),e.referenceNode=this.getSelf(),ir(e)}grad(t,e){const s=this.clone();return s.gradNode=[ir(t),ir(e)],s.referenceNode=this.getSelf(),ir(s)}depth(t){const e=this.clone();return e.depthNode=ir(t),e.referenceNode=this.getSelf(),ir(e)}serialize(t){super.serialize(t),t.value=this.value.toJSON(t.meta).uuid,t.sampler=this.sampler,t.updateMatrix=this.updateMatrix,t.updateType=this.updateType}deserialize(t){super.deserialize(t),this.value=t.meta.textures[t.value],this.sampler=t.sampler,this.updateMatrix=t.updateMatrix,this.updateType=t.updateType}update(){const t=this.value,e=this._matrixUniform;null!==e&&(e.value=t.matrix),!0===t.matrixAutoUpdate&&t.updateMatrix()}clone(){const t=new this.constructor(this.value,this.uvNode,this.levelNode,this.biasNode);return t.sampler=this.sampler,t}}const ph=ar(dh),mh=(...t)=>ph(...t).setSampler(!1);class gh extends jr{static get type(){return"BufferNode"}constructor(t,e,s=0){super(t,e),this.isBufferNode=!0,this.bufferType=e,this.bufferCount=s}getElementType(t){return this.getNodeType(t)}getInputType(){return"buffer"}}const yh=(t,e,s)=>ir(new gh(t,e,s));class fh extends yi{static get type(){return"UniformArrayElementNode"}constructor(t,e){super(t,e),this.isArrayBufferElementNode=!0}generate(t){const e=super.generate(t),s=this.getNodeType(),i=this.node.getPaddedType();return t.format(e,i,s)}}class xh extends gh{static get type(){return"UniformArrayNode"}constructor(t,e=null){super(null),this.array=t,this.elementType=null===e?ii(t[0]):e,this.paddedType=this.getPaddedType(),this.updateType=li.RENDER,this.isArrayBufferNode=!0}getNodeType(){return this.paddedType}getElementType(){return this.elementType}getPaddedType(){const t=this.elementType;let e="vec4";return"mat2"===t?e="mat2":!0===/mat/.test(t)?e="mat4":"i"===t.charAt(0)?e="ivec4":"u"===t.charAt(0)&&(e="uvec4"),e}update(){const{array:t,value:e}=this,s=this.elementType;if("float"===s||"int"===s||"uint"===s)for(let s=0;s<t.length;s++){e[4*s]=t[s]}else if("color"===s)for(let s=0;s<t.length;s++){const i=4*s,r=t[s];e[i]=r.r,e[i+1]=r.g,e[i+2]=r.b||0}else if("mat2"===s)for(let s=0;s<t.length;s++){const i=4*s,r=t[s];e[i]=r.elements[0],e[i+1]=r.elements[1],e[i+2]=r.elements[2],e[i+3]=r.elements[3]}else if("mat3"===s)for(let s=0;s<t.length;s++){const i=16*s,r=t[s];e[i]=r.elements[0],e[i+1]=r.elements[1],e[i+2]=r.elements[2],e[i+4]=r.elements[3],e[i+5]=r.elements[4],e[i+6]=r.elements[5],e[i+8]=r.elements[6],e[i+9]=r.elements[7],e[i+10]=r.elements[8],e[i+15]=1}else if("mat4"===s)for(let s=0;s<t.length;s++){const i=16*s,r=t[s];for(let t=0;t<r.elements.length;t++)e[i+t]=r.elements[t]}else for(let s=0;s<t.length;s++){const i=4*s,r=t[s];e[i]=r.x,e[i+1]=r.y,e[i+2]=r.z||0,e[i+3]=r.w||0}}setup(t){const e=this.array.length,s=this.elementType;let i=Float32Array;const r=this.paddedType,n=t.getTypeLength(r);return"i"===s.charAt(0)&&(i=Int32Array),"u"===s.charAt(0)&&(i=Uint32Array),this.value=new i(e*n),this.bufferCount=e,this.bufferType=r,super.setup(t)}element(t){return ir(new fh(this,ir(t)))}}const bh=(t,e)=>ir(new xh(t,e)),vh=qr(0,"uint").setGroup(Dr("cameraIndex")).toVarying("v_cameraIndex"),wh=qr("float").label("cameraNear").setGroup(Ur).onRenderUpdate(({camera:t})=>t.near),Nh=qr("float").label("cameraFar").setGroup(Ur).onRenderUpdate(({camera:t})=>t.far),Th=hr(({camera:t})=>{let e;if(t.isArrayCamera&&t.cameras.length>0){const s=[];for(const e of t.cameras)s.push(e.projectionMatrix);e=bh(s).setGroup(Ur).label("cameraProjectionMatrices").element(vh).toVar("cameraProjectionMatrix")}else e=qr("mat4").label("cameraProjectionMatrix").setGroup(Ur).onRenderUpdate(({camera:t})=>t.projectionMatrix);return e}).once()(),Mh=qr("mat4").label("cameraProjectionMatrixInverse").setGroup(Ur).onRenderUpdate(({camera:t})=>t.projectionMatrixInverse),_h=hr(({camera:t})=>{let e;if(t.isArrayCamera&&t.cameras.length>0){const s=[];for(const e of t.cameras)s.push(e.matrixWorldInverse);e=bh(s).setGroup(Ur).label("cameraViewMatrices").element(vh).toVar("cameraViewMatrix")}else e=qr("mat4").label("cameraViewMatrix").setGroup(Ur).onRenderUpdate(({camera:t})=>t.matrixWorldInverse);return e}).once()(),Sh=qr("mat4").label("cameraWorldMatrix").setGroup(Ur).onRenderUpdate(({camera:t})=>t.matrixWorld),Ah=qr("mat3").label("cameraNormalMatrix").setGroup(Ur).onRenderUpdate(({camera:t})=>t.normalMatrix),zh=qr(new at).label("cameraPosition").setGroup(Ur).onRenderUpdate(({camera:t},e)=>e.value.setFromMatrixPosition(t.matrixWorld)),Vh=new At;class Ch extends gi{static get type(){return"Object3DNode"}constructor(t,e=null){super(),this.scope=t,this.object3d=e,this.updateType=li.OBJECT,this._uniformNode=new jr(null)}getNodeType(){const t=this.scope;return t===Ch.WORLD_MATRIX?"mat4":t===Ch.POSITION||t===Ch.VIEW_POSITION||t===Ch.DIRECTION||t===Ch.SCALE?"vec3":t===Ch.RADIUS?"float":void 0}update(t){const e=this.object3d,s=this._uniformNode,i=this.scope;if(i===Ch.WORLD_MATRIX)s.value=e.matrixWorld;else if(i===Ch.POSITION)s.value=s.value||new at,s.value.setFromMatrixPosition(e.matrixWorld);else if(i===Ch.SCALE)s.value=s.value||new at,s.value.setFromMatrixScale(e.matrixWorld);else if(i===Ch.DIRECTION)s.value=s.value||new at,e.getWorldDirection(s.value);else if(i===Ch.VIEW_POSITION){const i=t.camera;s.value=s.value||new at,s.value.setFromMatrixPosition(e.matrixWorld),s.value.applyMatrix4(i.matrixWorldInverse)}else if(i===Ch.RADIUS){const i=t.object.geometry;null===i.boundingSphere&&i.computeBoundingSphere(),Vh.copy(i.boundingSphere).applyMatrix4(e.matrixWorld),s.value=Vh.radius}}generate(t){const e=this.scope;return e===Ch.WORLD_MATRIX?this._uniformNode.nodeType="mat4":e===Ch.POSITION||e===Ch.VIEW_POSITION||e===Ch.DIRECTION||e===Ch.SCALE?this._uniformNode.nodeType="vec3":e===Ch.RADIUS&&(this._uniformNode.nodeType="float"),this._uniformNode.build(t)}serialize(t){super.serialize(t),t.scope=this.scope}deserialize(t){super.deserialize(t),this.scope=t.scope}}Ch.WORLD_MATRIX="worldMatrix",Ch.POSITION="position",Ch.SCALE="scale",Ch.VIEW_POSITION="viewPosition",Ch.DIRECTION="direction",Ch.RADIUS="radius";const Ih=ar(Ch,Ch.DIRECTION),Rh=ar(Ch,Ch.WORLD_MATRIX),Eh=ar(Ch,Ch.POSITION),Oh=ar(Ch,Ch.SCALE),Fh=ar(Ch,Ch.VIEW_POSITION),Bh=ar(Ch,Ch.RADIUS);class Lh extends Ch{static get type(){return"ModelNode"}constructor(t){super(t)}update(t){this.object3d=t.object,super.update(t)}}const Ph=or(Lh,Lh.DIRECTION),Dh=or(Lh,Lh.WORLD_MATRIX),kh=or(Lh,Lh.POSITION),Uh=or(Lh,Lh.SCALE),Wh=or(Lh,Lh.VIEW_POSITION),jh=or(Lh,Lh.RADIUS),qh=qr(new k).onObjectUpdate(({object:t},e)=>e.value.getNormalMatrix(t.matrixWorld)),Hh=qr(new Bt).onObjectUpdate(({object:t},e)=>e.value.copy(t.matrixWorld).invert()),Gh=hr(t=>t.renderer.nodes.modelViewMatrix||Xh).once()().toVar("modelViewMatrix"),Xh=_h.mul(Dh),Yh=hr(t=>(t.context.isHighPrecisionModelViewMatrix=!0,qr("mat4").onObjectUpdate(({object:t,camera:e})=>t.modelViewMatrix.multiplyMatrices(e.matrixWorldInverse,t.matrixWorld)))).once()().toVar("highpModelViewMatrix"),$h=hr(t=>{const e=t.context.isHighPrecisionModelViewMatrix;return qr("mat3").onObjectUpdate(({object:t,camera:s})=>(!0!==e&&t.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix)))}).once()().toVar("highpModelNormalViewMatrix"),Zh=ah("position","vec3"),Jh=Zh.toVarying("positionLocal"),Kh=Zh.toVarying("positionPrevious"),Qh=Dh.mul(Jh).xyz.toVarying("v_positionWorld").context({needsPositionReassign:!0}),tl=Jh.transformDirection(Dh).toVarying("v_positionWorldDirection").normalize().toVar("positionWorldDirection").context({needsPositionReassign:!0}),el=hr(t=>t.context.setupPositionView(),"vec3").once()().toVarying("v_positionView").context({needsPositionReassign:!0}),sl=el.negate().toVarying("v_positionViewDirection").normalize().toVar("positionViewDirection");class il extends gi{static get type(){return"FrontFacingNode"}constructor(){super("bool"),this.isFrontFacingNode=!0}generate(t){const{renderer:e,material:s}=t;return e.coordinateSystem===_&&1===s.side?"false":t.getFrontFacing()}}const rl=or(il),nl=mr(rl).mul(2).sub(1),al=ah("normal","vec3"),ol=hr(t=>!1===t.geometry.hasAttribute("normal")?Nr(0,1,0):al,"vec3").once()().toVar("normalLocal"),hl=el.dFdx().cross(el.dFdy()).normalize().toVar("normalFlat"),ll=hr(t=>{let e;return e=!0===t.material.flatShading?hl:No(gl(ol),"v_normalView").normalize(),e},"vec3").once()().toVar("normalView"),ul=No(ll.transformDirection(_h),"v_normalWorld").normalize().toVar("normalWorld"),cl=hr(t=>t.context.setupNormal().context({getUV:null}),"vec3").once()().mul(nl).toVar("transformedNormalView"),dl=cl.transformDirection(_h).toVar("transformedNormalWorld"),pl=hr(t=>t.context.setupClearcoatNormal().context({getUV:null}),"vec3").once()().mul(nl).toVar("transformedClearcoatNormalView"),ml=hr(([t,e=Dh])=>{const s=Ir(e),i=t.div(Nr(s[0].dot(s[0]),s[1].dot(s[1]),s[2].dot(s[2])));return s.mul(i).xyz}),gl=hr(([t],e)=>{const s=e.renderer.nodes.modelNormalViewMatrix;if(null!==s)return s.transformDirection(t);const i=qh.mul(t);return _h.transformDirection(i)}),yl=new Gt,fl=new Bt,xl=qr(0).onReference(({material:t})=>t).onObjectUpdate(({material:t})=>t.refractionRatio),bl=qr(1).onReference(({material:t})=>t).onObjectUpdate(function({material:t,scene:e}){return t.envMap?t.envMapIntensity:e.environmentIntensity}),vl=qr(new Bt).onReference(function(t){return t.material}).onObjectUpdate(function({material:t,scene:e}){const s=null!==e.environment&&null===t.envMap?e.environmentRotation:t.envMapRotation;return s?(yl.copy(s),fl.makeRotationFromEuler(yl)):fl.identity(),fl}),wl=sl.negate().reflect(cl),Nl=sl.negate().refract(cl,xl),Tl=wl.transformDirection(_h).toVar("reflectVector"),Ml=Nl.transformDirection(_h).toVar("reflectVector");class _l extends dh{static get type(){return"CubeTextureNode"}constructor(t,e=null,s=null,i=null){super(t,e,s,i),this.isCubeTextureNode=!0}getInputType(){return"cubeTexture"}getDefaultUV(){const t=this.value;return t.mapping===e?Tl:t.mapping===s?Ml:Nr(0,0,0)}setUpdateMatrix(){}setupUV(t,e){const s=this.value;return t.renderer.coordinateSystem!==S&&s.isRenderTargetTexture||(e=Nr(e.x.negate(),e.yz)),vl.mul(e)}generateUV(t,e){return e.build(t,"vec3")}}const Sl=ar(_l);class Al extends yi{static get type(){return"ReferenceElementNode"}constructor(t,e){super(t,e),this.referenceNode=t,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(t){const e=super.generate(t),s=this.referenceNode.getNodeType(),i=this.getNodeType();return t.format(e,s,i)}}class zl extends gi{static get type(){return"ReferenceNode"}constructor(t,e,s=null,i=null){super(),this.property=t,this.uniformType=e,this.object=s,this.count=i,this.properties=t.split("."),this.reference=s,this.node=null,this.group=null,this.name=null,this.updateType=li.OBJECT}element(t){return ir(new Al(this,ir(t)))}setGroup(t){return this.group=t,this}label(t){return this.name=t,this}setNodeType(t){let e=null;e=null!==this.count?yh(null,t,this.count):Array.isArray(this.getValueFromReference())?bh(null,t):"texture"===t?ph(null):"cubeTexture"===t?Sl(null):qr(null,t),null!==this.group&&e.setGroup(this.group),null!==this.name&&e.label(this.name),this.node=e.getSelf()}getNodeType(t){return null===this.node&&(this.updateReference(t),this.updateValue()),this.node.getNodeType(t)}getValueFromReference(t=this.reference){const{properties:e}=this;let s=t[e[0]];for(let t=1;t<e.length;t++)s=s[e[t]];return s}updateReference(t){return this.reference=null!==this.object?this.object:t.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const t=this.getValueFromReference();Array.isArray(t)?this.node.array=t:this.node.value=t}}const Vl=(t,e,s)=>ir(new zl(t,e,s)),Cl=(t,e,s,i)=>ir(new zl(t,e,i,s));class Il extends zl{static get type(){return"MaterialReferenceNode"}constructor(t,e,s=null){super(t,e,s),this.material=s,this.isMaterialReferenceNode=!0}updateReference(t){return this.reference=null!==this.material?this.material:t.material,this.reference}}const Rl=(t,e,s=null)=>ir(new Il(t,e,s)),El=hr(t=>(!1===t.geometry.hasAttribute("tangent")&&t.geometry.computeTangents(),ah("tangent","vec4")))(),Ol=El.xyz.toVar("tangentLocal"),Fl=Gh.mul(Sr(Ol,0)).xyz.toVarying("v_tangentView").normalize().toVar("tangentView"),Bl=Fl.transformDirection(_h).toVarying("v_tangentWorld").normalize().toVar("tangentWorld"),Ll=Fl.toVar("transformedTangentView"),Pl=Ll.transformDirection(_h).normalize().toVar("transformedTangentWorld"),Dl=t=>t.mul(El.w).xyz,kl=No(Dl(al.cross(El)),"v_bitangentGeometry").normalize().toVar("bitangentGeometry"),Ul=No(Dl(ol.cross(Ol)),"v_bitangentLocal").normalize().toVar("bitangentLocal"),Wl=No(Dl(ll.cross(Fl)),"v_bitangentView").normalize().toVar("bitangentView"),jl=No(Dl(ul.cross(Bl)),"v_bitangentWorld").normalize().toVar("bitangentWorld"),ql=Dl(cl.cross(Ll)).normalize().toVar("transformedBitangentView"),Hl=ql.transformDirection(_h).normalize().toVar("transformedBitangentWorld"),Gl=Ir(Fl,Wl,ll),Xl=sl.mul(Gl),Yl=(()=>{let t=ln.cross(sl);return t=t.cross(ln).normalize(),t=Ja(t,cl,on.mul(Zr.oneMinus()).oneMinus().pow2().pow2()).normalize(),t})(),$l=hr(t=>{const{eye_pos:e,surf_norm:s,mapN:i,uv:r}=t,n=e.dFdx(),a=e.dFdy(),o=r.dFdx(),h=r.dFdy(),l=s,u=a.cross(l),c=l.cross(n),d=u.mul(o.x).add(c.mul(h.x)),p=u.mul(o.y).add(c.mul(h.y)),m=d.dot(d).max(p.dot(p)),g=nl.mul(m.inverseSqrt());return zn(d.mul(i.x,g),p.mul(i.y,g),l.mul(i.z)).normalize()});class Zl extends xi{static get type(){return"NormalMapNode"}constructor(t,e=null){super("vec3"),this.node=t,this.scaleNode=e,this.normalMapType=0}setup(t){const{normalMapType:e,scaleNode:s}=this;let i=this.node.mul(2).sub(1);null!==s&&(i=Nr(i.xy.mul(s),i.z));let r=null;if(1===e)r=gl(i);else if(0===e){r=!0===t.hasGeometryAttribute("tangent")?Gl.mul(i).normalize():$l({eye_pos:el,surf_norm:ll,mapN:i,uv:oh()})}return r}}const Jl=ar(Zl),Kl=hr(({textureNode:t,bumpScale:e})=>{const s=e=>t.cache().context({getUV:t=>e(t.uvNode||oh()),forceUVContext:!0}),i=mr(s(t=>t));return xr(mr(s(t=>t.add(t.dFdx()))).sub(i),mr(s(t=>t.add(t.dFdy()))).sub(i)).mul(e)}),Ql=hr(t=>{const{surf_pos:e,surf_norm:s,dHdxy:i}=t,r=e.dFdx().normalize(),n=s,a=e.dFdy().normalize().cross(n),o=n.cross(r),h=r.dot(a).mul(nl),l=h.sign().mul(i.x.mul(a).add(i.y.mul(o)));return h.abs().mul(s).sub(l).normalize()});class tu extends xi{static get type(){return"BumpMapNode"}constructor(t,e=null){super("vec3"),this.textureNode=t,this.scaleNode=e}setup(){const t=null!==this.scaleNode?this.scaleNode:1,e=Kl({textureNode:this.textureNode,bumpScale:t});return Ql({surf_pos:el,surf_norm:ll,dHdxy:e})}}const eu=ar(tu),su=new Map;class iu extends gi{static get type(){return"MaterialNode"}constructor(t){super(),this.scope=t}getCache(t,e){let s=su.get(t);return void 0===s&&(s=Rl(t,e),su.set(t,s)),s}getFloat(t){return this.getCache(t,"float")}getColor(t){return this.getCache(t,"color")}getTexture(t){return this.getCache("map"===t?"map":t+"Map","texture")}setup(t){const e=t.context.material,s=this.scope;let i=null;if(s===iu.COLOR){const t=void 0!==e.color?this.getColor(s):Nr();i=e.map&&!0===e.map.isTexture?t.mul(this.getTexture("map")):t}else if(s===iu.OPACITY){const t=this.getFloat(s);i=e.alphaMap&&!0===e.alphaMap.isTexture?t.mul(this.getTexture("alpha")):t}else if(s===iu.SPECULAR_STRENGTH)i=e.specularMap&&!0===e.specularMap.isTexture?this.getTexture("specular").r:mr(1);else if(s===iu.SPECULAR_INTENSITY){const t=this.getFloat(s);i=e.specularIntensityMap&&!0===e.specularIntensityMap.isTexture?t.mul(this.getTexture(s).a):t}else if(s===iu.SPECULAR_COLOR){const t=this.getColor(s);i=e.specularColorMap&&!0===e.specularColorMap.isTexture?t.mul(this.getTexture(s).rgb):t}else if(s===iu.ROUGHNESS){const t=this.getFloat(s);i=e.roughnessMap&&!0===e.roughnessMap.isTexture?t.mul(this.getTexture(s).g):t}else if(s===iu.METALNESS){const t=this.getFloat(s);i=e.metalnessMap&&!0===e.metalnessMap.isTexture?t.mul(this.getTexture(s).b):t}else if(s===iu.EMISSIVE){const t=this.getFloat("emissiveIntensity"),r=this.getColor(s).mul(t);i=e.emissiveMap&&!0===e.emissiveMap.isTexture?r.mul(this.getTexture(s)):r}else if(s===iu.NORMAL)e.normalMap?(i=Jl(this.getTexture("normal"),this.getCache("normalScale","vec2")),i.normalMapType=e.normalMapType):i=e.bumpMap?eu(this.getTexture("bump").r,this.getFloat("bumpScale")):ll;else if(s===iu.CLEARCOAT){const t=this.getFloat(s);i=e.clearcoatMap&&!0===e.clearcoatMap.isTexture?t.mul(this.getTexture(s).r):t}else if(s===iu.CLEARCOAT_ROUGHNESS){const t=this.getFloat(s);i=e.clearcoatRoughnessMap&&!0===e.clearcoatRoughnessMap.isTexture?t.mul(this.getTexture(s).r):t}else if(s===iu.CLEARCOAT_NORMAL)i=e.clearcoatNormalMap?Jl(this.getTexture(s),this.getCache(s+"Scale","vec2")):ll;else if(s===iu.SHEEN){const t=this.getColor("sheenColor").mul(this.getFloat("sheen"));i=e.sheenColorMap&&!0===e.sheenColorMap.isTexture?t.mul(this.getTexture("sheenColor").rgb):t}else if(s===iu.SHEEN_ROUGHNESS){const t=this.getFloat(s);i=e.sheenRoughnessMap&&!0===e.sheenRoughnessMap.isTexture?t.mul(this.getTexture(s).a):t,i=i.clamp(.07,1)}else if(s===iu.ANISOTROPY)if(e.anisotropyMap&&!0===e.anisotropyMap.isTexture){const t=this.getTexture(s);i=Cr(Uu.x,Uu.y,Uu.y.negate(),Uu.x).mul(t.rg.mul(2).sub(xr(1)).normalize().mul(t.b))}else i=Uu;else if(s===iu.IRIDESCENCE_THICKNESS){const t=Vl("1","float",e.iridescenceThicknessRange);if(e.iridescenceThicknessMap){const r=Vl("0","float",e.iridescenceThicknessRange);i=t.sub(r).mul(this.getTexture(s).g).add(r)}else i=t}else if(s===iu.TRANSMISSION){const t=this.getFloat(s);i=e.transmissionMap?t.mul(this.getTexture(s).r):t}else if(s===iu.THICKNESS){const t=this.getFloat(s);i=e.thicknessMap?t.mul(this.getTexture(s).g):t}else if(s===iu.IOR)i=this.getFloat(s);else if(s===iu.LIGHT_MAP)i=this.getTexture(s).rgb.mul(this.getFloat("lightMapIntensity"));else if(s===iu.AO)i=this.getTexture(s).r.sub(1).mul(this.getFloat("aoMapIntensity")).add(1);else{const e=this.getNodeType(t);i=this.getCache(s,e)}return i}}iu.ALPHA_TEST="alphaTest",iu.COLOR="color",iu.OPACITY="opacity",iu.SHININESS="shininess",iu.SPECULAR="specular",iu.SPECULAR_STRENGTH="specularStrength",iu.SPECULAR_INTENSITY="specularIntensity",iu.SPECULAR_COLOR="specularColor",iu.REFLECTIVITY="reflectivity",iu.ROUGHNESS="roughness",iu.METALNESS="metalness",iu.NORMAL="normal",iu.CLEARCOAT="clearcoat",iu.CLEARCOAT_ROUGHNESS="clearcoatRoughness",iu.CLEARCOAT_NORMAL="clearcoatNormal",iu.EMISSIVE="emissive",iu.ROTATION="rotation",iu.SHEEN="sheen",iu.SHEEN_ROUGHNESS="sheenRoughness",iu.ANISOTROPY="anisotropy",iu.IRIDESCENCE="iridescence",iu.IRIDESCENCE_IOR="iridescenceIOR",iu.IRIDESCENCE_THICKNESS="iridescenceThickness",iu.IOR="ior",iu.TRANSMISSION="transmission",iu.THICKNESS="thickness",iu.ATTENUATION_DISTANCE="attenuationDistance",iu.ATTENUATION_COLOR="attenuationColor",iu.LINE_SCALE="scale",iu.LINE_DASH_SIZE="dashSize",iu.LINE_GAP_SIZE="gapSize",iu.LINE_WIDTH="linewidth",iu.LINE_DASH_OFFSET="dashOffset",iu.POINT_SIZE="size",iu.DISPERSION="dispersion",iu.LIGHT_MAP="light",iu.AO="ao";const ru=or(iu,iu.ALPHA_TEST),nu=or(iu,iu.COLOR),au=or(iu,iu.SHININESS),ou=or(iu,iu.EMISSIVE),hu=or(iu,iu.OPACITY),lu=or(iu,iu.SPECULAR),uu=or(iu,iu.SPECULAR_INTENSITY),cu=or(iu,iu.SPECULAR_COLOR),du=or(iu,iu.SPECULAR_STRENGTH),pu=or(iu,iu.REFLECTIVITY),mu=or(iu,iu.ROUGHNESS),gu=or(iu,iu.METALNESS),yu=or(iu,iu.NORMAL),fu=or(iu,iu.CLEARCOAT),xu=or(iu,iu.CLEARCOAT_ROUGHNESS),bu=or(iu,iu.CLEARCOAT_NORMAL),vu=or(iu,iu.ROTATION),wu=or(iu,iu.SHEEN),Nu=or(iu,iu.SHEEN_ROUGHNESS),Tu=or(iu,iu.ANISOTROPY),Mu=or(iu,iu.IRIDESCENCE),_u=or(iu,iu.IRIDESCENCE_IOR),Su=or(iu,iu.IRIDESCENCE_THICKNESS),Au=or(iu,iu.TRANSMISSION),zu=or(iu,iu.THICKNESS),Vu=or(iu,iu.IOR),Cu=or(iu,iu.ATTENUATION_DISTANCE),Iu=or(iu,iu.ATTENUATION_COLOR),Ru=or(iu,iu.LINE_SCALE),Eu=or(iu,iu.LINE_DASH_SIZE),Ou=or(iu,iu.LINE_GAP_SIZE),Fu=or(iu,iu.LINE_WIDTH),Bu=or(iu,iu.LINE_DASH_OFFSET),Lu=or(iu,iu.POINT_SIZE),Pu=or(iu,iu.DISPERSION),Du=or(iu,iu.LIGHT_MAP),ku=or(iu,iu.AO),Uu=qr(new D).onReference(function(t){return t.material}).onRenderUpdate(function({material:t}){this.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation))}),Wu=hr(t=>t.context.setupModelViewProjection(),"vec4").once()().toVarying("v_modelViewProjection");class ju extends gi{static get type(){return"IndexNode"}constructor(t){super("uint"),this.scope=t,this.isIndexNode=!0}generate(t){const e=this.getNodeType(t),s=this.scope;let i,r;if(s===ju.VERTEX)i=t.getVertexIndex();else if(s===ju.INSTANCE)i=t.getInstanceIndex();else if(s===ju.DRAW)i=t.getDrawIndex();else if(s===ju.INVOCATION_LOCAL)i=t.getInvocationLocalIndex();else if(s===ju.INVOCATION_SUBGROUP)i=t.getInvocationSubgroupIndex();else{if(s!==ju.SUBGROUP)throw new Error("THREE.IndexNode: Unknown scope: "+s);i=t.getSubgroupIndex()}if("vertex"===t.shaderStage||"compute"===t.shaderStage)r=i;else{r=No(this).build(t,e)}return r}}ju.VERTEX="vertex",ju.INSTANCE="instance",ju.SUBGROUP="subgroup",ju.INVOCATION_LOCAL="invocationLocal",ju.INVOCATION_SUBGROUP="invocationSubgroup",ju.DRAW="draw";const qu=or(ju,ju.VERTEX),Hu=or(ju,ju.INSTANCE),Gu=or(ju,ju.SUBGROUP),Xu=or(ju,ju.INVOCATION_SUBGROUP),Yu=or(ju,ju.INVOCATION_LOCAL),$u=or(ju,ju.DRAW);class Zu extends gi{static get type(){return"InstanceNode"}constructor(t,e,s){super("void"),this.count=t,this.instanceMatrix=e,this.instanceColor=s,this.instanceMatrixNode=null,this.instanceColorNode=null,this.updateType=li.FRAME,this.buffer=null,this.bufferColor=null}setup(t){const{count:e,instanceMatrix:s,instanceColor:i}=this;let{instanceMatrixNode:r,instanceColorNode:n}=this;if(null===r){if(e<=1e3)r=yh(s.array,"mat4",Math.max(e,1)).element(Hu);else{const t=new qs(s.array,16,1);this.buffer=t;const e=s.usage===M?qo:jo,i=[e(t,"vec4",16,0),e(t,"vec4",16,4),e(t,"vec4",16,8),e(t,"vec4",16,12)];r=Rr(...i)}this.instanceMatrixNode=r}if(i&&null===n){const t=new vs(i.array,3),e=i.usage===M?qo:jo;this.bufferColor=t,n=Nr(e(t,"vec3",3,0)),this.instanceColorNode=n}const a=r.mul(Jh).xyz;if(Jh.assign(a),t.hasGeometryAttribute("normal")){const t=ml(ol,r);ol.assign(t)}null!==this.instanceColorNode&&Xr("vec3","vInstanceColor").assign(this.instanceColorNode)}update(){this.instanceMatrix.usage!==M&&null!==this.buffer&&this.instanceMatrix.version!==this.buffer.version&&(this.buffer.version=this.instanceMatrix.version),this.instanceColor&&this.instanceColor.usage!==M&&null!==this.bufferColor&&this.instanceColor.version!==this.bufferColor.version&&(this.bufferColor.version=this.instanceColor.version)}}const Ju=ar(Zu);class Ku extends Zu{static get type(){return"InstancedMeshNode"}constructor(t){const{count:e,instanceMatrix:s,instanceColor:i}=t;super(e,s,i),this.instancedMesh=t}}const Qu=ar(Ku);class tc extends gi{static get type(){return"BatchNode"}constructor(t){super("void"),this.batchMesh=t,this.batchingIdNode=null}setup(t){null===this.batchingIdNode&&(null===t.getDrawIndex()?this.batchingIdNode=Hu:this.batchingIdNode=$u);const e=hr(([t])=>{const e=gr(lh(mh(this.batchMesh._indirectTexture),0)),s=gr(t).modInt(e),i=gr(t).div(e);return mh(this.batchMesh._indirectTexture,br(s,i)).x}).setLayout({name:"getIndirectIndex",type:"uint",inputs:[{name:"id",type:"int"}]}),s=e(gr(this.batchingIdNode)),i=this.batchMesh._matricesTexture,r=lh(mh(i),0),n=mr(s).mul(4).toInt().toVar(),a=n.modInt(r),o=n.div(gr(r)),h=Rr(mh(i,br(a,o)),mh(i,br(a.add(1),o)),mh(i,br(a.add(2),o)),mh(i,br(a.add(3),o))),l=this.batchMesh._colorsTexture;if(null!==l){const t=hr(([t])=>{const e=lh(mh(l),0).x,s=t,i=s.modInt(e),r=s.div(e);return mh(l,br(i,r)).rgb}).setLayout({name:"getBatchingColor",type:"vec3",inputs:[{name:"id",type:"int"}]}),e=t(s);Xr("vec3","vBatchColor").assign(e)}const u=Ir(h);Jh.assign(h.mul(Jh));const c=ol.div(Nr(u[0].dot(u[0]),u[1].dot(u[1]),u[2].dot(u[2]))),d=u.mul(c).xyz;ol.assign(d),t.hasGeometryAttribute("tangent")&&Ol.mulAssign(u)}}const ec=ar(tc),sc=new WeakMap;class ic extends gi{static get type(){return"SkinningNode"}constructor(t,e=!1){let s,i,r;super("void"),this.skinnedMesh=t,this.useReference=e,this.updateType=li.OBJECT,this.skinIndexNode=ah("skinIndex","uvec4"),this.skinWeightNode=ah("skinWeight","vec4"),e?(s=Vl("bindMatrix","mat4"),i=Vl("bindMatrixInverse","mat4"),r=Cl("skeleton.boneMatrices","mat4",t.skeleton.bones.length)):(s=qr(t.bindMatrix,"mat4"),i=qr(t.bindMatrixInverse,"mat4"),r=yh(t.skeleton.boneMatrices,"mat4",t.skeleton.bones.length)),this.bindMatrixNode=s,this.bindMatrixInverseNode=i,this.boneMatricesNode=r,this.previousBoneMatricesNode=null}getSkinnedPosition(t=this.boneMatricesNode,e=Jh){const{skinIndexNode:s,skinWeightNode:i,bindMatrixNode:r,bindMatrixInverseNode:n}=this,a=t.element(s.x),o=t.element(s.y),h=t.element(s.z),l=t.element(s.w),u=r.mul(e),c=zn(a.mul(i.x).mul(u),o.mul(i.y).mul(u),h.mul(i.z).mul(u),l.mul(i.w).mul(u));return n.mul(c).xyz}getSkinnedNormal(t=this.boneMatricesNode,e=ol){const{skinIndexNode:s,skinWeightNode:i,bindMatrixNode:r,bindMatrixInverseNode:n}=this,a=t.element(s.x),o=t.element(s.y),h=t.element(s.z),l=t.element(s.w);let u=zn(i.x.mul(a),i.y.mul(o),i.z.mul(h),i.w.mul(l));return u=n.mul(u).mul(r),u.transformDirection(e).xyz}getPreviousSkinnedPosition(t){const e=t.object;return null===this.previousBoneMatricesNode&&(e.skeleton.previousBoneMatrices=new Float32Array(e.skeleton.boneMatrices),this.previousBoneMatricesNode=Cl("skeleton.previousBoneMatrices","mat4",e.skeleton.bones.length)),this.getSkinnedPosition(this.previousBoneMatricesNode,Kh)}needsPreviousBoneMatrices(t){const e=t.renderer.getMRT();return e&&e.has("velocity")||!0===ni(t.object).useVelocity}setup(t){this.needsPreviousBoneMatrices(t)&&Kh.assign(this.getPreviousSkinnedPosition(t));const e=this.getSkinnedPosition();if(Jh.assign(e),t.hasGeometryAttribute("normal")){const e=this.getSkinnedNormal();ol.assign(e),t.hasGeometryAttribute("tangent")&&Ol.assign(e)}}generate(t,e){if("void"!==e)return Jh.build(t,e)}update(t){const e=(this.useReference?t.object:this.skinnedMesh).skeleton;sc.get(e)!==t.frameId&&(sc.set(e,t.frameId),null!==this.previousBoneMatricesNode&&e.previousBoneMatrices.set(e.boneMatrices),e.update())}}const rc=t=>ir(new ic(t,!0));class nc extends gi{static get type(){return"LoopNode"}constructor(t=[]){super(),this.params=t}getVarName(t){return String.fromCharCode("i".charCodeAt(0)+t)}getProperties(t){const e=t.getNodeProperties(this);if(void 0!==e.stackNode)return e;const s={};for(let t=0,e=this.params.length-1;t<e;t++){const e=this.params[t],i=!0!==e.isNode&&e.name||this.getVarName(t),r=!0!==e.isNode&&e.type||"int";s[i]=eh(i,r)}const i=t.addStack();return e.returnsNode=this.params[this.params.length-1](s,i,t),e.stackNode=i,t.removeStack(),e}getNodeType(t){const{returnsNode:e}=this.getProperties(t);return e?e.getNodeType(t):"void"}setup(t){this.getProperties(t)}generate(t){const e=this.getProperties(t),s=this.params,i=e.stackNode;for(let e=0,i=s.length-1;e<i;e++){const i=s[e];let r=null,n=null,a=null,o=null,h=null,l=null;i.isNode?(o="int",a=this.getVarName(e),r="0",n=i.build(t,o),h="<"):(o=i.type||"int",a=i.name||this.getVarName(e),r=i.start,n=i.end,h=i.condition,l=i.update,"number"==typeof r?r=t.generateConst(o,r):r&&r.isNode&&(r=r.build(t,o)),"number"==typeof n?n=t.generateConst(o,n):n&&n.isNode&&(n=n.build(t,o)),void 0!==r&&void 0===n?(r+=" - 1",n="0",h=">="):void 0!==n&&void 0===r&&(r="0",h="<"),void 0===h&&(h=Number(r)>Number(n)?">=":"<"));const u={start:r,end:n,condition:h},c=u.start,d=u.end;let p="",m="",g="";l||(l="int"===o||"uint"===o?h.includes("<")?"++":"--":h.includes("<")?"+= 1.":"-= 1."),p+=t.getVar(o,a)+" = "+c,m+=a+" "+h+" "+d,g+=a+" "+l;const y=`for ( ${p}; ${m}; ${g} )`;t.addFlowCode((0===e?"\n":"")+t.tab+y+" {\n\n").addFlowTab()}const r=i.build(t,"void"),n=e.returnsNode?e.returnsNode.build(t):"";t.removeFlowTab().addFlowCode("\n"+t.tab+r);for(let e=0,s=this.params.length-1;e<s;e++)t.addFlowCode((0===e?"":t.tab)+"}\n\n").removeFlowTab();return t.addFlowTab(),n}}const ac=(...t)=>ir(new nc(nr(t,"int"))).append(),oc=()=>eh("break").append(),hc=new WeakMap,lc=new st,uc=hr(({bufferMap:t,influence:e,stride:s,width:i,depth:r,offset:n})=>{const a=gr(qu).mul(s).add(n),o=a.div(i),h=a.sub(o.mul(i));return mh(t,br(h,o)).depth(r).mul(e)});class cc extends gi{static get type(){return"MorphNode"}constructor(t){super("void"),this.mesh=t,this.morphBaseInfluence=qr(1),this.updateType=li.OBJECT}setup(t){const{geometry:e}=t,s=void 0!==e.morphAttributes.position,i=e.hasAttribute("normal")&&void 0!==e.morphAttributes.normal,r=e.morphAttributes.position||e.morphAttributes.normal||e.morphAttributes.color,n=void 0!==r?r.length:0,{texture:a,stride:o,size:h}=function(t){const e=void 0!==t.morphAttributes.position,s=void 0!==t.morphAttributes.normal,i=void 0!==t.morphAttributes.color,r=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,n=void 0!==r?r.length:0;let a=hc.get(t);if(void 0===a||a.count!==n){void 0!==a&&a.texture.dispose();const o=t.morphAttributes.position||[],h=t.morphAttributes.normal||[],l=t.morphAttributes.color||[];let c=0;!0===e&&(c=1),!0===s&&(c=2),!0===i&&(c=3);let d=t.attributes.position.count*c,p=1;const m=4096;d>m&&(p=Math.ceil(d/m),d=m);const g=new Float32Array(d*p*4*n),y=new rt(g,d,p,n);y.type=u,y.needsUpdate=!0;const f=4*c;for(let b=0;b<n;b++){const v=o[b],w=h[b],N=l[b],T=d*p*4*b;for(let M=0;M<v.count;M++){const _=M*f;!0===e&&(lc.fromBufferAttribute(v,M),g[T+_+0]=lc.x,g[T+_+1]=lc.y,g[T+_+2]=lc.z,g[T+_+3]=0),!0===s&&(lc.fromBufferAttribute(w,M),g[T+_+4]=lc.x,g[T+_+5]=lc.y,g[T+_+6]=lc.z,g[T+_+7]=0),!0===i&&(lc.fromBufferAttribute(N,M),g[T+_+8]=lc.x,g[T+_+9]=lc.y,g[T+_+10]=lc.z,g[T+_+11]=4===N.itemSize?lc.w:1)}}function x(){y.dispose(),hc.delete(t),t.removeEventListener("dispose",x)}a={count:n,texture:y,stride:c,size:new D(d,p)},hc.set(t,a),t.addEventListener("dispose",x)}return a}(e);!0===s&&Jh.mulAssign(this.morphBaseInfluence),!0===i&&ol.mulAssign(this.morphBaseInfluence);const l=gr(h.width);ac(n,({i:t})=>{const e=mr(0).toVar();this.mesh.count>1&&null!==this.mesh.morphTexture&&void 0!==this.mesh.morphTexture?e.assign(mh(this.mesh.morphTexture,br(gr(t).add(1),gr(Hu))).r):e.assign(Vl("morphTargetInfluences","float").element(t).toVar()),!0===s&&Jh.addAssign(uc({bufferMap:a,influence:e,stride:o,width:l,depth:t,offset:gr(0)})),!0===i&&ol.addAssign(uc({bufferMap:a,influence:e,stride:o,width:l,depth:t,offset:gr(1)}))})}update(){const t=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?t.value=1:t.value=1-this.mesh.morphTargetInfluences.reduce((t,e)=>t+e,0)}}const dc=ar(cc);class pc extends gi{static get type(){return"LightingNode"}constructor(){super("vec3"),this.isLightingNode=!0}}class mc extends pc{static get type(){return"AONode"}constructor(t=null){super(),this.aoNode=t}setup(t){t.context.ambientOcclusion.mulAssign(this.aoNode)}}class gc extends po{static get type(){return"LightingContextNode"}constructor(t,e=null,s=null,i=null){super(t),this.lightingModel=e,this.backdropNode=s,this.backdropAlphaNode=i,this._value=null}getContext(){const{backdropNode:t,backdropAlphaNode:e}=this,s={directDiffuse:Nr().toVar("directDiffuse"),directSpecular:Nr().toVar("directSpecular"),indirectDiffuse:Nr().toVar("indirectDiffuse"),indirectSpecular:Nr().toVar("indirectSpecular")};return{radiance:Nr().toVar("radiance"),irradiance:Nr().toVar("irradiance"),iblIrradiance:Nr().toVar("iblIrradiance"),ambientOcclusion:mr(1).toVar("ambientOcclusion"),reflectedLight:s,backdrop:t,backdropAlpha:e}}setup(t){return this.value=this._value||(this._value=this.getContext()),this.value.lightingModel=this.lightingModel||t.context.lightingModel,super.setup(t)}}const yc=ar(gc);class fc extends pc{static get type(){return"IrradianceNode"}constructor(t){super(),this.node=t}setup(t){t.context.irradiance.addAssign(this.node)}}let xc,bc;class vc extends gi{static get type(){return"ScreenNode"}constructor(t){super(),this.scope=t,this.isViewportNode=!0}getNodeType(){return this.scope===vc.VIEWPORT?"vec4":"vec2"}getUpdateType(){let t=li.NONE;return this.scope!==vc.SIZE&&this.scope!==vc.VIEWPORT||(t=li.RENDER),this.updateType=t,t}update({renderer:t}){const e=t.getRenderTarget();this.scope===vc.VIEWPORT?null!==e?bc.copy(e.viewport):(t.getViewport(bc),bc.multiplyScalar(t.getPixelRatio())):null!==e?(xc.width=e.width,xc.height=e.height):t.getDrawingBufferSize(xc)}setup(){const t=this.scope;let e=null;return e=t===vc.SIZE?qr(xc||(xc=new D)):t===vc.VIEWPORT?qr(bc||(bc=new st)):xr(Tc.div(Nc)),e}generate(t){if(this.scope===vc.COORDINATE){let e=t.getFragCoord();if(t.isFlipY()){const s=t.getNodeProperties(Nc).outputNode.build(t);e=`${t.getType("vec2")}( ${e}.x, ${s}.y - ${e}.y )`}return e}return super.generate(t)}}vc.COORDINATE="coordinate",vc.VIEWPORT="viewport",vc.SIZE="size",vc.UV="uv";const wc=or(vc,vc.UV),Nc=or(vc,vc.SIZE),Tc=or(vc,vc.COORDINATE),Mc=or(vc,vc.VIEWPORT),_c=Mc.zw,Sc=Tc.sub(Mc.xy),Ac=Sc.div(_c),zc=hr(()=>Nc,"vec2").once()(),Vc=hr(()=>wc,"vec2").once()(),Cc=hr(()=>wc.flipY(),"vec2").once()(),Ic=new D;class Rc extends dh{static get type(){return"ViewportTextureNode"}constructor(t=wc,e=null,s=null){null===s&&((s=new _s).minFilter=h),super(s,t,e),this.generateMipmaps=!1,this.isOutputTextureNode=!0,this.updateBeforeType=li.FRAME}updateBefore(t){const e=t.renderer;e.getDrawingBufferSize(Ic);const s=this.value;s.image.width===Ic.width&&s.image.height===Ic.height||(s.image.width=Ic.width,s.image.height=Ic.height,s.needsUpdate=!0);const i=s.generateMipmaps;s.generateMipmaps=this.generateMipmaps,e.copyFramebufferToTexture(s),s.generateMipmaps=i}clone(){const t=new this.constructor(this.uvNode,this.levelNode,this.value);return t.generateMipmaps=this.generateMipmaps,t}}const Ec=ar(Rc),Oc=ar(Rc,null,null,{generateMipmaps:!0});let Fc=null;class Bc extends Rc{static get type(){return"ViewportDepthTextureNode"}constructor(t=wc,e=null){null===Fc&&(Fc=new Ss),super(t,e,Fc)}}const Lc=ar(Bc);class Pc extends gi{static get type(){return"ViewportDepthNode"}constructor(t,e=null){super("float"),this.scope=t,this.valueNode=e,this.isViewportDepthNode=!0}generate(t){const{scope:e}=this;return e===Pc.DEPTH_BASE?t.getFragDepth():super.generate(t)}setup({camera:t}){const{scope:e}=this,s=this.valueNode;let i=null;if(e===Pc.DEPTH_BASE)null!==s&&(i=jc().assign(s));else if(e===Pc.DEPTH)i=t.isPerspectiveCamera?kc(el.z,wh,Nh):Dc(el.z,wh,Nh);else if(e===Pc.LINEAR_DEPTH)if(null!==s)if(t.isPerspectiveCamera){const t=Uc(s,wh,Nh);i=Dc(t,wh,Nh)}else i=s;else i=Dc(el.z,wh,Nh);return i}}Pc.DEPTH_BASE="depthBase",Pc.DEPTH="depth",Pc.LINEAR_DEPTH="linearDepth";const Dc=(t,e,s)=>t.add(e).div(e.sub(s)),kc=(t,e,s)=>e.add(t).mul(s).div(s.sub(e).mul(t)),Uc=(t,e,s)=>e.mul(s).div(s.sub(e).mul(t).sub(s)),Wc=(t,e,s)=>{e=e.max(1e-6).toVar();const i=ha(t.negate().div(e)),r=ha(s.div(e));return i.div(r)},jc=ar(Pc,Pc.DEPTH_BASE),qc=or(Pc,Pc.DEPTH),Hc=ar(Pc,Pc.LINEAR_DEPTH),Gc=Hc(Lc());qc.assign=t=>jc(t);const Xc=ar(class extends gi{constructor(t){super("float"),this.name=t,this.isBuiltinNode=!0}generate(){return this.name}});class Yc extends gi{static get type(){return"ClippingNode"}constructor(t=Yc.DEFAULT){super(),this.scope=t}setup(t){super.setup(t);const e=t.clippingContext,{intersectionPlanes:s,unionPlanes:i}=e;return this.hardwareClipping=t.material.hardwareClipping,this.scope===Yc.ALPHA_TO_COVERAGE?this.setupAlphaToCoverage(s,i):this.scope===Yc.HARDWARE?this.setupHardwareClipping(i,t):this.setupDefault(s,i)}setupAlphaToCoverage(t,e){return hr(()=>{const s=mr().toVar("distanceToPlane"),i=mr().toVar("distanceToGradient"),r=mr(1).toVar("clipOpacity"),n=e.length;if(!1===this.hardwareClipping&&n>0){const t=bh(e);ac(n,({i:e})=>{const n=t.element(e);s.assign(el.dot(n.xyz).negate().add(n.w)),i.assign(s.fwidth().div(2)),r.mulAssign(eo(i.negate(),i,s))})}const a=t.length;if(a>0){const e=bh(t),n=mr(1).toVar("intersectionClipOpacity");ac(a,({i:t})=>{const r=e.element(t);s.assign(el.dot(r.xyz).negate().add(r.w)),i.assign(s.fwidth().div(2)),n.mulAssign(eo(i.negate(),i,s).oneMinus())}),r.mulAssign(n.oneMinus())}Yr.a.mulAssign(r),Yr.a.equal(0).discard()})()}setupDefault(t,e){return hr(()=>{const s=e.length;if(!1===this.hardwareClipping&&s>0){const t=bh(e);ac(s,({i:e})=>{const s=t.element(e);el.dot(s.xyz).greaterThan(s.w).discard()})}const i=t.length;if(i>0){const e=bh(t),s=fr(!0).toVar("clipped");ac(i,({i:t})=>{const i=e.element(t);s.assign(el.dot(i.xyz).greaterThan(i.w).and(s))}),s.discard()}})()}setupHardwareClipping(t,e){const s=t.length;return e.enableHardwareClipping(s),hr(()=>{const i=bh(t),r=Xc(e.getClipDistance());ac(s,({i:t})=>{const e=i.element(t),s=el.dot(e.xyz).sub(e.w).negate();r.element(t).assign(s)})})()}}Yc.ALPHA_TO_COVERAGE="alphaToCoverage",Yc.DEFAULT="default",Yc.HARDWARE="hardware";const $c=hr(([t])=>ma(Cn(1e4,ga(Cn(17,t.x).add(Cn(.1,t.y)))).mul(zn(.1,wa(ga(Cn(13,t.y).add(t.x))))))),Zc=hr(([t])=>$c(xr($c(t.xy),t.z))),Jc=hr(([t])=>{const e=Ba(Ta(Sa(t.xyz)),Ta(Aa(t.xyz))),s=mr(1).div(mr(.05).mul(e)).toVar("pixScale"),i=xr(aa(ca(ha(s))),aa(da(ha(s)))),r=xr(Zc(ca(i.x.mul(t.xyz))),Zc(ca(i.y.mul(t.xyz)))),n=ma(ha(s)),a=zn(Cn(n.oneMinus(),r.x),Cn(n,r.y)),o=Fa(n,n.oneMinus()),h=Nr(a.mul(a).div(Cn(2,o).mul(Vn(1,o))),a.sub(Cn(.5,o)).div(Vn(1,o)),Vn(1,Vn(1,a).mul(Vn(1,a)).div(Cn(2,o).mul(Vn(1,o))))),l=a.lessThan(o.oneMinus()).select(a.lessThan(o).select(h.x,h.y),h.z);return Ka(l,1e-6,1)}).setLayout({name:"getAlphaHashThreshold",type:"float",inputs:[{name:"position",type:"vec3"}]});class Kc extends Ie{static get type(){return"NodeMaterial"}get type(){return this.constructor.type}set type(t){}constructor(){super(),this.isNodeMaterial=!0,this.fog=!0,this.lights=!1,this.hardwareClipping=!1,this.lightsNode=null,this.envNode=null,this.aoNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.positionNode=null,this.geometryNode=null,this.depthNode=null,this.shadowPositionNode=null,this.receivedShadowNode=null,this.castShadowNode=null,this.outputNode=null,this.mrtNode=null,this.fragmentNode=null,this.vertexNode=null}customProgramCacheKey(){return this.type+Js(this)}build(t){this.setup(t)}setupObserver(t){return new Xs(t)}setup(t){t.context.setupNormal=()=>this.setupNormal(t),t.context.setupPositionView=()=>this.setupPositionView(t),t.context.setupModelViewProjection=()=>this.setupModelViewProjection(t);const e=t.renderer,s=e.getRenderTarget();t.addStack();const i=this.vertexNode||this.setupVertex(t);let r;t.stack.outputNode=i,this.setupHardwareClipping(t),null!==this.geometryNode&&(t.stack.outputNode=t.stack.outputNode.bypass(this.geometryNode)),t.addFlow("vertex",t.removeStack()),t.addStack();const n=this.setupClipping(t);if(!0!==this.depthWrite&&!0!==this.depthTest||(null!==s?!0===s.depthBuffer&&this.setupDepth(t):!0===e.depth&&this.setupDepth(t)),null===this.fragmentNode){this.setupDiffuseColor(t),this.setupVariants(t);const i=this.setupLighting(t);null!==n&&t.stack.add(n);const a=Sr(i,Yr.a).max(0);if(r=this.setupOutput(t,a),pn.assign(r),null!==this.outputNode&&(r=this.outputNode),null!==s){const t=e.getMRT(),s=this.mrtNode;null!==t?(r=t,null!==s&&(r=t.merge(s))):null!==s&&(r=s)}}else{let e=this.fragmentNode;!0!==e.isOutputStructNode&&(e=Sr(e)),r=this.setupOutput(t,e)}t.stack.outputNode=r,t.addFlow("fragment",t.removeStack()),t.observer=this.setupObserver(t)}setupClipping(t){if(null===t.clippingContext)return null;const{unionPlanes:e,intersectionPlanes:s}=t.clippingContext;let i=null;if(e.length>0||s.length>0){const e=t.renderer.samples;this.alphaToCoverage&&e>1?i=ir(new Yc(Yc.ALPHA_TO_COVERAGE)):t.stack.add(ir(new Yc))}return i}setupHardwareClipping(t){if(this.hardwareClipping=!1,null===t.clippingContext)return;const e=t.clippingContext.unionPlanes.length;e>0&&e<=8&&t.isAvailable("clipDistance")&&(t.stack.add(ir(new Yc(Yc.HARDWARE))),this.hardwareClipping=!0)}setupDepth(t){const{renderer:e,camera:s}=t;let i=this.depthNode;if(null===i){const t=e.getMRT();t&&t.has("depth")?i=t.get("depth"):!0===e.logarithmicDepthBuffer&&(i=s.isPerspectiveCamera?Wc(el.z,wh,Nh):Dc(el.z,wh,Nh))}null!==i&&qc.assign(i).append()}setupPositionView(){return Gh.mul(Jh).xyz}setupModelViewProjection(){return Th.mul(el)}setupVertex(t){return t.addStack(),this.setupPosition(t),t.context.vertex=t.removeStack(),Wu}setupPosition(t){const{object:e,geometry:s}=t;if((s.morphAttributes.position||s.morphAttributes.normal||s.morphAttributes.color)&&dc(e).append(),!0===e.isSkinnedMesh&&rc(e).append(),this.displacementMap){const t=Rl("displacementMap","texture"),e=Rl("displacementScale","float"),s=Rl("displacementBias","float");Jh.addAssign(ol.normalize().mul(t.x.mul(e).add(s)))}return e.isBatchedMesh&&ec(e).append(),e.isInstancedMesh&&e.instanceMatrix&&!0===e.instanceMatrix.isInstancedBufferAttribute&&Qu(e).append(),null!==this.positionNode&&Jh.assign(this.positionNode.context({isPositionNodeInput:!0})),Jh}setupDiffuseColor({object:t,geometry:e}){let s=this.colorNode?Sr(this.colorNode):nu;if(!0===this.vertexColors&&e.hasAttribute("color")&&(s=Sr(s.xyz.mul(ah("color","vec3")),s.a)),t.instanceColor){s=Xr("vec3","vInstanceColor").mul(s)}if(t.isBatchedMesh&&t._colorsTexture){s=Xr("vec3","vBatchColor").mul(s)}Yr.assign(s);const i=this.opacityNode?mr(this.opacityNode):hu;if(Yr.a.assign(Yr.a.mul(i)),null!==this.alphaTestNode||this.alphaTest>0){const t=null!==this.alphaTestNode?mr(this.alphaTestNode):ru;Yr.a.lessThanEqual(t).discard()}!0===this.alphaHash&&Yr.a.lessThan(Jc(Jh)).discard(),!1===this.transparent&&1===this.blending&&!1===this.alphaToCoverage&&Yr.a.assign(1)}setupVariants(){}setupOutgoingLight(){return!0===this.lights?Nr(0):Yr.rgb}setupNormal(){return this.normalNode?Nr(this.normalNode):yu}setupEnvironment(){let t=null;return this.envNode?t=this.envNode:this.envMap&&(t=this.envMap.isCubeTexture?Rl("envMap","cubeTexture"):Rl("envMap","texture")),t}setupLightMap(t){let e=null;return t.material.lightMap&&(e=new fc(Du)),e}setupLights(t){const e=[],s=this.setupEnvironment(t);s&&s.isLightingNode&&e.push(s);const i=this.setupLightMap(t);if(i&&i.isLightingNode&&e.push(i),null!==this.aoNode||t.material.aoMap){const t=null!==this.aoNode?this.aoNode:ku;e.push(new mc(t))}let r=this.lightsNode||t.lightsNode;return e.length>0&&(r=t.renderer.lighting.createNode([...r.getLights(),...e])),r}setupLightingModel(){}setupLighting(t){const{material:e}=t,{backdropNode:s,backdropAlphaNode:i,emissiveNode:r}=this,n=!0===this.lights||null!==this.lightsNode?this.setupLights(t):null;let a=this.setupOutgoingLight(t);if(n&&n.getScope().hasLights){const e=this.setupLightingModel(t)||null;a=yc(n,e,s,i)}else null!==s&&(a=Nr(null!==i?Ja(a,s,i):s));return(r&&!0===r.isNode||e.emissive&&!0===e.emissive.isColor)&&($r.assign(Nr(r||ou)),a=a.add($r)),a}setupFog(t,e){const s=t.fogNode;return s&&(pn.assign(e),e=Sr(s)),e}setupOutput(t,e){return!0===this.fog&&(e=this.setupFog(t,e)),e}setDefaultValues(t){for(const e in t){const s=t[e];void 0===this[e]&&(this[e]=s,s&&s.clone&&(this[e]=s.clone()))}const e=Object.getOwnPropertyDescriptors(t.constructor.prototype);for(const t in e)void 0===Object.getOwnPropertyDescriptor(this.constructor.prototype,t)&&void 0!==e[t].get&&Object.defineProperty(this.constructor.prototype,t,e[t])}toJSON(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{},nodes:{}});const s=Ie.prototype.toJSON.call(this,t),i=Ks(this);s.inputNodes={};for(const{property:e,childNode:r}of i)s.inputNodes[e]=r.toJSON(t).uuid;function r(t){const e=[];for(const s in t){const i=t[s];delete i.metadata,e.push(i)}return e}if(e){const e=r(t.textures),i=r(t.images),n=r(t.nodes);e.length>0&&(s.textures=e),i.length>0&&(s.images=i),n.length>0&&(s.nodes=n)}return s}copy(t){return this.lightsNode=t.lightsNode,this.envNode=t.envNode,this.colorNode=t.colorNode,this.normalNode=t.normalNode,this.opacityNode=t.opacityNode,this.backdropNode=t.backdropNode,this.backdropAlphaNode=t.backdropAlphaNode,this.alphaTestNode=t.alphaTestNode,this.positionNode=t.positionNode,this.geometryNode=t.geometryNode,this.depthNode=t.depthNode,this.shadowPositionNode=t.shadowPositionNode,this.receivedShadowNode=t.receivedShadowNode,this.castShadowNode=t.castShadowNode,this.outputNode=t.outputNode,this.mrtNode=t.mrtNode,this.fragmentNode=t.fragmentNode,this.vertexNode=t.vertexNode,super.copy(t)}}let Qc=null;class td extends Rc{static get type(){return"ViewportSharedTextureNode"}constructor(t=wc,e=null){null===Qc&&(Qc=new _s),super(t,e,Qc)}updateReference(){return this}}const ed=ar(td);class sd extends xi{static get type(){return"EquirectUVNode"}constructor(t=tl){super("vec2"),this.dirNode=t}setup(){const t=this.dirNode,e=t.z.atan(t.x).mul(1/(2*Math.PI)).add(.5),s=t.y.clamp(-1,1).asin().mul(1/Math.PI).add(.5);return xr(e,s)}}const id=ar(sd);const rd=hr(({f0:t,f90:e,dotVH:s})=>{const i=s.mul(-5.55473).sub(6.98316).mul(s).exp2();return t.mul(i.oneMinus()).add(e.mul(i))}),nd=hr(t=>t.diffuseColor.mul(1/Math.PI)),ad=hr(t=>{if(!1===t.geometry.hasAttribute("normal"))return mr(0);const e=ll.dFdx().abs().max(ll.dFdy().abs());return e.x.max(e.y).max(e.z)}),od=hr(t=>{const{roughness:e}=t,s=ad();let i=e.max(.0525);return i=i.add(s),i=i.min(1),i}),hd=hr(({alpha:t,dotNL:e,dotNV:s})=>{const i=t.pow2(),r=e.mul(i.add(i.oneMinus().mul(s.pow2())).sqrt()),n=s.mul(i.add(i.oneMinus().mul(e.pow2())).sqrt());return In(.5,r.add(n).max(Jn))}).setLayout({name:"V_GGX_SmithCorrelated",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNL",type:"float"},{name:"dotNV",type:"float"}]}),ld=hr(({alphaT:t,alphaB:e,dotTV:s,dotBV:i,dotTL:r,dotBL:n,dotNV:a,dotNL:o})=>{const h=o.mul(Nr(t.mul(s),e.mul(i),a).length()),l=a.mul(Nr(t.mul(r),e.mul(n),o).length());return In(.5,h.add(l)).saturate()}).setLayout({name:"V_GGX_SmithCorrelated_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotTV",type:"float",qualifier:"in"},{name:"dotBV",type:"float",qualifier:"in"},{name:"dotTL",type:"float",qualifier:"in"},{name:"dotBL",type:"float",qualifier:"in"},{name:"dotNV",type:"float",qualifier:"in"},{name:"dotNL",type:"float",qualifier:"in"}]}),ud=hr(({alpha:t,dotNH:e})=>{const s=t.pow2(),i=e.pow2().mul(s.oneMinus()).oneMinus();return s.div(i.pow2()).mul(1/Math.PI)}).setLayout({name:"D_GGX",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNH",type:"float"}]}),cd=mr(1/Math.PI),dd=hr(({alphaT:t,alphaB:e,dotNH:s,dotTH:i,dotBH:r})=>{const n=t.mul(e),a=Nr(e.mul(i),t.mul(r),n.mul(s)),o=a.dot(a),h=n.div(o);return cd.mul(n.mul(h.pow2()))}).setLayout({name:"D_GGX_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotNH",type:"float",qualifier:"in"},{name:"dotTH",type:"float",qualifier:"in"},{name:"dotBH",type:"float",qualifier:"in"}]}),pd=hr(t=>{const{lightDirection:e,f0:s,f90:i,roughness:r,f:n,USE_IRIDESCENCE:a,USE_ANISOTROPY:o}=t,h=t.normalView||cl,l=r.pow2(),u=e.add(sl).normalize(),c=h.dot(e).clamp(),d=h.dot(sl).clamp(),p=h.dot(u).clamp(),m=sl.dot(u).clamp();let g,y,f=rd({f0:s,f90:i,dotVH:m});if(tr(a)&&(f=sn.mix(f,n)),tr(o)){const t=hn.dot(e),s=hn.dot(sl),i=hn.dot(u),r=ln.dot(e),n=ln.dot(sl),a=ln.dot(u);g=ld({alphaT:an,alphaB:l,dotTV:s,dotBV:n,dotTL:t,dotBL:r,dotNV:d,dotNL:c}),y=dd({alphaT:an,alphaB:l,dotNH:p,dotTH:i,dotBH:a})}else g=hd({alpha:l,dotNL:c,dotNV:d}),y=ud({alpha:l,dotNH:p});return f.mul(g).mul(y)}),md=hr(({roughness:t,dotNV:e})=>{const s=Sr(-1,-.0275,-.572,.022),i=Sr(1,.0425,1.04,-.04),r=t.mul(s).add(i),n=r.x.mul(r.x).min(e.mul(-9.28).exp2()).mul(r.x).add(r.y);return xr(-1.04,1.04).mul(n).add(r.zw)}).setLayout({name:"DFGApprox",type:"vec2",inputs:[{name:"roughness",type:"float"},{name:"dotNV",type:"vec3"}]}),gd=hr(({f:t,f90:e,dotVH:s})=>{const i=s.oneMinus().saturate(),r=i.mul(i),n=i.mul(r,r).clamp(0,.9999);return t.sub(Nr(e).mul(n)).div(n.oneMinus())}).setLayout({name:"Schlick_to_F0",type:"vec3",inputs:[{name:"f",type:"vec3"},{name:"f90",type:"float"},{name:"dotVH",type:"float"}]}),yd=1/6,fd=t=>Cn(yd,Cn(t,Cn(t,t.negate().add(3)).sub(3)).add(1)),xd=t=>Cn(yd,Cn(t,Cn(t,Cn(3,t).sub(6))).add(4)),bd=t=>Cn(yd,Cn(t,Cn(t,Cn(-3,t).add(3)).add(3)).add(1)),vd=t=>Cn(yd,qa(t,3)),wd=t=>fd(t).add(xd(t)),Nd=t=>bd(t).add(vd(t)),Td=t=>zn(-1,xd(t).div(fd(t).add(xd(t)))),Md=t=>zn(1,vd(t).div(bd(t).add(vd(t)))),_d=(t,e,s)=>{const i=t.uvNode,r=Cn(i,e.zw).add(.5),n=ca(r),a=ma(r),o=wd(a.x),h=Nd(a.x),l=Td(a.x),u=Md(a.x),c=Td(a.y),d=Md(a.y),p=xr(n.x.add(l),n.y.add(c)).sub(.5).mul(e.xy),m=xr(n.x.add(u),n.y.add(c)).sub(.5).mul(e.xy),g=xr(n.x.add(l),n.y.add(d)).sub(.5).mul(e.xy),y=xr(n.x.add(u),n.y.add(d)).sub(.5).mul(e.xy),f=wd(a.y).mul(zn(o.mul(t.sample(p).level(s)),h.mul(t.sample(m).level(s)))),x=Nd(a.y).mul(zn(o.mul(t.sample(g).level(s)),h.mul(t.sample(y).level(s))));return f.add(x)},Sd=hr(([t,e=mr(3)])=>{const s=xr(t.size(gr(e))),i=xr(t.size(gr(e.add(1)))),r=In(1,s),n=In(1,i),a=_d(t,Sr(r,s),ca(e)),o=_d(t,Sr(n,i),da(e));return ma(e).mix(a,o)});Nr(.04),mr(1);const Ad=mr(1),zd=mr(-2),Vd=mr(.8),Cd=mr(-1),Id=mr(.4),Rd=mr(2),Ed=mr(.305),Od=mr(3),Fd=mr(.21),Bd=mr(4),Ld=mr(4),Pd=mr(16),Dd=hr(([t])=>{const e=Nr(wa(t)).toVar(),s=mr(-1).toVar();return cr(e.x.greaterThan(e.z),()=>{cr(e.x.greaterThan(e.y),()=>{s.assign(uo(t.x.greaterThan(0),0,3))}).Else(()=>{s.assign(uo(t.y.greaterThan(0),1,4))})}).Else(()=>{cr(e.z.greaterThan(e.y),()=>{s.assign(uo(t.z.greaterThan(0),2,5))}).Else(()=>{s.assign(uo(t.y.greaterThan(0),1,4))})}),s}).setLayout({name:"getFace",type:"float",inputs:[{name:"direction",type:"vec3"}]}),kd=hr(([t,e])=>{const s=xr().toVar();return cr(e.equal(0),()=>{s.assign(xr(t.z,t.y).div(wa(t.x)))}).ElseIf(e.equal(1),()=>{s.assign(xr(t.x.negate(),t.z.negate()).div(wa(t.y)))}).ElseIf(e.equal(2),()=>{s.assign(xr(t.x.negate(),t.y).div(wa(t.z)))}).ElseIf(e.equal(3),()=>{s.assign(xr(t.z.negate(),t.y).div(wa(t.x)))}).ElseIf(e.equal(4),()=>{s.assign(xr(t.x.negate(),t.z).div(wa(t.y)))}).Else(()=>{s.assign(xr(t.x,t.y).div(wa(t.z)))}),Cn(.5,s.add(1))}).setLayout({name:"getUV",type:"vec2",inputs:[{name:"direction",type:"vec3"},{name:"face",type:"float"}]}),Ud=hr(([t])=>{const e=mr(0).toVar();return cr(t.greaterThanEqual(Vd),()=>{e.assign(Ad.sub(t).mul(Cd.sub(zd)).div(Ad.sub(Vd)).add(zd))}).ElseIf(t.greaterThanEqual(Id),()=>{e.assign(Vd.sub(t).mul(Rd.sub(Cd)).div(Vd.sub(Id)).add(Cd))}).ElseIf(t.greaterThanEqual(Ed),()=>{e.assign(Id.sub(t).mul(Od.sub(Rd)).div(Id.sub(Ed)).add(Rd))}).ElseIf(t.greaterThanEqual(Fd),()=>{e.assign(Ed.sub(t).mul(Bd.sub(Od)).div(Ed.sub(Fd)).add(Od))}).Else(()=>{e.assign(mr(-2).mul(ha(Cn(1.16,t))))}),e}).setLayout({name:"roughnessToMip",type:"float",inputs:[{name:"roughness",type:"float"}]}),Wd=hr(([t,e])=>{const s=t.toVar();s.assign(Cn(2,s).sub(1));const i=Nr(s,1).toVar();return cr(e.equal(0),()=>{i.assign(i.zyx)}).ElseIf(e.equal(1),()=>{i.assign(i.xzy),i.xz.mulAssign(-1)}).ElseIf(e.equal(2),()=>{i.x.mulAssign(-1)}).ElseIf(e.equal(3),()=>{i.assign(i.zyx),i.xz.mulAssign(-1)}).ElseIf(e.equal(4),()=>{i.assign(i.xzy),i.xy.mulAssign(-1)}).ElseIf(e.equal(5),()=>{i.z.mulAssign(-1)}),i}).setLayout({name:"getDirection",type:"vec3",inputs:[{name:"uv",type:"vec2"},{name:"face",type:"float"}]}),jd=hr(([t,e,s,i,r,n])=>{const a=mr(s),o=Nr(e),h=Ka(Ud(a),zd,n),l=ma(h),u=ca(h),c=Nr(qd(t,o,u,i,r,n)).toVar();return cr(l.notEqual(0),()=>{const e=Nr(qd(t,o,u.add(1),i,r,n)).toVar();c.assign(Ja(c,e,l))}),c}),qd=hr(([t,e,s,i,r,n])=>{const a=mr(s).toVar(),o=Nr(e),h=mr(Dd(o)).toVar(),l=mr(Ba(Ld.sub(a),0)).toVar();a.assign(Ba(a,Ld));const u=mr(aa(a)).toVar(),c=xr(kd(o,h).mul(u.sub(2)).add(1)).toVar();return cr(h.greaterThan(2),()=>{c.y.addAssign(u),h.subAssign(3)}),c.x.addAssign(h.mul(u)),c.x.addAssign(l.mul(Cn(3,Pd))),c.y.addAssign(Cn(4,aa(n).sub(u))),c.x.mulAssign(i),c.y.mulAssign(r),t.sample(c).grad(xr(),xr())}),Hd=hr(({envMap:t,mipInt:e,outputDirection:s,theta:i,axis:r,CUBEUV_TEXEL_WIDTH:n,CUBEUV_TEXEL_HEIGHT:a,CUBEUV_MAX_MIP:o})=>{const h=ya(i),l=s.mul(h).add(r.cross(s).mul(ga(i))).add(r.mul(r.dot(s).mul(h.oneMinus())));return qd(t,l,e,n,a,o)}),Gd=hr(({n:t,latitudinal:e,poleAxis:s,outputDirection:i,weights:r,samples:n,dTheta:a,mipInt:o,envMap:h,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c})=>{const d=Nr(uo(e,s,ja(s,i))).toVar();cr(ea(d.equals(Nr(0))),()=>{d.assign(Nr(i.z,0,i.x.negate()))}),d.assign(pa(d));const p=Nr().toVar();return p.addAssign(r.element(0).mul(Hd({theta:0,axis:d,outputDirection:i,mipInt:o,envMap:h,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c}))),ac({start:gr(1),end:t},({i:t})=>{cr(t.greaterThanEqual(n),()=>{oc()});const e=mr(a.mul(mr(t))).toVar();p.addAssign(r.element(t).mul(Hd({theta:e.mul(-1),axis:d,outputDirection:i,mipInt:o,envMap:h,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c}))),p.addAssign(r.element(t).mul(Hd({theta:e,axis:d,outputDirection:i,mipInt:o,envMap:h,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c})))}),Sr(p,1)}),Xd=[.125,.215,.35,.446,.526,.582],Yd=20,$d=new js(-1,1,1,-1,0,1),Zd=new ys(90,1),Jd=new ze;let Kd=null,Qd=0,tp=0;const ep=(1+Math.sqrt(5))/2,sp=1/ep,ip=[new at(-ep,sp,0),new at(ep,sp,0),new at(-sp,0,ep),new at(sp,0,ep),new at(0,ep,-sp),new at(0,ep,sp),new at(-1,1,-1),new at(1,1,-1),new at(-1,1,1),new at(1,1,1)],rp=new at,np=new WeakMap,ap=[3,1,5,0,4,2],op=Wd(oh(),ah("faceIndex")).normalize(),hp=Nr(op.x,op.y,op.z);class lp{constructor(t){this._renderer=t,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._backgroundBox=null}get _hasInitialized(){return this._renderer.hasInitialized()}fromScene(t,e=0,s=.1,i=100,r={}){const{size:n=256,position:a=rp,renderTarget:o=null}=r;if(this._setSize(n),!1===this._hasInitialized){const n=o||this._allocateTargets();return r.renderTarget=n,this.fromSceneAsync(t,e,s,i,r),n}Kd=this._renderer.getRenderTarget(),Qd=this._renderer.getActiveCubeFace(),tp=this._renderer.getActiveMipmapLevel();const h=o||this._allocateTargets();return h.depthBuffer=!0,this._sceneToCubeUV(t,s,i,h,a),e>0&&this._blur(h,0,0,e),this._applyPMREM(h),this._cleanup(h),h}async fromSceneAsync(t,e=0,s=.1,i=100,r={}){return!1===this._hasInitialized&&await this._renderer.init(),this.fromScene(t,e,s,i,r)}fromEquirectangular(t,e=null){if(!1===this._hasInitialized){this._setSizeFromTexture(t);const s=e||this._allocateTargets();return this.fromEquirectangularAsync(t,s),s}return this._fromTexture(t,e)}async fromEquirectangularAsync(t,e=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(t,e)}fromCubemap(t,e=null){if(!1===this._hasInitialized){this._setSizeFromTexture(t);const s=e||this._allocateTargets();return this.fromCubemapAsync(t,e),s}return this._fromTexture(t,e)}async fromCubemapAsync(t,e=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(t,e)}async compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=pp(),await this._compileMaterial(this._cubemapMaterial))}async compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=mp(),await this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose(),null!==this._backgroundBox&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSizeFromTexture(t){t.mapping===e||t.mapping===s?this._setSize(0===t.image.length?16:t.image[0].width||t.image[0].image.width):this._setSize(t.image.width/4)}_setSize(t){this._lodMax=Math.floor(Math.log2(t)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let t=0;t<this._lodPlanes.length;t++)this._lodPlanes[t].dispose()}_cleanup(t){this._renderer.setRenderTarget(Kd,Qd,tp),t.scissorTest=!1,cp(t,0,0,t.width,t.height)}_fromTexture(t,e){this._setSizeFromTexture(t),Kd=this._renderer.getRenderTarget(),Qd=this._renderer.getActiveCubeFace(),tp=this._renderer.getActiveMipmapLevel();const s=e||this._allocateTargets();return this._textureToCubeUV(t,s),this._applyPMREM(s),this._cleanup(s),s}_allocateTargets(){const t=3*Math.max(this._cubeSize,112),e=4*this._cubeSize,s={magFilter:o,minFilter:o,generateMipmaps:!1,type:c,format:d,colorSpace:b},i=up(t,e,s);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==t||this._pingPongRenderTarget.height!==e){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=up(t,e,s);const{_lodMax:i}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas,lodMeshes:this._lodMeshes}=function(t){const e=[],s=[],i=[],r=[];let n=t;const a=t-4+1+Xd.length;for(let o=0;o<a;o++){const a=Math.pow(2,n);s.push(a);let h=1/a;o>t-4?h=Xd[o-t+4-1]:0===o&&(h=0),i.push(h);const l=1/(a-2),u=-l,c=1+l,d=[u,u,c,u,c,c,u,u,c,c,u,c],p=6,m=6,g=3,y=2,f=1,x=new Float32Array(g*m*p),b=new Float32Array(y*m*p),v=new Float32Array(f*m*p);for(let t=0;t<p;t++){const e=t%3*2/3-1,s=t>2?0:-1,i=[e,s,0,e+2/3,s,0,e+2/3,s+1,0,e,s,0,e+2/3,s+1,0,e,s+1,0],r=ap[t];x.set(i,g*m*r),b.set(d,y*m*r);const n=[r,r,r,r,r,r];v.set(n,f*m*r)}const w=new Je;w.setAttribute("position",new ke(x,g)),w.setAttribute("uv",new ke(b,y)),w.setAttribute("faceIndex",new ke(v,f)),e.push(w),r.push(new ls(w,null)),n>4&&n--}return{lodPlanes:e,sizeLods:s,sigmas:i,lodMeshes:r}}(i)),this._blurMaterial=function(t,e,s){const i=bh(new Array(Yd).fill(0)),r=qr(new at(0,1,0)),n=qr(0),a=mr(Yd),o=qr(0),h=qr(1),l=ph(null),u=qr(0),c=mr(1/e),d=mr(1/s),p=mr(t),m={n:a,latitudinal:o,weights:i,poleAxis:r,outputDirection:hp,dTheta:n,samples:h,envMap:l,mipInt:u,CUBEUV_TEXEL_WIDTH:c,CUBEUV_TEXEL_HEIGHT:d,CUBEUV_MAX_MIP:p},g=dp("blur");return g.fragmentNode=Gd({...m,latitudinal:o.equal(1)}),np.set(g,m),g}(i,t,e)}return i}async _compileMaterial(t){const e=new ls(this._lodPlanes[0],t);await this._renderer.compile(e,$d)}_sceneToCubeUV(t,e,s,i,r){const n=Zd;n.near=e,n.far=s;const a=[1,1,1,1,-1,1],o=[1,-1,1,-1,1,-1],h=this._renderer,l=h.autoClear;h.getClearColor(Jd),h.autoClear=!1;let u=this._backgroundBox;if(null===u){const t=new Re({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1});u=new ls(new cs,t)}let c=!1;const d=t.background;d?d.isColor&&(u.material.color.copy(d),t.background=null,c=!0):(u.material.color.copy(Jd),c=!0),h.setRenderTarget(i),h.clear(),c&&h.render(u,n);for(let e=0;e<6;e++){const s=e%3;0===s?(n.up.set(0,a[e],0),n.position.set(r.x,r.y,r.z),n.lookAt(r.x+o[e],r.y,r.z)):1===s?(n.up.set(0,0,a[e]),n.position.set(r.x,r.y,r.z),n.lookAt(r.x,r.y+o[e],r.z)):(n.up.set(0,a[e],0),n.position.set(r.x,r.y,r.z),n.lookAt(r.x,r.y,r.z+o[e]));const l=this._cubeSize;cp(i,s*l,e>2?l:0,l,l),h.render(t,n)}h.autoClear=l,t.background=d}_textureToCubeUV(t,i){const r=this._renderer,n=t.mapping===e||t.mapping===s;n?null===this._cubemapMaterial&&(this._cubemapMaterial=pp(t)):null===this._equirectMaterial&&(this._equirectMaterial=mp(t));const a=n?this._cubemapMaterial:this._equirectMaterial;a.fragmentNode.value=t;const o=this._lodMeshes[0];o.material=a;const h=this._cubeSize;cp(i,0,0,3*h,2*h),r.setRenderTarget(i),r.render(o,$d)}_applyPMREM(t){const e=this._renderer,s=e.autoClear;e.autoClear=!1;const i=this._lodPlanes.length;for(let e=1;e<i;e++){const s=Math.sqrt(this._sigmas[e]*this._sigmas[e]-this._sigmas[e-1]*this._sigmas[e-1]),r=ip[(i-e-1)%ip.length];this._blur(t,e-1,e,s,r)}e.autoClear=s}_blur(t,e,s,i,r){const n=this._pingPongRenderTarget;this._halfBlur(t,n,e,s,i,"latitudinal",r),this._halfBlur(n,t,s,s,i,"longitudinal",r)}_halfBlur(t,e,s,i,r,n,a){const o=this._renderer,h=this._blurMaterial,l=this._lodMeshes[i];l.material=h;const u=np.get(h),c=this._sizeLods[s]-1,d=isFinite(r)?Math.PI/(2*c):2*Math.PI/39,p=r/d,m=isFinite(r)?1+Math.floor(3*p):Yd,g=[];let y=0;for(let t=0;t<Yd;++t){const e=t/p,s=Math.exp(-e*e/2);g.push(s),0===t?y+=s:t<m&&(y+=2*s)}for(let t=0;t<g.length;t++)g[t]=g[t]/y;t.texture.frame=(t.texture.frame||0)+1,u.envMap.value=t.texture,u.samples.value=m,u.weights.array=g,u.latitudinal.value="latitudinal"===n?1:0,a&&(u.poleAxis.value=a);const{_lodMax:f}=this;u.dTheta.value=d,u.mipInt.value=f-s;const x=this._sizeLods[i];cp(e,3*x*(i>f-4?i-f+4:0),4*(this._cubeSize-x),3*x,2*x),o.setRenderTarget(e),o.render(l,$d)}}function up(t,e,s){const i=new it(t,e,s);return i.texture.mapping=306,i.texture.name="PMREM.cubeUv",i.texture.isPMREMTexture=!0,i.scissorTest=!0,i}function cp(t,e,s,i,r){t.viewport.set(e,s,i,r),t.scissor.set(e,s,i,r)}function dp(t){const e=new Kc;return e.depthTest=!1,e.depthWrite=!1,e.blending=0,e.name=`PMREM_${t}`,e}function pp(t){const e=dp("cubemap");return e.fragmentNode=Sl(t,hp),e}function mp(t){const e=dp("equirect");return e.fragmentNode=ph(t,id(hp),0),e}const gp=new WeakMap;function yp(t,e,s){const i=function(t){let e=gp.get(t);void 0===e&&(e=new WeakMap,gp.set(t,e));return e}(e);let r=i.get(t);if((void 0!==r?r.pmremVersion:-1)!==t.pmremVersion){const e=t.image;if(t.isCubeTexture){if(!function(t){if(null==t)return!1;let e=0;const s=6;for(let i=0;i<s;i++)void 0!==t[i]&&e++;return e===s}(e))return null;r=s.fromCubemap(t,r)}else{if(!function(t){return null!=t&&t.height>0}(e))return null;r=s.fromEquirectangular(t,r)}r.pmremVersion=t.pmremVersion,i.set(t,r)}return r.texture}class fp extends xi{static get type(){return"PMREMNode"}constructor(t,e=null,s=null){super("vec3"),this._value=t,this._pmrem=null,this.uvNode=e,this.levelNode=s,this._generator=null;const i=new et;i.isRenderTargetTexture=!0,this._texture=ph(i),this._width=qr(0),this._height=qr(0),this._maxMip=qr(0),this.updateBeforeType=li.RENDER}set value(t){this._value=t,this._pmrem=null}get value(){return this._value}updateFromTexture(t){const e=function(t){const e=Math.log2(t)-2,s=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,e),112)),texelHeight:s,maxMip:e}}(t.image.height);this._texture.value=t,this._width.value=e.texelWidth,this._height.value=e.texelHeight,this._maxMip.value=e.maxMip}updateBefore(t){let e=this._pmrem;const s=e?e.pmremVersion:-1,i=this._value;s!==i.pmremVersion&&(e=!0===i.isPMREMTexture?i:yp(i,t.renderer,this._generator),null!==e&&(this._pmrem=e,this.updateFromTexture(e)))}setup(t){null===this._generator&&(this._generator=new lp(t.renderer)),this.updateBefore(t);let e=this.uvNode;null===e&&t.context.getUV&&(e=t.context.getUV(this)),e=vl.mul(Nr(e.x,e.y.negate(),e.z));let s=this.levelNode;return null===s&&t.context.getTextureLevel&&(s=t.context.getTextureLevel(this)),jd(this._texture,e,s,this._width,this._height,this._maxMip)}dispose(){super.dispose(),null!==this._generator&&this._generator.dispose()}}const xp=ar(fp);class bp extends xi{static get type(){return"MatcapUVNode"}constructor(){super("vec2")}setup(){const t=Nr(sl.z,0,sl.x.negate()).normalize(),e=sl.cross(t);return xr(t.dot(cl),e.dot(cl)).mul(.495).add(.5)}}const vp=or(bp);class wp extends xi{static get type(){return"RotateNode"}constructor(t,e){super(),this.positionNode=t,this.rotationNode=e}getNodeType(t){return this.positionNode.getNodeType(t)}setup(t){const{rotationNode:e,positionNode:s}=this;if("vec2"===this.getNodeType(t)){const t=e.cos(),i=e.sin();return Cr(t,i,i.negate(),t).mul(s)}{const t=e,i=Rr(Sr(1,0,0,0),Sr(0,ya(t.x),ga(t.x).negate(),0),Sr(0,ga(t.x),ya(t.x),0),Sr(0,0,0,1)),r=Rr(Sr(ya(t.y),0,ga(t.y),0),Sr(0,1,0,0),Sr(ga(t.y).negate(),0,ya(t.y),0),Sr(0,0,0,1)),n=Rr(Sr(ya(t.z),ga(t.z).negate(),0,0),Sr(ga(t.z),ya(t.z),0,0),Sr(0,0,1,0),Sr(0,0,0,1));return i.mul(r).mul(n).mul(Sr(s,1)).xyz}}}const Np=ar(wp);Gr("vec3"),Gr("vec3"),Gr("vec3");class Tp extends Hr{static get type(){return"ParameterNode"}constructor(t,e=null){super(t,e),this.isParameterNode=!0}getHash(){return this.uuid}generate(){return this.name}}class Mp extends gi{static get type(){return"StackNode"}constructor(t=null){super(),this.nodes=[],this.outputNode=null,this.parent=t,this._currentCond=null,this.isStackNode=!0}getNodeType(t){return this.outputNode?this.outputNode.getNodeType(t):"void"}getMemberType(t,e){return this.outputNode?this.outputNode.getMemberType(t,e):"void"}add(t){return this.nodes.push(t),this}If(t,e){const s=new sr(e);return this._currentCond=uo(t,s),this.add(this._currentCond)}ElseIf(t,e){const s=new sr(e),i=uo(t,s);return this._currentCond.elseNode=i,this._currentCond=i,this}Else(t){return this._currentCond.elseNode=new sr(t),this}build(t,...e){const s=ur();lr(this);for(const e of this.nodes)e.build(t,"void");return lr(s),this.outputNode?this.outputNode.build(t,...e):super.build(t,...e)}else(...t){return this.Else(...t)}elseif(...t){return this.ElseIf(...t)}}const _p=ar(Mp);class Sp extends gi{static get type(){return"StructTypeNode"}constructor(t,e=null){var s;super("struct"),this.membersLayout=(s=t,Object.entries(s).map(([t,e])=>"string"==typeof e?{name:t,type:e,atomic:!1}:{name:t,type:e.type,atomic:e.atomic||!1})),this.name=e,this.isStructLayoutNode=!0}getLength(){let t=0;for(const e of this.membersLayout)t+=si(e.type);return t}getMemberType(t,e){const s=this.membersLayout.find(t=>t.name===e);return s?s.type:"void"}getNodeType(t){return t.getStructTypeFromNode(this,this.membersLayout,this.name).name}setup(t){t.addInclude(this)}generate(t){return this.getNodeType(t)}}class Ap extends gi{static get type(){return"StructNode"}constructor(t,e){super("vec3"),this.structLayoutNode=t,this.values=e,this.isStructNode=!0}getNodeType(t){return this.structLayoutNode.getNodeType(t)}getMemberType(t,e){return this.structLayoutNode.getMemberType(t,e)}generate(t){const e=t.getVarFromNode(this),s=e.type,i=t.getPropertyName(e);return t.addLineFlowCode(`${i} = ${t.generateStruct(s,this.structLayoutNode.membersLayout,this.values)}`,this),e.name}}class zp extends gi{static get type(){return"OutputStructNode"}constructor(...t){super(),this.members=t,this.isOutputStructNode=!0}getNodeType(t){const e=t.getNodeProperties(this);if(void 0===e.membersLayout){const s=this.members,i=[];for(let e=0;e<s.length;e++){const r="m"+e,n=s[e].getNodeType(t);i.push({name:r,type:n,index:e})}e.membersLayout=i,e.structType=t.getOutputStructTypeFromNode(this,e.membersLayout)}return e.structType.name}generate(t){const e=t.getOutputStructName(),s=this.members,i=""!==e?e+".":"";for(let e=0;e<s.length;e++){const r=s[e].build(t);t.addLineFlowCode(`${i}m${e} = ${r}`,this)}return e}}const Vp=ar(zp);function Cp(t,e){for(let s=0;s<t.length;s++)if(t[s].name===e)return s;return-1}class Ip extends zp{static get type(){return"MRTNode"}constructor(t){super(),this.outputNodes=t,this.isMRTNode=!0}has(t){return void 0!==this.outputNodes[t]}get(t){return this.outputNodes[t]}merge(t){const e={...this.outputNodes,...t.outputNodes};return Rp(e)}setup(t){const e=this.outputNodes,s=[],i=t.renderer.getRenderTarget().textures;for(const t in e){s[Cp(i,t)]=Sr(e[t])}return this.members=s,super.setup(t)}}const Rp=ar(Ip),Ep=hr(([t])=>{const e=t.toUint().mul(747796405).add(2891336453),s=e.shiftRight(e.shiftRight(28).add(4)).bitXor(e).mul(277803737);return s.shiftRight(22).bitXor(s).toFloat().mul(1/2**32)}),Op=(t,e)=>qa(Cn(4,t.mul(Vn(1,t))),e),Fp=hr(([t])=>t.fract().sub(.5).abs()).setLayout({name:"tri",type:"float",inputs:[{name:"x",type:"float"}]}),Bp=hr(([t])=>Nr(Fp(t.z.add(Fp(t.y.mul(1)))),Fp(t.z.add(Fp(t.x.mul(1)))),Fp(t.y.add(Fp(t.x.mul(1)))))).setLayout({name:"tri3",type:"vec3",inputs:[{name:"p",type:"vec3"}]}),Lp=hr(([t,e,s])=>{const i=Nr(t).toVar(),r=mr(1.4).toVar(),n=mr(0).toVar(),a=Nr(i).toVar();return ac({start:mr(0),end:mr(3),type:"float",condition:"<="},()=>{const t=Nr(Bp(a.mul(2))).toVar();i.addAssign(t.add(s.mul(mr(.1).mul(e)))),a.mulAssign(1.8),r.mulAssign(1.5),i.mulAssign(1.2);const o=mr(Fp(i.z.add(Fp(i.x.add(Fp(i.y)))))).toVar();n.addAssign(o.div(r)),a.addAssign(.14)}),n}).setLayout({name:"triNoise3D",type:"float",inputs:[{name:"position",type:"vec3"},{name:"speed",type:"float"},{name:"time",type:"float"}]});class Pp extends gi{static get type(){return"FunctionOverloadingNode"}constructor(t=[],...e){super(),this.functionNodes=t,this.parametersNodes=e,this._candidateFnCall=null,this.global=!0}getNodeType(){return this.functionNodes[0].shaderNode.layout.type}setup(t){const e=this.parametersNodes;let s=this._candidateFnCall;if(null===s){let i=null,r=-1;for(const s of this.functionNodes){const n=s.shaderNode.layout;if(null===n)throw new Error("FunctionOverloadingNode: FunctionNode must be a layout.");const a=n.inputs;if(e.length===a.length){let n=0;for(let s=0;s<e.length;s++){const i=e[s],r=a[s];i.getNodeType(t)===r.type?n++:n=0}n>r&&(i=s,r=n)}}this._candidateFnCall=s=i(...e)}return s}}const Dp=ar(Pp),kp=t=>(...e)=>Dp(t,...e),Up=qr(0).setGroup(Ur).onRenderUpdate(t=>t.time),Wp=qr(0).setGroup(Ur).onRenderUpdate(t=>t.deltaTime),jp=qr(0,"uint").setGroup(Ur).onRenderUpdate(t=>t.frameId),qp=hr(([t,e,s=xr(.5)])=>Np(t.sub(s),e).add(s)),Hp=hr(([t,e,s=xr(.5)])=>{const i=t.sub(s),r=i.dot(i),n=r.mul(r).mul(e);return t.add(i.mul(n))}),Gp=hr(({position:t=null,horizontal:e=!0,vertical:s=!1})=>{let i;null!==t?(i=Dh.toVar(),i[3][0]=t.x,i[3][1]=t.y,i[3][2]=t.z):i=Dh;const r=_h.mul(i);return tr(e)&&(r[0][0]=Dh[0].length(),r[0][1]=0,r[0][2]=0),tr(s)&&(r[1][0]=0,r[1][1]=Dh[1].length(),r[1][2]=0),r[2][0]=0,r[2][1]=0,r[2][2]=1,Th.mul(r).mul(Jh)}),Xp=hr(([t=null])=>{const e=Hc();return Hc(Lc(t)).sub(e).lessThan(0).select(wc,t)});class Yp extends gi{static get type(){return"SpriteSheetUVNode"}constructor(t,e=oh(),s=mr(0)){super("vec2"),this.countNode=t,this.uvNode=e,this.frameNode=s}setup(){const{frameNode:t,uvNode:e,countNode:s}=this,{width:i,height:r}=s,n=t.mod(i.mul(r)).floor(),a=n.mod(i),o=r.sub(n.add(1).div(i).ceil()),h=s.reciprocal(),l=xr(a,o);return e.add(l).mul(h)}}const $p=ar(Yp);class Zp extends gi{static get type(){return"TriplanarTexturesNode"}constructor(t,e=null,s=null,i=mr(1),r=Jh,n=ol){super("vec4"),this.textureXNode=t,this.textureYNode=e,this.textureZNode=s,this.scaleNode=i,this.positionNode=r,this.normalNode=n}setup(){const{textureXNode:t,textureYNode:e,textureZNode:s,scaleNode:i,positionNode:r,normalNode:n}=this;let a=n.abs().normalize();a=a.div(a.dot(Nr(1)));const o=r.yz.mul(i),h=r.zx.mul(i),l=r.xy.mul(i),u=t.value,c=null!==e?e.value:u,d=null!==s?s.value:u,p=ph(u,o).mul(a.x),m=ph(c,h).mul(a.y),g=ph(d,l).mul(a.z);return zn(p,m,g)}}const Jp=ar(Zp),Kp=new Ms,Qp=new at,tm=new at,em=new at,sm=new Bt,im=new at(0,0,-1),rm=new st,nm=new at,am=new at,om=new st,hm=new D,lm=new it,um=wc.flipX();lm.depthTexture=new Ss(1,1);let cm=!1;class dm extends dh{static get type(){return"ReflectorNode"}constructor(t={}){super(t.defaultTexture||lm.texture,um),this._reflectorBaseNode=t.reflector||new pm(this,t),this._depthNode=null,this.setUpdateMatrix(!1)}get reflector(){return this._reflectorBaseNode}get target(){return this._reflectorBaseNode.target}getDepthNode(){if(null===this._depthNode){if(!0!==this._reflectorBaseNode.depth)throw new Error("THREE.ReflectorNode: Depth node can only be requested when the reflector is created with { depth: true }. ");this._depthNode=ir(new dm({defaultTexture:lm.depthTexture,reflector:this._reflectorBaseNode}))}return this._depthNode}setup(t){return t.object.isQuadMesh||this._reflectorBaseNode.build(t),super.setup(t)}clone(){const t=new this.constructor(this.reflectorNode);return t._reflectorBaseNode=this._reflectorBaseNode,t}}class pm extends gi{static get type(){return"ReflectorBaseNode"}constructor(t,e={}){super();const{target:s=new le,resolution:i=1,generateMipmaps:r=!1,bounces:n=!0,depth:a=!1}=e;this.textureNode=t,this.target=s,this.resolution=i,this.generateMipmaps=r,this.bounces=n,this.depth=a,this.updateBeforeType=n?li.RENDER:li.FRAME,this.virtualCameras=new WeakMap,this.renderTargets=new WeakMap,this.forceUpdate=!1}_updateResolution(t,e){const s=this.resolution;e.getDrawingBufferSize(hm),t.setSize(Math.round(hm.width*s),Math.round(hm.height*s))}setup(t){return this._updateResolution(lm,t.renderer),super.setup(t)}getVirtualCamera(t){let e=this.virtualCameras.get(t);return void 0===e&&(e=t.clone(),this.virtualCameras.set(t,e)),e}getRenderTarget(t){let e=this.renderTargets.get(t);return void 0===e&&(e=new it(0,0,{type:c}),!0===this.generateMipmaps&&(e.texture.minFilter=1008,e.texture.generateMipmaps=!0),!0===this.depth&&(e.depthTexture=new Ss),this.renderTargets.set(t,e)),e}updateBefore(t){if(!1===this.bounces&&cm)return!1;cm=!0;const{scene:e,camera:s,renderer:i,material:r}=t,{target:n}=this,a=this.getVirtualCamera(s),o=this.getRenderTarget(a);i.getDrawingBufferSize(hm),this._updateResolution(o,i),tm.setFromMatrixPosition(n.matrixWorld),em.setFromMatrixPosition(s.matrixWorld),sm.extractRotation(n.matrixWorld),Qp.set(0,0,1),Qp.applyMatrix4(sm),nm.subVectors(tm,em);if(!0===nm.dot(Qp)>0&&!1===this.forceUpdate)return;nm.reflect(Qp).negate(),nm.add(tm),sm.extractRotation(s.matrixWorld),im.set(0,0,-1),im.applyMatrix4(sm),im.add(em),am.subVectors(tm,im),am.reflect(Qp).negate(),am.add(tm),a.coordinateSystem=s.coordinateSystem,a.position.copy(nm),a.up.set(0,1,0),a.up.applyMatrix4(sm),a.up.reflect(Qp),a.lookAt(am),a.near=s.near,a.far=s.far,a.updateMatrixWorld(),a.projectionMatrix.copy(s.projectionMatrix),Kp.setFromNormalAndCoplanarPoint(Qp,tm),Kp.applyMatrix4(a.matrixWorldInverse),rm.set(Kp.normal.x,Kp.normal.y,Kp.normal.z,Kp.constant);const h=a.projectionMatrix;om.x=(Math.sign(rm.x)+h.elements[8])/h.elements[0],om.y=(Math.sign(rm.y)+h.elements[9])/h.elements[5],om.z=-1,om.w=(1+h.elements[10])/h.elements[14],rm.multiplyScalar(1/rm.dot(om));h.elements[2]=rm.x,h.elements[6]=rm.y,h.elements[10]=i.coordinateSystem===S?rm.z-0:rm.z+1-0,h.elements[14]=rm.w,this.textureNode.value=o.texture,!0===this.depth&&(this.textureNode.getDepthNode().value=o.depthTexture),r.visible=!1;const l=i.getRenderTarget(),u=i.getMRT(),c=i.autoClear;i.setMRT(null),i.setRenderTarget(o),i.autoClear=!0,i.render(e,a),i.setMRT(u),i.setRenderTarget(l),i.autoClear=c,r.visible=!0,cm=!1,this.forceUpdate=!1}}const mm=new js(-1,1,1,-1,0,1);class gm extends Je{constructor(t=!1){super();const e=!1===t?[0,-1,0,1,2,1]:[0,2,0,0,2,0];this.setAttribute("position",new je([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new je(e,2))}}const ym=new gm;class fm extends ls{constructor(t=null){super(ym,t),this.camera=mm,this.isQuadMesh=!0}async renderAsync(t){return t.renderAsync(this,mm)}render(t){t.render(this,mm)}}const xm=new D;class bm extends dh{static get type(){return"RTTNode"}constructor(t,e=null,s=null,i={type:c}){const r=new it(e,s,i);super(r.texture,oh()),this.node=t,this.width=e,this.height=s,this.pixelRatio=1,this.renderTarget=r,this.textureNeedsUpdate=!0,this.autoUpdate=!0,this._rttNode=null,this._quadMesh=new fm(new Kc),this.updateBeforeType=li.RENDER}get autoSize(){return null===this.width}setup(t){return this._rttNode=this.node.context(t.getSharedContext()),this._quadMesh.material.name="RTT",this._quadMesh.material.needsUpdate=!0,super.setup(t)}setSize(t,e){this.width=t,this.height=e;const s=t*this.pixelRatio,i=e*this.pixelRatio;this.renderTarget.setSize(s,i),this.textureNeedsUpdate=!0}setPixelRatio(t){this.pixelRatio=t,this.setSize(this.width,this.height)}updateBefore({renderer:t}){if(!1===this.textureNeedsUpdate&&!1===this.autoUpdate)return;if(this.textureNeedsUpdate=!1,!0===this.autoSize){this.pixelRatio=t.getPixelRatio();const e=t.getSize(xm);this.setSize(e.width,e.height)}this._quadMesh.material.fragmentNode=this._rttNode;const e=t.getRenderTarget();t.setRenderTarget(this.renderTarget),this._quadMesh.render(t),t.setRenderTarget(e)}clone(){const t=new dh(this.value,this.uvNode,this.levelNode);return t.sampler=this.sampler,t.referenceNode=this,t}}const vm=(t,...e)=>ir(new bm(ir(t),...e)),wm=hr(([t,e,s],i)=>{let r;i.renderer.coordinateSystem===S?(t=xr(t.x,t.y.oneMinus()).mul(2).sub(1),r=Sr(Nr(t,e),1)):r=Sr(Nr(t.x,t.y.oneMinus(),e).mul(2).sub(1),1);const n=Sr(s.mul(r));return n.xyz.div(n.w)}),Nm=hr(([t,e])=>{const s=e.mul(Sr(t,1)),i=s.xy.div(s.w).mul(.5).add(.5).toVar();return xr(i.x,i.y.oneMinus())}),Tm=hr(([t,e,s])=>{const i=lh(mh(e)),r=br(t.mul(i)).toVar(),n=mh(e,r).toVar(),a=mh(e,r.sub(br(2,0))).toVar(),o=mh(e,r.sub(br(1,0))).toVar(),h=mh(e,r.add(br(1,0))).toVar(),l=mh(e,r.add(br(2,0))).toVar(),u=mh(e,r.add(br(0,2))).toVar(),c=mh(e,r.add(br(0,1))).toVar(),d=mh(e,r.sub(br(0,1))).toVar(),p=mh(e,r.sub(br(0,2))).toVar(),m=wa(Vn(mr(2).mul(o).sub(a),n)).toVar(),g=wa(Vn(mr(2).mul(h).sub(l),n)).toVar(),y=wa(Vn(mr(2).mul(c).sub(u),n)).toVar(),f=wa(Vn(mr(2).mul(d).sub(p),n)).toVar(),x=wm(t,n,s).toVar(),b=m.lessThan(g).select(x.sub(wm(t.sub(xr(mr(1).div(i.x),0)),o,s)),x.negate().add(wm(t.add(xr(mr(1).div(i.x),0)),h,s))),v=y.lessThan(f).select(x.sub(wm(t.add(xr(0,mr(1).div(i.y))),c,s)),x.negate().add(wm(t.sub(xr(0,mr(1).div(i.y))),d,s)));return pa(ja(b,v))});class Mm extends vs{constructor(t,e,s=Float32Array){super(ArrayBuffer.isView(t)?t:new s(t*e),e),this.isStorageInstancedBufferAttribute=!0}}class _m extends ke{constructor(t,e,s=Float32Array){super(ArrayBuffer.isView(t)?t:new s(t*e),e),this.isStorageBufferAttribute=!0}}class Sm extends yi{static get type(){return"StorageArrayElementNode"}constructor(t,e){super(t,e),this.isStorageArrayElementNode=!0}set storageBufferNode(t){this.node=t}get storageBufferNode(){return this.node}getMemberType(t,e){const s=this.storageBufferNode.structTypeNode;return s?s.getMemberType(t,e):"void"}setup(t){return!1===t.isAvailable("storageBuffer")&&!0===this.node.isPBO&&t.setupPBO(this.node),super.setup(t)}generate(t,e){let s;const i=t.context.assign;if(s=!1===t.isAvailable("storageBuffer")?!0!==this.node.isPBO||!0===i||!this.node.value.isInstancedBufferAttribute&&"compute"===t.shaderStage?this.node.build(t):t.generatePBO(this):super.generate(t),!0!==i){const i=this.getNodeType(t);s=t.format(s,i,e)}return s}}const Am=ar(Sm);class zm extends gh{static get type(){return"StorageBufferNode"}constructor(t,e=null,s=0){let i,r=null;e&&e.isStruct?(i="struct",r=e.layout):null===e&&(t.isStorageBufferAttribute||t.isStorageInstancedBufferAttribute)?(i=function(t){return Qs.get(t)}(t.itemSize),s=t.count):i=e,super(t,i,s),this.isStorageBufferNode=!0,this.structTypeNode=r,this.access=ui.READ_WRITE,this.isAtomic=!1,this.isPBO=!1,this._attribute=null,this._varying=null,this.global=!0,!0!==t.isStorageBufferAttribute&&!0!==t.isStorageInstancedBufferAttribute&&(t.isInstancedBufferAttribute?t.isStorageInstancedBufferAttribute=!0:t.isStorageBufferAttribute=!0)}getHash(t){if(0===this.bufferCount){let e=t.globalCache.getData(this.value);return void 0===e&&(e={node:this},t.globalCache.setData(this.value,e)),e.node.uuid}return this.uuid}getInputType(){return this.value.isIndirectStorageBufferAttribute?"indirectStorageBuffer":"storageBuffer"}element(t){return Am(this,t)}setPBO(t){return this.isPBO=t,this}getPBO(){return this.isPBO}setAccess(t){return this.access=t,this}toReadOnly(){return this.setAccess(ui.READ_ONLY)}setAtomic(t){return this.isAtomic=t,this}toAtomic(){return this.setAtomic(!0)}getAttributeData(){return null===this._attribute&&(this._attribute=Uo(this.value),this._varying=No(this._attribute)),{attribute:this._attribute,varying:this._varying}}getNodeType(t){if(null!==this.structTypeNode)return this.structTypeNode.getNodeType(t);if(t.isAvailable("storageBuffer")||t.isAvailable("indirectStorageBuffer"))return super.getNodeType(t);const{attribute:e}=this.getAttributeData();return e.getNodeType(t)}generate(t){if(null!==this.structTypeNode&&this.structTypeNode.build(t),t.isAvailable("storageBuffer")||t.isAvailable("indirectStorageBuffer"))return super.generate(t);const{attribute:e,varying:s}=this.getAttributeData(),i=s.build(t);return t.registerTransform(i,e),i}}const Vm=(t,e=null,s=0)=>ir(new zm(t,e,s));class Cm extends nh{static get type(){return"VertexColorNode"}constructor(t=0){super(null,"vec4"),this.isVertexColorNode=!0,this.index=t}getAttributeName(){const t=this.index;return"color"+(t>0?t:"")}generate(t){const e=this.getAttributeName(t);let s;return s=!0===t.hasGeometryAttribute(e)?super.generate(t):t.generateConst(this.nodeType,new st(1,1,1,1)),s}serialize(t){super.serialize(t),t.index=this.index}deserialize(t){super.deserialize(t),this.index=t.index}}class Im extends gi{static get type(){return"PointUVNode"}constructor(){super("vec2"),this.isPointUVNode=!0}generate(){return"vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y )"}}const Rm=or(Im),Em=new Gt,Om=new Bt;class Fm extends gi{static get type(){return"SceneNode"}constructor(t=Fm.BACKGROUND_BLURRINESS,e=null){super(),this.scope=t,this.scene=e}setup(e){const s=this.scope,i=null!==this.scene?this.scene:e.scene;let r;return s===Fm.BACKGROUND_BLURRINESS?r=Vl("backgroundBlurriness","float",i):s===Fm.BACKGROUND_INTENSITY?r=Vl("backgroundIntensity","float",i):s===Fm.BACKGROUND_ROTATION&&(r=qr("mat4").label("backgroundRotation").setGroup(Ur).onRenderUpdate(()=>{const e=i.background;return null!==e&&e.isTexture&&e.mapping!==t?(Em.copy(i.backgroundRotation),Em.x*=-1,Em.y*=-1,Em.z*=-1,Om.makeRotationFromEuler(Em)):Om.identity(),Om})),r}}Fm.BACKGROUND_BLURRINESS="backgroundBlurriness",Fm.BACKGROUND_INTENSITY="backgroundIntensity",Fm.BACKGROUND_ROTATION="backgroundRotation";const Bm=or(Fm,Fm.BACKGROUND_BLURRINESS),Lm=or(Fm,Fm.BACKGROUND_INTENSITY),Pm=or(Fm,Fm.BACKGROUND_ROTATION);class Dm extends dh{static get type(){return"StorageTextureNode"}constructor(t,e,s=null){super(t,e),this.storeNode=s,this.isStorageTextureNode=!0,this.access=ui.WRITE_ONLY}getInputType(){return"storageTexture"}setup(t){super.setup(t);t.getNodeProperties(this).storeNode=this.storeNode}setAccess(t){return this.access=t,this}generate(t,e){let s;return s=null!==this.storeNode?this.generateStore(t):super.generate(t,e),s}toReadWrite(){return this.setAccess(ui.READ_WRITE)}toReadOnly(){return this.setAccess(ui.READ_ONLY)}toWriteOnly(){return this.setAccess(ui.WRITE_ONLY)}generateStore(t){const e=t.getNodeProperties(this),{uvNode:s,storeNode:i}=e,r=super.generate(t,"property"),n=s.build(t,"uvec2"),a=i.build(t,"vec4"),o=t.generateTextureStore(t,r,n,a);t.addLineFlowCode(o,this)}}const km=ar(Dm),Um=hr(({texture:t,uv:e})=>{const s=1e-4,i=Nr().toVar();return cr(e.x.lessThan(s),()=>{i.assign(Nr(1,0,0))}).ElseIf(e.y.lessThan(s),()=>{i.assign(Nr(0,1,0))}).ElseIf(e.z.lessThan(s),()=>{i.assign(Nr(0,0,1))}).ElseIf(e.x.greaterThan(.9999),()=>{i.assign(Nr(-1,0,0))}).ElseIf(e.y.greaterThan(.9999),()=>{i.assign(Nr(0,-1,0))}).ElseIf(e.z.greaterThan(.9999),()=>{i.assign(Nr(0,0,-1))}).Else(()=>{const s=.01,r=t.sample(e.add(Nr(-.01,0,0))).r.sub(t.sample(e.add(Nr(s,0,0))).r),n=t.sample(e.add(Nr(0,-.01,0))).r.sub(t.sample(e.add(Nr(0,s,0))).r),a=t.sample(e.add(Nr(0,0,-.01))).r.sub(t.sample(e.add(Nr(0,0,s))).r);i.assign(Nr(r,n,a))}),i.normalize()});class Wm extends dh{static get type(){return"Texture3DNode"}constructor(t,e=null,s=null){super(t,e,s),this.isTexture3DNode=!0}getInputType(){return"texture3D"}getDefaultUV(){return Nr(.5,.5,.5)}setUpdateMatrix(){}setupUV(t,e){const s=this.value;return!t.isFlipY()||!0!==s.isRenderTargetTexture&&!0!==s.isFramebufferTexture||(e=this.sampler?e.flipY():e.setY(gr(lh(this,this.levelNode).y).sub(e.y).sub(1))),e}generateUV(t,e){return e.build(t,"vec3")}normal(t){return Um({texture:this,uv:t})}}const jm=ar(Wm);class qm extends zl{static get type(){return"UserDataNode"}constructor(t,e,s=null){super(t,e,s),this.userData=s}updateReference(t){return this.reference=null!==this.userData?this.userData:t.object.userData,this.reference}}const Hm=new WeakMap;class Gm extends xi{static get type(){return"VelocityNode"}constructor(){super("vec2"),this.projectionMatrix=null,this.updateType=li.OBJECT,this.updateAfterType=li.OBJECT,this.previousModelWorldMatrix=qr(new Bt),this.previousProjectionMatrix=qr(new Bt).setGroup(Ur),this.previousCameraViewMatrix=qr(new Bt)}setProjectionMatrix(t){this.projectionMatrix=t}update({frameId:t,camera:e,object:s}){const i=Ym(s);this.previousModelWorldMatrix.value.copy(i);const r=Xm(e);r.frameId!==t&&(r.frameId=t,void 0===r.previousProjectionMatrix?(r.previousProjectionMatrix=new Bt,r.previousCameraViewMatrix=new Bt,r.currentProjectionMatrix=new Bt,r.currentCameraViewMatrix=new Bt,r.previousProjectionMatrix.copy(this.projectionMatrix||e.projectionMatrix),r.previousCameraViewMatrix.copy(e.matrixWorldInverse)):(r.previousProjectionMatrix.copy(r.currentProjectionMatrix),r.previousCameraViewMatrix.copy(r.currentCameraViewMatrix)),r.currentProjectionMatrix.copy(this.projectionMatrix||e.projectionMatrix),r.currentCameraViewMatrix.copy(e.matrixWorldInverse),this.previousProjectionMatrix.value.copy(r.previousProjectionMatrix),this.previousCameraViewMatrix.value.copy(r.previousCameraViewMatrix))}updateAfter({object:t}){Ym(t).copy(t.matrixWorld)}setup(){const t=null===this.projectionMatrix?Th:qr(this.projectionMatrix),e=this.previousCameraViewMatrix.mul(this.previousModelWorldMatrix),s=t.mul(Gh).mul(Jh),i=this.previousProjectionMatrix.mul(e).mul(Kh),r=s.xy.div(s.w),n=i.xy.div(i.w);return Vn(r,n)}}function Xm(t){let e=Hm.get(t);return void 0===e&&(e={},Hm.set(t,e)),e}function Ym(t,e=0){const s=Xm(t);let i=s[e];return void 0===i&&(s[e]=i=new Bt),i}const $m=or(Gm),Zm=hr(([t,e])=>Fa(1,t.oneMinus().div(e)).oneMinus()).setLayout({name:"blendBurn",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),Jm=hr(([t,e])=>Fa(t.div(e.oneMinus()),1)).setLayout({name:"blendDodge",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),Km=hr(([t,e])=>t.oneMinus().mul(e.oneMinus()).oneMinus()).setLayout({name:"blendScreen",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),Qm=hr(([t,e])=>Ja(t.mul(2).mul(e),t.oneMinus().mul(2).mul(e.oneMinus()).oneMinus(),Pa(.5,t))).setLayout({name:"blendOverlay",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),tg=hr(([t,e])=>{const s=e.a.add(t.a.mul(e.a.oneMinus()));return Sr(e.rgb.mul(e.a).add(t.rgb.mul(t.a).mul(e.a.oneMinus())).div(s),s)}).setLayout({name:"blendColor",type:"vec4",inputs:[{name:"base",type:"vec4"},{name:"blend",type:"vec4"}]}),eg=hr(([t])=>ng(t.rgb)),sg=hr(([t,e=mr(1)])=>e.mix(ng(t.rgb),t.rgb)),ig=hr(([t,e=mr(1)])=>{const s=zn(t.r,t.g,t.b).div(3),i=t.r.max(t.g.max(t.b)),r=i.sub(s).mul(e).mul(-3);return Ja(t.rgb,i,r)}),rg=hr(([t,e=mr(1)])=>{const s=Nr(.57735,.57735,.57735),i=e.cos();return Nr(t.rgb.mul(i).add(s.cross(t.rgb).mul(e.sin()).add(s.mul(Wa(s,t.rgb).mul(i.oneMinus())))))}),ng=(t,e=Nr(G.getLuminanceCoefficients(new at)))=>Wa(t,e),ag=hr(([t,e=Nr(1),s=Nr(0),i=Nr(1),r=mr(1),n=Nr(G.getLuminanceCoefficients(new at,b))])=>{const a=t.rgb.dot(Nr(n)),o=Ba(t.rgb.mul(e).add(s),0).toVar(),h=o.pow(i).toVar();return cr(o.r.greaterThan(0),()=>{o.r.assign(h.r)}),cr(o.g.greaterThan(0),()=>{o.g.assign(h.g)}),cr(o.b.greaterThan(0),()=>{o.b.assign(h.b)}),o.assign(a.add(o.sub(a).mul(r))),Sr(o.rgb,t.a)});class og extends xi{static get type(){return"PosterizeNode"}constructor(t,e){super(),this.sourceNode=t,this.stepsNode=e}setup(){const{sourceNode:t,stepsNode:e}=this;return t.mul(e).floor().div(e)}}const hg=ar(og),lg=new D;class ug extends dh{static get type(){return"PassTextureNode"}constructor(t,e){super(e),this.passNode=t,this.setUpdateMatrix(!1)}setup(t){return t.object.isQuadMesh&&this.passNode.build(t),super.setup(t)}clone(){return new this.constructor(this.passNode,this.value)}}class cg extends ug{static get type(){return"PassMultipleTextureNode"}constructor(t,e,s=!1){super(t,null),this.textureName=e,this.previousTexture=s}updateTexture(){this.value=this.previousTexture?this.passNode.getPreviousTexture(this.textureName):this.passNode.getTexture(this.textureName)}setup(t){return this.updateTexture(),super.setup(t)}clone(){return new this.constructor(this.passNode,this.textureName,this.previousTexture)}}class dg extends xi{static get type(){return"PassNode"}constructor(t,e,s,i={}){super("vec4"),this.scope=t,this.scene=e,this.camera=s,this.options=i,this._pixelRatio=1,this._width=1,this._height=1;const r=new Ss;r.isRenderTargetTexture=!0,r.name="depth";const n=new it(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:c,...i});n.texture.name="output",n.depthTexture=r,this.renderTarget=n,this._textures={output:n.texture,depth:r},this._textureNodes={},this._linearDepthNodes={},this._viewZNodes={},this._previousTextures={},this._previousTextureNodes={},this._cameraNear=qr(0),this._cameraFar=qr(0),this._mrt=null,this._layers=null,this._resolution=1,this.isPassNode=!0,this.updateBeforeType=li.FRAME}setResolution(t){return this._resolution=t,this}getResolution(){return this._resolution}setLayers(t){return this._layers=t,this}getLayers(){return this._layers}setMRT(t){return this._mrt=t,this}getMRT(){return this._mrt}isGlobal(){return!0}getTexture(t){let e=this._textures[t];if(void 0===e){e=this.renderTarget.texture.clone(),e.name=t,this._textures[t]=e,this.renderTarget.textures.push(e)}return e}getPreviousTexture(t){let e=this._previousTextures[t];return void 0===e&&(e=this.getTexture(t).clone(),this._previousTextures[t]=e),e}toggleTexture(t){const e=this._previousTextures[t];if(void 0!==e){const s=this._textures[t],i=this.renderTarget.textures.indexOf(s);this.renderTarget.textures[i]=e,this._textures[t]=e,this._previousTextures[t]=s,this._textureNodes[t].updateTexture(),this._previousTextureNodes[t].updateTexture()}}getTextureNode(t="output"){let e=this._textureNodes[t];return void 0===e&&(e=ir(new cg(this,t)),e.updateTexture(),this._textureNodes[t]=e),e}getPreviousTextureNode(t="output"){let e=this._previousTextureNodes[t];return void 0===e&&(void 0===this._textureNodes[t]&&this.getTextureNode(t),e=ir(new cg(this,t,!0)),e.updateTexture(),this._previousTextureNodes[t]=e),e}getViewZNode(t="depth"){let e=this._viewZNodes[t];if(void 0===e){const s=this._cameraNear,i=this._cameraFar;this._viewZNodes[t]=e=Uc(this.getTextureNode(t),s,i)}return e}getLinearDepthNode(t="depth"){let e=this._linearDepthNodes[t];if(void 0===e){const s=this._cameraNear,i=this._cameraFar,r=this.getViewZNode(t);this._linearDepthNodes[t]=e=Dc(r,s,i)}return e}setup({renderer:t}){return this.renderTarget.samples=void 0===this.options.samples?t.samples:this.options.samples,!0===t.backend.isWebGLBackend&&(this.renderTarget.samples=0),this.renderTarget.texture.type=t.getColorBufferType(),this.scope===dg.COLOR?this.getTextureNode():this.getLinearDepthNode()}updateBefore(t){const{renderer:e}=t,{scene:s}=this;let i,r;const n=e.getOutputRenderTarget();n&&!0===n.isXRRenderTarget?(r=1,i=e.xr.getCamera(),e.xr.updateCamera(i),lg.set(n.width,n.height)):(i=this.camera,r=e.getPixelRatio(),e.getSize(lg)),this._pixelRatio=r,this.setSize(lg.width,lg.height);const a=e.getRenderTarget(),o=e.getMRT(),h=i.layers.mask;this._cameraNear.value=i.near,this._cameraFar.value=i.far,null!==this._layers&&(i.layers.mask=this._layers.mask);for(const t in this._previousTextures)this.toggleTexture(t);e.setRenderTarget(this.renderTarget),e.setMRT(this._mrt),e.render(s,i),e.setRenderTarget(a),e.setMRT(o),i.layers.mask=h}setSize(t,e){this._width=t,this._height=e;const s=this._width*this._pixelRatio*this._resolution,i=this._height*this._pixelRatio*this._resolution;this.renderTarget.setSize(s,i)}setPixelRatio(t){this._pixelRatio=t,this.setSize(this._width,this._height)}dispose(){this.renderTarget.dispose()}}dg.COLOR="color",dg.DEPTH="depth";class pg extends dg{static get type(){return"ToonOutlinePassNode"}constructor(t,e,s,i,r){super(dg.COLOR,t,e),this.colorNode=s,this.thicknessNode=i,this.alphaNode=r,this._materialCache=new WeakMap}updateBefore(t){const{renderer:e}=t,s=e.getRenderObjectFunction();e.setRenderObjectFunction((t,s,i,r,n,a,o,h)=>{if((n.isMeshToonMaterial||n.isMeshToonNodeMaterial)&&!1===n.wireframe){const l=this._getOutlineMaterial(n);e.renderObject(t,s,i,r,l,a,o,h)}e.renderObject(t,s,i,r,n,a,o,h)}),super.updateBefore(t),e.setRenderObjectFunction(s)}_createMaterial(){const t=new Kc;t.isMeshToonOutlineMaterial=!0,t.name="Toon_Outline",t.side=1;const e=ol.negate(),s=Th.mul(Gh),i=mr(1),r=s.mul(Sr(Jh,1)),n=s.mul(Sr(Jh.add(e),1)),a=pa(r.sub(n));return t.vertexNode=r.add(a.mul(this.thicknessNode).mul(r.w).mul(i)),t.colorNode=Sr(this.colorNode,this.alphaNode),t}_getOutlineMaterial(t){let e=this._materialCache.get(t);return void 0===e&&(e=this._createMaterial(),this._materialCache.set(t,e)),e}}const mg=hr(([t,e])=>t.mul(e).clamp()).setLayout({name:"linearToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),gg=hr(([t,e])=>(t=t.mul(e)).div(t.add(1)).clamp()).setLayout({name:"reinhardToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),yg=hr(([t,e])=>{const s=(t=(t=t.mul(e)).sub(.004).max(0)).mul(t.mul(6.2).add(.5)),i=t.mul(t.mul(6.2).add(1.7)).add(.06);return s.div(i).pow(2.2)}).setLayout({name:"cineonToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),fg=hr(([t])=>{const e=t.mul(t.add(.0245786)).sub(90537e-9),s=t.mul(t.add(.432951).mul(.983729)).add(.238081);return e.div(s)}),xg=hr(([t,e])=>{const s=Ir(.59719,.35458,.04823,.076,.90834,.01566,.0284,.13383,.83777),i=Ir(1.60475,-.53108,-.07367,-.10208,1.10813,-.00605,-.00327,-.07276,1.07602);return t=t.mul(e).div(.6),t=s.mul(t),t=fg(t),(t=i.mul(t)).clamp()}).setLayout({name:"acesFilmicToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),bg=Ir(Nr(1.6605,-.1246,-.0182),Nr(-.5876,1.1329,-.1006),Nr(-.0728,-.0083,1.1187)),vg=Ir(Nr(.6274,.0691,.0164),Nr(.3293,.9195,.088),Nr(.0433,.0113,.8956)),wg=hr(([t])=>{const e=Nr(t).toVar(),s=Nr(e.mul(e)).toVar(),i=Nr(s.mul(s)).toVar();return mr(15.5).mul(i.mul(s)).sub(Cn(40.14,i.mul(e))).add(Cn(31.96,i).sub(Cn(6.868,s.mul(e))).add(Cn(.4298,s).add(Cn(.1191,e).sub(.00232))))}),Ng=hr(([t,e])=>{const s=Nr(t).toVar(),i=Ir(Nr(.856627153315983,.137318972929847,.11189821299995),Nr(.0951212405381588,.761241990602591,.0767994186031903),Nr(.0482516061458583,.101439036467562,.811302368396859)),r=Ir(Nr(1.1271005818144368,-.1413297634984383,-.14132976349843826),Nr(-.11060664309660323,1.157823702216272,-.11060664309660294),Nr(-.016493938717834573,-.016493938717834257,1.2519364065950405)),n=mr(-12.47393),a=mr(4.026069);return s.mulAssign(e),s.assign(vg.mul(s)),s.assign(i.mul(s)),s.assign(Ba(s,1e-10)),s.assign(ha(s)),s.assign(s.sub(n).div(a.sub(n))),s.assign(Ka(s,0,1)),s.assign(wg(s)),s.assign(r.mul(s)),s.assign(qa(Ba(Nr(0),s),Nr(2.2))),s.assign(bg.mul(s)),s.assign(Ka(s,0,1)),s}).setLayout({name:"agxToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),Tg=hr(([t,e])=>{const s=mr(.76),i=mr(.15);t=t.mul(e);const r=Fa(t.r,Fa(t.g,t.b)),n=uo(r.lessThan(.08),r.sub(Cn(6.25,r.mul(r))),.04);t.subAssign(n);const a=Ba(t.r,Ba(t.g,t.b));cr(a.lessThan(s),()=>t);const o=Vn(1,s),h=Vn(1,o.mul(o).div(a.add(o.sub(s))));t.mulAssign(h.div(a));const l=Vn(1,In(1,i.mul(a.sub(h)).add(1)));return Ja(t,Nr(h),l)}).setLayout({name:"neutralToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]});class Mg extends gi{static get type(){return"CodeNode"}constructor(t="",e=[],s=""){super("code"),this.isCodeNode=!0,this.code=t,this.includes=e,this.language=s}isGlobal(){return!0}setIncludes(t){return this.includes=t,this}getIncludes(){return this.includes}generate(t){const e=this.getIncludes(t);for(const s of e)s.build(t);const s=t.getCodeFromNode(this,this.getNodeType(t));return s.code=this.code,s.code}serialize(t){super.serialize(t),t.code=this.code,t.language=this.language}deserialize(t){super.deserialize(t),this.code=t.code,this.language=t.language}}const _g=ar(Mg);class Sg extends Mg{static get type(){return"FunctionNode"}constructor(t="",e=[],s=""){super(t,e,s)}getNodeType(t){return this.getNodeFunction(t).type}getInputs(t){return this.getNodeFunction(t).inputs}getNodeFunction(t){const e=t.getDataFromNode(this);let s=e.nodeFunction;return void 0===s&&(s=t.parser.parseFunction(this.code),e.nodeFunction=s),s}generate(t,e){super.generate(t);const s=this.getNodeFunction(t),i=s.name,r=s.type,n=t.getCodeFromNode(this,r);""!==i&&(n.name=i);const a=t.getPropertyName(n),o=this.getNodeFunction(t).getCode(a);return n.code=o+"\n","property"===e?a:t.format(`${a}()`,r,e)}}const Ag=(t,e=[],s="")=>{for(let t=0;t<e.length;t++){const s=e[t];"function"==typeof s&&(e[t]=s.functionNode)}const i=ir(new Sg(t,e,s)),r=(...t)=>i.call(...t);return r.functionNode=i,r};class zg extends gi{static get type(){return"ScriptableValueNode"}constructor(t=null){super(),this._value=t,this._cache=null,this.inputType=null,this.outputType=null,this.events=new A,this.isScriptableValueNode=!0}get isScriptableOutputNode(){return null!==this.outputType}set value(t){this._value!==t&&(this._cache&&"URL"===this.inputType&&this.value.value instanceof ArrayBuffer&&(URL.revokeObjectURL(this._cache),this._cache=null),this._value=t,this.events.dispatchEvent({type:"change"}),this.refresh())}get value(){return this._value}refresh(){this.events.dispatchEvent({type:"refresh"})}getValue(){const t=this.value;if(t&&null===this._cache&&"URL"===this.inputType&&t.value instanceof ArrayBuffer)this._cache=URL.createObjectURL(new Blob([t.value]));else if(t&&null!==t.value&&void 0!==t.value&&(("URL"===this.inputType||"String"===this.inputType)&&"string"==typeof t.value||"Number"===this.inputType&&"number"==typeof t.value||"Vector2"===this.inputType&&t.value.isVector2||"Vector3"===this.inputType&&t.value.isVector3||"Vector4"===this.inputType&&t.value.isVector4||"Color"===this.inputType&&t.value.isColor||"Matrix3"===this.inputType&&t.value.isMatrix3||"Matrix4"===this.inputType&&t.value.isMatrix4))return t.value;return this._cache||t}getNodeType(t){return this.value&&this.value.isNode?this.value.getNodeType(t):"float"}setup(){return this.value&&this.value.isNode?this.value:mr()}serialize(t){super.serialize(t),null!==this.value?"ArrayBuffer"===this.inputType?t.value=ai(this.value):t.value=this.value?this.value.toJSON(t.meta).uuid:null:t.value=null,t.inputType=this.inputType,t.outputType=this.outputType}deserialize(t){super.deserialize(t);let e=null;null!==t.value&&(e="ArrayBuffer"===t.inputType?oi(t.value):"Texture"===t.inputType?t.meta.textures[t.value]:t.meta.nodes[t.value]||null),this.value=e,this.inputType=t.inputType,this.outputType=t.outputType}}const Vg=ar(zg);class Cg extends Map{get(t,e=null,...s){if(this.has(t))return super.get(t);if(null!==e){const i=e(...s);return this.set(t,i),i}}}class Ig{constructor(t){this.scriptableNode=t}get parameters(){return this.scriptableNode.parameters}get layout(){return this.scriptableNode.getLayout()}getInputLayout(t){return this.scriptableNode.getInputLayout(t)}get(t){const e=this.parameters[t];return e?e.getValue():null}}const Rg=new Cg;class Eg extends gi{static get type(){return"ScriptableNode"}constructor(t=null,e={}){super(),this.codeNode=t,this.parameters=e,this._local=new Cg,this._output=Vg(),this._outputs={},this._source=this.source,this._method=null,this._object=null,this._value=null,this._needsOutputUpdate=!0,this.onRefresh=this.onRefresh.bind(this),this.isScriptableNode=!0}get source(){return this.codeNode?this.codeNode.code:""}setLocal(t,e){return this._local.set(t,e)}getLocal(t){return this._local.get(t)}onRefresh(){this._refresh()}getInputLayout(t){for(const e of this.getLayout())if(e.inputType&&(e.id===t||e.name===t))return e}getOutputLayout(t){for(const e of this.getLayout())if(e.outputType&&(e.id===t||e.name===t))return e}setOutput(t,e){const s=this._outputs;return void 0===s[t]?s[t]=Vg(e):s[t].value=e,this}getOutput(t){return this._outputs[t]}getParameter(t){return this.parameters[t]}setParameter(t,e){const s=this.parameters;return e&&e.isScriptableNode?(this.deleteParameter(t),s[t]=e,s[t].getDefaultOutput().events.addEventListener("refresh",this.onRefresh)):e&&e.isScriptableValueNode?(this.deleteParameter(t),s[t]=e,s[t].events.addEventListener("refresh",this.onRefresh)):void 0===s[t]?(s[t]=Vg(e),s[t].events.addEventListener("refresh",this.onRefresh)):s[t].value=e,this}getValue(){return this.getDefaultOutput().getValue()}deleteParameter(t){let e=this.parameters[t];return e&&(e.isScriptableNode&&(e=e.getDefaultOutput()),e.events.removeEventListener("refresh",this.onRefresh)),this}clearParameters(){for(const t of Object.keys(this.parameters))this.deleteParameter(t);return this.needsUpdate=!0,this}call(t,...e){const s=this.getObject()[t];if("function"==typeof s)return s(...e)}async callAsync(t,...e){const s=this.getObject()[t];if("function"==typeof s)return"AsyncFunction"===s.constructor.name?await s(...e):s(...e)}getNodeType(t){return this.getDefaultOutputNode().getNodeType(t)}refresh(t=null){null!==t?this.getOutput(t).refresh():this._refresh()}getObject(){if(this.needsUpdate&&this.dispose(),null!==this._object)return this._object;const t=new Ig(this),e=Rg.get("THREE"),s=Rg.get("TSL"),i=this.getMethod(),r=[t,this._local,Rg,()=>this.refresh(),(t,e)=>this.setOutput(t,e),e,s];this._object=i(...r);const n=this._object.layout;if(n&&(!1===n.cache&&this._local.clear(),this._output.outputType=n.outputType||null,Array.isArray(n.elements)))for(const t of n.elements){const e=t.id||t.name;t.inputType&&(void 0===this.getParameter(e)&&this.setParameter(e,null),this.getParameter(e).inputType=t.inputType),t.outputType&&(void 0===this.getOutput(e)&&this.setOutput(e,null),this.getOutput(e).outputType=t.outputType)}return this._object}deserialize(t){super.deserialize(t);for(const t in this.parameters){let e=this.parameters[t];e.isScriptableNode&&(e=e.getDefaultOutput()),e.events.addEventListener("refresh",this.onRefresh)}}getLayout(){return this.getObject().layout}getDefaultOutputNode(){const t=this.getDefaultOutput().value;return t&&t.isNode?t:mr()}getDefaultOutput(){return this._exec()._output}getMethod(){if(this.needsUpdate&&this.dispose(),null!==this._method)return this._method;const t=["layout","init","main","dispose"].join(", "),e="\nreturn { ...output, "+t+" };",s="var "+t+"; var output = {};\n"+this.codeNode.code+e;return this._method=new Function(...["parameters","local","global","refresh","setOutput","THREE","TSL"],s),this._method}dispose(){null!==this._method&&(this._object&&"function"==typeof this._object.dispose&&this._object.dispose(),this._method=null,this._object=null,this._source=null,this._value=null,this._needsOutputUpdate=!0,this._output.value=null,this._outputs={})}setup(){return this.getDefaultOutputNode()}getCacheKey(t){const e=[(s=this.source,Ys(s)),this.getDefaultOutputNode().getCacheKey(t)];var s;for(const s in this.parameters)e.push(this.parameters[s].getCacheKey(t));return $s(e)}set needsUpdate(t){!0===t&&this.dispose()}get needsUpdate(){return this.source!==this._source}_exec(){return null===this.codeNode||(!0===this._needsOutputUpdate&&(this._value=this.call("main"),this._needsOutputUpdate=!1),this._output.value=this._value),this}_refresh(){this.needsUpdate=!0,this._exec(),this._output.refresh()}}const Og=ar(Eg);function Fg(t){let e;const s=t.context.getViewZ;return void 0!==s&&(e=s(this)),(e||el.z).negate()}const Bg=hr(([t,e],s)=>{const i=Fg(s);return eo(t,e,i)}),Lg=hr(([t],e)=>{const s=Fg(e);return t.mul(t,s,s).negate().exp().oneMinus()}),Pg=hr(([t,e])=>Sr(e.toFloat().mix(pn.rgb,t.toVec3()),pn.a));let Dg=null,kg=null;class Ug extends gi{static get type(){return"RangeNode"}constructor(t=mr(),e=mr()){super(),this.minNode=t,this.maxNode=e}getVectorLength(t){const e=t.getTypeLength(ii(this.minNode.value)),s=t.getTypeLength(ii(this.maxNode.value));return e>s?e:s}getNodeType(t){return t.object.count>1?t.getTypeFromLength(this.getVectorLength(t)):"float"}setup(t){const e=t.object;let s=null;if(e.count>1){const i=this.minNode.value,r=this.maxNode.value,n=t.getTypeLength(ii(i)),a=t.getTypeLength(ii(r));Dg=Dg||new st,kg=kg||new st,Dg.setScalar(0),kg.setScalar(0),1===n?Dg.setScalar(i):i.isColor?Dg.set(i.r,i.g,i.b,1):Dg.set(i.x,i.y,i.z||0,i.w||0),1===a?kg.setScalar(r):r.isColor?kg.set(r.r,r.g,r.b,1):kg.set(r.x,r.y,r.z||0,r.w||0);const o=4,h=o*e.count,l=new Float32Array(h);for(let t=0;t<h;t++){const e=t%o,s=Dg.getComponent(e),i=kg.getComponent(e);l[t]=P.lerp(s,i,Math.random())}const u=this.getNodeType(t);if(e.count<=4096)s=yh(l,"vec4",e.count).element(Hu).convert(u);else{const e=new vs(l,4);t.geometry.setAttribute("__range"+this.id,e),s=jo(e).convert(u)}}else s=mr(0);return s}}const Wg=ar(Ug);class jg extends gi{static get type(){return"ComputeBuiltinNode"}constructor(t,e){super(e),this._builtinName=t}getHash(t){return this.getBuiltinName(t)}getNodeType(){return this.nodeType}setBuiltinName(t){return this._builtinName=t,this}getBuiltinName(){return this._builtinName}hasBuiltin(t){return t.hasBuiltin(this._builtinName)}generate(t,e){const s=this.getBuiltinName(t),i=this.getNodeType(t);return"compute"===t.shaderStage?t.format(s,i,e):t.generateConst(i)}serialize(t){super.serialize(t),t.global=this.global,t._builtinName=this._builtinName}deserialize(t){super.deserialize(t),this.global=t.global,this._builtinName=t._builtinName}}const qg=(t,e)=>ir(new jg(t,e)),Hg=qg("numWorkgroups","uvec3"),Gg=qg("workgroupId","uvec3"),Xg=qg("globalId","uvec3"),Yg=qg("localId","uvec3"),$g=qg("subgroupSize","uint");const Zg=ar(class extends gi{constructor(t){super(),this.scope=t}generate(t){const{scope:e}=this,{renderer:s}=t;!0===s.backend.isWebGLBackend?t.addFlowCode(`\t// ${e}Barrier \n`):t.addLineFlowCode(`${e}Barrier()`,this)}});class Jg extends yi{constructor(t,e){super(t,e),this.isWorkgroupInfoElementNode=!0}generate(t,e){let s;const i=t.context.assign;if(s=super.generate(t),!0!==i){const i=this.getNodeType(t);s=t.format(s,i,e)}return s}}class Kg extends gi{constructor(t,e,s=0){super(e),this.bufferType=e,this.bufferCount=s,this.isWorkgroupInfoNode=!0,this.elementType=e,this.scope=t}label(t){return this.name=t,this}setScope(t){return this.scope=t,this}getElementType(){return this.elementType}getInputType(){return`${this.scope}Array`}element(t){return ir(new Jg(this,t))}generate(t){return t.getScopedArray(this.name||`${this.scope}Array_${this.id}`,this.scope.toLowerCase(),this.bufferType,this.bufferCount)}}class Qg extends xi{static get type(){return"AtomicFunctionNode"}constructor(t,e,s,i=null){super("uint"),this.method=t,this.pointerNode=e,this.valueNode=s,this.storeNode=i}getInputType(t){return this.pointerNode.getNodeType(t)}getNodeType(t){return this.getInputType(t)}generate(t){const e=this.method,s=this.getNodeType(t),i=this.getInputType(t),r=this.pointerNode,n=this.valueNode,a=[];a.push(`&${r.build(t,i)}`),null!==n&&a.push(n.build(t,i));const o=`${t.getMethod(e,s)}( ${a.join(", ")} )`;if(null!==this.storeNode){const e=this.storeNode.build(t,i);t.addLineFlowCode(`${e} = ${o}`,this)}else t.addLineFlowCode(o,this)}}Qg.ATOMIC_LOAD="atomicLoad",Qg.ATOMIC_STORE="atomicStore",Qg.ATOMIC_ADD="atomicAdd",Qg.ATOMIC_SUB="atomicSub",Qg.ATOMIC_MAX="atomicMax",Qg.ATOMIC_MIN="atomicMin",Qg.ATOMIC_AND="atomicAnd",Qg.ATOMIC_OR="atomicOr",Qg.ATOMIC_XOR="atomicXor";const ty=ar(Qg),ey=(t,e,s,i=null)=>{const r=ty(t,e,s,i);return r.append(),r};let sy;function iy(t){sy=sy||new WeakMap;let e=sy.get(t);return void 0===e&&sy.set(t,e={}),e}function ry(t){const e=iy(t);return e.shadowMatrix||(e.shadowMatrix=qr("mat4").setGroup(Ur).onRenderUpdate(()=>(!0!==t.castShadow&&t.shadow.updateMatrices(t),t.shadow.matrix)))}function ny(t){const e=iy(t);return e.position||(e.position=qr(new at).setGroup(Ur).onRenderUpdate((e,s)=>s.value.setFromMatrixPosition(t.matrixWorld)))}function ay(t){const e=iy(t);return e.targetPosition||(e.targetPosition=qr(new at).setGroup(Ur).onRenderUpdate((e,s)=>s.value.setFromMatrixPosition(t.target.matrixWorld)))}const oy=(t,e)=>{for(const s of e)if(s.isAnalyticLightNode&&s.light.id===t)return s;return null},hy=new WeakMap;class ly extends gi{static get type(){return"LightsNode"}constructor(){super("vec3"),this.totalDiffuseNode=Nr().toVar("totalDiffuse"),this.totalSpecularNode=Nr().toVar("totalSpecular"),this.outgoingLightNode=Nr().toVar("outgoingLight"),this._lights=[],this._lightNodes=null,this._lightNodesHash=null,this.global=!0}customCacheKey(){const t=[],e=this._lights;for(let s=0;s<e.length;s++)t.push(e[s].id);return $s(t)}getHash(t){if(null===this._lightNodesHash){null===this._lightNodes&&this.setupLightsNode(t);const e=[];for(const t of this._lightNodes)e.push(t.getSelf().getHash());this._lightNodesHash="lights-"+e.join(",")}return this._lightNodesHash}analyze(t){const e=t.getDataFromNode(this);for(const s of e.nodes)s.build(t)}setupLightsNode(t){const e=[],s=this._lightNodes,i=(t=>t.sort((t,e)=>t.id-e.id))(this._lights),r=t.renderer.library;for(const t of i)if(t.isNode)e.push(ir(t));else{let i=null;if(null!==s&&(i=oy(t.id,s)),null===i){const s=r.getLightNodeClass(t.constructor);if(null===s)continue;let i=null;hy.has(t)?i=hy.get(t):(i=ir(new s(t)),hy.set(t,i)),e.push(i)}}this._lightNodes=e}setupDirectLight(t,e,s){const{lightingModel:i,reflectedLight:r}=t.context;i.direct({...s,lightNode:e,reflectedLight:r},t)}setupDirectRectAreaLight(t,e,s){const{lightingModel:i,reflectedLight:r}=t.context;i.directRectArea({...s,lightNode:e,reflectedLight:r},t)}setupLights(t,e){for(const s of e)s.build(t)}getLightNodes(t){return null===this._lightNodes&&this.setupLightsNode(t),this._lightNodes}setup(t){const e=t.lightsNode;t.lightsNode=this;let s=this.outgoingLightNode;const i=t.context,r=i.lightingModel,n=t.getDataFromNode(this);if(r){const{totalDiffuseNode:e,totalSpecularNode:a}=this;i.outgoingLight=s;const o=t.addStack();n.nodes=o.nodes,r.start(t);const{backdrop:h,backdropAlpha:l}=i,{directDiffuse:u,directSpecular:c,indirectDiffuse:d,indirectSpecular:p}=i.reflectedLight;let m=u.add(d);null!==h&&(m=Nr(null!==l?l.mix(m,h):h),i.material.transparent=!0),e.assign(m),a.assign(c.add(p)),s.assign(e.add(a)),r.finish(t),s=s.bypass(t.removeStack())}else n.nodes=[];return t.lightsNode=e,s}setLights(t){return this._lights=t,this._lightNodes=null,this._lightNodesHash=null,this}getLights(){return this._lights}get hasLights(){return this._lights.length>0}}class uy extends gi{static get type(){return"ShadowBaseNode"}constructor(t){super(),this.light=t,this.updateBeforeType=li.RENDER,this.isShadowBaseNode=!0}setupShadowPosition({context:t,material:e}){cy.assign(e.shadowPositionNode||t.shadowPositionWorld||Qh)}dispose(){this.updateBeforeType=li.NONE}}const cy=Gr("vec3","shadowPositionWorld");function dy(t,e={}){return e.toneMapping=t.toneMapping,e.toneMappingExposure=t.toneMappingExposure,e.outputColorSpace=t.outputColorSpace,e.renderTarget=t.getRenderTarget(),e.activeCubeFace=t.getActiveCubeFace(),e.activeMipmapLevel=t.getActiveMipmapLevel(),e.renderObjectFunction=t.getRenderObjectFunction(),e.pixelRatio=t.getPixelRatio(),e.mrt=t.getMRT(),e.clearColor=t.getClearColor(e.clearColor||new ze),e.clearAlpha=t.getClearAlpha(),e.autoClear=t.autoClear,e.scissorTest=t.getScissorTest(),e}function py(t,e){return e=dy(t,e),t.setMRT(null),t.setRenderObjectFunction(null),t.setClearColor(0,1),t.autoClear=!0,e}function my(t,e){t.toneMapping=e.toneMapping,t.toneMappingExposure=e.toneMappingExposure,t.outputColorSpace=e.outputColorSpace,t.setRenderTarget(e.renderTarget,e.activeCubeFace,e.activeMipmapLevel),t.setRenderObjectFunction(e.renderObjectFunction),t.setPixelRatio(e.pixelRatio),t.setMRT(e.mrt),t.setClearColor(e.clearColor,e.clearAlpha),t.autoClear=e.autoClear,t.setScissorTest(e.scissorTest)}function gy(t,e={}){return e.background=t.background,e.backgroundNode=t.backgroundNode,e.overrideMaterial=t.overrideMaterial,e}function yy(t,e){return e=gy(t,e),t.background=null,t.backgroundNode=null,t.overrideMaterial=null,e}function fy(t,e){t.background=e.background,t.backgroundNode=e.backgroundNode,t.overrideMaterial=e.overrideMaterial}function xy(t,e,s){return s=yy(e,s=py(t,s))}function by(t,e,s){my(t,s),fy(e,s)}var vy=Object.freeze({__proto__:null,resetRendererAndSceneState:xy,resetRendererState:py,resetSceneState:yy,restoreRendererAndSceneState:by,restoreRendererState:my,restoreSceneState:fy,saveRendererAndSceneState:function(t,e,s={}){return s=gy(e,s=dy(t,s))},saveRendererState:dy,saveSceneState:gy});const wy=new WeakMap,Ny=hr(([t,e,s])=>{let i=Qh.sub(t).length();return i=i.sub(e).div(s.sub(e)),i=i.saturate(),i}),Ty=t=>{let e=wy.get(t);if(void 0===e){const s=t.isPointLight?(t=>{const e=t.shadow.camera,s=Vl("near","float",e).setGroup(Ur),i=Vl("far","float",e).setGroup(Ur),r=Eh(t);return Ny(r,s,i)})(t):null;e=new Kc,e.colorNode=Sr(0,0,0,1),e.depthNode=s,e.isShadowPassMaterial=!0,e.name="ShadowMaterial",e.fog=!1,wy.set(t,e)}return e},My=hr(({depthTexture:t,shadowCoord:e})=>ph(t,e.xy).compare(e.z)),_y=hr(({depthTexture:t,shadowCoord:e,shadow:s})=>{const i=(e,s)=>ph(t,e).compare(s),r=Vl("mapSize","vec2",s).setGroup(Ur),n=Vl("radius","float",s).setGroup(Ur),a=xr(1).div(r),o=a.x.negate().mul(n),h=a.y.negate().mul(n),l=a.x.mul(n),u=a.y.mul(n),c=o.div(2),d=h.div(2),p=l.div(2),m=u.div(2);return zn(i(e.xy.add(xr(o,h)),e.z),i(e.xy.add(xr(0,h)),e.z),i(e.xy.add(xr(l,h)),e.z),i(e.xy.add(xr(c,d)),e.z),i(e.xy.add(xr(0,d)),e.z),i(e.xy.add(xr(p,d)),e.z),i(e.xy.add(xr(o,0)),e.z),i(e.xy.add(xr(c,0)),e.z),i(e.xy,e.z),i(e.xy.add(xr(p,0)),e.z),i(e.xy.add(xr(l,0)),e.z),i(e.xy.add(xr(c,m)),e.z),i(e.xy.add(xr(0,m)),e.z),i(e.xy.add(xr(p,m)),e.z),i(e.xy.add(xr(o,u)),e.z),i(e.xy.add(xr(0,u)),e.z),i(e.xy.add(xr(l,u)),e.z)).mul(1/17)}),Sy=hr(({depthTexture:t,shadowCoord:e,shadow:s})=>{const i=(e,s)=>ph(t,e).compare(s),r=Vl("mapSize","vec2",s).setGroup(Ur),n=xr(1).div(r),a=n.x,o=n.y,h=e.xy,l=ma(h.mul(r).add(.5));return h.subAssign(l.mul(n)),zn(i(h,e.z),i(h.add(xr(a,0)),e.z),i(h.add(xr(0,o)),e.z),i(h.add(n),e.z),Ja(i(h.add(xr(a.negate(),0)),e.z),i(h.add(xr(a.mul(2),0)),e.z),l.x),Ja(i(h.add(xr(a.negate(),o)),e.z),i(h.add(xr(a.mul(2),o)),e.z),l.x),Ja(i(h.add(xr(0,o.negate())),e.z),i(h.add(xr(0,o.mul(2))),e.z),l.y),Ja(i(h.add(xr(a,o.negate())),e.z),i(h.add(xr(a,o.mul(2))),e.z),l.y),Ja(Ja(i(h.add(xr(a.negate(),o.negate())),e.z),i(h.add(xr(a.mul(2),o.negate())),e.z),l.x),Ja(i(h.add(xr(a.negate(),o.mul(2))),e.z),i(h.add(xr(a.mul(2),o.mul(2))),e.z),l.x),l.y)).mul(1/9)}),Ay=hr(({depthTexture:t,shadowCoord:e})=>{const s=mr(1).toVar(),i=ph(t).sample(e.xy).rg,r=Pa(e.z,i.x);return cr(r.notEqual(mr(1)),()=>{const t=e.z.sub(i.x),n=Ba(0,i.y.mul(i.y));let a=n.div(n.add(t.mul(t)));a=Ka(Vn(a,.3).div(.95-.3)),s.assign(Ka(Ba(r,a)))}),s}),zy=hr(({samples:t,radius:e,size:s,shadowPass:i})=>{const r=mr(0).toVar(),n=mr(0).toVar(),a=t.lessThanEqual(mr(1)).select(mr(0),mr(2).div(t.sub(1))),o=t.lessThanEqual(mr(1)).select(mr(0),mr(-1));ac({start:gr(0),end:gr(t),type:"int",condition:"<"},({i:t})=>{const h=o.add(mr(t).mul(a)),l=i.sample(zn(Tc.xy,xr(0,h).mul(e)).div(s)).x;r.addAssign(l),n.addAssign(l.mul(l))}),r.divAssign(t),n.divAssign(t);const h=la(n.sub(r.mul(r)));return xr(r,h)}),Vy=hr(({samples:t,radius:e,size:s,shadowPass:i})=>{const r=mr(0).toVar(),n=mr(0).toVar(),a=t.lessThanEqual(mr(1)).select(mr(0),mr(2).div(t.sub(1))),o=t.lessThanEqual(mr(1)).select(mr(0),mr(-1));ac({start:gr(0),end:gr(t),type:"int",condition:"<"},({i:t})=>{const h=o.add(mr(t).mul(a)),l=i.sample(zn(Tc.xy,xr(h,0).mul(e)).div(s));r.addAssign(l.x),n.addAssign(zn(l.y.mul(l.y),l.x.mul(l.x)))}),r.divAssign(t),n.divAssign(t);const h=la(n.sub(r.mul(r)));return xr(r,h)}),Cy=[My,_y,Sy,Ay];let Iy;const Ry=new fm;class Ey extends uy{static get type(){return"ShadowNode"}constructor(t,e=null){super(t),this.shadow=e||t.shadow,this.shadowMap=null,this.vsmShadowMapVertical=null,this.vsmShadowMapHorizontal=null,this.vsmMaterialVertical=null,this.vsmMaterialHorizontal=null,this._node=null,this._cameraFrameId=new WeakMap,this.isShadowNode=!0}setupShadowFilter(t,{filterFn:e,depthTexture:s,shadowCoord:i,shadow:r}){const n=i.x.greaterThanEqual(0).and(i.x.lessThanEqual(1)).and(i.y.greaterThanEqual(0)).and(i.y.lessThanEqual(1)).and(i.z.lessThanEqual(1)),a=e({depthTexture:s,shadowCoord:i,shadow:r});return n.select(a,mr(1))}setupShadowCoord(t,e){const{shadow:s}=this,{renderer:i}=t,r=Vl("bias","float",s).setGroup(Ur);let n,a=e;if(s.camera.isOrthographicCamera||!0!==i.logarithmicDepthBuffer)a=a.xyz.div(a.w),n=a.z,i.coordinateSystem===S&&(n=n.mul(2).sub(1));else{const t=a.w;a=a.xy.div(t);const e=Vl("near","float",s.camera).setGroup(Ur),i=Vl("far","float",s.camera).setGroup(Ur);n=Wc(t.negate(),e,i)}return a=Nr(a.x,a.y.oneMinus(),n.add(r)),a}getShadowFilterFn(t){return Cy[t]}setupShadow(t){const{renderer:e}=t,{light:s,shadow:i}=this,r=e.shadowMap.type,n=new Ss(i.mapSize.width,i.mapSize.height);n.compareFunction=513;const a=t.createRenderTarget(i.mapSize.width,i.mapSize.height);if(a.depthTexture=n,i.camera.updateProjectionMatrix(),3===r){n.compareFunction=null,this.vsmShadowMapVertical=t.createRenderTarget(i.mapSize.width,i.mapSize.height,{format:1030,type:c}),this.vsmShadowMapHorizontal=t.createRenderTarget(i.mapSize.width,i.mapSize.height,{format:1030,type:c});const e=ph(n),s=ph(this.vsmShadowMapVertical.texture),r=Vl("blurSamples","float",i).setGroup(Ur),a=Vl("radius","float",i).setGroup(Ur),o=Vl("mapSize","vec2",i).setGroup(Ur);let h=this.vsmMaterialVertical||(this.vsmMaterialVertical=new Kc);h.fragmentNode=zy({samples:r,radius:a,size:o,shadowPass:e}).context(t.getSharedContext()),h.name="VSMVertical",h=this.vsmMaterialHorizontal||(this.vsmMaterialHorizontal=new Kc),h.fragmentNode=Vy({samples:r,radius:a,size:o,shadowPass:s}).context(t.getSharedContext()),h.name="VSMHorizontal"}const o=Vl("intensity","float",i).setGroup(Ur),h=Vl("normalBias","float",i).setGroup(Ur),l=ry(s).mul(cy.add(dl.mul(h))),u=this.setupShadowCoord(t,l),d=i.filterNode||this.getShadowFilterFn(e.shadowMap.type)||null;if(null===d)throw new Error("THREE.WebGPURenderer: Shadow map type not supported yet.");const p=3===r?this.vsmShadowMapHorizontal.texture:n,m=this.setupShadowFilter(t,{filterFn:d,shadowTexture:a.texture,depthTexture:p,shadowCoord:u,shadow:i}),g=ph(a.texture,u),y=Ja(1,m.rgb.mix(g,1),o.mul(g.a)).toVar();return this.shadowMap=a,this.shadow.map=a,y}setup(t){if(!1!==t.renderer.shadowMap.enabled)return hr(()=>{let e=this._node;return this.setupShadowPosition(t),null===e&&(this._node=e=this.setupShadow(t)),t.material.shadowNode,t.material.receivedShadowNode&&(e=t.material.receivedShadowNode(e)),e})()}renderShadow(t){const{shadow:e,shadowMap:s,light:i}=this,{renderer:r,scene:n}=t;e.updateMatrices(i),s.setSize(e.mapSize.width,e.mapSize.height),r.render(n,e.camera)}updateShadow(t){const{shadowMap:e,light:s,shadow:i}=this,{renderer:r,scene:n,camera:a}=t,o=r.shadowMap.type,h=e.depthTexture.version;this._depthVersionCached=h,i.camera.layers.mask=a.layers.mask;const l=r.getRenderObjectFunction(),u=r.getMRT(),c=!!u&&u.has("velocity");Iy=xy(r,n,Iy),n.overrideMaterial=Ty(s),r.setRenderObjectFunction((t,e,s,n,h,l,...u)=>{(!0===t.castShadow||t.receiveShadow&&3===o)&&(c&&(ni(t).useVelocity=!0),t.onBeforeShadow(r,t,a,i.camera,n,e.overrideMaterial,l),r.renderObject(t,e,s,n,h,l,...u),t.onAfterShadow(r,t,a,i.camera,n,e.overrideMaterial,l))}),r.setRenderTarget(e),this.renderShadow(t),r.setRenderObjectFunction(l),!0!==s.isPointLight&&3===o&&this.vsmPass(r),by(r,n,Iy)}vsmPass(t){const{shadow:e}=this;this.vsmShadowMapVertical.setSize(e.mapSize.width,e.mapSize.height),this.vsmShadowMapHorizontal.setSize(e.mapSize.width,e.mapSize.height),t.setRenderTarget(this.vsmShadowMapVertical),Ry.material=this.vsmMaterialVertical,Ry.render(t),t.setRenderTarget(this.vsmShadowMapHorizontal),Ry.material=this.vsmMaterialHorizontal,Ry.render(t)}dispose(){this.shadowMap.dispose(),this.shadowMap=null,null!==this.vsmShadowMapVertical&&(this.vsmShadowMapVertical.dispose(),this.vsmShadowMapVertical=null,this.vsmMaterialVertical.dispose(),this.vsmMaterialVertical=null),null!==this.vsmShadowMapHorizontal&&(this.vsmShadowMapHorizontal.dispose(),this.vsmShadowMapHorizontal=null,this.vsmMaterialHorizontal.dispose(),this.vsmMaterialHorizontal=null),super.dispose()}updateBefore(t){const{shadow:e}=this;let s=e.needsUpdate||e.autoUpdate;s&&(this._cameraFrameId[t.camera]===t.frameId&&(s=!1),this._cameraFrameId[t.camera]=t.frameId),s&&(this.updateShadow(t),this.shadowMap.depthTexture.version===this._depthVersionCached&&(e.needsUpdate=!1))}}const Oy=new ze,Fy=hr(([t,e])=>{const s=t.toVar(),i=wa(s),r=In(1,Ba(i.x,Ba(i.y,i.z)));i.mulAssign(r),s.mulAssign(r.mul(e.mul(2).oneMinus()));const n=xr(s.xy).toVar(),a=e.mul(1.5).oneMinus();return cr(i.z.greaterThanEqual(a),()=>{cr(s.z.greaterThan(0),()=>{n.x.assign(Vn(4,s.x))})}).ElseIf(i.x.greaterThanEqual(a),()=>{const t=Na(s.x);n.x.assign(s.z.mul(t).add(t.mul(2)))}).ElseIf(i.y.greaterThanEqual(a),()=>{const t=Na(s.y);n.x.assign(s.x.add(t.mul(2)).add(2)),n.y.assign(s.z.mul(t).sub(2))}),xr(.125,.25).mul(n).add(xr(.375,.75)).flipY()}).setLayout({name:"cubeToUV",type:"vec2",inputs:[{name:"pos",type:"vec3"},{name:"texelSizeY",type:"float"}]}),By=hr(({depthTexture:t,bd3D:e,dp:s,texelSize:i})=>ph(t,Fy(e,i.y)).compare(s)),Ly=hr(({depthTexture:t,bd3D:e,dp:s,texelSize:i,shadow:r})=>{const n=Vl("radius","float",r).setGroup(Ur),a=xr(-1,1).mul(n).mul(i.y);return ph(t,Fy(e.add(a.xyy),i.y)).compare(s).add(ph(t,Fy(e.add(a.yyy),i.y)).compare(s)).add(ph(t,Fy(e.add(a.xyx),i.y)).compare(s)).add(ph(t,Fy(e.add(a.yyx),i.y)).compare(s)).add(ph(t,Fy(e,i.y)).compare(s)).add(ph(t,Fy(e.add(a.xxy),i.y)).compare(s)).add(ph(t,Fy(e.add(a.yxy),i.y)).compare(s)).add(ph(t,Fy(e.add(a.xxx),i.y)).compare(s)).add(ph(t,Fy(e.add(a.yxx),i.y)).compare(s)).mul(1/9)}),Py=hr(({filterFn:t,depthTexture:e,shadowCoord:s,shadow:i})=>{const r=s.xyz.toVar(),n=r.length(),a=qr("float").setGroup(Ur).onRenderUpdate(()=>i.camera.near),o=qr("float").setGroup(Ur).onRenderUpdate(()=>i.camera.far),h=Vl("bias","float",i).setGroup(Ur),l=qr(i.mapSize).setGroup(Ur),u=mr(1).toVar();return cr(n.sub(o).lessThanEqual(0).and(n.sub(a).greaterThanEqual(0)),()=>{const s=n.sub(a).div(o.sub(a)).toVar();s.addAssign(h);const c=r.normalize(),d=xr(1).div(l.mul(xr(4,2)));u.assign(t({depthTexture:e,bd3D:c,dp:s,texelSize:d,shadow:i}))}),u}),Dy=new st,ky=new D,Uy=new D;class Wy extends Ey{static get type(){return"PointShadowNode"}constructor(t,e=null){super(t,e)}getShadowFilterFn(t){return 0===t?By:Ly}setupShadowCoord(t,e){return e}setupShadowFilter(t,{filterFn:e,shadowTexture:s,depthTexture:i,shadowCoord:r,shadow:n}){return Py({filterFn:e,shadowTexture:s,depthTexture:i,shadowCoord:r,shadow:n})}renderShadow(t){const{shadow:e,shadowMap:s,light:i}=this,{renderer:r,scene:n}=t,a=e.getFrameExtents();Uy.copy(e.mapSize),Uy.multiply(a),s.setSize(Uy.width,Uy.height),ky.copy(e.mapSize);const o=r.autoClear,h=r.getClearColor(Oy),l=r.getClearAlpha();r.autoClear=!1,r.setClearColor(e.clearColor,e.clearAlpha),r.clear();const u=e.getViewportCount();for(let t=0;t<u;t++){const a=e.getViewport(t),o=ky.x*a.x,h=Uy.y-ky.y-ky.y*a.y;Dy.set(o,h,ky.x*a.z,ky.y*a.w),s.viewport.copy(Dy),e.updateMatrices(i,t),r.render(n,e.camera)}r.autoClear=o,r.setClearColor(h,l)}}const jy=hr(({lightDistance:t,cutoffDistance:e,decayExponent:s})=>{const i=t.pow(s).max(.01).reciprocal();return e.greaterThan(0).select(i.mul(t.div(e).pow4().oneMinus().clamp().pow2()),i)}),qy=hr(([t=oh()])=>{const e=t.mul(2),s=e.x.floor(),i=e.y.floor();return s.add(i).mod(2).sign()}),Hy=hr(([t=oh()],{renderer:e,material:s})=>{const i=mr(1).toVar(),r=Za(t.mul(2).sub(1));if(s.alphaToCoverage&&e.samples>1){const t=mr(r.fwidth()).toVar();i.assign(eo(t.oneMinus(),t.add(1),r).oneMinus())}else r.greaterThan(1).discard();return i}),Gy=hr(([t,e,s])=>{const i=mr(s).toVar(),r=mr(e).toVar(),n=fr(t).toVar();return uo(n,r,i)}).setLayout({name:"mx_select",type:"float",inputs:[{name:"b",type:"bool"},{name:"t",type:"float"},{name:"f",type:"float"}]}),Xy=hr(([t,e])=>{const s=fr(e).toVar(),i=mr(t).toVar();return uo(s,i.negate(),i)}).setLayout({name:"mx_negate_if",type:"float",inputs:[{name:"val",type:"float"},{name:"b",type:"bool"}]}),Yy=hr(([t])=>{const e=mr(t).toVar();return gr(ca(e))}).setLayout({name:"mx_floor",type:"int",inputs:[{name:"x",type:"float"}]}),$y=hr(([t,e])=>{const s=mr(t).toVar();return e.assign(Yy(s)),s.sub(mr(e))}),Zy=kp([hr(([t,e,s,i,r,n])=>{const a=mr(n).toVar(),o=mr(r).toVar(),h=mr(i).toVar(),l=mr(s).toVar(),u=mr(e).toVar(),c=mr(t).toVar(),d=mr(Vn(1,o)).toVar();return Vn(1,a).mul(c.mul(d).add(u.mul(o))).add(a.mul(l.mul(d).add(h.mul(o))))}).setLayout({name:"mx_bilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"}]}),hr(([t,e,s,i,r,n])=>{const a=mr(n).toVar(),o=mr(r).toVar(),h=Nr(i).toVar(),l=Nr(s).toVar(),u=Nr(e).toVar(),c=Nr(t).toVar(),d=mr(Vn(1,o)).toVar();return Vn(1,a).mul(c.mul(d).add(u.mul(o))).add(a.mul(l.mul(d).add(h.mul(o))))}).setLayout({name:"mx_bilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"}]})]),Jy=kp([hr(([t,e,s,i,r,n,a,o,h,l,u])=>{const c=mr(u).toVar(),d=mr(l).toVar(),p=mr(h).toVar(),m=mr(o).toVar(),g=mr(a).toVar(),y=mr(n).toVar(),f=mr(r).toVar(),x=mr(i).toVar(),b=mr(s).toVar(),v=mr(e).toVar(),w=mr(t).toVar(),N=mr(Vn(1,p)).toVar(),T=mr(Vn(1,d)).toVar();return mr(Vn(1,c)).toVar().mul(T.mul(w.mul(N).add(v.mul(p))).add(d.mul(b.mul(N).add(x.mul(p))))).add(c.mul(T.mul(f.mul(N).add(y.mul(p))).add(d.mul(g.mul(N).add(m.mul(p))))))}).setLayout({name:"mx_trilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"v4",type:"float"},{name:"v5",type:"float"},{name:"v6",type:"float"},{name:"v7",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]}),hr(([t,e,s,i,r,n,a,o,h,l,u])=>{const c=mr(u).toVar(),d=mr(l).toVar(),p=mr(h).toVar(),m=Nr(o).toVar(),g=Nr(a).toVar(),y=Nr(n).toVar(),f=Nr(r).toVar(),x=Nr(i).toVar(),b=Nr(s).toVar(),v=Nr(e).toVar(),w=Nr(t).toVar(),N=mr(Vn(1,p)).toVar(),T=mr(Vn(1,d)).toVar();return mr(Vn(1,c)).toVar().mul(T.mul(w.mul(N).add(v.mul(p))).add(d.mul(b.mul(N).add(x.mul(p))))).add(c.mul(T.mul(f.mul(N).add(y.mul(p))).add(d.mul(g.mul(N).add(m.mul(p))))))}).setLayout({name:"mx_trilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"v4",type:"vec3"},{name:"v5",type:"vec3"},{name:"v6",type:"vec3"},{name:"v7",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]})]),Ky=hr(([t,e,s])=>{const i=mr(s).toVar(),r=mr(e).toVar(),n=yr(t).toVar(),a=yr(n.bitAnd(yr(7))).toVar(),o=mr(Gy(a.lessThan(yr(4)),r,i)).toVar(),h=mr(Cn(2,Gy(a.lessThan(yr(4)),i,r))).toVar();return Xy(o,fr(a.bitAnd(yr(1)))).add(Xy(h,fr(a.bitAnd(yr(2)))))}).setLayout({name:"mx_gradient_float_0",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"}]}),Qy=hr(([t,e,s,i])=>{const r=mr(i).toVar(),n=mr(s).toVar(),a=mr(e).toVar(),o=yr(t).toVar(),h=yr(o.bitAnd(yr(15))).toVar(),l=mr(Gy(h.lessThan(yr(8)),a,n)).toVar(),u=mr(Gy(h.lessThan(yr(4)),n,Gy(h.equal(yr(12)).or(h.equal(yr(14))),a,r))).toVar();return Xy(l,fr(h.bitAnd(yr(1)))).add(Xy(u,fr(h.bitAnd(yr(2)))))}).setLayout({name:"mx_gradient_float_1",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]}),tf=kp([Ky,Qy]),ef=hr(([t,e,s])=>{const i=mr(s).toVar(),r=mr(e).toVar(),n=Mr(t).toVar();return Nr(tf(n.x,r,i),tf(n.y,r,i),tf(n.z,r,i))}).setLayout({name:"mx_gradient_vec3_0",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"}]}),sf=hr(([t,e,s,i])=>{const r=mr(i).toVar(),n=mr(s).toVar(),a=mr(e).toVar(),o=Mr(t).toVar();return Nr(tf(o.x,a,n,r),tf(o.y,a,n,r),tf(o.z,a,n,r))}).setLayout({name:"mx_gradient_vec3_1",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]}),rf=kp([ef,sf]),nf=hr(([t])=>{const e=mr(t).toVar();return Cn(.6616,e)}).setLayout({name:"mx_gradient_scale2d_0",type:"float",inputs:[{name:"v",type:"float"}]}),af=hr(([t])=>{const e=mr(t).toVar();return Cn(.982,e)}).setLayout({name:"mx_gradient_scale3d_0",type:"float",inputs:[{name:"v",type:"float"}]}),of=kp([nf,hr(([t])=>{const e=Nr(t).toVar();return Cn(.6616,e)}).setLayout({name:"mx_gradient_scale2d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]})]),hf=kp([af,hr(([t])=>{const e=Nr(t).toVar();return Cn(.982,e)}).setLayout({name:"mx_gradient_scale3d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]})]),lf=hr(([t,e])=>{const s=gr(e).toVar(),i=yr(t).toVar();return i.shiftLeft(s).bitOr(i.shiftRight(gr(32).sub(s)))}).setLayout({name:"mx_rotl32",type:"uint",inputs:[{name:"x",type:"uint"},{name:"k",type:"int"}]}),uf=hr(([t,e,s])=>{t.subAssign(s),t.bitXorAssign(lf(s,gr(4))),s.addAssign(e),e.subAssign(t),e.bitXorAssign(lf(t,gr(6))),t.addAssign(s),s.subAssign(e),s.bitXorAssign(lf(e,gr(8))),e.addAssign(t),t.subAssign(s),t.bitXorAssign(lf(s,gr(16))),s.addAssign(e),e.subAssign(t),e.bitXorAssign(lf(t,gr(19))),t.addAssign(s),s.subAssign(e),s.bitXorAssign(lf(e,gr(4))),e.addAssign(t)}),cf=hr(([t,e,s])=>{const i=yr(s).toVar(),r=yr(e).toVar(),n=yr(t).toVar();return i.bitXorAssign(r),i.subAssign(lf(r,gr(14))),n.bitXorAssign(i),n.subAssign(lf(i,gr(11))),r.bitXorAssign(n),r.subAssign(lf(n,gr(25))),i.bitXorAssign(r),i.subAssign(lf(r,gr(16))),n.bitXorAssign(i),n.subAssign(lf(i,gr(4))),r.bitXorAssign(n),r.subAssign(lf(n,gr(14))),i.bitXorAssign(r),i.subAssign(lf(r,gr(24))),i}).setLayout({name:"mx_bjfinal",type:"uint",inputs:[{name:"a",type:"uint"},{name:"b",type:"uint"},{name:"c",type:"uint"}]}),df=hr(([t])=>{const e=yr(t).toVar();return mr(e).div(mr(yr(gr(4294967295))))}).setLayout({name:"mx_bits_to_01",type:"float",inputs:[{name:"bits",type:"uint"}]}),pf=hr(([t])=>{const e=mr(t).toVar();return e.mul(e).mul(e).mul(e.mul(e.mul(6).sub(15)).add(10))}).setLayout({name:"mx_fade",type:"float",inputs:[{name:"t",type:"float"}]}),mf=kp([hr(([t])=>{const e=gr(t).toVar(),s=yr(yr(1)).toVar(),i=yr(yr(gr(3735928559)).add(s.shiftLeft(yr(2))).add(yr(13))).toVar();return cf(i.add(yr(e)),i,i)}).setLayout({name:"mx_hash_int_0",type:"uint",inputs:[{name:"x",type:"int"}]}),hr(([t,e])=>{const s=gr(e).toVar(),i=gr(t).toVar(),r=yr(yr(2)).toVar(),n=yr().toVar(),a=yr().toVar(),o=yr().toVar();return n.assign(a.assign(o.assign(yr(gr(3735928559)).add(r.shiftLeft(yr(2))).add(yr(13))))),n.addAssign(yr(i)),a.addAssign(yr(s)),cf(n,a,o)}).setLayout({name:"mx_hash_int_1",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),hr(([t,e,s])=>{const i=gr(s).toVar(),r=gr(e).toVar(),n=gr(t).toVar(),a=yr(yr(3)).toVar(),o=yr().toVar(),h=yr().toVar(),l=yr().toVar();return o.assign(h.assign(l.assign(yr(gr(3735928559)).add(a.shiftLeft(yr(2))).add(yr(13))))),o.addAssign(yr(n)),h.addAssign(yr(r)),l.addAssign(yr(i)),cf(o,h,l)}).setLayout({name:"mx_hash_int_2",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]}),hr(([t,e,s,i])=>{const r=gr(i).toVar(),n=gr(s).toVar(),a=gr(e).toVar(),o=gr(t).toVar(),h=yr(yr(4)).toVar(),l=yr().toVar(),u=yr().toVar(),c=yr().toVar();return l.assign(u.assign(c.assign(yr(gr(3735928559)).add(h.shiftLeft(yr(2))).add(yr(13))))),l.addAssign(yr(o)),u.addAssign(yr(a)),c.addAssign(yr(n)),uf(l,u,c),l.addAssign(yr(r)),cf(l,u,c)}).setLayout({name:"mx_hash_int_3",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"}]}),hr(([t,e,s,i,r])=>{const n=gr(r).toVar(),a=gr(i).toVar(),o=gr(s).toVar(),h=gr(e).toVar(),l=gr(t).toVar(),u=yr(yr(5)).toVar(),c=yr().toVar(),d=yr().toVar(),p=yr().toVar();return c.assign(d.assign(p.assign(yr(gr(3735928559)).add(u.shiftLeft(yr(2))).add(yr(13))))),c.addAssign(yr(l)),d.addAssign(yr(h)),p.addAssign(yr(o)),uf(c,d,p),c.addAssign(yr(a)),d.addAssign(yr(n)),cf(c,d,p)}).setLayout({name:"mx_hash_int_4",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"},{name:"yy",type:"int"}]})]),gf=kp([hr(([t,e])=>{const s=gr(e).toVar(),i=gr(t).toVar(),r=yr(mf(i,s)).toVar(),n=Mr().toVar();return n.x.assign(r.bitAnd(gr(255))),n.y.assign(r.shiftRight(gr(8)).bitAnd(gr(255))),n.z.assign(r.shiftRight(gr(16)).bitAnd(gr(255))),n}).setLayout({name:"mx_hash_vec3_0",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),hr(([t,e,s])=>{const i=gr(s).toVar(),r=gr(e).toVar(),n=gr(t).toVar(),a=yr(mf(n,r,i)).toVar(),o=Mr().toVar();return o.x.assign(a.bitAnd(gr(255))),o.y.assign(a.shiftRight(gr(8)).bitAnd(gr(255))),o.z.assign(a.shiftRight(gr(16)).bitAnd(gr(255))),o}).setLayout({name:"mx_hash_vec3_1",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]})]),yf=kp([hr(([t])=>{const e=xr(t).toVar(),s=gr().toVar(),i=gr().toVar(),r=mr($y(e.x,s)).toVar(),n=mr($y(e.y,i)).toVar(),a=mr(pf(r)).toVar(),o=mr(pf(n)).toVar(),h=mr(Zy(tf(mf(s,i),r,n),tf(mf(s.add(gr(1)),i),r.sub(1),n),tf(mf(s,i.add(gr(1))),r,n.sub(1)),tf(mf(s.add(gr(1)),i.add(gr(1))),r.sub(1),n.sub(1)),a,o)).toVar();return of(h)}).setLayout({name:"mx_perlin_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"}]}),hr(([t])=>{const e=Nr(t).toVar(),s=gr().toVar(),i=gr().toVar(),r=gr().toVar(),n=mr($y(e.x,s)).toVar(),a=mr($y(e.y,i)).toVar(),o=mr($y(e.z,r)).toVar(),h=mr(pf(n)).toVar(),l=mr(pf(a)).toVar(),u=mr(pf(o)).toVar(),c=mr(Jy(tf(mf(s,i,r),n,a,o),tf(mf(s.add(gr(1)),i,r),n.sub(1),a,o),tf(mf(s,i.add(gr(1)),r),n,a.sub(1),o),tf(mf(s.add(gr(1)),i.add(gr(1)),r),n.sub(1),a.sub(1),o),tf(mf(s,i,r.add(gr(1))),n,a,o.sub(1)),tf(mf(s.add(gr(1)),i,r.add(gr(1))),n.sub(1),a,o.sub(1)),tf(mf(s,i.add(gr(1)),r.add(gr(1))),n,a.sub(1),o.sub(1)),tf(mf(s.add(gr(1)),i.add(gr(1)),r.add(gr(1))),n.sub(1),a.sub(1),o.sub(1)),h,l,u)).toVar();return hf(c)}).setLayout({name:"mx_perlin_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"}]})]),ff=kp([hr(([t])=>{const e=xr(t).toVar(),s=gr().toVar(),i=gr().toVar(),r=mr($y(e.x,s)).toVar(),n=mr($y(e.y,i)).toVar(),a=mr(pf(r)).toVar(),o=mr(pf(n)).toVar(),h=Nr(Zy(rf(gf(s,i),r,n),rf(gf(s.add(gr(1)),i),r.sub(1),n),rf(gf(s,i.add(gr(1))),r,n.sub(1)),rf(gf(s.add(gr(1)),i.add(gr(1))),r.sub(1),n.sub(1)),a,o)).toVar();return of(h)}).setLayout({name:"mx_perlin_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"}]}),hr(([t])=>{const e=Nr(t).toVar(),s=gr().toVar(),i=gr().toVar(),r=gr().toVar(),n=mr($y(e.x,s)).toVar(),a=mr($y(e.y,i)).toVar(),o=mr($y(e.z,r)).toVar(),h=mr(pf(n)).toVar(),l=mr(pf(a)).toVar(),u=mr(pf(o)).toVar(),c=Nr(Jy(rf(gf(s,i,r),n,a,o),rf(gf(s.add(gr(1)),i,r),n.sub(1),a,o),rf(gf(s,i.add(gr(1)),r),n,a.sub(1),o),rf(gf(s.add(gr(1)),i.add(gr(1)),r),n.sub(1),a.sub(1),o),rf(gf(s,i,r.add(gr(1))),n,a,o.sub(1)),rf(gf(s.add(gr(1)),i,r.add(gr(1))),n.sub(1),a,o.sub(1)),rf(gf(s,i.add(gr(1)),r.add(gr(1))),n,a.sub(1),o.sub(1)),rf(gf(s.add(gr(1)),i.add(gr(1)),r.add(gr(1))),n.sub(1),a.sub(1),o.sub(1)),h,l,u)).toVar();return hf(c)}).setLayout({name:"mx_perlin_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"}]})]),xf=kp([hr(([t])=>{const e=mr(t).toVar(),s=gr(Yy(e)).toVar();return df(mf(s))}).setLayout({name:"mx_cell_noise_float_0",type:"float",inputs:[{name:"p",type:"float"}]}),hr(([t])=>{const e=xr(t).toVar(),s=gr(Yy(e.x)).toVar(),i=gr(Yy(e.y)).toVar();return df(mf(s,i))}).setLayout({name:"mx_cell_noise_float_1",type:"float",inputs:[{name:"p",type:"vec2"}]}),hr(([t])=>{const e=Nr(t).toVar(),s=gr(Yy(e.x)).toVar(),i=gr(Yy(e.y)).toVar(),r=gr(Yy(e.z)).toVar();return df(mf(s,i,r))}).setLayout({name:"mx_cell_noise_float_2",type:"float",inputs:[{name:"p",type:"vec3"}]}),hr(([t])=>{const e=Sr(t).toVar(),s=gr(Yy(e.x)).toVar(),i=gr(Yy(e.y)).toVar(),r=gr(Yy(e.z)).toVar(),n=gr(Yy(e.w)).toVar();return df(mf(s,i,r,n))}).setLayout({name:"mx_cell_noise_float_3",type:"float",inputs:[{name:"p",type:"vec4"}]})]),bf=kp([hr(([t])=>{const e=mr(t).toVar(),s=gr(Yy(e)).toVar();return Nr(df(mf(s,gr(0))),df(mf(s,gr(1))),df(mf(s,gr(2))))}).setLayout({name:"mx_cell_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"float"}]}),hr(([t])=>{const e=xr(t).toVar(),s=gr(Yy(e.x)).toVar(),i=gr(Yy(e.y)).toVar();return Nr(df(mf(s,i,gr(0))),df(mf(s,i,gr(1))),df(mf(s,i,gr(2))))}).setLayout({name:"mx_cell_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec2"}]}),hr(([t])=>{const e=Nr(t).toVar(),s=gr(Yy(e.x)).toVar(),i=gr(Yy(e.y)).toVar(),r=gr(Yy(e.z)).toVar();return Nr(df(mf(s,i,r,gr(0))),df(mf(s,i,r,gr(1))),df(mf(s,i,r,gr(2))))}).setLayout({name:"mx_cell_noise_vec3_2",type:"vec3",inputs:[{name:"p",type:"vec3"}]}),hr(([t])=>{const e=Sr(t).toVar(),s=gr(Yy(e.x)).toVar(),i=gr(Yy(e.y)).toVar(),r=gr(Yy(e.z)).toVar(),n=gr(Yy(e.w)).toVar();return Nr(df(mf(s,i,r,n,gr(0))),df(mf(s,i,r,n,gr(1))),df(mf(s,i,r,n,gr(2))))}).setLayout({name:"mx_cell_noise_vec3_3",type:"vec3",inputs:[{name:"p",type:"vec4"}]})]),vf=hr(([t,e,s,i])=>{const r=mr(i).toVar(),n=mr(s).toVar(),a=gr(e).toVar(),o=Nr(t).toVar(),h=mr(0).toVar(),l=mr(1).toVar();return ac(a,()=>{h.addAssign(l.mul(yf(o))),l.mulAssign(r),o.mulAssign(n)}),h}).setLayout({name:"mx_fractal_noise_float",type:"float",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),wf=hr(([t,e,s,i])=>{const r=mr(i).toVar(),n=mr(s).toVar(),a=gr(e).toVar(),o=Nr(t).toVar(),h=Nr(0).toVar(),l=mr(1).toVar();return ac(a,()=>{h.addAssign(l.mul(ff(o))),l.mulAssign(r),o.mulAssign(n)}),h}).setLayout({name:"mx_fractal_noise_vec3",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),Nf=hr(([t,e,s,i])=>{const r=mr(i).toVar(),n=mr(s).toVar(),a=gr(e).toVar(),o=Nr(t).toVar();return xr(vf(o,a,n,r),vf(o.add(Nr(gr(19),gr(193),gr(17))),a,n,r))}).setLayout({name:"mx_fractal_noise_vec2",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),Tf=hr(([t,e,s,i])=>{const r=mr(i).toVar(),n=mr(s).toVar(),a=gr(e).toVar(),o=Nr(t).toVar(),h=Nr(wf(o,a,n,r)).toVar(),l=mr(vf(o.add(Nr(gr(19),gr(193),gr(17))),a,n,r)).toVar();return Sr(h,l)}).setLayout({name:"mx_fractal_noise_vec4",type:"vec4",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),Mf=hr(([t,e,s,i,r,n,a])=>{const o=gr(a).toVar(),h=mr(n).toVar(),l=gr(r).toVar(),u=gr(i).toVar(),c=gr(s).toVar(),d=gr(e).toVar(),p=xr(t).toVar(),m=Nr(bf(xr(d.add(u),c.add(l)))).toVar(),g=xr(m.x,m.y).toVar();g.subAssign(.5),g.mulAssign(h),g.addAssign(.5);const y=xr(xr(mr(d),mr(c)).add(g)).toVar(),f=xr(y.sub(p)).toVar();return cr(o.equal(gr(2)),()=>wa(f.x).add(wa(f.y))),cr(o.equal(gr(3)),()=>Ba(wa(f.x),wa(f.y))),Wa(f,f)}).setLayout({name:"mx_worley_distance_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),_f=kp([Mf,hr(([t,e,s,i,r,n,a,o,h])=>{const l=gr(h).toVar(),u=mr(o).toVar(),c=gr(a).toVar(),d=gr(n).toVar(),p=gr(r).toVar(),m=gr(i).toVar(),g=gr(s).toVar(),y=gr(e).toVar(),f=Nr(t).toVar(),x=Nr(bf(Nr(y.add(p),g.add(d),m.add(c)))).toVar();x.subAssign(.5),x.mulAssign(u),x.addAssign(.5);const b=Nr(Nr(mr(y),mr(g),mr(m)).add(x)).toVar(),v=Nr(b.sub(f)).toVar();return cr(l.equal(gr(2)),()=>wa(v.x).add(wa(v.y)).add(wa(v.z))),cr(l.equal(gr(3)),()=>Ba(Ba(wa(v.x),wa(v.y)),wa(v.z))),Wa(v,v)}).setLayout({name:"mx_worley_distance_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"zoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),Sf=hr(([t,e,s])=>{const i=gr(s).toVar(),r=mr(e).toVar(),n=xr(t).toVar(),a=gr().toVar(),o=gr().toVar(),h=xr($y(n.x,a),$y(n.y,o)).toVar(),l=mr(1e6).toVar();return ac({start:-1,end:gr(1),name:"x",condition:"<="},({x:t})=>{ac({start:-1,end:gr(1),name:"y",condition:"<="},({y:e})=>{const s=mr(_f(h,t,e,a,o,r,i)).toVar();l.assign(Fa(l,s))})}),cr(i.equal(gr(0)),()=>{l.assign(la(l))}),l}).setLayout({name:"mx_worley_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),Af=hr(([t,e,s])=>{const i=gr(s).toVar(),r=mr(e).toVar(),n=xr(t).toVar(),a=gr().toVar(),o=gr().toVar(),h=xr($y(n.x,a),$y(n.y,o)).toVar(),l=xr(1e6,1e6).toVar();return ac({start:-1,end:gr(1),name:"x",condition:"<="},({x:t})=>{ac({start:-1,end:gr(1),name:"y",condition:"<="},({y:e})=>{const s=mr(_f(h,t,e,a,o,r,i)).toVar();cr(s.lessThan(l.x),()=>{l.y.assign(l.x),l.x.assign(s)}).ElseIf(s.lessThan(l.y),()=>{l.y.assign(s)})})}),cr(i.equal(gr(0)),()=>{l.assign(la(l))}),l}).setLayout({name:"mx_worley_noise_vec2_0",type:"vec2",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),zf=hr(([t,e,s])=>{const i=gr(s).toVar(),r=mr(e).toVar(),n=xr(t).toVar(),a=gr().toVar(),o=gr().toVar(),h=xr($y(n.x,a),$y(n.y,o)).toVar(),l=Nr(1e6,1e6,1e6).toVar();return ac({start:-1,end:gr(1),name:"x",condition:"<="},({x:t})=>{ac({start:-1,end:gr(1),name:"y",condition:"<="},({y:e})=>{const s=mr(_f(h,t,e,a,o,r,i)).toVar();cr(s.lessThan(l.x),()=>{l.z.assign(l.y),l.y.assign(l.x),l.x.assign(s)}).ElseIf(s.lessThan(l.y),()=>{l.z.assign(l.y),l.y.assign(s)}).ElseIf(s.lessThan(l.z),()=>{l.z.assign(s)})})}),cr(i.equal(gr(0)),()=>{l.assign(la(l))}),l}).setLayout({name:"mx_worley_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),Vf=kp([Sf,hr(([t,e,s])=>{const i=gr(s).toVar(),r=mr(e).toVar(),n=Nr(t).toVar(),a=gr().toVar(),o=gr().toVar(),h=gr().toVar(),l=Nr($y(n.x,a),$y(n.y,o),$y(n.z,h)).toVar(),u=mr(1e6).toVar();return ac({start:-1,end:gr(1),name:"x",condition:"<="},({x:t})=>{ac({start:-1,end:gr(1),name:"y",condition:"<="},({y:e})=>{ac({start:-1,end:gr(1),name:"z",condition:"<="},({z:s})=>{const n=mr(_f(l,t,e,s,a,o,h,r,i)).toVar();u.assign(Fa(u,n))})})}),cr(i.equal(gr(0)),()=>{u.assign(la(u))}),u}).setLayout({name:"mx_worley_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),Cf=kp([Af,hr(([t,e,s])=>{const i=gr(s).toVar(),r=mr(e).toVar(),n=Nr(t).toVar(),a=gr().toVar(),o=gr().toVar(),h=gr().toVar(),l=Nr($y(n.x,a),$y(n.y,o),$y(n.z,h)).toVar(),u=xr(1e6,1e6).toVar();return ac({start:-1,end:gr(1),name:"x",condition:"<="},({x:t})=>{ac({start:-1,end:gr(1),name:"y",condition:"<="},({y:e})=>{ac({start:-1,end:gr(1),name:"z",condition:"<="},({z:s})=>{const n=mr(_f(l,t,e,s,a,o,h,r,i)).toVar();cr(n.lessThan(u.x),()=>{u.y.assign(u.x),u.x.assign(n)}).ElseIf(n.lessThan(u.y),()=>{u.y.assign(n)})})})}),cr(i.equal(gr(0)),()=>{u.assign(la(u))}),u}).setLayout({name:"mx_worley_noise_vec2_1",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),If=kp([zf,hr(([t,e,s])=>{const i=gr(s).toVar(),r=mr(e).toVar(),n=Nr(t).toVar(),a=gr().toVar(),o=gr().toVar(),h=gr().toVar(),l=Nr($y(n.x,a),$y(n.y,o),$y(n.z,h)).toVar(),u=Nr(1e6,1e6,1e6).toVar();return ac({start:-1,end:gr(1),name:"x",condition:"<="},({x:t})=>{ac({start:-1,end:gr(1),name:"y",condition:"<="},({y:e})=>{ac({start:-1,end:gr(1),name:"z",condition:"<="},({z:s})=>{const n=mr(_f(l,t,e,s,a,o,h,r,i)).toVar();cr(n.lessThan(u.x),()=>{u.z.assign(u.y),u.y.assign(u.x),u.x.assign(n)}).ElseIf(n.lessThan(u.y),()=>{u.z.assign(u.y),u.y.assign(n)}).ElseIf(n.lessThan(u.z),()=>{u.z.assign(n)})})})}),cr(i.equal(gr(0)),()=>{u.assign(la(u))}),u}).setLayout({name:"mx_worley_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),Rf=hr(([t])=>{const e=t.y,s=t.z,i=Nr().toVar();return cr(e.lessThan(1e-4),()=>{i.assign(Nr(s,s,s))}).Else(()=>{let r=t.x;r=r.sub(ca(r)).mul(6).toVar();const n=gr(Ca(r)),a=r.sub(mr(n)),o=s.mul(e.oneMinus()),h=s.mul(e.mul(a).oneMinus()),l=s.mul(e.mul(a.oneMinus()).oneMinus());cr(n.equal(gr(0)),()=>{i.assign(Nr(s,l,o))}).ElseIf(n.equal(gr(1)),()=>{i.assign(Nr(h,s,o))}).ElseIf(n.equal(gr(2)),()=>{i.assign(Nr(o,s,l))}).ElseIf(n.equal(gr(3)),()=>{i.assign(Nr(o,h,s))}).ElseIf(n.equal(gr(4)),()=>{i.assign(Nr(l,o,s))}).Else(()=>{i.assign(Nr(s,o,h))})}),i}).setLayout({name:"mx_hsvtorgb",type:"vec3",inputs:[{name:"hsv",type:"vec3"}]}),Ef=hr(([t])=>{const e=Nr(t).toVar(),s=mr(e.x).toVar(),i=mr(e.y).toVar(),r=mr(e.z).toVar(),n=mr(Fa(s,Fa(i,r))).toVar(),a=mr(Ba(s,Ba(i,r))).toVar(),o=mr(a.sub(n)).toVar(),h=mr().toVar(),l=mr().toVar(),u=mr().toVar();return u.assign(a),cr(a.greaterThan(0),()=>{l.assign(o.div(a))}).Else(()=>{l.assign(0)}),cr(l.lessThanEqual(0),()=>{h.assign(0)}).Else(()=>{cr(s.greaterThanEqual(a),()=>{h.assign(i.sub(r).div(o))}).ElseIf(i.greaterThanEqual(a),()=>{h.assign(zn(2,r.sub(s).div(o)))}).Else(()=>{h.assign(zn(4,s.sub(i).div(o)))}),h.mulAssign(1/6),cr(h.lessThan(0),()=>{h.addAssign(1)})}),Nr(h,l,u)}).setLayout({name:"mx_rgbtohsv",type:"vec3",inputs:[{name:"c",type:"vec3"}]}),Of=hr(([t])=>{const e=Nr(t).toVar(),s=_r(Bn(e,Nr(.04045))).toVar(),i=Nr(e.div(12.92)).toVar(),r=Nr(qa(Ba(e.add(Nr(.055)),Nr(0)).div(1.055),Nr(2.4))).toVar();return Ja(i,r,s)}).setLayout({name:"mx_srgb_texture_to_lin_rec709",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),Ff=(t,e)=>{t=mr(t),e=mr(e);const s=xr(e.dFdx(),e.dFdy()).length().mul(.7071067811865476);return eo(t.sub(s),t.add(s),e)},Bf=(t,e,s,i)=>Ja(t,e,s[i].clamp()),Lf=(t,e,s,i,r)=>Ja(t,e,Ff(s,i[r])),Pf=hr(([t,e,s])=>{const i=pa(t).toVar("nDir"),r=Vn(mr(.5).mul(e.sub(s)),Qh).div(i).toVar("rbmax"),n=Vn(mr(-.5).mul(e.sub(s)),Qh).div(i).toVar("rbmin"),a=Nr().toVar("rbminmax");a.x=i.x.greaterThan(mr(0)).select(r.x,n.x),a.y=i.y.greaterThan(mr(0)).select(r.y,n.y),a.z=i.z.greaterThan(mr(0)).select(r.z,n.z);const o=Fa(Fa(a.x,a.y),a.z).toVar("correction");return Qh.add(i.mul(o)).toVar("boxIntersection").sub(s)}),Df=hr(([t,e])=>{const s=t.x,i=t.y,r=t.z;let n=e.element(0).mul(.886227);return n=n.add(e.element(1).mul(1.023328).mul(i)),n=n.add(e.element(2).mul(1.023328).mul(r)),n=n.add(e.element(3).mul(1.023328).mul(s)),n=n.add(e.element(4).mul(.858086).mul(s).mul(i)),n=n.add(e.element(5).mul(.858086).mul(i).mul(r)),n=n.add(e.element(6).mul(r.mul(r).mul(.743125).sub(.247708))),n=n.add(e.element(7).mul(.858086).mul(s).mul(r)),n=n.add(e.element(8).mul(.429043).mul(Cn(s,s).sub(Cn(i,i)))),n});var kf=Object.freeze({__proto__:null,BRDF_GGX:pd,BRDF_Lambert:nd,BasicPointShadowFilter:By,BasicShadowFilter:My,Break:oc,Const:bo,Continue:()=>eh("continue").append(),DFGApprox:md,D_GGX:ud,Discard:sh,EPSILON:Jn,F_Schlick:rd,Fn:hr,INFINITY:Kn,If:cr,Loop:ac,NodeAccess:ui,NodeShaderStage:hi,NodeType:{BOOLEAN:"bool",INTEGER:"int",FLOAT:"float",VECTOR2:"vec2",VECTOR3:"vec3",VECTOR4:"vec4",MATRIX2:"mat2",MATRIX3:"mat3",MATRIX4:"mat4"},NodeUpdateType:li,PCFShadowFilter:_y,PCFSoftShadowFilter:Sy,PI:Qn,PI2:ta,PointShadowFilter:Ly,Return:()=>eh("return").append(),Schlick_to_F0:gd,ScriptableNodeResources:Rg,ShaderNode:sr,TBNViewMatrix:Gl,VSMShadowFilter:Ay,V_GGX_SmithCorrelated:hd,Var:xo,abs:wa,acesFilmicToneMapping:xg,acos:ba,add:zn,addMethodChaining:Ci,addNodeElement:function(t){},agxToneMapping:Ng,all:ea,alphaT:an,and:Dn,anisotropy:on,anisotropyB:ln,anisotropyT:hn,any:sa,append:dr,array:Br,arrayBuffer:t=>ir(new Si(t,"ArrayBuffer")),asin:xa,assign:Mn,atan:va,atan2:ao,atomicAdd:(t,e,s=null)=>ey(Qg.ATOMIC_ADD,t,e,s),atomicAnd:(t,e,s=null)=>ey(Qg.ATOMIC_AND,t,e,s),atomicFunc:ey,atomicLoad:(t,e=null)=>ey(Qg.ATOMIC_LOAD,t,null,e),atomicMax:(t,e,s=null)=>ey(Qg.ATOMIC_MAX,t,e,s),atomicMin:(t,e,s=null)=>ey(Qg.ATOMIC_MIN,t,e,s),atomicOr:(t,e,s=null)=>ey(Qg.ATOMIC_OR,t,e,s),atomicStore:(t,e,s=null)=>ey(Qg.ATOMIC_STORE,t,e,s),atomicSub:(t,e,s=null)=>ey(Qg.ATOMIC_SUB,t,e,s),atomicXor:(t,e,s=null)=>ey(Qg.ATOMIC_XOR,t,e,s),attenuationColor:wn,attenuationDistance:vn,attribute:ah,attributeArray:(t,e="float")=>{let s,i;!0===e.isStruct?(s=e.layout.getLength(),i=ei("float")):(s=si(e),i=ei(e));const r=new _m(t,s,i);return Vm(r,e,t)},backgroundBlurriness:Bm,backgroundIntensity:Lm,backgroundRotation:Pm,batch:ec,billboarding:Gp,bitAnd:jn,bitNot:qn,bitOr:Hn,bitXor:Gn,bitangentGeometry:kl,bitangentLocal:Ul,bitangentView:Wl,bitangentWorld:jl,bitcast:Ea,blendBurn:Zm,blendColor:tg,blendDodge:Jm,blendOverlay:Qm,blendScreen:Km,blur:Gd,bool:fr,buffer:yh,bufferAttribute:Uo,bumpMap:eu,burn:(...t)=>Zm(t),bvec2:wr,bvec3:_r,bvec4:Vr,bypass:Zo,cache:Yo,call:Sn,cameraFar:Nh,cameraIndex:vh,cameraNear:wh,cameraNormalMatrix:Ah,cameraPosition:zh,cameraProjectionMatrix:Th,cameraProjectionMatrixInverse:Mh,cameraViewMatrix:_h,cameraWorldMatrix:Sh,cbrt:$a,cdl:ag,ceil:da,checker:qy,cineonToneMapping:yg,clamp:Ka,clearcoat:Kr,clearcoatRoughness:Qr,code:_g,color:pr,colorSpaceToWorking:Ro,colorToDirection:t=>ir(t).mul(2).sub(1),compute:Go,cond:co,context:mo,convert:Or,convertColorSpace:(t,e,s)=>ir(new zo(ir(t),e,s)),convertToTexture:(t,...e)=>t.isTextureNode?t:t.isPassNode?t.getTextureNode():vm(t,...e),cos:ya,cross:ja,cubeTexture:Sl,cubeToUV:Fy,dFdx:Sa,dFdy:Aa,dashSize:mn,defaultBuildStages:["setup","analyze","generate"],defaultShaderStages:ci,defined:tr,degrees:ra,deltaTime:Wp,densityFog:function(t,e){return Pg(t,Lg(e))},densityFogFactor:Lg,depth:qc,depthPass:(t,e,s)=>ir(new dg(dg.DEPTH,t,e,s)),difference:Ua,diffuseColor:Yr,directPointLight:({color:t,lightVector:e,cutoffDistance:s,decayExponent:i})=>{const r=e.normalize(),n=e.length(),a=jy({lightDistance:n,cutoffDistance:s,decayExponent:i});return{lightDirection:r,lightColor:t.mul(a)}},directionToColor:t=>ir(t).mul(.5).add(.5),dispersion:Nn,distance:ka,div:In,dodge:(...t)=>Jm(t),dot:Wa,drawIndex:$u,dynamicBufferAttribute:Wo,element:Er,emissive:$r,equal:En,equals:Oa,equirectUV:id,exp:na,exp2:aa,expression:eh,faceDirection:nl,faceForward:so,faceforward:oo,float:mr,floor:ca,fog:Pg,fract:ma,frameGroup:kr,frameId:jp,frontFacing:rl,fwidth:Ia,gain:(t,e)=>t.lessThan(.5)?Op(t.mul(2),e).div(2):Vn(1,Op(Cn(Vn(1,t),2),e).div(2)),gapSize:gn,getConstNodeType:er,getCurrentStack:ur,getDirection:Wd,getDistanceAttenuation:jy,getGeometryRoughness:ad,getNormalFromDepth:Tm,getParallaxCorrectNormal:Pf,getRoughness:od,getScreenPosition:Nm,getShIrradianceAt:Df,getTextureIndex:Cp,getViewPosition:wm,globalId:Xg,glsl:(t,e)=>_g(t,e,"glsl"),glslFn:(t,e)=>Ag(t,e,"glsl"),grayscale:eg,greaterThan:Bn,greaterThanEqual:Pn,hash:Ep,highpModelNormalViewMatrix:$h,highpModelViewMatrix:Yh,hue:rg,instance:Ju,instanceIndex:Hu,instancedArray:(t,e="float")=>{let s,i;!0===e.isStruct?(s=e.layout.getLength(),i=ei("float")):(s=si(e),i=ei(e));const r=new Mm(t,s,i);return Vm(r,e,t)},instancedBufferAttribute:jo,instancedDynamicBufferAttribute:qo,instancedMesh:Qu,int:gr,inverseSqrt:ua,inversesqrt:ho,invocationLocalIndex:Yu,invocationSubgroupIndex:Xu,ior:fn,iridescence:sn,iridescenceIOR:rn,iridescenceThickness:nn,ivec2:br,ivec3:Tr,ivec4:Ar,js:(t,e)=>_g(t,e,"js"),label:go,length:Ta,lengthSq:Za,lessThan:Fn,lessThanEqual:Ln,lightPosition:ny,lightProjectionUV:function(t,e=Qh){const s=ry(t).mul(e);return s.xyz.div(s.w)},lightShadowMatrix:ry,lightTargetDirection:t=>_h.transformDirection(ny(t).sub(ay(t))),lightTargetPosition:ay,lightViewPosition:function(t){const e=iy(t);return e.viewPosition||(e.viewPosition=qr(new at).setGroup(Ur).onRenderUpdate(({camera:e},s)=>{s.value=s.value||new at,s.value.setFromMatrixPosition(t.matrixWorld),s.value.applyMatrix4(e.matrixWorldInverse)}))},lightingContext:yc,lights:(t=[])=>ir(new ly).setLights(t),linearDepth:Hc,linearToneMapping:mg,localId:Yg,log:oa,log2:ha,logarithmicDepthToViewZ:(t,e,s)=>{const i=t.mul(oa(s.div(e)));return mr(Math.E).pow(i).mul(e).negate()},loop:(...t)=>ac(...t),luminance:ng,mat2:Cr,mat3:Ir,mat4:Rr,matcapUV:vp,materialAO:ku,materialAlphaTest:ru,materialAnisotropy:Tu,materialAnisotropyVector:Uu,materialAttenuationColor:Iu,materialAttenuationDistance:Cu,materialClearcoat:fu,materialClearcoatNormal:bu,materialClearcoatRoughness:xu,materialColor:nu,materialDispersion:Pu,materialEmissive:ou,materialEnvIntensity:bl,materialEnvRotation:vl,materialIOR:Vu,materialIridescence:Mu,materialIridescenceIOR:_u,materialIridescenceThickness:Su,materialLightMap:Du,materialLineDashOffset:Bu,materialLineDashSize:Eu,materialLineGapSize:Ou,materialLineScale:Ru,materialLineWidth:Fu,materialMetalness:gu,materialNormal:yu,materialOpacity:hu,materialPointSize:Lu,materialReference:Rl,materialReflectivity:pu,materialRefractionRatio:xl,materialRotation:vu,materialRoughness:mu,materialSheen:wu,materialSheenRoughness:Nu,materialShininess:au,materialSpecular:lu,materialSpecularColor:cu,materialSpecularIntensity:uu,materialSpecularStrength:du,materialThickness:zu,materialTransmission:Au,max:Ba,maxMipLevel:ch,mediumpModelViewMatrix:Xh,metalness:Jr,min:Fa,mix:Ja,mixElement:ro,mod:La,modInt:Rn,modelDirection:Ph,modelNormalMatrix:qh,modelPosition:kh,modelRadius:jh,modelScale:Uh,modelViewMatrix:Gh,modelViewPosition:Wh,modelViewProjection:Wu,modelWorldMatrix:Dh,modelWorldMatrixInverse:Hh,morphReference:dc,mrt:Rp,mul:Cn,mx_aastep:Ff,mx_cell_noise_float:(t=oh())=>xf(t.convert("vec2|vec3")),mx_contrast:(t,e=1,s=.5)=>mr(t).sub(s).mul(e).add(s),mx_fractal_noise_float:(t=oh(),e=3,s=2,i=.5,r=1)=>vf(t,gr(e),s,i).mul(r),mx_fractal_noise_vec2:(t=oh(),e=3,s=2,i=.5,r=1)=>Nf(t,gr(e),s,i).mul(r),mx_fractal_noise_vec3:(t=oh(),e=3,s=2,i=.5,r=1)=>wf(t,gr(e),s,i).mul(r),mx_fractal_noise_vec4:(t=oh(),e=3,s=2,i=.5,r=1)=>Tf(t,gr(e),s,i).mul(r),mx_hsvtorgb:Rf,mx_noise_float:(t=oh(),e=1,s=0)=>yf(t.convert("vec2|vec3")).mul(e).add(s),mx_noise_vec3:(t=oh(),e=1,s=0)=>ff(t.convert("vec2|vec3")).mul(e).add(s),mx_noise_vec4:(t=oh(),e=1,s=0)=>{t=t.convert("vec2|vec3");return Sr(ff(t),yf(t.add(xr(19,73)))).mul(e).add(s)},mx_ramplr:(t,e,s=oh())=>Bf(t,e,s,"x"),mx_ramptb:(t,e,s=oh())=>Bf(t,e,s,"y"),mx_rgbtohsv:Ef,mx_safepower:(t,e=1)=>(t=mr(t)).abs().pow(e).mul(t.sign()),mx_splitlr:(t,e,s,i=oh())=>Lf(t,e,s,i,"x"),mx_splittb:(t,e,s,i=oh())=>Lf(t,e,s,i,"y"),mx_srgb_texture_to_lin_rec709:Of,mx_transform_uv:(t=1,e=0,s=oh())=>s.mul(t).add(e),mx_worley_noise_float:(t=oh(),e=1)=>Vf(t.convert("vec2|vec3"),e,gr(1)),mx_worley_noise_vec2:(t=oh(),e=1)=>Cf(t.convert("vec2|vec3"),e,gr(1)),mx_worley_noise_vec3:(t=oh(),e=1)=>If(t.convert("vec2|vec3"),e,gr(1)),negate:Ma,neutralToneMapping:Tg,nodeArray:nr,nodeImmutable:or,nodeObject:ir,nodeObjects:rr,nodeProxy:ar,normalFlat:hl,normalGeometry:al,normalLocal:ol,normalMap:Jl,normalView:ll,normalWorld:ul,normalize:pa,not:Un,notEqual:On,numWorkgroups:Hg,objectDirection:Ih,objectGroup:Wr,objectPosition:Eh,objectRadius:Bh,objectScale:Oh,objectViewPosition:Fh,objectWorldMatrix:Rh,oneMinus:_a,or:kn,orthographicDepthToViewZ:(t,e,s)=>e.sub(s).mul(t).sub(e),oscSawtooth:(t=Up)=>t.fract(),oscSine:(t=Up)=>t.add(.75).mul(2*Math.PI).sin().mul(.5).add(.5),oscSquare:(t=Up)=>t.fract().round(),oscTriangle:(t=Up)=>t.add(.5).fract().mul(2).sub(1).abs(),output:pn,outputStruct:Vp,overlay:(...t)=>Qm(t),overloadingFn:kp,parabola:Op,parallaxDirection:Xl,parallaxUV:(t,e)=>t.sub(Xl.mul(e)),parameter:(t,e)=>ir(new Tp(t,e)),pass:(t,e,s)=>ir(new dg(dg.COLOR,t,e,s)),passTexture:(t,e)=>ir(new ug(t,e)),pcurve:(t,e,s)=>qa(In(qa(t,e),zn(qa(t,e),qa(Vn(1,t),s))),1/e),perspectiveDepthToViewZ:Uc,pmremTexture:xp,pointShadow:(t,e)=>ir(new Wy(t,e)),pointUV:Rm,pointWidth:yn,positionGeometry:Zh,positionLocal:Jh,positionPrevious:Kh,positionView:el,positionViewDirection:sl,positionWorld:Qh,positionWorldDirection:tl,posterize:hg,pow:qa,pow2:Ha,pow3:Ga,pow4:Xa,property:Gr,radians:ia,rand:io,range:Wg,rangeFog:function(t,e,s){return Pg(t,Bg(e,s))},rangeFogFactor:Bg,reciprocal:Va,reference:Vl,referenceBuffer:Cl,reflect:Da,reflectVector:Tl,reflectView:wl,reflector:t=>ir(new dm(t)),refract:to,refractVector:Ml,refractView:Nl,reinhardToneMapping:gg,remainder:$n,remap:Ko,remapClamp:Qo,renderGroup:Ur,renderOutput:rh,rendererReference:Bo,rotate:Np,rotateUV:qp,roughness:Zr,round:za,rtt:vm,sRGBTransferEOTF:Mo,sRGBTransferOETF:_o,sampler:t=>(!0===t.isNode?t:ph(t)).convert("sampler"),saturate:Qa,saturation:sg,screen:(...t)=>Km(t),screenCoordinate:Tc,screenSize:Nc,screenUV:wc,scriptable:Og,scriptableValue:Vg,select:uo,setCurrentStack:lr,shaderStages:di,shadow:(t,e)=>ir(new Ey(t,e)),shadowPositionWorld:cy,shapeCircle:Hy,sharedUniformGroup:Dr,sheen:tn,sheenRoughness:en,shiftLeft:Xn,shiftRight:Yn,shininess:dn,sign:Na,sin:ga,sinc:(t,e)=>ga(Qn.mul(e.mul(t).sub(1))).div(Qn.mul(e.mul(t).sub(1))),skinning:t=>ir(new ic(t)),skinningReference:rc,smoothstep:eo,smoothstepElement:no,specularColor:un,specularF90:cn,spherizeUV:Hp,split:(t,e)=>ir(new wi(ir(t),e)),spritesheetUV:$p,sqrt:la,stack:_p,step:Pa,storage:Vm,storageBarrier:()=>Zg("storage").append(),storageObject:(t,e,s)=>Vm(t,e,s).setPBO(!0),storageTexture:km,string:(t="")=>ir(new Si(t,"string")),struct:(t,e=null)=>{const s=new Sp(t,e),i=(...e)=>{let i=null;if(e.length>0)if(e[0].isNode){i={};const s=Object.keys(t);for(let t=0;t<e.length;t++)i[s[t]]=e[t]}else i=e[0];return ir(new Ap(s,i))};return i.layout=s,i.isStruct=!0,i},sub:Vn,subgroupIndex:Gu,subgroupSize:$g,tan:fa,tangentGeometry:El,tangentLocal:Ol,tangentView:Fl,tangentWorld:Bl,temp:vo,texture:ph,texture3D:jm,textureBarrier:()=>Zg("texture").append(),textureBicubic:Sd,textureCubeUV:jd,textureLoad:mh,textureSize:lh,textureStore:(t,e,s)=>{const i=km(t,e,s);return null!==s&&i.append(),i},thickness:bn,time:Up,timerDelta:(t=1)=>Wp.mul(t),timerGlobal:(t=1)=>Up.mul(t),timerLocal:(t=1)=>Up.mul(t),toOutputColorSpace:Vo,toWorkingColorSpace:Co,toneMapping:Po,toneMappingExposure:Do,toonOutlinePass:(t,e,s=new ze(0,0,0),i=.003,r=1)=>ir(new pg(t,e,ir(s),ir(i),ir(r))),transformDirection:Ya,transformNormal:ml,transformNormalToView:gl,transformedBentNormalView:Yl,transformedBitangentView:ql,transformedBitangentWorld:Hl,transformedClearcoatNormalView:pl,transformedNormalView:cl,transformedNormalWorld:dl,transformedTangentView:Ll,transformedTangentWorld:Pl,transmission:xn,transpose:Ra,triNoise3D:Lp,triplanarTexture:(...t)=>Jp(...t),triplanarTextures:Jp,trunc:Ca,tslFn:(...t)=>hr(...t),uint:yr,uniform:qr,uniformArray:bh,uniformGroup:Pr,uniforms:(t,e)=>ir(new xh(t,e)),userData:(t,e,s)=>ir(new qm(t,e,s)),uv:oh,uvec2:vr,uvec3:Mr,uvec4:zr,varying:No,varyingProperty:Xr,vec2:xr,vec3:Nr,vec4:Sr,vectorComponents:pi,velocity:$m,vertexColor:t=>ir(new Cm(t)),vertexIndex:qu,vertexStage:To,vibrance:ig,viewZToLogarithmicDepth:Wc,viewZToOrthographicDepth:Dc,viewZToPerspectiveDepth:kc,viewport:Mc,viewportBottomLeft:Cc,viewportCoordinate:Sc,viewportDepthTexture:Lc,viewportLinearDepth:Gc,viewportMipTexture:Oc,viewportResolution:zc,viewportSafeUV:Xp,viewportSharedTexture:ed,viewportSize:_c,viewportTexture:Ec,viewportTopLeft:Vc,viewportUV:Ac,wgsl:(t,e)=>_g(t,e,"wgsl"),wgslFn:(t,e)=>Ag(t,e,"wgsl"),workgroupArray:(t,e)=>ir(new Kg("Workgroup",t,e)),workgroupBarrier:()=>Zg("workgroup").append(),workgroupId:Gg,workingToColorSpace:Io,xor:Wn});const Uf="undefined"!=typeof self?self.GPUShaderStage:{VERTEX:1,FRAGMENT:2,COMPUTE:4};Uf&&Uf.VERTEX,Uf&&Uf.FRAGMENT,Uf&&Uf.COMPUTE;const Wf={tsl_xor:new Mg("fn tsl_xor( a : bool, b : bool ) -> bool { return ( a || b ) && !( a && b ); }"),mod_float:new Mg("fn tsl_mod_float( x : f32, y : f32 ) -> f32 { return x - y * floor( x / y ); }"),mod_vec2:new Mg("fn tsl_mod_vec2( x : vec2f, y : vec2f ) -> vec2f { return x - y * floor( x / y ); }"),mod_vec3:new Mg("fn tsl_mod_vec3( x : vec3f, y : vec3f ) -> vec3f { return x - y * floor( x / y ); }"),mod_vec4:new Mg("fn tsl_mod_vec4( x : vec4f, y : vec4f ) -> vec4f { return x - y * floor( x / y ); }"),equals_bool:new Mg("fn tsl_equals_bool( a : bool, b : bool ) -> bool { return a == b; }"),equals_bvec2:new Mg("fn tsl_equals_bvec2( a : vec2f, b : vec2f ) -> vec2<bool> { return vec2<bool>( a.x == b.x, a.y == b.y ); }"),equals_bvec3:new Mg("fn tsl_equals_bvec3( a : vec3f, b : vec3f ) -> vec3<bool> { return vec3<bool>( a.x == b.x, a.y == b.y, a.z == b.z ); }"),equals_bvec4:new Mg("fn tsl_equals_bvec4( a : vec4f, b : vec4f ) -> vec4<bool> { return vec4<bool>( a.x == b.x, a.y == b.y, a.z == b.z, a.w == b.w ); }"),repeatWrapping_float:new Mg("fn tsl_repeatWrapping_float( coord: f32 ) -> f32 { return fract( coord ); }"),mirrorWrapping_float:new Mg("fn tsl_mirrorWrapping_float( coord: f32 ) -> f32 { let mirrored = fract( coord * 0.5 ) * 2.0; return 1.0 - abs( 1.0 - mirrored ); }"),clampWrapping_float:new Mg("fn tsl_clampWrapping_float( coord: f32 ) -> f32 { return clamp( coord, 0.0, 1.0 ); }"),biquadraticTexture:new Mg("\nfn tsl_biquadraticTexture( map : texture_2d<f32>, coord : vec2f, iRes : vec2u, level : u32 ) -> vec4f {\n\n\tlet res = vec2f( iRes );\n\n\tlet uvScaled = coord * res;\n\tlet uvWrapping = ( ( uvScaled % res ) + res ) % res;\n\n\t// https://www.shadertoy.com/view/WtyXRy\n\n\tlet uv = uvWrapping - 0.5;\n\tlet iuv = floor( uv );\n\tlet f = fract( uv );\n\n\tlet rg1 = textureLoad( map, vec2u( iuv + vec2( 0.5, 0.5 ) ) % iRes, level );\n\tlet rg2 = textureLoad( map, vec2u( iuv + vec2( 1.5, 0.5 ) ) % iRes, level );\n\tlet rg3 = textureLoad( map, vec2u( iuv + vec2( 0.5, 1.5 ) ) % iRes, level );\n\tlet rg4 = textureLoad( map, vec2u( iuv + vec2( 1.5, 1.5 ) ) % iRes, level );\n\n\treturn mix( mix( rg1, rg2, f.x ), mix( rg3, rg4, f.x ), f.y );\n\n}\n")};"undefined"!=typeof navigator&&/Windows/g.test(navigator.userAgent)&&(Wf.pow_float=new Mg("fn tsl_pow_float( a : f32, b : f32 ) -> f32 { return select( -pow( -a, b ), pow( a, b ), a > 0.0 ); }"),Wf.pow_vec2=new Mg("fn tsl_pow_vec2( a : vec2f, b : vec2f ) -> vec2f { return vec2f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ) ); }",[Wf.pow_float]),Wf.pow_vec3=new Mg("fn tsl_pow_vec3( a : vec3f, b : vec3f ) -> vec3f { return vec3f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ) ); }",[Wf.pow_float]),Wf.pow_vec4=new Mg("fn tsl_pow_vec4( a : vec4f, b : vec4f ) -> vec4f { return vec4f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ), tsl_pow_float( a.w, b.w ) ); }",[Wf.pow_float])),"undefined"!=typeof navigator&&/Firefox|Deno/g.test(navigator.userAgent),new Map([[class extends ke{constructor(t,e,s){super(new Uint16Array(t),e,s),this.isFloat16BufferAttribute=!0}getX(t){let e=Be(this.array[t*this.itemSize]);return this.normalized&&(e=B(e,this.array)),e}setX(t,e){return this.normalized&&(e=L(e,this.array)),this.array[t*this.itemSize]=Fe(e),this}getY(t){let e=Be(this.array[t*this.itemSize+1]);return this.normalized&&(e=B(e,this.array)),e}setY(t,e){return this.normalized&&(e=L(e,this.array)),this.array[t*this.itemSize+1]=Fe(e),this}getZ(t){let e=Be(this.array[t*this.itemSize+2]);return this.normalized&&(e=B(e,this.array)),e}setZ(t,e){return this.normalized&&(e=L(e,this.array)),this.array[t*this.itemSize+2]=Fe(e),this}getW(t){let e=Be(this.array[t*this.itemSize+3]);return this.normalized&&(e=B(e,this.array)),e}setW(t,e){return this.normalized&&(e=L(e,this.array)),this.array[t*this.itemSize+3]=Fe(e),this}setXY(t,e,s){return t*=this.itemSize,this.normalized&&(e=L(e,this.array),s=L(s,this.array)),this.array[t+0]=Fe(e),this.array[t+1]=Fe(s),this}setXYZ(t,e,s,i){return t*=this.itemSize,this.normalized&&(e=L(e,this.array),s=L(s,this.array),i=L(i,this.array)),this.array[t+0]=Fe(e),this.array[t+1]=Fe(s),this.array[t+2]=Fe(i),this}setXYZW(t,e,s,i,r){return t*=this.itemSize,this.normalized&&(e=L(e,this.array),s=L(s,this.array),i=L(i,this.array),r=L(r,this.array)),this.array[t+0]=Fe(e),this.array[t+1]=Fe(s),this.array[t+2]=Fe(i),this.array[t+3]=Fe(r),this}},["float16"]]]);kf.BRDF_GGX,kf.BRDF_Lambert,kf.BasicShadowFilter,kf.Break,kf.Continue,kf.DFGApprox,kf.D_GGX,kf.Discard,kf.EPSILON,kf.F_Schlick;const jf=kf.Fn;kf.INFINITY,kf.If;const qf=kf.Loop;kf.NodeShaderStage,kf.NodeType,kf.NodeUpdateType,kf.NodeAccess,kf.PCFShadowFilter,kf.PCFSoftShadowFilter,kf.PI,kf.PI2,kf.Return,kf.Schlick_to_F0,kf.ScriptableNodeResources;const Hf=kf.ShaderNode;kf.TBNViewMatrix,kf.VSMShadowFilter,kf.V_GGX_SmithCorrelated;const Gf=kf.abs;kf.acesFilmicToneMapping,kf.acos;const Xf=kf.add;kf.addNodeElement,kf.agxToneMapping,kf.all,kf.alphaT,kf.and,kf.anisotropy,kf.anisotropyB,kf.anisotropyT,kf.any,kf.append,kf.array,kf.arrayBuffer,kf.asin,kf.assign,kf.atan,kf.atan2,kf.atomicAdd,kf.atomicAnd,kf.atomicFunc,kf.atomicMax,kf.atomicMin,kf.atomicOr,kf.atomicStore,kf.atomicSub,kf.atomicXor,kf.atomicLoad,kf.attenuationColor,kf.attenuationDistance,kf.attribute,kf.attributeArray,kf.backgroundBlurriness,kf.backgroundIntensity,kf.backgroundRotation,kf.batch,kf.billboarding,kf.bitAnd,kf.bitNot,kf.bitOr,kf.bitXor,kf.bitangentGeometry,kf.bitangentLocal,kf.bitangentView,kf.bitangentWorld,kf.bitcast,kf.blendBurn,kf.blendColor,kf.blendDodge,kf.blendOverlay;const Yf=kf.blendScreen;kf.blur,kf.bool,kf.buffer,kf.bufferAttribute,kf.bumpMap,kf.burn,kf.bvec2,kf.bvec3,kf.bvec4,kf.bypass,kf.cache,kf.call,kf.cameraFar,kf.cameraIndex,kf.cameraNear,kf.cameraNormalMatrix,kf.cameraPosition,kf.cameraProjectionMatrix,kf.cameraProjectionMatrixInverse,kf.cameraViewMatrix,kf.cameraWorldMatrix,kf.cbrt,kf.cdl,kf.ceil,kf.checker,kf.cineonToneMapping,kf.clamp,kf.clearcoat,kf.clearcoatRoughness,kf.code,kf.color,kf.colorSpaceToWorking,kf.colorToDirection,kf.compute,kf.cond,kf.Const,kf.context,kf.convert,kf.convertColorSpace,kf.convertToTexture,kf.cos,kf.cross,kf.cubeTexture,kf.dFdx,kf.dFdy,kf.dashSize,kf.defaultBuildStages,kf.defaultShaderStages,kf.defined,kf.degrees,kf.deltaTime,kf.densityFog,kf.densityFogFactor,kf.depth,kf.depthPass,kf.difference,kf.diffuseColor,kf.directPointLight,kf.directionToColor,kf.dispersion,kf.distance,kf.div,kf.dodge,kf.dot,kf.drawIndex,kf.dynamicBufferAttribute,kf.element,kf.emissive,kf.equal,kf.equals,kf.equirectUV,kf.exp,kf.exp2,kf.expression,kf.faceDirection,kf.faceForward,kf.faceforward;const $f=kf.float;kf.floor,kf.fog,kf.fract,kf.frameGroup,kf.frameId,kf.frontFacing,kf.fwidth,kf.gain,kf.gapSize,kf.getConstNodeType,kf.getCurrentStack,kf.getDirection,kf.getDistanceAttenuation,kf.getGeometryRoughness,kf.getNormalFromDepth,kf.getParallaxCorrectNormal,kf.getRoughness,kf.getScreenPosition,kf.getShIrradianceAt,kf.getTextureIndex,kf.getViewPosition,kf.glsl,kf.glslFn,kf.grayscale,kf.greaterThan,kf.greaterThanEqual,kf.hash,kf.highpModelNormalViewMatrix,kf.highpModelViewMatrix,kf.hue,kf.instance,kf.instanceIndex,kf.instancedArray,kf.instancedBufferAttribute,kf.instancedDynamicBufferAttribute,kf.instancedMesh;const Zf=kf.int;kf.inverseSqrt,kf.inversesqrt,kf.invocationLocalIndex,kf.invocationSubgroupIndex,kf.ior,kf.iridescence,kf.iridescenceIOR,kf.iridescenceThickness,kf.ivec2,kf.ivec3,kf.ivec4,kf.js,kf.label,kf.length,kf.lengthSq,kf.lessThan,kf.lessThanEqual,kf.lightPosition,kf.lightTargetDirection,kf.lightTargetPosition,kf.lightViewPosition,kf.lightingContext,kf.lights,kf.linearDepth,kf.linearToneMapping,kf.localId,kf.globalId,kf.log,kf.log2,kf.logarithmicDepthToViewZ,kf.loop;const Jf=kf.luminance;kf.mediumpModelViewMatrix,kf.mat2,kf.mat3,kf.mat4,kf.matcapUV,kf.materialAO,kf.materialAlphaTest,kf.materialAnisotropy,kf.materialAnisotropyVector,kf.materialAttenuationColor,kf.materialAttenuationDistance,kf.materialClearcoat,kf.materialClearcoatNormal,kf.materialClearcoatRoughness,kf.materialColor,kf.materialDispersion,kf.materialEmissive,kf.materialIOR,kf.materialIridescence,kf.materialIridescenceIOR,kf.materialIridescenceThickness,kf.materialLightMap,kf.materialLineDashOffset,kf.materialLineDashSize,kf.materialLineGapSize,kf.materialLineScale,kf.materialLineWidth,kf.materialMetalness,kf.materialNormal,kf.materialOpacity,kf.materialPointSize,kf.materialReference,kf.materialReflectivity,kf.materialRefractionRatio,kf.materialRotation,kf.materialRoughness,kf.materialSheen,kf.materialSheenRoughness,kf.materialShininess,kf.materialSpecular,kf.materialSpecularColor,kf.materialSpecularIntensity,kf.materialSpecularStrength,kf.materialThickness,kf.materialTransmission;const Kf=kf.max;kf.maxMipLevel,kf.metalness,kf.min;const Qf=kf.mix;kf.mixElement;const tx=kf.mod;kf.modInt,kf.modelDirection,kf.modelNormalMatrix,kf.modelPosition,kf.modelRadius,kf.modelScale,kf.modelViewMatrix,kf.modelViewPosition,kf.modelViewProjection,kf.modelWorldMatrix,kf.modelWorldMatrixInverse,kf.morphReference,kf.mrt,kf.mul,kf.mx_aastep;const ex=kf.mx_cell_noise_float;kf.mx_contrast,kf.mx_fractal_noise_float,kf.mx_fractal_noise_vec2,kf.mx_fractal_noise_vec3,kf.mx_fractal_noise_vec4,kf.mx_hsvtorgb,kf.mx_noise_float,kf.mx_noise_vec3,kf.mx_noise_vec4,kf.mx_ramplr,kf.mx_ramptb,kf.mx_rgbtohsv,kf.mx_safepower,kf.mx_splitlr,kf.mx_splittb,kf.mx_srgb_texture_to_lin_rec709,kf.mx_transform_uv,kf.mx_worley_noise_float,kf.mx_worley_noise_vec2,kf.mx_worley_noise_vec3,kf.negate,kf.neutralToneMapping,kf.nodeArray,kf.nodeImmutable;const sx=kf.nodeObject;kf.nodeObjects,kf.nodeProxy,kf.normalFlat,kf.normalGeometry,kf.normalLocal,kf.normalMap,kf.normalView,kf.normalWorld,kf.normalize,kf.not,kf.notEqual,kf.numWorkgroups,kf.objectDirection,kf.objectGroup,kf.objectPosition,kf.objectRadius,kf.objectScale,kf.objectViewPosition,kf.objectWorldMatrix;const ix=kf.oneMinus;kf.or,kf.orthographicDepthToViewZ,kf.oscSawtooth,kf.oscSine,kf.oscSquare,kf.oscTriangle,kf.output,kf.outputStruct,kf.overlay,kf.overloadingFn,kf.parabola,kf.parallaxDirection,kf.parallaxUV,kf.parameter;const rx=kf.pass,nx=kf.passTexture;kf.pcurve,kf.perspectiveDepthToViewZ,kf.pmremTexture,kf.pointUV,kf.pointWidth,kf.positionGeometry,kf.positionLocal,kf.positionPrevious,kf.positionView,kf.positionViewDirection,kf.positionWorld,kf.positionWorldDirection,kf.posterize,kf.pow,kf.pow2,kf.pow3,kf.pow4,kf.property,kf.radians,kf.rand,kf.range,kf.rangeFog,kf.rangeFogFactor,kf.reciprocal,kf.lightProjectionUV,kf.reference,kf.referenceBuffer,kf.reflect,kf.reflectVector,kf.reflectView,kf.reflector,kf.refract,kf.refractVector,kf.refractView,kf.reinhardToneMapping,kf.remainder,kf.remap,kf.remapClamp,kf.renderGroup,kf.renderOutput,kf.rendererReference,kf.rotate,kf.rotateUV,kf.roughness,kf.round,kf.rtt,kf.sRGBTransferEOTF,kf.sRGBTransferOETF,kf.sampler,kf.saturate,kf.saturation,kf.screen,kf.screenCoordinate,kf.screenSize,kf.screenUV,kf.scriptable,kf.scriptableValue;const ax=kf.select;kf.setCurrentStack,kf.shaderStages,kf.shadow,kf.pointShadow,kf.shadowPositionWorld,kf.sharedUniformGroup,kf.shapeCircle,kf.sheen,kf.sheenRoughness,kf.shiftLeft,kf.shiftRight,kf.shininess,kf.sign,kf.sin,kf.sinc,kf.skinning,kf.skinningReference;const ox=kf.smoothstep;kf.smoothstepElement,kf.specularColor,kf.specularF90,kf.spherizeUV,kf.split,kf.spritesheetUV,kf.sqrt,kf.stack,kf.step,kf.storage,kf.storageBarrier,kf.storageObject,kf.storageTexture,kf.string,kf.struct;const hx=kf.sub;kf.subgroupIndex,kf.subgroupSize,kf.tan,kf.tangentGeometry,kf.tangentLocal,kf.tangentView,kf.tangentWorld,kf.temp;const lx=kf.texture;kf.texture3D,kf.textureBarrier,kf.textureBicubic,kf.textureCubeUV,kf.textureLoad,kf.textureSize,kf.textureStore,kf.thickness,kf.threshold,kf.time,kf.timerDelta,kf.timerGlobal,kf.timerLocal,kf.toOutputColorSpace,kf.toWorkingColorSpace,kf.toneMapping,kf.toneMappingExposure,kf.toonOutlinePass,kf.transformDirection,kf.transformNormal,kf.transformNormalToView,kf.transformedBentNormalView,kf.transformedBitangentView,kf.transformedBitangentWorld,kf.transformedClearcoatNormalView,kf.transformedNormalView,kf.transformedNormalWorld,kf.transformedTangentView,kf.transformedTangentWorld,kf.transmission,kf.transpose,kf.tri,kf.tri3,kf.triNoise3D,kf.triplanarTexture,kf.triplanarTextures,kf.trunc,kf.tslFn,kf.uint;const ux=kf.uniform,cx=kf.uniformArray;kf.uniformGroup,kf.uniforms,kf.userData;const dx=kf.uv;kf.uvec2,kf.uvec3,kf.uvec4,kf.Var,kf.varying,kf.varyingProperty;const px=kf.vec2,mx=kf.vec3,gx=kf.vec4;kf.vectorComponents,kf.velocity,kf.vertexColor,kf.vertexIndex,kf.vibrance,kf.viewZToLogarithmicDepth,kf.viewZToOrthographicDepth,kf.viewZToPerspectiveDepth,kf.viewport,kf.viewportBottomLeft,kf.viewportCoordinate,kf.viewportDepthTexture,kf.viewportLinearDepth,kf.viewportMipTexture,kf.viewportResolution,kf.viewportSafeUV,kf.viewportSharedTexture,kf.viewportSize,kf.viewportTexture,kf.viewportTopLeft,kf.viewportUV,kf.wgsl,kf.wgslFn,kf.workgroupArray,kf.workgroupBarrier,kf.workgroupId,kf.workingToColorSpace,kf.xor;const yx=new fm,fx=new D,xx=new D(1,0),bx=new D(0,1);let vx;class wx extends xi{static get type(){return"BloomNode"}constructor(t,e=1,s=0,i=0){super("vec4"),this.inputNode=t,this.strength=ux(e),this.radius=ux(s),this.threshold=ux(i),this.smoothWidth=ux(.01),this._renderTargetsHorizontal=[],this._renderTargetsVertical=[],this._nMips=5,this._renderTargetBright=new it(1,1,{depthBuffer:!1,type:c}),this._renderTargetBright.texture.name="UnrealBloomPass.bright",this._renderTargetBright.texture.generateMipmaps=!1;for(let t=0;t<this._nMips;t++){const e=new it(1,1,{depthBuffer:!1,type:c});e.texture.name="UnrealBloomPass.h"+t,e.texture.generateMipmaps=!1,this._renderTargetsHorizontal.push(e);const s=new it(1,1,{depthBuffer:!1,type:c});s.texture.name="UnrealBloomPass.v"+t,s.texture.generateMipmaps=!1,this._renderTargetsVertical.push(s)}this._compositeMaterial=null,this._highPassFilterMaterial=null,this._separableBlurMaterials=[],this._textureNodeBright=lx(this._renderTargetBright.texture),this._textureNodeBlur0=lx(this._renderTargetsVertical[0].texture),this._textureNodeBlur1=lx(this._renderTargetsVertical[1].texture),this._textureNodeBlur2=lx(this._renderTargetsVertical[2].texture),this._textureNodeBlur3=lx(this._renderTargetsVertical[3].texture),this._textureNodeBlur4=lx(this._renderTargetsVertical[4].texture),this._textureOutput=nx(this,this._renderTargetsHorizontal[0].texture),this.updateBeforeType=li.FRAME}getTextureNode(){return this._textureOutput}setSize(t,e){let s=Math.round(t/2),i=Math.round(e/2);this._renderTargetBright.setSize(s,i);for(let t=0;t<this._nMips;t++)this._renderTargetsHorizontal[t].setSize(s,i),this._renderTargetsVertical[t].setSize(s,i),this._separableBlurMaterials[t].invSize.value.set(1/s,1/i),s=Math.round(s/2),i=Math.round(i/2)}updateBefore(t){const{renderer:e}=t;vx=vy.resetRendererState(e,vx);const s=e.getDrawingBufferSize(fx);this.setSize(s.width,s.height),e.setRenderTarget(this._renderTargetBright),yx.material=this._highPassFilterMaterial,yx.render(e);let i=this._renderTargetBright;for(let t=0;t<this._nMips;t++)yx.material=this._separableBlurMaterials[t],this._separableBlurMaterials[t].colorTexture.value=i.texture,this._separableBlurMaterials[t].direction.value=xx,e.setRenderTarget(this._renderTargetsHorizontal[t]),yx.render(e),this._separableBlurMaterials[t].colorTexture.value=this._renderTargetsHorizontal[t].texture,this._separableBlurMaterials[t].direction.value=bx,e.setRenderTarget(this._renderTargetsVertical[t]),yx.render(e),i=this._renderTargetsVertical[t];e.setRenderTarget(this._renderTargetsHorizontal[0]),yx.material=this._compositeMaterial,yx.render(e),vy.restoreRendererState(e,vx)}setup(t){const e=jf(()=>{const t=this.inputNode,e=Jf(t.rgb),s=ox(this.threshold,this.threshold.add(this.smoothWidth),e);return Qf(gx(0),t,s)});this._highPassFilterMaterial=this._highPassFilterMaterial||new Kc,this._highPassFilterMaterial.fragmentNode=e().context(t.getSharedContext()),this._highPassFilterMaterial.name="Bloom_highPass",this._highPassFilterMaterial.needsUpdate=!0;const s=[3,5,7,9,11];for(let e=0;e<this._nMips;e++)this._separableBlurMaterials.push(this._getSeparableBlurMaterial(t,s[e]));const i=cx([1,.8,.6,.4,.2]),r=cx([new at(1,1,1),new at(1,1,1),new at(1,1,1),new at(1,1,1),new at(1,1,1)]),n=jf(([t,e])=>{const s=$f(1.2).sub(t);return Qf(t,s,e)}).setLayout({name:"lerpBloomFactor",type:"float",inputs:[{name:"factor",type:"float"},{name:"radius",type:"float"}]}),a=jf(()=>{const t=n(i.element(0),this.radius).mul(gx(r.element(0),1)).mul(this._textureNodeBlur0),e=n(i.element(1),this.radius).mul(gx(r.element(1),1)).mul(this._textureNodeBlur1),s=n(i.element(2),this.radius).mul(gx(r.element(2),1)).mul(this._textureNodeBlur2),a=n(i.element(3),this.radius).mul(gx(r.element(3),1)).mul(this._textureNodeBlur3),o=n(i.element(4),this.radius).mul(gx(r.element(4),1)).mul(this._textureNodeBlur4);return t.add(e).add(s).add(a).add(o).mul(this.strength)});return this._compositeMaterial=this._compositeMaterial||new Kc,this._compositeMaterial.fragmentNode=a().context(t.getSharedContext()),this._compositeMaterial.name="Bloom_comp",this._compositeMaterial.needsUpdate=!0,this._textureOutput}dispose(){for(let t=0;t<this._renderTargetsHorizontal.length;t++)this._renderTargetsHorizontal[t].dispose();for(let t=0;t<this._renderTargetsVertical.length;t++)this._renderTargetsVertical[t].dispose();this._renderTargetBright.dispose()}_getSeparableBlurMaterial(t,e){const s=[];for(let t=0;t<e;t++)s.push(.39894*Math.exp(-.5*t*t/(e*e))/e);const i=lx(),r=cx(s),n=ux(new D),a=ux(new D(.5,.5)),o=dx(),h=t=>i.sample(t),l=jf(()=>{const t=r.element(0).toVar(),s=h(o).rgb.mul(t).toVar();return qf({start:Zf(1),end:Zf(e),type:"int",condition:"<"},({i:e})=>{const i=$f(e),l=r.element(e),u=a.mul(n).mul(i),c=h(o.add(u)).rgb,d=h(o.sub(u)).rgb;s.addAssign(Xf(c,d).mul(l)),t.addAssign($f(2).mul(l))}),gx(s.div(t),1)}),u=new Kc;return u.fragmentNode=l().context(t.getSharedContext()),u.name="Bloom_separable",u.needsUpdate=!0,u.colorTexture=i,u.direction=a,u.invSize=n,u}}const Nx=(t,e,s,i)=>sx(new wx(sx(t),e,s,i));export{jf as Fn,Hf as ShaderNode,Gf as abs,Yf as blendScreen,Nx as bloom,$f as float,Kf as max,tx as mod,ex as mx_cell_noise_float,ix as oneMinus,rx as pass,ax as select,ox as smoothstep,hx as sub,lx as texture,ux as uniform,dx as uv,px as vec2,mx as vec3};
