const t=100,e=300,s=301,r=302,i=1e3,n=1001,a=1002,o=1003,h=1006,l=1008,u=1014,c=1015,d=1016,p=1023,m=1026,g=1027,y=1030,f=2300,x=2301,b=2302,v="srgb",N="srgb-linear",w="linear",T="srgb",M=7680,_=35044,S=35048,A=2e3,V=2001;class z{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const s=this._listeners;void 0===s[t]&&(s[t]=[]),-1===s[t].indexOf(e)&&s[t].push(e)}hasEventListener(t,e){const s=this._listeners;return void 0!==s&&(void 0!==s[t]&&-1!==s[t].indexOf(e))}removeEventListener(t,e){const s=this._listeners;if(void 0===s)return;const r=s[t];if(void 0!==r){const t=r.indexOf(e);-1!==t&&r.splice(t,1)}}dispatchEvent(t){const e=this._listeners;if(void 0===e)return;const s=e[t.type];if(void 0!==s){t.target=this;const e=s.slice(0);for(let s=0,r=e.length;s<r;s++)e[s].call(this,t);t.target=null}}}const C=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let I=1234567;const R=Math.PI/180,E=180/Math.PI;function L(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return(C[255&t]+C[t>>8&255]+C[t>>16&255]+C[t>>24&255]+"-"+C[255&e]+C[e>>8&255]+"-"+C[e>>16&15|64]+C[e>>24&255]+"-"+C[63&s|128]+C[s>>8&255]+"-"+C[s>>16&255]+C[s>>24&255]+C[255&r]+C[r>>8&255]+C[r>>16&255]+C[r>>24&255]).toLowerCase()}function O(t,e,s){return Math.max(e,Math.min(s,t))}function P(t,e){return(t%e+e)%e}function F(t,e,s){return(1-s)*t+s*e}function B(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return t/4294967295;case Uint16Array:return t/65535;case Uint8Array:return t/255;case Int32Array:return Math.max(t/2147483647,-1);case Int16Array:return Math.max(t/32767,-1);case Int8Array:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}function k(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return Math.round(4294967295*t);case Uint16Array:return Math.round(65535*t);case Uint8Array:return Math.round(255*t);case Int32Array:return Math.round(2147483647*t);case Int16Array:return Math.round(32767*t);case Int8Array:return Math.round(127*t);default:throw new Error("Invalid component type.")}}const D={DEG2RAD:R,RAD2DEG:E,generateUUID:L,clamp:O,euclideanModulo:P,mapLinear:function(t,e,s,r,i){return r+(t-e)*(i-r)/(s-e)},inverseLerp:function(t,e,s){return t!==e?(s-t)/(e-t):0},lerp:F,damp:function(t,e,s,r){return F(t,e,1-Math.exp(-s*r))},pingpong:function(t,e=1){return e-Math.abs(P(t,2*e)-e)},smoothstep:function(t,e,s){return t<=e?0:t>=s?1:(t=(t-e)/(s-e))*t*(3-2*t)},smootherstep:function(t,e,s){return t<=e?0:t>=s?1:(t=(t-e)/(s-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},seededRandom:function(t){void 0!==t&&(I=t);let e=I+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296},degToRad:function(t){return t*R},radToDeg:function(t){return t*E},isPowerOfTwo:function(t){return!(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},setQuaternionFromProperEuler:function(t,e,s,r,i){const n=Math.cos,a=Math.sin,o=n(s/2),h=a(s/2),l=n((e+r)/2),u=a((e+r)/2),c=n((e-r)/2),d=a((e-r)/2),p=n((r-e)/2),m=a((r-e)/2);switch(i){case"XYX":t.set(o*u,h*c,h*d,o*l);break;case"YZY":t.set(h*d,o*u,h*c,o*l);break;case"ZXZ":t.set(h*c,h*d,o*u,o*l);break;case"XZX":t.set(o*u,h*m,h*p,o*l);break;case"YXY":t.set(h*p,o*u,h*m,o*l);break;case"ZYZ":t.set(h*m,h*p,o*u,o*l)}},normalize:k,denormalize:B};class U{constructor(t=0,e=0){U.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,s=this.y,r=t.elements;return this.x=r[0]*e+r[3]*s+r[6],this.y=r[1]*e+r[4]*s+r[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=O(this.x,t.x,e.x),this.y=O(this.y,t.y,e.y),this}clampScalar(t,e){return this.x=O(this.x,t,e),this.y=O(this.y,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(O(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(O(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y;return e*e+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const s=Math.cos(e),r=Math.sin(e),i=this.x-t.x,n=this.y-t.y;return this.x=i*s-n*r+t.x,this.y=i*r+n*s+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class W{constructor(t=0,e=0,s=0,r=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=s,this._w=r}static slerpFlat(t,e,s,r,i,n,a){let o=s[r+0],h=s[r+1],l=s[r+2],u=s[r+3];const c=i[n+0],d=i[n+1],p=i[n+2],m=i[n+3];if(0===a)return t[e+0]=o,t[e+1]=h,t[e+2]=l,void(t[e+3]=u);if(1===a)return t[e+0]=c,t[e+1]=d,t[e+2]=p,void(t[e+3]=m);if(u!==m||o!==c||h!==d||l!==p){let t=1-a;const e=o*c+h*d+l*p+u*m,s=e>=0?1:-1,r=1-e*e;if(r>Number.EPSILON){const i=Math.sqrt(r),n=Math.atan2(i,e*s);t=Math.sin(t*n)/i,a=Math.sin(a*n)/i}const i=a*s;if(o=o*t+c*i,h=h*t+d*i,l=l*t+p*i,u=u*t+m*i,t===1-a){const t=1/Math.sqrt(o*o+h*h+l*l+u*u);o*=t,h*=t,l*=t,u*=t}}t[e]=o,t[e+1]=h,t[e+2]=l,t[e+3]=u}static multiplyQuaternionsFlat(t,e,s,r,i,n){const a=s[r],o=s[r+1],h=s[r+2],l=s[r+3],u=i[n],c=i[n+1],d=i[n+2],p=i[n+3];return t[e]=a*p+l*u+o*d-h*c,t[e+1]=o*p+l*c+h*u-a*d,t[e+2]=h*p+l*d+a*c-o*u,t[e+3]=l*p-a*u-o*c-h*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,s,r){return this._x=t,this._y=e,this._z=s,this._w=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const s=t._x,r=t._y,i=t._z,n=t._order,a=Math.cos,o=Math.sin,h=a(s/2),l=a(r/2),u=a(i/2),c=o(s/2),d=o(r/2),p=o(i/2);switch(n){case"XYZ":this._x=c*l*u+h*d*p,this._y=h*d*u-c*l*p,this._z=h*l*p+c*d*u,this._w=h*l*u-c*d*p;break;case"YXZ":this._x=c*l*u+h*d*p,this._y=h*d*u-c*l*p,this._z=h*l*p-c*d*u,this._w=h*l*u+c*d*p;break;case"ZXY":this._x=c*l*u-h*d*p,this._y=h*d*u+c*l*p,this._z=h*l*p+c*d*u,this._w=h*l*u-c*d*p;break;case"ZYX":this._x=c*l*u-h*d*p,this._y=h*d*u+c*l*p,this._z=h*l*p-c*d*u,this._w=h*l*u+c*d*p;break;case"YZX":this._x=c*l*u+h*d*p,this._y=h*d*u+c*l*p,this._z=h*l*p-c*d*u,this._w=h*l*u-c*d*p;break;case"XZY":this._x=c*l*u-h*d*p,this._y=h*d*u-c*l*p,this._z=h*l*p+c*d*u,this._w=h*l*u+c*d*p}return!0===e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const s=e/2,r=Math.sin(s);return this._x=t.x*r,this._y=t.y*r,this._z=t.z*r,this._w=Math.cos(s),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,s=e[0],r=e[4],i=e[8],n=e[1],a=e[5],o=e[9],h=e[2],l=e[6],u=e[10],c=s+a+u;if(c>0){const t=.5/Math.sqrt(c+1);this._w=.25/t,this._x=(l-o)*t,this._y=(i-h)*t,this._z=(n-r)*t}else if(s>a&&s>u){const t=2*Math.sqrt(1+s-a-u);this._w=(l-o)/t,this._x=.25*t,this._y=(r+n)/t,this._z=(i+h)/t}else if(a>u){const t=2*Math.sqrt(1+a-s-u);this._w=(i-h)/t,this._x=(r+n)/t,this._y=.25*t,this._z=(o+l)/t}else{const t=2*Math.sqrt(1+u-s-a);this._w=(n-r)/t,this._x=(i+h)/t,this._y=(o+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let s=t.dot(e)+1;return s<1e-8?(s=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=s):(this._x=0,this._y=-t.z,this._z=t.y,this._w=s)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=s),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(O(this.dot(t),-1,1)))}rotateTowards(t,e){const s=this.angleTo(t);if(0===s)return this;const r=Math.min(1,e/s);return this.slerp(t,r),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const s=t._x,r=t._y,i=t._z,n=t._w,a=e._x,o=e._y,h=e._z,l=e._w;return this._x=s*l+n*a+r*h-i*o,this._y=r*l+n*o+i*a-s*h,this._z=i*l+n*h+s*o-r*a,this._w=n*l-s*a-r*o-i*h,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const s=this._x,r=this._y,i=this._z,n=this._w;let a=n*t._w+s*t._x+r*t._y+i*t._z;if(a<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),a>=1)return this._w=n,this._x=s,this._y=r,this._z=i,this;const o=1-a*a;if(o<=Number.EPSILON){const t=1-e;return this._w=t*n+e*this._w,this._x=t*s+e*this._x,this._y=t*r+e*this._y,this._z=t*i+e*this._z,this.normalize(),this}const h=Math.sqrt(o),l=Math.atan2(h,a),u=Math.sin((1-e)*l)/h,c=Math.sin(e*l)/h;return this._w=n*u+this._w*c,this._x=s*u+this._x*c,this._y=r*u+this._y*c,this._z=i*u+this._z*c,this._onChangeCallback(),this}slerpQuaternions(t,e,s){return this.copy(t).slerp(e,s)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),s=Math.random(),r=Math.sqrt(1-s),i=Math.sqrt(s);return this.set(r*Math.sin(t),r*Math.cos(t),i*Math.sin(e),i*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class j{constructor(t=0,e=0,s=0){j.prototype.isVector3=!0,this.x=t,this.y=e,this.z=s}set(t,e,s){return void 0===s&&(s=this.z),this.x=t,this.y=e,this.z=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(H.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(H.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,s=this.y,r=this.z,i=t.elements;return this.x=i[0]*e+i[3]*s+i[6]*r,this.y=i[1]*e+i[4]*s+i[7]*r,this.z=i[2]*e+i[5]*s+i[8]*r,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,s=this.y,r=this.z,i=t.elements,n=1/(i[3]*e+i[7]*s+i[11]*r+i[15]);return this.x=(i[0]*e+i[4]*s+i[8]*r+i[12])*n,this.y=(i[1]*e+i[5]*s+i[9]*r+i[13])*n,this.z=(i[2]*e+i[6]*s+i[10]*r+i[14])*n,this}applyQuaternion(t){const e=this.x,s=this.y,r=this.z,i=t.x,n=t.y,a=t.z,o=t.w,h=2*(n*r-a*s),l=2*(a*e-i*r),u=2*(i*s-n*e);return this.x=e+o*h+n*u-a*l,this.y=s+o*l+a*h-i*u,this.z=r+o*u+i*l-n*h,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,s=this.y,r=this.z,i=t.elements;return this.x=i[0]*e+i[4]*s+i[8]*r,this.y=i[1]*e+i[5]*s+i[9]*r,this.z=i[2]*e+i[6]*s+i[10]*r,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=O(this.x,t.x,e.x),this.y=O(this.y,t.y,e.y),this.z=O(this.z,t.z,e.z),this}clampScalar(t,e){return this.x=O(this.x,t,e),this.y=O(this.y,t,e),this.z=O(this.z,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(O(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const s=t.x,r=t.y,i=t.z,n=e.x,a=e.y,o=e.z;return this.x=r*o-i*a,this.y=i*n-s*o,this.z=s*a-r*n,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const s=t.dot(this)/e;return this.copy(t).multiplyScalar(s)}projectOnPlane(t){return q.copy(this).projectOnVector(t),this.sub(q)}reflect(t){return this.sub(q.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(O(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y,r=this.z-t.z;return e*e+s*s+r*r}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,s){const r=Math.sin(e)*t;return this.x=r*Math.sin(s),this.y=Math.cos(e)*t,this.z=r*Math.cos(s),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,s){return this.x=t*Math.sin(e),this.y=s,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),s=this.setFromMatrixColumn(t,1).length(),r=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=s,this.z=r,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=2*Math.random()-1,s=Math.sqrt(1-e*e);return this.x=s*Math.cos(t),this.y=e,this.z=s*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const q=new j,H=new W;class G{constructor(t,e,s,r,i,n,a,o,h){G.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,e,s,r,i,n,a,o,h)}set(t,e,s,r,i,n,a,o,h){const l=this.elements;return l[0]=t,l[1]=r,l[2]=a,l[3]=e,l[4]=i,l[5]=o,l[6]=s,l[7]=n,l[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this}extractBasis(t,e,s){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),s.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,r=e.elements,i=this.elements,n=s[0],a=s[3],o=s[6],h=s[1],l=s[4],u=s[7],c=s[2],d=s[5],p=s[8],m=r[0],g=r[3],y=r[6],f=r[1],x=r[4],b=r[7],v=r[2],N=r[5],w=r[8];return i[0]=n*m+a*f+o*v,i[3]=n*g+a*x+o*N,i[6]=n*y+a*b+o*w,i[1]=h*m+l*f+u*v,i[4]=h*g+l*x+u*N,i[7]=h*y+l*b+u*w,i[2]=c*m+d*f+p*v,i[5]=c*g+d*x+p*N,i[8]=c*y+d*b+p*w,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[1],r=t[2],i=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8];return e*n*l-e*a*h-s*i*l+s*a*o+r*i*h-r*n*o}invert(){const t=this.elements,e=t[0],s=t[1],r=t[2],i=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],u=l*n-a*h,c=a*o-l*i,d=h*i-n*o,p=e*u+s*c+r*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const m=1/p;return t[0]=u*m,t[1]=(r*h-l*s)*m,t[2]=(a*s-r*n)*m,t[3]=c*m,t[4]=(l*e-r*o)*m,t[5]=(r*i-a*e)*m,t[6]=d*m,t[7]=(s*o-h*e)*m,t[8]=(n*e-s*i)*m,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,s,r,i,n,a){const o=Math.cos(i),h=Math.sin(i);return this.set(s*o,s*h,-s*(o*n+h*a)+n+t,-r*h,r*o,-r*(-h*n+o*a)+a+e,0,0,1),this}scale(t,e){return this.premultiply(X.makeScale(t,e)),this}rotate(t){return this.premultiply(X.makeRotation(-t)),this}translate(t,e){return this.premultiply(X.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,s,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<9;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e=0){for(let s=0;s<9;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}const X=new G;Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array;function Y(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)}const Z={};function $(t){t in Z||(Z[t]=!0)}const J=(new G).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),K=(new G).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function Q(){const t={enabled:!0,workingColorSpace:N,spaces:{},convert:function(t,e,s){return!1!==this.enabled&&e!==s&&e&&s?(this.spaces[e].transfer===T&&(t.r=et(t.r),t.g=et(t.g),t.b=et(t.b)),this.spaces[e].primaries!==this.spaces[s].primaries&&(t.applyMatrix3(this.spaces[e].toXYZ),t.applyMatrix3(this.spaces[s].fromXYZ)),this.spaces[s].transfer===T&&(t.r=st(t.r),t.g=st(t.g),t.b=st(t.b)),t):t},workingToColorSpace:function(t,e){return this.convert(t,this.workingColorSpace,e)},colorSpaceToWorking:function(t,e){return this.convert(t,e,this.workingColorSpace)},getPrimaries:function(t){return this.spaces[t].primaries},getTransfer:function(t){return""===t?w:this.spaces[t].transfer},getLuminanceCoefficients:function(t,e=this.workingColorSpace){return t.fromArray(this.spaces[e].luminanceCoefficients)},define:function(t){Object.assign(this.spaces,t)},_getMatrix:function(t,e,s){return t.copy(this.spaces[e].toXYZ).multiply(this.spaces[s].fromXYZ)},_getDrawingBufferColorSpace:function(t){return this.spaces[t].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(t=this.workingColorSpace){return this.spaces[t].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(e,s){return $("THREE.ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),t.workingToColorSpace(e,s)},toWorkingColorSpace:function(e,s){return $("THREE.ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),t.colorSpaceToWorking(e,s)}},e=[.64,.33,.3,.6,.15,.06],s=[.2126,.7152,.0722],r=[.3127,.329];return t.define({[N]:{primaries:e,whitePoint:r,transfer:w,toXYZ:J,fromXYZ:K,luminanceCoefficients:s,workingColorSpaceConfig:{unpackColorSpace:v},outputColorSpaceConfig:{drawingBufferColorSpace:v}},[v]:{primaries:e,whitePoint:r,transfer:T,toXYZ:J,fromXYZ:K,luminanceCoefficients:s,outputColorSpaceConfig:{drawingBufferColorSpace:v}}}),t}const tt=Q();function et(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function st(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}let rt;class it{static getDataURL(t,e="image/png"){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let s;if(t instanceof HTMLCanvasElement)s=t;else{void 0===rt&&(rt=Y("canvas")),rt.width=t.width,rt.height=t.height;const e=rt.getContext("2d");t instanceof ImageData?e.putImageData(t,0,0):e.drawImage(t,0,0,t.width,t.height),s=rt}return s.toDataURL(e)}static sRGBToLinear(t){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const e=Y("canvas");e.width=t.width,e.height=t.height;const s=e.getContext("2d");s.drawImage(t,0,0,t.width,t.height);const r=s.getImageData(0,0,t.width,t.height),i=r.data;for(let t=0;t<i.length;t++)i[t]=255*et(i[t]/255);return s.putImageData(r,0,0),e}if(t.data){const e=t.data.slice(0);for(let t=0;t<e.length;t++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[t]=Math.floor(255*et(e[t]/255)):e[t]=et(e[t]);return{data:e,width:t.width,height:t.height}}return t}}let nt=0;class at{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:nt++}),this.uuid=L(),this.data=t,this.dataReady=!0,this.version=0}getSize(t){const e=this.data;return e instanceof HTMLVideoElement?t.set(e.videoWidth,e.videoHeight,0):e instanceof VideoFrame?t.set(e.displayHeight,e.displayWidth,0):null!==e?t.set(e.width,e.height,e.depth||0):t.set(0,0,0),t}set needsUpdate(t){!0===t&&this.version++}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.images[this.uuid])return t.images[this.uuid];const s={uuid:this.uuid,url:""},r=this.data;if(null!==r){let t;if(Array.isArray(r)){t=[];for(let e=0,s=r.length;e<s;e++)r[e].isDataTexture?t.push(ot(r[e].image)):t.push(ot(r[e]))}else t=ot(r);s.url=t}return e||(t.images[this.uuid]=s),s}}function ot(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?it.getDataURL(t):t.data?{data:Array.from(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:{}}let ht=0;const lt=new j;class ut extends z{constructor(t=ut.DEFAULT_IMAGE,e=ut.DEFAULT_MAPPING,s=1001,r=1001,i=1006,n=1008,a=1023,o=1009,h=ut.DEFAULT_ANISOTROPY,l=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:ht++}),this.uuid=L(),this.name="",this.source=new at(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=s,this.wrapT=r,this.magFilter=i,this.minFilter=n,this.anisotropy=h,this.format=a,this.internalFormat=null,this.type=o,this.offset=new U(0,0),this.repeat=new U(1,1),this.center=new U(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new G,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=l,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(t&&t.depth&&t.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(lt).x}get height(){return this.source.getSize(lt).y}get depth(){return this.source.getSize(lt).z}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.renderTarget=t.renderTarget,this.isRenderTargetTexture=t.isRenderTargetTexture,this.isArrayTexture=t.isArrayTexture,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}setValues(t){for(const e in t){const s=t[e];if(void 0===s)continue;const r=this[e];void 0!==r&&(r&&s&&r.isVector2&&s.isVector2||r&&s&&r.isVector3&&s.isVector3||r&&s&&r.isMatrix3&&s.isMatrix3?r.copy(s):this[e]=s)}}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const s={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(s.userData=this.userData),e||(t.textures[this.uuid]=s),s}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(this.mapping!==e)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case i:t.x=t.x-Math.floor(t.x);break;case n:t.x=t.x<0?0:1;break;case a:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case i:t.y=t.y-Math.floor(t.y);break;case n:t.y=t.y<0?0:1;break;case a:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){!0===t&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){!0===t&&this.pmremVersion++}}ut.DEFAULT_IMAGE=null,ut.DEFAULT_MAPPING=e,ut.DEFAULT_ANISOTROPY=1;class ct{constructor(t=0,e=0,s=0,r=1){ct.prototype.isVector4=!0,this.x=t,this.y=e,this.z=s,this.w=r}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,s,r){return this.x=t,this.y=e,this.z=s,this.w=r,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,s=this.y,r=this.z,i=this.w,n=t.elements;return this.x=n[0]*e+n[4]*s+n[8]*r+n[12]*i,this.y=n[1]*e+n[5]*s+n[9]*r+n[13]*i,this.z=n[2]*e+n[6]*s+n[10]*r+n[14]*i,this.w=n[3]*e+n[7]*s+n[11]*r+n[15]*i,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,s,r,i;const n=.01,a=.1,o=t.elements,h=o[0],l=o[4],u=o[8],c=o[1],d=o[5],p=o[9],m=o[2],g=o[6],y=o[10];if(Math.abs(l-c)<n&&Math.abs(u-m)<n&&Math.abs(p-g)<n){if(Math.abs(l+c)<a&&Math.abs(u+m)<a&&Math.abs(p+g)<a&&Math.abs(h+d+y-3)<a)return this.set(1,0,0,0),this;e=Math.PI;const t=(h+1)/2,o=(d+1)/2,f=(y+1)/2,x=(l+c)/4,b=(u+m)/4,v=(p+g)/4;return t>o&&t>f?t<n?(s=0,r=.707106781,i=.707106781):(s=Math.sqrt(t),r=x/s,i=b/s):o>f?o<n?(s=.707106781,r=0,i=.707106781):(r=Math.sqrt(o),s=x/r,i=v/r):f<n?(s=.707106781,r=.707106781,i=0):(i=Math.sqrt(f),s=b/i,r=v/i),this.set(s,r,i,e),this}let f=Math.sqrt((g-p)*(g-p)+(u-m)*(u-m)+(c-l)*(c-l));return Math.abs(f)<.001&&(f=1),this.x=(g-p)/f,this.y=(u-m)/f,this.z=(c-l)/f,this.w=Math.acos((h+d+y-1)/2),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this.w=e[15],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=O(this.x,t.x,e.x),this.y=O(this.y,t.y,e.y),this.z=O(this.z,t.z,e.z),this.w=O(this.w,t.w,e.w),this}clampScalar(t,e){return this.x=O(this.x,t,e),this.y=O(this.y,t,e),this.z=O(this.z,t,e),this.w=O(this.w,t,e),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(O(s,t,e))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this.w=t.w+(e.w-t.w)*s,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class dt extends z{constructor(t=1,e=1,s={}){super(),s=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:h,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},s),this.isRenderTarget=!0,this.width=t,this.height=e,this.depth=s.depth,this.scissor=new ct(0,0,t,e),this.scissorTest=!1,this.viewport=new ct(0,0,t,e);const r={width:t,height:e,depth:s.depth},i=new ut(r);this.textures=[];const n=s.count;for(let t=0;t<n;t++)this.textures[t]=i.clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;this._setTextureOptions(s),this.depthBuffer=s.depthBuffer,this.stencilBuffer=s.stencilBuffer,this.resolveDepthBuffer=s.resolveDepthBuffer,this.resolveStencilBuffer=s.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=s.depthTexture,this.samples=s.samples,this.multiview=s.multiview}_setTextureOptions(t={}){const e={minFilter:h,generateMipmaps:!1,flipY:!1,internalFormat:null};void 0!==t.mapping&&(e.mapping=t.mapping),void 0!==t.wrapS&&(e.wrapS=t.wrapS),void 0!==t.wrapT&&(e.wrapT=t.wrapT),void 0!==t.wrapR&&(e.wrapR=t.wrapR),void 0!==t.magFilter&&(e.magFilter=t.magFilter),void 0!==t.minFilter&&(e.minFilter=t.minFilter),void 0!==t.format&&(e.format=t.format),void 0!==t.type&&(e.type=t.type),void 0!==t.anisotropy&&(e.anisotropy=t.anisotropy),void 0!==t.colorSpace&&(e.colorSpace=t.colorSpace),void 0!==t.flipY&&(e.flipY=t.flipY),void 0!==t.generateMipmaps&&(e.generateMipmaps=t.generateMipmaps),void 0!==t.internalFormat&&(e.internalFormat=t.internalFormat);for(let t=0;t<this.textures.length;t++){this.textures[t].setValues(e)}}get texture(){return this.textures[0]}set texture(t){this.textures[0]=t}set depthTexture(t){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==t&&(t.renderTarget=this),this._depthTexture=t}get depthTexture(){return this._depthTexture}setSize(t,e,s=1){if(this.width!==t||this.height!==e||this.depth!==s){this.width=t,this.height=e,this.depth=s;for(let r=0,i=this.textures.length;r<i;r++)this.textures[r].image.width=t,this.textures[r].image.height=e,this.textures[r].image.depth=s,this.textures[r].isArrayTexture=this.textures[r].image.depth>1;this.dispose()}this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)}clone(){return(new this.constructor).copy(this)}copy(t){this.width=t.width,this.height=t.height,this.depth=t.depth,this.scissor.copy(t.scissor),this.scissorTest=t.scissorTest,this.viewport.copy(t.viewport),this.textures.length=0;for(let e=0,s=t.textures.length;e<s;e++){this.textures[e]=t.textures[e].clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;const s=Object.assign({},t.textures[e].image);this.textures[e].source=new at(s)}return this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.resolveDepthBuffer=t.resolveDepthBuffer,this.resolveStencilBuffer=t.resolveStencilBuffer,null!==t.depthTexture&&(this.depthTexture=t.depthTexture.clone()),this.samples=t.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class pt extends ut{constructor(t=null,e=1,s=1,r=1){super(null),this.isDataArrayTexture=!0,this.image={data:t,width:e,height:s,depth:r},this.magFilter=o,this.minFilter=o,this.wrapR=n,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(t){this.layerUpdates.add(t)}clearLayerUpdates(){this.layerUpdates.clear()}}class mt{constructor(t=new j(1/0,1/0,1/0),e=new j(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e+=3)this.expandByPoint(yt.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,s=t.count;e<s;e++)this.expandByPoint(yt.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const s=yt.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(s),this.max.copy(t).add(s),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const s=t.geometry;if(void 0!==s){const r=s.getAttribute("position");if(!0===e&&void 0!==r&&!0!==t.isInstancedMesh)for(let e=0,s=r.count;e<s;e++)!0===t.isMesh?t.getVertexPosition(e,yt):yt.fromBufferAttribute(r,e),yt.applyMatrix4(t.matrixWorld),this.expandByPoint(yt);else void 0!==t.boundingBox?(null===t.boundingBox&&t.computeBoundingBox(),ft.copy(t.boundingBox)):(null===s.boundingBox&&s.computeBoundingBox(),ft.copy(s.boundingBox)),ft.applyMatrix4(t.matrixWorld),this.union(ft)}const r=t.children;for(let t=0,s=r.length;t<s;t++)this.expandByObject(r[t],e);return this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y&&t.max.z>=this.min.z&&t.min.z<=this.max.z}intersectsSphere(t){return this.clampPoint(t.center,yt),yt.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,s;return t.normal.x>0?(e=t.normal.x*this.min.x,s=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,s=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,s+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,s+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,s+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,s+=t.normal.z*this.min.z),e<=-t.constant&&s>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(Mt),_t.subVectors(this.max,Mt),xt.subVectors(t.a,Mt),bt.subVectors(t.b,Mt),vt.subVectors(t.c,Mt),Nt.subVectors(bt,xt),wt.subVectors(vt,bt),Tt.subVectors(xt,vt);let e=[0,-Nt.z,Nt.y,0,-wt.z,wt.y,0,-Tt.z,Tt.y,Nt.z,0,-Nt.x,wt.z,0,-wt.x,Tt.z,0,-Tt.x,-Nt.y,Nt.x,0,-wt.y,wt.x,0,-Tt.y,Tt.x,0];return!!Vt(e,xt,bt,vt,_t)&&(e=[1,0,0,0,1,0,0,0,1],!!Vt(e,xt,bt,vt,_t)&&(St.crossVectors(Nt,wt),e=[St.x,St.y,St.z],Vt(e,xt,bt,vt,_t)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,yt).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=.5*this.getSize(yt).length()),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(gt[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),gt[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),gt[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),gt[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),gt[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),gt[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),gt[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),gt[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(gt)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(t){return this.min.fromArray(t.min),this.max.fromArray(t.max),this}}const gt=[new j,new j,new j,new j,new j,new j,new j,new j],yt=new j,ft=new mt,xt=new j,bt=new j,vt=new j,Nt=new j,wt=new j,Tt=new j,Mt=new j,_t=new j,St=new j,At=new j;function Vt(t,e,s,r,i){for(let n=0,a=t.length-3;n<=a;n+=3){At.fromArray(t,n);const a=i.x*Math.abs(At.x)+i.y*Math.abs(At.y)+i.z*Math.abs(At.z),o=e.dot(At),h=s.dot(At),l=r.dot(At);if(Math.max(-Math.max(o,h,l),Math.min(o,h,l))>a)return!1}return!0}const zt=new mt,Ct=new j,It=new j;class Rt{constructor(t=new j,e=-1){this.isSphere=!0,this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const s=this.center;void 0!==e?s.copy(e):zt.setFromPoints(t).getCenter(s);let r=0;for(let e=0,i=t.length;e<i;e++)r=Math.max(r,s.distanceToSquared(t[e]));return this.radius=Math.sqrt(r),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const s=this.center.distanceToSquared(t);return e.copy(t),s>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;Ct.subVectors(t,this.center);const e=Ct.lengthSq();if(e>this.radius*this.radius){const t=Math.sqrt(e),s=.5*(t-this.radius);this.center.addScaledVector(Ct,s/t),this.radius+=s}return this}union(t){return t.isEmpty()?this:this.isEmpty()?(this.copy(t),this):(!0===this.center.equals(t.center)?this.radius=Math.max(this.radius,t.radius):(It.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(Ct.copy(t.center).add(It)),this.expandByPoint(Ct.copy(t.center).sub(It))),this)}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(t){return this.radius=t.radius,this.center.fromArray(t.center),this}}const Et=new j,Lt=new j,Ot=new j,Pt=new j,Ft=new j,Bt=new j,kt=new j;class Dt{constructor(t=new j,e=new j(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return e.copy(this.origin).addScaledVector(this.direction,t)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,Et)),this}closestPointToPoint(t,e){e.subVectors(t,this.origin);const s=e.dot(this.direction);return s<0?e.copy(this.origin):e.copy(this.origin).addScaledVector(this.direction,s)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=Et.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(Et.copy(this.origin).addScaledVector(this.direction,e),Et.distanceToSquared(t))}distanceSqToSegment(t,e,s,r){Lt.copy(t).add(e).multiplyScalar(.5),Ot.copy(e).sub(t).normalize(),Pt.copy(this.origin).sub(Lt);const i=.5*t.distanceTo(e),n=-this.direction.dot(Ot),a=Pt.dot(this.direction),o=-Pt.dot(Ot),h=Pt.lengthSq(),l=Math.abs(1-n*n);let u,c,d,p;if(l>0)if(u=n*o-a,c=n*a-o,p=i*l,u>=0)if(c>=-p)if(c<=p){const t=1/l;u*=t,c*=t,d=u*(u+n*c+2*a)+c*(n*u+c+2*o)+h}else c=i,u=Math.max(0,-(n*c+a)),d=-u*u+c*(c+2*o)+h;else c=-i,u=Math.max(0,-(n*c+a)),d=-u*u+c*(c+2*o)+h;else c<=-p?(u=Math.max(0,-(-n*i+a)),c=u>0?-i:Math.min(Math.max(-i,-o),i),d=-u*u+c*(c+2*o)+h):c<=p?(u=0,c=Math.min(Math.max(-i,-o),i),d=c*(c+2*o)+h):(u=Math.max(0,-(n*i+a)),c=u>0?i:Math.min(Math.max(-i,-o),i),d=-u*u+c*(c+2*o)+h);else c=n>0?-i:i,u=Math.max(0,-(n*c+a)),d=-u*u+c*(c+2*o)+h;return s&&s.copy(this.origin).addScaledVector(this.direction,u),r&&r.copy(Lt).addScaledVector(Ot,c),d}intersectSphere(t,e){Et.subVectors(t.center,this.origin);const s=Et.dot(this.direction),r=Et.dot(Et)-s*s,i=t.radius*t.radius;if(r>i)return null;const n=Math.sqrt(i-r),a=s-n,o=s+n;return o<0?null:a<0?this.at(o,e):this.at(a,e)}intersectsSphere(t){return!(t.radius<0)&&this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;const s=-(this.origin.dot(t.normal)+t.constant)/e;return s>=0?s:null}intersectPlane(t,e){const s=this.distanceToPlane(t);return null===s?null:this.at(s,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);if(0===e)return!0;return t.normal.dot(this.direction)*e<0}intersectBox(t,e){let s,r,i,n,a,o;const h=1/this.direction.x,l=1/this.direction.y,u=1/this.direction.z,c=this.origin;return h>=0?(s=(t.min.x-c.x)*h,r=(t.max.x-c.x)*h):(s=(t.max.x-c.x)*h,r=(t.min.x-c.x)*h),l>=0?(i=(t.min.y-c.y)*l,n=(t.max.y-c.y)*l):(i=(t.max.y-c.y)*l,n=(t.min.y-c.y)*l),s>n||i>r?null:((i>s||isNaN(s))&&(s=i),(n<r||isNaN(r))&&(r=n),u>=0?(a=(t.min.z-c.z)*u,o=(t.max.z-c.z)*u):(a=(t.max.z-c.z)*u,o=(t.min.z-c.z)*u),s>o||a>r?null:((a>s||s!=s)&&(s=a),(o<r||r!=r)&&(r=o),r<0?null:this.at(s>=0?s:r,e)))}intersectsBox(t){return null!==this.intersectBox(t,Et)}intersectTriangle(t,e,s,r,i){Ft.subVectors(e,t),Bt.subVectors(s,t),kt.crossVectors(Ft,Bt);let n,a=this.direction.dot(kt);if(a>0){if(r)return null;n=1}else{if(!(a<0))return null;n=-1,a=-a}Pt.subVectors(this.origin,t);const o=n*this.direction.dot(Bt.crossVectors(Pt,Bt));if(o<0)return null;const h=n*this.direction.dot(Ft.cross(Pt));if(h<0)return null;if(o+h>a)return null;const l=-n*Pt.dot(kt);return l<0?null:this.at(l/a,i)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class Ut{constructor(t,e,s,r,i,n,a,o,h,l,u,c,d,p,m,g){Ut.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,s,r,i,n,a,o,h,l,u,c,d,p,m,g)}set(t,e,s,r,i,n,a,o,h,l,u,c,d,p,m,g){const y=this.elements;return y[0]=t,y[4]=e,y[8]=s,y[12]=r,y[1]=i,y[5]=n,y[9]=a,y[13]=o,y[2]=h,y[6]=l,y[10]=u,y[14]=c,y[3]=d,y[7]=p,y[11]=m,y[15]=g,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Ut).fromArray(this.elements)}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],this}copyPosition(t){const e=this.elements,s=t.elements;return e[12]=s[12],e[13]=s[13],e[14]=s[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,s){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),s.setFromMatrixColumn(this,2),this}makeBasis(t,e,s){return this.set(t.x,e.x,s.x,0,t.y,e.y,s.y,0,t.z,e.z,s.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,s=t.elements,r=1/Wt.setFromMatrixColumn(t,0).length(),i=1/Wt.setFromMatrixColumn(t,1).length(),n=1/Wt.setFromMatrixColumn(t,2).length();return e[0]=s[0]*r,e[1]=s[1]*r,e[2]=s[2]*r,e[3]=0,e[4]=s[4]*i,e[5]=s[5]*i,e[6]=s[6]*i,e[7]=0,e[8]=s[8]*n,e[9]=s[9]*n,e[10]=s[10]*n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,s=t.x,r=t.y,i=t.z,n=Math.cos(s),a=Math.sin(s),o=Math.cos(r),h=Math.sin(r),l=Math.cos(i),u=Math.sin(i);if("XYZ"===t.order){const t=n*l,s=n*u,r=a*l,i=a*u;e[0]=o*l,e[4]=-o*u,e[8]=h,e[1]=s+r*h,e[5]=t-i*h,e[9]=-a*o,e[2]=i-t*h,e[6]=r+s*h,e[10]=n*o}else if("YXZ"===t.order){const t=o*l,s=o*u,r=h*l,i=h*u;e[0]=t+i*a,e[4]=r*a-s,e[8]=n*h,e[1]=n*u,e[5]=n*l,e[9]=-a,e[2]=s*a-r,e[6]=i+t*a,e[10]=n*o}else if("ZXY"===t.order){const t=o*l,s=o*u,r=h*l,i=h*u;e[0]=t-i*a,e[4]=-n*u,e[8]=r+s*a,e[1]=s+r*a,e[5]=n*l,e[9]=i-t*a,e[2]=-n*h,e[6]=a,e[10]=n*o}else if("ZYX"===t.order){const t=n*l,s=n*u,r=a*l,i=a*u;e[0]=o*l,e[4]=r*h-s,e[8]=t*h+i,e[1]=o*u,e[5]=i*h+t,e[9]=s*h-r,e[2]=-h,e[6]=a*o,e[10]=n*o}else if("YZX"===t.order){const t=n*o,s=n*h,r=a*o,i=a*h;e[0]=o*l,e[4]=i-t*u,e[8]=r*u+s,e[1]=u,e[5]=n*l,e[9]=-a*l,e[2]=-h*l,e[6]=s*u+r,e[10]=t-i*u}else if("XZY"===t.order){const t=n*o,s=n*h,r=a*o,i=a*h;e[0]=o*l,e[4]=-u,e[8]=h*l,e[1]=t*u+i,e[5]=n*l,e[9]=s*u-r,e[2]=r*u-s,e[6]=a*l,e[10]=i*u+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(qt,t,Ht)}lookAt(t,e,s){const r=this.elements;return Yt.subVectors(t,e),0===Yt.lengthSq()&&(Yt.z=1),Yt.normalize(),Gt.crossVectors(s,Yt),0===Gt.lengthSq()&&(1===Math.abs(s.z)?Yt.x+=1e-4:Yt.z+=1e-4,Yt.normalize(),Gt.crossVectors(s,Yt)),Gt.normalize(),Xt.crossVectors(Yt,Gt),r[0]=Gt.x,r[4]=Xt.x,r[8]=Yt.x,r[1]=Gt.y,r[5]=Xt.y,r[9]=Yt.y,r[2]=Gt.z,r[6]=Xt.z,r[10]=Yt.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,r=e.elements,i=this.elements,n=s[0],a=s[4],o=s[8],h=s[12],l=s[1],u=s[5],c=s[9],d=s[13],p=s[2],m=s[6],g=s[10],y=s[14],f=s[3],x=s[7],b=s[11],v=s[15],N=r[0],w=r[4],T=r[8],M=r[12],_=r[1],S=r[5],A=r[9],V=r[13],z=r[2],C=r[6],I=r[10],R=r[14],E=r[3],L=r[7],O=r[11],P=r[15];return i[0]=n*N+a*_+o*z+h*E,i[4]=n*w+a*S+o*C+h*L,i[8]=n*T+a*A+o*I+h*O,i[12]=n*M+a*V+o*R+h*P,i[1]=l*N+u*_+c*z+d*E,i[5]=l*w+u*S+c*C+d*L,i[9]=l*T+u*A+c*I+d*O,i[13]=l*M+u*V+c*R+d*P,i[2]=p*N+m*_+g*z+y*E,i[6]=p*w+m*S+g*C+y*L,i[10]=p*T+m*A+g*I+y*O,i[14]=p*M+m*V+g*R+y*P,i[3]=f*N+x*_+b*z+v*E,i[7]=f*w+x*S+b*C+v*L,i[11]=f*T+x*A+b*I+v*O,i[15]=f*M+x*V+b*R+v*P,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[4],r=t[8],i=t[12],n=t[1],a=t[5],o=t[9],h=t[13],l=t[2],u=t[6],c=t[10],d=t[14];return t[3]*(+i*o*u-r*h*u-i*a*c+s*h*c+r*a*d-s*o*d)+t[7]*(+e*o*d-e*h*c+i*n*c-r*n*d+r*h*l-i*o*l)+t[11]*(+e*h*u-e*a*d-i*n*u+s*n*d+i*a*l-s*h*l)+t[15]*(-r*a*l-e*o*u+e*a*c+r*n*u-s*n*c+s*o*l)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,s){const r=this.elements;return t.isVector3?(r[12]=t.x,r[13]=t.y,r[14]=t.z):(r[12]=t,r[13]=e,r[14]=s),this}invert(){const t=this.elements,e=t[0],s=t[1],r=t[2],i=t[3],n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],u=t[9],c=t[10],d=t[11],p=t[12],m=t[13],g=t[14],y=t[15],f=u*g*h-m*c*h+m*o*d-a*g*d-u*o*y+a*c*y,x=p*c*h-l*g*h-p*o*d+n*g*d+l*o*y-n*c*y,b=l*m*h-p*u*h+p*a*d-n*m*d-l*a*y+n*u*y,v=p*u*o-l*m*o-p*a*c+n*m*c+l*a*g-n*u*g,N=e*f+s*x+r*b+i*v;if(0===N)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/N;return t[0]=f*w,t[1]=(m*c*i-u*g*i-m*r*d+s*g*d+u*r*y-s*c*y)*w,t[2]=(a*g*i-m*o*i+m*r*h-s*g*h-a*r*y+s*o*y)*w,t[3]=(u*o*i-a*c*i-u*r*h+s*c*h+a*r*d-s*o*d)*w,t[4]=x*w,t[5]=(l*g*i-p*c*i+p*r*d-e*g*d-l*r*y+e*c*y)*w,t[6]=(p*o*i-n*g*i-p*r*h+e*g*h+n*r*y-e*o*y)*w,t[7]=(n*c*i-l*o*i+l*r*h-e*c*h-n*r*d+e*o*d)*w,t[8]=b*w,t[9]=(p*u*i-l*m*i-p*s*d+e*m*d+l*s*y-e*u*y)*w,t[10]=(n*m*i-p*a*i+p*s*h-e*m*h-n*s*y+e*a*y)*w,t[11]=(l*a*i-n*u*i-l*s*h+e*u*h+n*s*d-e*a*d)*w,t[12]=v*w,t[13]=(l*m*r-p*u*r+p*s*c-e*m*c-l*s*g+e*u*g)*w,t[14]=(p*a*r-n*m*r-p*s*o+e*m*o+n*s*g-e*a*g)*w,t[15]=(n*u*r-l*a*r+l*s*o-e*u*o-n*s*c+e*a*c)*w,this}scale(t){const e=this.elements,s=t.x,r=t.y,i=t.z;return e[0]*=s,e[4]*=r,e[8]*=i,e[1]*=s,e[5]*=r,e[9]*=i,e[2]*=s,e[6]*=r,e[10]*=i,e[3]*=s,e[7]*=r,e[11]*=i,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],r=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,s,r))}makeTranslation(t,e,s){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,s,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),s=Math.sin(t);return this.set(1,0,0,0,0,e,-s,0,0,s,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,0,s,0,0,1,0,0,-s,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,0,s,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const s=Math.cos(e),r=Math.sin(e),i=1-s,n=t.x,a=t.y,o=t.z,h=i*n,l=i*a;return this.set(h*n+s,h*a-r*o,h*o+r*a,0,h*a+r*o,l*a+s,l*o-r*n,0,h*o-r*a,l*o+r*n,i*o*o+s,0,0,0,0,1),this}makeScale(t,e,s){return this.set(t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1),this}makeShear(t,e,s,r,i,n){return this.set(1,s,i,0,t,1,n,0,e,r,1,0,0,0,0,1),this}compose(t,e,s){const r=this.elements,i=e._x,n=e._y,a=e._z,o=e._w,h=i+i,l=n+n,u=a+a,c=i*h,d=i*l,p=i*u,m=n*l,g=n*u,y=a*u,f=o*h,x=o*l,b=o*u,v=s.x,N=s.y,w=s.z;return r[0]=(1-(m+y))*v,r[1]=(d+b)*v,r[2]=(p-x)*v,r[3]=0,r[4]=(d-b)*N,r[5]=(1-(c+y))*N,r[6]=(g+f)*N,r[7]=0,r[8]=(p+x)*w,r[9]=(g-f)*w,r[10]=(1-(c+m))*w,r[11]=0,r[12]=t.x,r[13]=t.y,r[14]=t.z,r[15]=1,this}decompose(t,e,s){const r=this.elements;let i=Wt.set(r[0],r[1],r[2]).length();const n=Wt.set(r[4],r[5],r[6]).length(),a=Wt.set(r[8],r[9],r[10]).length();this.determinant()<0&&(i=-i),t.x=r[12],t.y=r[13],t.z=r[14],jt.copy(this);const o=1/i,h=1/n,l=1/a;return jt.elements[0]*=o,jt.elements[1]*=o,jt.elements[2]*=o,jt.elements[4]*=h,jt.elements[5]*=h,jt.elements[6]*=h,jt.elements[8]*=l,jt.elements[9]*=l,jt.elements[10]*=l,e.setFromRotationMatrix(jt),s.x=i,s.y=n,s.z=a,this}makePerspective(t,e,s,r,i,n,a=2e3,o=!1){const h=this.elements,l=2*i/(e-t),u=2*i/(s-r),c=(e+t)/(e-t),d=(s+r)/(s-r);let p,m;if(o)p=i/(n-i),m=n*i/(n-i);else if(a===A)p=-(n+i)/(n-i),m=-2*n*i/(n-i);else{if(a!==V)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);p=-n/(n-i),m=-n*i/(n-i)}return h[0]=l,h[4]=0,h[8]=c,h[12]=0,h[1]=0,h[5]=u,h[9]=d,h[13]=0,h[2]=0,h[6]=0,h[10]=p,h[14]=m,h[3]=0,h[7]=0,h[11]=-1,h[15]=0,this}makeOrthographic(t,e,s,r,i,n,a=2e3,o=!1){const h=this.elements,l=2/(e-t),u=2/(s-r),c=-(e+t)/(e-t),d=-(s+r)/(s-r);let p,m;if(o)p=1/(n-i),m=n/(n-i);else if(a===A)p=-2/(n-i),m=-(n+i)/(n-i);else{if(a!==V)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);p=-1/(n-i),m=-i/(n-i)}return h[0]=l,h[4]=0,h[8]=0,h[12]=c,h[1]=0,h[5]=u,h[9]=0,h[13]=d,h[2]=0,h[6]=0,h[10]=p,h[14]=m,h[3]=0,h[7]=0,h[11]=0,h[15]=1,this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<16;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e=0){for(let s=0;s<16;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t[e+9]=s[9],t[e+10]=s[10],t[e+11]=s[11],t[e+12]=s[12],t[e+13]=s[13],t[e+14]=s[14],t[e+15]=s[15],t}}const Wt=new j,jt=new Ut,qt=new j(0,0,0),Ht=new j(1,1,1),Gt=new j,Xt=new j,Yt=new j,Zt=new Ut,$t=new W;class Jt{constructor(t=0,e=0,s=0,r=Jt.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=s,this._order=r}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,s,r=this._order){return this._x=t,this._y=e,this._z=s,this._order=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,s=!0){const r=t.elements,i=r[0],n=r[4],a=r[8],o=r[1],h=r[5],l=r[9],u=r[2],c=r[6],d=r[10];switch(e){case"XYZ":this._y=Math.asin(O(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-l,d),this._z=Math.atan2(-n,i)):(this._x=Math.atan2(c,h),this._z=0);break;case"YXZ":this._x=Math.asin(-O(l,-1,1)),Math.abs(l)<.9999999?(this._y=Math.atan2(a,d),this._z=Math.atan2(o,h)):(this._y=Math.atan2(-u,i),this._z=0);break;case"ZXY":this._x=Math.asin(O(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(-u,d),this._z=Math.atan2(-n,h)):(this._y=0,this._z=Math.atan2(o,i));break;case"ZYX":this._y=Math.asin(-O(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(c,d),this._z=Math.atan2(o,i)):(this._x=0,this._z=Math.atan2(-n,h));break;case"YZX":this._z=Math.asin(O(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-l,h),this._y=Math.atan2(-u,i)):(this._x=0,this._y=Math.atan2(a,d));break;case"XZY":this._z=Math.asin(-O(n,-1,1)),Math.abs(n)<.9999999?(this._x=Math.atan2(c,h),this._y=Math.atan2(a,i)):(this._x=Math.atan2(-l,d),this._y=0)}return this._order=e,!0===s&&this._onChangeCallback(),this}setFromQuaternion(t,e,s){return Zt.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Zt,e,s)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return $t.setFromEuler(this),this.setFromQuaternion($t,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Jt.DEFAULT_ORDER="XYZ";class Kt{constructor(){this.mask=1}set(t){this.mask=1<<t>>>0}enable(t){this.mask|=1<<t}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t}disable(t){this.mask&=~(1<<t)}disableAll(){this.mask=0}test(t){return 0!==(this.mask&t.mask)}isEnabled(t){return!!(this.mask&1<<t)}}let Qt=0;const te=new j,ee=new W,se=new Ut,re=new j,ie=new j,ne=new j,ae=new W,oe=new j(1,0,0),he=new j(0,1,0),le=new j(0,0,1),ue={type:"added"},ce={type:"removed"},de={type:"childadded",child:null},pe={type:"childremoved",child:null};class me extends z{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Qt++}),this.uuid=L(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=me.DEFAULT_UP.clone();const t=new j,e=new Jt,s=new W,r=new j(1,1,1);e._onChange(function(){s.setFromEuler(e,!1)}),s._onChange(function(){e.setFromQuaternion(s,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:s},scale:{configurable:!0,enumerable:!0,value:r},modelViewMatrix:{value:new Ut},normalMatrix:{value:new G}}),this.matrix=new Ut,this.matrixWorld=new Ut,this.matrixAutoUpdate=me.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=me.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Kt,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return ee.setFromAxisAngle(t,e),this.quaternion.multiply(ee),this}rotateOnWorldAxis(t,e){return ee.setFromAxisAngle(t,e),this.quaternion.premultiply(ee),this}rotateX(t){return this.rotateOnAxis(oe,t)}rotateY(t){return this.rotateOnAxis(he,t)}rotateZ(t){return this.rotateOnAxis(le,t)}translateOnAxis(t,e){return te.copy(t).applyQuaternion(this.quaternion),this.position.add(te.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(oe,t)}translateY(t){return this.translateOnAxis(he,t)}translateZ(t){return this.translateOnAxis(le,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(se.copy(this.matrixWorld).invert())}lookAt(t,e,s){t.isVector3?re.copy(t):re.set(t,e,s);const r=this.parent;this.updateWorldMatrix(!0,!1),ie.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?se.lookAt(ie,re,this.up):se.lookAt(re,ie,this.up),this.quaternion.setFromRotationMatrix(se),r&&(se.extractRotation(r.matrixWorld),ee.setFromRotationMatrix(se),this.quaternion.premultiply(ee.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this||t&&t.isObject3D&&(t.removeFromParent(),t.parent=this,this.children.push(t),t.dispatchEvent(ue),de.child=t,this.dispatchEvent(de),de.child=null),this}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(ce),pe.child=t,this.dispatchEvent(pe),pe.child=null),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),se.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),se.multiply(t.parent.matrixWorld)),t.applyMatrix4(se),t.removeFromParent(),t.parent=this,this.children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(ue),de.child=t,this.dispatchEvent(de),de.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let s=0,r=this.children.length;s<r;s++){const r=this.children[s].getObjectByProperty(t,e);if(void 0!==r)return r}}getObjectsByProperty(t,e,s=[]){this[t]===e&&s.push(this);const r=this.children;for(let i=0,n=r.length;i<n;i++)r[i].getObjectsByProperty(t,e,s);return s}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ie,t,ne),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ie,ae,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let s=0,r=e.length;s<r;s++)e[s].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let s=0,r=e.length;s<r;s++)e[s].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let s=0,r=e.length;s<r;s++){e[s].updateMatrixWorld(t)}}updateWorldMatrix(t,e){const s=this.parent;if(!0===t&&null!==s&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===e){const t=this.children;for(let e=0,s=t.length;e<s;e++){t[e].updateWorldMatrix(!1,!0)}}}toJSON(t){const e=void 0===t||"string"==typeof t,s={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},s.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const r={};function i(e,s){return void 0===e[s.uuid]&&(e[s.uuid]=s.toJSON(t)),s.uuid}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),!0===this.castShadow&&(r.castShadow=!0),!0===this.receiveShadow&&(r.receiveShadow=!0),!1===this.visible&&(r.visible=!1),!1===this.frustumCulled&&(r.frustumCulled=!1),0!==this.renderOrder&&(r.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(r.userData=this.userData),r.layers=this.layers.mask,r.matrix=this.matrix.toArray(),r.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(r.matrixAutoUpdate=!1),this.isInstancedMesh&&(r.type="InstancedMesh",r.count=this.count,r.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(r.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(r.type="BatchedMesh",r.perObjectFrustumCulled=this.perObjectFrustumCulled,r.sortObjects=this.sortObjects,r.drawRanges=this._drawRanges,r.reservedRanges=this._reservedRanges,r.geometryInfo=this._geometryInfo.map(t=>({...t,boundingBox:t.boundingBox?t.boundingBox.toJSON():void 0,boundingSphere:t.boundingSphere?t.boundingSphere.toJSON():void 0})),r.instanceInfo=this._instanceInfo.map(t=>({...t})),r.availableInstanceIds=this._availableInstanceIds.slice(),r.availableGeometryIds=this._availableGeometryIds.slice(),r.nextIndexStart=this._nextIndexStart,r.nextVertexStart=this._nextVertexStart,r.geometryCount=this._geometryCount,r.maxInstanceCount=this._maxInstanceCount,r.maxVertexCount=this._maxVertexCount,r.maxIndexCount=this._maxIndexCount,r.geometryInitialized=this._geometryInitialized,r.matricesTexture=this._matricesTexture.toJSON(t),r.indirectTexture=this._indirectTexture.toJSON(t),null!==this._colorsTexture&&(r.colorsTexture=this._colorsTexture.toJSON(t)),null!==this.boundingSphere&&(r.boundingSphere=this.boundingSphere.toJSON()),null!==this.boundingBox&&(r.boundingBox=this.boundingBox.toJSON())),this.isScene)this.background&&(this.background.isColor?r.background=this.background.toJSON():this.background.isTexture&&(r.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(r.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){r.geometry=i(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const s=e.shapes;if(Array.isArray(s))for(let e=0,r=s.length;e<r;e++){const r=s[e];i(t.shapes,r)}else i(t.shapes,s)}}if(this.isSkinnedMesh&&(r.bindMode=this.bindMode,r.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(i(t.skeletons,this.skeleton),r.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let s=0,r=this.material.length;s<r;s++)e.push(i(t.materials,this.material[s]));r.material=e}else r.material=i(t.materials,this.material);if(this.children.length>0){r.children=[];for(let e=0;e<this.children.length;e++)r.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){r.animations=[];for(let e=0;e<this.animations.length;e++){const s=this.animations[e];r.animations.push(i(t.animations,s))}}if(e){const e=n(t.geometries),r=n(t.materials),i=n(t.textures),a=n(t.images),o=n(t.shapes),h=n(t.skeletons),l=n(t.animations),u=n(t.nodes);e.length>0&&(s.geometries=e),r.length>0&&(s.materials=r),i.length>0&&(s.textures=i),a.length>0&&(s.images=a),o.length>0&&(s.shapes=o),h.length>0&&(s.skeletons=h),l.length>0&&(s.animations=l),u.length>0&&(s.nodes=u)}return s.object=r,s;function n(t){const e=[];for(const s in t){const r=t[s];delete r.metadata,e.push(r)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const s=t.children[e];this.add(s.clone())}return this}}me.DEFAULT_UP=new j(0,1,0),me.DEFAULT_MATRIX_AUTO_UPDATE=!0,me.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const ge=new j,ye=new j,fe=new j,xe=new j,be=new j,ve=new j,Ne=new j,we=new j,Te=new j,Me=new j,_e=new ct,Se=new ct,Ae=new ct;class Ve{constructor(t=new j,e=new j,s=new j){this.a=t,this.b=e,this.c=s}static getNormal(t,e,s,r){r.subVectors(s,e),ge.subVectors(t,e),r.cross(ge);const i=r.lengthSq();return i>0?r.multiplyScalar(1/Math.sqrt(i)):r.set(0,0,0)}static getBarycoord(t,e,s,r,i){ge.subVectors(r,e),ye.subVectors(s,e),fe.subVectors(t,e);const n=ge.dot(ge),a=ge.dot(ye),o=ge.dot(fe),h=ye.dot(ye),l=ye.dot(fe),u=n*h-a*a;if(0===u)return i.set(0,0,0),null;const c=1/u,d=(h*o-a*l)*c,p=(n*l-a*o)*c;return i.set(1-d-p,p,d)}static containsPoint(t,e,s,r){return null!==this.getBarycoord(t,e,s,r,xe)&&(xe.x>=0&&xe.y>=0&&xe.x+xe.y<=1)}static getInterpolation(t,e,s,r,i,n,a,o){return null===this.getBarycoord(t,e,s,r,xe)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(i,xe.x),o.addScaledVector(n,xe.y),o.addScaledVector(a,xe.z),o)}static getInterpolatedAttribute(t,e,s,r,i,n){return _e.setScalar(0),Se.setScalar(0),Ae.setScalar(0),_e.fromBufferAttribute(t,e),Se.fromBufferAttribute(t,s),Ae.fromBufferAttribute(t,r),n.setScalar(0),n.addScaledVector(_e,i.x),n.addScaledVector(Se,i.y),n.addScaledVector(Ae,i.z),n}static isFrontFacing(t,e,s,r){return ge.subVectors(s,e),ye.subVectors(t,e),ge.cross(ye).dot(r)<0}set(t,e,s){return this.a.copy(t),this.b.copy(e),this.c.copy(s),this}setFromPointsAndIndices(t,e,s,r){return this.a.copy(t[e]),this.b.copy(t[s]),this.c.copy(t[r]),this}setFromAttributeAndIndices(t,e,s,r){return this.a.fromBufferAttribute(t,e),this.b.fromBufferAttribute(t,s),this.c.fromBufferAttribute(t,r),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return ge.subVectors(this.c,this.b),ye.subVectors(this.a,this.b),.5*ge.cross(ye).length()}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return Ve.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return Ve.getBarycoord(t,this.a,this.b,this.c,e)}getInterpolation(t,e,s,r,i){return Ve.getInterpolation(t,this.a,this.b,this.c,e,s,r,i)}containsPoint(t){return Ve.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return Ve.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){const s=this.a,r=this.b,i=this.c;let n,a;be.subVectors(r,s),ve.subVectors(i,s),we.subVectors(t,s);const o=be.dot(we),h=ve.dot(we);if(o<=0&&h<=0)return e.copy(s);Te.subVectors(t,r);const l=be.dot(Te),u=ve.dot(Te);if(l>=0&&u<=l)return e.copy(r);const c=o*u-l*h;if(c<=0&&o>=0&&l<=0)return n=o/(o-l),e.copy(s).addScaledVector(be,n);Me.subVectors(t,i);const d=be.dot(Me),p=ve.dot(Me);if(p>=0&&d<=p)return e.copy(i);const m=d*h-o*p;if(m<=0&&h>=0&&p<=0)return a=h/(h-p),e.copy(s).addScaledVector(ve,a);const g=l*p-d*u;if(g<=0&&u-l>=0&&d-p>=0)return Ne.subVectors(i,r),a=(u-l)/(u-l+(d-p)),e.copy(r).addScaledVector(Ne,a);const y=1/(g+m+c);return n=m*y,a=c*y,e.copy(s).addScaledVector(be,n).addScaledVector(ve,a)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}const ze={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Ce={h:0,s:0,l:0},Ie={h:0,s:0,l:0};function Re(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+6*(e-t)*(2/3-s):t}class Ee{constructor(t,e,s){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(t,e,s)}set(t,e,s){if(void 0===e&&void 0===s){const e=t;e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e)}else this.setRGB(t,e,s);return this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=v){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,tt.colorSpaceToWorking(this,e),this}setRGB(t,e,s,r=tt.workingColorSpace){return this.r=t,this.g=e,this.b=s,tt.colorSpaceToWorking(this,r),this}setHSL(t,e,s,r=tt.workingColorSpace){if(t=P(t,1),e=O(e,0,1),s=O(s,0,1),0===e)this.r=this.g=this.b=s;else{const r=s<=.5?s*(1+e):s+e-s*e,i=2*s-r;this.r=Re(i,r,t+1/3),this.g=Re(i,r,t),this.b=Re(i,r,t-1/3)}return tt.colorSpaceToWorking(this,r),this}setStyle(t,e=v){function s(t){void 0!==t&&parseFloat(t)}let r;if(r=/^(\w+)\(([^\)]*)\)/.exec(t)){let t;const i=r[1],n=r[2];switch(i){case"rgb":case"rgba":if(t=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return s(t[4]),this.setRGB(Math.min(255,parseInt(t[1],10))/255,Math.min(255,parseInt(t[2],10))/255,Math.min(255,parseInt(t[3],10))/255,e);if(t=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return s(t[4]),this.setRGB(Math.min(100,parseInt(t[1],10))/100,Math.min(100,parseInt(t[2],10))/100,Math.min(100,parseInt(t[3],10))/100,e);break;case"hsl":case"hsla":if(t=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return s(t[4]),this.setHSL(parseFloat(t[1])/360,parseFloat(t[2])/100,parseFloat(t[3])/100,e)}}else if(r=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=r[1],s=t.length;if(3===s)return this.setRGB(parseInt(t.charAt(0),16)/15,parseInt(t.charAt(1),16)/15,parseInt(t.charAt(2),16)/15,e);if(6===s)return this.setHex(parseInt(t,16),e)}else if(t&&t.length>0)return this.setColorName(t,e);return this}setColorName(t,e=v){const s=ze[t.toLowerCase()];return void 0!==s&&this.setHex(s,e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=et(t.r),this.g=et(t.g),this.b=et(t.b),this}copyLinearToSRGB(t){return this.r=st(t.r),this.g=st(t.g),this.b=st(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=v){return tt.workingToColorSpace(Le.copy(this),t),65536*Math.round(O(255*Le.r,0,255))+256*Math.round(O(255*Le.g,0,255))+Math.round(O(255*Le.b,0,255))}getHexString(t=v){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=tt.workingColorSpace){tt.workingToColorSpace(Le.copy(this),e);const s=Le.r,r=Le.g,i=Le.b,n=Math.max(s,r,i),a=Math.min(s,r,i);let o,h;const l=(a+n)/2;if(a===n)o=0,h=0;else{const t=n-a;switch(h=l<=.5?t/(n+a):t/(2-n-a),n){case s:o=(r-i)/t+(r<i?6:0);break;case r:o=(i-s)/t+2;break;case i:o=(s-r)/t+4}o/=6}return t.h=o,t.s=h,t.l=l,t}getRGB(t,e=tt.workingColorSpace){return tt.workingToColorSpace(Le.copy(this),e),t.r=Le.r,t.g=Le.g,t.b=Le.b,t}getStyle(t=v){tt.workingToColorSpace(Le.copy(this),t);const e=Le.r,s=Le.g,r=Le.b;return t!==v?`color(${t} ${e.toFixed(3)} ${s.toFixed(3)} ${r.toFixed(3)})`:`rgb(${Math.round(255*e)},${Math.round(255*s)},${Math.round(255*r)})`}offsetHSL(t,e,s){return this.getHSL(Ce),this.setHSL(Ce.h+t,Ce.s+e,Ce.l+s)}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,s){return this.r=t.r+(e.r-t.r)*s,this.g=t.g+(e.g-t.g)*s,this.b=t.b+(e.b-t.b)*s,this}lerpHSL(t,e){this.getHSL(Ce),t.getHSL(Ie);const s=F(Ce.h,Ie.h,e),r=F(Ce.s,Ie.s,e),i=F(Ce.l,Ie.l,e);return this.setHSL(s,r,i),this}setFromVector3(t){return this.r=t.x,this.g=t.y,this.b=t.z,this}applyMatrix3(t){const e=this.r,s=this.g,r=this.b,i=t.elements;return this.r=i[0]*e+i[3]*s+i[6]*r,this.g=i[1]*e+i[4]*s+i[7]*r,this.b=i[2]*e+i[5]*s+i[8]*r,this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const Le=new Ee;Ee.NAMES=ze;let Oe=0;class Pe extends z{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Oe++}),this.uuid=L(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=t,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Ee(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=M,this.stencilZFail=M,this.stencilZPass=M,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(t){this._alphaTest>0!=t>0&&this.version++,this._alphaTest=t}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(t){if(void 0!==t)for(const e in t){const s=t[e];if(void 0===s)continue;const r=this[e];void 0!==r&&(r&&r.isColor?r.set(s):r&&r.isVector3&&s&&s.isVector3?r.copy(s):this[e]=s)}}toJSON(e){const s=void 0===e||"string"==typeof e;s&&(e={textures:{},images:{}});const r={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};function i(t){const e=[];for(const s in t){const r=t[s];delete r.metadata,e.push(r)}return e}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),void 0!==this.roughness&&(r.roughness=this.roughness),void 0!==this.metalness&&(r.metalness=this.metalness),void 0!==this.sheen&&(r.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(r.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(r.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(r.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(r.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(r.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(r.shininess=this.shininess),void 0!==this.clearcoat&&(r.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(r.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(r.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(r.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(r.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,r.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(r.dispersion=this.dispersion),void 0!==this.iridescence&&(r.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(r.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(r.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(r.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(r.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(r.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(r.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(r.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(r.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(e).uuid,r.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(r.aoMap=this.aoMap.toJSON(e).uuid,r.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(e).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(e).uuid,r.normalMapType=this.normalMapType,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(e).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(r.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(r.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(r.combine=this.combine)),void 0!==this.envMapRotation&&(r.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(r.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(r.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(r.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(r.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(r.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(r.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(r.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(r.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(r.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(r.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(r.size=this.size),null!==this.shadowSide&&(r.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(r.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(r.blending=this.blending),0!==this.side&&(r.side=this.side),!0===this.vertexColors&&(r.vertexColors=!0),this.opacity<1&&(r.opacity=this.opacity),!0===this.transparent&&(r.transparent=!0),204!==this.blendSrc&&(r.blendSrc=this.blendSrc),205!==this.blendDst&&(r.blendDst=this.blendDst),this.blendEquation!==t&&(r.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(r.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(r.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(r.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(r.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(r.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(r.depthFunc=this.depthFunc),!1===this.depthTest&&(r.depthTest=this.depthTest),!1===this.depthWrite&&(r.depthWrite=this.depthWrite),!1===this.colorWrite&&(r.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(r.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(r.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(r.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(r.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==M&&(r.stencilFail=this.stencilFail),this.stencilZFail!==M&&(r.stencilZFail=this.stencilZFail),this.stencilZPass!==M&&(r.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(r.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(r.rotation=this.rotation),!0===this.polygonOffset&&(r.polygonOffset=!0),0!==this.polygonOffsetFactor&&(r.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(r.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(r.linewidth=this.linewidth),void 0!==this.dashSize&&(r.dashSize=this.dashSize),void 0!==this.gapSize&&(r.gapSize=this.gapSize),void 0!==this.scale&&(r.scale=this.scale),!0===this.dithering&&(r.dithering=!0),this.alphaTest>0&&(r.alphaTest=this.alphaTest),!0===this.alphaHash&&(r.alphaHash=!0),!0===this.alphaToCoverage&&(r.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(r.premultipliedAlpha=!0),!0===this.forceSinglePass&&(r.forceSinglePass=!0),!0===this.wireframe&&(r.wireframe=!0),this.wireframeLinewidth>1&&(r.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(r.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(r.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(r.flatShading=!0),!1===this.visible&&(r.visible=!1),!1===this.toneMapped&&(r.toneMapped=!1),!1===this.fog&&(r.fog=!1),Object.keys(this.userData).length>0&&(r.userData=this.userData),s){const t=i(e.textures),s=i(e.images);t.length>0&&(r.textures=t),s.length>0&&(r.images=s)}return r}clone(){return(new this.constructor).copy(this)}copy(t){this.name=t.name,this.blending=t.blending,this.side=t.side,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.blendColor.copy(t.blendColor),this.blendAlpha=t.blendAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let s=null;if(null!==e){const t=e.length;s=new Array(t);for(let r=0;r!==t;++r)s[r]=e[r].clone()}return this.clippingPlanes=s,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.alphaHash=t.alphaHash,this.alphaToCoverage=t.alphaToCoverage,this.premultipliedAlpha=t.premultipliedAlpha,this.forceSinglePass=t.forceSinglePass,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(t){!0===t&&this.version++}}class Fe extends Pe{constructor(t){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Ee(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Jt,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}const Be=ke();function ke(){const t=new ArrayBuffer(4),e=new Float32Array(t),s=new Uint32Array(t),r=new Uint32Array(512),i=new Uint32Array(512);for(let t=0;t<256;++t){const e=t-127;e<-27?(r[t]=0,r[256|t]=32768,i[t]=24,i[256|t]=24):e<-14?(r[t]=1024>>-e-14,r[256|t]=1024>>-e-14|32768,i[t]=-e-1,i[256|t]=-e-1):e<=15?(r[t]=e+15<<10,r[256|t]=e+15<<10|32768,i[t]=13,i[256|t]=13):e<128?(r[t]=31744,r[256|t]=64512,i[t]=24,i[256|t]=24):(r[t]=31744,r[256|t]=64512,i[t]=13,i[256|t]=13)}const n=new Uint32Array(2048),a=new Uint32Array(64),o=new Uint32Array(64);for(let t=1;t<1024;++t){let e=t<<13,s=0;for(;!(8388608&e);)e<<=1,s-=8388608;e&=-8388609,s+=947912704,n[t]=e|s}for(let t=1024;t<2048;++t)n[t]=939524096+(t-1024<<13);for(let t=1;t<31;++t)a[t]=t<<23;a[31]=1199570944,a[32]=2147483648;for(let t=33;t<63;++t)a[t]=2147483648+(t-32<<23);a[63]=3347054592;for(let t=1;t<64;++t)32!==t&&(o[t]=1024);return{floatView:e,uint32View:s,baseTable:r,shiftTable:i,mantissaTable:n,exponentTable:a,offsetTable:o}}function De(t){Math.abs(t),t=O(t,-65504,65504),Be.floatView[0]=t;const e=Be.uint32View[0],s=e>>23&511;return Be.baseTable[s]+((8388607&e)>>Be.shiftTable[s])}function Ue(t){const e=t>>10;return Be.uint32View[0]=Be.mantissaTable[Be.offsetTable[e]+(1023&t)]+Be.exponentTable[e],Be.floatView[0]}const We=new j,je=new U;let qe=0;class He{constructor(t,e,s=!1){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:qe++}),this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=s,this.usage=_,this.updateRanges=[],this.gpuType=c,this.version=0}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this.gpuType=t.gpuType,this}copyAt(t,e,s){t*=this.itemSize,s*=e.itemSize;for(let r=0,i=this.itemSize;r<i;r++)this.array[t+r]=e.array[s+r];return this}copyArray(t){return this.array.set(t),this}applyMatrix3(t){if(2===this.itemSize)for(let e=0,s=this.count;e<s;e++)je.fromBufferAttribute(this,e),je.applyMatrix3(t),this.setXY(e,je.x,je.y);else if(3===this.itemSize)for(let e=0,s=this.count;e<s;e++)We.fromBufferAttribute(this,e),We.applyMatrix3(t),this.setXYZ(e,We.x,We.y,We.z);return this}applyMatrix4(t){for(let e=0,s=this.count;e<s;e++)We.fromBufferAttribute(this,e),We.applyMatrix4(t),this.setXYZ(e,We.x,We.y,We.z);return this}applyNormalMatrix(t){for(let e=0,s=this.count;e<s;e++)We.fromBufferAttribute(this,e),We.applyNormalMatrix(t),this.setXYZ(e,We.x,We.y,We.z);return this}transformDirection(t){for(let e=0,s=this.count;e<s;e++)We.fromBufferAttribute(this,e),We.transformDirection(t),this.setXYZ(e,We.x,We.y,We.z);return this}set(t,e=0){return this.array.set(t,e),this}getComponent(t,e){let s=this.array[t*this.itemSize+e];return this.normalized&&(s=B(s,this.array)),s}setComponent(t,e,s){return this.normalized&&(s=k(s,this.array)),this.array[t*this.itemSize+e]=s,this}getX(t){let e=this.array[t*this.itemSize];return this.normalized&&(e=B(e,this.array)),e}setX(t,e){return this.normalized&&(e=k(e,this.array)),this.array[t*this.itemSize]=e,this}getY(t){let e=this.array[t*this.itemSize+1];return this.normalized&&(e=B(e,this.array)),e}setY(t,e){return this.normalized&&(e=k(e,this.array)),this.array[t*this.itemSize+1]=e,this}getZ(t){let e=this.array[t*this.itemSize+2];return this.normalized&&(e=B(e,this.array)),e}setZ(t,e){return this.normalized&&(e=k(e,this.array)),this.array[t*this.itemSize+2]=e,this}getW(t){let e=this.array[t*this.itemSize+3];return this.normalized&&(e=B(e,this.array)),e}setW(t,e){return this.normalized&&(e=k(e,this.array)),this.array[t*this.itemSize+3]=e,this}setXY(t,e,s){return t*=this.itemSize,this.normalized&&(e=k(e,this.array),s=k(s,this.array)),this.array[t+0]=e,this.array[t+1]=s,this}setXYZ(t,e,s,r){return t*=this.itemSize,this.normalized&&(e=k(e,this.array),s=k(s,this.array),r=k(r,this.array)),this.array[t+0]=e,this.array[t+1]=s,this.array[t+2]=r,this}setXYZW(t,e,s,r,i){return t*=this.itemSize,this.normalized&&(e=k(e,this.array),s=k(s,this.array),r=k(r,this.array),i=k(i,this.array)),this.array[t+0]=e,this.array[t+1]=s,this.array[t+2]=r,this.array[t+3]=i,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(t.name=this.name),this.usage!==_&&(t.usage=this.usage),t}}class Ge extends He{constructor(t,e,s){super(new Uint16Array(t),e,s)}}class Xe extends He{constructor(t,e,s){super(new Uint32Array(t),e,s)}}class Ye extends He{constructor(t,e,s){super(new Float32Array(t),e,s)}}let Ze=0;const $e=new Ut,Je=new me,Ke=new j,Qe=new mt,ts=new mt,es=new j;class ss extends z{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:Ze++}),this.uuid=L(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return Array.isArray(t)?this.index=new(function(t){for(let e=t.length-1;e>=0;--e)if(t[e]>=65535)return!0;return!1}(t)?Xe:Ge)(t,1):this.index=t,this}setIndirect(t){return this.indirect=t,this}getIndirect(){return this.indirect}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return void 0!==this.attributes[t]}addGroup(t,e,s=0){this.groups.push({start:t,count:e,materialIndex:s})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const s=this.attributes.normal;if(void 0!==s){const e=(new G).getNormalMatrix(t);s.applyNormalMatrix(e),s.needsUpdate=!0}const r=this.attributes.tangent;return void 0!==r&&(r.transformDirection(t),r.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(t){return $e.makeRotationFromQuaternion(t),this.applyMatrix4($e),this}rotateX(t){return $e.makeRotationX(t),this.applyMatrix4($e),this}rotateY(t){return $e.makeRotationY(t),this.applyMatrix4($e),this}rotateZ(t){return $e.makeRotationZ(t),this.applyMatrix4($e),this}translate(t,e,s){return $e.makeTranslation(t,e,s),this.applyMatrix4($e),this}scale(t,e,s){return $e.makeScale(t,e,s),this.applyMatrix4($e),this}lookAt(t){return Je.lookAt(t),Je.updateMatrix(),this.applyMatrix4(Je.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Ke).negate(),this.translate(Ke.x,Ke.y,Ke.z),this}setFromPoints(t){const e=this.getAttribute("position");if(void 0===e){const e=[];for(let s=0,r=t.length;s<r;s++){const r=t[s];e.push(r.x,r.y,r.z||0)}this.setAttribute("position",new Ye(e,3))}else{const s=Math.min(t.length,e.count);for(let r=0;r<s;r++){const s=t[r];e.setXYZ(r,s.x,s.y,s.z||0)}t.length,e.count,e.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new mt);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)this.boundingBox.set(new j(-1/0,-1/0,-1/0),new j(1/0,1/0,1/0));else{if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,s=e.length;t<s;t++){const s=e[t];Qe.setFromBufferAttribute(s),this.morphTargetsRelative?(es.addVectors(this.boundingBox.min,Qe.min),this.boundingBox.expandByPoint(es),es.addVectors(this.boundingBox.max,Qe.max),this.boundingBox.expandByPoint(es)):(this.boundingBox.expandByPoint(Qe.min),this.boundingBox.expandByPoint(Qe.max))}}else this.boundingBox.makeEmpty();isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Rt);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)this.boundingSphere.set(new j,1/0);else if(t){const s=this.boundingSphere.center;if(Qe.setFromBufferAttribute(t),e)for(let t=0,s=e.length;t<s;t++){const s=e[t];ts.setFromBufferAttribute(s),this.morphTargetsRelative?(es.addVectors(Qe.min,ts.min),Qe.expandByPoint(es),es.addVectors(Qe.max,ts.max),Qe.expandByPoint(es)):(Qe.expandByPoint(ts.min),Qe.expandByPoint(ts.max))}Qe.getCenter(s);let r=0;for(let e=0,i=t.count;e<i;e++)es.fromBufferAttribute(t,e),r=Math.max(r,s.distanceToSquared(es));if(e)for(let i=0,n=e.length;i<n;i++){const n=e[i],a=this.morphTargetsRelative;for(let e=0,i=n.count;e<i;e++)es.fromBufferAttribute(n,e),a&&(Ke.fromBufferAttribute(t,e),es.add(Ke)),r=Math.max(r,s.distanceToSquared(es))}this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)}}computeTangents(){const t=this.index,e=this.attributes;if(null===t||void 0===e.position||void 0===e.normal||void 0===e.uv)return;const s=e.position,r=e.normal,i=e.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new He(new Float32Array(4*s.count),4));const n=this.getAttribute("tangent"),a=[],o=[];for(let t=0;t<s.count;t++)a[t]=new j,o[t]=new j;const h=new j,l=new j,u=new j,c=new U,d=new U,p=new U,m=new j,g=new j;function y(t,e,r){h.fromBufferAttribute(s,t),l.fromBufferAttribute(s,e),u.fromBufferAttribute(s,r),c.fromBufferAttribute(i,t),d.fromBufferAttribute(i,e),p.fromBufferAttribute(i,r),l.sub(h),u.sub(h),d.sub(c),p.sub(c);const n=1/(d.x*p.y-p.x*d.y);isFinite(n)&&(m.copy(l).multiplyScalar(p.y).addScaledVector(u,-d.y).multiplyScalar(n),g.copy(u).multiplyScalar(d.x).addScaledVector(l,-p.x).multiplyScalar(n),a[t].add(m),a[e].add(m),a[r].add(m),o[t].add(g),o[e].add(g),o[r].add(g))}let f=this.groups;0===f.length&&(f=[{start:0,count:t.count}]);for(let e=0,s=f.length;e<s;++e){const s=f[e],r=s.start;for(let e=r,i=r+s.count;e<i;e+=3)y(t.getX(e+0),t.getX(e+1),t.getX(e+2))}const x=new j,b=new j,v=new j,N=new j;function w(t){v.fromBufferAttribute(r,t),N.copy(v);const e=a[t];x.copy(e),x.sub(v.multiplyScalar(v.dot(e))).normalize(),b.crossVectors(N,e);const s=b.dot(o[t])<0?-1:1;n.setXYZW(t,x.x,x.y,x.z,s)}for(let e=0,s=f.length;e<s;++e){const s=f[e],r=s.start;for(let e=r,i=r+s.count;e<i;e+=3)w(t.getX(e+0)),w(t.getX(e+1)),w(t.getX(e+2))}}computeVertexNormals(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let s=this.getAttribute("normal");if(void 0===s)s=new He(new Float32Array(3*e.count),3),this.setAttribute("normal",s);else for(let t=0,e=s.count;t<e;t++)s.setXYZ(t,0,0,0);const r=new j,i=new j,n=new j,a=new j,o=new j,h=new j,l=new j,u=new j;if(t)for(let c=0,d=t.count;c<d;c+=3){const d=t.getX(c+0),p=t.getX(c+1),m=t.getX(c+2);r.fromBufferAttribute(e,d),i.fromBufferAttribute(e,p),n.fromBufferAttribute(e,m),l.subVectors(n,i),u.subVectors(r,i),l.cross(u),a.fromBufferAttribute(s,d),o.fromBufferAttribute(s,p),h.fromBufferAttribute(s,m),a.add(l),o.add(l),h.add(l),s.setXYZ(d,a.x,a.y,a.z),s.setXYZ(p,o.x,o.y,o.z),s.setXYZ(m,h.x,h.y,h.z)}else for(let t=0,a=e.count;t<a;t+=3)r.fromBufferAttribute(e,t+0),i.fromBufferAttribute(e,t+1),n.fromBufferAttribute(e,t+2),l.subVectors(n,i),u.subVectors(r,i),l.cross(u),s.setXYZ(t+0,l.x,l.y,l.z),s.setXYZ(t+1,l.x,l.y,l.z),s.setXYZ(t+2,l.x,l.y,l.z);this.normalizeNormals(),s.needsUpdate=!0}}normalizeNormals(){const t=this.attributes.normal;for(let e=0,s=t.count;e<s;e++)es.fromBufferAttribute(t,e),es.normalize(),t.setXYZ(e,es.x,es.y,es.z)}toNonIndexed(){function t(t,e){const s=t.array,r=t.itemSize,i=t.normalized,n=new s.constructor(e.length*r);let a=0,o=0;for(let i=0,h=e.length;i<h;i++){a=t.isInterleavedBufferAttribute?e[i]*t.data.stride+t.offset:e[i]*r;for(let t=0;t<r;t++)n[o++]=s[a++]}return new He(n,r,i)}if(null===this.index)return this;const e=new ss,s=this.index.array,r=this.attributes;for(const i in r){const n=t(r[i],s);e.setAttribute(i,n)}const i=this.morphAttributes;for(const r in i){const n=[],a=i[r];for(let e=0,r=a.length;e<r;e++){const r=t(a[e],s);n.push(r)}e.morphAttributes[r]=n}e.morphTargetsRelative=this.morphTargetsRelative;const n=this.groups;for(let t=0,s=n.length;t<s;t++){const s=n[t];e.addGroup(s.start,s.count,s.materialIndex)}return e}toJSON(){const t={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const s in e)void 0!==e[s]&&(t[s]=e[s]);return t}t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const s=this.attributes;for(const e in s){const r=s[e];t.data.attributes[e]=r.toJSON(t.data)}const r={};let i=!1;for(const e in this.morphAttributes){const s=this.morphAttributes[e],n=[];for(let e=0,r=s.length;e<r;e++){const r=s[e];n.push(r.toJSON(t.data))}n.length>0&&(r[e]=n,i=!0)}i&&(t.data.morphAttributes=r,t.data.morphTargetsRelative=this.morphTargetsRelative);const n=this.groups;n.length>0&&(t.data.groups=JSON.parse(JSON.stringify(n)));const a=this.boundingSphere;return null!==a&&(t.data.boundingSphere=a.toJSON()),t}clone(){return(new this.constructor).copy(this)}copy(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const s=t.index;null!==s&&this.setIndex(s.clone());const r=t.attributes;for(const t in r){const s=r[t];this.setAttribute(t,s.clone(e))}const i=t.morphAttributes;for(const t in i){const s=[],r=i[t];for(let t=0,i=r.length;t<i;t++)s.push(r[t].clone(e));this.morphAttributes[t]=s}this.morphTargetsRelative=t.morphTargetsRelative;const n=t.groups;for(let t=0,e=n.length;t<e;t++){const e=n[t];this.addGroup(e.start,e.count,e.materialIndex)}const a=t.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=t.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const rs=new Ut,is=new Dt,ns=new Rt,as=new j,os=new j,hs=new j,ls=new j,us=new j,cs=new j,ds=new j,ps=new j;class ms extends me{constructor(t=new ss,e=new Fe){super(),this.isMesh=!0,this.type="Mesh",this.geometry=t,this.material=e,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const s=t[e[0]];if(void 0!==s){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=s.length;t<e;t++){const e=s[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}getVertexPosition(t,e){const s=this.geometry,r=s.attributes.position,i=s.morphAttributes.position,n=s.morphTargetsRelative;e.fromBufferAttribute(r,t);const a=this.morphTargetInfluences;if(i&&a){cs.set(0,0,0);for(let s=0,r=i.length;s<r;s++){const r=a[s],o=i[s];0!==r&&(us.fromBufferAttribute(o,t),n?cs.addScaledVector(us,r):cs.addScaledVector(us.sub(e),r))}e.add(cs)}return e}raycast(t,e){const s=this.geometry,r=this.material,i=this.matrixWorld;if(void 0!==r){if(null===s.boundingSphere&&s.computeBoundingSphere(),ns.copy(s.boundingSphere),ns.applyMatrix4(i),is.copy(t.ray).recast(t.near),!1===ns.containsPoint(is.origin)){if(null===is.intersectSphere(ns,as))return;if(is.origin.distanceToSquared(as)>(t.far-t.near)**2)return}rs.copy(i).invert(),is.copy(t.ray).applyMatrix4(rs),null!==s.boundingBox&&!1===is.intersectsBox(s.boundingBox)||this._computeIntersections(t,e,is)}}_computeIntersections(t,e,s){let r;const i=this.geometry,n=this.material,a=i.index,o=i.attributes.position,h=i.attributes.uv,l=i.attributes.uv1,u=i.attributes.normal,c=i.groups,d=i.drawRange;if(null!==a)if(Array.isArray(n))for(let i=0,o=c.length;i<o;i++){const o=c[i],p=n[o.materialIndex];for(let i=Math.max(o.start,d.start),n=Math.min(a.count,Math.min(o.start+o.count,d.start+d.count));i<n;i+=3){r=gs(this,p,t,s,h,l,u,a.getX(i),a.getX(i+1),a.getX(i+2)),r&&(r.faceIndex=Math.floor(i/3),r.face.materialIndex=o.materialIndex,e.push(r))}}else{for(let i=Math.max(0,d.start),o=Math.min(a.count,d.start+d.count);i<o;i+=3){r=gs(this,n,t,s,h,l,u,a.getX(i),a.getX(i+1),a.getX(i+2)),r&&(r.faceIndex=Math.floor(i/3),e.push(r))}}else if(void 0!==o)if(Array.isArray(n))for(let i=0,a=c.length;i<a;i++){const a=c[i],p=n[a.materialIndex];for(let i=Math.max(a.start,d.start),n=Math.min(o.count,Math.min(a.start+a.count,d.start+d.count));i<n;i+=3){r=gs(this,p,t,s,h,l,u,i,i+1,i+2),r&&(r.faceIndex=Math.floor(i/3),r.face.materialIndex=a.materialIndex,e.push(r))}}else{for(let i=Math.max(0,d.start),a=Math.min(o.count,d.start+d.count);i<a;i+=3){r=gs(this,n,t,s,h,l,u,i,i+1,i+2),r&&(r.faceIndex=Math.floor(i/3),e.push(r))}}}}function gs(t,e,s,r,i,n,a,o,h,l){t.getVertexPosition(o,os),t.getVertexPosition(h,hs),t.getVertexPosition(l,ls);const u=function(t,e,s,r,i,n,a,o){let h;if(h=1===e.side?r.intersectTriangle(a,n,i,!0,o):r.intersectTriangle(i,n,a,0===e.side,o),null===h)return null;ps.copy(o),ps.applyMatrix4(t.matrixWorld);const l=s.ray.origin.distanceTo(ps);return l<s.near||l>s.far?null:{distance:l,point:ps.clone(),object:t}}(t,e,s,r,os,hs,ls,ds);if(u){const t=new j;Ve.getBarycoord(ds,os,hs,ls,t),i&&(u.uv=Ve.getInterpolatedAttribute(i,o,h,l,t,new U)),n&&(u.uv1=Ve.getInterpolatedAttribute(n,o,h,l,t,new U)),a&&(u.normal=Ve.getInterpolatedAttribute(a,o,h,l,t,new j),u.normal.dot(r.direction)>0&&u.normal.multiplyScalar(-1));const e={a:o,b:h,c:l,normal:new j,materialIndex:0};Ve.getNormal(os,hs,ls,e.normal),u.face=e,u.barycoord=t}return u}class ys extends ss{constructor(t=1,e=1,s=1,r=1,i=1,n=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:s,widthSegments:r,heightSegments:i,depthSegments:n};const a=this;r=Math.floor(r),i=Math.floor(i),n=Math.floor(n);const o=[],h=[],l=[],u=[];let c=0,d=0;function p(t,e,s,r,i,n,p,m,g,y,f){const x=n/g,b=p/y,v=n/2,N=p/2,w=m/2,T=g+1,M=y+1;let _=0,S=0;const A=new j;for(let n=0;n<M;n++){const a=n*b-N;for(let o=0;o<T;o++){const c=o*x-v;A[t]=c*r,A[e]=a*i,A[s]=w,h.push(A.x,A.y,A.z),A[t]=0,A[e]=0,A[s]=m>0?1:-1,l.push(A.x,A.y,A.z),u.push(o/g),u.push(1-n/y),_+=1}}for(let t=0;t<y;t++)for(let e=0;e<g;e++){const s=c+e+T*t,r=c+e+T*(t+1),i=c+(e+1)+T*(t+1),n=c+(e+1)+T*t;o.push(s,r,n),o.push(r,i,n),S+=6}a.addGroup(d,S,f),d+=S,c+=_}p("z","y","x",-1,-1,s,e,t,n,i,0),p("z","y","x",1,-1,s,e,-t,n,i,1),p("x","z","y",1,1,t,s,e,r,n,2),p("x","z","y",1,-1,t,s,-e,r,n,3),p("x","y","z",1,-1,t,e,s,r,i,4),p("x","y","z",-1,-1,t,e,-s,r,i,5),this.setIndex(o),this.setAttribute("position",new Ye(h,3)),this.setAttribute("normal",new Ye(l,3)),this.setAttribute("uv",new Ye(u,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new ys(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}}class fs extends me{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Ut,this.projectionMatrix=new Ut,this.projectionMatrixInverse=new Ut,this.coordinateSystem=A,this._reversedDepth=!1}get reversedDepth(){return this._reversedDepth}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this.coordinateSystem=t.coordinateSystem,this}getWorldDirection(t){return super.getWorldDirection(t).negate()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const xs=new j,bs=new U,vs=new U;class Ns extends fs{constructor(t=50,e=1,s=.1,r=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=s,this.far=r,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}setFocalLength(t){const e=.5*this.getFilmHeight()/t;this.fov=2*E*Math.atan(e),this.updateProjectionMatrix()}getFocalLength(){const t=Math.tan(.5*R*this.fov);return.5*this.getFilmHeight()/t}getEffectiveFOV(){return 2*E*Math.atan(Math.tan(.5*R*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(t,e,s){xs.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),e.set(xs.x,xs.y).multiplyScalar(-t/xs.z),xs.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),s.set(xs.x,xs.y).multiplyScalar(-t/xs.z)}getViewSize(t,e){return this.getViewBounds(t,bs,vs),e.subVectors(vs,bs)}setViewOffset(t,e,s,r,i,n){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=s,this.view.offsetY=r,this.view.width=i,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=this.near;let e=t*Math.tan(.5*R*this.fov)/this.zoom,s=2*e,r=this.aspect*s,i=-.5*r;const n=this.view;if(null!==this.view&&this.view.enabled){const t=n.fullWidth,a=n.fullHeight;i+=n.offsetX*r/t,e-=n.offsetY*s/a,r*=n.width/t,s*=n.height/a}const a=this.filmOffset;0!==a&&(i+=t*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(i,i+r,e,e-s,t,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}class ws extends ut{constructor(t=[],e=301,s,r,i,n,a,o,h,l){super(t,e,s,r,i,n,a,o,h,l),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(t){this.image=t}}class Ts{constructor(t,e){this.isInterleavedBuffer=!0,this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.usage=_,this.updateRanges=[],this.version=0,this.uuid=L()}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.usage=t.usage,this}copyAt(t,e,s){t*=this.stride,s*=e.stride;for(let r=0,i=this.stride;r<i;r++)this.array[t+r]=e.array[s+r];return this}set(t,e=0){return this.array.set(t,e),this}clone(t){void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=L()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const e=new this.array.constructor(t.arrayBuffers[this.array.buffer._uuid]),s=new this.constructor(e,this.stride);return s.setUsage(this.usage),s}onUpload(t){return this.onUploadCallback=t,this}toJSON(t){return void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=L()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const Ms=new j;class _s{constructor(t,e,s,r=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=t,this.itemSize=e,this.offset=s,this.normalized=r}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(t){this.data.needsUpdate=t}applyMatrix4(t){for(let e=0,s=this.data.count;e<s;e++)Ms.fromBufferAttribute(this,e),Ms.applyMatrix4(t),this.setXYZ(e,Ms.x,Ms.y,Ms.z);return this}applyNormalMatrix(t){for(let e=0,s=this.count;e<s;e++)Ms.fromBufferAttribute(this,e),Ms.applyNormalMatrix(t),this.setXYZ(e,Ms.x,Ms.y,Ms.z);return this}transformDirection(t){for(let e=0,s=this.count;e<s;e++)Ms.fromBufferAttribute(this,e),Ms.transformDirection(t),this.setXYZ(e,Ms.x,Ms.y,Ms.z);return this}getComponent(t,e){let s=this.array[t*this.data.stride+this.offset+e];return this.normalized&&(s=B(s,this.array)),s}setComponent(t,e,s){return this.normalized&&(s=k(s,this.array)),this.data.array[t*this.data.stride+this.offset+e]=s,this}setX(t,e){return this.normalized&&(e=k(e,this.array)),this.data.array[t*this.data.stride+this.offset]=e,this}setY(t,e){return this.normalized&&(e=k(e,this.array)),this.data.array[t*this.data.stride+this.offset+1]=e,this}setZ(t,e){return this.normalized&&(e=k(e,this.array)),this.data.array[t*this.data.stride+this.offset+2]=e,this}setW(t,e){return this.normalized&&(e=k(e,this.array)),this.data.array[t*this.data.stride+this.offset+3]=e,this}getX(t){let e=this.data.array[t*this.data.stride+this.offset];return this.normalized&&(e=B(e,this.array)),e}getY(t){let e=this.data.array[t*this.data.stride+this.offset+1];return this.normalized&&(e=B(e,this.array)),e}getZ(t){let e=this.data.array[t*this.data.stride+this.offset+2];return this.normalized&&(e=B(e,this.array)),e}getW(t){let e=this.data.array[t*this.data.stride+this.offset+3];return this.normalized&&(e=B(e,this.array)),e}setXY(t,e,s){return t=t*this.data.stride+this.offset,this.normalized&&(e=k(e,this.array),s=k(s,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=s,this}setXYZ(t,e,s,r){return t=t*this.data.stride+this.offset,this.normalized&&(e=k(e,this.array),s=k(s,this.array),r=k(r,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=s,this.data.array[t+2]=r,this}setXYZW(t,e,s,r,i){return t=t*this.data.stride+this.offset,this.normalized&&(e=k(e,this.array),s=k(s,this.array),r=k(r,this.array),i=k(i,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=s,this.data.array[t+2]=r,this.data.array[t+3]=i,this}clone(t){if(void 0===t){const t=[];for(let e=0;e<this.count;e++){const s=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[s+e])}return new He(new this.array.constructor(t),this.itemSize,this.normalized)}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new _s(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(t){if(void 0===t){const t=[];for(let e=0;e<this.count;e++){const s=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[s+e])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.toJSON(t)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class Ss extends He{constructor(t,e,s,r=1){super(t,e,s),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=r}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}toJSON(){const t=super.toJSON();return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}const As=new j,Vs=new j,zs=new G;class Cs{constructor(t=new j(1,0,0),e=0){this.isPlane=!0,this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,s,r){return this.normal.set(t,e,s),this.constant=r,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,s){const r=As.subVectors(s,e).cross(Vs.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(r,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(t).addScaledVector(this.normal,-this.distanceToPoint(t))}intersectLine(t,e){const s=t.delta(As),r=this.normal.dot(s);if(0===r)return 0===this.distanceToPoint(t.start)?e.copy(t.start):null;const i=-(t.start.dot(this.normal)+this.constant)/r;return i<0||i>1?null:e.copy(t.start).addScaledVector(s,i)}intersectsLine(t){const e=this.distanceToPoint(t.start),s=this.distanceToPoint(t.end);return e<0&&s>0||s<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const s=e||zs.getNormalMatrix(t),r=this.coplanarPoint(As).applyMatrix4(t),i=this.normal.applyMatrix3(s).normalize();return this.constant=-r.dot(i),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return(new this.constructor).copy(this)}}class Is extends ut{constructor(t,e){super({width:t,height:e}),this.isFramebufferTexture=!0,this.magFilter=o,this.minFilter=o,this.generateMipmaps=!1,this.needsUpdate=!0}}class Rs extends ut{constructor(t,e,s=1014,r,i,n,a=1003,o=1003,h,l=1026,u=1){if(l!==m&&l!==g)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");super({width:t,height:e,depth:u},r,i,n,a,o,l,s,h),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(t){return super.copy(t),this.source=new at(Object.assign({},t.image)),this.compareFunction=t.compareFunction,this}toJSON(t){const e=super.toJSON(t);return null!==this.compareFunction&&(e.compareFunction=this.compareFunction),e}}function Es(t,e){return t&&t.constructor!==e?"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t):t}class Ls{constructor(t,e,s,r){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==r?r:new e.constructor(s),this.sampleValues=e,this.valueSize=s,this.settings=null,this.DefaultSettings_={}}evaluate(t){const e=this.parameterPositions;let s=this._cachedIndex,r=e[s],i=e[s-1];t:{e:{let n;s:{r:if(!(t<r)){for(let n=s+2;;){if(void 0===r){if(t<i)break r;return s=e.length,this._cachedIndex=s,this.copySampleValue_(s-1)}if(s===n)break;if(i=r,r=e[++s],t<r)break e}n=e.length;break s}if(!(t>=i)){const a=e[1];t<a&&(s=2,i=a);for(let n=s-2;;){if(void 0===i)return this._cachedIndex=0,this.copySampleValue_(0);if(s===n)break;if(r=i,i=e[--s-1],t>=i)break e}n=s,s=0;break s}break t}for(;s<n;){const r=s+n>>>1;t<e[r]?n=r:s=r+1}if(r=e[s],i=e[s-1],void 0===i)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===r)return s=e.length,this._cachedIndex=s,this.copySampleValue_(s-1)}this._cachedIndex=s,this.intervalChanged_(s,i,r)}return this.interpolate_(s,i,t,r)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(t){const e=this.resultBuffer,s=this.sampleValues,r=this.valueSize,i=t*r;for(let t=0;t!==r;++t)e[t]=s[i+t];return e}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class Os extends Ls{constructor(t,e,s,r){super(t,e,s,r),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(t,e,s){const r=this.parameterPositions;let i=t-2,n=t+1,a=r[i],o=r[n];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:i=t,a=2*e-s;break;case 2402:i=r.length-2,a=e+r[i]-r[i+1];break;default:i=t,a=s}if(void 0===o)switch(this.getSettings_().endingEnd){case 2401:n=t,o=2*s-e;break;case 2402:n=1,o=s+r[1]-r[0];break;default:n=t-1,o=e}const h=.5*(s-e),l=this.valueSize;this._weightPrev=h/(e-a),this._weightNext=h/(o-s),this._offsetPrev=i*l,this._offsetNext=n*l}interpolate_(t,e,s,r){const i=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=t*a,h=o-a,l=this._offsetPrev,u=this._offsetNext,c=this._weightPrev,d=this._weightNext,p=(s-e)/(r-e),m=p*p,g=m*p,y=-c*g+2*c*m-c*p,f=(1+c)*g+(-1.5-2*c)*m+(-.5+c)*p+1,x=(-1-d)*g+(1.5+d)*m+.5*p,b=d*g-d*m;for(let t=0;t!==a;++t)i[t]=y*n[l+t]+f*n[h+t]+x*n[o+t]+b*n[u+t];return i}}class Ps extends Ls{constructor(t,e,s,r){super(t,e,s,r)}interpolate_(t,e,s,r){const i=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=t*a,h=o-a,l=(s-e)/(r-e),u=1-l;for(let t=0;t!==a;++t)i[t]=n[h+t]*u+n[o+t]*l;return i}}class Fs extends Ls{constructor(t,e,s,r){super(t,e,s,r)}interpolate_(t){return this.copySampleValue_(t-1)}}class Bs{constructor(t,e,s,r){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=Es(e,this.TimeBufferType),this.values=Es(s,this.ValueBufferType),this.setInterpolation(r||this.DefaultInterpolation)}static toJSON(t){const e=t.constructor;let s;if(e.toJSON!==this.toJSON)s=e.toJSON(t);else{s={name:t.name,times:Es(t.times,Array),values:Es(t.values,Array)};const e=t.getInterpolation();e!==t.DefaultInterpolation&&(s.interpolation=e)}return s.type=t.ValueTypeName,s}InterpolantFactoryMethodDiscrete(t){return new Fs(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodLinear(t){return new Ps(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodSmooth(t){return new Os(this.times,this.values,this.getValueSize(),t)}setInterpolation(t){let e;switch(t){case f:e=this.InterpolantFactoryMethodDiscrete;break;case x:e=this.InterpolantFactoryMethodLinear;break;case b:e=this.InterpolantFactoryMethodSmooth}if(void 0===e){const e="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error(e);this.setInterpolation(this.DefaultInterpolation)}return this}return this.createInterpolant=e,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return f;case this.InterpolantFactoryMethodLinear:return x;case this.InterpolantFactoryMethodSmooth:return b}}getValueSize(){return this.values.length/this.times.length}shift(t){if(0!==t){const e=this.times;for(let s=0,r=e.length;s!==r;++s)e[s]+=t}return this}scale(t){if(1!==t){const e=this.times;for(let s=0,r=e.length;s!==r;++s)e[s]*=t}return this}trim(t,e){const s=this.times,r=s.length;let i=0,n=r-1;for(;i!==r&&s[i]<t;)++i;for(;-1!==n&&s[n]>e;)--n;if(++n,0!==i||n!==r){i>=n&&(n=Math.max(n,1),i=n-1);const t=this.getValueSize();this.times=s.slice(i,n),this.values=this.values.slice(i*t,n*t)}return this}validate(){let t=!0;const e=this.getValueSize();e-Math.floor(e)!==0&&(t=!1);const s=this.times,r=this.values,i=s.length;0===i&&(t=!1);let n=null;for(let e=0;e!==i;e++){const r=s[e];if("number"==typeof r&&isNaN(r)){t=!1;break}if(null!==n&&n>r){t=!1;break}n=r}if(void 0!==r&&(a=r,ArrayBuffer.isView(a)&&!(a instanceof DataView)))for(let e=0,s=r.length;e!==s;++e){const s=r[e];if(isNaN(s)){t=!1;break}}var a;return t}optimize(){const t=this.times.slice(),e=this.values.slice(),s=this.getValueSize(),r=this.getInterpolation()===b,i=t.length-1;let n=1;for(let a=1;a<i;++a){let i=!1;const o=t[a];if(o!==t[a+1]&&(1!==a||o!==t[0]))if(r)i=!0;else{const t=a*s,r=t-s,n=t+s;for(let a=0;a!==s;++a){const s=e[t+a];if(s!==e[r+a]||s!==e[n+a]){i=!0;break}}}if(i){if(a!==n){t[n]=t[a];const r=a*s,i=n*s;for(let t=0;t!==s;++t)e[i+t]=e[r+t]}++n}}if(i>0){t[n]=t[i];for(let t=i*s,r=n*s,a=0;a!==s;++a)e[r+a]=e[t+a];++n}return n!==t.length?(this.times=t.slice(0,n),this.values=e.slice(0,n*s)):(this.times=t,this.values=e),this}clone(){const t=this.times.slice(),e=this.values.slice(),s=new(0,this.constructor)(this.name,t,e);return s.createInterpolant=this.createInterpolant,s}}Bs.prototype.ValueTypeName="",Bs.prototype.TimeBufferType=Float32Array,Bs.prototype.ValueBufferType=Float32Array,Bs.prototype.DefaultInterpolation=x;class ks extends Bs{constructor(t,e,s){super(t,e,s)}}ks.prototype.ValueTypeName="bool",ks.prototype.ValueBufferType=Array,ks.prototype.DefaultInterpolation=f,ks.prototype.InterpolantFactoryMethodLinear=void 0,ks.prototype.InterpolantFactoryMethodSmooth=void 0;class Ds extends Bs{constructor(t,e,s,r){super(t,e,s,r)}}Ds.prototype.ValueTypeName="color";class Us extends Bs{constructor(t,e,s,r){super(t,e,s,r)}}Us.prototype.ValueTypeName="number";class Ws extends Ls{constructor(t,e,s,r){super(t,e,s,r)}interpolate_(t,e,s,r){const i=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=(s-e)/(r-e);let h=t*a;for(let t=h+a;h!==t;h+=4)W.slerpFlat(i,0,n,h-a,n,h,o);return i}}class js extends Bs{constructor(t,e,s,r){super(t,e,s,r)}InterpolantFactoryMethodLinear(t){return new Ws(this.times,this.values,this.getValueSize(),t)}}js.prototype.ValueTypeName="quaternion",js.prototype.InterpolantFactoryMethodSmooth=void 0;class qs extends Bs{constructor(t,e,s){super(t,e,s)}}qs.prototype.ValueTypeName="string",qs.prototype.ValueBufferType=Array,qs.prototype.DefaultInterpolation=f,qs.prototype.InterpolantFactoryMethodLinear=void 0,qs.prototype.InterpolantFactoryMethodSmooth=void 0;class Hs extends Bs{constructor(t,e,s,r){super(t,e,s,r)}}Hs.prototype.ValueTypeName="vector";class Gs{constructor(t,e,s){const r=this;let i,n=!1,a=0,o=0;const h=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=s,this.abortController=new AbortController,this.itemStart=function(t){o++,!1===n&&void 0!==r.onStart&&r.onStart(t,a,o),n=!0},this.itemEnd=function(t){a++,void 0!==r.onProgress&&r.onProgress(t,a,o),a===o&&(n=!1,void 0!==r.onLoad&&r.onLoad())},this.itemError=function(t){void 0!==r.onError&&r.onError(t)},this.resolveURL=function(t){return i?i(t):t},this.setURLModifier=function(t){return i=t,this},this.addHandler=function(t,e){return h.push(t,e),this},this.removeHandler=function(t){const e=h.indexOf(t);return-1!==e&&h.splice(e,2),this},this.getHandler=function(t){for(let e=0,s=h.length;e<s;e+=2){const s=h[e],r=h[e+1];if(s.global&&(s.lastIndex=0),s.test(t))return r}return null},this.abort=function(){return this.abortController.abort(),this.abortController=new AbortController,this}}}const Xs=new Gs;class Ys{constructor(t){this.manager=void 0!==t?t:Xs,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(t,e){const s=this;return new Promise(function(r,i){s.load(t,r,e,i)})}parse(){}setCrossOrigin(t){return this.crossOrigin=t,this}setWithCredentials(t){return this.withCredentials=t,this}setPath(t){return this.path=t,this}setResourcePath(t){return this.resourcePath=t,this}setRequestHeader(t){return this.requestHeader=t,this}abort(){return this}}Ys.DEFAULT_MATERIAL_NAME="__DEFAULT";Error;new WeakMap;class Zs extends fs{constructor(t=-1,e=1,s=1,r=-1,i=.1,n=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=s,this.bottom=r,this.near=i,this.far=n,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this}setViewOffset(t,e,s,r,i,n){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=s,this.view.offsetY=r,this.view.width=i,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),s=(this.right+this.left)/2,r=(this.top+this.bottom)/2;let i=s-t,n=s+t,a=r+e,o=r-e;if(null!==this.view&&this.view.enabled){const t=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom;i+=t*this.view.offsetX,n=i+t*this.view.width,a-=e*this.view.offsetY,o=a-e*this.view.height}this.projectionMatrix.makeOrthographic(i,n,a,o,this.near,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}class $s extends Ts{constructor(t,e,s=1){super(t,e),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=s}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}clone(t){const e=super.clone(t);return e.meshPerAttribute=this.meshPerAttribute,e}toJSON(t){const e=super.toJSON(t);return e.isInstancedInterleavedBuffer=!0,e.meshPerAttribute=this.meshPerAttribute,e}}class Js{constructor(t,e,s,r){Js.prototype.isMatrix2=!0,this.elements=[1,0,0,1],void 0!==t&&this.set(t,e,s,r)}identity(){return this.set(1,0,0,1),this}fromArray(t,e=0){for(let s=0;s<4;s++)this.elements[s]=t[s+e];return this}set(t,e,s,r){const i=this.elements;return i[0]=t,i[2]=e,i[1]=s,i[3]=r,this}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:"179"}})),"undefined"!=typeof window&&(window.__THREE__||(window.__THREE__="179"));const Ks=["alphaMap","alphaTest","anisotropy","anisotropyMap","anisotropyRotation","aoMap","aoMapIntensity","attenuationColor","attenuationDistance","bumpMap","clearcoat","clearcoatMap","clearcoatNormalMap","clearcoatNormalScale","clearcoatRoughness","color","dispersion","displacementMap","emissive","emissiveIntensity","emissiveMap","envMap","envMapIntensity","gradientMap","ior","iridescence","iridescenceIOR","iridescenceMap","iridescenceThicknessMap","lightMap","lightMapIntensity","map","matcap","metalness","metalnessMap","normalMap","normalScale","opacity","roughness","roughnessMap","sheen","sheenColor","sheenColorMap","sheenRoughnessMap","shininess","specular","specularColor","specularColorMap","specularIntensity","specularIntensityMap","specularMap","thickness","transmission","transmissionMap"],Qs=new WeakMap;class tr{constructor(t){this.renderObjects=new WeakMap,this.hasNode=this.containsNode(t),this.hasAnimation=!0===t.object.isSkinnedMesh,this.refreshUniforms=Ks,this.renderId=0}firstInitialization(t){return!1===this.renderObjects.has(t)&&(this.getRenderObjectData(t),!0)}needsVelocity(t){const e=t.getMRT();return null!==e&&e.has("velocity")}getRenderObjectData(t){let e=this.renderObjects.get(t);if(void 0===e){const{geometry:s,material:r,object:i}=t;if(e={material:this.getMaterialData(r),geometry:{id:s.id,attributes:this.getAttributesData(s.attributes),indexVersion:s.index?s.index.version:null,drawRange:{start:s.drawRange.start,count:s.drawRange.count}},worldMatrix:i.matrixWorld.clone()},i.center&&(e.center=i.center.clone()),i.morphTargetInfluences&&(e.morphTargetInfluences=i.morphTargetInfluences.slice()),null!==t.bundle&&(e.version=t.bundle.version),e.material.transmission>0){const{width:s,height:r}=t.context;e.bufferWidth=s,e.bufferHeight=r}e.lights=this.getLightsData(t.lightsNode.getLights()),this.renderObjects.set(t,e)}return e}getAttributesData(t){const e={};for(const s in t){const r=t[s];e[s]={version:r.version}}return e}containsNode(t){const e=t.material;for(const t in e)if(e[t]&&e[t].isNode)return!0;return null!==t.renderer.overrideNodes.modelViewMatrix||null!==t.renderer.overrideNodes.modelNormalViewMatrix}getMaterialData(t){const e={};for(const s of this.refreshUniforms){const r=t[s];null!=r&&("object"==typeof r&&void 0!==r.clone?!0===r.isTexture?e[s]={id:r.id,version:r.version}:e[s]=r.clone():e[s]=r)}return e}equals(t,e){const{object:s,material:r,geometry:i}=t,n=this.getRenderObjectData(t);if(!0!==n.worldMatrix.equals(s.matrixWorld))return n.worldMatrix.copy(s.matrixWorld),!1;const a=n.material;for(const t in a){const e=a[t],s=r[t];if(void 0!==e.equals){if(!1===e.equals(s))return e.copy(s),!1}else if(!0===s.isTexture){if(e.id!==s.id||e.version!==s.version)return e.id=s.id,e.version=s.version,!1}else if(e!==s)return a[t]=s,!1}if(a.transmission>0){const{width:e,height:s}=t.context;if(n.bufferWidth!==e||n.bufferHeight!==s)return n.bufferWidth=e,n.bufferHeight=s,!1}const o=n.geometry,h=i.attributes,l=o.attributes,u=Object.keys(l),c=Object.keys(h);if(o.id!==i.id)return o.id=i.id,!1;if(u.length!==c.length)return n.geometry.attributes=this.getAttributesData(h),!1;for(const t of u){const e=l[t],s=h[t];if(void 0===s)return delete l[t],!1;if(e.version!==s.version)return e.version=s.version,!1}const d=i.index,p=o.indexVersion,m=d?d.version:null;if(p!==m)return o.indexVersion=m,!1;if(o.drawRange.start!==i.drawRange.start||o.drawRange.count!==i.drawRange.count)return o.drawRange.start=i.drawRange.start,o.drawRange.count=i.drawRange.count,!1;if(n.morphTargetInfluences){let t=!1;for(let e=0;e<n.morphTargetInfluences.length;e++)n.morphTargetInfluences[e]!==s.morphTargetInfluences[e]&&(t=!0);if(t)return!0}if(n.lights)for(let t=0;t<e.length;t++)if(n.lights[t].map!==e[t].map)return!1;return n.center&&!1===n.center.equals(s.center)?(n.center.copy(s.center),!0):(null!==t.bundle&&(n.version=t.bundle.version),!0)}getLightsData(t){const e=[];for(const s of t)!0===s.isSpotLight&&null!==s.map&&e.push({map:s.map.version});return e}getLights(t,e){if(Qs.has(t)){const s=Qs.get(t);if(s.renderId===e)return s.lightsData}const s=this.getLightsData(t.getLights());return Qs.set(t,{renderId:e,lightsData:s}),s}needsRefresh(t,e){if(this.hasNode||this.hasAnimation||this.firstInitialization(t)||this.needsVelocity(e.renderer))return!0;const{renderId:s}=e;if(this.renderId!==s)return this.renderId=s,!0;const r=!0===t.object.static,i=null!==t.bundle&&!0===t.bundle.static&&this.getRenderObjectData(t).version===t.bundle.version;if(r||i)return!1;const n=this.getLights(t.lightsNode,s);return!0!==this.equals(t,n)}}function er(t,e=0){let s=3735928559^e,r=1103547991^e;if(t instanceof Array)for(let e,i=0;i<t.length;i++)e=t[i],s=Math.imul(s^e,2654435761),r=Math.imul(r^e,1597334677);else for(let e,i=0;i<t.length;i++)e=t.charCodeAt(i),s=Math.imul(s^e,2654435761),r=Math.imul(r^e,1597334677);return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(r^r>>>13,3266489909),r=Math.imul(r^r>>>16,2246822507),r^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&r)+(s>>>0)}const sr=t=>er(t),rr=(...t)=>er(t);function ir(t,e=!1){const s=[];!0===t.isNode&&(s.push(t.id),t=t.getSelf());for(const{property:r,childNode:i}of nr(t))s.push(er(r.slice(0,-4)),i.getCacheKey(e));return er(s)}function*nr(t,e=!1){for(const s in t){if(!0===s.startsWith("_"))continue;const r=t[s];if(!0===Array.isArray(r))for(let t=0;t<r.length;t++){const i=r[t];i&&(!0===i.isNode||e&&"function"==typeof i.toJSON)&&(yield{property:s,index:t,childNode:i})}else if(r&&!0===r.isNode)yield{property:s,childNode:r};else if(r&&Object.getPrototypeOf(r)===Object.prototype)for(const t in r){if(!0===t.startsWith("_"))continue;const i=r[t];i&&(!0===i.isNode||e&&"function"==typeof i.toJSON)&&(yield{property:s,index:t,childNode:i})}}}const ar=new Map([[1,"float"],[2,"vec2"],[3,"vec3"],[4,"vec4"],[9,"mat3"],[16,"mat4"]]),or=new WeakMap;function hr(t){if(/[iu]?vec\d/.test(t))return t.startsWith("ivec")?Int32Array:t.startsWith("uvec")?Uint32Array:Float32Array;if(/mat\d/.test(t))return Float32Array;if(/float/.test(t))return Float32Array;if(/uint/.test(t))return Uint32Array;if(/int/.test(t))return Int32Array;throw new Error(`THREE.NodeUtils: Unsupported type: ${t}`)}function lr(t){return/float|int|uint/.test(t)?1:/vec2/.test(t)?2:/vec3/.test(t)?3:/vec4/.test(t)||/mat2/.test(t)?4:/mat3/.test(t)?9:/mat4/.test(t)?16:void 0}function ur(t){return/float|int|uint/.test(t)?1:/vec2/.test(t)?2:/vec3/.test(t)?3:/vec4/.test(t)||/mat2/.test(t)?4:/mat3/.test(t)?12:/mat4/.test(t)?16:void 0}function cr(t){return/float|int|uint/.test(t)?4:/vec2/.test(t)?8:/vec3/.test(t)||/vec4/.test(t)?16:/mat2/.test(t)?8:/mat3/.test(t)?48:/mat4/.test(t)?64:void 0}function dr(t){if(null==t)return null;const e=typeof t;return!0===t.isNode?"node":"number"===e?"float":"boolean"===e?"bool":"string"===e?"string":"function"===e?"shader":!0===t.isVector2?"vec2":!0===t.isVector3?"vec3":!0===t.isVector4?"vec4":!0===t.isMatrix2?"mat2":!0===t.isMatrix3?"mat3":!0===t.isMatrix4?"mat4":!0===t.isColor?"color":t instanceof ArrayBuffer?"ArrayBuffer":null}function pr(t,...e){const s=t?t.slice(-4):void 0;return 1===e.length&&("vec2"===s?e=[e[0],e[0]]:"vec3"===s?e=[e[0],e[0],e[0]]:"vec4"===s&&(e=[e[0],e[0],e[0],e[0]])),"color"===t?new Ee(...e):"vec2"===s?new U(...e):"vec3"===s?new j(...e):"vec4"===s?new ct(...e):"mat2"===s?new Js(...e):"mat3"===s?new G(...e):"mat4"===s?new Ut(...e):"bool"===t?e[0]||!1:"float"===t||"int"===t||"uint"===t?e[0]||0:"string"===t?e[0]||"":"ArrayBuffer"===t?yr(e[0]):null}function mr(t){let e=or.get(t);return void 0===e&&(e={},or.set(t,e)),e}function gr(t){let e="";const s=new Uint8Array(t);for(let t=0;t<s.length;t++)e+=String.fromCharCode(s[t]);return btoa(e)}function yr(t){return Uint8Array.from(atob(t),t=>t.charCodeAt(0)).buffer}const fr={VERTEX:"vertex",FRAGMENT:"fragment"},xr={NONE:"none",FRAME:"frame",RENDER:"render",OBJECT:"object"},br={READ_ONLY:"readOnly",WRITE_ONLY:"writeOnly",READ_WRITE:"readWrite"},vr=["fragment","vertex"],Nr=[...vr,"compute"],wr=["x","y","z","w"],Tr={analyze:"setup",generate:"analyze"};let Mr=0;class _r extends z{static get type(){return"Node"}constructor(t=null){super(),this.nodeType=t,this.updateType=xr.NONE,this.updateBeforeType=xr.NONE,this.updateAfterType=xr.NONE,this.uuid=D.generateUUID(),this.version=0,this.global=!1,this.parents=!1,this.isNode=!0,this._cacheKey=null,this._cacheKeyVersion=0,Object.defineProperty(this,"id",{value:Mr++})}set needsUpdate(t){!0===t&&this.version++}get type(){return this.constructor.type}onUpdate(t,e){return this.updateType=e,this.update=t.bind(this.getSelf()),this}onFrameUpdate(t){return this.onUpdate(t,xr.FRAME)}onRenderUpdate(t){return this.onUpdate(t,xr.RENDER)}onObjectUpdate(t){return this.onUpdate(t,xr.OBJECT)}onReference(t){return this.updateReference=t.bind(this.getSelf()),this}getSelf(){return this.self||this}updateReference(){return this}isGlobal(){return this.global}*getChildren(){for(const{childNode:t}of nr(this))yield t}dispose(){this.dispatchEvent({type:"dispose"})}traverse(t){t(this);for(const e of this.getChildren())e.traverse(t)}getCacheKey(t=!1){return!0!==(t=t||this.version!==this._cacheKeyVersion)&&null!==this._cacheKey||(this._cacheKey=rr(ir(this,t),this.customCacheKey()),this._cacheKeyVersion=this.version),this._cacheKey}customCacheKey(){return 0}getScope(){return this}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getUpdateAfterType(){return this.updateAfterType}getElementType(t){const e=this.getNodeType(t);return t.getElementType(e)}getMemberType(){return"void"}getNodeType(t){const e=t.getNodeProperties(this);return e.outputNode?e.outputNode.getNodeType(t):this.nodeType}getShared(t){const e=this.getHash(t);return t.getNodeFromHash(e)||this}getArrayCount(){return null}setup(t){const e=t.getNodeProperties(this);let s=0;for(const t of this.getChildren())e["node"+s++]=t;return e.outputNode||null}analyze(t,e=null){const s=t.increaseUsage(this);if(!0===this.parents){const s=t.getDataFromNode(this,"any");s.stages=s.stages||{},s.stages[t.shaderStage]=s.stages[t.shaderStage]||[],s.stages[t.shaderStage].push(e)}if(1===s){const e=t.getNodeProperties(this);for(const s of Object.values(e))s&&!0===s.isNode&&s.build(t,this)}}generate(t,e){const{outputNode:s}=t.getNodeProperties(this);if(s&&!0===s.isNode)return s.build(t,e)}updateBefore(){}updateAfter(){}update(){}build(t,e=null){const s=this.getShared(t);if(this!==s)return s.build(t,e);const r=t.getDataFromNode(this);r.buildStages=r.buildStages||{},r.buildStages[t.buildStage]=!0;const i=Tr[t.buildStage];if(i&&!0!==r.buildStages[i]){const e=t.getBuildStage();t.setBuildStage(i),this.build(t),t.setBuildStage(e)}t.addNode(this),t.addChain(this);let n=null;const a=t.getBuildStage();if("setup"===a){this.updateReference(t);const e=t.getNodeProperties(this);if(!0!==e.initialized){e.initialized=!0,e.outputNode=this.setup(t)||e.outputNode||null;for(const s of Object.values(e))if(s&&!0===s.isNode){if(!0===s.parents){const e=t.getNodeProperties(s);e.parents=e.parents||[],e.parents.push(this)}s.build(t)}}n=e.outputNode}else if("analyze"===a)this.analyze(t,e);else if("generate"===a){if(1===this.generate.length){const s=this.getNodeType(t),r=t.getDataFromNode(this);n=r.snippet,void 0===n?void 0===r.generated?(r.generated=!0,n=this.generate(t)||"",r.snippet=n):n="/* Recursion detected. */":void 0!==r.flowCodes&&void 0!==t.context.nodeBlock&&t.addFlowCodeHierarchy(this,t.context.nodeBlock),n=t.format(n,s,e)}else n=this.generate(t,e)||""}return t.removeChain(this),t.addSequentialNode(this),n}getSerializeChildren(){return nr(this)}serialize(t){const e=this.getSerializeChildren(),s={};for(const{property:r,index:i,childNode:n}of e)void 0!==i?(void 0===s[r]&&(s[r]=Number.isInteger(i)?[]:{}),s[r][i]=n.toJSON(t.meta).uuid):s[r]=n.toJSON(t.meta).uuid;Object.keys(s).length>0&&(t.inputNodes=s)}deserialize(t){if(void 0!==t.inputNodes){const e=t.meta.nodes;for(const s in t.inputNodes)if(Array.isArray(t.inputNodes[s])){const r=[];for(const i of t.inputNodes[s])r.push(e[i]);this[s]=r}else if("object"==typeof t.inputNodes[s]){const r={};for(const i in t.inputNodes[s]){const n=t.inputNodes[s][i];r[i]=e[n]}this[s]=r}else{const r=t.inputNodes[s];this[s]=e[r]}}}toJSON(t){const{uuid:e,type:s}=this,r=void 0===t||"string"==typeof t;r&&(t={textures:{},images:{},nodes:{}});let i=t.nodes[e];function n(t){const e=[];for(const s in t){const r=t[s];delete r.metadata,e.push(r)}return e}if(void 0===i&&(i={uuid:e,type:s,meta:t,metadata:{version:4.7,type:"Node",generator:"Node.toJSON"}},!0!==r&&(t.nodes[i.uuid]=i),this.serialize(i),delete i.meta),r){const e=n(t.textures),s=n(t.images),r=n(t.nodes);e.length>0&&(i.textures=e),s.length>0&&(i.images=s),r.length>0&&(i.nodes=r)}return i}}class Sr extends _r{static get type(){return"ArrayElementNode"}constructor(t,e){super(),this.node=t,this.indexNode=e,this.isArrayElementNode=!0}getNodeType(t){return this.node.getElementType(t)}generate(t){const e=this.indexNode.getNodeType(t);return`${this.node.build(t)}[ ${this.indexNode.build(t,!t.isVector(e)&&t.isInteger(e)?e:"uint")} ]`}}class Ar extends _r{static get type(){return"ConvertNode"}constructor(t,e){super(),this.node=t,this.convertTo=e}getNodeType(t){const e=this.node.getNodeType(t);let s=null;for(const r of this.convertTo.split("|"))null!==s&&t.getTypeLength(e)!==t.getTypeLength(r)||(s=r);return s}serialize(t){super.serialize(t),t.convertTo=this.convertTo}deserialize(t){super.deserialize(t),this.convertTo=t.convertTo}generate(t,e){const s=this.node,r=this.getNodeType(t),i=s.build(t,r);return t.format(i,r,e)}}class Vr extends _r{static get type(){return"TempNode"}constructor(t=null){super(t),this.isTempNode=!0}hasDependencies(t){return t.getDataFromNode(this).usageCount>1}build(t,e){if("generate"===t.getBuildStage()){const s=t.getVectorType(this.getNodeType(t,e)),r=t.getDataFromNode(this);if(void 0!==r.propertyName)return t.format(r.propertyName,s,e);if("void"!==s&&"void"!==e&&this.hasDependencies(t)){const i=super.build(t,s),n=t.getVarFromNode(this,null,s),a=t.getPropertyName(n);return t.addLineFlowCode(`${a} = ${i}`,this),r.snippet=i,r.propertyName=a,t.format(r.propertyName,s,e)}}return super.build(t,e)}}class zr extends Vr{static get type(){return"JoinNode"}constructor(t=[],e=null){super(e),this.nodes=t}getNodeType(t){return null!==this.nodeType?t.getVectorType(this.nodeType):t.getTypeFromLength(this.nodes.reduce((e,s)=>e+t.getTypeLength(s.getNodeType(t)),0))}generate(t,e){const s=this.getNodeType(t),r=t.getTypeLength(s),i=this.nodes,n=t.getComponentType(s),a=[];let o=0;for(const e of i){if(o>=r)break;let s,i=e.getNodeType(t),h=t.getTypeLength(i);o+h>r&&(h=r-o,i=t.getTypeFromLength(h)),o+=h,s=e.build(t,i);const l=t.getComponentType(i);l!==n&&(s=t.format(s,l,n)),a.push(s)}const h=`${t.getType(s)}( ${a.join(", ")} )`;return t.format(h,s,e)}}const Cr=wr.join("");class Ir extends _r{static get type(){return"SplitNode"}constructor(t,e="x"){super(),this.node=t,this.components=e,this.isSplitNode=!0}getVectorLength(){let t=this.components.length;for(const e of this.components)t=Math.max(wr.indexOf(e)+1,t);return t}getComponentType(t){return t.getComponentType(this.node.getNodeType(t))}getNodeType(t){return t.getTypeFromLength(this.components.length,this.getComponentType(t))}generate(t,e){const s=this.node,r=t.getTypeLength(s.getNodeType(t));let i=null;if(r>1){let n=null;this.getVectorLength()>=r&&(n=t.getTypeFromLength(this.getVectorLength(),this.getComponentType(t)));const a=s.build(t,n);i=this.components.length===r&&this.components===Cr.slice(0,this.components.length)?t.format(a,n,e):t.format(`${a}.${this.components}`,this.getNodeType(t),e)}else i=s.build(t,e);return i}serialize(t){super.serialize(t),t.components=this.components}deserialize(t){super.deserialize(t),this.components=t.components}}class Rr extends Vr{static get type(){return"SetNode"}constructor(t,e,s){super(),this.sourceNode=t,this.components=e,this.targetNode=s}getNodeType(t){return this.sourceNode.getNodeType(t)}generate(t){const{sourceNode:e,components:s,targetNode:r}=this,i=this.getNodeType(t),n=t.getComponentType(r.getNodeType(t)),a=t.getTypeFromLength(s.length,n),o=r.build(t,a),h=e.build(t,i),l=t.getTypeLength(i),u=[];for(let t=0;t<l;t++){const e=wr[t];e===s[0]?(u.push(o),t+=s.length-1):u.push(h+"."+e)}return`${t.getType(i)}( ${u.join(", ")} )`}}class Er extends Vr{static get type(){return"FlipNode"}constructor(t,e){super(),this.sourceNode=t,this.components=e}getNodeType(t){return this.sourceNode.getNodeType(t)}generate(t){const{components:e,sourceNode:s}=this,r=this.getNodeType(t),i=s.build(t),n=t.getVarFromNode(this),a=t.getPropertyName(n);t.addLineFlowCode(a+" = "+i,this);const o=t.getTypeLength(r),h=[];let l=0;for(let t=0;t<o;t++){const s=wr[t];s===e[l]?(h.push("1.0 - "+a+"."+s),l++):h.push(a+"."+s)}return`${t.getType(r)}( ${h.join(", ")} )`}}class Lr extends _r{static get type(){return"InputNode"}constructor(t,e=null){super(e),this.isInputNode=!0,this.value=t,this.precision=null}getNodeType(){return null===this.nodeType?dr(this.value):this.nodeType}getInputType(t){return this.getNodeType(t)}setPrecision(t){return this.precision=t,this}serialize(t){super.serialize(t),t.value=this.value,this.value&&this.value.toArray&&(t.value=this.value.toArray()),t.valueType=dr(this.value),t.nodeType=this.nodeType,"ArrayBuffer"===t.valueType&&(t.value=gr(t.value)),t.precision=this.precision}deserialize(t){super.deserialize(t),this.nodeType=t.nodeType,this.value=Array.isArray(t.value)?pr(t.valueType,...t.value):t.value,this.precision=t.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(t.value))}generate(){}}const Or=/float|u?int/;class Pr extends Lr{static get type(){return"ConstNode"}constructor(t,e=null){super(t,e),this.isConstNode=!0}generateConst(t){return t.generateConst(this.getNodeType(t),this.value)}generate(t,e){const s=this.getNodeType(t);return Or.test(s)&&Or.test(e)?t.generateConst(e,this.value):t.format(this.generateConst(t),s,e)}}class Fr extends _r{static get type(){return"MemberNode"}constructor(t,e){super(),this.node=t,this.property=e,this.isMemberNode=!0}getNodeType(t){return this.node.getMemberType(t,this.property)}generate(t){return this.node.build(t)+"."+this.property}}let Br=null;const kr=new Map;function Dr(t,e){if(!kr.has(t)){if("function"!=typeof e)throw new Error(`THREE.TSL: Node element ${t} is not a function`);kr.set(t,e)}}const Ur=t=>t.replace(/r|s/g,"x").replace(/g|t/g,"y").replace(/b|p/g,"z").replace(/a|q/g,"w"),Wr=t=>Ur(t).split("").sort().join(""),jr={setup(t,e){const s=e.shift();return t(gi(s),...e)},get(t,e,s){if("string"==typeof e&&void 0===t[e]){if(!0!==t.isStackNode&&"assign"===e)return(...t)=>(Br.assign(s,...t),s);if(kr.has(e)){const r=kr.get(e);return t.isStackNode?(...t)=>s.add(r(...t)):(...t)=>r(s,...t)}if("toVarIntent"===e)return()=>s;if("self"===e)return t;if(e.endsWith("Assign")&&kr.has(e.slice(0,e.length-6))){const r=kr.get(e.slice(0,e.length-6));return t.isStackNode?(...t)=>s.assign(t[0],r(...t)):(...t)=>s.assign(r(s,...t))}if(!0===/^[xyzwrgbastpq]{1,4}$/.test(e))return e=Ur(e),pi(new Ir(s,e));if(!0===/^set[XYZWRGBASTPQ]{1,4}$/.test(e))return e=Wr(e.slice(3).toLowerCase()),s=>pi(new Rr(t,e,pi(s)));if(!0===/^flip[XYZWRGBASTPQ]{1,4}$/.test(e))return e=Wr(e.slice(4).toLowerCase()),()=>pi(new Er(pi(t),e));if("width"===e||"height"===e||"depth"===e)return"width"===e?e="x":"height"===e?e="y":"depth"===e&&(e="z"),pi(new Ir(t,e));if(!0===/^\d+$/.test(e))return pi(new Sr(s,new Pr(Number(e),"uint")));if(!0===/^get$/.test(e))return t=>pi(new Fr(s,t))}return Reflect.get(t,e,s)},set:(t,e,s,r)=>"string"!=typeof e||void 0!==t[e]||!0!==/^[xyzwrgbastpq]{1,4}$/.test(e)&&"width"!==e&&"height"!==e&&"depth"!==e&&!0!==/^\d+$/.test(e)?Reflect.set(t,e,s,r):(r[e].assign(s),!0)},qr=new WeakMap,Hr=new WeakMap,Gr=function(t,e=null){for(const s in t)t[s]=pi(t[s],e);return t},Xr=function(t,e=null){const s=t.length;for(let r=0;r<s;r++)t[r]=pi(t[r],e);return t},Yr=function(t,e=null,s=null,r=null){function i(t){return null!==r?(t=pi(Object.assign(t,r)),!0===r.intent&&(t=t.toVarIntent())):t=pi(t),t}let n,a,o,h=e;function l(e){let s;return s=h?/[a-z]/i.test(h)?h+"()":h:t.type,void 0!==a&&e.length<a?e.concat(new Array(a-e.length).fill(0)):void 0!==o&&e.length>o?e.slice(0,o):e}return null===e?n=(...e)=>i(new t(...yi(l(e)))):null!==s?(s=pi(s),n=(...r)=>i(new t(e,...yi(l(r)),s))):n=(...s)=>i(new t(e,...yi(l(s)))),n.setParameterLength=(...t)=>(1===t.length?a=o=t[0]:2===t.length&&([a,o]=t),n),n.setName=t=>(h=t,n),n},Zr=function(t,...e){return pi(new t(...yi(e)))};class $r extends _r{constructor(t,e){super(),this.shaderNode=t,this.inputNodes=e,this.isShaderCallNodeInternal=!0}getNodeType(t){return this.shaderNode.nodeType||this.getOutputNode(t).getNodeType(t)}getMemberType(t,e){return this.getOutputNode(t).getMemberType(t,e)}call(t){const{shaderNode:e,inputNodes:s}=this,r=t.getNodeProperties(e),i=t.getClosestSubBuild(e.subBuilds)||"",n=i||"default";if(r[n])return r[n];const a=t.subBuildFn;t.subBuildFn=i;let o=null;if(e.layout){let r=Hr.get(t.constructor);void 0===r&&(r=new WeakMap,Hr.set(t.constructor,r));let i=r.get(e);void 0===i&&(i=pi(t.buildFunctionNode(e)),r.set(e,i)),t.addInclude(i),o=pi(i.call(s))}else{let r=s;if(Array.isArray(r)){let t=0;r=new Proxy(r,{get:(e,s,r)=>void 0===e[s]?e[t++]:Reflect.get(e,s,r)})}const i=e.jsFunc,n=null!==r||i.length>1?i(r||[],t):i(t);o=pi(n)}return t.subBuildFn=a,e.once&&(r[n]=o),o}setupOutput(t){return t.addStack(),t.stack.outputNode=this.call(t),t.removeStack()}getOutputNode(t){const e=t.getNodeProperties(this),s=t.getSubBuildOutput(this);return e[s]=e[s]||this.setupOutput(t),e[s].subBuild=t.getClosestSubBuild(this),e[s]}build(t,e=null){let s=null;const r=t.getBuildStage(),i=t.getNodeProperties(this),n=t.getSubBuildOutput(this),a=this.getOutputNode(t);if("setup"===r){const e=t.getSubBuildProperty("initialized",this);if(!0!==i[e]&&(i[e]=!0,i[n]=this.getOutputNode(t),i[n].build(t),this.shaderNode.subBuilds))for(const e of t.chaining){const s=t.getDataFromNode(e,"any");s.subBuilds=s.subBuilds||new Set;for(const t of this.shaderNode.subBuilds)s.subBuilds.add(t)}s=i[n]}else"analyze"===r?a.build(t,e):"generate"===r&&(s=a.build(t,e)||"");return s}}class Jr extends _r{constructor(t,e){super(e),this.jsFunc=t,this.layout=null,this.global=!0,this.once=!1}setLayout(t){return this.layout=t,this}call(t=null){return gi(t),pi(new $r(this,t))}setup(){return this.call()}}const Kr=[!1,!0],Qr=[0,1,2,3],ti=[-1,-2],ei=[.5,1.5,1/3,1e-6,1e6,Math.PI,2*Math.PI,1/Math.PI,2/Math.PI,1/(2*Math.PI),Math.PI/2],si=new Map;for(const t of Kr)si.set(t,new Pr(t));const ri=new Map;for(const t of Qr)ri.set(t,new Pr(t,"uint"));const ii=new Map([...ri].map(t=>new Pr(t.value,"int")));for(const t of ti)ii.set(t,new Pr(t,"int"));const ni=new Map([...ii].map(t=>new Pr(t.value)));for(const t of ei)ni.set(t,new Pr(t));for(const t of ei)ni.set(-t,new Pr(-t));const ai={bool:si,uint:ri,ints:ii,float:ni},oi=new Map([...si,...ni]),hi=(t,e)=>oi.has(t)?oi.get(t):!0===t.isNode?t:new Pr(t,e),li=function(t,e=null){return(...s)=>{if((0===s.length||!["bool","float","int","uint"].includes(t)&&s.every(t=>"object"!=typeof t))&&(s=[pr(t,...s)]),1===s.length&&null!==e&&e.has(s[0]))return mi(e.get(s[0]));if(1===s.length){const e=hi(s[0],t);return e.nodeType===t?mi(e):mi(new Ar(e,t))}const r=s.map(t=>hi(t));return mi(new zr(r,t))}},ui=t=>"object"==typeof t&&null!==t?t.value:t,ci=t=>null!=t?t.nodeType||t.convertTo||("string"==typeof t?t:null):null;function di(t,e){return new Proxy(new Jr(t,e),jr)}const pi=(t,e=null)=>function(t,e=null){const s=dr(t);if("node"===s){let e=qr.get(t);return void 0===e&&(e=new Proxy(t,jr),qr.set(t,e),qr.set(e,e)),e}return null===e&&("float"===s||"boolean"===s)||s&&"shader"!==s&&"string"!==s?pi(hi(t,e)):"shader"===s?t.isFn?t:Ni(t):t}(t,e),mi=(t,e=null)=>pi(t,e).toVarIntent(),gi=(t,e=null)=>new Gr(t,e),yi=(t,e=null)=>new Xr(t,e),fi=(t,e=null,s=null,r=null)=>new Yr(t,e,s,r),xi=(t,...e)=>new Zr(t,...e),bi=(t,e=null,s=null,r={})=>new Yr(t,e,s,{intent:!0,...r});let vi=0;const Ni=(t,e=null)=>{let s=null;null!==e&&("object"==typeof e?s=e.return:("string"==typeof e&&(s=e),e=null));const r=new di(t,s),i=(...t)=>{let e;gi(t);e=t[0]&&(t[0].isNode||Object.getPrototypeOf(t[0])!==Object.prototype)?[...t]:t[0];const i=r.call(e);return"void"===s&&i.toStack(),i.toVarIntent()};if(i.shaderNode=r,i.id=r.id,i.isFn=!0,i.getNodeType=(...t)=>r.getNodeType(...t),i.getCacheKey=(...t)=>r.getCacheKey(...t),i.setLayout=t=>(r.setLayout(t),i),i.once=(t=null)=>(r.once=!0,r.subBuilds=t,i),null!==e){if("object"!=typeof e.inputs){const t={name:"fn"+vi++,type:s,inputs:[]};for(const s in e)"return"!==s&&t.inputs.push({name:s,type:e[s]});e=t}i.setLayout(e)}return i},wi=t=>{Br=t},Ti=()=>Br,Mi=(...t)=>Br.If(...t);function _i(t){return Br&&Br.add(t),t}Dr("toStack",_i);const Si=new li("color"),Ai=new li("float",ai.float),Vi=new li("int",ai.ints),zi=new li("uint",ai.uint),Ci=new li("bool",ai.bool),Ii=new li("vec2"),Ri=new li("ivec2"),Ei=new li("uvec2"),Li=new li("bvec2"),Oi=new li("vec3"),Pi=new li("ivec3"),Fi=new li("uvec3"),Bi=new li("bvec3"),ki=new li("vec4"),Di=new li("ivec4"),Ui=new li("uvec4"),Wi=new li("bvec4"),ji=new li("mat2"),qi=new li("mat3"),Hi=new li("mat4");Dr("toColor",Si),Dr("toFloat",Ai),Dr("toInt",Vi),Dr("toUint",zi),Dr("toBool",Ci),Dr("toVec2",Ii),Dr("toIVec2",Ri),Dr("toUVec2",Ei),Dr("toBVec2",Li),Dr("toVec3",Oi),Dr("toIVec3",Pi),Dr("toUVec3",Fi),Dr("toBVec3",Bi),Dr("toVec4",ki),Dr("toIVec4",Di),Dr("toUVec4",Ui),Dr("toBVec4",Wi),Dr("toMat2",ji),Dr("toMat3",qi),Dr("toMat4",Hi);const Gi=fi(Sr).setParameterLength(2),Xi=(t,e)=>pi(new Ar(pi(t),e));Dr("element",Gi),Dr("convert",Xi);Dr("append",t=>_i(t));class Yi extends _r{static get type(){return"PropertyNode"}constructor(t,e=null,s=!1){super(t),this.name=e,this.varying=s,this.isPropertyNode=!0,this.global=!0}getHash(t){return this.name||super.getHash(t)}generate(t){let e;return!0===this.varying?(e=t.getVaryingFromNode(this,this.name),e.needsInterpolation=!0):e=t.getVarFromNode(this,this.name),t.getPropertyName(e)}}const Zi=(t,e)=>pi(new Yi(t,e)),$i=(t,e)=>pi(new Yi(t,e,!0)),Ji=xi(Yi,"vec4","DiffuseColor"),Ki=xi(Yi,"vec3","EmissiveColor"),Qi=xi(Yi,"float","Roughness"),tn=xi(Yi,"float","Metalness"),en=xi(Yi,"float","Clearcoat"),sn=xi(Yi,"float","ClearcoatRoughness"),rn=xi(Yi,"vec3","Sheen"),nn=xi(Yi,"float","SheenRoughness"),an=xi(Yi,"float","Iridescence"),on=xi(Yi,"float","IridescenceIOR"),hn=xi(Yi,"float","IridescenceThickness"),ln=xi(Yi,"float","AlphaT"),un=xi(Yi,"float","Anisotropy"),cn=xi(Yi,"vec3","AnisotropyT"),dn=xi(Yi,"vec3","AnisotropyB"),pn=xi(Yi,"color","SpecularColor"),mn=xi(Yi,"float","SpecularF90"),gn=xi(Yi,"float","Shininess"),yn=xi(Yi,"vec4","Output"),fn=xi(Yi,"float","dashSize"),xn=xi(Yi,"float","gapSize"),bn=xi(Yi,"float","pointWidth"),vn=xi(Yi,"float","IOR"),Nn=xi(Yi,"float","Transmission"),wn=xi(Yi,"float","Thickness"),Tn=xi(Yi,"float","AttenuationDistance"),Mn=xi(Yi,"color","AttenuationColor"),_n=xi(Yi,"float","Dispersion");class Sn extends _r{static get type(){return"UniformGroupNode"}constructor(t,e=!1,s=1){super("string"),this.name=t,this.shared=e,this.order=s,this.isUniformGroup=!0}serialize(t){super.serialize(t),t.name=this.name,t.version=this.version,t.shared=this.shared}deserialize(t){super.deserialize(t),this.name=t.name,this.version=t.version,this.shared=t.shared}}const An=t=>new Sn(t),Vn=(t,e=0)=>new Sn(t,!0,e),zn=Vn("frame"),Cn=Vn("render"),In=An("object");class Rn extends Lr{static get type(){return"UniformNode"}constructor(t,e=null){super(t,e),this.isUniformNode=!0,this.name="",this.groupNode=In}setName(t){return this.name=t,this}label(t){return this.setName(t)}setGroup(t){return this.groupNode=t,this}getGroup(){return this.groupNode}getUniformHash(t){return this.getHash(t)}onUpdate(t,e){const s=this.getSelf();return t=t.bind(s),super.onUpdate(e=>{const r=t(e,s);void 0!==r&&(this.value=r)},e)}getInputType(t){let e=super.getInputType(t);return"bool"===e&&(e="uint"),e}generate(t,e){const s=this.getNodeType(t),r=this.getUniformHash(t);let i=t.getNodeFromHash(r);void 0===i&&(t.setHashNode(this,r),i=this);const n=i.getInputType(t),a=t.getUniformFromNode(i,n,t.shaderStage,this.name||t.context.nodeName),o=t.getPropertyName(a);void 0!==t.context.nodeName&&delete t.context.nodeName;let h=o;if("bool"===s){const e=t.getDataFromNode(this);let r=e.propertyName;if(void 0===r){const i=t.getVarFromNode(this,null,"bool");r=t.getPropertyName(i),e.propertyName=r,h=t.format(o,n,s),t.addLineFlowCode(`${r} = ${h}`,this)}h=r}return t.format(h,s,e)}}const En=(t,e)=>{const s=ci(e||t),r=t&&!0===t.isNode?t.node&&t.node.value||t.value:t;return pi(new Rn(r,s))};class Ln extends Vr{static get type(){return"ArrayNode"}constructor(t,e,s=null){super(t),this.count=e,this.values=s,this.isArrayNode=!0}getArrayCount(){return this.count}getNodeType(t){return null===this.nodeType&&(this.nodeType=this.values[0].getNodeType(t)),this.nodeType}getElementType(t){return this.getNodeType(t)}generate(t){const e=this.getNodeType(t);return t.generateArray(e,this.count,this.values)}}const On=(...t)=>{let e;if(1===t.length){const s=t[0];e=new Ln(null,s.length,s)}else{const s=t[0],r=t[1];e=new Ln(s,r)}return pi(e)};Dr("toArray",(t,e)=>On(Array(e).fill(t)));class Pn extends Vr{static get type(){return"AssignNode"}constructor(t,e){super(),this.targetNode=t,this.sourceNode=e,this.isAssignNode=!0}hasDependencies(){return!1}getNodeType(t,e){return"void"!==e?this.targetNode.getNodeType(t):"void"}needsSplitAssign(t){const{targetNode:e}=this;if(!1===t.isAvailable("swizzleAssign")&&e.isSplitNode&&e.components.length>1){const s=t.getTypeLength(e.node.getNodeType(t));return wr.join("").slice(0,s)!==e.components}return!1}setup(t){const{targetNode:e,sourceNode:s}=this;t.getNodeProperties(e).assign=!0;const r=t.getNodeProperties(this);r.sourceNode=s,r.targetNode=e.context({assign:!0})}generate(t,e){const{targetNode:s,sourceNode:r}=t.getNodeProperties(this),i=this.needsSplitAssign(t),n=s.getNodeType(t),a=s.build(t),o=r.build(t,n),h=r.getNodeType(t),l=t.getDataFromNode(this);let u;if(!0===l.initialized)"void"!==e&&(u=a);else if(i){const r=t.getVarFromNode(this,null,n),i=t.getPropertyName(r);t.addLineFlowCode(`${i} = ${o}`,this);const h=s.node,l=h.node.context({assign:!0}).build(t);for(let e=0;e<h.components.length;e++){const s=h.components[e];t.addLineFlowCode(`${l}.${s} = ${i}[ ${e} ]`,this)}"void"!==e&&(u=a)}else u=`${a} = ${o}`,"void"!==e&&"void"!==h||(t.addLineFlowCode(u,this),"void"!==e&&(u=a));return l.initialized=!0,t.format(u,n,e)}}const Fn=fi(Pn).setParameterLength(2);Dr("assign",Fn);class Bn extends Vr{static get type(){return"FunctionCallNode"}constructor(t=null,e={}){super(),this.functionNode=t,this.parameters=e}setParameters(t){return this.parameters=t,this}getParameters(){return this.parameters}getNodeType(t){return this.functionNode.getNodeType(t)}generate(t){const e=[],s=this.functionNode,r=s.getInputs(t),i=this.parameters,n=(e,s)=>{const r=s.type;let i;return i="pointer"===r?"&"+e.build(t):e.build(t,r),i};if(Array.isArray(i)){if(i.length>r.length)i.length=r.length;else if(i.length<r.length)for(;i.length<r.length;)i.push(Ai(0));for(let t=0;t<i.length;t++)e.push(n(i[t],r[t]))}else for(const t of r){const s=i[t.name];void 0!==s?e.push(n(s,t)):e.push(n(Ai(0),t))}return`${s.build(t,"property")}( ${e.join(", ")} )`}}const kn=(t,...e)=>(e=e.length>1||e[0]&&!0===e[0].isNode?yi(e):gi(e[0]),pi(new Bn(pi(t),e)));Dr("call",kn);const Dn={"==":"equal","!=":"notEqual","<":"lessThan",">":"greaterThan","<=":"lessThanEqual",">=":"greaterThanEqual","%":"mod"};class Un extends Vr{static get type(){return"OperatorNode"}constructor(t,e,s,...r){if(super(),r.length>0){let i=new Un(t,e,s);for(let e=0;e<r.length-1;e++)i=new Un(t,i,r[e]);e=i,s=r[r.length-1]}this.op=t,this.aNode=e,this.bNode=s,this.isOperatorNode=!0}getOperatorMethod(t,e){return t.getMethod(Dn[this.op],e)}getNodeType(t){const e=this.op,s=this.aNode,r=this.bNode,i=s.getNodeType(t),n=r?r.getNodeType(t):null;if("void"===i||"void"===n)return"void";if("%"===e)return i;if("~"===e||"&"===e||"|"===e||"^"===e||">>"===e||"<<"===e)return t.getIntegerType(i);if("!"===e||"&&"===e||"||"===e||"^^"===e)return"bool";if("=="===e||"!="===e||"<"===e||">"===e||"<="===e||">="===e){const e=Math.max(t.getTypeLength(i),t.getTypeLength(n));return e>1?`bvec${e}`:"bool"}if(t.isMatrix(i)){if("float"===n)return i;if(t.isVector(n))return t.getVectorFromMatrix(i);if(t.isMatrix(n))return i}else if(t.isMatrix(n)){if("float"===i)return n;if(t.isVector(i))return t.getVectorFromMatrix(n)}return t.getTypeLength(n)>t.getTypeLength(i)?n:i}generate(t,e){const s=this.op,{aNode:r,bNode:i}=this,n=this.getNodeType(t);let a=null,o=null;"void"!==n?(a=r.getNodeType(t),o=i?i.getNodeType(t):null,"<"===s||">"===s||"<="===s||">="===s||"=="===s||"!="===s?t.isVector(a)?o=a:t.isVector(o)?a=o:a!==o&&(a=o="float"):">>"===s||"<<"===s?(a=n,o=t.changeComponentType(o,"uint")):"%"===s?(a=n,o=t.isInteger(a)&&t.isInteger(o)?o:a):t.isMatrix(a)?"float"===o?o="float":t.isVector(o)?o=t.getVectorFromMatrix(a):t.isMatrix(o)||(a=o=n):a=t.isMatrix(o)?"float"===a?"float":t.isVector(a)?t.getVectorFromMatrix(o):o=n:o=n):a=o=n;const h=r.build(t,a),l=i?i.build(t,o):null,u=t.getFunctionOperator(s);if("void"!==e){const r=t.renderer.coordinateSystem===A;if("=="===s||"!="===s||"<"===s||">"===s||"<="===s||">="===s)return r&&t.isVector(a)?t.format(`${this.getOperatorMethod(t,e)}( ${h}, ${l} )`,n,e):t.format(`( ${h} ${s} ${l} )`,n,e);if("%"===s)return t.isInteger(o)?t.format(`( ${h} % ${l} )`,n,e):t.format(`${this.getOperatorMethod(t,n)}( ${h}, ${l} )`,n,e);if("!"===s||"~"===s)return t.format(`(${s}${h})`,a,e);if(u)return t.format(`${u}( ${h}, ${l} )`,n,e);if(t.isMatrix(a)&&"float"===o)return t.format(`( ${l} ${s} ${h} )`,n,e);if("float"===a&&t.isMatrix(o))return t.format(`${h} ${s} ${l}`,n,e);{let i=`( ${h} ${s} ${l} )`;return!r&&"bool"===n&&t.isVector(a)&&t.isVector(o)&&(i=`all${i}`),t.format(i,n,e)}}if("void"!==a)return u?t.format(`${u}( ${h}, ${l} )`,n,e):t.isMatrix(a)&&"float"===o?t.format(`${l} ${s} ${h}`,n,e):t.format(`${h} ${s} ${l}`,n,e)}serialize(t){super.serialize(t),t.op=this.op}deserialize(t){super.deserialize(t),this.op=t.op}}const Wn=bi(Un,"+").setParameterLength(2,1/0).setName("add"),jn=bi(Un,"-").setParameterLength(2,1/0).setName("sub"),qn=bi(Un,"*").setParameterLength(2,1/0).setName("mul"),Hn=bi(Un,"/").setParameterLength(2,1/0).setName("div"),Gn=bi(Un,"%").setParameterLength(2).setName("mod"),Xn=bi(Un,"==").setParameterLength(2).setName("equal"),Yn=bi(Un,"!=").setParameterLength(2).setName("notEqual"),Zn=bi(Un,"<").setParameterLength(2).setName("lessThan"),$n=bi(Un,">").setParameterLength(2).setName("greaterThan"),Jn=bi(Un,"<=").setParameterLength(2).setName("lessThanEqual"),Kn=bi(Un,">=").setParameterLength(2).setName("greaterThanEqual"),Qn=bi(Un,"&&").setParameterLength(2,1/0).setName("and"),ta=bi(Un,"||").setParameterLength(2,1/0).setName("or"),ea=bi(Un,"!").setParameterLength(1).setName("not"),sa=bi(Un,"^^").setParameterLength(2).setName("xor"),ra=bi(Un,"&").setParameterLength(2).setName("bitAnd"),ia=bi(Un,"~").setParameterLength(2).setName("bitNot"),na=bi(Un,"|").setParameterLength(2).setName("bitOr"),aa=bi(Un,"^").setParameterLength(2).setName("bitXor"),oa=bi(Un,"<<").setParameterLength(2).setName("shiftLeft"),ha=bi(Un,">>").setParameterLength(2).setName("shiftRight"),la=Ni(([t])=>(t.addAssign(1),t)),ua=Ni(([t])=>(t.subAssign(1),t)),ca=Ni(([t])=>{const e=Vi(t).toConst();return t.addAssign(1),e}),da=Ni(([t])=>{const e=Vi(t).toConst();return t.subAssign(1),e});Dr("add",Wn),Dr("sub",jn),Dr("mul",qn),Dr("div",Hn),Dr("mod",Gn),Dr("equal",Xn),Dr("notEqual",Yn),Dr("lessThan",Zn),Dr("greaterThan",$n),Dr("lessThanEqual",Jn),Dr("greaterThanEqual",Kn),Dr("and",Qn),Dr("or",ta),Dr("not",ea),Dr("xor",sa),Dr("bitAnd",ra),Dr("bitNot",ia),Dr("bitOr",na),Dr("bitXor",aa),Dr("shiftLeft",oa),Dr("shiftRight",ha),Dr("incrementBefore",la),Dr("decrementBefore",ua),Dr("increment",ca),Dr("decrement",da);const pa=(t,e)=>Gn(Vi(t),Vi(e));Dr("modInt",pa);class ma extends Vr{static get type(){return"MathNode"}constructor(t,e,s=null,r=null){if(super(),(t===ma.MAX||t===ma.MIN)&&arguments.length>3){let i=new ma(t,e,s);for(let e=2;e<arguments.length-1;e++)i=new ma(t,i,arguments[e]);e=i,s=arguments[arguments.length-1],r=null}this.method=t,this.aNode=e,this.bNode=s,this.cNode=r,this.isMathNode=!0}getInputType(t){const e=this.aNode.getNodeType(t),s=this.bNode?this.bNode.getNodeType(t):null,r=this.cNode?this.cNode.getNodeType(t):null,i=t.isMatrix(e)?0:t.getTypeLength(e),n=t.isMatrix(s)?0:t.getTypeLength(s),a=t.isMatrix(r)?0:t.getTypeLength(r);return i>n&&i>a?e:n>a?s:a>i?r:e}getNodeType(t){const e=this.method;return e===ma.LENGTH||e===ma.DISTANCE||e===ma.DOT?"float":e===ma.CROSS?"vec3":e===ma.ALL||e===ma.ANY?"bool":e===ma.EQUALS?t.changeComponentType(this.aNode.getNodeType(t),"bool"):this.getInputType(t)}setup(t){const{aNode:e,bNode:s,method:r}=this;let i=null;if(r===ma.ONE_MINUS)i=jn(1,e);else if(r===ma.RECIPROCAL)i=Hn(1,e);else if(r===ma.DIFFERENCE)i=ka(jn(e,s));else if(r===ma.TRANSFORM_DIRECTION){let r=e,n=s;t.isMatrix(r.getNodeType(t))?n=ki(Oi(n),0):r=ki(Oi(r),0);const a=qn(r,n).xyz;i=Ia(a)}return null!==i?i:super.setup(t)}generate(t,e){if(t.getNodeProperties(this).outputNode)return super.generate(t,e);let s=this.method;const r=this.getNodeType(t),i=this.getInputType(t),n=this.aNode,a=this.bNode,o=this.cNode,h=t.renderer.coordinateSystem;if(s===ma.NEGATE)return t.format("( - "+n.build(t,i)+" )",r,e);{const l=[];return s===ma.CROSS?l.push(n.build(t,r),a.build(t,r)):h===A&&s===ma.STEP?l.push(n.build(t,1===t.getTypeLength(n.getNodeType(t))?"float":i),a.build(t,i)):h!==A||s!==ma.MIN&&s!==ma.MAX?s===ma.REFRACT?l.push(n.build(t,i),a.build(t,i),o.build(t,"float")):s===ma.MIX?l.push(n.build(t,i),a.build(t,i),o.build(t,1===t.getTypeLength(o.getNodeType(t))?"float":i)):(h===V&&s===ma.ATAN&&null!==a&&(s="atan2"),"fragment"===t.shaderStage||s!==ma.DFDX&&s!==ma.DFDY||(s="/*"+s+"*/"),l.push(n.build(t,i)),null!==a&&l.push(a.build(t,i)),null!==o&&l.push(o.build(t,i))):l.push(n.build(t,i),a.build(t,1===t.getTypeLength(a.getNodeType(t))?"float":i)),t.format(`${t.getMethod(s,r)}( ${l.join(", ")} )`,r,e)}}serialize(t){super.serialize(t),t.method=this.method}deserialize(t){super.deserialize(t),this.method=t.method}}ma.ALL="all",ma.ANY="any",ma.RADIANS="radians",ma.DEGREES="degrees",ma.EXP="exp",ma.EXP2="exp2",ma.LOG="log",ma.LOG2="log2",ma.SQRT="sqrt",ma.INVERSE_SQRT="inversesqrt",ma.FLOOR="floor",ma.CEIL="ceil",ma.NORMALIZE="normalize",ma.FRACT="fract",ma.SIN="sin",ma.COS="cos",ma.TAN="tan",ma.ASIN="asin",ma.ACOS="acos",ma.ATAN="atan",ma.ABS="abs",ma.SIGN="sign",ma.LENGTH="length",ma.NEGATE="negate",ma.ONE_MINUS="oneMinus",ma.DFDX="dFdx",ma.DFDY="dFdy",ma.ROUND="round",ma.RECIPROCAL="reciprocal",ma.TRUNC="trunc",ma.FWIDTH="fwidth",ma.TRANSPOSE="transpose",ma.DETERMINANT="determinant",ma.INVERSE="inverse",ma.BITCAST="bitcast",ma.EQUALS="equals",ma.MIN="min",ma.MAX="max",ma.STEP="step",ma.REFLECT="reflect",ma.DISTANCE="distance",ma.DIFFERENCE="difference",ma.DOT="dot",ma.CROSS="cross",ma.POW="pow",ma.TRANSFORM_DIRECTION="transformDirection",ma.MIX="mix",ma.CLAMP="clamp",ma.REFRACT="refract",ma.SMOOTHSTEP="smoothstep",ma.FACEFORWARD="faceforward";const ga=Ai(1e-6),ya=Ai(1e6),fa=Ai(Math.PI),xa=Ai(2*Math.PI),ba=bi(ma,ma.ALL).setParameterLength(1),va=bi(ma,ma.ANY).setParameterLength(1),Na=bi(ma,ma.RADIANS).setParameterLength(1),wa=bi(ma,ma.DEGREES).setParameterLength(1),Ta=bi(ma,ma.EXP).setParameterLength(1),Ma=bi(ma,ma.EXP2).setParameterLength(1),_a=bi(ma,ma.LOG).setParameterLength(1),Sa=bi(ma,ma.LOG2).setParameterLength(1),Aa=bi(ma,ma.SQRT).setParameterLength(1),Va=bi(ma,ma.INVERSE_SQRT).setParameterLength(1),za=bi(ma,ma.FLOOR).setParameterLength(1),Ca=bi(ma,ma.CEIL).setParameterLength(1),Ia=bi(ma,ma.NORMALIZE).setParameterLength(1),Ra=bi(ma,ma.FRACT).setParameterLength(1),Ea=bi(ma,ma.SIN).setParameterLength(1),La=bi(ma,ma.COS).setParameterLength(1),Oa=bi(ma,ma.TAN).setParameterLength(1),Pa=bi(ma,ma.ASIN).setParameterLength(1),Fa=bi(ma,ma.ACOS).setParameterLength(1),Ba=bi(ma,ma.ATAN).setParameterLength(1,2),ka=bi(ma,ma.ABS).setParameterLength(1),Da=bi(ma,ma.SIGN).setParameterLength(1),Ua=bi(ma,ma.LENGTH).setParameterLength(1),Wa=bi(ma,ma.NEGATE).setParameterLength(1),ja=bi(ma,ma.ONE_MINUS).setParameterLength(1),qa=bi(ma,ma.DFDX).setParameterLength(1),Ha=bi(ma,ma.DFDY).setParameterLength(1),Ga=bi(ma,ma.ROUND).setParameterLength(1),Xa=bi(ma,ma.RECIPROCAL).setParameterLength(1),Ya=bi(ma,ma.TRUNC).setParameterLength(1),Za=bi(ma,ma.FWIDTH).setParameterLength(1),$a=bi(ma,ma.TRANSPOSE).setParameterLength(1),Ja=bi(ma,ma.DETERMINANT).setParameterLength(1),Ka=bi(ma,ma.INVERSE).setParameterLength(1),Qa=bi(ma,ma.BITCAST).setParameterLength(2),to=(t,e)=>Xn(t,e),eo=bi(ma,ma.MIN).setParameterLength(2,1/0),so=bi(ma,ma.MAX).setParameterLength(2,1/0),ro=bi(ma,ma.STEP).setParameterLength(2),io=bi(ma,ma.REFLECT).setParameterLength(2),no=bi(ma,ma.DISTANCE).setParameterLength(2),ao=bi(ma,ma.DIFFERENCE).setParameterLength(2),oo=bi(ma,ma.DOT).setParameterLength(2),ho=bi(ma,ma.CROSS).setParameterLength(2),lo=bi(ma,ma.POW).setParameterLength(2),uo=bi(ma,ma.POW,2).setParameterLength(1),co=bi(ma,ma.POW,3).setParameterLength(1),po=bi(ma,ma.POW,4).setParameterLength(1),mo=bi(ma,ma.TRANSFORM_DIRECTION).setParameterLength(2),go=t=>qn(Da(t),lo(ka(t),1/3)),yo=t=>oo(t,t),fo=bi(ma,ma.MIX).setParameterLength(3),xo=(t,e=0,s=1)=>pi(new ma(ma.CLAMP,pi(t),pi(e),pi(s))),bo=t=>xo(t),vo=bi(ma,ma.REFRACT).setParameterLength(3),No=bi(ma,ma.SMOOTHSTEP).setParameterLength(3),wo=bi(ma,ma.FACEFORWARD).setParameterLength(3),To=Ni(([t])=>{const e=oo(t.xy,Ii(12.9898,78.233)),s=Gn(e,fa);return Ra(Ea(s).mul(43758.5453))}),Mo=(t,e,s)=>fo(e,s,t),_o=(t,e,s)=>No(e,s,t),So=(t,e)=>ro(e,t),Ao=(t,e)=>Ba(t,e),Vo=wo,zo=Va;Dr("all",ba),Dr("any",va),Dr("equals",to),Dr("radians",Na),Dr("degrees",wa),Dr("exp",Ta),Dr("exp2",Ma),Dr("log",_a),Dr("log2",Sa),Dr("sqrt",Aa),Dr("inverseSqrt",Va),Dr("floor",za),Dr("ceil",Ca),Dr("normalize",Ia),Dr("fract",Ra),Dr("sin",Ea),Dr("cos",La),Dr("tan",Oa),Dr("asin",Pa),Dr("acos",Fa),Dr("atan",Ba),Dr("abs",ka),Dr("sign",Da),Dr("length",Ua),Dr("lengthSq",yo),Dr("negate",Wa),Dr("oneMinus",ja),Dr("dFdx",qa),Dr("dFdy",Ha),Dr("round",Ga),Dr("reciprocal",Xa),Dr("trunc",Ya),Dr("fwidth",Za),Dr("atan2",Ao),Dr("min",eo),Dr("max",so),Dr("step",So),Dr("reflect",io),Dr("distance",no),Dr("dot",oo),Dr("cross",ho),Dr("pow",lo),Dr("pow2",uo),Dr("pow3",co),Dr("pow4",po),Dr("transformDirection",mo),Dr("mix",Mo),Dr("clamp",xo),Dr("refract",vo),Dr("smoothstep",_o),Dr("faceForward",wo),Dr("difference",ao),Dr("saturate",bo),Dr("cbrt",go),Dr("transpose",$a),Dr("determinant",Ja),Dr("inverse",Ka),Dr("rand",To);class Co extends _r{static get type(){return"ConditionalNode"}constructor(t,e,s=null){super(),this.condNode=t,this.ifNode=e,this.elseNode=s}getNodeType(t){const{ifNode:e,elseNode:s}=t.getNodeProperties(this);if(void 0===e)return t.flowBuildStage(this,"setup"),this.getNodeType(t);const r=e.getNodeType(t);if(null!==s){const e=s.getNodeType(t);if(t.getTypeLength(e)>t.getTypeLength(r))return e}return r}setup(t){const e=this.condNode.cache(),s=this.ifNode.cache(),r=this.elseNode?this.elseNode.cache():null,i=t.context.nodeBlock;t.getDataFromNode(s).parentNodeBlock=i,null!==r&&(t.getDataFromNode(r).parentNodeBlock=i);const n=t.getNodeProperties(this);n.condNode=e,n.ifNode=s.context({nodeBlock:s}),n.elseNode=r?r.context({nodeBlock:r}):null}generate(t,e){const s=this.getNodeType(t),r=t.getDataFromNode(this);if(void 0!==r.nodeProperty)return r.nodeProperty;const{condNode:i,ifNode:n,elseNode:a}=t.getNodeProperties(this),o=t.currentFunctionNode,h="void"!==e,l=h?Zi(s).build(t):"";r.nodeProperty=l;const u=i.build(t,"bool");t.addFlowCode(`\n${t.tab}if ( ${u} ) {\n\n`).addFlowTab();let c=n.build(t,s);if(c&&(h?c=l+" = "+c+";":(c="return "+c+";",null===o&&(c="// "+c))),t.removeFlowTab().addFlowCode(t.tab+"\t"+c+"\n\n"+t.tab+"}"),null!==a){t.addFlowCode(" else {\n\n").addFlowTab();let e=a.build(t,s);e&&(h?e=l+" = "+e+";":(e="return "+e+";",null===o&&(e="// "+e))),t.removeFlowTab().addFlowCode(t.tab+"\t"+e+"\n\n"+t.tab+"}\n\n")}else t.addFlowCode("\n\n");return t.format(l,s,e)}}const Io=fi(Co).setParameterLength(2,3);Dr("select",Io);class Ro extends _r{static get type(){return"ContextNode"}constructor(t,e={}){super(),this.isContextNode=!0,this.node=t,this.value=e}getScope(){return this.node.getScope()}getNodeType(t){return this.node.getNodeType(t)}analyze(t){const e=t.getContext();t.setContext({...t.context,...this.value}),this.node.build(t),t.setContext(e)}setup(t){const e=t.getContext();t.setContext({...t.context,...this.value}),this.node.build(t),t.setContext(e)}generate(t,e){const s=t.getContext();t.setContext({...t.context,...this.value});const r=this.node.build(t,e);return t.setContext(s),r}}const Eo=fi(Ro).setParameterLength(1,2),Lo=(t,e)=>Eo(t,{nodeName:e});function Oo(t,e){return Lo(t,e)}Dr("context",Eo),Dr("label",Oo),Dr("setName",Lo);class Po extends _r{static get type(){return"VarNode"}constructor(t,e=null,s=!1){super(),this.node=t,this.name=e,this.global=!0,this.isVarNode=!0,this.readOnly=s,this.parents=!0,this.intent=!1}setIntent(t){return this.intent=t,this}getIntent(){return this.intent}getMemberType(t,e){return this.node.getMemberType(t,e)}getElementType(t){return this.node.getElementType(t)}getNodeType(t){return this.node.getNodeType(t)}getArrayCount(t){return this.node.getArrayCount(t)}build(...t){if(!0===this.intent){if(!0!==t[0].getNodeProperties(this).assign)return this.node.build(...t)}return super.build(...t)}generate(t){const{node:e,name:s,readOnly:r}=this,{renderer:i}=t,n=!0===i.backend.isWebGPUBackend;let a=!1,o=!1;r&&(a=t.isDeterministic(e),o=n?r:a);const h=t.getVectorType(this.getNodeType(t)),l=e.build(t,h),u=t.getVarFromNode(this,s,h,void 0,o),c=t.getPropertyName(u);let d=c;if(o)if(n)d=a?`const ${c}`:`let ${c}`;else{const s=e.getArrayCount(t);d=`const ${t.getVar(u.type,c,s)}`}return t.addLineFlowCode(`${d} = ${l}`,this),c}}const Fo=fi(Po),Bo=(t,e=null)=>Fo(t,e).toStack(),ko=(t,e=null)=>Fo(t,e,!0).toStack(),Do=t=>null===Ti()?t:Fo(t).setIntent(!0).toStack();Dr("toVar",Bo),Dr("toConst",ko),Dr("toVarIntent",Do);const Uo=t=>Fo(t);Dr("temp",Uo);class Wo extends _r{static get type(){return"SubBuild"}constructor(t,e,s=null){super(s),this.node=t,this.name=e,this.isSubBuildNode=!0}getNodeType(t){if(null!==this.nodeType)return this.nodeType;t.addSubBuild(this.name);const e=this.node.getNodeType(t);return t.removeSubBuild(),e}build(t,...e){t.addSubBuild(this.name);const s=this.node.build(t,...e);return t.removeSubBuild(),s}}const jo=(t,e,s=null)=>pi(new Wo(pi(t),e,s));class qo extends _r{static get type(){return"VaryingNode"}constructor(t,e=null){super(),this.node=t,this.name=e,this.isVaryingNode=!0,this.interpolationType=null,this.interpolationSampling=null,this.global=!0}setInterpolation(t,e=null){return this.interpolationType=t,this.interpolationSampling=e,this}getHash(t){return this.name||super.getHash(t)}getNodeType(t){return this.node.getNodeType(t)}setupVarying(t){const e=t.getNodeProperties(this);let s=e.varying;if(void 0===s){const r=this.name,i=this.getNodeType(t),n=this.interpolationType,a=this.interpolationSampling;e.varying=s=t.getVaryingFromNode(this,r,i,n,a),e.node=jo(this.node,"VERTEX")}return s.needsInterpolation||(s.needsInterpolation="fragment"===t.shaderStage),s}setup(t){this.setupVarying(t),t.flowNodeFromShaderStage(fr.VERTEX,this.node)}analyze(t){this.setupVarying(t),t.flowNodeFromShaderStage(fr.VERTEX,this.node)}generate(t){const e=t.getSubBuildProperty("property",t.currentStack),s=t.getNodeProperties(this),r=this.setupVarying(t);if(void 0===s[e]){const i=this.getNodeType(t),n=t.getPropertyName(r,fr.VERTEX);t.flowNodeFromShaderStage(fr.VERTEX,s.node,i,n),s[e]=n}return t.getPropertyName(r)}}const Ho=fi(qo).setParameterLength(1,2),Go=t=>Ho(t);Dr("toVarying",Ho),Dr("toVertexStage",Go),Dr("varying",(...t)=>Ho(...t)),Dr("vertexStage",(...t)=>Ho(...t));const Xo=Ni(([t])=>{const e=t.mul(.9478672986).add(.0521327014).pow(2.4),s=t.mul(.0773993808),r=t.lessThanEqual(.04045);return fo(e,s,r)}).setLayout({name:"sRGBTransferEOTF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),Yo=Ni(([t])=>{const e=t.pow(.41666).mul(1.055).sub(.055),s=t.mul(12.92),r=t.lessThanEqual(.0031308);return fo(e,s,r)}).setLayout({name:"sRGBTransferOETF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),Zo="WorkingColorSpace";class $o extends Vr{static get type(){return"ColorSpaceNode"}constructor(t,e,s){super("vec4"),this.colorNode=t,this.source=e,this.target=s}resolveColorSpace(t,e){return e===Zo?tt.workingColorSpace:"OutputColorSpace"===e?t.context.outputColorSpace||t.renderer.outputColorSpace:e}setup(t){const{colorNode:e}=this,s=this.resolveColorSpace(t,this.source),r=this.resolveColorSpace(t,this.target);let i=e;return!1!==tt.enabled&&s!==r&&s&&r?(tt.getTransfer(s)===T&&(i=ki(Xo(i.rgb),i.a)),tt.getPrimaries(s)!==tt.getPrimaries(r)&&(i=ki(qi(tt._getMatrix(new G,s,r)).mul(i.rgb),i.a)),tt.getTransfer(r)===T&&(i=ki(Yo(i.rgb),i.a)),i):i}}const Jo=(t,e)=>pi(new $o(pi(t),Zo,e)),Ko=(t,e)=>pi(new $o(pi(t),e,Zo));Dr("workingToColorSpace",Jo),Dr("colorSpaceToWorking",Ko);let Qo=class extends Sr{static get type(){return"ReferenceElementNode"}constructor(t,e){super(t,e),this.referenceNode=t,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(t){const e=super.generate(t),s=this.referenceNode.getNodeType(),r=this.getNodeType();return t.format(e,s,r)}};class th extends _r{static get type(){return"ReferenceBaseNode"}constructor(t,e,s=null,r=null){super(),this.property=t,this.uniformType=e,this.object=s,this.count=r,this.properties=t.split("."),this.reference=s,this.node=null,this.group=null,this.updateType=xr.OBJECT}setGroup(t){return this.group=t,this}element(t){return pi(new Qo(this,pi(t)))}setNodeType(t){const e=En(null,t).getSelf();null!==this.group&&e.setGroup(this.group),this.node=e}getNodeType(t){return null===this.node&&(this.updateReference(t),this.updateValue()),this.node.getNodeType(t)}getValueFromReference(t=this.reference){const{properties:e}=this;let s=t[e[0]];for(let t=1;t<e.length;t++)s=s[e[t]];return s}updateReference(t){return this.reference=null!==this.object?this.object:t.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const t=this.getValueFromReference();Array.isArray(t)?this.node.array=t:this.node.value=t}}class eh extends th{static get type(){return"RendererReferenceNode"}constructor(t,e,s=null){super(t,e,s),this.renderer=s,this.setGroup(Cn)}updateReference(t){return this.reference=null!==this.renderer?this.renderer:t.renderer,this.reference}}const sh=(t,e,s=null)=>pi(new eh(t,e,s));class rh extends Vr{static get type(){return"ToneMappingNode"}constructor(t,e=nh,s=null){super("vec3"),this.toneMapping=t,this.exposureNode=e,this.colorNode=s}customCacheKey(){return rr(this.toneMapping)}setup(t){const e=this.colorNode||t.context.color,s=this.toneMapping;if(0===s)return e;let r=null;const i=t.renderer.library.getToneMappingFunction(s);return r=null!==i?ki(i(e.rgb,this.exposureNode),e.a):e,r}}const ih=(t,e,s)=>pi(new rh(t,pi(e),pi(s))),nh=sh("toneMappingExposure","float");Dr("toneMapping",(t,e,s)=>ih(e,s,t));class ah extends Lr{static get type(){return"BufferAttributeNode"}constructor(t,e=null,s=0,r=0){super(t,e),this.isBufferNode=!0,this.bufferType=e,this.bufferStride=s,this.bufferOffset=r,this.usage=_,this.instanced=!1,this.attribute=null,this.global=!0,t&&!0===t.isBufferAttribute&&(this.attribute=t,this.usage=t.usage,this.instanced=t.isInstancedBufferAttribute)}getHash(t){if(0===this.bufferStride&&0===this.bufferOffset){let e=t.globalCache.getData(this.value);return void 0===e&&(e={node:this},t.globalCache.setData(this.value,e)),e.node.uuid}return this.uuid}getNodeType(t){return null===this.bufferType&&(this.bufferType=t.getTypeFromAttribute(this.attribute)),this.bufferType}setup(t){if(null!==this.attribute)return;const e=this.getNodeType(t),s=this.value,r=t.getTypeLength(e),i=this.bufferStride||r,n=this.bufferOffset,a=!0===s.isInterleavedBuffer?s:new Ts(s,i),o=new _s(a,r,n);a.setUsage(this.usage),this.attribute=o,this.attribute.isInstancedBufferAttribute=this.instanced}generate(t){const e=this.getNodeType(t),s=t.getBufferAttributeFromNode(this,e),r=t.getPropertyName(s);let i=null;if("vertex"===t.shaderStage||"compute"===t.shaderStage)this.name=r,i=r;else{i=Ho(this).build(t,e)}return i}getInputType(){return"bufferAttribute"}setUsage(t){return this.usage=t,this.attribute&&!0===this.attribute.isBufferAttribute&&(this.attribute.usage=t),this}setInstanced(t){return this.instanced=t,this}}const oh=(t,e=null,s=0,r=0)=>pi(new ah(t,e,s,r)),hh=(t,e=null,s=0,r=0)=>oh(t,e,s,r).setUsage(S),lh=(t,e=null,s=0,r=0)=>oh(t,e,s,r).setInstanced(!0),uh=(t,e=null,s=0,r=0)=>hh(t,e,s,r).setInstanced(!0);Dr("toAttribute",t=>oh(t.value));class ch extends _r{static get type(){return"ComputeNode"}constructor(t,e){super("void"),this.isComputeNode=!0,this.computeNode=t,this.workgroupSize=e,this.count=null,this.version=1,this.name="",this.updateBeforeType=xr.OBJECT,this.onInitFunction=null}setCount(t){return this.count=t,this}getCount(){return this.count}dispose(){this.dispatchEvent({type:"dispose"})}setName(t){return this.name=t,this}label(t){return this.setName(t)}onInit(t){return this.onInitFunction=t,this}updateBefore({renderer:t}){t.compute(this)}setup(t){const e=this.computeNode.build(t);if(e){t.getNodeProperties(this).outputComputeNode=e.outputNode,e.outputNode=null}return e}generate(t,e){const{shaderStage:s}=t;if("compute"===s){const e=this.computeNode.build(t,"void");""!==e&&t.addLineFlowCode(e,this)}else{const s=t.getNodeProperties(this).outputComputeNode;if(s)return s.build(t,e)}}}const dh=(t,e=[64])=>{0===e.length||e.length;for(let t=0;t<e.length;t++){const s=e[t];"number"!=typeof s||s<=0||Number.isInteger(s)}for(;e.length<3;)e.push(1);return pi(new ch(pi(t),e))},ph=(t,e,s)=>dh(t,s).setCount(e);Dr("compute",ph),Dr("computeKernel",dh);class mh extends _r{static get type(){return"CacheNode"}constructor(t,e=!0){super(),this.node=t,this.parent=e,this.isCacheNode=!0}getNodeType(t){const e=t.getCache(),s=t.getCacheFromNode(this,this.parent);t.setCache(s);const r=this.node.getNodeType(t);return t.setCache(e),r}build(t,...e){const s=t.getCache(),r=t.getCacheFromNode(this,this.parent);t.setCache(r);const i=this.node.build(t,...e);return t.setCache(s),i}}const gh=(t,e)=>pi(new mh(pi(t),e));Dr("cache",gh);class yh extends _r{static get type(){return"BypassNode"}constructor(t,e){super(),this.isBypassNode=!0,this.outputNode=t,this.callNode=e}getNodeType(t){return this.outputNode.getNodeType(t)}generate(t){const e=this.callNode.build(t,"void");return""!==e&&t.addLineFlowCode(e,this),this.outputNode.build(t)}}const fh=fi(yh).setParameterLength(2);Dr("bypass",fh);class xh extends _r{static get type(){return"RemapNode"}constructor(t,e,s,r=Ai(0),i=Ai(1)){super(),this.node=t,this.inLowNode=e,this.inHighNode=s,this.outLowNode=r,this.outHighNode=i,this.doClamp=!0}setup(){const{node:t,inLowNode:e,inHighNode:s,outLowNode:r,outHighNode:i,doClamp:n}=this;let a=t.sub(e).div(s.sub(e));return!0===n&&(a=a.clamp()),a.mul(i.sub(r)).add(r)}}const bh=fi(xh,null,null,{doClamp:!1}).setParameterLength(3,5),vh=fi(xh).setParameterLength(3,5);Dr("remap",bh),Dr("remapClamp",vh);class Nh extends _r{static get type(){return"ExpressionNode"}constructor(t="",e="void"){super(e),this.snippet=t}generate(t,e){const s=this.getNodeType(t),r=this.snippet;if("void"!==s)return t.format(r,s,e);t.addLineFlowCode(r,this)}}const wh=fi(Nh).setParameterLength(1,2),Th=t=>(t?Io(t,wh("discard")):wh("discard")).toStack();Dr("discard",Th);class Mh extends Vr{static get type(){return"RenderOutputNode"}constructor(t,e,s){super("vec4"),this.colorNode=t,this.toneMapping=e,this.outputColorSpace=s,this.isRenderOutputNode=!0}setup({context:t}){let e=this.colorNode||t.color;const s=(null!==this.toneMapping?this.toneMapping:t.toneMapping)||0,r=(null!==this.outputColorSpace?this.outputColorSpace:t.outputColorSpace)||"";return 0!==s&&(e=e.toneMapping(s)),""!==r&&r!==tt.workingColorSpace&&(e=e.workingToColorSpace(r)),e}}const _h=(t,e=null,s=null)=>pi(new Mh(pi(t),e,s));Dr("renderOutput",_h);class Sh extends Vr{static get type(){return"DebugNode"}constructor(t,e=null){super(),this.node=t,this.callback=e}getNodeType(t){return this.node.getNodeType(t)}setup(t){return this.node.build(t)}analyze(t){return this.node.build(t)}generate(t){const e=this.callback,s=this.node.build(t),r="--- TSL debug - "+t.shaderStage+" shader ---",i="-".repeat(r.length);let n="";return n+="// #"+r+"#\n",n+=t.flow.code.replace(/^\t/gm,"")+"\n",n+="/* ... */ "+s+" /* ... */\n",n+="// #"+i+"#\n",null!==e&&e(t,n),s}}const Ah=(t,e=null)=>pi(new Sh(pi(t),e)).toStack();Dr("debug",Ah);class Vh extends _r{static get type(){return"AttributeNode"}constructor(t,e=null){super(e),this.global=!0,this._attributeName=t}getHash(t){return this.getAttributeName(t)}getNodeType(t){let e=this.nodeType;if(null===e){const s=this.getAttributeName(t);if(t.hasGeometryAttribute(s)){const r=t.geometry.getAttribute(s);e=t.getTypeFromAttribute(r)}else e="float"}return e}setAttributeName(t){return this._attributeName=t,this}getAttributeName(){return this._attributeName}generate(t){const e=this.getAttributeName(t),s=this.getNodeType(t);if(!0===t.hasGeometryAttribute(e)){const r=t.geometry.getAttribute(e),i=t.getTypeFromAttribute(r),n=t.getAttribute(e,i);if("vertex"===t.shaderStage)return t.format(n.name,i,s);return Ho(this).build(t,s)}return t.generateConst(s)}serialize(t){super.serialize(t),t.global=this.global,t._attributeName=this._attributeName}deserialize(t){super.deserialize(t),this.global=t.global,this._attributeName=t._attributeName}}const zh=(t,e=null)=>pi(new Vh(t,e)),Ch=(t=0)=>zh("uv"+(t>0?t:""),"vec2");class Ih extends _r{static get type(){return"TextureSizeNode"}constructor(t,e=null){super("uvec2"),this.isTextureSizeNode=!0,this.textureNode=t,this.levelNode=e}generate(t,e){const s=this.textureNode.build(t,"property"),r=null===this.levelNode?"0":this.levelNode.build(t,"int");return t.format(`${t.getMethod("textureDimensions")}( ${s}, ${r} )`,this.getNodeType(t),e)}}const Rh=fi(Ih).setParameterLength(1,2);class Eh extends Rn{static get type(){return"MaxMipLevelNode"}constructor(t){super(0),this._textureNode=t,this.updateType=xr.FRAME}get textureNode(){return this._textureNode}get texture(){return this._textureNode.value}update(){const t=this.texture,e=t.images,s=e&&e.length>0?e[0]&&e[0].image||e[0]:t.image;if(s&&void 0!==s.width){const{width:t,height:e}=s;this.value=Math.log2(Math.max(t,e))}}}const Lh=fi(Eh).setParameterLength(1),Oh=new ut;class Ph extends Rn{static get type(){return"TextureNode"}constructor(t=Oh,e=null,s=null,r=null){super(t),this.isTextureNode=!0,this.uvNode=e,this.levelNode=s,this.biasNode=r,this.compareNode=null,this.depthNode=null,this.gradNode=null,this.sampler=!0,this.updateMatrix=!1,this.updateType=xr.NONE,this.referenceNode=null,this._value=t,this._matrixUniform=null,this.setUpdateMatrix(null===e)}set value(t){this.referenceNode?this.referenceNode.value=t:this._value=t}get value(){return this.referenceNode?this.referenceNode.value:this._value}getUniformHash(){return this.value.uuid}getNodeType(){return!0===this.value.isDepthTexture?"float":this.value.type===u?"uvec4":1013===this.value.type?"ivec4":"vec4"}getInputType(){return"texture"}getDefaultUV(){return Ch(this.value.channel)}updateReference(){return this.value}getTransformedUV(t){return null===this._matrixUniform&&(this._matrixUniform=En(this.value.matrix)),this._matrixUniform.mul(Oi(t,1)).xy}setUpdateMatrix(t){return this.updateMatrix=t,this.updateType=t?xr.OBJECT:xr.NONE,this}setupUV(t,e){const s=this.value;return t.isFlipY()&&(s.image instanceof ImageBitmap&&!0===s.flipY||!0===s.isRenderTargetTexture||!0===s.isFramebufferTexture||!0===s.isDepthTexture)&&(e=this.sampler?e.flipY():e.setY(Vi(Rh(this,this.levelNode).y).sub(e.y).sub(1))),e}setup(t){const e=t.getNodeProperties(this);e.referenceNode=this.referenceNode;const s=this.value;if(!s||!0!==s.isTexture)throw new Error("THREE.TSL: `texture( value )` function expects a valid instance of THREE.Texture().");let r=this.uvNode;null!==r&&!0!==t.context.forceUVContext||!t.context.getUV||(r=t.context.getUV(this,t)),r||(r=this.getDefaultUV()),!0===this.updateMatrix&&(r=this.getTransformedUV(r)),r=this.setupUV(t,r);let i=this.levelNode;null===i&&t.context.getTextureLevel&&(i=t.context.getTextureLevel(this)),e.uvNode=r,e.levelNode=i,e.biasNode=this.biasNode,e.compareNode=this.compareNode,e.gradNode=this.gradNode,e.depthNode=this.depthNode}generateUV(t,e){return e.build(t,!0===this.sampler?"vec2":"ivec2")}generateSnippet(t,e,s,r,i,n,a,o){const h=this.value;let l;return l=r?t.generateTextureLevel(h,e,s,r,n):i?t.generateTextureBias(h,e,s,i,n):o?t.generateTextureGrad(h,e,s,o,n):a?t.generateTextureCompare(h,e,s,a,n):!1===this.sampler?t.generateTextureLoad(h,e,s,n):t.generateTexture(h,e,s,n),l}generate(t,e){const s=this.value,r=t.getNodeProperties(this),i=super.generate(t,"property");if(/^sampler/.test(e))return i+"_sampler";if(t.isReference(e))return i;{const n=t.getDataFromNode(this);let a=n.propertyName;if(void 0===a){const{uvNode:e,levelNode:s,biasNode:o,compareNode:h,depthNode:l,gradNode:u}=r,c=this.generateUV(t,e),d=s?s.build(t,"float"):null,p=o?o.build(t,"float"):null,m=l?l.build(t,"int"):null,g=h?h.build(t,"float"):null,y=u?[u[0].build(t,"vec2"),u[1].build(t,"vec2")]:null,f=t.getVarFromNode(this);a=t.getPropertyName(f);const x=this.generateSnippet(t,i,c,d,p,m,g,y);t.addLineFlowCode(`${a} = ${x}`,this),n.snippet=x,n.propertyName=a}let o=a;const h=this.getNodeType(t);return t.needsToWorkingColorSpace(s)&&(o=Ko(wh(o,h),s.colorSpace).setup(t).build(t,h)),t.format(o,h,e)}}setSampler(t){return this.sampler=t,this}getSampler(){return this.sampler}uv(t){return this.sample(t)}sample(t){const e=this.clone();return e.uvNode=pi(t),e.referenceNode=this.getSelf(),pi(e)}load(t){return this.sample(t).setSampler(!1)}blur(t){const e=this.clone();e.biasNode=pi(t).mul(Lh(e)),e.referenceNode=this.getSelf();const s=e.value;return!1===e.generateMipmaps&&(s&&!1===s.generateMipmaps||s.minFilter===o||s.magFilter===o)&&(e.biasNode=null),pi(e)}level(t){const e=this.clone();return e.levelNode=pi(t),e.referenceNode=this.getSelf(),pi(e)}size(t){return Rh(this,t)}bias(t){const e=this.clone();return e.biasNode=pi(t),e.referenceNode=this.getSelf(),pi(e)}compare(t){const e=this.clone();return e.compareNode=pi(t),e.referenceNode=this.getSelf(),pi(e)}grad(t,e){const s=this.clone();return s.gradNode=[pi(t),pi(e)],s.referenceNode=this.getSelf(),pi(s)}depth(t){const e=this.clone();return e.depthNode=pi(t),e.referenceNode=this.getSelf(),pi(e)}serialize(t){super.serialize(t),t.value=this.value.toJSON(t.meta).uuid,t.sampler=this.sampler,t.updateMatrix=this.updateMatrix,t.updateType=this.updateType}deserialize(t){super.deserialize(t),this.value=t.meta.textures[t.value],this.sampler=t.sampler,this.updateMatrix=t.updateMatrix,this.updateType=t.updateType}update(){const t=this.value,e=this._matrixUniform;null!==e&&(e.value=t.matrix),!0===t.matrixAutoUpdate&&t.updateMatrix()}clone(){const t=new this.constructor(this.value,this.uvNode,this.levelNode,this.biasNode);return t.sampler=this.sampler,t.depthNode=this.depthNode,t.compareNode=this.compareNode,t.gradNode=this.gradNode,t}}const Fh=fi(Ph).setParameterLength(1,4).setName("texture"),Bh=(t=Oh,e=null,s=null,r=null)=>{let i;return t&&!0===t.isTextureNode?(i=pi(t.clone()),i.referenceNode=t.getSelf(),null!==e&&(i.uvNode=pi(e)),null!==s&&(i.levelNode=pi(s)),null!==r&&(i.biasNode=pi(r))):i=Fh(t,e,s,r),i},kh=(...t)=>Bh(...t).setSampler(!1);class Dh extends Rn{static get type(){return"BufferNode"}constructor(t,e,s=0){super(t,e),this.isBufferNode=!0,this.bufferType=e,this.bufferCount=s}getElementType(t){return this.getNodeType(t)}getInputType(){return"buffer"}}const Uh=(t,e,s)=>pi(new Dh(t,e,s));class Wh extends Sr{static get type(){return"UniformArrayElementNode"}constructor(t,e){super(t,e),this.isArrayBufferElementNode=!0}generate(t){const e=super.generate(t),s=this.getNodeType(),r=this.node.getPaddedType();return t.format(e,r,s)}}class jh extends Dh{static get type(){return"UniformArrayNode"}constructor(t,e=null){super(null),this.array=t,this.elementType=null===e?dr(t[0]):e,this.paddedType=this.getPaddedType(),this.updateType=xr.RENDER,this.isArrayBufferNode=!0}getNodeType(){return this.paddedType}getElementType(){return this.elementType}getPaddedType(){const t=this.elementType;let e="vec4";return"mat2"===t?e="mat2":!0===/mat/.test(t)?e="mat4":"i"===t.charAt(0)?e="ivec4":"u"===t.charAt(0)&&(e="uvec4"),e}update(){const{array:t,value:e}=this,s=this.elementType;if("float"===s||"int"===s||"uint"===s)for(let s=0;s<t.length;s++){e[4*s]=t[s]}else if("color"===s)for(let s=0;s<t.length;s++){const r=4*s,i=t[s];e[r]=i.r,e[r+1]=i.g,e[r+2]=i.b||0}else if("mat2"===s)for(let s=0;s<t.length;s++){const r=4*s,i=t[s];e[r]=i.elements[0],e[r+1]=i.elements[1],e[r+2]=i.elements[2],e[r+3]=i.elements[3]}else if("mat3"===s)for(let s=0;s<t.length;s++){const r=16*s,i=t[s];e[r]=i.elements[0],e[r+1]=i.elements[1],e[r+2]=i.elements[2],e[r+4]=i.elements[3],e[r+5]=i.elements[4],e[r+6]=i.elements[5],e[r+8]=i.elements[6],e[r+9]=i.elements[7],e[r+10]=i.elements[8],e[r+15]=1}else if("mat4"===s)for(let s=0;s<t.length;s++){const r=16*s,i=t[s];for(let t=0;t<i.elements.length;t++)e[r+t]=i.elements[t]}else for(let s=0;s<t.length;s++){const r=4*s,i=t[s];e[r]=i.x,e[r+1]=i.y,e[r+2]=i.z||0,e[r+3]=i.w||0}}setup(t){const e=this.array.length,s=this.elementType;let r=Float32Array;const i=this.paddedType,n=t.getTypeLength(i);return"i"===s.charAt(0)&&(r=Int32Array),"u"===s.charAt(0)&&(r=Uint32Array),this.value=new r(e*n),this.bufferCount=e,this.bufferType=i,super.setup(t)}element(t){return pi(new Wh(this,pi(t)))}}const qh=(t,e)=>pi(new jh(t,e));const Hh=fi(class extends _r{constructor(t){super("float"),this.name=t,this.isBuiltinNode=!0}generate(){return this.name}}).setParameterLength(1),Gh=En(0,"uint").setName("u_cameraIndex").setGroup(Vn("cameraIndex")).toVarying("v_cameraIndex"),Xh=En("float").setName("cameraNear").setGroup(Cn).onRenderUpdate(({camera:t})=>t.near),Yh=En("float").setName("cameraFar").setGroup(Cn).onRenderUpdate(({camera:t})=>t.far),Zh=Ni(({camera:t})=>{let e;if(t.isArrayCamera&&t.cameras.length>0){const s=[];for(const e of t.cameras)s.push(e.projectionMatrix);e=qh(s).setGroup(Cn).setName("cameraProjectionMatrices").element(t.isMultiViewCamera?Hh("gl_ViewID_OVR"):Gh).toVar("cameraProjectionMatrix")}else e=En("mat4").setName("cameraProjectionMatrix").setGroup(Cn).onRenderUpdate(({camera:t})=>t.projectionMatrix);return e}).once()(),$h=Ni(({camera:t})=>{let e;if(t.isArrayCamera&&t.cameras.length>0){const s=[];for(const e of t.cameras)s.push(e.projectionMatrixInverse);e=qh(s).setGroup(Cn).setName("cameraProjectionMatricesInverse").element(t.isMultiViewCamera?Hh("gl_ViewID_OVR"):Gh).toVar("cameraProjectionMatrixInverse")}else e=En("mat4").setName("cameraProjectionMatrixInverse").setGroup(Cn).onRenderUpdate(({camera:t})=>t.projectionMatrixInverse);return e}).once()(),Jh=Ni(({camera:t})=>{let e;if(t.isArrayCamera&&t.cameras.length>0){const s=[];for(const e of t.cameras)s.push(e.matrixWorldInverse);e=qh(s).setGroup(Cn).setName("cameraViewMatrices").element(t.isMultiViewCamera?Hh("gl_ViewID_OVR"):Gh).toVar("cameraViewMatrix")}else e=En("mat4").setName("cameraViewMatrix").setGroup(Cn).onRenderUpdate(({camera:t})=>t.matrixWorldInverse);return e}).once()(),Kh=En("mat4").setName("cameraWorldMatrix").setGroup(Cn).onRenderUpdate(({camera:t})=>t.matrixWorld),Qh=En("mat3").setName("cameraNormalMatrix").setGroup(Cn).onRenderUpdate(({camera:t})=>t.normalMatrix),tl=En(new j).setName("cameraPosition").setGroup(Cn).onRenderUpdate(({camera:t},e)=>e.value.setFromMatrixPosition(t.matrixWorld)),el=new Rt;class sl extends _r{static get type(){return"Object3DNode"}constructor(t,e=null){super(),this.scope=t,this.object3d=e,this.updateType=xr.OBJECT,this.uniformNode=new Rn(null)}getNodeType(){const t=this.scope;return t===sl.WORLD_MATRIX?"mat4":t===sl.POSITION||t===sl.VIEW_POSITION||t===sl.DIRECTION||t===sl.SCALE?"vec3":t===sl.RADIUS?"float":void 0}update(t){const e=this.object3d,s=this.uniformNode,r=this.scope;if(r===sl.WORLD_MATRIX)s.value=e.matrixWorld;else if(r===sl.POSITION)s.value=s.value||new j,s.value.setFromMatrixPosition(e.matrixWorld);else if(r===sl.SCALE)s.value=s.value||new j,s.value.setFromMatrixScale(e.matrixWorld);else if(r===sl.DIRECTION)s.value=s.value||new j,e.getWorldDirection(s.value);else if(r===sl.VIEW_POSITION){const r=t.camera;s.value=s.value||new j,s.value.setFromMatrixPosition(e.matrixWorld),s.value.applyMatrix4(r.matrixWorldInverse)}else if(r===sl.RADIUS){const r=t.object.geometry;null===r.boundingSphere&&r.computeBoundingSphere(),el.copy(r.boundingSphere).applyMatrix4(e.matrixWorld),s.value=el.radius}}generate(t){const e=this.scope;return e===sl.WORLD_MATRIX?this.uniformNode.nodeType="mat4":e===sl.POSITION||e===sl.VIEW_POSITION||e===sl.DIRECTION||e===sl.SCALE?this.uniformNode.nodeType="vec3":e===sl.RADIUS&&(this.uniformNode.nodeType="float"),this.uniformNode.build(t)}serialize(t){super.serialize(t),t.scope=this.scope}deserialize(t){super.deserialize(t),this.scope=t.scope}}sl.WORLD_MATRIX="worldMatrix",sl.POSITION="position",sl.SCALE="scale",sl.VIEW_POSITION="viewPosition",sl.DIRECTION="direction",sl.RADIUS="radius";const rl=fi(sl,sl.DIRECTION).setParameterLength(1),il=fi(sl,sl.WORLD_MATRIX).setParameterLength(1),nl=fi(sl,sl.POSITION).setParameterLength(1),al=fi(sl,sl.SCALE).setParameterLength(1),ol=fi(sl,sl.VIEW_POSITION).setParameterLength(1),hl=fi(sl,sl.RADIUS).setParameterLength(1);class ll extends sl{static get type(){return"ModelNode"}constructor(t){super(t)}update(t){this.object3d=t.object,super.update(t)}}const ul=xi(ll,ll.DIRECTION),cl=xi(ll,ll.WORLD_MATRIX),dl=xi(ll,ll.POSITION),pl=xi(ll,ll.SCALE),ml=xi(ll,ll.VIEW_POSITION),gl=xi(ll,ll.RADIUS),yl=En(new G).onObjectUpdate(({object:t},e)=>e.value.getNormalMatrix(t.matrixWorld)),fl=En(new Ut).onObjectUpdate(({object:t},e)=>e.value.copy(t.matrixWorld).invert()),xl=Ni(t=>t.renderer.overrideNodes.modelViewMatrix||bl).once()().toVar("modelViewMatrix"),bl=Jh.mul(cl),vl=Ni(t=>(t.context.isHighPrecisionModelViewMatrix=!0,En("mat4").onObjectUpdate(({object:t,camera:e})=>t.modelViewMatrix.multiplyMatrices(e.matrixWorldInverse,t.matrixWorld)))).once()().toVar("highpModelViewMatrix"),Nl=Ni(t=>{const e=t.context.isHighPrecisionModelViewMatrix;return En("mat3").onObjectUpdate(({object:t,camera:s})=>(!0!==e&&t.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix)))}).once()().toVar("highpModelNormalViewMatrix"),wl=zh("position","vec3"),Tl=wl.toVarying("positionLocal"),Ml=wl.toVarying("positionPrevious"),_l=Ni(t=>cl.mul(Tl).xyz.toVarying(t.getSubBuildProperty("v_positionWorld")),"vec3").once(["POSITION"])(),Sl=Ni(()=>Tl.transformDirection(cl).toVarying("v_positionWorldDirection").normalize().toVar("positionWorldDirection"),"vec3").once(["POSITION"])(),Al=Ni(t=>t.context.setupPositionView().toVarying("v_positionView"),"vec3").once(["POSITION"])(),Vl=Al.negate().toVarying("v_positionViewDirection").normalize().toVar("positionViewDirection");class zl extends _r{static get type(){return"FrontFacingNode"}constructor(){super("bool"),this.isFrontFacingNode=!0}generate(t){if("fragment"!==t.shaderStage)return"true";const{renderer:e,material:s}=t;return e.coordinateSystem===A&&1===s.side?"false":t.getFrontFacing()}}const Cl=xi(zl),Il=Ai(Cl).mul(2).sub(1),Rl=Ni(([t],{material:e})=>{const s=e.side;return 1===s?t=t.mul(-1):2===s&&(t=t.mul(Il)),t}),El=zh("normal","vec3"),Ll=Ni(t=>!1===t.geometry.hasAttribute("normal")?Oi(0,1,0):El,"vec3").once()().toVar("normalLocal"),Ol=Al.dFdx().cross(Al.dFdy()).normalize().toVar("normalFlat"),Pl=Ni(t=>{let e;return e=!0===t.material.flatShading?Ol:Wl(Ll).toVarying("v_normalViewGeometry").normalize(),e},"vec3").once()().toVar("normalViewGeometry"),Fl=Ni(t=>{let e=Pl.transformDirection(Jh);return!0!==t.material.flatShading&&(e=e.toVarying("v_normalWorldGeometry")),e.normalize().toVar("normalWorldGeometry")},"vec3").once()(),Bl=Ni(({subBuildFn:t,material:e,context:s})=>{let r;return"NORMAL"===t||"VERTEX"===t?(r=Pl,!0!==e.flatShading&&(r=Rl(r))):r=s.setupNormal().context({getUV:null}),r},"vec3").once(["NORMAL","VERTEX"])().toVar("normalView"),kl=Bl.transformDirection(Jh).toVar("normalWorld"),Dl=Ni(({subBuildFn:t,context:e})=>{let s;return s="NORMAL"===t||"VERTEX"===t?Bl:e.setupClearcoatNormal().context({getUV:null}),s},"vec3").once(["NORMAL","VERTEX"])().toVar("clearcoatNormalView"),Ul=Ni(([t,e=cl])=>{const s=qi(e),r=t.div(Oi(s[0].dot(s[0]),s[1].dot(s[1]),s[2].dot(s[2])));return s.mul(r).xyz}),Wl=Ni(([t],e)=>{const s=e.renderer.overrideNodes.modelNormalViewMatrix;if(null!==s)return s.transformDirection(t);const r=yl.mul(t);return Jh.transformDirection(r)}),jl=Ni(()=>Bl).once(["NORMAL","VERTEX"])(),ql=Ni(()=>kl).once(["NORMAL","VERTEX"])(),Hl=Ni(()=>Dl).once(["NORMAL","VERTEX"])(),Gl=new Jt,Xl=new Ut,Yl=En(0).onReference(({material:t})=>t).onObjectUpdate(({material:t})=>t.refractionRatio),Zl=En(1).onReference(({material:t})=>t).onObjectUpdate(function({material:t,scene:e}){return t.envMap?t.envMapIntensity:e.environmentIntensity}),$l=En(new Ut).onReference(function(t){return t.material}).onObjectUpdate(function({material:t,scene:e}){const s=null!==e.environment&&null===t.envMap?e.environmentRotation:t.envMapRotation;return s?(Gl.copy(s),Xl.makeRotationFromEuler(Gl)):Xl.identity(),Xl}),Jl=Vl.negate().reflect(Bl),Kl=Vl.negate().refract(Bl,Yl),Ql=Jl.transformDirection(Jh).toVar("reflectVector"),tu=Kl.transformDirection(Jh).toVar("reflectVector"),eu=new ws;class su extends Ph{static get type(){return"CubeTextureNode"}constructor(t,e=null,s=null,r=null){super(t,e,s,r),this.isCubeTextureNode=!0}getInputType(){return"cubeTexture"}getDefaultUV(){const t=this.value;return t.mapping===s?Ql:t.mapping===r?tu:Oi(0,0,0)}setUpdateMatrix(){}setupUV(t,e){const s=this.value;return t.renderer.coordinateSystem!==V&&s.isRenderTargetTexture||(e=Oi(e.x.negate(),e.yz)),$l.mul(e)}generateUV(t,e){return e.build(t,"vec3")}}const ru=fi(su).setParameterLength(1,4).setName("cubeTexture"),iu=(t=eu,e=null,s=null,r=null)=>{let i;return t&&!0===t.isCubeTextureNode?(i=pi(t.clone()),i.referenceNode=t.getSelf(),null!==e&&(i.uvNode=pi(e)),null!==s&&(i.levelNode=pi(s)),null!==r&&(i.biasNode=pi(r))):i=ru(t,e,s,r),i};class nu extends Sr{static get type(){return"ReferenceElementNode"}constructor(t,e){super(t,e),this.referenceNode=t,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(t){const e=super.generate(t),s=this.referenceNode.getNodeType(),r=this.getNodeType();return t.format(e,s,r)}}class au extends _r{static get type(){return"ReferenceNode"}constructor(t,e,s=null,r=null){super(),this.property=t,this.uniformType=e,this.object=s,this.count=r,this.properties=t.split("."),this.reference=s,this.node=null,this.group=null,this.name=null,this.updateType=xr.OBJECT}element(t){return pi(new nu(this,pi(t)))}setGroup(t){return this.group=t,this}setName(t){return this.name=t,this}label(t){return this.setName(t)}setNodeType(t){let e=null;e=null!==this.count?Uh(null,t,this.count):Array.isArray(this.getValueFromReference())?qh(null,t):"texture"===t?Bh(null):"cubeTexture"===t?iu(null):En(null,t),null!==this.group&&e.setGroup(this.group),null!==this.name&&e.setName(this.name),this.node=e.getSelf()}getNodeType(t){return null===this.node&&(this.updateReference(t),this.updateValue()),this.node.getNodeType(t)}getValueFromReference(t=this.reference){const{properties:e}=this;let s=t[e[0]];for(let t=1;t<e.length;t++)s=s[e[t]];return s}updateReference(t){return this.reference=null!==this.object?this.object:t.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const t=this.getValueFromReference();Array.isArray(t)?this.node.array=t:this.node.value=t}}const ou=(t,e,s)=>pi(new au(t,e,s)),hu=(t,e,s,r)=>pi(new au(t,e,r,s));class lu extends au{static get type(){return"MaterialReferenceNode"}constructor(t,e,s=null){super(t,e,s),this.material=s,this.isMaterialReferenceNode=!0}updateReference(t){return this.reference=null!==this.material?this.material:t.material,this.reference}}const uu=(t,e,s=null)=>pi(new lu(t,e,s)),cu=Ch(),du=Al.dFdx(),pu=Al.dFdy(),mu=cu.dFdx(),gu=cu.dFdy(),yu=Bl,fu=pu.cross(yu),xu=yu.cross(du),bu=fu.mul(mu.x).add(xu.mul(gu.x)),vu=fu.mul(mu.y).add(xu.mul(gu.y)),Nu=bu.dot(bu).max(vu.dot(vu)),wu=Nu.equal(0).select(0,Nu.inverseSqrt()),Tu=bu.mul(wu).toVar("tangentViewFrame"),Mu=vu.mul(wu).toVar("bitangentViewFrame"),_u=Ni(t=>(!1===t.geometry.hasAttribute("tangent")&&t.geometry.computeTangents(),zh("tangent","vec4")))(),Su=_u.xyz.toVar("tangentLocal"),Au=Ni(({subBuildFn:t,geometry:e,material:s})=>{let r;return r="VERTEX"===t||e.hasAttribute("tangent")?xl.mul(ki(Su,0)).xyz.toVarying("v_tangentView").normalize():Tu,!0!==s.flatShading&&(r=Rl(r)),r},"vec3").once(["NORMAL","VERTEX"])().toVar("tangentView"),Vu=Au.transformDirection(Jh).toVarying("v_tangentWorld").normalize().toVar("tangentWorld"),zu=Ni(([t,e],{subBuildFn:s,material:r})=>{let i=t.mul(_u.w).xyz;return"NORMAL"===s&&!0!==r.flatShading&&(i=i.toVarying(e)),i}).once(["NORMAL"]),Cu=zu(El.cross(_u),"v_bitangentGeometry").normalize().toVar("bitangentGeometry"),Iu=zu(Ll.cross(Su),"v_bitangentLocal").normalize().toVar("bitangentLocal"),Ru=Ni(({subBuildFn:t,geometry:e,material:s})=>{let r;return r="VERTEX"===t||e.hasAttribute("tangent")?zu(Bl.cross(Au),"v_bitangentView").normalize():Mu,!0!==s.flatShading&&(r=Rl(r)),r},"vec3").once(["NORMAL","VERTEX"])().toVar("bitangentView"),Eu=zu(kl.cross(Vu),"v_bitangentWorld").normalize().toVar("bitangentWorld"),Lu=qi(Au,Ru,Bl).toVar("TBNViewMatrix"),Ou=Vl.mul(Lu),Pu=Ni(()=>{let t=dn.cross(Vl);return t=t.cross(dn).normalize(),t=fo(t,Bl,un.mul(Qi.oneMinus()).oneMinus().pow2().pow2()).normalize(),t}).once()();class Fu extends Vr{static get type(){return"NormalMapNode"}constructor(t,e=null){super("vec3"),this.node=t,this.scaleNode=e,this.normalMapType=0}setup({material:t}){const{normalMapType:e,scaleNode:s}=this;let r=this.node.mul(2).sub(1);if(null!==s){let e=s;!0===t.flatShading&&(e=Rl(e)),r=Oi(r.xy.mul(e),r.z)}let i=null;return i=1===e?Wl(r):0===e?Lu.mul(r).normalize():Bl,i}}const Bu=fi(Fu).setParameterLength(1,2),ku=Ni(({textureNode:t,bumpScale:e})=>{const s=e=>t.cache().context({getUV:t=>e(t.uvNode||Ch()),forceUVContext:!0}),r=Ai(s(t=>t));return Ii(Ai(s(t=>t.add(t.dFdx()))).sub(r),Ai(s(t=>t.add(t.dFdy()))).sub(r)).mul(e)}),Du=Ni(t=>{const{surf_pos:e,surf_norm:s,dHdxy:r}=t,i=e.dFdx().normalize(),n=s,a=e.dFdy().normalize().cross(n),o=n.cross(i),h=i.dot(a).mul(Il),l=h.sign().mul(r.x.mul(a).add(r.y.mul(o)));return h.abs().mul(s).sub(l).normalize()});class Uu extends Vr{static get type(){return"BumpMapNode"}constructor(t,e=null){super("vec3"),this.textureNode=t,this.scaleNode=e}setup(){const t=null!==this.scaleNode?this.scaleNode:1,e=ku({textureNode:this.textureNode,bumpScale:t});return Du({surf_pos:Al,surf_norm:Bl,dHdxy:e})}}const Wu=fi(Uu).setParameterLength(1,2),ju=new Map;class qu extends _r{static get type(){return"MaterialNode"}constructor(t){super(),this.scope=t}getCache(t,e){let s=ju.get(t);return void 0===s&&(s=uu(t,e),ju.set(t,s)),s}getFloat(t){return this.getCache(t,"float")}getColor(t){return this.getCache(t,"color")}getTexture(t){return this.getCache("map"===t?"map":t+"Map","texture")}setup(t){const e=t.context.material,s=this.scope;let r=null;if(s===qu.COLOR){const t=void 0!==e.color?this.getColor(s):Oi();r=e.map&&!0===e.map.isTexture?t.mul(this.getTexture("map")):t}else if(s===qu.OPACITY){const t=this.getFloat(s);r=e.alphaMap&&!0===e.alphaMap.isTexture?t.mul(this.getTexture("alpha")):t}else if(s===qu.SPECULAR_STRENGTH)r=e.specularMap&&!0===e.specularMap.isTexture?this.getTexture("specular").r:Ai(1);else if(s===qu.SPECULAR_INTENSITY){const t=this.getFloat(s);r=e.specularIntensityMap&&!0===e.specularIntensityMap.isTexture?t.mul(this.getTexture(s).a):t}else if(s===qu.SPECULAR_COLOR){const t=this.getColor(s);r=e.specularColorMap&&!0===e.specularColorMap.isTexture?t.mul(this.getTexture(s).rgb):t}else if(s===qu.ROUGHNESS){const t=this.getFloat(s);r=e.roughnessMap&&!0===e.roughnessMap.isTexture?t.mul(this.getTexture(s).g):t}else if(s===qu.METALNESS){const t=this.getFloat(s);r=e.metalnessMap&&!0===e.metalnessMap.isTexture?t.mul(this.getTexture(s).b):t}else if(s===qu.EMISSIVE){const t=this.getFloat("emissiveIntensity"),i=this.getColor(s).mul(t);r=e.emissiveMap&&!0===e.emissiveMap.isTexture?i.mul(this.getTexture(s)):i}else if(s===qu.NORMAL)e.normalMap?(r=Bu(this.getTexture("normal"),this.getCache("normalScale","vec2")),r.normalMapType=e.normalMapType):r=e.bumpMap?Wu(this.getTexture("bump").r,this.getFloat("bumpScale")):Bl;else if(s===qu.CLEARCOAT){const t=this.getFloat(s);r=e.clearcoatMap&&!0===e.clearcoatMap.isTexture?t.mul(this.getTexture(s).r):t}else if(s===qu.CLEARCOAT_ROUGHNESS){const t=this.getFloat(s);r=e.clearcoatRoughnessMap&&!0===e.clearcoatRoughnessMap.isTexture?t.mul(this.getTexture(s).r):t}else if(s===qu.CLEARCOAT_NORMAL)r=e.clearcoatNormalMap?Bu(this.getTexture(s),this.getCache(s+"Scale","vec2")):Bl;else if(s===qu.SHEEN){const t=this.getColor("sheenColor").mul(this.getFloat("sheen"));r=e.sheenColorMap&&!0===e.sheenColorMap.isTexture?t.mul(this.getTexture("sheenColor").rgb):t}else if(s===qu.SHEEN_ROUGHNESS){const t=this.getFloat(s);r=e.sheenRoughnessMap&&!0===e.sheenRoughnessMap.isTexture?t.mul(this.getTexture(s).a):t,r=r.clamp(.07,1)}else if(s===qu.ANISOTROPY)if(e.anisotropyMap&&!0===e.anisotropyMap.isTexture){const t=this.getTexture(s);r=ji(Vc.x,Vc.y,Vc.y.negate(),Vc.x).mul(t.rg.mul(2).sub(Ii(1)).normalize().mul(t.b))}else r=Vc;else if(s===qu.IRIDESCENCE_THICKNESS){const t=ou("1","float",e.iridescenceThicknessRange);if(e.iridescenceThicknessMap){const i=ou("0","float",e.iridescenceThicknessRange);r=t.sub(i).mul(this.getTexture(s).g).add(i)}else r=t}else if(s===qu.TRANSMISSION){const t=this.getFloat(s);r=e.transmissionMap?t.mul(this.getTexture(s).r):t}else if(s===qu.THICKNESS){const t=this.getFloat(s);r=e.thicknessMap?t.mul(this.getTexture(s).g):t}else if(s===qu.IOR)r=this.getFloat(s);else if(s===qu.LIGHT_MAP)r=this.getTexture(s).rgb.mul(this.getFloat("lightMapIntensity"));else if(s===qu.AO)r=this.getTexture(s).r.sub(1).mul(this.getFloat("aoMapIntensity")).add(1);else if(s===qu.LINE_DASH_OFFSET)r=e.dashOffset?this.getFloat(s):Ai(0);else{const e=this.getNodeType(t);r=this.getCache(s,e)}return r}}qu.ALPHA_TEST="alphaTest",qu.COLOR="color",qu.OPACITY="opacity",qu.SHININESS="shininess",qu.SPECULAR="specular",qu.SPECULAR_STRENGTH="specularStrength",qu.SPECULAR_INTENSITY="specularIntensity",qu.SPECULAR_COLOR="specularColor",qu.REFLECTIVITY="reflectivity",qu.ROUGHNESS="roughness",qu.METALNESS="metalness",qu.NORMAL="normal",qu.CLEARCOAT="clearcoat",qu.CLEARCOAT_ROUGHNESS="clearcoatRoughness",qu.CLEARCOAT_NORMAL="clearcoatNormal",qu.EMISSIVE="emissive",qu.ROTATION="rotation",qu.SHEEN="sheen",qu.SHEEN_ROUGHNESS="sheenRoughness",qu.ANISOTROPY="anisotropy",qu.IRIDESCENCE="iridescence",qu.IRIDESCENCE_IOR="iridescenceIOR",qu.IRIDESCENCE_THICKNESS="iridescenceThickness",qu.IOR="ior",qu.TRANSMISSION="transmission",qu.THICKNESS="thickness",qu.ATTENUATION_DISTANCE="attenuationDistance",qu.ATTENUATION_COLOR="attenuationColor",qu.LINE_SCALE="scale",qu.LINE_DASH_SIZE="dashSize",qu.LINE_GAP_SIZE="gapSize",qu.LINE_WIDTH="linewidth",qu.LINE_DASH_OFFSET="dashOffset",qu.POINT_SIZE="size",qu.DISPERSION="dispersion",qu.LIGHT_MAP="light",qu.AO="ao";const Hu=xi(qu,qu.ALPHA_TEST),Gu=xi(qu,qu.COLOR),Xu=xi(qu,qu.SHININESS),Yu=xi(qu,qu.EMISSIVE),Zu=xi(qu,qu.OPACITY),$u=xi(qu,qu.SPECULAR),Ju=xi(qu,qu.SPECULAR_INTENSITY),Ku=xi(qu,qu.SPECULAR_COLOR),Qu=xi(qu,qu.SPECULAR_STRENGTH),tc=xi(qu,qu.REFLECTIVITY),ec=xi(qu,qu.ROUGHNESS),sc=xi(qu,qu.METALNESS),rc=xi(qu,qu.NORMAL),ic=xi(qu,qu.CLEARCOAT),nc=xi(qu,qu.CLEARCOAT_ROUGHNESS),ac=xi(qu,qu.CLEARCOAT_NORMAL),oc=xi(qu,qu.ROTATION),hc=xi(qu,qu.SHEEN),lc=xi(qu,qu.SHEEN_ROUGHNESS),uc=xi(qu,qu.ANISOTROPY),cc=xi(qu,qu.IRIDESCENCE),dc=xi(qu,qu.IRIDESCENCE_IOR),pc=xi(qu,qu.IRIDESCENCE_THICKNESS),mc=xi(qu,qu.TRANSMISSION),gc=xi(qu,qu.THICKNESS),yc=xi(qu,qu.IOR),fc=xi(qu,qu.ATTENUATION_DISTANCE),xc=xi(qu,qu.ATTENUATION_COLOR),bc=xi(qu,qu.LINE_SCALE),vc=xi(qu,qu.LINE_DASH_SIZE),Nc=xi(qu,qu.LINE_GAP_SIZE),wc=xi(qu,qu.LINE_WIDTH),Tc=xi(qu,qu.LINE_DASH_OFFSET),Mc=xi(qu,qu.POINT_SIZE),_c=xi(qu,qu.DISPERSION),Sc=xi(qu,qu.LIGHT_MAP),Ac=xi(qu,qu.AO),Vc=En(new U).onReference(function(t){return t.material}).onRenderUpdate(function({material:t}){this.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation))}),zc=Ni(t=>t.context.setupModelViewProjection(),"vec4").once()().toVarying("v_modelViewProjection");class Cc extends _r{static get type(){return"IndexNode"}constructor(t){super("uint"),this.scope=t,this.isIndexNode=!0}generate(t){const e=this.getNodeType(t),s=this.scope;let r,i;if(s===Cc.VERTEX)r=t.getVertexIndex();else if(s===Cc.INSTANCE)r=t.getInstanceIndex();else if(s===Cc.DRAW)r=t.getDrawIndex();else if(s===Cc.INVOCATION_LOCAL)r=t.getInvocationLocalIndex();else if(s===Cc.INVOCATION_SUBGROUP)r=t.getInvocationSubgroupIndex();else{if(s!==Cc.SUBGROUP)throw new Error("THREE.IndexNode: Unknown scope: "+s);r=t.getSubgroupIndex()}if("vertex"===t.shaderStage||"compute"===t.shaderStage)i=r;else{i=Ho(this).build(t,e)}return i}}Cc.VERTEX="vertex",Cc.INSTANCE="instance",Cc.SUBGROUP="subgroup",Cc.INVOCATION_LOCAL="invocationLocal",Cc.INVOCATION_SUBGROUP="invocationSubgroup",Cc.DRAW="draw";const Ic=xi(Cc,Cc.VERTEX),Rc=xi(Cc,Cc.INSTANCE),Ec=xi(Cc,Cc.SUBGROUP),Lc=xi(Cc,Cc.INVOCATION_SUBGROUP),Oc=xi(Cc,Cc.INVOCATION_LOCAL),Pc=xi(Cc,Cc.DRAW);class Fc extends _r{static get type(){return"InstanceNode"}constructor(t,e,s=null){super("void"),this.count=t,this.instanceMatrix=e,this.instanceColor=s,this.instanceMatrixNode=null,this.instanceColorNode=null,this.updateType=xr.FRAME,this.buffer=null,this.bufferColor=null}setup(t){const{count:e,instanceMatrix:s,instanceColor:r}=this;let{instanceMatrixNode:i,instanceColorNode:n}=this;if(null===i){if(e<=1e3)i=Uh(s.array,"mat4",Math.max(e,1)).element(Rc);else{const t=new $s(s.array,16,1);this.buffer=t;const e=s.usage===S?uh:lh,r=[e(t,"vec4",16,0),e(t,"vec4",16,4),e(t,"vec4",16,8),e(t,"vec4",16,12)];i=Hi(...r)}this.instanceMatrixNode=i}if(r&&null===n){const t=new Ss(r.array,3),e=r.usage===S?uh:lh;this.bufferColor=t,n=Oi(e(t,"vec3",3,0)),this.instanceColorNode=n}const a=i.mul(Tl).xyz;if(Tl.assign(a),t.hasGeometryAttribute("normal")){const t=Ul(Ll,i);Ll.assign(t)}null!==this.instanceColorNode&&$i("vec3","vInstanceColor").assign(this.instanceColorNode)}update(){this.instanceMatrix.usage!==S&&null!==this.buffer&&this.instanceMatrix.version!==this.buffer.version&&(this.buffer.version=this.instanceMatrix.version),this.instanceColor&&this.instanceColor.usage!==S&&null!==this.bufferColor&&this.instanceColor.version!==this.bufferColor.version&&(this.bufferColor.version=this.instanceColor.version)}}const Bc=fi(Fc).setParameterLength(2,3);class kc extends Fc{static get type(){return"InstancedMeshNode"}constructor(t){const{count:e,instanceMatrix:s,instanceColor:r}=t;super(e,s,r),this.instancedMesh=t}}const Dc=fi(kc).setParameterLength(1);class Uc extends _r{static get type(){return"BatchNode"}constructor(t){super("void"),this.batchMesh=t,this.batchingIdNode=null}setup(t){null===this.batchingIdNode&&(null===t.getDrawIndex()?this.batchingIdNode=Rc:this.batchingIdNode=Pc);const e=Ni(([t])=>{const e=Vi(Rh(kh(this.batchMesh._indirectTexture),0).x),s=Vi(t).mod(e),r=Vi(t).div(e);return kh(this.batchMesh._indirectTexture,Ri(s,r)).x}).setLayout({name:"getIndirectIndex",type:"uint",inputs:[{name:"id",type:"int"}]}),s=e(Vi(this.batchingIdNode)),r=this.batchMesh._matricesTexture,i=Vi(Rh(kh(r),0).x),n=Ai(s).mul(4).toInt().toVar(),a=n.mod(i),o=n.div(i),h=Hi(kh(r,Ri(a,o)),kh(r,Ri(a.add(1),o)),kh(r,Ri(a.add(2),o)),kh(r,Ri(a.add(3),o))),l=this.batchMesh._colorsTexture;if(null!==l){const t=Ni(([t])=>{const e=Vi(Rh(kh(l),0).x),s=t,r=s.mod(e),i=s.div(e);return kh(l,Ri(r,i)).rgb}).setLayout({name:"getBatchingColor",type:"vec3",inputs:[{name:"id",type:"int"}]}),e=t(s);$i("vec3","vBatchColor").assign(e)}const u=qi(h);Tl.assign(h.mul(Tl));const c=Ll.div(Oi(u[0].dot(u[0]),u[1].dot(u[1]),u[2].dot(u[2]))),d=u.mul(c).xyz;Ll.assign(d),t.hasGeometryAttribute("tangent")&&Su.mulAssign(u)}}const Wc=fi(Uc).setParameterLength(1);class jc extends Sr{static get type(){return"StorageArrayElementNode"}constructor(t,e){super(t,e),this.isStorageArrayElementNode=!0}set storageBufferNode(t){this.node=t}get storageBufferNode(){return this.node}getMemberType(t,e){const s=this.storageBufferNode.structTypeNode;return s?s.getMemberType(t,e):"void"}setup(t){return!1===t.isAvailable("storageBuffer")&&!0===this.node.isPBO&&t.setupPBO(this.node),super.setup(t)}generate(t,e){let s;const r=t.context.assign;if(s=!1===t.isAvailable("storageBuffer")?!0!==this.node.isPBO||!0===r||!this.node.value.isInstancedBufferAttribute&&"compute"===t.shaderStage?this.node.build(t):t.generatePBO(this):super.generate(t),!0!==r){const r=this.getNodeType(t);s=t.format(s,r,e)}return s}}const qc=fi(jc).setParameterLength(2);class Hc extends Dh{static get type(){return"StorageBufferNode"}constructor(t,e=null,s=0){let r,i=null;e&&e.isStruct?(r="struct",i=e.layout,(t.isStorageBufferAttribute||t.isStorageInstancedBufferAttribute)&&(s=t.count)):null===e&&(t.isStorageBufferAttribute||t.isStorageInstancedBufferAttribute)?(r=function(t){return ar.get(t)}(t.itemSize),s=t.count):r=e,super(t,r,s),this.isStorageBufferNode=!0,this.structTypeNode=i,this.access=br.READ_WRITE,this.isAtomic=!1,this.isPBO=!1,this._attribute=null,this._varying=null,this.global=!0,!0!==t.isStorageBufferAttribute&&!0!==t.isStorageInstancedBufferAttribute&&(t.isInstancedBufferAttribute?t.isStorageInstancedBufferAttribute=!0:t.isStorageBufferAttribute=!0)}getHash(t){if(0===this.bufferCount){let e=t.globalCache.getData(this.value);return void 0===e&&(e={node:this},t.globalCache.setData(this.value,e)),e.node.uuid}return this.uuid}getInputType(){return this.value.isIndirectStorageBufferAttribute?"indirectStorageBuffer":"storageBuffer"}element(t){return qc(this,t)}setPBO(t){return this.isPBO=t,this}getPBO(){return this.isPBO}setAccess(t){return this.access=t,this}toReadOnly(){return this.setAccess(br.READ_ONLY)}setAtomic(t){return this.isAtomic=t,this}toAtomic(){return this.setAtomic(!0)}getAttributeData(){return null===this._attribute&&(this._attribute=oh(this.value),this._varying=Ho(this._attribute)),{attribute:this._attribute,varying:this._varying}}getNodeType(t){if(null!==this.structTypeNode)return this.structTypeNode.getNodeType(t);if(t.isAvailable("storageBuffer")||t.isAvailable("indirectStorageBuffer"))return super.getNodeType(t);const{attribute:e}=this.getAttributeData();return e.getNodeType(t)}getMemberType(t,e){return null!==this.structTypeNode?this.structTypeNode.getMemberType(t,e):"void"}generate(t){if(null!==this.structTypeNode&&this.structTypeNode.build(t),t.isAvailable("storageBuffer")||t.isAvailable("indirectStorageBuffer"))return super.generate(t);const{attribute:e,varying:s}=this.getAttributeData(),r=s.build(t);return t.registerTransform(r,e),r}}const Gc=(t,e=null,s=0)=>pi(new Hc(t,e,s)),Xc=new WeakMap;class Yc extends _r{static get type(){return"SkinningNode"}constructor(t){super("void"),this.skinnedMesh=t,this.updateType=xr.OBJECT,this.skinIndexNode=zh("skinIndex","uvec4"),this.skinWeightNode=zh("skinWeight","vec4"),this.bindMatrixNode=ou("bindMatrix","mat4"),this.bindMatrixInverseNode=ou("bindMatrixInverse","mat4"),this.boneMatricesNode=hu("skeleton.boneMatrices","mat4",t.skeleton.bones.length),this.positionNode=Tl,this.toPositionNode=Tl,this.previousBoneMatricesNode=null}getSkinnedPosition(t=this.boneMatricesNode,e=this.positionNode){const{skinIndexNode:s,skinWeightNode:r,bindMatrixNode:i,bindMatrixInverseNode:n}=this,a=t.element(s.x),o=t.element(s.y),h=t.element(s.z),l=t.element(s.w),u=i.mul(e),c=Wn(a.mul(r.x).mul(u),o.mul(r.y).mul(u),h.mul(r.z).mul(u),l.mul(r.w).mul(u));return n.mul(c).xyz}getSkinnedNormal(t=this.boneMatricesNode,e=Ll){const{skinIndexNode:s,skinWeightNode:r,bindMatrixNode:i,bindMatrixInverseNode:n}=this,a=t.element(s.x),o=t.element(s.y),h=t.element(s.z),l=t.element(s.w);let u=Wn(r.x.mul(a),r.y.mul(o),r.z.mul(h),r.w.mul(l));return u=n.mul(u).mul(i),u.transformDirection(e).xyz}getPreviousSkinnedPosition(t){const e=t.object;return null===this.previousBoneMatricesNode&&(e.skeleton.previousBoneMatrices=new Float32Array(e.skeleton.boneMatrices),this.previousBoneMatricesNode=hu("skeleton.previousBoneMatrices","mat4",e.skeleton.bones.length)),this.getSkinnedPosition(this.previousBoneMatricesNode,Ml)}needsPreviousBoneMatrices(t){const e=t.renderer.getMRT();return e&&e.has("velocity")||!0===mr(t.object).useVelocity}setup(t){this.needsPreviousBoneMatrices(t)&&Ml.assign(this.getPreviousSkinnedPosition(t));const e=this.getSkinnedPosition();if(this.toPositionNode&&this.toPositionNode.assign(e),t.hasGeometryAttribute("normal")){const e=this.getSkinnedNormal();Ll.assign(e),t.hasGeometryAttribute("tangent")&&Su.assign(e)}return e}generate(t,e){if("void"!==e)return super.generate(t,e)}update(t){const e=t.object&&t.object.skeleton?t.object.skeleton:this.skinnedMesh.skeleton;Xc.get(e)!==t.frameId&&(Xc.set(e,t.frameId),null!==this.previousBoneMatricesNode&&e.previousBoneMatrices.set(e.boneMatrices),e.update())}}const Zc=t=>pi(new Yc(t));class $c extends _r{static get type(){return"LoopNode"}constructor(t=[]){super(),this.params=t}getVarName(t){return String.fromCharCode("i".charCodeAt(0)+t)}getProperties(t){const e=t.getNodeProperties(this);if(void 0!==e.stackNode)return e;const s={};for(let t=0,e=this.params.length-1;t<e;t++){const e=this.params[t],r=!0!==e.isNode&&e.name||this.getVarName(t),i=!0!==e.isNode&&e.type||"int";s[r]=wh(r,i)}const r=t.addStack();e.returnsNode=this.params[this.params.length-1](s,t),e.stackNode=r;const i=this.params[0];return!0!==i.isNode&&"function"==typeof i.update&&(e.updateNode=Ni(this.params[0].update)(s)),t.removeStack(),e}getNodeType(t){const{returnsNode:e}=this.getProperties(t);return e?e.getNodeType(t):"void"}setup(t){this.getProperties(t)}generate(t){const e=this.getProperties(t),s=this.params,r=e.stackNode;for(let r=0,i=s.length-1;r<i;r++){const i=s[r];let n,a=!1,o=null,h=null,l=null,u=null,c=null,d=null;if(i.isNode?"bool"===i.getNodeType(t)?(a=!0,u="bool",h=i.build(t,u)):(u="int",l=this.getVarName(r),o="0",h=i.build(t,u),c="<"):(u=i.type||"int",l=i.name||this.getVarName(r),o=i.start,h=i.end,c=i.condition,d=i.update,"number"==typeof o?o=t.generateConst(u,o):o&&o.isNode&&(o=o.build(t,u)),"number"==typeof h?h=t.generateConst(u,h):h&&h.isNode&&(h=h.build(t,u)),void 0!==o&&void 0===h?(o+=" - 1",h="0",c=">="):void 0!==h&&void 0===o&&(o="0",c="<"),void 0===c&&(c=Number(o)>Number(h)?">=":"<")),a)n=`while ( ${h} )`;else{const s={start:o,end:h},r=s.start,i=s.end;let a;const p=()=>c.includes("<")?"+=":"-=";if(null!=d)switch(typeof d){case"function":a=t.flowStagesNode(e.updateNode,"void").code.replace(/\t|;/g,"");break;case"number":a=l+" "+p()+" "+t.generateConst(u,d);break;case"string":a=l+" "+d;break;default:a=d.isNode?l+" "+p()+" "+d.build(t):"break /* invalid update */"}else d="int"===u||"uint"===u?c.includes("<")?"++":"--":p()+" 1.",a=l+" "+d;n=`for ( ${t.getVar(u,l)+" = "+r}; ${l+" "+c+" "+i}; ${a} )`}t.addFlowCode((0===r?"\n":"")+t.tab+n+" {\n\n").addFlowTab()}const i=r.build(t,"void"),n=e.returnsNode?e.returnsNode.build(t):"";t.removeFlowTab().addFlowCode("\n"+t.tab+i);for(let e=0,s=this.params.length-1;e<s;e++)t.addFlowCode((0===e?"":t.tab)+"}\n\n").removeFlowTab();return t.addFlowTab(),n}}const Jc=(...t)=>pi(new $c(yi(t,"int"))).toStack(),Kc=()=>wh("break").toStack(),Qc=new WeakMap,td=new ct,ed=Ni(({bufferMap:t,influence:e,stride:s,width:r,depth:i,offset:n})=>{const a=Vi(Ic).mul(s).add(n),o=a.div(r),h=a.sub(o.mul(r));return kh(t,Ri(h,o)).depth(i).xyz.mul(e)});class sd extends _r{static get type(){return"MorphNode"}constructor(t){super("void"),this.mesh=t,this.morphBaseInfluence=En(1),this.updateType=xr.OBJECT}setup(t){const{geometry:e}=t,s=void 0!==e.morphAttributes.position,r=e.hasAttribute("normal")&&void 0!==e.morphAttributes.normal,i=e.morphAttributes.position||e.morphAttributes.normal||e.morphAttributes.color,n=void 0!==i?i.length:0,{texture:a,stride:o,size:h}=function(t){const e=void 0!==t.morphAttributes.position,s=void 0!==t.morphAttributes.normal,r=void 0!==t.morphAttributes.color,i=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,n=void 0!==i?i.length:0;let a=Qc.get(t);if(void 0===a||a.count!==n){void 0!==a&&a.texture.dispose();const o=t.morphAttributes.position||[],h=t.morphAttributes.normal||[],l=t.morphAttributes.color||[];let u=0;!0===e&&(u=1),!0===s&&(u=2),!0===r&&(u=3);let d=t.attributes.position.count*u,p=1;const m=4096;d>m&&(p=Math.ceil(d/m),d=m);const g=new Float32Array(d*p*4*n),y=new pt(g,d,p,n);y.type=c,y.needsUpdate=!0;const f=4*u;for(let b=0;b<n;b++){const v=o[b],N=h[b],w=l[b],T=d*p*4*b;for(let M=0;M<v.count;M++){const _=M*f;!0===e&&(td.fromBufferAttribute(v,M),g[T+_+0]=td.x,g[T+_+1]=td.y,g[T+_+2]=td.z,g[T+_+3]=0),!0===s&&(td.fromBufferAttribute(N,M),g[T+_+4]=td.x,g[T+_+5]=td.y,g[T+_+6]=td.z,g[T+_+7]=0),!0===r&&(td.fromBufferAttribute(w,M),g[T+_+8]=td.x,g[T+_+9]=td.y,g[T+_+10]=td.z,g[T+_+11]=4===w.itemSize?td.w:1)}}function x(){y.dispose(),Qc.delete(t),t.removeEventListener("dispose",x)}a={count:n,texture:y,stride:u,size:new U(d,p)},Qc.set(t,a),t.addEventListener("dispose",x)}return a}(e);!0===s&&Tl.mulAssign(this.morphBaseInfluence),!0===r&&Ll.mulAssign(this.morphBaseInfluence);const l=Vi(h.width);Jc(n,({i:t})=>{const e=Ai(0).toVar();this.mesh.count>1&&null!==this.mesh.morphTexture&&void 0!==this.mesh.morphTexture?e.assign(kh(this.mesh.morphTexture,Ri(Vi(t).add(1),Vi(Rc))).r):e.assign(ou("morphTargetInfluences","float").element(t).toVar()),Mi(e.notEqual(0),()=>{!0===s&&Tl.addAssign(ed({bufferMap:a,influence:e,stride:o,width:l,depth:t,offset:Vi(0)})),!0===r&&Ll.addAssign(ed({bufferMap:a,influence:e,stride:o,width:l,depth:t,offset:Vi(1)}))})})}update(){const t=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?t.value=1:t.value=1-this.mesh.morphTargetInfluences.reduce((t,e)=>t+e,0)}}const rd=fi(sd).setParameterLength(1);class id extends _r{static get type(){return"LightingNode"}constructor(){super("vec3"),this.isLightingNode=!0}}class nd extends id{static get type(){return"AONode"}constructor(t=null){super(),this.aoNode=t}setup(t){t.context.ambientOcclusion.mulAssign(this.aoNode)}}class ad extends Ro{static get type(){return"LightingContextNode"}constructor(t,e=null,s=null,r=null){super(t),this.lightingModel=e,this.backdropNode=s,this.backdropAlphaNode=r,this._value=null}getContext(){const{backdropNode:t,backdropAlphaNode:e}=this,s={directDiffuse:Oi().toVar("directDiffuse"),directSpecular:Oi().toVar("directSpecular"),indirectDiffuse:Oi().toVar("indirectDiffuse"),indirectSpecular:Oi().toVar("indirectSpecular")};return{radiance:Oi().toVar("radiance"),irradiance:Oi().toVar("irradiance"),iblIrradiance:Oi().toVar("iblIrradiance"),ambientOcclusion:Ai(1).toVar("ambientOcclusion"),reflectedLight:s,backdrop:t,backdropAlpha:e}}setup(t){return this.value=this._value||(this._value=this.getContext()),this.value.lightingModel=this.lightingModel||t.context.lightingModel,super.setup(t)}}const od=fi(ad);class hd extends id{static get type(){return"IrradianceNode"}constructor(t){super(),this.node=t}setup(t){t.context.irradiance.addAssign(this.node)}}let ld,ud;class cd extends _r{static get type(){return"ScreenNode"}constructor(t){super(),this.scope=t,this.isViewportNode=!0}getNodeType(){return this.scope===cd.VIEWPORT?"vec4":"vec2"}getUpdateType(){let t=xr.NONE;return this.scope!==cd.SIZE&&this.scope!==cd.VIEWPORT||(t=xr.RENDER),this.updateType=t,t}update({renderer:t}){const e=t.getRenderTarget();this.scope===cd.VIEWPORT?null!==e?ud.copy(e.viewport):(t.getViewport(ud),ud.multiplyScalar(t.getPixelRatio())):null!==e?(ld.width=e.width,ld.height=e.height):t.getDrawingBufferSize(ld)}setup(){const t=this.scope;let e=null;return e=t===cd.SIZE?En(ld||(ld=new U)):t===cd.VIEWPORT?En(ud||(ud=new ct)):Ii(md.div(pd)),e}generate(t){if(this.scope===cd.COORDINATE){let e=t.getFragCoord();if(t.isFlipY()){const s=t.getNodeProperties(pd).outputNode.build(t);e=`${t.getType("vec2")}( ${e}.x, ${s}.y - ${e}.y )`}return e}return super.generate(t)}}cd.COORDINATE="coordinate",cd.VIEWPORT="viewport",cd.SIZE="size",cd.UV="uv";const dd=xi(cd,cd.UV),pd=xi(cd,cd.SIZE),md=xi(cd,cd.COORDINATE),gd=xi(cd,cd.VIEWPORT),yd=gd.zw,fd=md.sub(gd.xy),xd=fd.div(yd),bd=Ni(()=>pd,"vec2").once()(),vd=new U;class Nd extends Ph{static get type(){return"ViewportTextureNode"}constructor(t=dd,e=null,s=null){let r=null;null===s?(r=new Is,r.minFilter=l,s=r):r=s,super(s,t,e),this.generateMipmaps=!1,this.defaultFramebuffer=r,this.isOutputTextureNode=!0,this.updateBeforeType=xr.RENDER,this._textures=new WeakMap}getFrameBufferTexture(t=null){const e=this.referenceNode?this.referenceNode.defaultFramebuffer:this.defaultFramebuffer;if(null===t)return e;if(!1===this._textures.has(t)){const s=e.clone();this._textures.set(t,s)}return this._textures.get(t)}updateBefore(t){const e=t.renderer,s=e.getRenderTarget();null===s?e.getDrawingBufferSize(vd):vd.set(s.width,s.height);const r=this.getFrameBufferTexture(s);r.image.width===vd.width&&r.image.height===vd.height||(r.image.width=vd.width,r.image.height=vd.height,r.needsUpdate=!0);const i=r.generateMipmaps;r.generateMipmaps=this.generateMipmaps,e.copyFramebufferToTexture(r),r.generateMipmaps=i,this.value=r}clone(){const t=new this.constructor(this.uvNode,this.levelNode,this.value);return t.generateMipmaps=this.generateMipmaps,t}}const wd=fi(Nd).setParameterLength(0,3),Td=fi(Nd,null,null,{generateMipmaps:!0}).setParameterLength(0,3);let Md=null;class _d extends Nd{static get type(){return"ViewportDepthTextureNode"}constructor(t=dd,e=null){null===Md&&(Md=new Rs),super(t,e,Md)}}const Sd=fi(_d).setParameterLength(0,2);class Ad extends _r{static get type(){return"ViewportDepthNode"}constructor(t,e=null){super("float"),this.scope=t,this.valueNode=e,this.isViewportDepthNode=!0}generate(t){const{scope:e}=this;return e===Ad.DEPTH_BASE?t.getFragDepth():super.generate(t)}setup({camera:t}){const{scope:e}=this,s=this.valueNode;let r=null;if(e===Ad.DEPTH_BASE)null!==s&&(r=Rd().assign(s));else if(e===Ad.DEPTH)r=t.isPerspectiveCamera?zd(Al.z,Xh,Yh):Vd(Al.z,Xh,Yh);else if(e===Ad.LINEAR_DEPTH)if(null!==s)if(t.isPerspectiveCamera){const t=Cd(s,Xh,Yh);r=Vd(t,Xh,Yh)}else r=s;else r=Vd(Al.z,Xh,Yh);return r}}Ad.DEPTH_BASE="depthBase",Ad.DEPTH="depth",Ad.LINEAR_DEPTH="linearDepth";const Vd=(t,e,s)=>t.add(e).div(e.sub(s)),zd=(t,e,s)=>e.add(t).mul(s).div(s.sub(e).mul(t)),Cd=(t,e,s)=>e.mul(s).div(s.sub(e).mul(t).sub(s)),Id=(t,e,s)=>{e=e.max(1e-6).toVar();const r=Sa(t.negate().div(e)),i=Sa(s.div(e));return r.div(i)},Rd=fi(Ad,Ad.DEPTH_BASE),Ed=xi(Ad,Ad.DEPTH),Ld=fi(Ad,Ad.LINEAR_DEPTH).setParameterLength(0,1),Od=Ld(Sd());Ed.assign=t=>Rd(t);class Pd extends _r{static get type(){return"ClippingNode"}constructor(t=Pd.DEFAULT){super(),this.scope=t}setup(t){super.setup(t);const e=t.clippingContext,{intersectionPlanes:s,unionPlanes:r}=e;return this.hardwareClipping=t.material.hardwareClipping,this.scope===Pd.ALPHA_TO_COVERAGE?this.setupAlphaToCoverage(s,r):this.scope===Pd.HARDWARE?this.setupHardwareClipping(r,t):this.setupDefault(s,r)}setupAlphaToCoverage(t,e){return Ni(()=>{const s=Ai().toVar("distanceToPlane"),r=Ai().toVar("distanceToGradient"),i=Ai(1).toVar("clipOpacity"),n=e.length;if(!1===this.hardwareClipping&&n>0){const t=qh(e);Jc(n,({i:e})=>{const n=t.element(e);s.assign(Al.dot(n.xyz).negate().add(n.w)),r.assign(s.fwidth().div(2)),i.mulAssign(No(r.negate(),r,s))})}const a=t.length;if(a>0){const e=qh(t),n=Ai(1).toVar("intersectionClipOpacity");Jc(a,({i:t})=>{const i=e.element(t);s.assign(Al.dot(i.xyz).negate().add(i.w)),r.assign(s.fwidth().div(2)),n.mulAssign(No(r.negate(),r,s).oneMinus())}),i.mulAssign(n.oneMinus())}Ji.a.mulAssign(i),Ji.a.equal(0).discard()})()}setupDefault(t,e){return Ni(()=>{const s=e.length;if(!1===this.hardwareClipping&&s>0){const t=qh(e);Jc(s,({i:e})=>{const s=t.element(e);Al.dot(s.xyz).greaterThan(s.w).discard()})}const r=t.length;if(r>0){const e=qh(t),s=Ci(!0).toVar("clipped");Jc(r,({i:t})=>{const r=e.element(t);s.assign(Al.dot(r.xyz).greaterThan(r.w).and(s))}),s.discard()}})()}setupHardwareClipping(t,e){const s=t.length;return e.enableHardwareClipping(s),Ni(()=>{const r=qh(t),i=Hh(e.getClipDistance());Jc(s,({i:t})=>{const e=r.element(t),s=Al.dot(e.xyz).sub(e.w).negate();i.element(t).assign(s)})})()}}Pd.ALPHA_TO_COVERAGE="alphaToCoverage",Pd.DEFAULT="default",Pd.HARDWARE="hardware";const Fd=Ni(([t])=>Ra(qn(1e4,Ea(qn(17,t.x).add(qn(.1,t.y)))).mul(Wn(.1,ka(Ea(qn(13,t.y).add(t.x))))))),Bd=Ni(([t])=>Fd(Ii(Fd(t.xy),t.z))),kd=Ni(([t])=>{const e=so(Ua(qa(t.xyz)),Ua(Ha(t.xyz))),s=Ai(1).div(Ai(.05).mul(e)).toVar("pixScale"),r=Ii(Ma(za(Sa(s))),Ma(Ca(Sa(s)))),i=Ii(Bd(za(r.x.mul(t.xyz))),Bd(za(r.y.mul(t.xyz)))),n=Ra(Sa(s)),a=Wn(qn(n.oneMinus(),i.x),qn(n,i.y)),o=eo(n,n.oneMinus()),h=Oi(a.mul(a).div(qn(2,o).mul(jn(1,o))),a.sub(qn(.5,o)).div(jn(1,o)),jn(1,jn(1,a).mul(jn(1,a)).div(qn(2,o).mul(jn(1,o))))),l=a.lessThan(o.oneMinus()).select(a.lessThan(o).select(h.x,h.y),h.z);return xo(l,1e-6,1)}).setLayout({name:"getAlphaHashThreshold",type:"float",inputs:[{name:"position",type:"vec3"}]});class Dd extends Vh{static get type(){return"VertexColorNode"}constructor(t){super(null,"vec4"),this.isVertexColorNode=!0,this.index=t}getAttributeName(){const t=this.index;return"color"+(t>0?t:"")}generate(t){const e=this.getAttributeName(t);let s;return s=!0===t.hasGeometryAttribute(e)?super.generate(t):t.generateConst(this.nodeType,new ct(1,1,1,1)),s}serialize(t){super.serialize(t),t.index=this.index}deserialize(t){super.deserialize(t),this.index=t.index}}const Ud=(t=0)=>pi(new Dd(t)),Wd=Ni(([t,e])=>eo(1,t.oneMinus().div(e)).oneMinus()).setLayout({name:"blendBurn",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),jd=Ni(([t,e])=>eo(t.div(e.oneMinus()),1)).setLayout({name:"blendDodge",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),qd=Ni(([t,e])=>t.oneMinus().mul(e.oneMinus()).oneMinus()).setLayout({name:"blendScreen",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),Hd=Ni(([t,e])=>fo(t.mul(2).mul(e),t.oneMinus().mul(2).mul(e.oneMinus()).oneMinus(),ro(.5,t))).setLayout({name:"blendOverlay",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),Gd=Ni(([t,e])=>{const s=e.a.add(t.a.mul(e.a.oneMinus()));return ki(e.rgb.mul(e.a).add(t.rgb.mul(t.a).mul(e.a.oneMinus())).div(s),s)}).setLayout({name:"blendColor",type:"vec4",inputs:[{name:"base",type:"vec4"},{name:"blend",type:"vec4"}]}),Xd=Ni(([t])=>ki(t.rgb.mul(t.a),t.a),{color:"vec4",return:"vec4"}),Yd=Ni(([t])=>(Mi(t.a.equal(0),()=>ki(0)),ki(t.rgb.div(t.a),t.a)),{color:"vec4",return:"vec4"});class Zd extends Pe{static get type(){return"NodeMaterial"}get type(){return this.constructor.type}set type(t){}constructor(){super(),this.isNodeMaterial=!0,this.fog=!0,this.lights=!1,this.hardwareClipping=!1,this.lightsNode=null,this.envNode=null,this.aoNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.maskNode=null,this.positionNode=null,this.geometryNode=null,this.depthNode=null,this.receivedShadowPositionNode=null,this.castShadowPositionNode=null,this.receivedShadowNode=null,this.castShadowNode=null,this.outputNode=null,this.mrtNode=null,this.fragmentNode=null,this.vertexNode=null,Object.defineProperty(this,"shadowPositionNode",{get:()=>this.receivedShadowPositionNode,set:t=>{this.receivedShadowPositionNode=t}})}customProgramCacheKey(){return this.type+ir(this)}build(t){this.setup(t)}setupObserver(t){return new tr(t)}setup(t){t.context.setupNormal=()=>jo(this.setupNormal(t),"NORMAL","vec3"),t.context.setupPositionView=()=>this.setupPositionView(t),t.context.setupModelViewProjection=()=>this.setupModelViewProjection(t);const e=t.renderer,s=e.getRenderTarget();t.addStack();const r=jo(this.setupVertex(t),"VERTEX"),i=this.vertexNode||r;let n;t.stack.outputNode=i,this.setupHardwareClipping(t),null!==this.geometryNode&&(t.stack.outputNode=t.stack.outputNode.bypass(this.geometryNode)),t.addFlow("vertex",t.removeStack()),t.addStack();const a=this.setupClipping(t);if(!0!==this.depthWrite&&!0!==this.depthTest||(null!==s?!0===s.depthBuffer&&this.setupDepth(t):!0===e.depth&&this.setupDepth(t)),null===this.fragmentNode){this.setupDiffuseColor(t),this.setupVariants(t);const r=this.setupLighting(t);null!==a&&t.stack.add(a);const i=ki(r,Ji.a).max(0);n=this.setupOutput(t,i),yn.assign(n);const o=null!==this.outputNode;if(o&&(n=this.outputNode),null!==s){const t=e.getMRT(),s=this.mrtNode;null!==t?(o&&yn.assign(n),n=t,null!==s&&(n=t.merge(s))):null!==s&&(n=s)}}else{let e=this.fragmentNode;!0!==e.isOutputStructNode&&(e=ki(e)),n=this.setupOutput(t,e)}t.stack.outputNode=n,t.addFlow("fragment",t.removeStack()),t.observer=this.setupObserver(t)}setupClipping(t){if(null===t.clippingContext)return null;const{unionPlanes:e,intersectionPlanes:s}=t.clippingContext;let r=null;if(e.length>0||s.length>0){const e=t.renderer.samples;this.alphaToCoverage&&e>1?r=pi(new Pd(Pd.ALPHA_TO_COVERAGE)):t.stack.add(pi(new Pd))}return r}setupHardwareClipping(t){if(this.hardwareClipping=!1,null===t.clippingContext)return;const e=t.clippingContext.unionPlanes.length;e>0&&e<=8&&t.isAvailable("clipDistance")&&(t.stack.add(pi(new Pd(Pd.HARDWARE))),this.hardwareClipping=!0)}setupDepth(t){const{renderer:e,camera:s}=t;let r=this.depthNode;if(null===r){const t=e.getMRT();t&&t.has("depth")?r=t.get("depth"):!0===e.logarithmicDepthBuffer&&(r=s.isPerspectiveCamera?Id(Al.z,Xh,Yh):Vd(Al.z,Xh,Yh))}null!==r&&Ed.assign(r).toStack()}setupPositionView(){return xl.mul(Tl).xyz}setupModelViewProjection(){return Zh.mul(Al)}setupVertex(t){return t.addStack(),this.setupPosition(t),t.context.vertex=t.removeStack(),zc}setupPosition(t){const{object:e,geometry:s}=t;if((s.morphAttributes.position||s.morphAttributes.normal||s.morphAttributes.color)&&rd(e).toStack(),!0===e.isSkinnedMesh&&Zc(e).toStack(),this.displacementMap){const t=uu("displacementMap","texture"),e=uu("displacementScale","float"),s=uu("displacementBias","float");Tl.addAssign(Ll.normalize().mul(t.x.mul(e).add(s)))}return e.isBatchedMesh&&Wc(e).toStack(),e.isInstancedMesh&&e.instanceMatrix&&!0===e.instanceMatrix.isInstancedBufferAttribute&&Dc(e).toStack(),null!==this.positionNode&&Tl.assign(jo(this.positionNode,"POSITION","vec3")),Tl}setupDiffuseColor({object:t,geometry:e}){null!==this.maskNode&&Ci(this.maskNode).not().discard();let s=this.colorNode?ki(this.colorNode):Gu;if(!0===this.vertexColors&&e.hasAttribute("color")&&(s=s.mul(Ud())),t.instanceColor){s=$i("vec3","vInstanceColor").mul(s)}if(t.isBatchedMesh&&t._colorsTexture){s=$i("vec3","vBatchColor").mul(s)}Ji.assign(s);const r=this.opacityNode?Ai(this.opacityNode):Zu;Ji.a.assign(Ji.a.mul(r));let i=null;(null!==this.alphaTestNode||this.alphaTest>0)&&(i=null!==this.alphaTestNode?Ai(this.alphaTestNode):Hu,Ji.a.lessThanEqual(i).discard()),!0===this.alphaHash&&Ji.a.lessThan(kd(Tl)).discard();!1===this.transparent&&1===this.blending&&!1===this.alphaToCoverage?Ji.a.assign(1):null===i&&Ji.a.lessThanEqual(0).discard()}setupVariants(){}setupOutgoingLight(){return!0===this.lights?Oi(0):Ji.rgb}setupNormal(){return this.normalNode?Oi(this.normalNode):rc}setupEnvironment(){let t=null;return this.envNode?t=this.envNode:this.envMap&&(t=this.envMap.isCubeTexture?uu("envMap","cubeTexture"):uu("envMap","texture")),t}setupLightMap(t){let e=null;return t.material.lightMap&&(e=new hd(Sc)),e}setupLights(t){const e=[],s=this.setupEnvironment(t);s&&s.isLightingNode&&e.push(s);const r=this.setupLightMap(t);if(r&&r.isLightingNode&&e.push(r),null!==this.aoNode||t.material.aoMap){const t=null!==this.aoNode?this.aoNode:Ac;e.push(new nd(t))}let i=this.lightsNode||t.lightsNode;return e.length>0&&(i=t.renderer.lighting.createNode([...i.getLights(),...e])),i}setupLightingModel(){}setupLighting(t){const{material:e}=t,{backdropNode:s,backdropAlphaNode:r,emissiveNode:i}=this,n=!0===this.lights||null!==this.lightsNode?this.setupLights(t):null;let a=this.setupOutgoingLight(t);if(n&&n.getScope().hasLights){const e=this.setupLightingModel(t)||null;a=od(n,e,s,r)}else null!==s&&(a=Oi(null!==r?fo(a,s,r):s));return(i&&!0===i.isNode||e.emissive&&!0===e.emissive.isColor)&&(Ki.assign(Oi(i||Yu)),a=a.add(Ki)),a}setupFog(t,e){const s=t.fogNode;return s&&(yn.assign(e),e=ki(s.toVar())),e}setupPremultipliedAlpha(t,e){return Xd(e)}setupOutput(t,e){return!0===this.fog&&(e=this.setupFog(t,e)),!0===this.premultipliedAlpha&&(e=this.setupPremultipliedAlpha(t,e)),e}setDefaultValues(t){for(const e in t){const s=t[e];void 0===this[e]&&(this[e]=s,s&&s.clone&&(this[e]=s.clone()))}const e=Object.getOwnPropertyDescriptors(t.constructor.prototype);for(const t in e)void 0===Object.getOwnPropertyDescriptor(this.constructor.prototype,t)&&void 0!==e[t].get&&Object.defineProperty(this.constructor.prototype,t,e[t])}toJSON(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{},nodes:{}});const s=Pe.prototype.toJSON.call(this,t),r=nr(this);s.inputNodes={};for(const{property:e,childNode:i}of r)s.inputNodes[e]=i.toJSON(t).uuid;function i(t){const e=[];for(const s in t){const r=t[s];delete r.metadata,e.push(r)}return e}if(e){const e=i(t.textures),r=i(t.images),n=i(t.nodes);e.length>0&&(s.textures=e),r.length>0&&(s.images=r),n.length>0&&(s.nodes=n)}return s}copy(t){return this.lightsNode=t.lightsNode,this.envNode=t.envNode,this.colorNode=t.colorNode,this.normalNode=t.normalNode,this.opacityNode=t.opacityNode,this.backdropNode=t.backdropNode,this.backdropAlphaNode=t.backdropAlphaNode,this.alphaTestNode=t.alphaTestNode,this.maskNode=t.maskNode,this.positionNode=t.positionNode,this.geometryNode=t.geometryNode,this.depthNode=t.depthNode,this.receivedShadowPositionNode=t.receivedShadowPositionNode,this.castShadowPositionNode=t.castShadowPositionNode,this.receivedShadowNode=t.receivedShadowNode,this.castShadowNode=t.castShadowNode,this.outputNode=t.outputNode,this.mrtNode=t.mrtNode,this.fragmentNode=t.fragmentNode,this.vertexNode=t.vertexNode,super.copy(t)}}let $d=null;class Jd extends Nd{static get type(){return"ViewportSharedTextureNode"}constructor(t=dd,e=null){null===$d&&($d=new Is),super(t,e,$d)}updateReference(){return this}}const Kd=fi(Jd).setParameterLength(0,2),Qd=Ni(([t=Sl])=>{const e=t.z.atan(t.x).mul(1/(2*Math.PI)).add(.5),s=t.y.clamp(-1,1).asin().mul(1/Math.PI).add(.5);return Ii(e,s)});const tp=Ni(({f0:t,f90:e,dotVH:s})=>{const r=s.mul(-5.55473).sub(6.98316).mul(s).exp2();return t.mul(r.oneMinus()).add(e.mul(r))}),ep=Ni(t=>t.diffuseColor.mul(1/Math.PI)),sp=Ni(t=>{if(!1===t.geometry.hasAttribute("normal"))return Ai(0);const e=Pl.dFdx().abs().max(Pl.dFdy().abs());return e.x.max(e.y).max(e.z)}),rp=Ni(t=>{const{roughness:e}=t,s=sp();let r=e.max(.0525);return r=r.add(s),r=r.min(1),r}),ip=Ni(({alpha:t,dotNL:e,dotNV:s})=>{const r=t.pow2(),i=e.mul(r.add(r.oneMinus().mul(s.pow2())).sqrt()),n=s.mul(r.add(r.oneMinus().mul(e.pow2())).sqrt());return Hn(.5,i.add(n).max(ga))}).setLayout({name:"V_GGX_SmithCorrelated",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNL",type:"float"},{name:"dotNV",type:"float"}]}),np=Ni(({alphaT:t,alphaB:e,dotTV:s,dotBV:r,dotTL:i,dotBL:n,dotNV:a,dotNL:o})=>{const h=o.mul(Oi(t.mul(s),e.mul(r),a).length()),l=a.mul(Oi(t.mul(i),e.mul(n),o).length());return Hn(.5,h.add(l)).saturate()}).setLayout({name:"V_GGX_SmithCorrelated_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotTV",type:"float",qualifier:"in"},{name:"dotBV",type:"float",qualifier:"in"},{name:"dotTL",type:"float",qualifier:"in"},{name:"dotBL",type:"float",qualifier:"in"},{name:"dotNV",type:"float",qualifier:"in"},{name:"dotNL",type:"float",qualifier:"in"}]}),ap=Ni(({alpha:t,dotNH:e})=>{const s=t.pow2(),r=e.pow2().mul(s.oneMinus()).oneMinus();return s.div(r.pow2()).mul(1/Math.PI)}).setLayout({name:"D_GGX",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNH",type:"float"}]}),op=Ai(1/Math.PI),hp=Ni(({alphaT:t,alphaB:e,dotNH:s,dotTH:r,dotBH:i})=>{const n=t.mul(e),a=Oi(e.mul(r),t.mul(i),n.mul(s)),o=a.dot(a),h=n.div(o);return op.mul(n.mul(h.pow2()))}).setLayout({name:"D_GGX_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotNH",type:"float",qualifier:"in"},{name:"dotTH",type:"float",qualifier:"in"},{name:"dotBH",type:"float",qualifier:"in"}]}),lp=Ni(({lightDirection:t,f0:e,f90:s,roughness:r,f:i,normalView:n=Bl,USE_IRIDESCENCE:a,USE_ANISOTROPY:o})=>{const h=r.pow2(),l=t.add(Vl).normalize(),u=n.dot(t).clamp(),c=n.dot(Vl).clamp(),d=n.dot(l).clamp(),p=Vl.dot(l).clamp();let m,g,y=tp({f0:e,f90:s,dotVH:p});if(ui(a)&&(y=an.mix(y,i)),ui(o)){const e=cn.dot(t),s=cn.dot(Vl),r=cn.dot(l),i=dn.dot(t),n=dn.dot(Vl),a=dn.dot(l);m=np({alphaT:ln,alphaB:h,dotTV:s,dotBV:n,dotTL:e,dotBL:i,dotNV:c,dotNL:u}),g=hp({alphaT:ln,alphaB:h,dotNH:d,dotTH:r,dotBH:a})}else m=ip({alpha:h,dotNL:u,dotNV:c}),g=ap({alpha:h,dotNH:d});return y.mul(m).mul(g)}),up=Ni(({roughness:t,dotNV:e})=>{const s=ki(-1,-.0275,-.572,.022),r=ki(1,.0425,1.04,-.04),i=t.mul(s).add(r),n=i.x.mul(i.x).min(e.mul(-9.28).exp2()).mul(i.x).add(i.y);return Ii(-1.04,1.04).mul(n).add(i.zw)}).setLayout({name:"DFGApprox",type:"vec2",inputs:[{name:"roughness",type:"float"},{name:"dotNV",type:"vec3"}]}),cp=Ni(({f:t,f90:e,dotVH:s})=>{const r=s.oneMinus().saturate(),i=r.mul(r),n=r.mul(i,i).clamp(0,.9999);return t.sub(Oi(e).mul(n)).div(n.oneMinus())}).setLayout({name:"Schlick_to_F0",type:"vec3",inputs:[{name:"f",type:"vec3"},{name:"f90",type:"float"},{name:"dotVH",type:"float"}]}),dp=1/6,pp=t=>qn(dp,qn(t,qn(t,t.negate().add(3)).sub(3)).add(1)),mp=t=>qn(dp,qn(t,qn(t,qn(3,t).sub(6))).add(4)),gp=t=>qn(dp,qn(t,qn(t,qn(-3,t).add(3)).add(3)).add(1)),yp=t=>qn(dp,lo(t,3)),fp=t=>pp(t).add(mp(t)),xp=t=>gp(t).add(yp(t)),bp=t=>Wn(-1,mp(t).div(pp(t).add(mp(t)))),vp=t=>Wn(1,yp(t).div(gp(t).add(yp(t)))),Np=(t,e,s)=>{const r=t.uvNode,i=qn(r,e.zw).add(.5),n=za(i),a=Ra(i),o=fp(a.x),h=xp(a.x),l=bp(a.x),u=vp(a.x),c=bp(a.y),d=vp(a.y),p=Ii(n.x.add(l),n.y.add(c)).sub(.5).mul(e.xy),m=Ii(n.x.add(u),n.y.add(c)).sub(.5).mul(e.xy),g=Ii(n.x.add(l),n.y.add(d)).sub(.5).mul(e.xy),y=Ii(n.x.add(u),n.y.add(d)).sub(.5).mul(e.xy),f=fp(a.y).mul(Wn(o.mul(t.sample(p).level(s)),h.mul(t.sample(m).level(s)))),x=xp(a.y).mul(Wn(o.mul(t.sample(g).level(s)),h.mul(t.sample(y).level(s))));return f.add(x)},wp=Ni(([t,e])=>{const s=Ii(t.size(Vi(e))),r=Ii(t.size(Vi(e.add(1)))),i=Hn(1,s),n=Hn(1,r),a=Np(t,ki(i,s),za(e)),o=Np(t,ki(n,r),Ca(e));return Ra(e).mix(a,o)}),Tp=Ni(([t,e])=>{const s=e.mul(Lh(t));return wp(t,s)});Oi(.04),Ai(1);const Mp=Ai(1),_p=Ai(-2),Sp=Ai(.8),Ap=Ai(-1),Vp=Ai(.4),zp=Ai(2),Cp=Ai(.305),Ip=Ai(3),Rp=Ai(.21),Ep=Ai(4),Lp=Ai(4),Op=Ai(16),Pp=Ni(([t])=>{const e=Oi(ka(t)).toVar(),s=Ai(-1).toVar();return Mi(e.x.greaterThan(e.z),()=>{Mi(e.x.greaterThan(e.y),()=>{s.assign(Io(t.x.greaterThan(0),0,3))}).Else(()=>{s.assign(Io(t.y.greaterThan(0),1,4))})}).Else(()=>{Mi(e.z.greaterThan(e.y),()=>{s.assign(Io(t.z.greaterThan(0),2,5))}).Else(()=>{s.assign(Io(t.y.greaterThan(0),1,4))})}),s}).setLayout({name:"getFace",type:"float",inputs:[{name:"direction",type:"vec3"}]}),Fp=Ni(([t,e])=>{const s=Ii().toVar();return Mi(e.equal(0),()=>{s.assign(Ii(t.z,t.y).div(ka(t.x)))}).ElseIf(e.equal(1),()=>{s.assign(Ii(t.x.negate(),t.z.negate()).div(ka(t.y)))}).ElseIf(e.equal(2),()=>{s.assign(Ii(t.x.negate(),t.y).div(ka(t.z)))}).ElseIf(e.equal(3),()=>{s.assign(Ii(t.z.negate(),t.y).div(ka(t.x)))}).ElseIf(e.equal(4),()=>{s.assign(Ii(t.x.negate(),t.z).div(ka(t.y)))}).Else(()=>{s.assign(Ii(t.x,t.y).div(ka(t.z)))}),qn(.5,s.add(1))}).setLayout({name:"getUV",type:"vec2",inputs:[{name:"direction",type:"vec3"},{name:"face",type:"float"}]}),Bp=Ni(([t])=>{const e=Ai(0).toVar();return Mi(t.greaterThanEqual(Sp),()=>{e.assign(Mp.sub(t).mul(Ap.sub(_p)).div(Mp.sub(Sp)).add(_p))}).ElseIf(t.greaterThanEqual(Vp),()=>{e.assign(Sp.sub(t).mul(zp.sub(Ap)).div(Sp.sub(Vp)).add(Ap))}).ElseIf(t.greaterThanEqual(Cp),()=>{e.assign(Vp.sub(t).mul(Ip.sub(zp)).div(Vp.sub(Cp)).add(zp))}).ElseIf(t.greaterThanEqual(Rp),()=>{e.assign(Cp.sub(t).mul(Ep.sub(Ip)).div(Cp.sub(Rp)).add(Ip))}).Else(()=>{e.assign(Ai(-2).mul(Sa(qn(1.16,t))))}),e}).setLayout({name:"roughnessToMip",type:"float",inputs:[{name:"roughness",type:"float"}]}),kp=Ni(([t,e])=>{const s=t.toVar();s.assign(qn(2,s).sub(1));const r=Oi(s,1).toVar();return Mi(e.equal(0),()=>{r.assign(r.zyx)}).ElseIf(e.equal(1),()=>{r.assign(r.xzy),r.xz.mulAssign(-1)}).ElseIf(e.equal(2),()=>{r.x.mulAssign(-1)}).ElseIf(e.equal(3),()=>{r.assign(r.zyx),r.xz.mulAssign(-1)}).ElseIf(e.equal(4),()=>{r.assign(r.xzy),r.xy.mulAssign(-1)}).ElseIf(e.equal(5),()=>{r.z.mulAssign(-1)}),r}).setLayout({name:"getDirection",type:"vec3",inputs:[{name:"uv",type:"vec2"},{name:"face",type:"float"}]}),Dp=Ni(([t,e,s,r,i,n])=>{const a=Ai(s),o=Oi(e),h=xo(Bp(a),_p,n),l=Ra(h),u=za(h),c=Oi(Up(t,o,u,r,i,n)).toVar();return Mi(l.notEqual(0),()=>{const e=Oi(Up(t,o,u.add(1),r,i,n)).toVar();c.assign(fo(c,e,l))}),c}),Up=Ni(([t,e,s,r,i,n])=>{const a=Ai(s).toVar(),o=Oi(e),h=Ai(Pp(o)).toVar(),l=Ai(so(Lp.sub(a),0)).toVar();a.assign(so(a,Lp));const u=Ai(Ma(a)).toVar(),c=Ii(Fp(o,h).mul(u.sub(2)).add(1)).toVar();return Mi(h.greaterThan(2),()=>{c.y.addAssign(u),h.subAssign(3)}),c.x.addAssign(h.mul(u)),c.x.addAssign(l.mul(qn(3,Op))),c.y.addAssign(qn(4,Ma(n).sub(u))),c.x.mulAssign(r),c.y.mulAssign(i),t.sample(c).grad(Ii(),Ii())}),Wp=Ni(({envMap:t,mipInt:e,outputDirection:s,theta:r,axis:i,CUBEUV_TEXEL_WIDTH:n,CUBEUV_TEXEL_HEIGHT:a,CUBEUV_MAX_MIP:o})=>{const h=La(r),l=s.mul(h).add(i.cross(s).mul(Ea(r))).add(i.mul(i.dot(s).mul(h.oneMinus())));return Up(t,l,e,n,a,o)}),jp=Ni(({n:t,latitudinal:e,poleAxis:s,outputDirection:r,weights:i,samples:n,dTheta:a,mipInt:o,envMap:h,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c})=>{const d=Oi(Io(e,s,ho(s,r))).toVar();Mi(d.equal(Oi(0)),()=>{d.assign(Oi(r.z,0,r.x.negate()))}),d.assign(Ia(d));const p=Oi().toVar();return p.addAssign(i.element(0).mul(Wp({theta:0,axis:d,outputDirection:r,mipInt:o,envMap:h,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c}))),Jc({start:Vi(1),end:t},({i:t})=>{Mi(t.greaterThanEqual(n),()=>{Kc()});const e=Ai(a.mul(Ai(t))).toVar();p.addAssign(i.element(t).mul(Wp({theta:e.mul(-1),axis:d,outputDirection:r,mipInt:o,envMap:h,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c}))),p.addAssign(i.element(t).mul(Wp({theta:e,axis:d,outputDirection:r,mipInt:o,envMap:h,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c})))}),ki(p,1)}),qp=[.125,.215,.35,.446,.526,.582],Hp=20,Gp=new Zs(-1,1,1,-1,0,1),Xp=new Ns(90,1),Yp=new Ee;let Zp=null,$p=0,Jp=0;const Kp=(1+Math.sqrt(5))/2,Qp=1/Kp,tm=[new j(-Kp,Qp,0),new j(Kp,Qp,0),new j(-Qp,0,Kp),new j(Qp,0,Kp),new j(0,Kp,-Qp),new j(0,Kp,Qp),new j(-1,1,-1),new j(1,1,-1),new j(-1,1,1),new j(1,1,1)],em=new j,sm=new WeakMap,rm=[3,1,5,0,4,2],im=kp(Ch(),zh("faceIndex")).normalize(),nm=Oi(im.x,im.y,im.z);class am{constructor(t){this._renderer=t,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._backgroundBox=null}get _hasInitialized(){return this._renderer.hasInitialized()}fromScene(t,e=0,s=.1,r=100,i={}){const{size:n=256,position:a=em,renderTarget:o=null}=i;if(this._setSize(n),!1===this._hasInitialized){const n=o||this._allocateTarget();return i.renderTarget=n,this.fromSceneAsync(t,e,s,r,i),n}Zp=this._renderer.getRenderTarget(),$p=this._renderer.getActiveCubeFace(),Jp=this._renderer.getActiveMipmapLevel();const h=o||this._allocateTarget();return h.depthBuffer=!0,this._init(h),this._sceneToCubeUV(t,s,r,h,a),e>0&&this._blur(h,0,0,e),this._applyPMREM(h),this._cleanup(h),h}async fromSceneAsync(t,e=0,s=.1,r=100,i={}){return!1===this._hasInitialized&&await this._renderer.init(),this.fromScene(t,e,s,r,i)}fromEquirectangular(t,e=null){if(!1===this._hasInitialized){this._setSizeFromTexture(t);const s=e||this._allocateTarget();return this.fromEquirectangularAsync(t,s),s}return this._fromTexture(t,e)}async fromEquirectangularAsync(t,e=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(t,e)}fromCubemap(t,e=null){if(!1===this._hasInitialized){this._setSizeFromTexture(t);const s=e||this._allocateTarget();return this.fromCubemapAsync(t,e),s}return this._fromTexture(t,e)}async fromCubemapAsync(t,e=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(t,e)}async compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=um(),await this._compileMaterial(this._cubemapMaterial))}async compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=cm(),await this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose(),null!==this._backgroundBox&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSizeFromTexture(t){t.mapping===s||t.mapping===r?this._setSize(0===t.image.length?16:t.image[0].width||t.image[0].image.width):this._setSize(t.image.width/4)}_setSize(t){this._lodMax=Math.floor(Math.log2(t)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let t=0;t<this._lodPlanes.length;t++)this._lodPlanes[t].dispose()}_cleanup(t){this._renderer.setRenderTarget(Zp,$p,Jp),t.scissorTest=!1,hm(t,0,0,t.width,t.height)}_fromTexture(t,e){this._setSizeFromTexture(t),Zp=this._renderer.getRenderTarget(),$p=this._renderer.getActiveCubeFace(),Jp=this._renderer.getActiveMipmapLevel();const s=e||this._allocateTarget();return this._init(s),this._textureToCubeUV(t,s),this._applyPMREM(s),this._cleanup(s),s}_allocateTarget(){return om(3*Math.max(this._cubeSize,112),4*this._cubeSize)}_init(t){if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==t.width||this._pingPongRenderTarget.height!==t.height){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=om(t.width,t.height);const{_lodMax:e}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas,lodMeshes:this._lodMeshes}=function(t){const e=[],s=[],r=[],i=[];let n=t;const a=t-4+1+qp.length;for(let o=0;o<a;o++){const a=Math.pow(2,n);s.push(a);let h=1/a;o>t-4?h=qp[o-t+4-1]:0===o&&(h=0),r.push(h);const l=1/(a-2),u=-l,c=1+l,d=[u,u,c,u,c,c,u,u,c,c,u,c],p=6,m=6,g=3,y=2,f=1,x=new Float32Array(g*m*p),b=new Float32Array(y*m*p),v=new Float32Array(f*m*p);for(let t=0;t<p;t++){const e=t%3*2/3-1,s=t>2?0:-1,r=[e,s,0,e+2/3,s,0,e+2/3,s+1,0,e,s,0,e+2/3,s+1,0,e,s+1,0],i=rm[t];x.set(r,g*m*i),b.set(d,y*m*i);const n=[i,i,i,i,i,i];v.set(n,f*m*i)}const N=new ss;N.setAttribute("position",new He(x,g)),N.setAttribute("uv",new He(b,y)),N.setAttribute("faceIndex",new He(v,f)),e.push(N),i.push(new ms(N,null)),n>4&&n--}return{lodPlanes:e,sizeLods:s,sigmas:r,lodMeshes:i}}(e)),this._blurMaterial=function(t,e,s){const r=qh(new Array(Hp).fill(0)),i=En(new j(0,1,0)),n=En(0),a=Ai(Hp),o=En(0),h=En(1),l=Bh(null),u=En(0),c=Ai(1/e),d=Ai(1/s),p=Ai(t),m={n:a,latitudinal:o,weights:r,poleAxis:i,outputDirection:nm,dTheta:n,samples:h,envMap:l,mipInt:u,CUBEUV_TEXEL_WIDTH:c,CUBEUV_TEXEL_HEIGHT:d,CUBEUV_MAX_MIP:p},g=lm("blur");return g.fragmentNode=jp({...m,latitudinal:o.equal(1)}),sm.set(g,m),g}(e,t.width,t.height)}}async _compileMaterial(t){const e=new ms(this._lodPlanes[0],t);await this._renderer.compile(e,Gp)}_sceneToCubeUV(t,e,s,r,i){const n=Xp;n.near=e,n.far=s;const a=[1,1,1,1,-1,1],o=[1,-1,1,-1,1,-1],h=this._renderer,l=h.autoClear;h.getClearColor(Yp),h.autoClear=!1;let u=this._backgroundBox;if(null===u){const t=new Fe({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1});u=new ms(new ys,t)}let c=!1;const d=t.background;d?d.isColor&&(u.material.color.copy(d),t.background=null,c=!0):(u.material.color.copy(Yp),c=!0),h.setRenderTarget(r),h.clear(),c&&h.render(u,n);for(let e=0;e<6;e++){const s=e%3;0===s?(n.up.set(0,a[e],0),n.position.set(i.x,i.y,i.z),n.lookAt(i.x+o[e],i.y,i.z)):1===s?(n.up.set(0,0,a[e]),n.position.set(i.x,i.y,i.z),n.lookAt(i.x,i.y+o[e],i.z)):(n.up.set(0,a[e],0),n.position.set(i.x,i.y,i.z),n.lookAt(i.x,i.y,i.z+o[e]));const l=this._cubeSize;hm(r,s*l,e>2?l:0,l,l),h.render(t,n)}h.autoClear=l,t.background=d}_textureToCubeUV(t,e){const i=this._renderer,n=t.mapping===s||t.mapping===r;n?null===this._cubemapMaterial&&(this._cubemapMaterial=um(t)):null===this._equirectMaterial&&(this._equirectMaterial=cm(t));const a=n?this._cubemapMaterial:this._equirectMaterial;a.fragmentNode.value=t;const o=this._lodMeshes[0];o.material=a;const h=this._cubeSize;hm(e,0,0,3*h,2*h),i.setRenderTarget(e),i.render(o,Gp)}_applyPMREM(t){const e=this._renderer,s=e.autoClear;e.autoClear=!1;const r=this._lodPlanes.length;for(let e=1;e<r;e++){const s=Math.sqrt(this._sigmas[e]*this._sigmas[e]-this._sigmas[e-1]*this._sigmas[e-1]),i=tm[(r-e-1)%tm.length];this._blur(t,e-1,e,s,i)}e.autoClear=s}_blur(t,e,s,r,i){const n=this._pingPongRenderTarget;this._halfBlur(t,n,e,s,r,"latitudinal",i),this._halfBlur(n,t,s,s,r,"longitudinal",i)}_halfBlur(t,e,s,r,i,n,a){const o=this._renderer,h=this._blurMaterial,l=this._lodMeshes[r];l.material=h;const u=sm.get(h),c=this._sizeLods[s]-1,d=isFinite(i)?Math.PI/(2*c):2*Math.PI/39,p=i/d,m=isFinite(i)?1+Math.floor(3*p):Hp,g=[];let y=0;for(let t=0;t<Hp;++t){const e=t/p,s=Math.exp(-e*e/2);g.push(s),0===t?y+=s:t<m&&(y+=2*s)}for(let t=0;t<g.length;t++)g[t]=g[t]/y;t.texture.frame=(t.texture.frame||0)+1,u.envMap.value=t.texture,u.samples.value=m,u.weights.array=g,u.latitudinal.value="latitudinal"===n?1:0,a&&(u.poleAxis.value=a);const{_lodMax:f}=this;u.dTheta.value=d,u.mipInt.value=f-s;const x=this._sizeLods[r];hm(e,3*x*(r>f-4?r-f+4:0),4*(this._cubeSize-x),3*x,2*x),o.setRenderTarget(e),o.render(l,Gp)}}function om(t,e){const s=new dt(t,e,{magFilter:h,minFilter:h,generateMipmaps:!1,type:d,format:p,colorSpace:N});return s.texture.mapping=306,s.texture.name="PMREM.cubeUv",s.texture.isPMREMTexture=!0,s.scissorTest=!0,s}function hm(t,e,s,r,i){t.viewport.set(e,s,r,i),t.scissor.set(e,s,r,i)}function lm(t){const e=new Zd;return e.depthTest=!1,e.depthWrite=!1,e.blending=0,e.name=`PMREM_${t}`,e}function um(t){const e=lm("cubemap");return e.fragmentNode=iu(t,nm),e}function cm(t){const e=lm("equirect");return e.fragmentNode=Bh(t,Qd(nm),0),e}const dm=new WeakMap;function pm(t,e,s){const r=function(t){let e=dm.get(t);void 0===e&&(e=new WeakMap,dm.set(t,e));return e}(e);let i=r.get(t);if((void 0!==i?i.pmremVersion:-1)!==t.pmremVersion){const e=t.image;if(t.isCubeTexture){if(!function(t){if(null==t)return!1;let e=0;const s=6;for(let r=0;r<s;r++)void 0!==t[r]&&e++;return e===s}(e))return null;i=s.fromCubemap(t,i)}else{if(!function(t){return null!=t&&t.height>0}(e))return null;i=s.fromEquirectangular(t,i)}i.pmremVersion=t.pmremVersion,r.set(t,i)}return i.texture}class mm extends Vr{static get type(){return"PMREMNode"}constructor(t,e=null,s=null){super("vec3"),this._value=t,this._pmrem=null,this.uvNode=e,this.levelNode=s,this._generator=null;const r=new ut;r.isRenderTargetTexture=!0,this._texture=Bh(r),this._width=En(0),this._height=En(0),this._maxMip=En(0),this.updateBeforeType=xr.RENDER}set value(t){this._value=t,this._pmrem=null}get value(){return this._value}updateFromTexture(t){const e=function(t){const e=Math.log2(t)-2,s=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,e),112)),texelHeight:s,maxMip:e}}(t.image.height);this._texture.value=t,this._width.value=e.texelWidth,this._height.value=e.texelHeight,this._maxMip.value=e.maxMip}updateBefore(t){let e=this._pmrem;const s=e?e.pmremVersion:-1,r=this._value;s!==r.pmremVersion&&(e=!0===r.isPMREMTexture?r:pm(r,t.renderer,this._generator),null!==e&&(this._pmrem=e,this.updateFromTexture(e)))}setup(t){null===this._generator&&(this._generator=new am(t.renderer)),this.updateBefore(t);let e=this.uvNode;null===e&&t.context.getUV&&(e=t.context.getUV(this)),e=$l.mul(Oi(e.x,e.y.negate(),e.z));let s=this.levelNode;return null===s&&t.context.getTextureLevel&&(s=t.context.getTextureLevel(this)),Dp(this._texture,e,s,this._width,this._height,this._maxMip)}dispose(){super.dispose(),null!==this._generator&&this._generator.dispose()}}const gm=fi(mm).setParameterLength(1,3),ym=Ni(()=>{const t=Oi(Vl.z,0,Vl.x.negate()).normalize(),e=Vl.cross(t);return Ii(t.dot(Bl),e.dot(Bl)).mul(.495).add(.5)}).once(["NORMAL","VERTEX"])().toVar("matcapUV");class fm extends Vr{static get type(){return"RotateNode"}constructor(t,e){super(),this.positionNode=t,this.rotationNode=e}getNodeType(t){return this.positionNode.getNodeType(t)}setup(t){const{rotationNode:e,positionNode:s}=this;if("vec2"===this.getNodeType(t)){const t=e.cos(),r=e.sin();return ji(t,r,r.negate(),t).mul(s)}{const t=e,r=Hi(ki(1,0,0,0),ki(0,La(t.x),Ea(t.x).negate(),0),ki(0,Ea(t.x),La(t.x),0),ki(0,0,0,1)),i=Hi(ki(La(t.y),0,Ea(t.y),0),ki(0,1,0,0),ki(Ea(t.y).negate(),0,La(t.y),0),ki(0,0,0,1)),n=Hi(ki(La(t.z),Ea(t.z).negate(),0,0),ki(Ea(t.z),La(t.z),0,0),ki(0,0,1,0),ki(0,0,0,1));return r.mul(i).mul(n).mul(ki(s,1)).xyz}}}const xm=fi(fm).setParameterLength(2);Zi("vec3"),Zi("vec3"),Zi("vec3");class bm{constructor(){this.weakMap=new WeakMap}get(t){let e=this.weakMap;for(let s=0;s<t.length-1;s++)if(e=e.get(t[s]),void 0===e)return;return e.get(t[t.length-1])}set(t,e){let s=this.weakMap;for(let e=0;e<t.length-1;e++){const r=t[e];!1===s.has(r)&&s.set(r,new WeakMap),s=s.get(r)}return s.set(t[t.length-1],e),this}delete(t){let e=this.weakMap;for(let s=0;s<t.length-1;s++)if(e=e.get(t[s]),void 0===e)return!1;return e.delete(t[t.length-1])}}class vm extends Yi{static get type(){return"ParameterNode"}constructor(t,e=null){super(t,e),this.isParameterNode=!0}getHash(){return this.uuid}generate(){return this.name}}class Nm extends _r{static get type(){return"StackNode"}constructor(t=null){super(),this.nodes=[],this.outputNode=null,this.parent=t,this._currentCond=null,this._expressionNode=null,this.isStackNode=!0}getNodeType(t){return this.outputNode?this.outputNode.getNodeType(t):"void"}getMemberType(t,e){return this.outputNode?this.outputNode.getMemberType(t,e):"void"}add(t){return this.nodes.push(t),this}If(t,e){const s=new di(e);return this._currentCond=Io(t,s),this.add(this._currentCond)}ElseIf(t,e){const s=new di(e),r=Io(t,s);return this._currentCond.elseNode=r,this._currentCond=r,this}Else(t){return this._currentCond.elseNode=new di(t),this}Switch(t){return this._expressionNode=pi(t),this}Case(...t){const e=[];if(!(t.length>=2))throw new Error("TSL: Invalid parameter length. Case() requires at least two parameters.");for(let s=0;s<t.length-1;s++)e.push(this._expressionNode.equal(pi(t[s])));const s=new di(t[t.length-1]);let r=e[0];for(let t=1;t<e.length;t++)r=r.or(e[t]);const i=Io(r,s);return null===this._currentCond?(this._currentCond=i,this.add(this._currentCond)):(this._currentCond.elseNode=i,this._currentCond=i,this)}Default(t){return this.Else(t),this}setup(t){const e=t.getNodeProperties(this);let s=0;for(const r of this.getChildren()){if(r.isVarNode&&!0===r.intent){if(!0!==t.getNodeProperties(r).assign)continue}e["node"+s++]=r}return e.outputNode||null}build(t,...e){const s=t.currentStack,r=Ti();wi(this),t.currentStack=this;const i=t.buildStage;for(const e of this.nodes){if(e.isVarNode&&!0===e.intent){if(!0!==t.getNodeProperties(e).assign)continue}if("setup"===i)e.build(t);else if("analyze"===i)e.build(t,this);else if("generate"===i){const s=t.getDataFromNode(e,"any").stages,r=s&&s[t.shaderStage];if(e.isVarNode&&r&&1===r.length&&r[0]&&r[0].isStackNode)continue;e.build(t,"void")}}const n=this.outputNode?this.outputNode.build(t,...e):super.build(t,...e);return wi(r),t.currentStack=s,n}}const wm=fi(Nm).setParameterLength(0,1);class Tm extends _r{static get type(){return"StructTypeNode"}constructor(t,e=null){var s;super("struct"),this.membersLayout=(s=t,Object.entries(s).map(([t,e])=>"string"==typeof e?{name:t,type:e,atomic:!1}:{name:t,type:e.type,atomic:e.atomic||!1})),this.name=e,this.isStructLayoutNode=!0}getLength(){const t=Float32Array.BYTES_PER_ELEMENT;let e=0;for(const s of this.membersLayout){const r=s.type,i=ur(r)*t,n=e%8,a=n%cr(r),o=n+a;e+=a,0!==o&&8-o<i&&(e+=8-o),e+=i}return 8*Math.ceil(e/8)/t}getMemberType(t,e){const s=this.membersLayout.find(t=>t.name===e);return s?s.type:"void"}getNodeType(t){return t.getStructTypeFromNode(this,this.membersLayout,this.name).name}setup(t){t.addInclude(this)}generate(t){return this.getNodeType(t)}}class Mm extends _r{static get type(){return"StructNode"}constructor(t,e){super("vec3"),this.structLayoutNode=t,this.values=e,this.isStructNode=!0}getNodeType(t){return this.structLayoutNode.getNodeType(t)}getMemberType(t,e){return this.structLayoutNode.getMemberType(t,e)}generate(t){const e=t.getVarFromNode(this),s=e.type,r=t.getPropertyName(e);return t.addLineFlowCode(`${r} = ${t.generateStruct(s,this.structLayoutNode.membersLayout,this.values)}`,this),e.name}}class _m extends _r{static get type(){return"OutputStructNode"}constructor(...t){super(),this.members=t,this.isOutputStructNode=!0}getNodeType(t){const e=t.getNodeProperties(this);if(void 0===e.membersLayout){const s=this.members,r=[];for(let e=0;e<s.length;e++){const i="m"+e,n=s[e].getNodeType(t);r.push({name:i,type:n,index:e})}e.membersLayout=r,e.structType=t.getOutputStructTypeFromNode(this,e.membersLayout)}return e.structType.name}generate(t){const e=t.getOutputStructName(),s=this.members,r=""!==e?e+".":"";for(let e=0;e<s.length;e++){const i=s[e].build(t);t.addLineFlowCode(`${r}m${e} = ${i}`,this)}return e}}const Sm=fi(_m);function Am(t,e){for(let s=0;s<t.length;s++)if(t[s].name===e)return s;return-1}class Vm extends _m{static get type(){return"MRTNode"}constructor(t){super(),this.outputNodes=t,this.isMRTNode=!0}has(t){return void 0!==this.outputNodes[t]}get(t){return this.outputNodes[t]}merge(t){const e={...this.outputNodes,...t.outputNodes};return zm(e)}setup(t){const e=this.outputNodes,s=[],r=t.renderer.getRenderTarget().textures;for(const t in e){s[Am(r,t)]=ki(e[t])}return this.members=s,super.setup(t)}}const zm=fi(Vm),Cm=Ni(([t])=>{const e=t.toUint().mul(747796405).add(2891336453),s=e.shiftRight(e.shiftRight(28).add(4)).bitXor(e).mul(277803737);return s.shiftRight(22).bitXor(s).toFloat().mul(1/2**32)}),Im=(t,e)=>lo(qn(4,t.mul(jn(1,t))),e),Rm=Ni(([t])=>t.fract().sub(.5).abs()).setLayout({name:"tri",type:"float",inputs:[{name:"x",type:"float"}]}),Em=Ni(([t])=>Oi(Rm(t.z.add(Rm(t.y.mul(1)))),Rm(t.z.add(Rm(t.x.mul(1)))),Rm(t.y.add(Rm(t.x.mul(1)))))).setLayout({name:"tri3",type:"vec3",inputs:[{name:"p",type:"vec3"}]}),Lm=Ni(([t,e,s])=>{const r=Oi(t).toVar(),i=Ai(1.4).toVar(),n=Ai(0).toVar(),a=Oi(r).toVar();return Jc({start:Ai(0),end:Ai(3),type:"float",condition:"<="},()=>{const t=Oi(Em(a.mul(2))).toVar();r.addAssign(t.add(s.mul(Ai(.1).mul(e)))),a.mulAssign(1.8),i.mulAssign(1.5),r.mulAssign(1.2);const o=Ai(Rm(r.z.add(Rm(r.x.add(Rm(r.y)))))).toVar();n.addAssign(o.div(i)),a.addAssign(.14)}),n}).setLayout({name:"triNoise3D",type:"float",inputs:[{name:"position",type:"vec3"},{name:"speed",type:"float"},{name:"time",type:"float"}]});class Om extends _r{static get type(){return"FunctionOverloadingNode"}constructor(t=[],...e){super(),this.functionNodes=t,this.parametersNodes=e,this._candidateFnCall=null,this.global=!0}getNodeType(){return this.functionNodes[0].shaderNode.layout.type}setup(t){const e=this.parametersNodes;let s=this._candidateFnCall;if(null===s){let r=null,i=-1;for(const s of this.functionNodes){const n=s.shaderNode.layout;if(null===n)throw new Error("FunctionOverloadingNode: FunctionNode must be a layout.");const a=n.inputs;if(e.length===a.length){let n=0;for(let s=0;s<e.length;s++){const r=e[s],i=a[s];r.getNodeType(t)===i.type?n++:n=0}n>i&&(r=s,i=n)}}this._candidateFnCall=s=r(...e)}return s}}const Pm=fi(Om),Fm=t=>(...e)=>Pm(t,...e),Bm=En(0).setGroup(Cn).onRenderUpdate(t=>t.time),km=En(0).setGroup(Cn).onRenderUpdate(t=>t.deltaTime),Dm=En(0,"uint").setGroup(Cn).onRenderUpdate(t=>t.frameId),Um=Ni(([t,e,s=Ii(.5)])=>xm(t.sub(s),e).add(s)),Wm=Ni(([t,e,s=Ii(.5)])=>{const r=t.sub(s),i=r.dot(r),n=i.mul(i).mul(e);return t.add(r.mul(n))}),jm=Ni(({position:t=null,horizontal:e=!0,vertical:s=!1})=>{let r;null!==t?(r=cl.toVar(),r[3][0]=t.x,r[3][1]=t.y,r[3][2]=t.z):r=cl;const i=Jh.mul(r);return ui(e)&&(i[0][0]=cl[0].length(),i[0][1]=0,i[0][2]=0),ui(s)&&(i[1][0]=0,i[1][1]=cl[1].length(),i[1][2]=0),i[2][0]=0,i[2][1]=0,i[2][2]=1,Zh.mul(i).mul(Tl)}),qm=Ni(([t=null])=>{const e=Ld();return Ld(Sd(t)).sub(e).lessThan(0).select(dd,t)});class Hm extends _r{static get type(){return"SpriteSheetUVNode"}constructor(t,e=Ch(),s=Ai(0)){super("vec2"),this.countNode=t,this.uvNode=e,this.frameNode=s}setup(){const{frameNode:t,uvNode:e,countNode:s}=this,{width:r,height:i}=s,n=t.mod(r.mul(i)).floor(),a=n.mod(r),o=i.sub(n.add(1).div(r).ceil()),h=s.reciprocal(),l=Ii(a,o);return e.add(l).mul(h)}}const Gm=fi(Hm).setParameterLength(3),Xm=Ni(([t,e=null,s=null,r=Ai(1),i=Tl,n=Ll])=>{let a=n.abs().normalize();a=a.div(a.dot(Oi(1)));const o=i.yz.mul(r),h=i.zx.mul(r),l=i.xy.mul(r),u=t.value,c=null!==e?e.value:u,d=null!==s?s.value:u,p=Bh(u,o).mul(a.x),m=Bh(c,h).mul(a.y),g=Bh(d,l).mul(a.z);return Wn(p,m,g)}),Ym=new Cs,Zm=new j,$m=new j,Jm=new j,Km=new Ut,Qm=new j(0,0,-1),tg=new ct,eg=new j,sg=new j,rg=new ct,ig=new U,ng=new dt,ag=dd.flipX();ng.depthTexture=new Rs(1,1);let og=!1;class hg extends Ph{static get type(){return"ReflectorNode"}constructor(t={}){super(t.defaultTexture||ng.texture,ag),this._reflectorBaseNode=t.reflector||new lg(this,t),this._depthNode=null,this.setUpdateMatrix(!1)}get reflector(){return this._reflectorBaseNode}get target(){return this._reflectorBaseNode.target}getDepthNode(){if(null===this._depthNode){if(!0!==this._reflectorBaseNode.depth)throw new Error("THREE.ReflectorNode: Depth node can only be requested when the reflector is created with { depth: true }. ");this._depthNode=pi(new hg({defaultTexture:ng.depthTexture,reflector:this._reflectorBaseNode}))}return this._depthNode}setup(t){return t.object.isQuadMesh||this._reflectorBaseNode.build(t),super.setup(t)}clone(){const t=new this.constructor(this.reflectorNode);return t.uvNode=this.uvNode,t.levelNode=this.levelNode,t.biasNode=this.biasNode,t.sampler=this.sampler,t.depthNode=this.depthNode,t.compareNode=this.compareNode,t.gradNode=this.gradNode,t._reflectorBaseNode=this._reflectorBaseNode,t}dispose(){super.dispose(),this._reflectorBaseNode.dispose()}}class lg extends _r{static get type(){return"ReflectorBaseNode"}constructor(t,e={}){super();const{target:s=new me,resolution:r=1,generateMipmaps:i=!1,bounces:n=!0,depth:a=!1}=e;this.textureNode=t,this.target=s,this.resolution=r,this.generateMipmaps=i,this.bounces=n,this.depth=a,this.updateBeforeType=n?xr.RENDER:xr.FRAME,this.virtualCameras=new WeakMap,this.renderTargets=new Map,this.forceUpdate=!1,this.hasOutput=!1}_updateResolution(t,e){const s=this.resolution;e.getDrawingBufferSize(ig),t.setSize(Math.round(ig.width*s),Math.round(ig.height*s))}setup(t){return this._updateResolution(ng,t.renderer),super.setup(t)}dispose(){super.dispose();for(const t of this.renderTargets.values())t.dispose()}getVirtualCamera(t){let e=this.virtualCameras.get(t);return void 0===e&&(e=t.clone(),this.virtualCameras.set(t,e)),e}getRenderTarget(t){let e=this.renderTargets.get(t);return void 0===e&&(e=new dt(0,0,{type:d}),!0===this.generateMipmaps&&(e.texture.minFilter=1008,e.texture.generateMipmaps=!0),!0===this.depth&&(e.depthTexture=new Rs),this.renderTargets.set(t,e)),e}updateBefore(t){if(!1===this.bounces&&og)return!1;og=!0;const{scene:e,camera:s,renderer:r,material:i}=t,{target:n}=this,a=this.getVirtualCamera(s),o=this.getRenderTarget(a);r.getDrawingBufferSize(ig),this._updateResolution(o,r),$m.setFromMatrixPosition(n.matrixWorld),Jm.setFromMatrixPosition(s.matrixWorld),Km.extractRotation(n.matrixWorld),Zm.set(0,0,1),Zm.applyMatrix4(Km),eg.subVectors($m,Jm);let h=!1;if(!0===eg.dot(Zm)>0&&!1===this.forceUpdate){if(!1===this.hasOutput)return void(og=!1);h=!0}eg.reflect(Zm).negate(),eg.add($m),Km.extractRotation(s.matrixWorld),Qm.set(0,0,-1),Qm.applyMatrix4(Km),Qm.add(Jm),sg.subVectors($m,Qm),sg.reflect(Zm).negate(),sg.add($m),a.coordinateSystem=s.coordinateSystem,a.position.copy(eg),a.up.set(0,1,0),a.up.applyMatrix4(Km),a.up.reflect(Zm),a.lookAt(sg),a.near=s.near,a.far=s.far,a.updateMatrixWorld(),a.projectionMatrix.copy(s.projectionMatrix),Ym.setFromNormalAndCoplanarPoint(Zm,$m),Ym.applyMatrix4(a.matrixWorldInverse),tg.set(Ym.normal.x,Ym.normal.y,Ym.normal.z,Ym.constant);const l=a.projectionMatrix;rg.x=(Math.sign(tg.x)+l.elements[8])/l.elements[0],rg.y=(Math.sign(tg.y)+l.elements[9])/l.elements[5],rg.z=-1,rg.w=(1+l.elements[10])/l.elements[14],tg.multiplyScalar(1/tg.dot(rg));l.elements[2]=tg.x,l.elements[6]=tg.y,l.elements[10]=r.coordinateSystem===V?tg.z-0:tg.z+1-0,l.elements[14]=tg.w,this.textureNode.value=o.texture,!0===this.depth&&(this.textureNode.getDepthNode().value=o.depthTexture),i.visible=!1;const u=r.getRenderTarget(),c=r.getMRT(),d=r.autoClear;r.setMRT(null),r.setRenderTarget(o),r.autoClear=!0,h?(r.clear(),this.hasOutput=!1):(r.render(e,a),this.hasOutput=!0),r.setMRT(c),r.setRenderTarget(u),r.autoClear=d,i.visible=!0,og=!1,this.forceUpdate=!1}}const ug=new Zs(-1,1,1,-1,0,1);class cg extends ss{constructor(t=!1){super();const e=!1===t?[0,-1,0,1,2,1]:[0,2,0,0,2,0];this.setAttribute("position",new Ye([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Ye(e,2))}}const dg=new cg;class pg extends ms{constructor(t=null){super(dg,t),this.camera=ug,this.isQuadMesh=!0}async renderAsync(t){return t.renderAsync(this,ug)}render(t){t.render(this,ug)}}const mg=new U;class gg extends Ph{static get type(){return"RTTNode"}constructor(t,e=null,s=null,r={type:d}){const i=new dt(e,s,r);super(i.texture,Ch()),this.isRTTNode=!0,this.node=t,this.width=e,this.height=s,this.pixelRatio=1,this.renderTarget=i,this.textureNeedsUpdate=!0,this.autoUpdate=!0,this._rttNode=null,this._quadMesh=new pg(new Zd),this.updateBeforeType=xr.RENDER}get autoResize(){return null===this.width}setup(t){return this._rttNode=this.node.context(t.getSharedContext()),this._quadMesh.material.name="RTT",this._quadMesh.material.needsUpdate=!0,super.setup(t)}setSize(t,e){this.width=t,this.height=e;const s=t*this.pixelRatio,r=e*this.pixelRatio;this.renderTarget.setSize(s,r),this.textureNeedsUpdate=!0}setPixelRatio(t){this.pixelRatio=t,this.setSize(this.width,this.height)}updateBefore({renderer:t}){if(!1===this.textureNeedsUpdate&&!1===this.autoUpdate)return;if(this.textureNeedsUpdate=!1,!0===this.autoResize){const e=t.getPixelRatio(),s=t.getSize(mg),r=s.width*e,i=s.height*e;r===this.renderTarget.width&&i===this.renderTarget.height||(this.renderTarget.setSize(r,i),this.textureNeedsUpdate=!0)}this._quadMesh.material.fragmentNode=this._rttNode;const e=t.getRenderTarget();t.setRenderTarget(this.renderTarget),this._quadMesh.render(t),t.setRenderTarget(e)}clone(){const t=new Ph(this.value,this.uvNode,this.levelNode);return t.sampler=this.sampler,t.referenceNode=this,t}}const yg=(t,...e)=>pi(new gg(pi(t),...e)),fg=Ni(([t,e,s],r)=>{let i;r.renderer.coordinateSystem===V?(t=Ii(t.x,t.y.oneMinus()).mul(2).sub(1),i=ki(Oi(t,e),1)):i=ki(Oi(t.x,t.y.oneMinus(),e).mul(2).sub(1),1);const n=ki(s.mul(i));return n.xyz.div(n.w)}),xg=Ni(([t,e])=>{const s=e.mul(ki(t,1)),r=s.xy.div(s.w).mul(.5).add(.5).toVar();return Ii(r.x,r.y.oneMinus())}),bg=Ni(([t,e,s])=>{const r=Rh(kh(e)),i=Ri(t.mul(r)).toVar(),n=kh(e,i).toVar(),a=kh(e,i.sub(Ri(2,0))).toVar(),o=kh(e,i.sub(Ri(1,0))).toVar(),h=kh(e,i.add(Ri(1,0))).toVar(),l=kh(e,i.add(Ri(2,0))).toVar(),u=kh(e,i.add(Ri(0,2))).toVar(),c=kh(e,i.add(Ri(0,1))).toVar(),d=kh(e,i.sub(Ri(0,1))).toVar(),p=kh(e,i.sub(Ri(0,2))).toVar(),m=ka(jn(Ai(2).mul(o).sub(a),n)).toVar(),g=ka(jn(Ai(2).mul(h).sub(l),n)).toVar(),y=ka(jn(Ai(2).mul(c).sub(u),n)).toVar(),f=ka(jn(Ai(2).mul(d).sub(p),n)).toVar(),x=fg(t,n,s).toVar(),b=m.lessThan(g).select(x.sub(fg(t.sub(Ii(Ai(1).div(r.x),0)),o,s)),x.negate().add(fg(t.add(Ii(Ai(1).div(r.x),0)),h,s))),v=y.lessThan(f).select(x.sub(fg(t.add(Ii(0,Ai(1).div(r.y))),c,s)),x.negate().add(fg(t.sub(Ii(0,Ai(1).div(r.y))),d,s)));return Ia(ho(b,v))});class vg extends _r{static get type(){return"SampleNode"}constructor(t){super(),this.callback=t,this.isSampleNode=!0}setup(){return this.sample(Ch())}sample(t){return this.callback(t)}}class Ng extends _r{static get type(){return"EventNode"}constructor(t,e){super("void"),this.eventType=t,this.callback=e,t===Ng.OBJECT?this.updateType=xr.OBJECT:t===Ng.MATERIAL&&(this.updateType=xr.RENDER)}update(t){this.callback(t)}}Ng.OBJECT="object",Ng.MATERIAL="material";const wg=(t,e)=>pi(new Ng(t,e)).toStack();class Tg extends Ss{constructor(t,e,s=Float32Array){super(ArrayBuffer.isView(t)?t:new s(t*e),e),this.isStorageInstancedBufferAttribute=!0}}class Mg extends He{constructor(t,e,s=Float32Array){super(ArrayBuffer.isView(t)?t:new s(t*e),e),this.isStorageBufferAttribute=!0}}class _g extends _r{static get type(){return"PointUVNode"}constructor(){super("vec2"),this.isPointUVNode=!0}generate(){return"vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y )"}}const Sg=xi(_g),Ag=new Jt,Vg=new Ut;class zg extends _r{static get type(){return"SceneNode"}constructor(t=zg.BACKGROUND_BLURRINESS,e=null){super(),this.scope=t,this.scene=e}setup(t){const s=this.scope,r=null!==this.scene?this.scene:t.scene;let i;return s===zg.BACKGROUND_BLURRINESS?i=ou("backgroundBlurriness","float",r):s===zg.BACKGROUND_INTENSITY?i=ou("backgroundIntensity","float",r):s===zg.BACKGROUND_ROTATION&&(i=En("mat4").setName("backgroundRotation").setGroup(Cn).onRenderUpdate(()=>{const t=r.background;return null!==t&&t.isTexture&&t.mapping!==e?(Ag.copy(r.backgroundRotation),Ag.x*=-1,Ag.y*=-1,Ag.z*=-1,Vg.makeRotationFromEuler(Ag)):Vg.identity(),Vg})),i}}zg.BACKGROUND_BLURRINESS="backgroundBlurriness",zg.BACKGROUND_INTENSITY="backgroundIntensity",zg.BACKGROUND_ROTATION="backgroundRotation";const Cg=xi(zg,zg.BACKGROUND_BLURRINESS),Ig=xi(zg,zg.BACKGROUND_INTENSITY),Rg=xi(zg,zg.BACKGROUND_ROTATION);class Eg extends Ph{static get type(){return"StorageTextureNode"}constructor(t,e,s=null){super(t,e),this.storeNode=s,this.isStorageTextureNode=!0,this.access=br.WRITE_ONLY}getInputType(){return"storageTexture"}setup(t){super.setup(t);const e=t.getNodeProperties(this);return e.storeNode=this.storeNode,e}setAccess(t){return this.access=t,this}generate(t,e){let s;return s=null!==this.storeNode?this.generateStore(t):super.generate(t,e),s}toReadWrite(){return this.setAccess(br.READ_WRITE)}toReadOnly(){return this.setAccess(br.READ_ONLY)}toWriteOnly(){return this.setAccess(br.WRITE_ONLY)}generateStore(t){const e=t.getNodeProperties(this),{uvNode:s,storeNode:r,depthNode:i}=e,n=super.generate(t,"property"),a=s.build(t,!0===this.value.is3DTexture?"uvec3":"uvec2"),o=r.build(t,"vec4"),h=i?i.build(t,"int"):null,l=t.generateTextureStore(t,n,a,h,o);t.addLineFlowCode(l,this)}clone(){const t=super.clone();return t.storeNode=this.storeNode,t}}const Lg=fi(Eg).setParameterLength(1,3),Og=Ni(({texture:t,uv:e})=>{const s=1e-4,r=Oi().toVar();return Mi(e.x.lessThan(s),()=>{r.assign(Oi(1,0,0))}).ElseIf(e.y.lessThan(s),()=>{r.assign(Oi(0,1,0))}).ElseIf(e.z.lessThan(s),()=>{r.assign(Oi(0,0,1))}).ElseIf(e.x.greaterThan(.9999),()=>{r.assign(Oi(-1,0,0))}).ElseIf(e.y.greaterThan(.9999),()=>{r.assign(Oi(0,-1,0))}).ElseIf(e.z.greaterThan(.9999),()=>{r.assign(Oi(0,0,-1))}).Else(()=>{const s=.01,i=t.sample(e.add(Oi(-.01,0,0))).r.sub(t.sample(e.add(Oi(s,0,0))).r),n=t.sample(e.add(Oi(0,-.01,0))).r.sub(t.sample(e.add(Oi(0,s,0))).r),a=t.sample(e.add(Oi(0,0,-.01))).r.sub(t.sample(e.add(Oi(0,0,s))).r);r.assign(Oi(i,n,a))}),r.normalize()});class Pg extends Ph{static get type(){return"Texture3DNode"}constructor(t,e=null,s=null){super(t,e,s),this.isTexture3DNode=!0}getInputType(){return"texture3D"}getDefaultUV(){return Oi(.5,.5,.5)}setUpdateMatrix(){}setupUV(t,e){const s=this.value;return!t.isFlipY()||!0!==s.isRenderTargetTexture&&!0!==s.isFramebufferTexture||(e=this.sampler?e.flipY():e.setY(Vi(Rh(this,this.levelNode).y).sub(e.y).sub(1))),e}generateUV(t,e){return e.build(t,"vec3")}normal(t){return Og({texture:this,uv:t})}}const Fg=fi(Pg).setParameterLength(1,3);class Bg extends au{static get type(){return"UserDataNode"}constructor(t,e,s=null){super(t,e,s),this.userData=s}updateReference(t){return this.reference=null!==this.userData?this.userData:t.object.userData,this.reference}}const kg=new WeakMap;class Dg extends Vr{static get type(){return"VelocityNode"}constructor(){super("vec2"),this.projectionMatrix=null,this.updateType=xr.OBJECT,this.updateAfterType=xr.OBJECT,this.previousModelWorldMatrix=En(new Ut),this.previousProjectionMatrix=En(new Ut).setGroup(Cn),this.previousCameraViewMatrix=En(new Ut)}setProjectionMatrix(t){this.projectionMatrix=t}update({frameId:t,camera:e,object:s}){const r=Wg(s);this.previousModelWorldMatrix.value.copy(r);const i=Ug(e);i.frameId!==t&&(i.frameId=t,void 0===i.previousProjectionMatrix?(i.previousProjectionMatrix=new Ut,i.previousCameraViewMatrix=new Ut,i.currentProjectionMatrix=new Ut,i.currentCameraViewMatrix=new Ut,i.previousProjectionMatrix.copy(this.projectionMatrix||e.projectionMatrix),i.previousCameraViewMatrix.copy(e.matrixWorldInverse)):(i.previousProjectionMatrix.copy(i.currentProjectionMatrix),i.previousCameraViewMatrix.copy(i.currentCameraViewMatrix)),i.currentProjectionMatrix.copy(this.projectionMatrix||e.projectionMatrix),i.currentCameraViewMatrix.copy(e.matrixWorldInverse),this.previousProjectionMatrix.value.copy(i.previousProjectionMatrix),this.previousCameraViewMatrix.value.copy(i.previousCameraViewMatrix))}updateAfter({object:t}){Wg(t).copy(t.matrixWorld)}setup(){const t=null===this.projectionMatrix?Zh:En(this.projectionMatrix),e=this.previousCameraViewMatrix.mul(this.previousModelWorldMatrix),s=t.mul(xl).mul(Tl),r=this.previousProjectionMatrix.mul(e).mul(Ml),i=s.xy.div(s.w),n=r.xy.div(r.w);return jn(i,n)}}function Ug(t){let e=kg.get(t);return void 0===e&&(e={},kg.set(t,e)),e}function Wg(t,e=0){const s=Ug(t);let r=s[e];return void 0===r&&(s[e]=r=new Ut,s[e].copy(t.matrixWorld)),r}const jg=xi(Dg),qg=Ni(([t])=>Yg(t.rgb)),Hg=Ni(([t,e=Ai(1)])=>e.mix(Yg(t.rgb),t.rgb)),Gg=Ni(([t,e=Ai(1)])=>{const s=Wn(t.r,t.g,t.b).div(3),r=t.r.max(t.g.max(t.b)),i=r.sub(s).mul(e).mul(-3);return fo(t.rgb,r,i)}),Xg=Ni(([t,e=Ai(1)])=>{const s=Oi(.57735,.57735,.57735),r=e.cos();return Oi(t.rgb.mul(r).add(s.cross(t.rgb).mul(e.sin()).add(s.mul(oo(s,t.rgb).mul(r.oneMinus())))))}),Yg=(t,e=Oi(tt.getLuminanceCoefficients(new j)))=>oo(t,e),Zg=Ni(([t,e=Oi(1),s=Oi(0),r=Oi(1),i=Ai(1),n=Oi(tt.getLuminanceCoefficients(new j,N))])=>{const a=t.rgb.dot(Oi(n)),o=so(t.rgb.mul(e).add(s),0).toVar(),h=o.pow(r).toVar();return Mi(o.r.greaterThan(0),()=>{o.r.assign(h.r)}),Mi(o.g.greaterThan(0),()=>{o.g.assign(h.g)}),Mi(o.b.greaterThan(0),()=>{o.b.assign(h.b)}),o.assign(a.add(o.sub(a).mul(i))),ki(o.rgb,t.a)});class $g extends Vr{static get type(){return"PosterizeNode"}constructor(t,e){super(),this.sourceNode=t,this.stepsNode=e}setup(){const{sourceNode:t,stepsNode:e}=this;return t.mul(e).floor().div(e)}}const Jg=fi($g).setParameterLength(2),Kg=new U;class Qg extends Ph{static get type(){return"PassTextureNode"}constructor(t,e){super(e),this.passNode=t,this.setUpdateMatrix(!1)}setup(t){return this.passNode.build(t),super.setup(t)}clone(){return new this.constructor(this.passNode,this.value)}}class ty extends Qg{static get type(){return"PassMultipleTextureNode"}constructor(t,e,s=!1){super(t,null),this.textureName=e,this.previousTexture=s}updateTexture(){this.value=this.previousTexture?this.passNode.getPreviousTexture(this.textureName):this.passNode.getTexture(this.textureName)}setup(t){return this.updateTexture(),super.setup(t)}clone(){const t=new this.constructor(this.passNode,this.textureName,this.previousTexture);return t.uvNode=this.uvNode,t.levelNode=this.levelNode,t.biasNode=this.biasNode,t.sampler=this.sampler,t.depthNode=this.depthNode,t.compareNode=this.compareNode,t.gradNode=this.gradNode,t}}class ey extends Vr{static get type(){return"PassNode"}constructor(t,e,s,r={}){super("vec4"),this.scope=t,this.scene=e,this.camera=s,this.options=r,this._pixelRatio=1,this._width=1,this._height=1;const i=new Rs;i.isRenderTargetTexture=!0,i.name="depth";const n=new dt(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:d,...r});n.texture.name="output",n.depthTexture=i,this.renderTarget=n,this._textures={output:n.texture,depth:i},this._textureNodes={},this._linearDepthNodes={},this._viewZNodes={},this._previousTextures={},this._previousTextureNodes={},this._cameraNear=En(0),this._cameraFar=En(0),this._mrt=null,this._layers=null,this._resolution=1,this._viewport=null,this._scissor=null,this.isPassNode=!0,this.updateBeforeType=xr.FRAME,this.global=!0}setResolution(t){return this._resolution=t,this}getResolution(){return this._resolution}setLayers(t){return this._layers=t,this}getLayers(){return this._layers}setMRT(t){return this._mrt=t,this}getMRT(){return this._mrt}getTexture(t){let e=this._textures[t];if(void 0===e){e=this.renderTarget.texture.clone(),e.name=t,this._textures[t]=e,this.renderTarget.textures.push(e)}return e}getPreviousTexture(t){let e=this._previousTextures[t];return void 0===e&&(e=this.getTexture(t).clone(),this._previousTextures[t]=e),e}toggleTexture(t){const e=this._previousTextures[t];if(void 0!==e){const s=this._textures[t],r=this.renderTarget.textures.indexOf(s);this.renderTarget.textures[r]=e,this._textures[t]=e,this._previousTextures[t]=s,this._textureNodes[t].updateTexture(),this._previousTextureNodes[t].updateTexture()}}getTextureNode(t="output"){let e=this._textureNodes[t];return void 0===e&&(e=pi(new ty(this,t)),e.updateTexture(),this._textureNodes[t]=e),e}getPreviousTextureNode(t="output"){let e=this._previousTextureNodes[t];return void 0===e&&(void 0===this._textureNodes[t]&&this.getTextureNode(t),e=pi(new ty(this,t,!0)),e.updateTexture(),this._previousTextureNodes[t]=e),e}getViewZNode(t="depth"){let e=this._viewZNodes[t];if(void 0===e){const s=this._cameraNear,r=this._cameraFar;this._viewZNodes[t]=e=Cd(this.getTextureNode(t),s,r)}return e}getLinearDepthNode(t="depth"){let e=this._linearDepthNodes[t];if(void 0===e){const s=this._cameraNear,r=this._cameraFar,i=this.getViewZNode(t);this._linearDepthNodes[t]=e=Vd(i,s,r)}return e}async compileAsync(t){const e=t.getRenderTarget(),s=t.getMRT();t.setRenderTarget(this.renderTarget),t.setMRT(this._mrt),await t.compileAsync(this.scene,this.camera),t.setRenderTarget(e),t.setMRT(s)}setup({renderer:t}){return this.renderTarget.samples=void 0===this.options.samples?t.samples:this.options.samples,this.renderTarget.texture.type=t.getColorBufferType(),this.scope===ey.COLOR?this.getTextureNode():this.getLinearDepthNode()}updateBefore(t){const{renderer:e}=t,{scene:s}=this;let r,i;const n=e.getOutputRenderTarget();n&&!0===n.isXRRenderTarget?(i=1,r=e.xr.getCamera(),e.xr.updateCamera(r),Kg.set(n.width,n.height)):(r=this.camera,i=e.getPixelRatio(),e.getSize(Kg)),this._pixelRatio=i,this.setSize(Kg.width,Kg.height);const a=e.getRenderTarget(),o=e.getMRT(),h=r.layers.mask;this._cameraNear.value=r.near,this._cameraFar.value=r.far,null!==this._layers&&(r.layers.mask=this._layers.mask);for(const t in this._previousTextures)this.toggleTexture(t);e.setRenderTarget(this.renderTarget),e.setMRT(this._mrt),e.render(s,r),e.setRenderTarget(a),e.setMRT(o),r.layers.mask=h}setSize(t,e){this._width=t,this._height=e;const s=this._width*this._pixelRatio*this._resolution,r=this._height*this._pixelRatio*this._resolution;this.renderTarget.setSize(s,r),null!==this._scissor&&this.renderTarget.scissor.copy(this._scissor),null!==this._viewport&&this.renderTarget.viewport.copy(this._viewport)}setScissor(t,e,s,r){null===t?this._scissor=null:(null===this._scissor&&(this._scissor=new ct),t.isVector4?this._scissor.copy(t):this._scissor.set(t,e,s,r),this._scissor.multiplyScalar(this._pixelRatio*this._resolution).floor())}setViewport(t,e,s,r){null===t?this._viewport=null:(null===this._viewport&&(this._viewport=new ct),t.isVector4?this._viewport.copy(t):this._viewport.set(t,e,s,r),this._viewport.multiplyScalar(this._pixelRatio*this._resolution).floor())}setPixelRatio(t){this._pixelRatio=t,this.setSize(this._width,this._height)}dispose(){this.renderTarget.dispose()}}ey.COLOR="color",ey.DEPTH="depth";class sy extends ey{static get type(){return"ToonOutlinePassNode"}constructor(t,e,s,r,i){super(ey.COLOR,t,e),this.colorNode=s,this.thicknessNode=r,this.alphaNode=i,this._materialCache=new WeakMap}updateBefore(t){const{renderer:e}=t,s=e.getRenderObjectFunction();e.setRenderObjectFunction((t,s,r,i,n,a,o,h)=>{if((n.isMeshToonMaterial||n.isMeshToonNodeMaterial)&&!1===n.wireframe){const l=this._getOutlineMaterial(n);e.renderObject(t,s,r,i,l,a,o,h)}e.renderObject(t,s,r,i,n,a,o,h)}),super.updateBefore(t),e.setRenderObjectFunction(s)}_createMaterial(){const t=new Zd;t.isMeshToonOutlineMaterial=!0,t.name="Toon_Outline",t.side=1;const e=Ll.negate(),s=Zh.mul(xl),r=Ai(1),i=s.mul(ki(Tl,1)),n=s.mul(ki(Tl.add(e),1)),a=Ia(i.sub(n));return t.vertexNode=i.add(a.mul(this.thicknessNode).mul(i.w).mul(r)),t.colorNode=ki(this.colorNode,this.alphaNode),t}_getOutlineMaterial(t){let e=this._materialCache.get(t);return void 0===e&&(e=this._createMaterial(),this._materialCache.set(t,e)),e}}const ry=Ni(([t,e])=>t.mul(e).clamp()).setLayout({name:"linearToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),iy=Ni(([t,e])=>(t=t.mul(e)).div(t.add(1)).clamp()).setLayout({name:"reinhardToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),ny=Ni(([t,e])=>{const s=(t=(t=t.mul(e)).sub(.004).max(0)).mul(t.mul(6.2).add(.5)),r=t.mul(t.mul(6.2).add(1.7)).add(.06);return s.div(r).pow(2.2)}).setLayout({name:"cineonToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),ay=Ni(([t])=>{const e=t.mul(t.add(.0245786)).sub(90537e-9),s=t.mul(t.add(.432951).mul(.983729)).add(.238081);return e.div(s)}),oy=Ni(([t,e])=>{const s=qi(.59719,.35458,.04823,.076,.90834,.01566,.0284,.13383,.83777),r=qi(1.60475,-.53108,-.07367,-.10208,1.10813,-.00605,-.00327,-.07276,1.07602);return t=t.mul(e).div(.6),t=s.mul(t),t=ay(t),(t=r.mul(t)).clamp()}).setLayout({name:"acesFilmicToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),hy=qi(Oi(1.6605,-.1246,-.0182),Oi(-.5876,1.1329,-.1006),Oi(-.0728,-.0083,1.1187)),ly=qi(Oi(.6274,.0691,.0164),Oi(.3293,.9195,.088),Oi(.0433,.0113,.8956)),uy=Ni(([t])=>{const e=Oi(t).toVar(),s=Oi(e.mul(e)).toVar(),r=Oi(s.mul(s)).toVar();return Ai(15.5).mul(r.mul(s)).sub(qn(40.14,r.mul(e))).add(qn(31.96,r).sub(qn(6.868,s.mul(e))).add(qn(.4298,s).add(qn(.1191,e).sub(.00232))))}),cy=Ni(([t,e])=>{const s=Oi(t).toVar(),r=qi(Oi(.856627153315983,.137318972929847,.11189821299995),Oi(.0951212405381588,.761241990602591,.0767994186031903),Oi(.0482516061458583,.101439036467562,.811302368396859)),i=qi(Oi(1.1271005818144368,-.1413297634984383,-.14132976349843826),Oi(-.11060664309660323,1.157823702216272,-.11060664309660294),Oi(-.016493938717834573,-.016493938717834257,1.2519364065950405)),n=Ai(-12.47393),a=Ai(4.026069);return s.mulAssign(e),s.assign(ly.mul(s)),s.assign(r.mul(s)),s.assign(so(s,1e-10)),s.assign(Sa(s)),s.assign(s.sub(n).div(a.sub(n))),s.assign(xo(s,0,1)),s.assign(uy(s)),s.assign(i.mul(s)),s.assign(lo(so(Oi(0),s),Oi(2.2))),s.assign(hy.mul(s)),s.assign(xo(s,0,1)),s}).setLayout({name:"agxToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),dy=Ni(([t,e])=>{const s=Ai(.76),r=Ai(.15);t=t.mul(e);const i=eo(t.r,eo(t.g,t.b)),n=Io(i.lessThan(.08),i.sub(qn(6.25,i.mul(i))),.04);t.subAssign(n);const a=so(t.r,so(t.g,t.b));Mi(a.lessThan(s),()=>t);const o=jn(1,s),h=jn(1,o.mul(o).div(a.add(o.sub(s))));t.mulAssign(h.div(a));const l=jn(1,Hn(1,r.mul(a.sub(h)).add(1)));return fo(t,Oi(h),l)}).setLayout({name:"neutralToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]});class py extends _r{static get type(){return"CodeNode"}constructor(t="",e=[],s=""){super("code"),this.isCodeNode=!0,this.global=!0,this.code=t,this.includes=e,this.language=s}setIncludes(t){return this.includes=t,this}getIncludes(){return this.includes}generate(t){const e=this.getIncludes(t);for(const s of e)s.build(t);const s=t.getCodeFromNode(this,this.getNodeType(t));return s.code=this.code,s.code}serialize(t){super.serialize(t),t.code=this.code,t.language=this.language}deserialize(t){super.deserialize(t),this.code=t.code,this.language=t.language}}const my=fi(py).setParameterLength(1,3);class gy extends py{static get type(){return"FunctionNode"}constructor(t="",e=[],s=""){super(t,e,s)}getNodeType(t){return this.getNodeFunction(t).type}getInputs(t){return this.getNodeFunction(t).inputs}getNodeFunction(t){const e=t.getDataFromNode(this);let s=e.nodeFunction;return void 0===s&&(s=t.parser.parseFunction(this.code),e.nodeFunction=s),s}generate(t,e){super.generate(t);const s=this.getNodeFunction(t),r=s.name,i=s.type,n=t.getCodeFromNode(this,i);""!==r&&(n.name=r);const a=t.getPropertyName(n),o=this.getNodeFunction(t).getCode(a);return n.code=o+"\n","property"===e?a:t.format(`${a}()`,i,e)}}const yy=(t,e=[],s="")=>{for(let t=0;t<e.length;t++){const s=e[t];"function"==typeof s&&(e[t]=s.functionNode)}const r=pi(new gy(t,e,s)),i=(...t)=>r.call(...t);return i.functionNode=r,i};class fy extends _r{static get type(){return"ScriptableValueNode"}constructor(t=null){super(),this._value=t,this._cache=null,this.inputType=null,this.outputType=null,this.events=new z,this.isScriptableValueNode=!0}get isScriptableOutputNode(){return null!==this.outputType}set value(t){this._value!==t&&(this._cache&&"URL"===this.inputType&&this.value.value instanceof ArrayBuffer&&(URL.revokeObjectURL(this._cache),this._cache=null),this._value=t,this.events.dispatchEvent({type:"change"}),this.refresh())}get value(){return this._value}refresh(){this.events.dispatchEvent({type:"refresh"})}getValue(){const t=this.value;if(t&&null===this._cache&&"URL"===this.inputType&&t.value instanceof ArrayBuffer)this._cache=URL.createObjectURL(new Blob([t.value]));else if(t&&null!==t.value&&void 0!==t.value&&(("URL"===this.inputType||"String"===this.inputType)&&"string"==typeof t.value||"Number"===this.inputType&&"number"==typeof t.value||"Vector2"===this.inputType&&t.value.isVector2||"Vector3"===this.inputType&&t.value.isVector3||"Vector4"===this.inputType&&t.value.isVector4||"Color"===this.inputType&&t.value.isColor||"Matrix3"===this.inputType&&t.value.isMatrix3||"Matrix4"===this.inputType&&t.value.isMatrix4))return t.value;return this._cache||t}getNodeType(t){return this.value&&this.value.isNode?this.value.getNodeType(t):"float"}setup(){return this.value&&this.value.isNode?this.value:Ai()}serialize(t){super.serialize(t),null!==this.value?"ArrayBuffer"===this.inputType?t.value=gr(this.value):t.value=this.value?this.value.toJSON(t.meta).uuid:null:t.value=null,t.inputType=this.inputType,t.outputType=this.outputType}deserialize(t){super.deserialize(t);let e=null;null!==t.value&&(e="ArrayBuffer"===t.inputType?yr(t.value):"Texture"===t.inputType?t.meta.textures[t.value]:t.meta.nodes[t.value]||null),this.value=e,this.inputType=t.inputType,this.outputType=t.outputType}}const xy=fi(fy).setParameterLength(1);class by extends Map{get(t,e=null,...s){if(this.has(t))return super.get(t);if(null!==e){const r=e(...s);return this.set(t,r),r}}}class vy{constructor(t){this.scriptableNode=t}get parameters(){return this.scriptableNode.parameters}get layout(){return this.scriptableNode.getLayout()}getInputLayout(t){return this.scriptableNode.getInputLayout(t)}get(t){const e=this.parameters[t];return e?e.getValue():null}}const Ny=new by;class wy extends _r{static get type(){return"ScriptableNode"}constructor(t=null,e={}){super(),this.codeNode=t,this.parameters=e,this._local=new by,this._output=xy(null),this._outputs={},this._source=this.source,this._method=null,this._object=null,this._value=null,this._needsOutputUpdate=!0,this.onRefresh=this.onRefresh.bind(this),this.isScriptableNode=!0}get source(){return this.codeNode?this.codeNode.code:""}setLocal(t,e){return this._local.set(t,e)}getLocal(t){return this._local.get(t)}onRefresh(){this._refresh()}getInputLayout(t){for(const e of this.getLayout())if(e.inputType&&(e.id===t||e.name===t))return e}getOutputLayout(t){for(const e of this.getLayout())if(e.outputType&&(e.id===t||e.name===t))return e}setOutput(t,e){const s=this._outputs;return void 0===s[t]?s[t]=xy(e):s[t].value=e,this}getOutput(t){return this._outputs[t]}getParameter(t){return this.parameters[t]}setParameter(t,e){const s=this.parameters;return e&&e.isScriptableNode?(this.deleteParameter(t),s[t]=e,s[t].getDefaultOutput().events.addEventListener("refresh",this.onRefresh)):e&&e.isScriptableValueNode?(this.deleteParameter(t),s[t]=e,s[t].events.addEventListener("refresh",this.onRefresh)):void 0===s[t]?(s[t]=xy(e),s[t].events.addEventListener("refresh",this.onRefresh)):s[t].value=e,this}getValue(){return this.getDefaultOutput().getValue()}deleteParameter(t){let e=this.parameters[t];return e&&(e.isScriptableNode&&(e=e.getDefaultOutput()),e.events.removeEventListener("refresh",this.onRefresh)),this}clearParameters(){for(const t of Object.keys(this.parameters))this.deleteParameter(t);return this.needsUpdate=!0,this}call(t,...e){const s=this.getObject()[t];if("function"==typeof s)return s(...e)}async callAsync(t,...e){const s=this.getObject()[t];if("function"==typeof s)return"AsyncFunction"===s.constructor.name?await s(...e):s(...e)}getNodeType(t){return this.getDefaultOutputNode().getNodeType(t)}refresh(t=null){null!==t?this.getOutput(t).refresh():this._refresh()}getObject(){if(this.needsUpdate&&this.dispose(),null!==this._object)return this._object;const t=new vy(this),e=Ny.get("THREE"),s=Ny.get("TSL"),r=this.getMethod(),i=[t,this._local,Ny,()=>this.refresh(),(t,e)=>this.setOutput(t,e),e,s];this._object=r(...i);const n=this._object.layout;if(n&&(!1===n.cache&&this._local.clear(),this._output.outputType=n.outputType||null,Array.isArray(n.elements)))for(const t of n.elements){const e=t.id||t.name;t.inputType&&(void 0===this.getParameter(e)&&this.setParameter(e,null),this.getParameter(e).inputType=t.inputType),t.outputType&&(void 0===this.getOutput(e)&&this.setOutput(e,null),this.getOutput(e).outputType=t.outputType)}return this._object}deserialize(t){super.deserialize(t);for(const t in this.parameters){let e=this.parameters[t];e.isScriptableNode&&(e=e.getDefaultOutput()),e.events.addEventListener("refresh",this.onRefresh)}}getLayout(){return this.getObject().layout}getDefaultOutputNode(){const t=this.getDefaultOutput().value;return t&&t.isNode?t:Ai()}getDefaultOutput(){return this._exec()._output}getMethod(){if(this.needsUpdate&&this.dispose(),null!==this._method)return this._method;const t=["layout","init","main","dispose"].join(", "),e="\nreturn { ...output, "+t+" };",s="var "+t+"; var output = {};\n"+this.codeNode.code+e;return this._method=new Function(...["parameters","local","global","refresh","setOutput","THREE","TSL"],s),this._method}dispose(){null!==this._method&&(this._object&&"function"==typeof this._object.dispose&&this._object.dispose(),this._method=null,this._object=null,this._source=null,this._value=null,this._needsOutputUpdate=!0,this._output.value=null,this._outputs={})}setup(){return this.getDefaultOutputNode()}getCacheKey(t){const e=[(s=this.source,er(s)),this.getDefaultOutputNode().getCacheKey(t)];var s;for(const s in this.parameters)e.push(this.parameters[s].getCacheKey(t));return sr(e)}set needsUpdate(t){!0===t&&this.dispose()}get needsUpdate(){return this.source!==this._source}_exec(){return null===this.codeNode||(!0===this._needsOutputUpdate&&(this._value=this.call("main"),this._needsOutputUpdate=!1),this._output.value=this._value),this}_refresh(){this.needsUpdate=!0,this._exec(),this._output.refresh()}}const Ty=fi(wy).setParameterLength(1,2);function My(t){let e;const s=t.context.getViewZ;return void 0!==s&&(e=s(this)),(e||Al.z).negate()}const _y=Ni(([t,e],s)=>{const r=My(s);return No(t,e,r)}),Sy=Ni(([t],e)=>{const s=My(e);return t.mul(t,s,s).negate().exp().oneMinus()}),Ay=Ni(([t,e])=>ki(e.toFloat().mix(yn.rgb,t.toVec3()),yn.a));let Vy=null,zy=null;class Cy extends _r{static get type(){return"RangeNode"}constructor(t=Ai(),e=Ai()){super(),this.minNode=t,this.maxNode=e}getVectorLength(t){const e=t.getTypeLength(dr(this.minNode.value)),s=t.getTypeLength(dr(this.maxNode.value));return e>s?e:s}getNodeType(t){return t.object.count>1?t.getTypeFromLength(this.getVectorLength(t)):"float"}setup(t){const e=t.object;let s=null;if(e.count>1){const r=this.minNode.value,i=this.maxNode.value,n=t.getTypeLength(dr(r)),a=t.getTypeLength(dr(i));Vy=Vy||new ct,zy=zy||new ct,Vy.setScalar(0),zy.setScalar(0),1===n?Vy.setScalar(r):r.isColor?Vy.set(r.r,r.g,r.b,1):Vy.set(r.x,r.y,r.z||0,r.w||0),1===a?zy.setScalar(i):i.isColor?zy.set(i.r,i.g,i.b,1):zy.set(i.x,i.y,i.z||0,i.w||0);const o=4,h=o*e.count,l=new Float32Array(h);for(let t=0;t<h;t++){const e=t%o,s=Vy.getComponent(e),r=zy.getComponent(e);l[t]=D.lerp(s,r,Math.random())}const u=this.getNodeType(t);if(e.count<=4096)s=Uh(l,"vec4",e.count).element(Rc).convert(u);else{const e=new Ss(l,4);t.geometry.setAttribute("__range"+this.id,e),s=lh(e).convert(u)}}else s=Ai(0);return s}}const Iy=fi(Cy).setParameterLength(2);class Ry extends _r{static get type(){return"ComputeBuiltinNode"}constructor(t,e){super(e),this._builtinName=t}getHash(t){return this.getBuiltinName(t)}getNodeType(){return this.nodeType}setBuiltinName(t){return this._builtinName=t,this}getBuiltinName(){return this._builtinName}hasBuiltin(t){return t.hasBuiltin(this._builtinName)}generate(t,e){const s=this.getBuiltinName(t),r=this.getNodeType(t);return"compute"===t.shaderStage?t.format(s,r,e):t.generateConst(r)}serialize(t){super.serialize(t),t.global=this.global,t._builtinName=this._builtinName}deserialize(t){super.deserialize(t),this.global=t.global,this._builtinName=t._builtinName}}const Ey=(t,e)=>pi(new Ry(t,e)),Ly=Ey("numWorkgroups","uvec3"),Oy=Ey("workgroupId","uvec3"),Py=Ey("globalId","uvec3"),Fy=Ey("localId","uvec3"),By=Ey("subgroupSize","uint");const ky=fi(class extends _r{constructor(t){super(),this.scope=t}generate(t){const{scope:e}=this,{renderer:s}=t;!0===s.backend.isWebGLBackend?t.addFlowCode(`\t// ${e}Barrier \n`):t.addLineFlowCode(`${e}Barrier()`,this)}});class Dy extends Sr{constructor(t,e){super(t,e),this.isWorkgroupInfoElementNode=!0}generate(t,e){let s;const r=t.context.assign;if(s=super.generate(t),!0!==r){const r=this.getNodeType(t);s=t.format(s,r,e)}return s}}class Uy extends _r{constructor(t,e,s=0){super(e),this.bufferType=e,this.bufferCount=s,this.isWorkgroupInfoNode=!0,this.elementType=e,this.scope=t,this.name=""}setName(t){return this.name=t,this}label(t){return this.setName(t)}setScope(t){return this.scope=t,this}getElementType(){return this.elementType}getInputType(){return`${this.scope}Array`}element(t){return pi(new Dy(this,t))}generate(t){const e=""!==this.name?this.name:`${this.scope}Array_${this.id}`;return t.getScopedArray(e,this.scope.toLowerCase(),this.bufferType,this.bufferCount)}}class Wy extends _r{static get type(){return"AtomicFunctionNode"}constructor(t,e,s){super("uint"),this.method=t,this.pointerNode=e,this.valueNode=s,this.parents=!0}getInputType(t){return this.pointerNode.getNodeType(t)}getNodeType(t){return this.getInputType(t)}generate(t){const e=t.getNodeProperties(this),s=e.parents,r=this.method,i=this.getNodeType(t),n=this.getInputType(t),a=this.pointerNode,o=this.valueNode,h=[];h.push(`&${a.build(t,n)}`),null!==o&&h.push(o.build(t,n));const l=`${t.getMethod(r,i)}( ${h.join(", ")} )`;if(!(!!s&&(1===s.length&&!0===s[0].isStackNode)))return void 0===e.constNode&&(e.constNode=wh(l,i).toConst()),e.constNode.build(t);t.addLineFlowCode(l,this)}}Wy.ATOMIC_LOAD="atomicLoad",Wy.ATOMIC_STORE="atomicStore",Wy.ATOMIC_ADD="atomicAdd",Wy.ATOMIC_SUB="atomicSub",Wy.ATOMIC_MAX="atomicMax",Wy.ATOMIC_MIN="atomicMin",Wy.ATOMIC_AND="atomicAnd",Wy.ATOMIC_OR="atomicOr",Wy.ATOMIC_XOR="atomicXor";const jy=fi(Wy),qy=(t,e,s)=>jy(t,e,s).toStack();let Hy;function Gy(t){Hy=Hy||new WeakMap;let e=Hy.get(t);return void 0===e&&Hy.set(t,e={}),e}function Xy(t){const e=Gy(t);return e.shadowMatrix||(e.shadowMatrix=En("mat4").setGroup(Cn).onRenderUpdate(e=>(!0===t.castShadow&&!1!==e.renderer.shadowMap.enabled||t.shadow.updateMatrices(t),t.shadow.matrix)))}function Yy(t){const e=Gy(t);return e.position||(e.position=En(new j).setGroup(Cn).onRenderUpdate((e,s)=>s.value.setFromMatrixPosition(t.matrixWorld)))}function Zy(t){const e=Gy(t);return e.targetPosition||(e.targetPosition=En(new j).setGroup(Cn).onRenderUpdate((e,s)=>s.value.setFromMatrixPosition(t.target.matrixWorld)))}const $y=(t,e)=>{for(const s of e)if(s.isAnalyticLightNode&&s.light.id===t)return s;return null},Jy=new WeakMap,Ky=[];class Qy extends _r{static get type(){return"LightsNode"}constructor(){super("vec3"),this.totalDiffuseNode=Zi("vec3","totalDiffuse"),this.totalSpecularNode=Zi("vec3","totalSpecular"),this.outgoingLightNode=Zi("vec3","outgoingLight"),this._lights=[],this._lightNodes=null,this._lightNodesHash=null,this.global=!0}customCacheKey(){const t=this._lights;for(let e=0;e<t.length;e++){const s=t[e];if(Ky.push(s.id),Ky.push(s.castShadow?1:0),!0===s.isSpotLight){const t=null!==s.map?s.map.id:-1,e=s.colorNode?s.colorNode.getCacheKey():-1;Ky.push(t,e)}}const e=sr(Ky);return Ky.length=0,e}getHash(t){if(null===this._lightNodesHash){null===this._lightNodes&&this.setupLightsNode(t);const e=[];for(const t of this._lightNodes)e.push(t.getSelf().getHash());this._lightNodesHash="lights-"+e.join(",")}return this._lightNodesHash}analyze(t){const e=t.getNodeProperties(this);for(const s of e.nodes)s.build(t);e.outputNode.build(t)}setupLightsNode(t){const e=[],s=this._lightNodes,r=(t=>t.sort((t,e)=>t.id-e.id))(this._lights),i=t.renderer.library;for(const t of r)if(t.isNode)e.push(pi(t));else{let r=null;if(null!==s&&(r=$y(t.id,s)),null===r){const s=i.getLightNodeClass(t.constructor);if(null===s)continue;let r=null;Jy.has(t)?r=Jy.get(t):(r=pi(new s(t)),Jy.set(t,r)),e.push(r)}}this._lightNodes=e}setupDirectLight(t,e,s){const{lightingModel:r,reflectedLight:i}=t.context;r.direct({...s,lightNode:e,reflectedLight:i},t)}setupDirectRectAreaLight(t,e,s){const{lightingModel:r,reflectedLight:i}=t.context;r.directRectArea({...s,lightNode:e,reflectedLight:i},t)}setupLights(t,e){for(const s of e)s.build(t)}getLightNodes(t){return null===this._lightNodes&&this.setupLightsNode(t),this._lightNodes}setup(t){const e=t.lightsNode;t.lightsNode=this;let s=this.outgoingLightNode;const r=t.context,i=r.lightingModel,n=t.getNodeProperties(this);if(i){const{totalDiffuseNode:e,totalSpecularNode:a}=this;r.outgoingLight=s;const o=t.addStack();n.nodes=o.nodes,i.start(t);const{backdrop:h,backdropAlpha:l}=r,{directDiffuse:u,directSpecular:c,indirectDiffuse:d,indirectSpecular:p}=r.reflectedLight;let m=u.add(d);null!==h&&(m=Oi(null!==l?l.mix(m,h):h),r.material.transparent=!0),e.assign(m),a.assign(c.add(p)),s.assign(e.add(a)),i.finish(t),s=s.bypass(t.removeStack())}else n.nodes=[];return t.lightsNode=e,s}setLights(t){return this._lights=t,this._lightNodes=null,this._lightNodesHash=null,this}getLights(){return this._lights}get hasLights(){return this._lights.length>0}}class tf extends _r{static get type(){return"ShadowBaseNode"}constructor(t){super(),this.light=t,this.updateBeforeType=xr.RENDER,this.isShadowBaseNode=!0}setupShadowPosition({context:t,material:e}){ef.assign(e.receivedShadowPositionNode||t.shadowPositionWorld||_l)}}const ef=Zi("vec3","shadowPositionWorld");function sf(t,e={}){return e.toneMapping=t.toneMapping,e.toneMappingExposure=t.toneMappingExposure,e.outputColorSpace=t.outputColorSpace,e.renderTarget=t.getRenderTarget(),e.activeCubeFace=t.getActiveCubeFace(),e.activeMipmapLevel=t.getActiveMipmapLevel(),e.renderObjectFunction=t.getRenderObjectFunction(),e.pixelRatio=t.getPixelRatio(),e.mrt=t.getMRT(),e.clearColor=t.getClearColor(e.clearColor||new Ee),e.clearAlpha=t.getClearAlpha(),e.autoClear=t.autoClear,e.scissorTest=t.getScissorTest(),e}function rf(t,e){return e=sf(t,e),t.setMRT(null),t.setRenderObjectFunction(null),t.setClearColor(0,1),t.autoClear=!0,e}function nf(t,e){t.toneMapping=e.toneMapping,t.toneMappingExposure=e.toneMappingExposure,t.outputColorSpace=e.outputColorSpace,t.setRenderTarget(e.renderTarget,e.activeCubeFace,e.activeMipmapLevel),t.setRenderObjectFunction(e.renderObjectFunction),t.setPixelRatio(e.pixelRatio),t.setMRT(e.mrt),t.setClearColor(e.clearColor,e.clearAlpha),t.autoClear=e.autoClear,t.setScissorTest(e.scissorTest)}function af(t,e={}){return e.background=t.background,e.backgroundNode=t.backgroundNode,e.overrideMaterial=t.overrideMaterial,e}function of(t,e){return e=af(t,e),t.background=null,t.backgroundNode=null,t.overrideMaterial=null,e}function hf(t,e){t.background=e.background,t.backgroundNode=e.backgroundNode,t.overrideMaterial=e.overrideMaterial}function lf(t,e,s){return s=of(e,s=rf(t,s))}function uf(t,e,s){nf(t,s),hf(e,s)}var cf=Object.freeze({__proto__:null,resetRendererAndSceneState:lf,resetRendererState:rf,resetSceneState:of,restoreRendererAndSceneState:uf,restoreRendererState:nf,restoreSceneState:hf,saveRendererAndSceneState:function(t,e,s={}){return s=af(e,s=sf(t,s))},saveRendererState:sf,saveSceneState:af});const df=new WeakMap,pf=Ni(({depthTexture:t,shadowCoord:e,depthLayer:s})=>{let r=Bh(t,e.xy).setName("t_basic");return t.isArrayTexture&&(r=r.depth(s)),r.compare(e.z)}),mf=Ni(({depthTexture:t,shadowCoord:e,shadow:s,depthLayer:r})=>{const i=(e,s)=>{let i=Bh(t,e);return t.isArrayTexture&&(i=i.depth(r)),i.compare(s)},n=ou("mapSize","vec2",s).setGroup(Cn),a=ou("radius","float",s).setGroup(Cn),o=Ii(1).div(n),h=o.x.negate().mul(a),l=o.y.negate().mul(a),u=o.x.mul(a),c=o.y.mul(a),d=h.div(2),p=l.div(2),m=u.div(2),g=c.div(2);return Wn(i(e.xy.add(Ii(h,l)),e.z),i(e.xy.add(Ii(0,l)),e.z),i(e.xy.add(Ii(u,l)),e.z),i(e.xy.add(Ii(d,p)),e.z),i(e.xy.add(Ii(0,p)),e.z),i(e.xy.add(Ii(m,p)),e.z),i(e.xy.add(Ii(h,0)),e.z),i(e.xy.add(Ii(d,0)),e.z),i(e.xy,e.z),i(e.xy.add(Ii(m,0)),e.z),i(e.xy.add(Ii(u,0)),e.z),i(e.xy.add(Ii(d,g)),e.z),i(e.xy.add(Ii(0,g)),e.z),i(e.xy.add(Ii(m,g)),e.z),i(e.xy.add(Ii(h,c)),e.z),i(e.xy.add(Ii(0,c)),e.z),i(e.xy.add(Ii(u,c)),e.z)).mul(1/17)}),gf=Ni(({depthTexture:t,shadowCoord:e,shadow:s,depthLayer:r})=>{const i=(e,s)=>{let i=Bh(t,e);return t.isArrayTexture&&(i=i.depth(r)),i.compare(s)},n=ou("mapSize","vec2",s).setGroup(Cn),a=Ii(1).div(n),o=a.x,h=a.y,l=e.xy,u=Ra(l.mul(n).add(.5));return l.subAssign(u.mul(a)),Wn(i(l,e.z),i(l.add(Ii(o,0)),e.z),i(l.add(Ii(0,h)),e.z),i(l.add(a),e.z),fo(i(l.add(Ii(o.negate(),0)),e.z),i(l.add(Ii(o.mul(2),0)),e.z),u.x),fo(i(l.add(Ii(o.negate(),h)),e.z),i(l.add(Ii(o.mul(2),h)),e.z),u.x),fo(i(l.add(Ii(0,h.negate())),e.z),i(l.add(Ii(0,h.mul(2))),e.z),u.y),fo(i(l.add(Ii(o,h.negate())),e.z),i(l.add(Ii(o,h.mul(2))),e.z),u.y),fo(fo(i(l.add(Ii(o.negate(),h.negate())),e.z),i(l.add(Ii(o.mul(2),h.negate())),e.z),u.x),fo(i(l.add(Ii(o.negate(),h.mul(2))),e.z),i(l.add(Ii(o.mul(2),h.mul(2))),e.z),u.x),u.y)).mul(1/9)}),yf=Ni(({depthTexture:t,shadowCoord:e,depthLayer:s})=>{const r=Ai(1).toVar();let i=Bh(t).sample(e.xy);t.isArrayTexture&&(i=i.depth(s)),i=i.rg;const n=ro(e.z,i.x);return Mi(n.notEqual(Ai(1)),()=>{const t=e.z.sub(i.x),s=so(0,i.y.mul(i.y));let a=s.div(s.add(t.mul(t)));a=xo(jn(a,.3).div(.95-.3)),r.assign(xo(so(n,a)))}),r}),ff=Ni(([t,e,s])=>{let r=_l.sub(t).length();return r=r.sub(e).div(s.sub(e)),r=r.saturate(),r}),xf=t=>{let e=df.get(t);if(void 0===e){const s=t.isPointLight?(t=>{const e=t.shadow.camera,s=ou("near","float",e).setGroup(Cn),r=ou("far","float",e).setGroup(Cn),i=nl(t);return ff(i,s,r)})(t):null;e=new Zd,e.colorNode=ki(0,0,0,1),e.depthNode=s,e.isShadowPassMaterial=!0,e.name="ShadowMaterial",e.fog=!1,df.set(t,e)}return e},bf=new bm,vf=[],Nf=(t,e,s,r)=>{vf[0]=t,vf[1]=e;let i=bf.get(vf);return void 0!==i&&i.shadowType===s&&i.useVelocity===r||(i=(i,n,a,o,h,l,...u)=>{(!0===i.castShadow||i.receiveShadow&&3===s)&&(r&&(mr(i).useVelocity=!0),i.onBeforeShadow(t,i,a,e.camera,o,n.overrideMaterial,l),t.renderObject(i,n,a,o,h,l,...u),i.onAfterShadow(t,i,a,e.camera,o,n.overrideMaterial,l))},i.shadowType=s,i.useVelocity=r,bf.set(vf,i)),vf[0]=null,vf[1]=null,i},wf=Ni(({samples:t,radius:e,size:s,shadowPass:r,depthLayer:i})=>{const n=Ai(0).toVar("meanVertical"),a=Ai(0).toVar("squareMeanVertical"),o=t.lessThanEqual(Ai(1)).select(Ai(0),Ai(2).div(t.sub(1))),h=t.lessThanEqual(Ai(1)).select(Ai(0),Ai(-1));Jc({start:Vi(0),end:Vi(t),type:"int",condition:"<"},({i:t})=>{const l=h.add(Ai(t).mul(o));let u=r.sample(Wn(md.xy,Ii(0,l).mul(e)).div(s));r.value.isArrayTexture&&(u=u.depth(i)),u=u.x,n.addAssign(u),a.addAssign(u.mul(u))}),n.divAssign(t),a.divAssign(t);const l=Aa(a.sub(n.mul(n)));return Ii(n,l)}),Tf=Ni(({samples:t,radius:e,size:s,shadowPass:r,depthLayer:i})=>{const n=Ai(0).toVar("meanHorizontal"),a=Ai(0).toVar("squareMeanHorizontal"),o=t.lessThanEqual(Ai(1)).select(Ai(0),Ai(2).div(t.sub(1))),h=t.lessThanEqual(Ai(1)).select(Ai(0),Ai(-1));Jc({start:Vi(0),end:Vi(t),type:"int",condition:"<"},({i:t})=>{const l=h.add(Ai(t).mul(o));let u=r.sample(Wn(md.xy,Ii(l,0).mul(e)).div(s));r.value.isArrayTexture&&(u=u.depth(i)),n.addAssign(u.x),a.addAssign(Wn(u.y.mul(u.y),u.x.mul(u.x)))}),n.divAssign(t),a.divAssign(t);const l=Aa(a.sub(n.mul(n)));return Ii(n,l)}),Mf=[pf,mf,gf,yf];let _f;const Sf=new pg;class Af extends tf{static get type(){return"ShadowNode"}constructor(t,e=null){super(t),this.shadow=e||t.shadow,this.shadowMap=null,this.vsmShadowMapVertical=null,this.vsmShadowMapHorizontal=null,this.vsmMaterialVertical=null,this.vsmMaterialHorizontal=null,this._node=null,this._cameraFrameId=new WeakMap,this.isShadowNode=!0,this.depthLayer=0}setupShadowFilter(t,{filterFn:e,depthTexture:s,shadowCoord:r,shadow:i,depthLayer:n}){const a=r.x.greaterThanEqual(0).and(r.x.lessThanEqual(1)).and(r.y.greaterThanEqual(0)).and(r.y.lessThanEqual(1)).and(r.z.lessThanEqual(1)),o=e({depthTexture:s,shadowCoord:r,shadow:i,depthLayer:n});return a.select(o,Ai(1))}setupShadowCoord(t,e){const{shadow:s}=this,{renderer:r}=t,i=ou("bias","float",s).setGroup(Cn);let n,a=e;if(s.camera.isOrthographicCamera||!0!==r.logarithmicDepthBuffer)a=a.xyz.div(a.w),n=a.z,r.coordinateSystem===V&&(n=n.mul(2).sub(1));else{const t=a.w;a=a.xy.div(t);const e=ou("near","float",s.camera).setGroup(Cn),r=ou("far","float",s.camera).setGroup(Cn);n=Id(t.negate(),e,r)}return a=Oi(a.x,a.y.oneMinus(),n.add(i)),a}getShadowFilterFn(t){return Mf[t]}setupRenderTarget(t,e){const s=new Rs(t.mapSize.width,t.mapSize.height);s.name="ShadowDepthTexture",s.compareFunction=513;const r=e.createRenderTarget(t.mapSize.width,t.mapSize.height);return r.texture.name="ShadowMap",r.texture.type=t.mapType,r.depthTexture=s,{shadowMap:r,depthTexture:s}}setupShadow(t){const{renderer:e}=t,{light:s,shadow:r}=this,i=e.shadowMap.type,{depthTexture:n,shadowMap:a}=this.setupRenderTarget(r,t);if(r.camera.updateProjectionMatrix(),3===i&&!0!==r.isPointLightShadow){n.compareFunction=null,a.depth>1?(a._vsmShadowMapVertical||(a._vsmShadowMapVertical=t.createRenderTarget(r.mapSize.width,r.mapSize.height,{format:y,type:d,depth:a.depth,depthBuffer:!1}),a._vsmShadowMapVertical.texture.name="VSMVertical"),this.vsmShadowMapVertical=a._vsmShadowMapVertical,a._vsmShadowMapHorizontal||(a._vsmShadowMapHorizontal=t.createRenderTarget(r.mapSize.width,r.mapSize.height,{format:y,type:d,depth:a.depth,depthBuffer:!1}),a._vsmShadowMapHorizontal.texture.name="VSMHorizontal"),this.vsmShadowMapHorizontal=a._vsmShadowMapHorizontal):(this.vsmShadowMapVertical=t.createRenderTarget(r.mapSize.width,r.mapSize.height,{format:y,type:d,depthBuffer:!1}),this.vsmShadowMapHorizontal=t.createRenderTarget(r.mapSize.width,r.mapSize.height,{format:y,type:d,depthBuffer:!1}));let e=Bh(n);n.isArrayTexture&&(e=e.depth(this.depthLayer));let s=Bh(this.vsmShadowMapVertical.texture);n.isArrayTexture&&(s=s.depth(this.depthLayer));const i=ou("blurSamples","float",r).setGroup(Cn),o=ou("radius","float",r).setGroup(Cn),h=ou("mapSize","vec2",r).setGroup(Cn);let l=this.vsmMaterialVertical||(this.vsmMaterialVertical=new Zd);l.fragmentNode=wf({samples:i,radius:o,size:h,shadowPass:e,depthLayer:this.depthLayer}).context(t.getSharedContext()),l.name="VSMVertical",l=this.vsmMaterialHorizontal||(this.vsmMaterialHorizontal=new Zd),l.fragmentNode=Tf({samples:i,radius:o,size:h,shadowPass:s,depthLayer:this.depthLayer}).context(t.getSharedContext()),l.name="VSMHorizontal"}const o=ou("intensity","float",r).setGroup(Cn),h=ou("normalBias","float",r).setGroup(Cn),l=Xy(s).mul(ef.add(kl.mul(h))),u=this.setupShadowCoord(t,l),c=r.filterNode||this.getShadowFilterFn(e.shadowMap.type)||null;if(null===c)throw new Error("THREE.WebGPURenderer: Shadow map type not supported yet.");const p=3===i&&!0!==r.isPointLightShadow?this.vsmShadowMapHorizontal.texture:n,m=this.setupShadowFilter(t,{filterFn:c,shadowTexture:a.texture,depthTexture:p,shadowCoord:u,shadow:r,depthLayer:this.depthLayer});let g=Bh(a.texture,u);n.isArrayTexture&&(g=g.depth(this.depthLayer));const f=fo(1,m.rgb.mix(g,1),o.mul(g.a)).toVar();return this.shadowMap=a,this.shadow.map=a,f}setup(t){if(!1!==t.renderer.shadowMap.enabled)return Ni(()=>{let e=this._node;return this.setupShadowPosition(t),null===e&&(this._node=e=this.setupShadow(t)),t.material.shadowNode,t.material.receivedShadowNode&&(e=t.material.receivedShadowNode(e)),e})()}renderShadow(t){const{shadow:e,shadowMap:s,light:r}=this,{renderer:i,scene:n}=t;e.updateMatrices(r),s.setSize(e.mapSize.width,e.mapSize.height,s.depth),i.render(n,e.camera)}updateShadow(t){const{shadowMap:e,light:s,shadow:r}=this,{renderer:i,scene:n,camera:a}=t,o=i.shadowMap.type,h=e.depthTexture.version;this._depthVersionCached=h;const l=r.camera.layers.mask;4294967294&r.camera.layers.mask||(r.camera.layers.mask=a.layers.mask);const u=i.getRenderObjectFunction(),c=i.getMRT(),d=!!c&&c.has("velocity");_f=lf(i,n,_f),n.overrideMaterial=xf(s),i.setRenderObjectFunction(Nf(i,r,o,d)),i.setClearColor(0,0),i.setRenderTarget(e),this.renderShadow(t),i.setRenderObjectFunction(u),3===o&&!0!==r.isPointLightShadow&&this.vsmPass(i),r.camera.layers.mask=l,uf(i,n,_f)}vsmPass(t){const{shadow:e}=this,s=this.shadowMap.depth;this.vsmShadowMapVertical.setSize(e.mapSize.width,e.mapSize.height,s),this.vsmShadowMapHorizontal.setSize(e.mapSize.width,e.mapSize.height,s),t.setRenderTarget(this.vsmShadowMapVertical),Sf.material=this.vsmMaterialVertical,Sf.render(t),t.setRenderTarget(this.vsmShadowMapHorizontal),Sf.material=this.vsmMaterialHorizontal,Sf.render(t)}dispose(){this.shadowMap.dispose(),this.shadowMap=null,null!==this.vsmShadowMapVertical&&(this.vsmShadowMapVertical.dispose(),this.vsmShadowMapVertical=null,this.vsmMaterialVertical.dispose(),this.vsmMaterialVertical=null),null!==this.vsmShadowMapHorizontal&&(this.vsmShadowMapHorizontal.dispose(),this.vsmShadowMapHorizontal=null,this.vsmMaterialHorizontal.dispose(),this.vsmMaterialHorizontal=null),super.dispose()}updateBefore(t){const{shadow:e}=this;let s=e.needsUpdate||e.autoUpdate;s&&(this._cameraFrameId[t.camera]===t.frameId&&(s=!1),this._cameraFrameId[t.camera]=t.frameId),s&&(this.updateShadow(t),this.shadowMap.depthTexture.version===this._depthVersionCached&&(e.needsUpdate=!1))}}const Vf=new Ee,zf=Ni(([t,e])=>{const s=t.toVar(),r=ka(s),i=Hn(1,so(r.x,so(r.y,r.z)));r.mulAssign(i),s.mulAssign(i.mul(e.mul(2).oneMinus()));const n=Ii(s.xy).toVar(),a=e.mul(1.5).oneMinus();return Mi(r.z.greaterThanEqual(a),()=>{Mi(s.z.greaterThan(0),()=>{n.x.assign(jn(4,s.x))})}).ElseIf(r.x.greaterThanEqual(a),()=>{const t=Da(s.x);n.x.assign(s.z.mul(t).add(t.mul(2)))}).ElseIf(r.y.greaterThanEqual(a),()=>{const t=Da(s.y);n.x.assign(s.x.add(t.mul(2)).add(2)),n.y.assign(s.z.mul(t).sub(2))}),Ii(.125,.25).mul(n).add(Ii(.375,.75)).flipY()}).setLayout({name:"cubeToUV",type:"vec2",inputs:[{name:"pos",type:"vec3"},{name:"texelSizeY",type:"float"}]}),Cf=Ni(({depthTexture:t,bd3D:e,dp:s,texelSize:r})=>Bh(t,zf(e,r.y)).compare(s)),If=Ni(({depthTexture:t,bd3D:e,dp:s,texelSize:r,shadow:i})=>{const n=ou("radius","float",i).setGroup(Cn),a=Ii(-1,1).mul(n).mul(r.y);return Bh(t,zf(e.add(a.xyy),r.y)).compare(s).add(Bh(t,zf(e.add(a.yyy),r.y)).compare(s)).add(Bh(t,zf(e.add(a.xyx),r.y)).compare(s)).add(Bh(t,zf(e.add(a.yyx),r.y)).compare(s)).add(Bh(t,zf(e,r.y)).compare(s)).add(Bh(t,zf(e.add(a.xxy),r.y)).compare(s)).add(Bh(t,zf(e.add(a.yxy),r.y)).compare(s)).add(Bh(t,zf(e.add(a.xxx),r.y)).compare(s)).add(Bh(t,zf(e.add(a.yxx),r.y)).compare(s)).mul(1/9)}),Rf=Ni(({filterFn:t,depthTexture:e,shadowCoord:s,shadow:r})=>{const i=s.xyz.toVar(),n=i.length(),a=En("float").setGroup(Cn).onRenderUpdate(()=>r.camera.near),o=En("float").setGroup(Cn).onRenderUpdate(()=>r.camera.far),h=ou("bias","float",r).setGroup(Cn),l=En(r.mapSize).setGroup(Cn),u=Ai(1).toVar();return Mi(n.sub(o).lessThanEqual(0).and(n.sub(a).greaterThanEqual(0)),()=>{const s=n.sub(a).div(o.sub(a)).toVar();s.addAssign(h);const c=i.normalize(),d=Ii(1).div(l.mul(Ii(4,2)));u.assign(t({depthTexture:e,bd3D:c,dp:s,texelSize:d,shadow:r}))}),u}),Ef=new ct,Lf=new U,Of=new U;class Pf extends Af{static get type(){return"PointShadowNode"}constructor(t,e=null){super(t,e)}getShadowFilterFn(t){return 0===t?Cf:If}setupShadowCoord(t,e){return e}setupShadowFilter(t,{filterFn:e,shadowTexture:s,depthTexture:r,shadowCoord:i,shadow:n}){return Rf({filterFn:e,shadowTexture:s,depthTexture:r,shadowCoord:i,shadow:n})}renderShadow(t){const{shadow:e,shadowMap:s,light:r}=this,{renderer:i,scene:n}=t,a=e.getFrameExtents();Of.copy(e.mapSize),Of.multiply(a),s.setSize(Of.width,Of.height),Lf.copy(e.mapSize);const o=i.autoClear,h=i.getClearColor(Vf),l=i.getClearAlpha();i.autoClear=!1,i.setClearColor(e.clearColor,e.clearAlpha),i.clear();const u=e.getViewportCount();for(let t=0;t<u;t++){const a=e.getViewport(t),o=Lf.x*a.x,h=Of.y-Lf.y-Lf.y*a.y;Ef.set(o,h,Lf.x*a.z,Lf.y*a.w),s.viewport.copy(Ef),e.updateMatrices(r,t),i.render(n,e.camera)}i.autoClear=o,i.setClearColor(h,l)}}const Ff=Ni(({lightDistance:t,cutoffDistance:e,decayExponent:s})=>{const r=t.pow(s).max(.01).reciprocal();return e.greaterThan(0).select(r.mul(t.div(e).pow4().oneMinus().clamp().pow2()),r)}),Bf=Ni(([t=Ch()])=>{const e=t.mul(2),s=e.x.floor(),r=e.y.floor();return s.add(r).mod(2).sign()}),kf=Ni(([t=Ch()],{renderer:e,material:s})=>{const r=yo(t.mul(2).sub(1));let i;if(s.alphaToCoverage&&e.samples>1){const t=Ai(r.fwidth()).toVar();i=No(t.oneMinus(),t.add(1),r).oneMinus()}else i=Io(r.greaterThan(1),0,1);return i}),Df=Ni(([t,e,s])=>{const r=Ai(s).toVar(),i=Ai(e).toVar(),n=Ci(t).toVar();return Io(n,i,r)}).setLayout({name:"mx_select",type:"float",inputs:[{name:"b",type:"bool"},{name:"t",type:"float"},{name:"f",type:"float"}]}),Uf=Ni(([t,e])=>{const s=Ci(e).toVar(),r=Ai(t).toVar();return Io(s,r.negate(),r)}).setLayout({name:"mx_negate_if",type:"float",inputs:[{name:"val",type:"float"},{name:"b",type:"bool"}]}),Wf=Ni(([t])=>{const e=Ai(t).toVar();return Vi(za(e))}).setLayout({name:"mx_floor",type:"int",inputs:[{name:"x",type:"float"}]}),jf=Ni(([t,e])=>{const s=Ai(t).toVar();return e.assign(Wf(s)),s.sub(Ai(e))}),qf=Fm([Ni(([t,e,s,r,i,n])=>{const a=Ai(n).toVar(),o=Ai(i).toVar(),h=Ai(r).toVar(),l=Ai(s).toVar(),u=Ai(e).toVar(),c=Ai(t).toVar(),d=Ai(jn(1,o)).toVar();return jn(1,a).mul(c.mul(d).add(u.mul(o))).add(a.mul(l.mul(d).add(h.mul(o))))}).setLayout({name:"mx_bilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"}]}),Ni(([t,e,s,r,i,n])=>{const a=Ai(n).toVar(),o=Ai(i).toVar(),h=Oi(r).toVar(),l=Oi(s).toVar(),u=Oi(e).toVar(),c=Oi(t).toVar(),d=Ai(jn(1,o)).toVar();return jn(1,a).mul(c.mul(d).add(u.mul(o))).add(a.mul(l.mul(d).add(h.mul(o))))}).setLayout({name:"mx_bilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"}]})]),Hf=Fm([Ni(([t,e,s,r,i,n,a,o,h,l,u])=>{const c=Ai(u).toVar(),d=Ai(l).toVar(),p=Ai(h).toVar(),m=Ai(o).toVar(),g=Ai(a).toVar(),y=Ai(n).toVar(),f=Ai(i).toVar(),x=Ai(r).toVar(),b=Ai(s).toVar(),v=Ai(e).toVar(),N=Ai(t).toVar(),w=Ai(jn(1,p)).toVar(),T=Ai(jn(1,d)).toVar();return Ai(jn(1,c)).toVar().mul(T.mul(N.mul(w).add(v.mul(p))).add(d.mul(b.mul(w).add(x.mul(p))))).add(c.mul(T.mul(f.mul(w).add(y.mul(p))).add(d.mul(g.mul(w).add(m.mul(p))))))}).setLayout({name:"mx_trilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"v4",type:"float"},{name:"v5",type:"float"},{name:"v6",type:"float"},{name:"v7",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]}),Ni(([t,e,s,r,i,n,a,o,h,l,u])=>{const c=Ai(u).toVar(),d=Ai(l).toVar(),p=Ai(h).toVar(),m=Oi(o).toVar(),g=Oi(a).toVar(),y=Oi(n).toVar(),f=Oi(i).toVar(),x=Oi(r).toVar(),b=Oi(s).toVar(),v=Oi(e).toVar(),N=Oi(t).toVar(),w=Ai(jn(1,p)).toVar(),T=Ai(jn(1,d)).toVar();return Ai(jn(1,c)).toVar().mul(T.mul(N.mul(w).add(v.mul(p))).add(d.mul(b.mul(w).add(x.mul(p))))).add(c.mul(T.mul(f.mul(w).add(y.mul(p))).add(d.mul(g.mul(w).add(m.mul(p))))))}).setLayout({name:"mx_trilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"v4",type:"vec3"},{name:"v5",type:"vec3"},{name:"v6",type:"vec3"},{name:"v7",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]})]),Gf=Ni(([t,e,s])=>{const r=Ai(s).toVar(),i=Ai(e).toVar(),n=zi(t).toVar(),a=zi(n.bitAnd(zi(7))).toVar(),o=Ai(Df(a.lessThan(zi(4)),i,r)).toVar(),h=Ai(qn(2,Df(a.lessThan(zi(4)),r,i))).toVar();return Uf(o,Ci(a.bitAnd(zi(1)))).add(Uf(h,Ci(a.bitAnd(zi(2)))))}).setLayout({name:"mx_gradient_float_0",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"}]}),Xf=Ni(([t,e,s,r])=>{const i=Ai(r).toVar(),n=Ai(s).toVar(),a=Ai(e).toVar(),o=zi(t).toVar(),h=zi(o.bitAnd(zi(15))).toVar(),l=Ai(Df(h.lessThan(zi(8)),a,n)).toVar(),u=Ai(Df(h.lessThan(zi(4)),n,Df(h.equal(zi(12)).or(h.equal(zi(14))),a,i))).toVar();return Uf(l,Ci(h.bitAnd(zi(1)))).add(Uf(u,Ci(h.bitAnd(zi(2)))))}).setLayout({name:"mx_gradient_float_1",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]}),Yf=Fm([Gf,Xf]),Zf=Ni(([t,e,s])=>{const r=Ai(s).toVar(),i=Ai(e).toVar(),n=Fi(t).toVar();return Oi(Yf(n.x,i,r),Yf(n.y,i,r),Yf(n.z,i,r))}).setLayout({name:"mx_gradient_vec3_0",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"}]}),$f=Ni(([t,e,s,r])=>{const i=Ai(r).toVar(),n=Ai(s).toVar(),a=Ai(e).toVar(),o=Fi(t).toVar();return Oi(Yf(o.x,a,n,i),Yf(o.y,a,n,i),Yf(o.z,a,n,i))}).setLayout({name:"mx_gradient_vec3_1",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]}),Jf=Fm([Zf,$f]),Kf=Ni(([t])=>{const e=Ai(t).toVar();return qn(.6616,e)}).setLayout({name:"mx_gradient_scale2d_0",type:"float",inputs:[{name:"v",type:"float"}]}),Qf=Ni(([t])=>{const e=Ai(t).toVar();return qn(.982,e)}).setLayout({name:"mx_gradient_scale3d_0",type:"float",inputs:[{name:"v",type:"float"}]}),tx=Fm([Kf,Ni(([t])=>{const e=Oi(t).toVar();return qn(.6616,e)}).setLayout({name:"mx_gradient_scale2d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]})]),ex=Fm([Qf,Ni(([t])=>{const e=Oi(t).toVar();return qn(.982,e)}).setLayout({name:"mx_gradient_scale3d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]})]),sx=Ni(([t,e])=>{const s=Vi(e).toVar(),r=zi(t).toVar();return r.shiftLeft(s).bitOr(r.shiftRight(Vi(32).sub(s)))}).setLayout({name:"mx_rotl32",type:"uint",inputs:[{name:"x",type:"uint"},{name:"k",type:"int"}]}),rx=Ni(([t,e,s])=>{t.subAssign(s),t.bitXorAssign(sx(s,Vi(4))),s.addAssign(e),e.subAssign(t),e.bitXorAssign(sx(t,Vi(6))),t.addAssign(s),s.subAssign(e),s.bitXorAssign(sx(e,Vi(8))),e.addAssign(t),t.subAssign(s),t.bitXorAssign(sx(s,Vi(16))),s.addAssign(e),e.subAssign(t),e.bitXorAssign(sx(t,Vi(19))),t.addAssign(s),s.subAssign(e),s.bitXorAssign(sx(e,Vi(4))),e.addAssign(t)}),ix=Ni(([t,e,s])=>{const r=zi(s).toVar(),i=zi(e).toVar(),n=zi(t).toVar();return r.bitXorAssign(i),r.subAssign(sx(i,Vi(14))),n.bitXorAssign(r),n.subAssign(sx(r,Vi(11))),i.bitXorAssign(n),i.subAssign(sx(n,Vi(25))),r.bitXorAssign(i),r.subAssign(sx(i,Vi(16))),n.bitXorAssign(r),n.subAssign(sx(r,Vi(4))),i.bitXorAssign(n),i.subAssign(sx(n,Vi(14))),r.bitXorAssign(i),r.subAssign(sx(i,Vi(24))),r}).setLayout({name:"mx_bjfinal",type:"uint",inputs:[{name:"a",type:"uint"},{name:"b",type:"uint"},{name:"c",type:"uint"}]}),nx=Ni(([t])=>{const e=zi(t).toVar();return Ai(e).div(Ai(zi(Vi(4294967295))))}).setLayout({name:"mx_bits_to_01",type:"float",inputs:[{name:"bits",type:"uint"}]}),ax=Ni(([t])=>{const e=Ai(t).toVar();return e.mul(e).mul(e).mul(e.mul(e.mul(6).sub(15)).add(10))}).setLayout({name:"mx_fade",type:"float",inputs:[{name:"t",type:"float"}]}),ox=Fm([Ni(([t])=>{const e=Vi(t).toVar(),s=zi(zi(1)).toVar(),r=zi(zi(Vi(3735928559)).add(s.shiftLeft(zi(2))).add(zi(13))).toVar();return ix(r.add(zi(e)),r,r)}).setLayout({name:"mx_hash_int_0",type:"uint",inputs:[{name:"x",type:"int"}]}),Ni(([t,e])=>{const s=Vi(e).toVar(),r=Vi(t).toVar(),i=zi(zi(2)).toVar(),n=zi().toVar(),a=zi().toVar(),o=zi().toVar();return n.assign(a.assign(o.assign(zi(Vi(3735928559)).add(i.shiftLeft(zi(2))).add(zi(13))))),n.addAssign(zi(r)),a.addAssign(zi(s)),ix(n,a,o)}).setLayout({name:"mx_hash_int_1",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),Ni(([t,e,s])=>{const r=Vi(s).toVar(),i=Vi(e).toVar(),n=Vi(t).toVar(),a=zi(zi(3)).toVar(),o=zi().toVar(),h=zi().toVar(),l=zi().toVar();return o.assign(h.assign(l.assign(zi(Vi(3735928559)).add(a.shiftLeft(zi(2))).add(zi(13))))),o.addAssign(zi(n)),h.addAssign(zi(i)),l.addAssign(zi(r)),ix(o,h,l)}).setLayout({name:"mx_hash_int_2",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]}),Ni(([t,e,s,r])=>{const i=Vi(r).toVar(),n=Vi(s).toVar(),a=Vi(e).toVar(),o=Vi(t).toVar(),h=zi(zi(4)).toVar(),l=zi().toVar(),u=zi().toVar(),c=zi().toVar();return l.assign(u.assign(c.assign(zi(Vi(3735928559)).add(h.shiftLeft(zi(2))).add(zi(13))))),l.addAssign(zi(o)),u.addAssign(zi(a)),c.addAssign(zi(n)),rx(l,u,c),l.addAssign(zi(i)),ix(l,u,c)}).setLayout({name:"mx_hash_int_3",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"}]}),Ni(([t,e,s,r,i])=>{const n=Vi(i).toVar(),a=Vi(r).toVar(),o=Vi(s).toVar(),h=Vi(e).toVar(),l=Vi(t).toVar(),u=zi(zi(5)).toVar(),c=zi().toVar(),d=zi().toVar(),p=zi().toVar();return c.assign(d.assign(p.assign(zi(Vi(3735928559)).add(u.shiftLeft(zi(2))).add(zi(13))))),c.addAssign(zi(l)),d.addAssign(zi(h)),p.addAssign(zi(o)),rx(c,d,p),c.addAssign(zi(a)),d.addAssign(zi(n)),ix(c,d,p)}).setLayout({name:"mx_hash_int_4",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"},{name:"yy",type:"int"}]})]),hx=Fm([Ni(([t,e])=>{const s=Vi(e).toVar(),r=Vi(t).toVar(),i=zi(ox(r,s)).toVar(),n=Fi().toVar();return n.x.assign(i.bitAnd(Vi(255))),n.y.assign(i.shiftRight(Vi(8)).bitAnd(Vi(255))),n.z.assign(i.shiftRight(Vi(16)).bitAnd(Vi(255))),n}).setLayout({name:"mx_hash_vec3_0",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),Ni(([t,e,s])=>{const r=Vi(s).toVar(),i=Vi(e).toVar(),n=Vi(t).toVar(),a=zi(ox(n,i,r)).toVar(),o=Fi().toVar();return o.x.assign(a.bitAnd(Vi(255))),o.y.assign(a.shiftRight(Vi(8)).bitAnd(Vi(255))),o.z.assign(a.shiftRight(Vi(16)).bitAnd(Vi(255))),o}).setLayout({name:"mx_hash_vec3_1",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]})]),lx=Fm([Ni(([t])=>{const e=Ii(t).toVar(),s=Vi().toVar(),r=Vi().toVar(),i=Ai(jf(e.x,s)).toVar(),n=Ai(jf(e.y,r)).toVar(),a=Ai(ax(i)).toVar(),o=Ai(ax(n)).toVar(),h=Ai(qf(Yf(ox(s,r),i,n),Yf(ox(s.add(Vi(1)),r),i.sub(1),n),Yf(ox(s,r.add(Vi(1))),i,n.sub(1)),Yf(ox(s.add(Vi(1)),r.add(Vi(1))),i.sub(1),n.sub(1)),a,o)).toVar();return tx(h)}).setLayout({name:"mx_perlin_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"}]}),Ni(([t])=>{const e=Oi(t).toVar(),s=Vi().toVar(),r=Vi().toVar(),i=Vi().toVar(),n=Ai(jf(e.x,s)).toVar(),a=Ai(jf(e.y,r)).toVar(),o=Ai(jf(e.z,i)).toVar(),h=Ai(ax(n)).toVar(),l=Ai(ax(a)).toVar(),u=Ai(ax(o)).toVar(),c=Ai(Hf(Yf(ox(s,r,i),n,a,o),Yf(ox(s.add(Vi(1)),r,i),n.sub(1),a,o),Yf(ox(s,r.add(Vi(1)),i),n,a.sub(1),o),Yf(ox(s.add(Vi(1)),r.add(Vi(1)),i),n.sub(1),a.sub(1),o),Yf(ox(s,r,i.add(Vi(1))),n,a,o.sub(1)),Yf(ox(s.add(Vi(1)),r,i.add(Vi(1))),n.sub(1),a,o.sub(1)),Yf(ox(s,r.add(Vi(1)),i.add(Vi(1))),n,a.sub(1),o.sub(1)),Yf(ox(s.add(Vi(1)),r.add(Vi(1)),i.add(Vi(1))),n.sub(1),a.sub(1),o.sub(1)),h,l,u)).toVar();return ex(c)}).setLayout({name:"mx_perlin_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"}]})]),ux=Fm([Ni(([t])=>{const e=Ii(t).toVar(),s=Vi().toVar(),r=Vi().toVar(),i=Ai(jf(e.x,s)).toVar(),n=Ai(jf(e.y,r)).toVar(),a=Ai(ax(i)).toVar(),o=Ai(ax(n)).toVar(),h=Oi(qf(Jf(hx(s,r),i,n),Jf(hx(s.add(Vi(1)),r),i.sub(1),n),Jf(hx(s,r.add(Vi(1))),i,n.sub(1)),Jf(hx(s.add(Vi(1)),r.add(Vi(1))),i.sub(1),n.sub(1)),a,o)).toVar();return tx(h)}).setLayout({name:"mx_perlin_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"}]}),Ni(([t])=>{const e=Oi(t).toVar(),s=Vi().toVar(),r=Vi().toVar(),i=Vi().toVar(),n=Ai(jf(e.x,s)).toVar(),a=Ai(jf(e.y,r)).toVar(),o=Ai(jf(e.z,i)).toVar(),h=Ai(ax(n)).toVar(),l=Ai(ax(a)).toVar(),u=Ai(ax(o)).toVar(),c=Oi(Hf(Jf(hx(s,r,i),n,a,o),Jf(hx(s.add(Vi(1)),r,i),n.sub(1),a,o),Jf(hx(s,r.add(Vi(1)),i),n,a.sub(1),o),Jf(hx(s.add(Vi(1)),r.add(Vi(1)),i),n.sub(1),a.sub(1),o),Jf(hx(s,r,i.add(Vi(1))),n,a,o.sub(1)),Jf(hx(s.add(Vi(1)),r,i.add(Vi(1))),n.sub(1),a,o.sub(1)),Jf(hx(s,r.add(Vi(1)),i.add(Vi(1))),n,a.sub(1),o.sub(1)),Jf(hx(s.add(Vi(1)),r.add(Vi(1)),i.add(Vi(1))),n.sub(1),a.sub(1),o.sub(1)),h,l,u)).toVar();return ex(c)}).setLayout({name:"mx_perlin_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"}]})]),cx=Fm([Ni(([t])=>{const e=Ai(t).toVar(),s=Vi(Wf(e)).toVar();return nx(ox(s))}).setLayout({name:"mx_cell_noise_float_0",type:"float",inputs:[{name:"p",type:"float"}]}),Ni(([t])=>{const e=Ii(t).toVar(),s=Vi(Wf(e.x)).toVar(),r=Vi(Wf(e.y)).toVar();return nx(ox(s,r))}).setLayout({name:"mx_cell_noise_float_1",type:"float",inputs:[{name:"p",type:"vec2"}]}),Ni(([t])=>{const e=Oi(t).toVar(),s=Vi(Wf(e.x)).toVar(),r=Vi(Wf(e.y)).toVar(),i=Vi(Wf(e.z)).toVar();return nx(ox(s,r,i))}).setLayout({name:"mx_cell_noise_float_2",type:"float",inputs:[{name:"p",type:"vec3"}]}),Ni(([t])=>{const e=ki(t).toVar(),s=Vi(Wf(e.x)).toVar(),r=Vi(Wf(e.y)).toVar(),i=Vi(Wf(e.z)).toVar(),n=Vi(Wf(e.w)).toVar();return nx(ox(s,r,i,n))}).setLayout({name:"mx_cell_noise_float_3",type:"float",inputs:[{name:"p",type:"vec4"}]})]),dx=Fm([Ni(([t])=>{const e=Ai(t).toVar(),s=Vi(Wf(e)).toVar();return Oi(nx(ox(s,Vi(0))),nx(ox(s,Vi(1))),nx(ox(s,Vi(2))))}).setLayout({name:"mx_cell_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"float"}]}),Ni(([t])=>{const e=Ii(t).toVar(),s=Vi(Wf(e.x)).toVar(),r=Vi(Wf(e.y)).toVar();return Oi(nx(ox(s,r,Vi(0))),nx(ox(s,r,Vi(1))),nx(ox(s,r,Vi(2))))}).setLayout({name:"mx_cell_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec2"}]}),Ni(([t])=>{const e=Oi(t).toVar(),s=Vi(Wf(e.x)).toVar(),r=Vi(Wf(e.y)).toVar(),i=Vi(Wf(e.z)).toVar();return Oi(nx(ox(s,r,i,Vi(0))),nx(ox(s,r,i,Vi(1))),nx(ox(s,r,i,Vi(2))))}).setLayout({name:"mx_cell_noise_vec3_2",type:"vec3",inputs:[{name:"p",type:"vec3"}]}),Ni(([t])=>{const e=ki(t).toVar(),s=Vi(Wf(e.x)).toVar(),r=Vi(Wf(e.y)).toVar(),i=Vi(Wf(e.z)).toVar(),n=Vi(Wf(e.w)).toVar();return Oi(nx(ox(s,r,i,n,Vi(0))),nx(ox(s,r,i,n,Vi(1))),nx(ox(s,r,i,n,Vi(2))))}).setLayout({name:"mx_cell_noise_vec3_3",type:"vec3",inputs:[{name:"p",type:"vec4"}]})]),px=Ni(([t,e,s,r])=>{const i=Ai(r).toVar(),n=Ai(s).toVar(),a=Vi(e).toVar(),o=Oi(t).toVar(),h=Ai(0).toVar(),l=Ai(1).toVar();return Jc(a,()=>{h.addAssign(l.mul(lx(o))),l.mulAssign(i),o.mulAssign(n)}),h}).setLayout({name:"mx_fractal_noise_float",type:"float",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),mx=Ni(([t,e,s,r])=>{const i=Ai(r).toVar(),n=Ai(s).toVar(),a=Vi(e).toVar(),o=Oi(t).toVar(),h=Oi(0).toVar(),l=Ai(1).toVar();return Jc(a,()=>{h.addAssign(l.mul(ux(o))),l.mulAssign(i),o.mulAssign(n)}),h}).setLayout({name:"mx_fractal_noise_vec3",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),gx=Ni(([t,e,s,r])=>{const i=Ai(r).toVar(),n=Ai(s).toVar(),a=Vi(e).toVar(),o=Oi(t).toVar();return Ii(px(o,a,n,i),px(o.add(Oi(Vi(19),Vi(193),Vi(17))),a,n,i))}).setLayout({name:"mx_fractal_noise_vec2",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),yx=Ni(([t,e,s,r])=>{const i=Ai(r).toVar(),n=Ai(s).toVar(),a=Vi(e).toVar(),o=Oi(t).toVar(),h=Oi(mx(o,a,n,i)).toVar(),l=Ai(px(o.add(Oi(Vi(19),Vi(193),Vi(17))),a,n,i)).toVar();return ki(h,l)}).setLayout({name:"mx_fractal_noise_vec4",type:"vec4",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),fx=Ni(([t,e,s,r,i,n,a])=>{const o=Vi(a).toVar(),h=Ai(n).toVar(),l=Vi(i).toVar(),u=Vi(r).toVar(),c=Vi(s).toVar(),d=Vi(e).toVar(),p=Ii(t).toVar(),m=Oi(dx(Ii(d.add(u),c.add(l)))).toVar(),g=Ii(m.x,m.y).toVar();g.subAssign(.5),g.mulAssign(h),g.addAssign(.5);const y=Ii(Ii(Ai(d),Ai(c)).add(g)).toVar(),f=Ii(y.sub(p)).toVar();return Mi(o.equal(Vi(2)),()=>ka(f.x).add(ka(f.y))),Mi(o.equal(Vi(3)),()=>so(ka(f.x),ka(f.y))),oo(f,f)}).setLayout({name:"mx_worley_distance_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),xx=Fm([fx,Ni(([t,e,s,r,i,n,a,o,h])=>{const l=Vi(h).toVar(),u=Ai(o).toVar(),c=Vi(a).toVar(),d=Vi(n).toVar(),p=Vi(i).toVar(),m=Vi(r).toVar(),g=Vi(s).toVar(),y=Vi(e).toVar(),f=Oi(t).toVar(),x=Oi(dx(Oi(y.add(p),g.add(d),m.add(c)))).toVar();x.subAssign(.5),x.mulAssign(u),x.addAssign(.5);const b=Oi(Oi(Ai(y),Ai(g),Ai(m)).add(x)).toVar(),v=Oi(b.sub(f)).toVar();return Mi(l.equal(Vi(2)),()=>ka(v.x).add(ka(v.y)).add(ka(v.z))),Mi(l.equal(Vi(3)),()=>so(ka(v.x),ka(v.y),ka(v.z))),oo(v,v)}).setLayout({name:"mx_worley_distance_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"zoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),bx=Ni(([t,e,s])=>{const r=Vi(s).toVar(),i=Ai(e).toVar(),n=Ii(t).toVar(),a=Vi().toVar(),o=Vi().toVar(),h=Ii(jf(n.x,a),jf(n.y,o)).toVar(),l=Ai(1e6).toVar();return Jc({start:-1,end:Vi(1),name:"x",condition:"<="},({x:t})=>{Jc({start:-1,end:Vi(1),name:"y",condition:"<="},({y:e})=>{const s=Ai(xx(h,t,e,a,o,i,r)).toVar();l.assign(eo(l,s))})}),Mi(r.equal(Vi(0)),()=>{l.assign(Aa(l))}),l}).setLayout({name:"mx_worley_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),vx=Ni(([t,e,s])=>{const r=Vi(s).toVar(),i=Ai(e).toVar(),n=Ii(t).toVar(),a=Vi().toVar(),o=Vi().toVar(),h=Ii(jf(n.x,a),jf(n.y,o)).toVar(),l=Ii(1e6,1e6).toVar();return Jc({start:-1,end:Vi(1),name:"x",condition:"<="},({x:t})=>{Jc({start:-1,end:Vi(1),name:"y",condition:"<="},({y:e})=>{const s=Ai(xx(h,t,e,a,o,i,r)).toVar();Mi(s.lessThan(l.x),()=>{l.y.assign(l.x),l.x.assign(s)}).ElseIf(s.lessThan(l.y),()=>{l.y.assign(s)})})}),Mi(r.equal(Vi(0)),()=>{l.assign(Aa(l))}),l}).setLayout({name:"mx_worley_noise_vec2_0",type:"vec2",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),Nx=Ni(([t,e,s])=>{const r=Vi(s).toVar(),i=Ai(e).toVar(),n=Ii(t).toVar(),a=Vi().toVar(),o=Vi().toVar(),h=Ii(jf(n.x,a),jf(n.y,o)).toVar(),l=Oi(1e6,1e6,1e6).toVar();return Jc({start:-1,end:Vi(1),name:"x",condition:"<="},({x:t})=>{Jc({start:-1,end:Vi(1),name:"y",condition:"<="},({y:e})=>{const s=Ai(xx(h,t,e,a,o,i,r)).toVar();Mi(s.lessThan(l.x),()=>{l.z.assign(l.y),l.y.assign(l.x),l.x.assign(s)}).ElseIf(s.lessThan(l.y),()=>{l.z.assign(l.y),l.y.assign(s)}).ElseIf(s.lessThan(l.z),()=>{l.z.assign(s)})})}),Mi(r.equal(Vi(0)),()=>{l.assign(Aa(l))}),l}).setLayout({name:"mx_worley_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),wx=Fm([bx,Ni(([t,e,s])=>{const r=Vi(s).toVar(),i=Ai(e).toVar(),n=Oi(t).toVar(),a=Vi().toVar(),o=Vi().toVar(),h=Vi().toVar(),l=Oi(jf(n.x,a),jf(n.y,o),jf(n.z,h)).toVar(),u=Ai(1e6).toVar();return Jc({start:-1,end:Vi(1),name:"x",condition:"<="},({x:t})=>{Jc({start:-1,end:Vi(1),name:"y",condition:"<="},({y:e})=>{Jc({start:-1,end:Vi(1),name:"z",condition:"<="},({z:s})=>{const n=Ai(xx(l,t,e,s,a,o,h,i,r)).toVar();u.assign(eo(u,n))})})}),Mi(r.equal(Vi(0)),()=>{u.assign(Aa(u))}),u}).setLayout({name:"mx_worley_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),Tx=Fm([vx,Ni(([t,e,s])=>{const r=Vi(s).toVar(),i=Ai(e).toVar(),n=Oi(t).toVar(),a=Vi().toVar(),o=Vi().toVar(),h=Vi().toVar(),l=Oi(jf(n.x,a),jf(n.y,o),jf(n.z,h)).toVar(),u=Ii(1e6,1e6).toVar();return Jc({start:-1,end:Vi(1),name:"x",condition:"<="},({x:t})=>{Jc({start:-1,end:Vi(1),name:"y",condition:"<="},({y:e})=>{Jc({start:-1,end:Vi(1),name:"z",condition:"<="},({z:s})=>{const n=Ai(xx(l,t,e,s,a,o,h,i,r)).toVar();Mi(n.lessThan(u.x),()=>{u.y.assign(u.x),u.x.assign(n)}).ElseIf(n.lessThan(u.y),()=>{u.y.assign(n)})})})}),Mi(r.equal(Vi(0)),()=>{u.assign(Aa(u))}),u}).setLayout({name:"mx_worley_noise_vec2_1",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),Mx=Fm([Nx,Ni(([t,e,s])=>{const r=Vi(s).toVar(),i=Ai(e).toVar(),n=Oi(t).toVar(),a=Vi().toVar(),o=Vi().toVar(),h=Vi().toVar(),l=Oi(jf(n.x,a),jf(n.y,o),jf(n.z,h)).toVar(),u=Oi(1e6,1e6,1e6).toVar();return Jc({start:-1,end:Vi(1),name:"x",condition:"<="},({x:t})=>{Jc({start:-1,end:Vi(1),name:"y",condition:"<="},({y:e})=>{Jc({start:-1,end:Vi(1),name:"z",condition:"<="},({z:s})=>{const n=Ai(xx(l,t,e,s,a,o,h,i,r)).toVar();Mi(n.lessThan(u.x),()=>{u.z.assign(u.y),u.y.assign(u.x),u.x.assign(n)}).ElseIf(n.lessThan(u.y),()=>{u.z.assign(u.y),u.y.assign(n)}).ElseIf(n.lessThan(u.z),()=>{u.z.assign(n)})})})}),Mi(r.equal(Vi(0)),()=>{u.assign(Aa(u))}),u}).setLayout({name:"mx_worley_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),_x=Ni(([t,e,s,r,i,n,a,o,h,l,u])=>{const c=Vi(t).toVar(),d=Ii(e).toVar(),p=Ii(s).toVar(),m=Ii(r).toVar(),g=Ai(i).toVar(),y=Ai(n).toVar(),f=Ai(a).toVar(),x=Ci(o).toVar(),b=Vi(h).toVar(),v=Ai(l).toVar(),N=Ai(u).toVar(),w=d.mul(p).add(m),T=Ai(0).toVar();return Mi(c.equal(Vi(0)),()=>{T.assign(ux(w))}),Mi(c.equal(Vi(1)),()=>{T.assign(dx(w))}),Mi(c.equal(Vi(2)),()=>{T.assign(Mx(w,g,Vi(0)))}),Mi(c.equal(Vi(3)),()=>{T.assign(mx(Oi(w,0),b,v,N))}),T.assign(T.mul(f.sub(y)).add(y)),Mi(x,()=>{T.assign(xo(T,y,f))}),T}).setLayout({name:"mx_unifiednoise2d",type:"float",inputs:[{name:"noiseType",type:"int"},{name:"texcoord",type:"vec2"},{name:"freq",type:"vec2"},{name:"offset",type:"vec2"},{name:"jitter",type:"float"},{name:"outmin",type:"float"},{name:"outmax",type:"float"},{name:"clampoutput",type:"bool"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),Sx=Ni(([t,e,s,r,i,n,a,o,h,l,u])=>{const c=Vi(t).toVar(),d=Oi(e).toVar(),p=Oi(s).toVar(),m=Oi(r).toVar(),g=Ai(i).toVar(),y=Ai(n).toVar(),f=Ai(a).toVar(),x=Ci(o).toVar(),b=Vi(h).toVar(),v=Ai(l).toVar(),N=Ai(u).toVar(),w=d.mul(p).add(m),T=Ai(0).toVar();return Mi(c.equal(Vi(0)),()=>{T.assign(ux(w))}),Mi(c.equal(Vi(1)),()=>{T.assign(dx(w))}),Mi(c.equal(Vi(2)),()=>{T.assign(Mx(w,g,Vi(0)))}),Mi(c.equal(Vi(3)),()=>{T.assign(mx(w,b,v,N))}),T.assign(T.mul(f.sub(y)).add(y)),Mi(x,()=>{T.assign(xo(T,y,f))}),T}).setLayout({name:"mx_unifiednoise3d",type:"float",inputs:[{name:"noiseType",type:"int"},{name:"position",type:"vec3"},{name:"freq",type:"vec3"},{name:"offset",type:"vec3"},{name:"jitter",type:"float"},{name:"outmin",type:"float"},{name:"outmax",type:"float"},{name:"clampoutput",type:"bool"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),Ax=Ni(([t])=>{const e=t.y,s=t.z,r=Oi().toVar();return Mi(e.lessThan(1e-4),()=>{r.assign(Oi(s,s,s))}).Else(()=>{let i=t.x;i=i.sub(za(i)).mul(6).toVar();const n=Vi(Ya(i)),a=i.sub(Ai(n)),o=s.mul(e.oneMinus()),h=s.mul(e.mul(a).oneMinus()),l=s.mul(e.mul(a.oneMinus()).oneMinus());Mi(n.equal(Vi(0)),()=>{r.assign(Oi(s,l,o))}).ElseIf(n.equal(Vi(1)),()=>{r.assign(Oi(h,s,o))}).ElseIf(n.equal(Vi(2)),()=>{r.assign(Oi(o,s,l))}).ElseIf(n.equal(Vi(3)),()=>{r.assign(Oi(o,h,s))}).ElseIf(n.equal(Vi(4)),()=>{r.assign(Oi(l,o,s))}).Else(()=>{r.assign(Oi(s,o,h))})}),r}).setLayout({name:"mx_hsvtorgb",type:"vec3",inputs:[{name:"hsv",type:"vec3"}]}),Vx=Ni(([t])=>{const e=Oi(t).toVar(),s=Ai(e.x).toVar(),r=Ai(e.y).toVar(),i=Ai(e.z).toVar(),n=Ai(eo(s,eo(r,i))).toVar(),a=Ai(so(s,so(r,i))).toVar(),o=Ai(a.sub(n)).toVar(),h=Ai().toVar(),l=Ai().toVar(),u=Ai().toVar();return u.assign(a),Mi(a.greaterThan(0),()=>{l.assign(o.div(a))}).Else(()=>{l.assign(0)}),Mi(l.lessThanEqual(0),()=>{h.assign(0)}).Else(()=>{Mi(s.greaterThanEqual(a),()=>{h.assign(r.sub(i).div(o))}).ElseIf(r.greaterThanEqual(a),()=>{h.assign(Wn(2,i.sub(s).div(o)))}).Else(()=>{h.assign(Wn(4,s.sub(r).div(o)))}),h.mulAssign(1/6),Mi(h.lessThan(0),()=>{h.addAssign(1)})}),Oi(h,l,u)}).setLayout({name:"mx_rgbtohsv",type:"vec3",inputs:[{name:"c",type:"vec3"}]}),zx=Ni(([t])=>{const e=Oi(t).toVar(),s=Bi($n(e,Oi(.04045))).toVar(),r=Oi(e.div(12.92)).toVar(),i=Oi(lo(so(e.add(Oi(.055)),Oi(0)).div(1.055),Oi(2.4))).toVar();return fo(r,i,s)}).setLayout({name:"mx_srgb_texture_to_lin_rec709",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),Cx=(t,e)=>{t=Ai(t),e=Ai(e);const s=Ii(e.dFdx(),e.dFdy()).length().mul(.7071067811865476);return No(t.sub(s),t.add(s),e)},Ix=(t,e,s,r)=>fo(t,e,s[r].clamp()),Rx=(t,e,s,r,i)=>fo(t,e,Cx(s,r[i])),Ex=Ni(([t,e,s])=>{const r=Ia(t).toVar(),i=jn(Ai(.5).mul(e.sub(s)),_l).div(r).toVar(),n=jn(Ai(-.5).mul(e.sub(s)),_l).div(r).toVar(),a=Oi().toVar();a.x=r.x.greaterThan(Ai(0)).select(i.x,n.x),a.y=r.y.greaterThan(Ai(0)).select(i.y,n.y),a.z=r.z.greaterThan(Ai(0)).select(i.z,n.z);const o=eo(a.x,a.y,a.z).toVar();return _l.add(r.mul(o)).toVar().sub(s)}),Lx=Ni(([t,e])=>{const s=t.x,r=t.y,i=t.z;let n=e.element(0).mul(.886227);return n=n.add(e.element(1).mul(1.023328).mul(r)),n=n.add(e.element(2).mul(1.023328).mul(i)),n=n.add(e.element(3).mul(1.023328).mul(s)),n=n.add(e.element(4).mul(.858086).mul(s).mul(r)),n=n.add(e.element(5).mul(.858086).mul(r).mul(i)),n=n.add(e.element(6).mul(i.mul(i).mul(.743125).sub(.247708))),n=n.add(e.element(7).mul(.858086).mul(s).mul(i)),n=n.add(e.element(8).mul(.429043).mul(qn(s,s).sub(qn(r,r)))),n});var Ox=Object.freeze({__proto__:null,BRDF_GGX:lp,BRDF_Lambert:ep,BasicPointShadowFilter:Cf,BasicShadowFilter:pf,Break:Kc,Const:ko,Continue:()=>wh("continue").toStack(),DFGApprox:up,D_GGX:ap,Discard:Th,EPSILON:ga,F_Schlick:tp,Fn:Ni,INFINITY:ya,If:Mi,Loop:Jc,NodeAccess:br,NodeShaderStage:fr,NodeType:{BOOLEAN:"bool",INTEGER:"int",FLOAT:"float",VECTOR2:"vec2",VECTOR3:"vec3",VECTOR4:"vec4",MATRIX2:"mat2",MATRIX3:"mat3",MATRIX4:"mat4"},NodeUpdateType:xr,OnMaterialUpdate:t=>wg(Ng.MATERIAL,t),OnObjectUpdate:t=>wg(Ng.OBJECT,t),PCFShadowFilter:mf,PCFSoftShadowFilter:gf,PI:fa,PI2:xa,PointShadowFilter:If,Return:()=>wh("return").toStack(),Schlick_to_F0:cp,ScriptableNodeResources:Ny,ShaderNode:di,Stack:_i,Switch:(...t)=>Br.Switch(...t),TBNViewMatrix:Lu,VSMShadowFilter:yf,V_GGX_SmithCorrelated:ip,Var:Bo,VarIntent:Do,abs:ka,acesFilmicToneMapping:oy,acos:Fa,add:Wn,addMethodChaining:Dr,addNodeElement:function(t){},agxToneMapping:cy,all:ba,alphaT:ln,and:Qn,anisotropy:un,anisotropyB:dn,anisotropyT:cn,any:va,append:t=>_i(t),array:On,arrayBuffer:t=>pi(new Pr(t,"ArrayBuffer")),asin:Pa,assign:Fn,atan:Ba,atan2:Ao,atomicAdd:(t,e)=>qy(Wy.ATOMIC_ADD,t,e),atomicAnd:(t,e)=>qy(Wy.ATOMIC_AND,t,e),atomicFunc:qy,atomicLoad:t=>qy(Wy.ATOMIC_LOAD,t,null),atomicMax:(t,e)=>qy(Wy.ATOMIC_MAX,t,e),atomicMin:(t,e)=>qy(Wy.ATOMIC_MIN,t,e),atomicOr:(t,e)=>qy(Wy.ATOMIC_OR,t,e),atomicStore:(t,e)=>qy(Wy.ATOMIC_STORE,t,e),atomicSub:(t,e)=>qy(Wy.ATOMIC_SUB,t,e),atomicXor:(t,e)=>qy(Wy.ATOMIC_XOR,t,e),attenuationColor:Mn,attenuationDistance:Tn,attribute:zh,attributeArray:(t,e="float")=>{let s,r;!0===e.isStruct?(s=e.layout.getLength(),r=hr("float")):(s=lr(e),r=hr(e));const i=new Mg(t,s,r);return Gc(i,e,t)},backgroundBlurriness:Cg,backgroundIntensity:Ig,backgroundRotation:Rg,batch:Wc,bentNormalView:Pu,billboarding:jm,bitAnd:ra,bitNot:ia,bitOr:na,bitXor:aa,bitangentGeometry:Cu,bitangentLocal:Iu,bitangentView:Ru,bitangentWorld:Eu,bitcast:Qa,blendBurn:Wd,blendColor:Gd,blendDodge:jd,blendOverlay:Hd,blendScreen:qd,blur:jp,bool:Ci,buffer:Uh,bufferAttribute:oh,bumpMap:Wu,burn:(...t)=>Wd(t),bvec2:Li,bvec3:Bi,bvec4:Wi,bypass:fh,cache:gh,call:kn,cameraFar:Yh,cameraIndex:Gh,cameraNear:Xh,cameraNormalMatrix:Qh,cameraPosition:tl,cameraProjectionMatrix:Zh,cameraProjectionMatrixInverse:$h,cameraViewMatrix:Jh,cameraWorldMatrix:Kh,cbrt:go,cdl:Zg,ceil:Ca,checker:Bf,cineonToneMapping:ny,clamp:xo,clearcoat:en,clearcoatNormalView:Dl,clearcoatRoughness:sn,code:my,color:Si,colorSpaceToWorking:Ko,colorToDirection:t=>pi(t).mul(2).sub(1),compute:ph,computeKernel:dh,computeSkinning:(t,e=null)=>{const s=new Yc(t);return s.positionNode=Gc(new Ss(t.geometry.getAttribute("position").array,3),"vec3").setPBO(!0).toReadOnly().element(Rc).toVar(),s.skinIndexNode=Gc(new Ss(new Uint32Array(t.geometry.getAttribute("skinIndex").array),4),"uvec4").setPBO(!0).toReadOnly().element(Rc).toVar(),s.skinWeightNode=Gc(new Ss(t.geometry.getAttribute("skinWeight").array,4),"vec4").setPBO(!0).toReadOnly().element(Rc).toVar(),s.bindMatrixNode=En(t.bindMatrix,"mat4"),s.bindMatrixInverseNode=En(t.bindMatrixInverse,"mat4"),s.boneMatricesNode=Uh(t.skeleton.boneMatrices,"mat4",t.skeleton.bones.length),s.toPositionNode=e,pi(s)},context:Eo,convert:Xi,convertColorSpace:(t,e,s)=>pi(new $o(pi(t),e,s)),convertToTexture:(t,...e)=>t.isTextureNode?t:t.isPassNode?t.getTextureNode():yg(t,...e),cos:La,cross:ho,cubeTexture:iu,cubeTextureBase:ru,cubeToUV:zf,dFdx:qa,dFdy:Ha,dashSize:fn,debug:Ah,decrement:da,decrementBefore:ua,defaultBuildStages:["setup","analyze","generate"],defaultShaderStages:vr,defined:ui,degrees:wa,deltaTime:km,densityFog:function(t,e){return Ay(t,Sy(e))},densityFogFactor:Sy,depth:Ed,depthPass:(t,e,s)=>pi(new ey(ey.DEPTH,t,e,s)),determinant:Ja,difference:ao,diffuseColor:Ji,directPointLight:({color:t,lightVector:e,cutoffDistance:s,decayExponent:r})=>{const i=e.normalize(),n=e.length(),a=Ff({lightDistance:n,cutoffDistance:s,decayExponent:r});return{lightDirection:i,lightColor:t.mul(a)}},directionToColor:t=>pi(t).mul(.5).add(.5),directionToFaceDirection:Rl,dispersion:_n,distance:no,div:Hn,dodge:(...t)=>jd(t),dot:oo,drawIndex:Pc,dynamicBufferAttribute:hh,element:Gi,emissive:Ki,equal:Xn,equals:to,equirectUV:Qd,exp:Ta,exp2:Ma,expression:wh,faceDirection:Il,faceForward:wo,faceforward:Vo,float:Ai,floor:za,fog:Ay,fract:Ra,frameGroup:zn,frameId:Dm,frontFacing:Cl,fwidth:Za,gain:(t,e)=>t.lessThan(.5)?Im(t.mul(2),e).div(2):jn(1,Im(qn(jn(1,t),2),e).div(2)),gapSize:xn,getConstNodeType:ci,getCurrentStack:Ti,getDirection:kp,getDistanceAttenuation:Ff,getGeometryRoughness:sp,getNormalFromDepth:bg,getParallaxCorrectNormal:Ex,getRoughness:rp,getScreenPosition:xg,getShIrradianceAt:Lx,getShadowMaterial:xf,getShadowRenderObjectFunction:Nf,getTextureIndex:Am,getViewPosition:fg,globalId:Py,glsl:(t,e)=>my(t,e,"glsl"),glslFn:(t,e)=>yy(t,e,"glsl"),grayscale:qg,greaterThan:$n,greaterThanEqual:Kn,hash:Cm,highpModelNormalViewMatrix:Nl,highpModelViewMatrix:vl,hue:Xg,increment:ca,incrementBefore:la,instance:Bc,instanceIndex:Rc,instancedArray:(t,e="float")=>{let s,r;!0===e.isStruct?(s=e.layout.getLength(),r=hr("float")):(s=lr(e),r=hr(e));const i=new Tg(t,s,r);return Gc(i,e,t)},instancedBufferAttribute:lh,instancedDynamicBufferAttribute:uh,instancedMesh:Dc,int:Vi,inverse:Ka,inverseSqrt:Va,inversesqrt:zo,invocationLocalIndex:Oc,invocationSubgroupIndex:Lc,ior:vn,iridescence:an,iridescenceIOR:on,iridescenceThickness:hn,ivec2:Ri,ivec3:Pi,ivec4:Di,js:(t,e)=>my(t,e,"js"),label:Oo,length:Ua,lengthSq:yo,lessThan:Zn,lessThanEqual:Jn,lightPosition:Yy,lightProjectionUV:function(t,e=_l){const s=Xy(t).mul(e);return s.xyz.div(s.w)},lightShadowMatrix:Xy,lightTargetDirection:t=>Jh.transformDirection(Yy(t).sub(Zy(t))),lightTargetPosition:Zy,lightViewPosition:function(t){const e=Gy(t);return e.viewPosition||(e.viewPosition=En(new j).setGroup(Cn).onRenderUpdate(({camera:e},s)=>{s.value=s.value||new j,s.value.setFromMatrixPosition(t.matrixWorld),s.value.applyMatrix4(e.matrixWorldInverse)}))},lightingContext:od,lights:(t=[])=>pi(new Qy).setLights(t),linearDepth:Ld,linearToneMapping:ry,localId:Fy,log:_a,log2:Sa,logarithmicDepthToViewZ:(t,e,s)=>{const r=t.mul(_a(s.div(e)));return Ai(Math.E).pow(r).mul(e).negate()},luminance:Yg,mat2:ji,mat3:qi,mat4:Hi,matcapUV:ym,materialAO:Ac,materialAlphaTest:Hu,materialAnisotropy:uc,materialAnisotropyVector:Vc,materialAttenuationColor:xc,materialAttenuationDistance:fc,materialClearcoat:ic,materialClearcoatNormal:ac,materialClearcoatRoughness:nc,materialColor:Gu,materialDispersion:_c,materialEmissive:Yu,materialEnvIntensity:Zl,materialEnvRotation:$l,materialIOR:yc,materialIridescence:cc,materialIridescenceIOR:dc,materialIridescenceThickness:pc,materialLightMap:Sc,materialLineDashOffset:Tc,materialLineDashSize:vc,materialLineGapSize:Nc,materialLineScale:bc,materialLineWidth:wc,materialMetalness:sc,materialNormal:rc,materialOpacity:Zu,materialPointSize:Mc,materialReference:uu,materialReflectivity:tc,materialRefractionRatio:Yl,materialRotation:oc,materialRoughness:ec,materialSheen:hc,materialSheenRoughness:lc,materialShininess:Xu,materialSpecular:$u,materialSpecularColor:Ku,materialSpecularIntensity:Ju,materialSpecularStrength:Qu,materialThickness:gc,materialTransmission:mc,max:so,maxMipLevel:Lh,mediumpModelViewMatrix:bl,metalness:tn,min:eo,mix:fo,mixElement:Mo,mod:Gn,modInt:pa,modelDirection:ul,modelNormalMatrix:yl,modelPosition:dl,modelRadius:gl,modelScale:pl,modelViewMatrix:xl,modelViewPosition:ml,modelViewProjection:zc,modelWorldMatrix:cl,modelWorldMatrixInverse:fl,morphReference:rd,mrt:zm,mul:qn,mx_aastep:Cx,mx_add:(t,e=Ai(0))=>Wn(t,e),mx_atan2:(t=Ai(0),e=Ai(1))=>Ba(t,e),mx_cell_noise_float:(t=Ch())=>cx(t.convert("vec2|vec3")),mx_contrast:(t,e=1,s=.5)=>Ai(t).sub(s).mul(e).add(s),mx_divide:(t,e=Ai(1))=>Hn(t,e),mx_fractal_noise_float:(t=Ch(),e=3,s=2,r=.5,i=1)=>px(t,Vi(e),s,r).mul(i),mx_fractal_noise_vec2:(t=Ch(),e=3,s=2,r=.5,i=1)=>gx(t,Vi(e),s,r).mul(i),mx_fractal_noise_vec3:(t=Ch(),e=3,s=2,r=.5,i=1)=>mx(t,Vi(e),s,r).mul(i),mx_fractal_noise_vec4:(t=Ch(),e=3,s=2,r=.5,i=1)=>yx(t,Vi(e),s,r).mul(i),mx_frame:()=>Dm,mx_heighttonormal:(t,e)=>(t=Oi(t),e=Ai(e),Wu(t,e)),mx_hsvtorgb:Ax,mx_ifequal:(t,e,s,r)=>t.equal(e).mix(s,r),mx_ifgreater:(t,e,s,r)=>t.greaterThan(e).mix(s,r),mx_ifgreatereq:(t,e,s,r)=>t.greaterThanEqual(e).mix(s,r),mx_invert:(t,e=Ai(1))=>jn(e,t),mx_modulo:(t,e=Ai(1))=>Gn(t,e),mx_multiply:(t,e=Ai(1))=>qn(t,e),mx_noise_float:(t=Ch(),e=1,s=0)=>lx(t.convert("vec2|vec3")).mul(e).add(s),mx_noise_vec3:(t=Ch(),e=1,s=0)=>ux(t.convert("vec2|vec3")).mul(e).add(s),mx_noise_vec4:(t=Ch(),e=1,s=0)=>{t=t.convert("vec2|vec3");return ki(ux(t),lx(t.add(Ii(19,73)))).mul(e).add(s)},mx_place2d:(t,e=Ii(.5,.5),s=Ii(1,1),r=Ai(0),i=Ii(0,0))=>{let n=t;if(e&&(n=n.sub(e)),s&&(n=n.mul(s)),r){const t=r.mul(Math.PI/180),e=t.cos(),s=t.sin();n=Ii(n.x.mul(e).sub(n.y.mul(s)),n.x.mul(s).add(n.y.mul(e)))}return e&&(n=n.add(e)),i&&(n=n.add(i)),n},mx_power:(t,e=Ai(1))=>lo(t,e),mx_ramp4:(t,e,s,r,i=Ch())=>{const n=i.x.clamp(),a=i.y.clamp(),o=fo(t,e,n),h=fo(s,r,n);return fo(o,h,a)},mx_ramplr:(t,e,s=Ch())=>Ix(t,e,s,"x"),mx_ramptb:(t,e,s=Ch())=>Ix(t,e,s,"y"),mx_rgbtohsv:Vx,mx_rotate2d:(t,e)=>{t=Ii(t);const s=(e=Ai(e)).mul(Math.PI/180);return xm(t,s)},mx_rotate3d:(t,e,s)=>{t=Oi(t),e=Ai(e),s=Oi(s);const r=e.mul(Math.PI/180),i=s.normalize(),n=r.cos(),a=r.sin(),o=Ai(1).sub(n);return t.mul(n).add(i.cross(t).mul(a)).add(i.mul(i.dot(t)).mul(o))},mx_safepower:(t,e=1)=>(t=Ai(t)).abs().pow(e).mul(t.sign()),mx_separate:(t,e=null)=>{if("string"==typeof e){const s={x:0,r:0,y:1,g:1,z:2,b:2,w:3,a:3},r=e.replace(/^out/,"").toLowerCase();if(void 0!==s[r])return t.element(s[r])}if("number"==typeof e)return t.element(e);if("string"==typeof e&&1===e.length){const s={x:0,r:0,y:1,g:1,z:2,b:2,w:3,a:3};if(void 0!==s[e])return t.element(s[e])}return t},mx_splitlr:(t,e,s,r=Ch())=>Rx(t,e,s,r,"x"),mx_splittb:(t,e,s,r=Ch())=>Rx(t,e,s,r,"y"),mx_srgb_texture_to_lin_rec709:zx,mx_subtract:(t,e=Ai(0))=>jn(t,e),mx_timer:()=>Bm,mx_transform_uv:(t=1,e=0,s=Ch())=>s.mul(t).add(e),mx_unifiednoise2d:(t,e=Ch(),s=Ii(1,1),r=Ii(0,0),i=1,n=0,a=1,o=!1,h=1,l=2,u=.5)=>_x(t,e.convert("vec2|vec3"),s,r,i,n,a,o,h,l,u),mx_unifiednoise3d:(t,e=Ch(),s=Ii(1,1),r=Ii(0,0),i=1,n=0,a=1,o=!1,h=1,l=2,u=.5)=>Sx(t,e.convert("vec2|vec3"),s,r,i,n,a,o,h,l,u),mx_worley_noise_float:(t=Ch(),e=1)=>wx(t.convert("vec2|vec3"),e,Vi(1)),mx_worley_noise_vec2:(t=Ch(),e=1)=>Tx(t.convert("vec2|vec3"),e,Vi(1)),mx_worley_noise_vec3:(t=Ch(),e=1)=>Mx(t.convert("vec2|vec3"),e,Vi(1)),negate:Wa,neutralToneMapping:dy,nodeArray:yi,nodeImmutable:xi,nodeObject:pi,nodeObjectIntent:mi,nodeObjects:gi,nodeProxy:fi,nodeProxyIntent:bi,normalFlat:Ol,normalGeometry:El,normalLocal:Ll,normalMap:Bu,normalView:Bl,normalViewGeometry:Pl,normalWorld:kl,normalWorldGeometry:Fl,normalize:Ia,not:ea,notEqual:Yn,numWorkgroups:Ly,objectDirection:rl,objectGroup:In,objectPosition:nl,objectRadius:hl,objectScale:al,objectViewPosition:ol,objectWorldMatrix:il,oneMinus:ja,or:ta,orthographicDepthToViewZ:(t,e,s)=>e.sub(s).mul(t).sub(e),oscSawtooth:(t=Bm)=>t.fract(),oscSine:(t=Bm)=>t.add(.75).mul(2*Math.PI).sin().mul(.5).add(.5),oscSquare:(t=Bm)=>t.fract().round(),oscTriangle:(t=Bm)=>t.add(.5).fract().mul(2).sub(1).abs(),output:yn,outputStruct:Sm,overlay:(...t)=>Hd(t),overloadingFn:Fm,parabola:Im,parallaxDirection:Ou,parallaxUV:(t,e)=>t.sub(Ou.mul(e)),parameter:(t,e)=>pi(new vm(t,e)),pass:(t,e,s)=>pi(new ey(ey.COLOR,t,e,s)),passTexture:(t,e)=>pi(new Qg(t,e)),pcurve:(t,e,s)=>lo(Hn(lo(t,e),Wn(lo(t,e),lo(jn(1,t),s))),1/e),perspectiveDepthToViewZ:Cd,pmremTexture:gm,pointShadow:(t,e)=>pi(new Pf(t,e)),pointUV:Sg,pointWidth:bn,positionGeometry:wl,positionLocal:Tl,positionPrevious:Ml,positionView:Al,positionViewDirection:Vl,positionWorld:_l,positionWorldDirection:Sl,posterize:Jg,pow:lo,pow2:uo,pow3:co,pow4:po,premultiplyAlpha:Xd,property:Zi,radians:Na,rand:To,range:Iy,rangeFog:function(t,e,s){return Ay(t,_y(e,s))},rangeFogFactor:_y,reciprocal:Xa,reference:ou,referenceBuffer:hu,reflect:io,reflectVector:Ql,reflectView:Jl,reflector:t=>pi(new hg(t)),refract:vo,refractVector:tu,refractView:Kl,reinhardToneMapping:iy,remap:bh,remapClamp:vh,renderGroup:Cn,renderOutput:_h,rendererReference:sh,rotate:xm,rotateUV:Um,roughness:Qi,round:Ga,rtt:yg,sRGBTransferEOTF:Xo,sRGBTransferOETF:Yo,sample:t=>pi(new vg(t)),sampler:t=>(!0===t.isNode?t:Bh(t)).convert("sampler"),samplerComparison:t=>(!0===t.isNode?t:Bh(t)).convert("samplerComparison"),saturate:bo,saturation:Hg,screen:(...t)=>qd(t),screenCoordinate:md,screenSize:pd,screenUV:dd,scriptable:Ty,scriptableValue:xy,select:Io,setCurrentStack:wi,setName:Lo,shaderStages:Nr,shadow:(t,e)=>pi(new Af(t,e)),shadowPositionWorld:ef,shapeCircle:kf,sharedUniformGroup:Vn,sheen:rn,sheenRoughness:nn,shiftLeft:oa,shiftRight:ha,shininess:gn,sign:Da,sin:Ea,sinc:(t,e)=>Ea(fa.mul(e.mul(t).sub(1))).div(fa.mul(e.mul(t).sub(1))),skinning:Zc,smoothstep:No,smoothstepElement:_o,specularColor:pn,specularF90:mn,spherizeUV:Wm,split:(t,e)=>pi(new Ir(pi(t),e)),spritesheetUV:Gm,sqrt:Aa,stack:wm,step:ro,stepElement:So,storage:Gc,storageBarrier:()=>ky("storage").toStack(),storageObject:(t,e,s)=>Gc(t,e,s).setPBO(!0),storageTexture:Lg,string:(t="")=>pi(new Pr(t,"string")),struct:(t,e=null)=>{const s=new Tm(t,e),r=(...e)=>{let r=null;if(e.length>0)if(e[0].isNode){r={};const s=Object.keys(t);for(let t=0;t<e.length;t++)r[s[t]]=e[t]}else r=e[0];return pi(new Mm(s,r))};return r.layout=s,r.isStruct=!0,r},sub:jn,subBuild:jo,subgroupIndex:Ec,subgroupSize:By,tan:Oa,tangentGeometry:_u,tangentLocal:Su,tangentView:Au,tangentWorld:Vu,temp:Uo,texture:Bh,texture3D:Fg,textureBarrier:()=>ky("texture").toStack(),textureBicubic:Tp,textureBicubicLevel:wp,textureCubeUV:Dp,textureLoad:kh,textureSize:Rh,textureStore:(t,e,s)=>{const r=Lg(t,e,s);return null!==s&&r.toStack(),r},thickness:wn,time:Bm,timerDelta:(t=1)=>km.mul(t),timerGlobal:(t=1)=>Bm.mul(t),timerLocal:(t=1)=>Bm.mul(t),toneMapping:ih,toneMappingExposure:nh,toonOutlinePass:(t,e,s=new Ee(0,0,0),r=.003,i=1)=>pi(new sy(t,e,pi(s),pi(r),pi(i))),transformDirection:mo,transformNormal:Ul,transformNormalToView:Wl,transformedClearcoatNormalView:Hl,transformedNormalView:jl,transformedNormalWorld:ql,transmission:Nn,transpose:$a,triNoise3D:Lm,triplanarTexture:(...t)=>Xm(...t),triplanarTextures:Xm,trunc:Ya,uint:zi,uniform:En,uniformArray:qh,uniformCubeTexture:(t=eu)=>ru(t),uniformGroup:An,uniformTexture:(t=Oh)=>Bh(t),unpremultiplyAlpha:Yd,userData:(t,e,s)=>pi(new Bg(t,e,s)),uv:Ch,uvec2:Ei,uvec3:Fi,uvec4:Ui,varying:Ho,varyingProperty:$i,vec2:Ii,vec3:Oi,vec4:ki,vectorComponents:wr,velocity:jg,vertexColor:Ud,vertexIndex:Ic,vertexStage:Go,vibrance:Gg,viewZToLogarithmicDepth:Id,viewZToOrthographicDepth:Vd,viewZToPerspectiveDepth:zd,viewport:gd,viewportCoordinate:fd,viewportDepthTexture:Sd,viewportLinearDepth:Od,viewportMipTexture:Td,viewportResolution:bd,viewportSafeUV:qm,viewportSharedTexture:Kd,viewportSize:yd,viewportTexture:wd,viewportUV:xd,wgsl:(t,e)=>my(t,e,"wgsl"),wgslFn:(t,e)=>yy(t,e,"wgsl"),workgroupArray:(t,e)=>pi(new Uy("Workgroup",t,e)),workgroupBarrier:()=>ky("workgroup").toStack(),workgroupId:Oy,workingToColorSpace:Jo,xor:sa});const Px="undefined"!=typeof self?self.GPUShaderStage:{VERTEX:1,FRAGMENT:2,COMPUTE:4};Px&&Px.VERTEX,Px&&Px.FRAGMENT,Px&&Px.COMPUTE;const Fx={tsl_xor:new py("fn tsl_xor( a : bool, b : bool ) -> bool { return ( a || b ) && !( a && b ); }"),mod_float:new py("fn tsl_mod_float( x : f32, y : f32 ) -> f32 { return x - y * floor( x / y ); }"),mod_vec2:new py("fn tsl_mod_vec2( x : vec2f, y : vec2f ) -> vec2f { return x - y * floor( x / y ); }"),mod_vec3:new py("fn tsl_mod_vec3( x : vec3f, y : vec3f ) -> vec3f { return x - y * floor( x / y ); }"),mod_vec4:new py("fn tsl_mod_vec4( x : vec4f, y : vec4f ) -> vec4f { return x - y * floor( x / y ); }"),equals_bool:new py("fn tsl_equals_bool( a : bool, b : bool ) -> bool { return a == b; }"),equals_bvec2:new py("fn tsl_equals_bvec2( a : vec2f, b : vec2f ) -> vec2<bool> { return vec2<bool>( a.x == b.x, a.y == b.y ); }"),equals_bvec3:new py("fn tsl_equals_bvec3( a : vec3f, b : vec3f ) -> vec3<bool> { return vec3<bool>( a.x == b.x, a.y == b.y, a.z == b.z ); }"),equals_bvec4:new py("fn tsl_equals_bvec4( a : vec4f, b : vec4f ) -> vec4<bool> { return vec4<bool>( a.x == b.x, a.y == b.y, a.z == b.z, a.w == b.w ); }"),repeatWrapping_float:new py("fn tsl_repeatWrapping_float( coord: f32 ) -> f32 { return fract( coord ); }"),mirrorWrapping_float:new py("fn tsl_mirrorWrapping_float( coord: f32 ) -> f32 { let mirrored = fract( coord * 0.5 ) * 2.0; return 1.0 - abs( 1.0 - mirrored ); }"),clampWrapping_float:new py("fn tsl_clampWrapping_float( coord: f32 ) -> f32 { return clamp( coord, 0.0, 1.0 ); }"),biquadraticTexture:new py("\nfn tsl_biquadraticTexture( map : texture_2d<f32>, coord : vec2f, iRes : vec2u, level : u32 ) -> vec4f {\n\n\tlet res = vec2f( iRes );\n\n\tlet uvScaled = coord * res;\n\tlet uvWrapping = ( ( uvScaled % res ) + res ) % res;\n\n\t// https://www.shadertoy.com/view/WtyXRy\n\n\tlet uv = uvWrapping - 0.5;\n\tlet iuv = floor( uv );\n\tlet f = fract( uv );\n\n\tlet rg1 = textureLoad( map, vec2u( iuv + vec2( 0.5, 0.5 ) ) % iRes, level );\n\tlet rg2 = textureLoad( map, vec2u( iuv + vec2( 1.5, 0.5 ) ) % iRes, level );\n\tlet rg3 = textureLoad( map, vec2u( iuv + vec2( 0.5, 1.5 ) ) % iRes, level );\n\tlet rg4 = textureLoad( map, vec2u( iuv + vec2( 1.5, 1.5 ) ) % iRes, level );\n\n\treturn mix( mix( rg1, rg2, f.x ), mix( rg3, rg4, f.x ), f.y );\n\n}\n")};"undefined"!=typeof navigator&&/Windows/g.test(navigator.userAgent)&&(Fx.pow_float=new py("fn tsl_pow_float( a : f32, b : f32 ) -> f32 { return select( -pow( -a, b ), pow( a, b ), a > 0.0 ); }"),Fx.pow_vec2=new py("fn tsl_pow_vec2( a : vec2f, b : vec2f ) -> vec2f { return vec2f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ) ); }",[Fx.pow_float]),Fx.pow_vec3=new py("fn tsl_pow_vec3( a : vec3f, b : vec3f ) -> vec3f { return vec3f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ) ); }",[Fx.pow_float]),Fx.pow_vec4=new py("fn tsl_pow_vec4( a : vec4f, b : vec4f ) -> vec4f { return vec4f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ), tsl_pow_float( a.w, b.w ) ); }",[Fx.pow_float])),"undefined"!=typeof navigator&&/Firefox|Deno/g.test(navigator.userAgent);const Bx=new Map([[Int8Array,["sint8","snorm8"]],[Uint8Array,["uint8","unorm8"]],[Int16Array,["sint16","snorm16"]],[Uint16Array,["uint16","unorm16"]],[Int32Array,["sint32","snorm32"]],[Uint32Array,["uint32","unorm32"]],[Float32Array,["float32"]]]);"undefined"!=typeof Float16Array&&Bx.set(Float16Array,["float16"]),new Map([[class extends He{constructor(t,e,s){super(new Uint16Array(t),e,s),this.isFloat16BufferAttribute=!0}getX(t){let e=Ue(this.array[t*this.itemSize]);return this.normalized&&(e=B(e,this.array)),e}setX(t,e){return this.normalized&&(e=k(e,this.array)),this.array[t*this.itemSize]=De(e),this}getY(t){let e=Ue(this.array[t*this.itemSize+1]);return this.normalized&&(e=B(e,this.array)),e}setY(t,e){return this.normalized&&(e=k(e,this.array)),this.array[t*this.itemSize+1]=De(e),this}getZ(t){let e=Ue(this.array[t*this.itemSize+2]);return this.normalized&&(e=B(e,this.array)),e}setZ(t,e){return this.normalized&&(e=k(e,this.array)),this.array[t*this.itemSize+2]=De(e),this}getW(t){let e=Ue(this.array[t*this.itemSize+3]);return this.normalized&&(e=B(e,this.array)),e}setW(t,e){return this.normalized&&(e=k(e,this.array)),this.array[t*this.itemSize+3]=De(e),this}setXY(t,e,s){return t*=this.itemSize,this.normalized&&(e=k(e,this.array),s=k(s,this.array)),this.array[t+0]=De(e),this.array[t+1]=De(s),this}setXYZ(t,e,s,r){return t*=this.itemSize,this.normalized&&(e=k(e,this.array),s=k(s,this.array),r=k(r,this.array)),this.array[t+0]=De(e),this.array[t+1]=De(s),this.array[t+2]=De(r),this}setXYZW(t,e,s,r,i){return t*=this.itemSize,this.normalized&&(e=k(e,this.array),s=k(s,this.array),r=k(r,this.array),i=k(i,this.array)),this.array[t+0]=De(e),this.array[t+1]=De(s),this.array[t+2]=De(r),this.array[t+3]=De(i),this}},["float16"]]]);Ox.BRDF_GGX,Ox.BRDF_Lambert,Ox.BasicPointShadowFilter,Ox.BasicShadowFilter,Ox.Break,Ox.Const,Ox.Continue,Ox.DFGApprox,Ox.D_GGX,Ox.Discard,Ox.EPSILON,Ox.F_Schlick;const kx=Ox.Fn;Ox.INFINITY,Ox.If;const Dx=Ox.Loop;Ox.NodeAccess,Ox.NodeShaderStage,Ox.NodeType,Ox.NodeUpdateType,Ox.PCFShadowFilter,Ox.PCFSoftShadowFilter,Ox.PI,Ox.PI2,Ox.PointShadowFilter,Ox.Return,Ox.Schlick_to_F0,Ox.ScriptableNodeResources;const Ux=Ox.ShaderNode;Ox.Stack,Ox.Switch,Ox.TBNViewMatrix,Ox.VSMShadowFilter,Ox.V_GGX_SmithCorrelated,Ox.Var,Ox.VarIntent;const Wx=Ox.abs;Ox.acesFilmicToneMapping,Ox.acos;const jx=Ox.add;Ox.addMethodChaining,Ox.addNodeElement,Ox.agxToneMapping,Ox.all,Ox.alphaT,Ox.and,Ox.anisotropy,Ox.anisotropyB,Ox.anisotropyT,Ox.any,Ox.append,Ox.array,Ox.arrayBuffer,Ox.asin,Ox.assign,Ox.atan,Ox.atan2,Ox.atomicAdd,Ox.atomicAnd,Ox.atomicFunc,Ox.atomicLoad,Ox.atomicMax,Ox.atomicMin,Ox.atomicOr,Ox.atomicStore,Ox.atomicSub,Ox.atomicXor,Ox.attenuationColor,Ox.attenuationDistance,Ox.attribute,Ox.attributeArray,Ox.backgroundBlurriness,Ox.backgroundIntensity,Ox.backgroundRotation,Ox.batch,Ox.bentNormalView,Ox.billboarding,Ox.bitAnd,Ox.bitNot,Ox.bitOr,Ox.bitXor,Ox.bitangentGeometry,Ox.bitangentLocal,Ox.bitangentView,Ox.bitangentWorld,Ox.bitcast,Ox.blendBurn,Ox.blendColor,Ox.blendDodge,Ox.blendOverlay;const qx=Ox.blendScreen;Ox.blur,Ox.bool,Ox.buffer,Ox.bufferAttribute,Ox.bumpMap,Ox.burn,Ox.bvec2,Ox.bvec3,Ox.bvec4,Ox.bypass,Ox.cache,Ox.call,Ox.cameraFar,Ox.cameraIndex,Ox.cameraNear,Ox.cameraNormalMatrix,Ox.cameraPosition,Ox.cameraProjectionMatrix,Ox.cameraProjectionMatrixInverse,Ox.cameraViewMatrix,Ox.cameraWorldMatrix,Ox.cbrt,Ox.cdl,Ox.ceil,Ox.checker,Ox.cineonToneMapping,Ox.clamp,Ox.clearcoat,Ox.clearcoatNormalView,Ox.clearcoatRoughness,Ox.code,Ox.color,Ox.colorSpaceToWorking,Ox.colorToDirection,Ox.compute,Ox.computeKernel,Ox.computeSkinning,Ox.context,Ox.convert,Ox.convertColorSpace,Ox.convertToTexture,Ox.cos,Ox.cross,Ox.cubeTexture,Ox.cubeTextureBase,Ox.cubeToUV,Ox.dFdx,Ox.dFdy,Ox.dashSize,Ox.debug,Ox.decrement,Ox.decrementBefore,Ox.defaultBuildStages,Ox.defaultShaderStages,Ox.defined,Ox.degrees,Ox.deltaTime,Ox.densityFog,Ox.densityFogFactor,Ox.depth,Ox.depthPass,Ox.determinant,Ox.difference,Ox.diffuseColor,Ox.directPointLight,Ox.directionToColor,Ox.directionToFaceDirection,Ox.dispersion,Ox.distance,Ox.div,Ox.dodge,Ox.dot,Ox.drawIndex,Ox.dynamicBufferAttribute,Ox.element,Ox.emissive,Ox.equal,Ox.equals,Ox.equirectUV,Ox.exp,Ox.exp2,Ox.expression,Ox.faceDirection,Ox.faceForward,Ox.faceforward;const Hx=Ox.float;Ox.floor,Ox.fog,Ox.fract,Ox.frameGroup,Ox.frameId,Ox.frontFacing,Ox.fwidth,Ox.gain,Ox.gapSize,Ox.getConstNodeType,Ox.getCurrentStack,Ox.getDirection,Ox.getDistanceAttenuation,Ox.getGeometryRoughness,Ox.getNormalFromDepth,Ox.getParallaxCorrectNormal,Ox.getRoughness,Ox.getScreenPosition,Ox.getShIrradianceAt,Ox.getShadowMaterial,Ox.getShadowRenderObjectFunction,Ox.getTextureIndex,Ox.getViewPosition,Ox.globalId,Ox.glsl,Ox.glslFn,Ox.grayscale,Ox.greaterThan,Ox.greaterThanEqual,Ox.hash,Ox.highpModelNormalViewMatrix,Ox.highpModelViewMatrix,Ox.hue,Ox.increment,Ox.incrementBefore,Ox.instance,Ox.instanceIndex,Ox.instancedArray,Ox.instancedBufferAttribute,Ox.instancedDynamicBufferAttribute,Ox.instancedMesh;const Gx=Ox.int;Ox.inverse,Ox.inverseSqrt,Ox.inversesqrt,Ox.invocationLocalIndex,Ox.invocationSubgroupIndex,Ox.ior,Ox.iridescence,Ox.iridescenceIOR,Ox.iridescenceThickness,Ox.ivec2,Ox.ivec3,Ox.ivec4,Ox.js,Ox.label,Ox.length,Ox.lengthSq,Ox.lessThan,Ox.lessThanEqual,Ox.lightPosition,Ox.lightProjectionUV,Ox.lightShadowMatrix,Ox.lightTargetDirection,Ox.lightTargetPosition,Ox.lightViewPosition,Ox.lightingContext,Ox.lights,Ox.linearDepth,Ox.linearToneMapping,Ox.localId,Ox.log,Ox.log2,Ox.logarithmicDepthToViewZ;const Xx=Ox.luminance;Ox.mat2,Ox.mat3,Ox.mat4,Ox.matcapUV,Ox.materialAO,Ox.materialAlphaTest,Ox.materialAnisotropy,Ox.materialAnisotropyVector,Ox.materialAttenuationColor,Ox.materialAttenuationDistance,Ox.materialClearcoat,Ox.materialClearcoatNormal,Ox.materialClearcoatRoughness,Ox.materialColor,Ox.materialDispersion,Ox.materialEmissive,Ox.materialEnvIntensity,Ox.materialEnvRotation,Ox.materialIOR,Ox.materialIridescence,Ox.materialIridescenceIOR,Ox.materialIridescenceThickness,Ox.materialLightMap,Ox.materialLineDashOffset,Ox.materialLineDashSize,Ox.materialLineGapSize,Ox.materialLineScale,Ox.materialLineWidth,Ox.materialMetalness,Ox.materialNormal,Ox.materialOpacity,Ox.materialPointSize,Ox.materialReference,Ox.materialReflectivity,Ox.materialRefractionRatio,Ox.materialRotation,Ox.materialRoughness,Ox.materialSheen,Ox.materialSheenRoughness,Ox.materialShininess,Ox.materialSpecular,Ox.materialSpecularColor,Ox.materialSpecularIntensity,Ox.materialSpecularStrength,Ox.materialThickness,Ox.materialTransmission;const Yx=Ox.max;Ox.maxMipLevel,Ox.mediumpModelViewMatrix,Ox.metalness,Ox.min;const Zx=Ox.mix;Ox.mixElement;const $x=Ox.mod;Ox.modInt,Ox.modelDirection,Ox.modelNormalMatrix,Ox.modelPosition,Ox.modelRadius,Ox.modelScale,Ox.modelViewMatrix,Ox.modelViewPosition,Ox.modelViewProjection,Ox.modelWorldMatrix,Ox.modelWorldMatrixInverse,Ox.morphReference,Ox.mrt,Ox.mul,Ox.mx_aastep,Ox.mx_add,Ox.mx_atan2;const Jx=Ox.mx_cell_noise_float;Ox.mx_contrast,Ox.mx_divide,Ox.mx_fractal_noise_float,Ox.mx_fractal_noise_vec2,Ox.mx_fractal_noise_vec3,Ox.mx_fractal_noise_vec4,Ox.mx_frame,Ox.mx_heighttonormal,Ox.mx_hsvtorgb,Ox.mx_ifequal,Ox.mx_ifgreater,Ox.mx_ifgreatereq,Ox.mx_invert,Ox.mx_modulo,Ox.mx_multiply,Ox.mx_noise_float,Ox.mx_noise_vec3,Ox.mx_noise_vec4,Ox.mx_place2d,Ox.mx_power,Ox.mx_ramp4,Ox.mx_ramplr,Ox.mx_ramptb,Ox.mx_rgbtohsv,Ox.mx_rotate2d,Ox.mx_rotate3d,Ox.mx_safepower,Ox.mx_separate,Ox.mx_splitlr,Ox.mx_splittb,Ox.mx_srgb_texture_to_lin_rec709,Ox.mx_subtract,Ox.mx_timer,Ox.mx_transform_uv,Ox.mx_unifiednoise2d,Ox.mx_unifiednoise3d,Ox.mx_worley_noise_float,Ox.mx_worley_noise_vec2,Ox.mx_worley_noise_vec3,Ox.negate,Ox.neutralToneMapping,Ox.nodeArray,Ox.nodeImmutable;const Kx=Ox.nodeObject;Ox.nodeObjectIntent,Ox.nodeObjects,Ox.nodeProxy,Ox.nodeProxyIntent,Ox.normalFlat,Ox.normalGeometry,Ox.normalLocal,Ox.normalMap,Ox.normalView,Ox.normalViewGeometry,Ox.normalWorld,Ox.normalWorldGeometry,Ox.normalize,Ox.not,Ox.notEqual,Ox.numWorkgroups,Ox.objectDirection,Ox.objectGroup,Ox.objectPosition,Ox.objectRadius,Ox.objectScale,Ox.objectViewPosition,Ox.objectWorldMatrix,Ox.OnObjectUpdate,Ox.OnMaterialUpdate;const Qx=Ox.oneMinus;Ox.or,Ox.orthographicDepthToViewZ,Ox.oscSawtooth,Ox.oscSine,Ox.oscSquare,Ox.oscTriangle,Ox.output,Ox.outputStruct,Ox.overlay,Ox.overloadingFn,Ox.parabola,Ox.parallaxDirection,Ox.parallaxUV,Ox.parameter;const tb=Ox.pass,eb=Ox.passTexture;Ox.pcurve,Ox.perspectiveDepthToViewZ,Ox.pmremTexture,Ox.pointShadow,Ox.pointUV,Ox.pointWidth,Ox.positionGeometry,Ox.positionLocal,Ox.positionPrevious,Ox.positionView,Ox.positionViewDirection,Ox.positionWorld,Ox.positionWorldDirection,Ox.posterize,Ox.pow,Ox.pow2,Ox.pow3,Ox.pow4,Ox.premultiplyAlpha,Ox.property,Ox.radians,Ox.rand,Ox.range,Ox.rangeFog,Ox.rangeFogFactor,Ox.reciprocal,Ox.reference,Ox.referenceBuffer,Ox.reflect,Ox.reflectVector,Ox.reflectView,Ox.reflector,Ox.refract,Ox.refractVector,Ox.refractView,Ox.reinhardToneMapping,Ox.remap,Ox.remapClamp,Ox.renderGroup,Ox.renderOutput,Ox.rendererReference,Ox.rotate,Ox.rotateUV,Ox.roughness,Ox.round,Ox.rtt,Ox.sRGBTransferEOTF,Ox.sRGBTransferOETF,Ox.sample,Ox.sampler,Ox.samplerComparison,Ox.saturate,Ox.saturation,Ox.screen,Ox.screenCoordinate,Ox.screenSize,Ox.screenUV,Ox.scriptable,Ox.scriptableValue;const sb=Ox.select;Ox.setCurrentStack,Ox.setName,Ox.shaderStages,Ox.shadow,Ox.shadowPositionWorld,Ox.shapeCircle,Ox.sharedUniformGroup,Ox.sheen,Ox.sheenRoughness,Ox.shiftLeft,Ox.shiftRight,Ox.shininess,Ox.sign,Ox.sin,Ox.sinc,Ox.skinning;const rb=Ox.smoothstep;Ox.smoothstepElement,Ox.specularColor,Ox.specularF90,Ox.spherizeUV,Ox.split,Ox.spritesheetUV,Ox.sqrt,Ox.stack,Ox.step,Ox.stepElement,Ox.storage,Ox.storageBarrier,Ox.storageObject,Ox.storageTexture,Ox.string,Ox.struct;const ib=Ox.sub;Ox.subBuild,Ox.subgroupIndex,Ox.subgroupSize,Ox.tan,Ox.tangentGeometry,Ox.tangentLocal,Ox.tangentView,Ox.tangentWorld,Ox.temp;const nb=Ox.texture;Ox.texture3D,Ox.textureBarrier,Ox.textureBicubic,Ox.textureBicubicLevel,Ox.textureCubeUV,Ox.textureLoad,Ox.textureSize,Ox.textureStore,Ox.thickness,Ox.time,Ox.timerDelta,Ox.timerGlobal,Ox.timerLocal,Ox.toneMapping,Ox.toneMappingExposure,Ox.toonOutlinePass,Ox.transformDirection,Ox.transformNormal,Ox.transformNormalToView,Ox.transformedClearcoatNormalView,Ox.transformedNormalView,Ox.transformedNormalWorld,Ox.transmission,Ox.transpose,Ox.triNoise3D,Ox.triplanarTexture,Ox.triplanarTextures,Ox.trunc,Ox.uint;const ab=Ox.uniform,ob=Ox.uniformArray;Ox.uniformCubeTexture,Ox.uniformGroup,Ox.uniformTexture,Ox.unpremultiplyAlpha,Ox.userData;const hb=Ox.uv;Ox.uvec2,Ox.uvec3,Ox.uvec4,Ox.varying,Ox.varyingProperty;const lb=Ox.vec2,ub=Ox.vec3,cb=Ox.vec4;Ox.vectorComponents,Ox.velocity,Ox.vertexColor,Ox.vertexIndex,Ox.vertexStage,Ox.vibrance,Ox.viewZToLogarithmicDepth,Ox.viewZToOrthographicDepth,Ox.viewZToPerspectiveDepth,Ox.viewport,Ox.viewportCoordinate,Ox.viewportDepthTexture,Ox.viewportLinearDepth,Ox.viewportMipTexture,Ox.viewportResolution,Ox.viewportSafeUV,Ox.viewportSharedTexture,Ox.viewportSize,Ox.viewportTexture,Ox.viewportUV,Ox.wgsl,Ox.wgslFn,Ox.workgroupArray,Ox.workgroupBarrier,Ox.workgroupId,Ox.workingToColorSpace,Ox.xor;const db=new pg,pb=new U,mb=new U(1,0),gb=new U(0,1);let yb;class fb extends Vr{static get type(){return"BloomNode"}constructor(t,e=1,s=0,r=0){super("vec4"),this.inputNode=t,this.strength=ab(e),this.radius=ab(s),this.threshold=ab(r),this.smoothWidth=ab(.01),this._renderTargetsHorizontal=[],this._renderTargetsVertical=[],this._nMips=5,this._renderTargetBright=new dt(1,1,{depthBuffer:!1,type:d}),this._renderTargetBright.texture.name="UnrealBloomPass.bright",this._renderTargetBright.texture.generateMipmaps=!1;for(let t=0;t<this._nMips;t++){const e=new dt(1,1,{depthBuffer:!1,type:d});e.texture.name="UnrealBloomPass.h"+t,e.texture.generateMipmaps=!1,this._renderTargetsHorizontal.push(e);const s=new dt(1,1,{depthBuffer:!1,type:d});s.texture.name="UnrealBloomPass.v"+t,s.texture.generateMipmaps=!1,this._renderTargetsVertical.push(s)}this._compositeMaterial=null,this._highPassFilterMaterial=null,this._separableBlurMaterials=[],this._textureNodeBright=nb(this._renderTargetBright.texture),this._textureNodeBlur0=nb(this._renderTargetsVertical[0].texture),this._textureNodeBlur1=nb(this._renderTargetsVertical[1].texture),this._textureNodeBlur2=nb(this._renderTargetsVertical[2].texture),this._textureNodeBlur3=nb(this._renderTargetsVertical[3].texture),this._textureNodeBlur4=nb(this._renderTargetsVertical[4].texture),this._textureOutput=eb(this,this._renderTargetsHorizontal[0].texture),this.updateBeforeType=xr.FRAME}getTextureNode(){return this._textureOutput}setSize(t,e){let s=Math.round(t/2),r=Math.round(e/2);this._renderTargetBright.setSize(s,r);for(let t=0;t<this._nMips;t++)this._renderTargetsHorizontal[t].setSize(s,r),this._renderTargetsVertical[t].setSize(s,r),this._separableBlurMaterials[t].invSize.value.set(1/s,1/r),s=Math.round(s/2),r=Math.round(r/2)}updateBefore(t){const{renderer:e}=t;yb=cf.resetRendererState(e,yb);const s=e.getDrawingBufferSize(pb);this.setSize(s.width,s.height),e.setRenderTarget(this._renderTargetBright),db.material=this._highPassFilterMaterial,db.render(e);let r=this._renderTargetBright;for(let t=0;t<this._nMips;t++)db.material=this._separableBlurMaterials[t],this._separableBlurMaterials[t].colorTexture.value=r.texture,this._separableBlurMaterials[t].direction.value=mb,e.setRenderTarget(this._renderTargetsHorizontal[t]),db.render(e),this._separableBlurMaterials[t].colorTexture.value=this._renderTargetsHorizontal[t].texture,this._separableBlurMaterials[t].direction.value=gb,e.setRenderTarget(this._renderTargetsVertical[t]),db.render(e),r=this._renderTargetsVertical[t];e.setRenderTarget(this._renderTargetsHorizontal[0]),db.material=this._compositeMaterial,db.render(e),cf.restoreRendererState(e,yb)}setup(t){const e=kx(()=>{const t=this.inputNode,e=Xx(t.rgb),s=rb(this.threshold,this.threshold.add(this.smoothWidth),e);return Zx(cb(0),t,s)});this._highPassFilterMaterial=this._highPassFilterMaterial||new Zd,this._highPassFilterMaterial.fragmentNode=e().context(t.getSharedContext()),this._highPassFilterMaterial.name="Bloom_highPass",this._highPassFilterMaterial.needsUpdate=!0;const s=[6,10,14,18,22];for(let e=0;e<this._nMips;e++)this._separableBlurMaterials.push(this._getSeparableBlurMaterial(t,s[e]));const r=ob([1,.8,.6,.4,.2]),i=ob([new j(1,1,1),new j(1,1,1),new j(1,1,1),new j(1,1,1),new j(1,1,1)]),n=kx(([t,e])=>{const s=Hx(1.2).sub(t);return Zx(t,s,e)}).setLayout({name:"lerpBloomFactor",type:"float",inputs:[{name:"factor",type:"float"},{name:"radius",type:"float"}]}),a=kx(()=>{const t=n(r.element(0),this.radius).mul(cb(i.element(0),1)).mul(this._textureNodeBlur0),e=n(r.element(1),this.radius).mul(cb(i.element(1),1)).mul(this._textureNodeBlur1),s=n(r.element(2),this.radius).mul(cb(i.element(2),1)).mul(this._textureNodeBlur2),a=n(r.element(3),this.radius).mul(cb(i.element(3),1)).mul(this._textureNodeBlur3),o=n(r.element(4),this.radius).mul(cb(i.element(4),1)).mul(this._textureNodeBlur4);return t.add(e).add(s).add(a).add(o).mul(this.strength)});return this._compositeMaterial=this._compositeMaterial||new Zd,this._compositeMaterial.fragmentNode=a().context(t.getSharedContext()),this._compositeMaterial.name="Bloom_comp",this._compositeMaterial.needsUpdate=!0,this._textureOutput}dispose(){for(let t=0;t<this._renderTargetsHorizontal.length;t++)this._renderTargetsHorizontal[t].dispose();for(let t=0;t<this._renderTargetsVertical.length;t++)this._renderTargetsVertical[t].dispose();this._renderTargetBright.dispose()}_getSeparableBlurMaterial(t,e){const s=[],r=e/3;for(let t=0;t<e;t++)s.push(.39894*Math.exp(-.5*t*t/(r*r))/r);const i=nb(null),n=ob(s),a=ab(new U),o=ab(new U(.5,.5)),h=hb(),l=t=>i.sample(t),u=kx(()=>{const t=l(h).rgb.mul(n.element(0)).toVar();return Dx({start:Gx(1),end:Gx(e),type:"int",condition:"<"},({i:e})=>{const s=Hx(e),r=n.element(e),i=o.mul(a).mul(s),u=l(h.add(i)).rgb,c=l(h.sub(i)).rgb;t.addAssign(jx(u,c).mul(r))}),cb(t,1)}),c=new Zd;return c.fragmentNode=u().context(t.getSharedContext()),c.name="Bloom_separable",c.needsUpdate=!0,c.colorTexture=i,c.direction=o,c.invSize=a,c}}const xb=(t,e,s,r)=>Kx(new fb(Kx(t),e,s,r));export{kx as Fn,Ux as ShaderNode,Wx as abs,qx as blendScreen,xb as bloom,Hx as float,Yx as max,$x as mod,Jx as mx_cell_noise_float,Qx as oneMinus,tb as pass,sb as select,rb as smoothstep,ib as sub,nb as texture,ab as uniform,hb as uv,lb as vec2,ub as vec3};
